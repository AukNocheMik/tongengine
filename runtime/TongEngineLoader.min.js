"use strict";var System={browser:function(){var e=navigator.userAgent;return/Arora/i.test(e)?"Arora":/Chrome/i.test(e)?"Chrome":/Epiphany/i.test(e)?"Epiphany":/Firefox/i.test(e)?"Firefox":/Mobile(\/.*)? Safari/i.test(e)?"Mobile Safari":/MSIE/i.test(e)?"Internet Explorer":/Midori/i.test(e)?"Midori":/Opera/.test(e)?"Opera":!!/Safari/i.test(e)&&"Safari"}(),os:function(){var e=navigator.userAgent;return/Android/i.test(e)?"Android":/CrOS/i.test(e)?"Chrome OS":/iP[ao]d|iPhone/i.test(e)?"iOS":/Linux/i.test(e)?"Linux":/Mac OS/i.test(e)?"Mac OS":!!/windows/i.test(e)&&"Windows"}(),support:{canvas:!!window.CanvasRenderingContext2D,localStorage:function(){try{return!!window.localStorage.getItem}catch(e){return!1}}(),file:!!(window.File&&window.FileReader&&window.FileList&&window.Blob),fileSystem:!!window.requestFileSystem||!!window.webkitRequestFileSystem,getUserMedia:!!(window.navigator.getUserMedia||window.navigator.webkitGetUserMedia||window.navigator.mozGetUserMedia||window.navigator.msGetUserMedia),requestAnimationFrame:!!(window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame),sessionStorage:function(){try{return!!window.sessionStorage.getItem}catch(e){return!1}}(),webgl:function(){try{return!!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(e){return!1}}(),worker:!!window.Worker}};TONG.OrbitPointControls=function(r,t){t=void 0!==t?t:document,this.enabled=!0,this.center=new TONG.Vector3,this.panSpeed=.001,this.zoomSpeed=.1,this.rotationSpeed=.005;var i=this,a=new TONG.Vector3,s=new TONG.Vector3,n=new TONG.Box3,o={NONE:-1,ROTATE:0,ZOOM:1,PAN:2},l=o.NONE,u=this.center,h=new TONG.Matrix3,c=new TONG.Vector2,d=new TONG.Vector2,f=new TONG.Spherical,p={type:"change"};function e(e){!1!==i.enabled&&(0===e.button?l=o.ROTATE:1===e.button?l=o.ZOOM:2===e.button&&(l=o.PAN),d.set(e.clientX,e.clientY),t.addEventListener("mousemove",m,!1),t.addEventListener("mouseup",g,!1),t.addEventListener("mouseout",g,!1),t.addEventListener("dblclick",g,!1))}function m(e){if(!1!==i.enabled){c.set(e.clientX,e.clientY);var t=c.x-d.x,r=c.y-d.y;l===o.ROTATE?i.rotate(s.set(-t*i.rotationSpeed,-r*i.rotationSpeed,0)):l===o.ZOOM?i.zoom(s.set(0,0,r)):l===o.PAN&&i.pan(s.set(-t,r,0)),d.set(e.clientX,e.clientY)}}function g(e){t.removeEventListener("mousemove",m,!1),t.removeEventListener("mouseup",g,!1),t.removeEventListener("mouseout",g,!1),t.removeEventListener("dblclick",g,!1),l=o.NONE}function v(e){e.preventDefault(),i.zoom(s.set(0,0,0<e.deltaY?1:-1))}function y(e){e.preventDefault()}this.focus=function(e){var t;n.setFromObject(e),!1===n.isEmpty()?(u.copy(n.getCenter()),t=n.getBoundingSphere().radius):(u.setFromMatrixPosition(e.matrixWorld),t=.1),s.set(0,0,1),s.applyQuaternion(r.quaternion),s.multiplyScalar(4*t),r.position.copy(u).add(s),i.dispatchEvent(p)},this.pan=function(e){var t=r.position.distanceTo(u);e.multiplyScalar(t*i.panSpeed),e.applyMatrix3(h.getNormalMatrix(r.matrix)),r.position.add(e),u.add(e),i.dispatchEvent(p)},this.zoom=function(e){var t=r.position.distanceTo(u);e.multiplyScalar(t*i.zoomSpeed),e.length()>t||(e.applyMatrix3(h.getNormalMatrix(r.matrix)),r.position.add(e),i.dispatchEvent(p))},this.rotate=function(e){a.copy(r.position).sub(u),f.setFromVector3(a),f.theta+=e.x,f.phi+=e.y,f.makeSafe(),a.setFromSpherical(f),r.position.copy(u).add(a),r.lookAt(u),i.dispatchEvent(p)},this.dispose=function(){t.removeEventListener("contextmenu",y,!1),t.removeEventListener("mousedown",e,!1),t.removeEventListener("wheel",v,!1),t.removeEventListener("mousemove",m,!1),t.removeEventListener("mouseup",g,!1),t.removeEventListener("mouseout",g,!1),t.removeEventListener("dblclick",g,!1),t.removeEventListener("touchstart",O,!1),t.removeEventListener("touchmove",w,!1)},t.addEventListener("contextmenu",y,!1),t.addEventListener("mousedown",e,!1),t.addEventListener("wheel",v,!1);var T=[new TONG.Vector3,new TONG.Vector3,new TONG.Vector3],b=[new TONG.Vector3,new TONG.Vector3,new TONG.Vector3],_=null;function O(e){if(!1!==i.enabled){switch(e.touches.length){case 1:T[0].set(e.touches[0].pageX,e.touches[0].pageY,0),T[1].set(e.touches[0].pageX,e.touches[0].pageY,0);break;case 2:T[0].set(e.touches[0].pageX,e.touches[0].pageY,0),T[1].set(e.touches[1].pageX,e.touches[1].pageY,0),_=T[0].distanceTo(T[1])}b[0].copy(T[0]),b[1].copy(T[1])}}function w(e){if(!1!==i.enabled){switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:T[0].set(e.touches[0].pageX,e.touches[0].pageY,0),T[1].set(e.touches[0].pageX,e.touches[0].pageY,0),i.rotate(T[0].sub(n(T[0],b)).multiplyScalar(-i.rotationSpeed));break;case 2:T[0].set(e.touches[0].pageX,e.touches[0].pageY,0),T[1].set(e.touches[1].pageX,e.touches[1].pageY,0);var t=T[0].distanceTo(T[1]);i.zoom(s.set(0,0,_-t)),_=t;var r=T[0].clone().sub(n(T[0],b)),a=T[1].clone().sub(n(T[1],b));r.x=-r.x,a.x=-a.x,i.pan(r.add(a).multiplyScalar(.5))}b[0].copy(T[0]),b[1].copy(T[1])}function n(e,t){var r=t[0];for(var a in t)r.distanceTo(e)>t[a].distanceTo(e)&&(r=t[a]);return r}}t.addEventListener("touchstart",O,!1),t.addEventListener("touchmove",w,!1)},TONG.OrbitPointControls.prototype=Object.create(TONG.EventDispatcher.prototype),TONG.OrbitPointControls.prototype.constructor=TONG.OrbitPointControls,function(){var n=function(e){TONG.MeshBasicMaterial.call(this),this.depthTest=!1,this.depthWrite=!1,this.fog=!1,this.side=TONG.FrontSide,this.transparent=!0,this.setValues(e),this.oldColor=this.color.clone(),this.oldOpacity=this.opacity,this.highlight=function(e){e?(this.color.setRGB(1,1,0),this.opacity=1):(this.color.copy(this.oldColor),this.opacity=this.oldOpacity)}};(n.prototype=Object.create(TONG.MeshBasicMaterial.prototype)).constructor=n;var i=function(e){TONG.LineBasicMaterial.call(this),this.depthTest=!1,this.depthWrite=!1,this.fog=!1,this.transparent=!0,this.linewidth=1,this.setValues(e),this.oldColor=this.color.clone(),this.oldOpacity=this.opacity,this.highlight=function(e){e?(this.color.setRGB(1,1,0),this.opacity=1):(this.color.copy(this.oldColor),this.opacity=this.oldOpacity)}};(i.prototype=Object.create(TONG.LineBasicMaterial.prototype)).constructor=i;var s=new n({visible:!1,transparent:!1});TONG.TransformGizmo=function(){this.init=function(){TONG.Object3D.call(this),this.handles=new TONG.Object3D,this.pickers=new TONG.Object3D,this.planes=new TONG.Object3D,this.add(this.handles),this.add(this.pickers),this.add(this.planes);var e=new TONG.PlaneBufferGeometry(50,50,2,2),t=new TONG.MeshBasicMaterial({visible:!1,side:TONG.DoubleSide}),r={XY:new TONG.Mesh(e,t),YZ:new TONG.Mesh(e,t),XZ:new TONG.Mesh(e,t),XYZE:new TONG.Mesh(e,t)};for(var s in this.activePlane=r.XYZE,r.YZ.rotation.set(0,Math.PI/2,0),r.XZ.rotation.set(-Math.PI/2,0,0),r)r[s].name=s,this.planes.add(r[s]),this.planes[s]=r[s];var a=function(e,t){for(var r in e)for(s=e[r].length;s--;){var a=e[r][s][0],n=e[r][s][1],i=e[r][s][2];a.name=r,a.renderOrder=1/0,n&&a.position.set(n[0],n[1],n[2]),i&&a.rotation.set(i[0],i[1],i[2]),t.add(a)}};a(this.handleGizmos,this.handles),a(this.pickerGizmos,this.pickers),this.traverse(function(e){if(e instanceof TONG.Mesh){e.updateMatrix();var t=e.geometry.clone();t.applyMatrix(e.matrix),e.geometry=t,e.position.set(0,0,0),e.rotation.set(0,0,0),e.scale.set(1,1,1)}})},this.highlight=function(t){this.traverse(function(e){e.material&&e.material.highlight&&(e.name===t?e.material.highlight(!0):e.material.highlight(!1))})}},TONG.TransformGizmo.prototype=Object.create(TONG.Object3D.prototype),TONG.TransformGizmo.prototype.constructor=TONG.TransformGizmo,TONG.TransformGizmo.prototype.update=function(t,r){var a=new TONG.Vector3(0,0,0),n=new TONG.Vector3(0,1,0),i=new TONG.Matrix4;this.traverse(function(e){-1!==e.name.search("E")?e.quaternion.setFromRotationMatrix(i.lookAt(r,a,n)):-1===e.name.search("X")&&-1===e.name.search("Y")&&-1===e.name.search("Z")||e.quaternion.setFromEuler(t)})},TONG.TransformGizmoTranslate=function(){TONG.TransformGizmo.call(this);var e=new TONG.ConeBufferGeometry(.05,.2,12,1,!1);e.translate(0,.5,0);var t=new TONG.BufferGeometry;t.addAttribute("position",new TONG.Float32BufferAttribute([0,0,0,1,0,0],3));var r=new TONG.BufferGeometry;r.addAttribute("position",new TONG.Float32BufferAttribute([0,0,0,0,1,0],3));var a=new TONG.BufferGeometry;a.addAttribute("position",new TONG.Float32BufferAttribute([0,0,0,0,0,1],3)),this.handleGizmos={X:[[new TONG.Mesh(e,new n({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new TONG.Line(t,new i({color:16711680}))]],Y:[[new TONG.Mesh(e,new n({color:65280})),[0,.5,0]],[new TONG.Line(r,new i({color:65280}))]],Z:[[new TONG.Mesh(e,new n({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new TONG.Line(a,new i({color:255}))]],XYZ:[[new TONG.Mesh(new TONG.OctahedronGeometry(.1,0),new n({color:16777215,opacity:.25})),[0,0,0],[0,0,0]]],XY:[[new TONG.Mesh(new TONG.PlaneBufferGeometry(.29,.29),new n({color:16776960,opacity:.25})),[.15,.15,0]]],YZ:[[new TONG.Mesh(new TONG.PlaneBufferGeometry(.29,.29),new n({color:65535,opacity:.25})),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new TONG.Mesh(new TONG.PlaneBufferGeometry(.29,.29),new n({color:16711935,opacity:.25})),[.15,0,.15],[-Math.PI/2,0,0]]]},this.pickerGizmos={X:[[new TONG.Mesh(new TONG.CylinderBufferGeometry(.2,0,1,4,1,!1),s),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new TONG.Mesh(new TONG.CylinderBufferGeometry(.2,0,1,4,1,!1),s),[0,.6,0]]],Z:[[new TONG.Mesh(new TONG.CylinderBufferGeometry(.2,0,1,4,1,!1),s),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new TONG.Mesh(new TONG.OctahedronGeometry(.2,0),s)]],XY:[[new TONG.Mesh(new TONG.PlaneBufferGeometry(.4,.4),s),[.2,.2,0]]],YZ:[[new TONG.Mesh(new TONG.PlaneBufferGeometry(.4,.4),s),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new TONG.Mesh(new TONG.PlaneBufferGeometry(.4,.4),s),[.2,0,.2],[-Math.PI/2,0,0]]]},this.setActivePlane=function(e,t){var r=new TONG.Matrix4;t.applyMatrix4(r.getInverse(r.extractRotation(this.planes.XY.matrixWorld))),"X"===e&&(this.activePlane=this.planes.XY,Math.abs(t.y)>Math.abs(t.z)&&(this.activePlane=this.planes.XZ)),"Y"===e&&(this.activePlane=this.planes.XY,Math.abs(t.x)>Math.abs(t.z)&&(this.activePlane=this.planes.YZ)),"Z"===e&&(this.activePlane=this.planes.XZ,Math.abs(t.x)>Math.abs(t.y)&&(this.activePlane=this.planes.YZ)),"XYZ"===e&&(this.activePlane=this.planes.XYZE),"XY"===e&&(this.activePlane=this.planes.XY),"YZ"===e&&(this.activePlane=this.planes.YZ),"XZ"===e&&(this.activePlane=this.planes.XZ)},this.init()},TONG.TransformGizmoTranslate.prototype=Object.create(TONG.TransformGizmo.prototype),TONG.TransformGizmoTranslate.prototype.constructor=TONG.TransformGizmoTranslate,TONG.TransformGizmoRotate=function(){TONG.TransformGizmo.call(this);var e=function(e,t,r){var a=new TONG.BufferGeometry,n=[];r=r||1;for(var i=0;i<=64*r;++i)"x"===t&&n.push(0,Math.cos(i/32*Math.PI)*e,Math.sin(i/32*Math.PI)*e),"y"===t&&n.push(Math.cos(i/32*Math.PI)*e,0,Math.sin(i/32*Math.PI)*e),"z"===t&&n.push(Math.sin(i/32*Math.PI)*e,Math.cos(i/32*Math.PI)*e,0);return a.addAttribute("position",new TONG.Float32BufferAttribute(n,3)),a};this.handleGizmos={X:[[new TONG.Line(new e(1,"x",.5),new i({color:16711680}))]],Y:[[new TONG.Line(new e(1,"y",.5),new i({color:65280}))]],Z:[[new TONG.Line(new e(1,"z",.5),new i({color:255}))]],E:[[new TONG.Line(new e(1.25,"z",1),new i({color:13421568}))]],XYZE:[[new TONG.Line(new e(1,"z",1),new i({color:7895160}))]]},this.pickerGizmos={X:[[new TONG.Mesh(new TONG.TorusBufferGeometry(1,.12,4,12,Math.PI),s),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new TONG.Mesh(new TONG.TorusBufferGeometry(1,.12,4,12,Math.PI),s),[0,0,0],[Math.PI/2,0,0]]],Z:[[new TONG.Mesh(new TONG.TorusBufferGeometry(1,.12,4,12,Math.PI),s),[0,0,0],[0,0,-Math.PI/2]]],E:[[new TONG.Mesh(new TONG.TorusBufferGeometry(1.25,.12,2,24),s)]],XYZE:[[new TONG.Mesh(new TONG.TorusBufferGeometry(1,.12,2,24),s)]]},this.pickerGizmos.XYZE[0][0].visible=!1,this.setActivePlane=function(e){"E"===e&&(this.activePlane=this.planes.XYZE),"X"===e&&(this.activePlane=this.planes.YZ),"Y"===e&&(this.activePlane=this.planes.XZ),"Z"===e&&(this.activePlane=this.planes.XY)},this.update=function(e,t){TONG.TransformGizmo.prototype.update.apply(this,arguments);var r=new TONG.Matrix4,a=new TONG.Euler(0,0,1),n=new TONG.Quaternion,i=new TONG.Vector3(1,0,0),s=new TONG.Vector3(0,1,0),o=new TONG.Vector3(0,0,1),l=new TONG.Quaternion,u=new TONG.Quaternion,h=new TONG.Quaternion,c=t.clone();a.copy(this.planes.XY.rotation),n.setFromEuler(a),r.makeRotationFromQuaternion(n).getInverse(r),c.applyMatrix4(r),this.traverse(function(e){n.setFromEuler(a),"X"===e.name&&(l.setFromAxisAngle(i,Math.atan2(-c.y,c.z)),n.multiplyQuaternions(n,l),e.quaternion.copy(n)),"Y"===e.name&&(u.setFromAxisAngle(s,Math.atan2(c.x,c.z)),n.multiplyQuaternions(n,u),e.quaternion.copy(n)),"Z"===e.name&&(h.setFromAxisAngle(o,Math.atan2(c.y,c.x)),n.multiplyQuaternions(n,h),e.quaternion.copy(n))})},this.init()},TONG.TransformGizmoRotate.prototype=Object.create(TONG.TransformGizmo.prototype),TONG.TransformGizmoRotate.prototype.constructor=TONG.TransformGizmoRotate,TONG.TransformGizmoScale=function(){TONG.TransformGizmo.call(this);var e=new TONG.BoxBufferGeometry(.125,.125,.125);e.translate(0,.5,0);var t=new TONG.BufferGeometry;t.addAttribute("position",new TONG.Float32BufferAttribute([0,0,0,1,0,0],3));var r=new TONG.BufferGeometry;r.addAttribute("position",new TONG.Float32BufferAttribute([0,0,0,0,1,0],3));var a=new TONG.BufferGeometry;a.addAttribute("position",new TONG.Float32BufferAttribute([0,0,0,0,0,1],3)),this.handleGizmos={X:[[new TONG.Mesh(e,new n({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new TONG.Line(t,new i({color:16711680}))]],Y:[[new TONG.Mesh(e,new n({color:65280})),[0,.5,0]],[new TONG.Line(r,new i({color:65280}))]],Z:[[new TONG.Mesh(e,new n({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new TONG.Line(a,new i({color:255}))]],XYZ:[[new TONG.Mesh(new TONG.BoxBufferGeometry(.125,.125,.125),new n({color:16777215,opacity:.25}))]]},this.pickerGizmos={X:[[new TONG.Mesh(new TONG.CylinderBufferGeometry(.2,0,1,4,1,!1),s),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new TONG.Mesh(new TONG.CylinderBufferGeometry(.2,0,1,4,1,!1),s),[0,.6,0]]],Z:[[new TONG.Mesh(new TONG.CylinderBufferGeometry(.2,0,1,4,1,!1),s),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new TONG.Mesh(new TONG.BoxBufferGeometry(.4,.4,.4),s)]]},this.setActivePlane=function(e,t){var r=new TONG.Matrix4;t.applyMatrix4(r.getInverse(r.extractRotation(this.planes.XY.matrixWorld))),"X"===e&&(this.activePlane=this.planes.XY,Math.abs(t.y)>Math.abs(t.z)&&(this.activePlane=this.planes.XZ)),"Y"===e&&(this.activePlane=this.planes.XY,Math.abs(t.x)>Math.abs(t.z)&&(this.activePlane=this.planes.YZ)),"Z"===e&&(this.activePlane=this.planes.XZ,Math.abs(t.x)>Math.abs(t.y)&&(this.activePlane=this.planes.YZ)),"XYZ"===e&&(this.activePlane=this.planes.XYZE)},this.init()},TONG.TransformGizmoScale.prototype=Object.create(TONG.TransformGizmo.prototype),TONG.TransformGizmoScale.prototype.constructor=TONG.TransformGizmoScale,TONG.TransformControls=function(s,o){TONG.Object3D.call(this),o=void 0!==o?o:document,this.object=void 0,this.visible=!1,this.translationSnap=null,this.rotationSnap=null,this.space="world",this.size=1,this.axis=null;var n=this,i="translate",l=!1,u={translate:new TONG.TransformGizmoTranslate,rotate:new TONG.TransformGizmoRotate,scale:new TONG.TransformGizmoScale};for(var e in u){var t=u[e];t.visible=e===i,this.add(t)}var a={type:"change"},h={type:"mouseDown"},r={type:"mouseUp",mode:i},c={type:"objectChange"},d=new TONG.Raycaster,f=new TONG.Vector2,p=new TONG.Vector3,m=new TONG.Vector3,g=new TONG.Vector3,v=new TONG.Vector3,y=1,T=new TONG.Matrix4,b=new TONG.Vector3,_=new TONG.Matrix4,O=new TONG.Vector3,w=new TONG.Quaternion,N=new TONG.Vector3(1,0,0),A=new TONG.Vector3(0,1,0),x=new TONG.Vector3(0,0,1),M=new TONG.Quaternion,G=new TONG.Quaternion,k=new TONG.Quaternion,L=new TONG.Quaternion,S=new TONG.Quaternion,C=new TONG.Vector3,F=new TONG.Vector3,I=new TONG.Matrix4,B=new TONG.Matrix4,E=new TONG.Vector3,R=new TONG.Vector3,D=new TONG.Euler,P=new TONG.Matrix4,U=new TONG.Vector3,z=new TONG.Euler;function V(e){if(void 0!==n.object&&!0!==l&&(void 0===e.button||0===e.button)){var t=X(e.changedTouches?e.changedTouches[0]:e,u[i].pickers.children),r=null;t&&(r=t.object.name,e.preventDefault()),n.axis!==r&&(n.axis=r,n.update(),n.dispatchEvent(a))}}function j(e){if(void 0!==n.object&&!0!==l&&(void 0===e.button||0===e.button)){var t=e.changedTouches?e.changedTouches[0]:e;if(0===t.button||void 0===t.button){var r=X(t,u[i].pickers.children);if(r){e.preventDefault(),e.stopPropagation(),n.axis=r.object.name,n.dispatchEvent(h),n.update(),b.copy(U).sub(R).normalize(),u[i].setActivePlane(n.axis,b);var a=X(t,[u[i].activePlane]);a&&(C.copy(n.object.position),F.copy(n.object.scale),I.extractRotation(n.object.matrix),P.extractRotation(n.object.matrixWorld),B.extractRotation(n.object.parent.matrixWorld),E.setFromMatrixScale(_.getInverse(n.object.parent.matrixWorld)),m.copy(a.point))}}l=!0}}function W(e){if(void 0!==n.object&&null!==n.axis&&!1!==l&&(void 0===e.button||0===e.button)){var t=X(e.changedTouches?e.changedTouches[0]:e,[u[i].activePlane]);!1!==t&&(e.preventDefault(),e.stopPropagation(),p.copy(t.point),"translate"===i?(p.sub(m),p.multiply(E),"local"===n.space&&(p.applyMatrix4(_.getInverse(P)),-1===n.axis.search("X")&&(p.x=0),-1===n.axis.search("Y")&&(p.y=0),-1===n.axis.search("Z")&&(p.z=0),p.applyMatrix4(I),n.object.position.copy(C),n.object.position.add(p)),"world"!==n.space&&-1===n.axis.search("XYZ")||(-1===n.axis.search("X")&&(p.x=0),-1===n.axis.search("Y")&&(p.y=0),-1===n.axis.search("Z")&&(p.z=0),p.applyMatrix4(_.getInverse(B)),n.object.position.copy(C),n.object.position.add(p)),null!==n.translationSnap&&("local"===n.space&&n.object.position.applyMatrix4(_.getInverse(P)),-1!==n.axis.search("X")&&(n.object.position.x=Math.round(n.object.position.x/n.translationSnap)*n.translationSnap),-1!==n.axis.search("Y")&&(n.object.position.y=Math.round(n.object.position.y/n.translationSnap)*n.translationSnap),-1!==n.axis.search("Z")&&(n.object.position.z=Math.round(n.object.position.z/n.translationSnap)*n.translationSnap),"local"===n.space&&n.object.position.applyMatrix4(P))):"scale"===i?(p.sub(m),p.multiply(E),"local"===n.space&&("XYZ"===n.axis?(y=1+p.y/Math.max(F.x,F.y,F.z),n.object.scale.x=F.x*y,n.object.scale.y=F.y*y,n.object.scale.z=F.z*y):(p.applyMatrix4(_.getInverse(P)),"X"===n.axis&&(n.object.scale.x=F.x*(1+p.x/F.x)),"Y"===n.axis&&(n.object.scale.y=F.y*(1+p.y/F.y)),"Z"===n.axis&&(n.object.scale.z=F.z*(1+p.z/F.z))))):"rotate"===i&&(p.sub(R),p.multiply(E),O.copy(m).sub(R),O.multiply(E),"E"===n.axis?(p.applyMatrix4(_.getInverse(T)),O.applyMatrix4(_.getInverse(T)),g.set(Math.atan2(p.z,p.y),Math.atan2(p.x,p.z),Math.atan2(p.y,p.x)),v.set(Math.atan2(O.z,O.y),Math.atan2(O.x,O.z),Math.atan2(O.y,O.x)),w.setFromRotationMatrix(_.getInverse(B)),S.setFromAxisAngle(b,g.z-v.z),M.setFromRotationMatrix(P),w.multiplyQuaternions(w,S),w.multiplyQuaternions(w,M),n.object.quaternion.copy(w)):"XYZE"===n.axis?(S.setFromEuler(p.clone().cross(O).normalize()),w.setFromRotationMatrix(_.getInverse(B)),G.setFromAxisAngle(S,-p.clone().angleTo(O)),M.setFromRotationMatrix(P),w.multiplyQuaternions(w,G),w.multiplyQuaternions(w,M),n.object.quaternion.copy(w)):"local"===n.space?(p.applyMatrix4(_.getInverse(P)),O.applyMatrix4(_.getInverse(P)),g.set(Math.atan2(p.z,p.y),Math.atan2(p.x,p.z),Math.atan2(p.y,p.x)),v.set(Math.atan2(O.z,O.y),Math.atan2(O.x,O.z),Math.atan2(O.y,O.x)),M.setFromRotationMatrix(I),null!==n.rotationSnap?(G.setFromAxisAngle(N,Math.round((g.x-v.x)/n.rotationSnap)*n.rotationSnap),k.setFromAxisAngle(A,Math.round((g.y-v.y)/n.rotationSnap)*n.rotationSnap),L.setFromAxisAngle(x,Math.round((g.z-v.z)/n.rotationSnap)*n.rotationSnap)):(G.setFromAxisAngle(N,g.x-v.x),k.setFromAxisAngle(A,g.y-v.y),L.setFromAxisAngle(x,g.z-v.z)),"X"===n.axis&&M.multiplyQuaternions(M,G),"Y"===n.axis&&M.multiplyQuaternions(M,k),"Z"===n.axis&&M.multiplyQuaternions(M,L),n.object.quaternion.copy(M)):"world"===n.space&&(g.set(Math.atan2(p.z,p.y),Math.atan2(p.x,p.z),Math.atan2(p.y,p.x)),v.set(Math.atan2(O.z,O.y),Math.atan2(O.x,O.z),Math.atan2(O.y,O.x)),w.setFromRotationMatrix(_.getInverse(B)),null!==n.rotationSnap?(G.setFromAxisAngle(N,Math.round((g.x-v.x)/n.rotationSnap)*n.rotationSnap),k.setFromAxisAngle(A,Math.round((g.y-v.y)/n.rotationSnap)*n.rotationSnap),L.setFromAxisAngle(x,Math.round((g.z-v.z)/n.rotationSnap)*n.rotationSnap)):(G.setFromAxisAngle(N,g.x-v.x),k.setFromAxisAngle(A,g.y-v.y),L.setFromAxisAngle(x,g.z-v.z)),M.setFromRotationMatrix(P),"X"===n.axis&&w.multiplyQuaternions(w,G),"Y"===n.axis&&w.multiplyQuaternions(w,k),"Z"===n.axis&&w.multiplyQuaternions(w,L),w.multiplyQuaternions(w,M),n.object.quaternion.copy(w))),n.update(),n.dispatchEvent(a),n.dispatchEvent(c))}}function Z(e){e.preventDefault(),void 0!==e.button&&0!==e.button||(l&&null!==n.axis&&(r.mode=i,n.dispatchEvent(r)),l=!1,"TouchEvent"in window&&e instanceof TouchEvent?(n.axis=null,n.update(),n.dispatchEvent(a)):V(e))}function X(e,t){var r=o.getBoundingClientRect(),a=(e.clientX-r.left)/r.width,n=(e.clientY-r.top)/r.height;f.set(2*a-1,-2*n+1),d.setFromCamera(f,s);var i=d.intersectObjects(t,!0);return!!i[0]&&i[0]}o.addEventListener("mousedown",j,!1),o.addEventListener("touchstart",j,!1),o.addEventListener("mousemove",V,!1),o.addEventListener("touchmove",V,!1),o.addEventListener("mousemove",W,!1),o.addEventListener("touchmove",W,!1),o.addEventListener("mouseup",Z,!1),o.addEventListener("mouseout",Z,!1),o.addEventListener("touchend",Z,!1),o.addEventListener("touchcancel",Z,!1),o.addEventListener("touchleave",Z,!1),this.dispose=function(){o.removeEventListener("mousedown",j),o.removeEventListener("touchstart",j),o.removeEventListener("mousemove",V),o.removeEventListener("touchmove",V),o.removeEventListener("mousemove",W),o.removeEventListener("touchmove",W),o.removeEventListener("mouseup",Z),o.removeEventListener("mouseout",Z),o.removeEventListener("touchend",Z),o.removeEventListener("touchcancel",Z),o.removeEventListener("touchleave",Z)},this.attach=function(e){this.object=e,this.visible=!0,this.update()},this.detach=function(){this.object=void 0,this.visible=!1,this.axis=null},this.getMode=function(){return i},this.setMode=function(e){for(var t in"scale"===(i=e||i)&&(n.space="local"),u)u[t].visible=t===i;this.update(),n.dispatchEvent(a)},this.setTranslationSnap=function(e){n.translationSnap=e},this.setRotationSnap=function(e){n.rotationSnap=e},this.setSize=function(e){n.size=e,this.update(),n.dispatchEvent(a)},this.setSpace=function(e){n.space=e,this.update(),n.dispatchEvent(a)},this.update=function(){void 0!==n.object&&(n.object.updateMatrixWorld(),R.setFromMatrixPosition(n.object.matrixWorld),D.setFromRotationMatrix(_.extractRotation(n.object.matrixWorld)),s.updateMatrixWorld(),U.setFromMatrixPosition(s.matrixWorld),z.setFromRotationMatrix(_.extractRotation(s.matrixWorld)),y=R.distanceTo(U)/6*n.size,this.position.copy(R),this.scale.set(y,y,y),s instanceof TONG.PerspectiveCamera?b.copy(U).sub(R).normalize():s instanceof TONG.OrthographicCamera&&b.copy(U).normalize(),"local"===n.space?u[i].update(D,b):"world"===n.space&&u[i].update(new TONG.Euler,b),u[i].highlight(n.axis))}},TONG.TransformControls.prototype=Object.create(TONG.Object3D.prototype),TONG.TransformControls.prototype.constructor=TONG.TransformControls}(),function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self),t.JSZip=e()}}(function(){return function n(i,s,o){function l(r,e){if(!s[r]){if(!i[r]){var t="function"==typeof require&&require;if(!e&&t)return t(r,!0);if(u)return u(r,!0);throw new Error("Cannot find module '"+r+"'")}var a=s[r]={exports:{}};i[r][0].call(a.exports,function(e){var t=i[r][1][e];return l(t||e)},a,a.exports,n,i,s,o)}return s[r].exports}for(var u="function"==typeof require&&require,e=0;e<o.length;e++)l(o[e]);return l}({1:[function(e,t,r){var h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";r.encode=function(e){for(var t,r,a,n,i,s,o,l="",u=0;u<e.length;)n=(t=e.charCodeAt(u++))>>2,i=(3&t)<<4|(r=e.charCodeAt(u++))>>4,s=(15&r)<<2|(a=e.charCodeAt(u++))>>6,o=63&a,isNaN(r)?s=o=64:isNaN(a)&&(o=64),l=l+h.charAt(n)+h.charAt(i)+h.charAt(s)+h.charAt(o);return l},r.decode=function(e){var t,r,a,n,i,s,o="",l=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");l<e.length;)t=h.indexOf(e.charAt(l++))<<2|(n=h.indexOf(e.charAt(l++)))>>4,r=(15&n)<<4|(i=h.indexOf(e.charAt(l++)))>>2,a=(3&i)<<6|(s=h.indexOf(e.charAt(l++))),o+=String.fromCharCode(t),64!=i&&(o+=String.fromCharCode(r)),64!=s&&(o+=String.fromCharCode(a));return o}},{}],2:[function(e,t){function r(){this.compressedSize=0,this.uncompressedSize=0,this.crc32=0,this.compressionMethod=null,this.compressedContent=null}r.prototype={getContent:function(){return null},getCompressedContent:function(){return null}},t.exports=r},{}],3:[function(e,t,r){r.STORE={magic:"\0\0",compress:function(e){return e},uncompress:function(e){return e},compressInputType:null,uncompressInputType:null},r.DEFLATE=e("./flate")},{"./flate":8}],4:[function(e,t){var s=e("./utils"),o=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117];t.exports=function(e,t){if(void 0===e||!e.length)return 0;var r="string"!==s.getTypeOf(e);void 0===t&&(t=0);var a=0;t^=-1;for(var n=0,i=e.length;n<i;n++)a=r?e[n]:e.charCodeAt(n),t=t>>>8^o[255&(t^a)];return-1^t}},{"./utils":21}],5:[function(e,t){function r(){this.data=null,this.length=0,this.index=0}var a=e("./utils");r.prototype={checkOffset:function(e){this.checkIndex(this.index+e)},checkIndex:function(e){if(this.length<e||e<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+e+"). Corrupted zip ?")},setIndex:function(e){this.checkIndex(e),this.index=e},skip:function(e){this.setIndex(this.index+e)},byteAt:function(){},readInt:function(e){var t,r=0;for(this.checkOffset(e),t=this.index+e-1;t>=this.index;t--)r=(r<<8)+this.byteAt(t);return this.index+=e,r},readString:function(e){return a.transformTo("string",this.readData(e))},readData:function(){},lastIndexOfSignature:function(){},readDate:function(){var e=this.readInt(4);return new Date(1980+(e>>25&127),(e>>21&15)-1,e>>16&31,e>>11&31,e>>5&63,(31&e)<<1)}},t.exports=r},{"./utils":21}],6:[function(e,t,r){r.base64=!1,r.binary=!1,r.dir=!1,r.createFolders=!1,r.date=null,r.compression=null,r.comment=null},{}],7:[function(e,t,r){var a=e("./utils");r.string2binary=function(e){return a.string2binary(e)},r.string2Uint8Array=function(e){return a.transformTo("uint8array",e)},r.uint8Array2String=function(e){return a.transformTo("string",e)},r.string2Blob=function(e){var t=a.transformTo("arraybuffer",e);return a.arrayBuffer2Blob(t)},r.arrayBuffer2Blob=function(e){return a.arrayBuffer2Blob(e)},r.transformTo=function(e,t){return a.transformTo(e,t)},r.getTypeOf=function(e){return a.getTypeOf(e)},r.checkSupport=function(e){return a.checkSupport(e)},r.MAX_VALUE_16BITS=a.MAX_VALUE_16BITS,r.MAX_VALUE_32BITS=a.MAX_VALUE_32BITS,r.pretty=function(e){return a.pretty(e)},r.findCompression=function(e){return a.findCompression(e)},r.isRegExp=function(e){return a.isRegExp(e)}},{"./utils":21}],8:[function(e,t,r){var a="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array,n=e("pako");r.uncompressInputType=a?"uint8array":"array",r.compressInputType=a?"uint8array":"array",r.magic="\b\0",r.compress=function(e){return n.deflateRaw(e)},r.uncompress=function(e){return n.inflateRaw(e)}},{pako:24}],9:[function(e,t){function r(e,t){return this instanceof r?(this.files={},this.comment=null,this.root="",e&&this.load(e,t),void(this.clone=function(){var e=new r;for(var t in this)"function"!=typeof this[t]&&(e[t]=this[t]);return e})):new r(e,t)}var a=e("./base64");(r.prototype=e("./object")).load=e("./load"),r.support=e("./support"),r.defaults=e("./defaults"),r.utils=e("./deprecatedPublicUtils"),r.base64={encode:function(e){return a.encode(e)},decode:function(e){return a.decode(e)}},r.compressions=e("./compressions"),t.exports=r},{"./base64":1,"./compressions":3,"./defaults":6,"./deprecatedPublicUtils":7,"./load":10,"./object":13,"./support":17}],10:[function(e,t){var s=e("./base64"),o=e("./zipEntries");t.exports=function(e,t){var r,a,n,i;for((t=t||{}).base64&&(e=s.decode(e)),r=(a=new o(e,t)).files,n=0;n<r.length;n++)i=r[n],this.file(i.fileName,i.decompressed,{binary:!0,optimizedBinaryString:!0,date:i.date,dir:i.dir,comment:i.fileComment.length?i.fileComment:null,createFolders:t.createFolders});return a.zipComment.length&&(this.comment=a.zipComment),this}},{"./base64":1,"./zipEntries":22}],11:[function(e,t){(function(r){t.exports=function(e,t){return new r(e,t)},t.exports.test=function(e){return r.isBuffer(e)}}).call(this,"undefined"!=typeof Buffer?Buffer:void 0)},{}],12:[function(e,t){function r(e){this.data=e,this.length=this.data.length,this.index=0}var a=e("./uint8ArrayReader");(r.prototype=new a).readData=function(e){this.checkOffset(e);var t=this.data.slice(this.index,this.index+e);return this.index+=e,t},t.exports=r},{"./uint8ArrayReader":18}],13:[function(e,t){var r=e("./support"),y=e("./utils"),T=e("./crc32"),b=e("./signature"),o=e("./defaults"),g=e("./base64"),v=e("./compressions"),l=e("./compressedObject"),a=e("./nodeBuffer"),_=e("./utf8"),O=e("./stringWriter"),w=e("./uint8ArrayWriter"),n=function(e){if(e._data instanceof l&&(e._data=e._data.getContent(),e.options.binary=!0,e.options.base64=!1,"uint8array"===y.getTypeOf(e._data))){var t=e._data;e._data=new Uint8Array(t.length),0!==t.length&&e._data.set(t,0)}return e._data},i=function(e){var t=n(e);return"string"===y.getTypeOf(t)?!e.options.binary&&r.nodebuffer?a(t,"utf-8"):e.asBinary():t},s=function(e){var t=n(this);return null==t?"":(this.options.base64&&(t=g.decode(t)),t=e&&this.options.binary?f.utf8decode(t):y.transformTo("string",t),e||this.options.binary||(t=y.transformTo("string",f.utf8encode(t))),t)},u=function(e,t,r){this.name=e,this.dir=r.dir,this.date=r.date,this.comment=r.comment,this._data=t,this.options=r,this._initialMetadata={dir:r.dir,date:r.date}};u.prototype={asText:function(){return s.call(this,!0)},asBinary:function(){return s.call(this,!1)},asNodeBuffer:function(){var e=i(this);return y.transformTo("nodebuffer",e)},asUint8Array:function(){var e=i(this);return y.transformTo("uint8array",e)},asArrayBuffer:function(){return this.asUint8Array().buffer}};var N=function(e,t){var r,a="";for(r=0;r<t;r++)a+=String.fromCharCode(255&e),e>>>=8;return a},A=function(){var e,t,r={};for(e=0;e<arguments.length;e++)for(t in arguments[e])arguments[e].hasOwnProperty(t)&&void 0===r[t]&&(r[t]=arguments[e][t]);return r},h=function(e,t,r){var a,n,i=y.getTypeOf(t);if(!0!==(n=(n=r)||{}).base64||null!==n.binary&&void 0!==n.binary||(n.binary=!0),(n=A(n,o)).date=n.date||new Date,null!==n.compression&&(n.compression=n.compression.toUpperCase()),(r=n).createFolders&&(a=c(e))&&d.call(this,a,!0),r.dir||null==t)r.base64=!1,r.binary=!1,t=null;else if("string"===i)r.binary&&!r.base64&&!0!==r.optimizedBinaryString&&(t=y.string2binary(t));else{if(r.base64=!1,r.binary=!0,!(i||t instanceof l))throw new Error("The data of '"+e+"' is in an unsupported format !");"arraybuffer"===i&&(t=y.transformTo("uint8array",t))}var s=new u(e,t,r);return this.files[e]=s},c=function(e){"/"==e.slice(-1)&&(e=e.substring(0,e.length-1));var t=e.lastIndexOf("/");return 0<t?e.substring(0,t):""},d=function(e,t){return"/"!=e.slice(-1)&&(e+="/"),t=void 0!==t&&t,this.files[e]||h.call(this,e,null,{dir:!0,createFolders:t}),this.files[e]},x=function(e,t){var r,a=new l;return e._data instanceof l?(a.uncompressedSize=e._data.uncompressedSize,a.crc32=e._data.crc32,0===a.uncompressedSize||e.dir?(t=v.STORE,a.compressedContent="",a.crc32=0):e._data.compressionMethod===t.magic?a.compressedContent=e._data.getCompressedContent():(r=e._data.getContent(),a.compressedContent=t.compress(y.transformTo(t.compressInputType,r)))):((!(r=i(e))||0===r.length||e.dir)&&(t=v.STORE,r=""),a.uncompressedSize=r.length,a.crc32=T(r),a.compressedContent=t.compress(y.transformTo(t.compressInputType,r))),a.compressedSize=a.compressedContent.length,a.compressionMethod=t.magic,a},M=function(e,t,r,a){var n,i,s,o,l=(r.compressedContent,y.transformTo("string",_.utf8encode(t.name))),u=t.comment||"",h=y.transformTo("string",_.utf8encode(u)),c=l.length!==t.name.length,d=h.length!==u.length,f=t.options,p="",m="",g="";s=t._initialMetadata.dir!==t.dir?t.dir:f.dir,n=(o=t._initialMetadata.date!==t.date?t.date:f.date).getHours(),n<<=6,n|=o.getMinutes(),n<<=5,n|=o.getSeconds()/2,i=o.getFullYear()-1980,i<<=4,i|=o.getMonth()+1,i<<=5,i|=o.getDate(),c&&(m=N(1,1)+N(T(l),4)+l,p+="up"+N(m.length,2)+m),d&&(g=N(1,1)+N(this.crc32(h),4)+h,p+="uc"+N(g.length,2)+g);var v="";return v+="\n\0",v+=c||d?"\0\b":"\0\0",v+=r.compressionMethod,v+=N(n,2),v+=N(i,2),v+=N(r.crc32,4),v+=N(r.compressedSize,4),v+=N(r.uncompressedSize,4),v+=N(l.length,2),v+=N(p.length,2),{fileRecord:b.LOCAL_FILE_HEADER+v+l+p,dirRecord:b.CENTRAL_FILE_HEADER+"\0"+v+N(h.length,2)+"\0\0\0\0"+(!0===s?"\0\0\0":"\0\0\0\0")+N(a,4)+l+p+h,compressedObject:r}},f={load:function(){throw new Error("Load method is not defined. Is the file jszip-load.js included ?")},filter:function(e){var t,r,a,n,i=[];for(t in this.files)this.files.hasOwnProperty(t)&&(a=this.files[t],n=new u(a.name,a._data,A(a.options)),r=t.slice(this.root.length,t.length),t.slice(0,this.root.length)===this.root&&e(r,n)&&i.push(n));return i},file:function(r,e,t){if(1===arguments.length){if(y.isRegExp(r)){var a=r;return this.filter(function(e,t){return!t.dir&&a.test(e)})}return this.filter(function(e,t){return!t.dir&&e===r})[0]||null}return r=this.root+r,h.call(this,r,e,t),this},folder:function(r){if(!r)return this;if(y.isRegExp(r))return this.filter(function(e,t){return t.dir&&r.test(e)});var e=this.root+r,t=d.call(this,e),a=this.clone();return a.root=t.name,a},remove:function(r){r=this.root+r;var e=this.files[r];if(e||("/"!=r.slice(-1)&&(r+="/"),e=this.files[r]),e&&!e.dir)delete this.files[r];else for(var t=this.filter(function(e,t){return t.name.slice(0,r.length)===r}),a=0;a<t.length;a++)delete this.files[t[a].name];return this},generate:function(e){e=A(e||{},{base64:!0,compression:"STORE",type:"base64",comment:null}),y.checkSupport(e.type);var t,r,a=[],n=0,i=0,s=y.transformTo("string",this.utf8encode(e.comment||this.comment||""));for(var o in this.files)if(this.files.hasOwnProperty(o)){var l=this.files[o],u=l.options.compression||e.compression.toUpperCase(),h=v[u];if(!h)throw new Error(u+" is not a valid compression method !");var c=x.call(this,l,h),d=M.call(this,o,l,c,n);n+=d.fileRecord.length+c.compressedSize,i+=d.dirRecord.length,a.push(d)}var f;f=b.CENTRAL_DIRECTORY_END+"\0\0\0\0"+N(a.length,2)+N(a.length,2)+N(i,4)+N(n,4)+N(s.length,2)+s;var p=e.type.toLowerCase();for(t="uint8array"===p||"arraybuffer"===p||"blob"===p||"nodebuffer"===p?new w(n+i+f.length):new O(n+i+f.length),r=0;r<a.length;r++)t.append(a[r].fileRecord),t.append(a[r].compressedObject.compressedContent);for(r=0;r<a.length;r++)t.append(a[r].dirRecord);t.append(f);var m=t.finalize();switch(e.type.toLowerCase()){case"uint8array":case"arraybuffer":case"nodebuffer":return y.transformTo(e.type.toLowerCase(),m);case"blob":return y.arrayBuffer2Blob(y.transformTo("arraybuffer",m));case"base64":return e.base64?g.encode(m):m;default:return m}},crc32:function(e,t){return T(e,t)},utf8encode:function(e){return y.transformTo("string",_.utf8encode(e))},utf8decode:function(e){return _.utf8decode(e)}};t.exports=f},{"./base64":1,"./compressedObject":2,"./compressions":3,"./crc32":4,"./defaults":6,"./nodeBuffer":11,"./signature":14,"./stringWriter":16,"./support":17,"./uint8ArrayWriter":19,"./utf8":20,"./utils":21}],14:[function(e,t,r){r.LOCAL_FILE_HEADER="PK",r.CENTRAL_FILE_HEADER="PK",r.CENTRAL_DIRECTORY_END="PK",r.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK",r.ZIP64_CENTRAL_DIRECTORY_END="PK",r.DATA_DESCRIPTOR="PK\b"},{}],15:[function(e,t){function r(e,t){this.data=e,t||(this.data=n.string2binary(this.data)),this.length=this.data.length,this.index=0}var a=e("./dataReader"),n=e("./utils");(r.prototype=new a).byteAt=function(e){return this.data.charCodeAt(e)},r.prototype.lastIndexOfSignature=function(e){return this.data.lastIndexOf(e)},r.prototype.readData=function(e){this.checkOffset(e);var t=this.data.slice(this.index,this.index+e);return this.index+=e,t},t.exports=r},{"./dataReader":5,"./utils":21}],16:[function(e,t){var r=e("./utils"),a=function(){this.data=[]};a.prototype={append:function(e){e=r.transformTo("string",e),this.data.push(e)},finalize:function(){return this.data.join("")}},t.exports=a},{"./utils":21}],17:[function(e,t,a){(function(e){if(a.base64=!0,a.array=!0,a.string=!0,a.arraybuffer="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof Uint8Array,a.nodebuffer=void 0!==e,a.uint8array="undefined"!=typeof Uint8Array,"undefined"==typeof ArrayBuffer)a.blob=!1;else{var t=new ArrayBuffer(0);try{a.blob=0===new Blob([t],{type:"application/zip"}).size}catch(e){try{var r=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder);r.append(t),a.blob=0===r.getBlob("application/zip").size}catch(e){a.blob=!1}}}}).call(this,"undefined"!=typeof Buffer?Buffer:void 0)},{}],18:[function(e,t){function r(e){e&&(this.data=e,this.length=this.data.length,this.index=0)}var a=e("./dataReader");(r.prototype=new a).byteAt=function(e){return this.data[e]},r.prototype.lastIndexOfSignature=function(e){for(var t=e.charCodeAt(0),r=e.charCodeAt(1),a=e.charCodeAt(2),n=e.charCodeAt(3),i=this.length-4;0<=i;--i)if(this.data[i]===t&&this.data[i+1]===r&&this.data[i+2]===a&&this.data[i+3]===n)return i;return-1},r.prototype.readData=function(e){if(this.checkOffset(e),0===e)return new Uint8Array(0);var t=this.data.subarray(this.index,this.index+e);return this.index+=e,t},t.exports=r},{"./dataReader":5}],19:[function(e,t){var r=e("./utils"),a=function(e){this.data=new Uint8Array(e),this.index=0};a.prototype={append:function(e){0!==e.length&&(e=r.transformTo("uint8array",e),this.data.set(e,this.index),this.index+=e.length)},finalize:function(){return this.data}},t.exports=a},{"./utils":21}],20:[function(e,t,r){for(var o=e("./utils"),l=e("./support"),a=e("./nodeBuffer"),u=new Array(256),n=0;n<256;n++)u[n]=252<=n?6:248<=n?5:240<=n?4:224<=n?3:192<=n?2:1;u[254]=u[254]=1;var i=function(e,t){var r;for((t=t||e.length)>e.length&&(t=e.length),r=t-1;0<=r&&128==(192&e[r]);)r--;return r<0?t:0===r?t:r+u[e[r]]>t?r:t},s=function(e){var t,r,a,n,i=e.length,s=new Array(2*i);for(t=r=0;t<i;)if((a=e[t++])<128)s[r++]=a;else if(4<(n=u[a]))s[r++]=65533,t+=n-1;else{for(a&=2===n?31:3===n?15:7;1<n&&t<i;)a=a<<6|63&e[t++],n--;1<n?s[r++]=65533:a<65536?s[r++]=a:(a-=65536,s[r++]=55296|a>>10&1023,s[r++]=56320|1023&a)}return s.length!==r&&(s.subarray?s=s.subarray(0,r):s.length=r),o.applyFromCharCode(s)};r.utf8encode=function(e){return l.nodebuffer?a(e,"utf-8"):function(e){var t,r,a,n,i,s=e.length,o=0;for(n=0;n<s;n++)55296==(64512&(r=e.charCodeAt(n)))&&n+1<s&&56320==(64512&(a=e.charCodeAt(n+1)))&&(r=65536+(r-55296<<10)+(a-56320),n++),o+=r<128?1:r<2048?2:r<65536?3:4;for(t=l.uint8array?new Uint8Array(o):new Array(o),n=i=0;i<o;n++)55296==(64512&(r=e.charCodeAt(n)))&&n+1<s&&56320==(64512&(a=e.charCodeAt(n+1)))&&(r=65536+(r-55296<<10)+(a-56320),n++),r<128?t[i++]=r:(r<2048?t[i++]=192|r>>>6:(r<65536?t[i++]=224|r>>>12:(t[i++]=240|r>>>18,t[i++]=128|r>>>12&63),t[i++]=128|r>>>6&63),t[i++]=128|63&r);return t}(e)},r.utf8decode=function(e){if(l.nodebuffer)return o.transformTo("nodebuffer",e).toString("utf-8");for(var t=[],r=0,a=(e=o.transformTo(l.uint8array?"uint8array":"array",e)).length;r<a;){var n=i(e,Math.min(r+65536,a));t.push(l.uint8array?s(e.subarray(r,n)):s(e.slice(r,n))),r=n}return t.join("")}},{"./nodeBuffer":11,"./support":17,"./utils":21}],21:[function(e,t,u){function r(e){return e}function a(e,t){for(var r=0;r<e.length;++r)t[r]=255&e.charCodeAt(r);return t}function n(e){var t=65536,r=[],a=e.length,n=u.getTypeOf(e),i=0,s=!0;try{switch(n){case"uint8array":String.fromCharCode.apply(null,new Uint8Array(0));break;case"nodebuffer":String.fromCharCode.apply(null,h(0))}}catch(e){s=!1}if(!s){for(var o="",l=0;l<e.length;l++)o+=String.fromCharCode(e[l]);return o}for(;i<a&&1<t;)try{r.push("array"===n||"nodebuffer"===n?String.fromCharCode.apply(null,e.slice(i,Math.min(i+t,a))):String.fromCharCode.apply(null,e.subarray(i,Math.min(i+t,a)))),i+=t}catch(e){t=Math.floor(t/2)}return r.join("")}function i(e,t){for(var r=0;r<e.length;r++)t[r]=e[r];return t}var s=e("./support"),o=e("./compressions"),h=e("./nodeBuffer");u.string2binary=function(e){for(var t="",r=0;r<e.length;r++)t+=String.fromCharCode(255&e.charCodeAt(r));return t},u.arrayBuffer2Blob=function(t){u.checkSupport("blob");try{return new Blob([t],{type:"application/zip"})}catch(e){try{var r=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder);return r.append(t),r.getBlob("application/zip")}catch(e){throw new Error("Bug : can't construct the Blob.")}}},u.applyFromCharCode=n;var l={};l.string={string:r,array:function(e){return a(e,new Array(e.length))},arraybuffer:function(e){return l.string.uint8array(e).buffer},uint8array:function(e){return a(e,new Uint8Array(e.length))},nodebuffer:function(e){return a(e,h(e.length))}},l.array={string:n,array:r,arraybuffer:function(e){return new Uint8Array(e).buffer},uint8array:function(e){return new Uint8Array(e)},nodebuffer:function(e){return h(e)}},l.arraybuffer={string:function(e){return n(new Uint8Array(e))},array:function(e){return i(new Uint8Array(e),new Array(e.byteLength))},arraybuffer:r,uint8array:function(e){return new Uint8Array(e)},nodebuffer:function(e){return h(new Uint8Array(e))}},l.uint8array={string:n,array:function(e){return i(e,new Array(e.length))},arraybuffer:function(e){return e.buffer},uint8array:r,nodebuffer:function(e){return h(e)}},l.nodebuffer={string:n,array:function(e){return i(e,new Array(e.length))},arraybuffer:function(e){return l.nodebuffer.uint8array(e).buffer},uint8array:function(e){return i(e,new Uint8Array(e.length))},nodebuffer:r},u.transformTo=function(e,t){if(t||(t=""),!e)return t;u.checkSupport(e);var r=u.getTypeOf(t);return l[r][e](t)},u.getTypeOf=function(e){return"string"==typeof e?"string":"[object Array]"===Object.prototype.toString.call(e)?"array":s.nodebuffer&&h.test(e)?"nodebuffer":s.uint8array&&e instanceof Uint8Array?"uint8array":s.arraybuffer&&e instanceof ArrayBuffer?"arraybuffer":void 0},u.checkSupport=function(e){if(!s[e.toLowerCase()])throw new Error(e+" is not supported by this browser")},u.MAX_VALUE_16BITS=65535,u.MAX_VALUE_32BITS=-1,u.pretty=function(e){var t,r,a="";for(r=0;r<(e||"").length;r++)a+="\\x"+((t=e.charCodeAt(r))<16?"0":"")+t.toString(16).toUpperCase();return a},u.findCompression=function(e){for(var t in o)if(o.hasOwnProperty(t)&&o[t].magic===e)return o[t];return null},u.isRegExp=function(e){return"[object RegExp]"===Object.prototype.toString.call(e)}},{"./compressions":3,"./nodeBuffer":11,"./support":17}],22:[function(e,t){function r(e,t){this.files=[],this.loadOptions=t,e&&this.load(e)}var a=e("./stringReader"),n=e("./nodeBufferReader"),i=e("./uint8ArrayReader"),s=e("./utils"),o=e("./signature"),l=e("./zipEntry"),u=e("./support"),h=e("./object");r.prototype={checkSignature:function(e){var t=this.reader.readString(4);if(t!==e)throw new Error("Corrupted zip or bug : unexpected signature ("+s.pretty(t)+", expected "+s.pretty(e)+")")},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2),this.zipComment=this.reader.readString(this.zipCommentLength),this.zipComment=h.utf8decode(this.zipComment)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.versionMadeBy=this.reader.readString(2),this.versionNeeded=this.reader.readInt(2),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var e,t,r,a=this.zip64EndOfCentralSize-44;0<a;)e=this.reader.readInt(2),t=this.reader.readInt(4),r=this.reader.readString(t),this.zip64ExtensibleData[e]={id:e,length:t,value:r}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var e,t;for(e=0;e<this.files.length;e++)t=this.files[e],this.reader.setIndex(t.localHeaderOffset),this.checkSignature(o.LOCAL_FILE_HEADER),t.readLocalPart(this.reader),t.handleUTF8()},readCentralDir:function(){var e;for(this.reader.setIndex(this.centralDirOffset);this.reader.readString(4)===o.CENTRAL_FILE_HEADER;)(e=new l({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(e)},readEndOfCentral:function(){var e=this.reader.lastIndexOfSignature(o.CENTRAL_DIRECTORY_END);if(-1===e)throw new Error("Corrupted zip : can't find end of central directory");if(this.reader.setIndex(e),this.checkSignature(o.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===s.MAX_VALUE_16BITS||this.diskWithCentralDirStart===s.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===s.MAX_VALUE_16BITS||this.centralDirRecords===s.MAX_VALUE_16BITS||this.centralDirSize===s.MAX_VALUE_32BITS||this.centralDirOffset===s.MAX_VALUE_32BITS){if(this.zip64=!0,-1===(e=this.reader.lastIndexOfSignature(o.ZIP64_CENTRAL_DIRECTORY_LOCATOR)))throw new Error("Corrupted zip : can't find the ZIP64 end of central directory locator");this.reader.setIndex(e),this.checkSignature(o.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(o.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}},prepareReader:function(e){var t=s.getTypeOf(e);this.reader="string"!==t||u.uint8array?"nodebuffer"===t?new n(e):new i(s.transformTo("uint8array",e)):new a(e,this.loadOptions.optimizedBinaryString)},load:function(e){this.prepareReader(e),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},t.exports=r},{"./nodeBufferReader":12,"./object":13,"./signature":14,"./stringReader":15,"./support":17,"./uint8ArrayReader":18,"./utils":21,"./zipEntry":23}],23:[function(e,t){function r(e,t){this.options=e,this.loadOptions=t}var a=e("./stringReader"),i=e("./utils"),n=e("./compressedObject"),s=e("./object");r.prototype={isEncrypted:function(){return 1==(1&this.bitFlag)},useUTF8:function(){return 2048==(2048&this.bitFlag)},prepareCompressedContent:function(r,a,n){return function(){var e=r.index;r.setIndex(a);var t=r.readData(n);return r.setIndex(e),t}},prepareContent:function(e,t,r,a,n){return function(){var e=i.transformTo(a.uncompressInputType,this.getCompressedContent()),t=a.uncompress(e);if(t.length!==n)throw new Error("Bug : uncompressed data size mismatch");return t}},readLocalPart:function(e){var t,r;if(e.skip(22),this.fileNameLength=e.readInt(2),r=e.readInt(2),this.fileName=e.readString(this.fileNameLength),e.skip(r),-1==this.compressedSize||-1==this.uncompressedSize)throw new Error("Bug or corrupted zip : didn't get enough informations from the central directory (compressedSize == -1 || uncompressedSize == -1)");if(null===(t=i.findCompression(this.compressionMethod)))throw new Error("Corrupted zip : compression "+i.pretty(this.compressionMethod)+" unknown (inner file : "+this.fileName+")");if(this.decompressed=new n,this.decompressed.compressedSize=this.compressedSize,this.decompressed.uncompressedSize=this.uncompressedSize,this.decompressed.crc32=this.crc32,this.decompressed.compressionMethod=this.compressionMethod,this.decompressed.getCompressedContent=this.prepareCompressedContent(e,e.index,this.compressedSize,t),this.decompressed.getContent=this.prepareContent(e,e.index,this.compressedSize,t,this.uncompressedSize),this.loadOptions.checkCRC32&&(this.decompressed=i.transformTo("string",this.decompressed.getContent()),s.crc32(this.decompressed)!==this.crc32))throw new Error("Corrupted zip : CRC32 mismatch")},readCentralPart:function(e){if(this.versionMadeBy=e.readString(2),this.versionNeeded=e.readInt(2),this.bitFlag=e.readInt(2),this.compressionMethod=e.readString(2),this.date=e.readDate(),this.crc32=e.readInt(4),this.compressedSize=e.readInt(4),this.uncompressedSize=e.readInt(4),this.fileNameLength=e.readInt(2),this.extraFieldsLength=e.readInt(2),this.fileCommentLength=e.readInt(2),this.diskNumberStart=e.readInt(2),this.internalFileAttributes=e.readInt(2),this.externalFileAttributes=e.readInt(4),this.localHeaderOffset=e.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");this.fileName=e.readString(this.fileNameLength),this.readExtraFields(e),this.parseZIP64ExtraField(e),this.fileComment=e.readString(this.fileCommentLength),this.dir=!!(16&this.externalFileAttributes)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var e=new a(this.extraFields[1].value);this.uncompressedSize===i.MAX_VALUE_32BITS&&(this.uncompressedSize=e.readInt(8)),this.compressedSize===i.MAX_VALUE_32BITS&&(this.compressedSize=e.readInt(8)),this.localHeaderOffset===i.MAX_VALUE_32BITS&&(this.localHeaderOffset=e.readInt(8)),this.diskNumberStart===i.MAX_VALUE_32BITS&&(this.diskNumberStart=e.readInt(4))}},readExtraFields:function(e){var t,r,a,n=e.index;for(this.extraFields=this.extraFields||{};e.index<n+this.extraFieldsLength;)t=e.readInt(2),r=e.readInt(2),a=e.readString(r),this.extraFields[t]={id:t,length:r,value:a}},handleUTF8:function(){if(this.useUTF8())this.fileName=s.utf8decode(this.fileName),this.fileComment=s.utf8decode(this.fileComment);else{var e=this.findExtraFieldUnicodePath();null!==e&&(this.fileName=e);var t=this.findExtraFieldUnicodeComment();null!==t&&(this.fileComment=t)}},findExtraFieldUnicodePath:function(){var e=this.extraFields[28789];if(e){var t=new a(e.value);return 1!==t.readInt(1)?null:s.crc32(this.fileName)!==t.readInt(4)?null:s.utf8decode(t.readString(e.length-5))}return null},findExtraFieldUnicodeComment:function(){var e=this.extraFields[25461];if(e){var t=new a(e.value);return 1!==t.readInt(1)?null:s.crc32(this.fileComment)!==t.readInt(4)?null:s.utf8decode(t.readString(e.length-5))}return null}},t.exports=r},{"./compressedObject":2,"./object":13,"./stringReader":15,"./utils":21}],24:[function(e,t){var r={};(0,e("./lib/utils/common").assign)(r,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),t.exports=r},{"./lib/deflate":25,"./lib/inflate":26,"./lib/utils/common":27,"./lib/zlib/constants":30}],25:[function(e,t,r){function a(e,t){var r=new u(t);if(r.push(e,!0),r.err)throw r.msg;return r.result}var s=e("./zlib/deflate.js"),o=e("./utils/common"),l=e("./utils/strings"),n=e("./zlib/messages"),i=e("./zlib/zstream"),u=function(e){this.options=o.assign({level:-1,method:8,chunkSize:16384,windowBits:15,memLevel:8,strategy:0,to:""},e||{});var t=this.options;t.raw&&0<t.windowBits?t.windowBits=-t.windowBits:t.gzip&&0<t.windowBits&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new i,this.strm.avail_out=0;var r=s.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(0!==r)throw new Error(n[r]);t.header&&s.deflateSetHeader(this.strm,t.header)};u.prototype.push=function(e,t){var r,a,n=this.strm,i=this.options.chunkSize;if(this.ended)return!1;a=t===~~t?t:!0===t?4:0,n.input="string"==typeof e?l.string2buf(e):e,n.next_in=0,n.avail_in=n.input.length;do{if(0===n.avail_out&&(n.output=new o.Buf8(i),n.next_out=0,n.avail_out=i),1!==(r=s.deflate(n,a))&&0!==r)return this.onEnd(r),!(this.ended=!0);(0===n.avail_out||0===n.avail_in&&4===a)&&this.onData("string"===this.options.to?l.buf2binstring(o.shrinkBuf(n.output,n.next_out)):o.shrinkBuf(n.output,n.next_out))}while((0<n.avail_in||0===n.avail_out)&&1!==r);return 4!==a||(r=s.deflateEnd(this.strm),this.onEnd(r),this.ended=!0,0===r)},u.prototype.onData=function(e){this.chunks.push(e)},u.prototype.onEnd=function(e){0===e&&(this.result="string"===this.options.to?this.chunks.join(""):o.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},r.Deflate=u,r.deflate=a,r.deflateRaw=function(e,t){return(t=t||{}).raw=!0,a(e,t)},r.gzip=function(e,t){return(t=t||{}).gzip=!0,a(e,t)}},{"./utils/common":27,"./utils/strings":28,"./zlib/deflate.js":32,"./zlib/messages":37,"./zlib/zstream":39}],26:[function(e,t,r){function a(e,t){var r=new o(t);if(r.push(e,!0),r.err)throw r.msg;return r.result}var u=e("./zlib/inflate.js"),h=e("./utils/common"),c=e("./utils/strings"),d=e("./zlib/constants"),n=e("./zlib/messages"),i=e("./zlib/zstream"),s=e("./zlib/gzheader"),o=function(e){this.options=h.assign({chunkSize:16384,windowBits:0,to:""},e||{});var t=this.options;t.raw&&0<=t.windowBits&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(0<=t.windowBits&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),15<t.windowBits&&t.windowBits<48&&0==(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new i,this.strm.avail_out=0;var r=u.inflateInit2(this.strm,t.windowBits);if(r!==d.Z_OK)throw new Error(n[r]);this.header=new s,u.inflateGetHeader(this.strm,this.header)};o.prototype.push=function(e,t){var r,a,n,i,s,o=this.strm,l=this.options.chunkSize;if(this.ended)return!1;a=t===~~t?t:!0===t?d.Z_FINISH:d.Z_NO_FLUSH,o.input="string"==typeof e?c.binstring2buf(e):e,o.next_in=0,o.avail_in=o.input.length;do{if(0===o.avail_out&&(o.output=new h.Buf8(l),o.next_out=0,o.avail_out=l),(r=u.inflate(o,d.Z_NO_FLUSH))!==d.Z_STREAM_END&&r!==d.Z_OK)return this.onEnd(r),!(this.ended=!0);o.next_out&&(0===o.avail_out||r===d.Z_STREAM_END||0===o.avail_in&&a===d.Z_FINISH)&&("string"===this.options.to?(n=c.utf8border(o.output,o.next_out),i=o.next_out-n,s=c.buf2string(o.output,n),o.next_out=i,o.avail_out=l-i,i&&h.arraySet(o.output,o.output,n,i,0),this.onData(s)):this.onData(h.shrinkBuf(o.output,o.next_out)))}while(0<o.avail_in&&r!==d.Z_STREAM_END);return r===d.Z_STREAM_END&&(a=d.Z_FINISH),a!==d.Z_FINISH||(r=u.inflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===d.Z_OK)},o.prototype.onData=function(e){this.chunks.push(e)},o.prototype.onEnd=function(e){e===d.Z_OK&&(this.result="string"===this.options.to?this.chunks.join(""):h.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},r.Inflate=o,r.inflate=a,r.inflateRaw=function(e,t){return(t=t||{}).raw=!0,a(e,t)},r.ungzip=a},{"./utils/common":27,"./utils/strings":28,"./zlib/constants":30,"./zlib/gzheader":33,"./zlib/inflate.js":35,"./zlib/messages":37,"./zlib/zstream":39}],27:[function(e,t,r){var a="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;r.assign=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var r=t.shift();if(r){if("object"!=typeof r)throw new TypeError(r+"must be non-object");for(var a in r)r.hasOwnProperty(a)&&(e[a]=r[a])}}return e},r.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var n={arraySet:function(e,t,r,a,n){if(t.subarray&&e.subarray)e.set(t.subarray(r,r+a),n);else for(var i=0;i<a;i++)e[n+i]=t[r+i]},flattenChunks:function(e){var t,r,a,n,i,s;for(t=a=0,r=e.length;t<r;t++)a+=e[t].length;for(s=new Uint8Array(a),t=n=0,r=e.length;t<r;t++)i=e[t],s.set(i,n),n+=i.length;return s}},i={arraySet:function(e,t,r,a,n){for(var i=0;i<a;i++)e[n+i]=t[r+i]},flattenChunks:function(e){return[].concat.apply([],e)}};r.setTyped=function(e){e?(r.Buf8=Uint8Array,r.Buf16=Uint16Array,r.Buf32=Int32Array,r.assign(r,n)):(r.Buf8=Array,r.Buf16=Array,r.Buf32=Array,r.assign(r,i))},r.setTyped(a)},{}],28:[function(e,t,r){function l(e,t){if(t<65537&&(e.subarray&&i||!e.subarray&&n))return String.fromCharCode.apply(null,u.shrinkBuf(e,t));for(var r="",a=0;a<t;a++)r+=String.fromCharCode(e[a]);return r}var u=e("./common"),n=!0,i=!0;try{String.fromCharCode.apply(null,[0])}catch(e){n=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){i=!1}for(var h=new u.Buf8(256),a=0;a<256;a++)h[a]=252<=a?6:248<=a?5:240<=a?4:224<=a?3:192<=a?2:1;h[254]=h[254]=1,r.string2buf=function(e){var t,r,a,n,i,s=e.length,o=0;for(n=0;n<s;n++)55296==(64512&(r=e.charCodeAt(n)))&&n+1<s&&(56320==(64512&(a=e.charCodeAt(n+1)))&&(r=65536+(r-55296<<10)+(a-56320),n++)),o+=r<128?1:r<2048?2:r<65536?3:4;for(t=new u.Buf8(o),n=i=0;i<o;n++)55296==(64512&(r=e.charCodeAt(n)))&&n+1<s&&(56320==(64512&(a=e.charCodeAt(n+1)))&&(r=65536+(r-55296<<10)+(a-56320),n++)),r<128?t[i++]=r:(r<2048?t[i++]=192|r>>>6:(r<65536?t[i++]=224|r>>>12:(t[i++]=240|r>>>18,t[i++]=128|r>>>12&63),t[i++]=128|r>>>6&63),t[i++]=128|63&r);return t},r.buf2binstring=function(e){return l(e,e.length)},r.binstring2buf=function(e){for(var t=new u.Buf8(e.length),r=0,a=t.length;r<a;r++)t[r]=e.charCodeAt(r);return t},r.buf2string=function(e,t){var r,a,n,i,s=t||e.length,o=new Array(2*s);for(r=a=0;r<s;)if((n=e[r++])<128)o[a++]=n;else if(4<(i=h[n]))o[a++]=65533,r+=i-1;else{for(n&=2===i?31:3===i?15:7;1<i&&r<s;)n=n<<6|63&e[r++],i--;1<i?o[a++]=65533:n<65536?o[a++]=n:(n-=65536,o[a++]=55296|n>>10&1023,o[a++]=56320|1023&n)}return l(o,a)},r.utf8border=function(e,t){var r;for((t=t||e.length)>e.length&&(t=e.length),r=t-1;0<=r&&128==(192&e[r]);)r--;return r<0?t:0===r?t:r+h[e[r]]>t?r:t}},{"./common":27}],29:[function(e,t){t.exports=function(e,t,r,a){for(var n=65535&e|0,i=e>>>16&65535|0,s=0;0!==r;){for(r-=s=2e3<r?2e3:r;i=i+(n=n+t[a++]|0)|0,--s;);n%=65521,i%=65521}return n|i<<16|0}},{}],30:[function(e,t){t.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],31:[function(e,t){var o=function(){for(var e,t=[],r=0;r<256;r++){e=r;for(var a=0;a<8;a++)e=1&e?3988292384^e>>>1:e>>>1;t[r]=e}return t}();t.exports=function(e,t,r,a){var n=o,i=a+r;e^=-1;for(var s=a;s<i;s++)e=e>>>8^n[255&(e^t[s])];return-1^e}},{}],32:[function(e,t,r){function l(e,t){return e.msg=w[t],t}function u(e){return(e<<1)-(4<e?9:0)}function h(e){for(var t=e.length;0<=--t;)e[t]=0}function c(e){var t=e.state,r=t.pending;r>e.avail_out&&(r=e.avail_out),0!==r&&(T.arraySet(e.output,t.pending_buf,t.pending_out,r,e.next_out),e.next_out+=r,t.pending_out+=r,e.total_out+=r,e.avail_out-=r,t.pending-=r,0===t.pending&&(t.pending_out=0))}function d(e,t){b._tr_flush_block(e,0<=e.block_start?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,c(e.strm)}function f(e,t){e.pending_buf[e.pending++]=t}function p(e,t){e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t}function i(e,t){var r,a,n=e.max_chain_length,i=e.strstart,s=e.prev_length,o=e.nice_match,l=e.strstart>e.w_size-U?e.strstart-(e.w_size-U):0,u=e.window,h=e.w_mask,c=e.prev,d=e.strstart+P,f=u[i+s-1],p=u[i+s];e.prev_length>=e.good_match&&(n>>=2),o>e.lookahead&&(o=e.lookahead);do{if(u[(r=t)+s]===p&&u[r+s-1]===f&&u[r]===u[i]&&u[++r]===u[i+1]){i+=2,r++;do{}while(u[++i]===u[++r]&&u[++i]===u[++r]&&u[++i]===u[++r]&&u[++i]===u[++r]&&u[++i]===u[++r]&&u[++i]===u[++r]&&u[++i]===u[++r]&&u[++i]===u[++r]&&i<d);if(a=P-(d-i),i=d-P,s<a){if(e.match_start=t,o<=(s=a))break;f=u[i+s-1],p=u[i+s]}}}while((t=c[t&h])>l&&0!=--n);return s<=e.lookahead?s:e.lookahead}function m(e){var t,r,a,n,i,s,o,l,u,h,c=e.w_size;do{if(n=e.window_size-e.lookahead-e.strstart,e.strstart>=c+(c-U)){for(T.arraySet(e.window,e.window,c,c,0),e.match_start-=c,e.strstart-=c,e.block_start-=c,t=r=e.hash_size;a=e.head[--t],e.head[t]=c<=a?a-c:0,--r;);for(t=r=c;a=e.prev[--t],e.prev[t]=c<=a?a-c:0,--r;);n+=c}if(0===e.strm.avail_in)break;if(s=e.strm,o=e.window,l=e.strstart+e.lookahead,u=n,h=void 0,h=s.avail_in,u<h&&(h=u),r=0===h?0:(s.avail_in-=h,T.arraySet(o,s.input,s.next_in,h,l),1===s.state.wrap?s.adler=_(s.adler,o,h,l):2===s.state.wrap&&(s.adler=O(s.adler,o,h,l)),s.next_in+=h,s.total_in+=h,h),e.lookahead+=r,e.lookahead+e.insert>=D)for(i=e.strstart-e.insert,e.ins_h=e.window[i],e.ins_h=(e.ins_h<<e.hash_shift^e.window[i+1])&e.hash_mask;e.insert&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[i+D-1])&e.hash_mask,e.prev[i&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=i,i++,e.insert--,!(e.lookahead+e.insert<D)););}while(e.lookahead<U&&0!==e.strm.avail_in)}function a(e,t){for(var r,a;;){if(e.lookahead<U){if(m(e),e.lookahead<U&&t===N)return j;if(0===e.lookahead)break}if(r=0,e.lookahead>=D&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+D-1])&e.hash_mask,r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==r&&e.strstart-r<=e.w_size-U&&(e.match_length=i(e,r)),e.match_length>=D)if(a=b._tr_tally(e,e.strstart-e.match_start,e.match_length-D),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=D){for(e.match_length--;e.strstart++,e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+D-1])&e.hash_mask,r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart,0!=--e.match_length;);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+1])&e.hash_mask;else a=b._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(a&&(d(e,!1),0===e.strm.avail_out))return j}return e.insert=e.strstart<D-1?e.strstart:D-1,t===A?(d(e,!0),0===e.strm.avail_out?Z:X):e.last_lit&&(d(e,!1),0===e.strm.avail_out)?j:W}function n(e,t){for(var r,a,n;;){if(e.lookahead<U){if(m(e),e.lookahead<U&&t===N)return j;if(0===e.lookahead)break}if(r=0,e.lookahead>=D&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+D-1])&e.hash_mask,r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=D-1,0!==r&&e.prev_length<e.max_lazy_match&&e.strstart-r<=e.w_size-U&&(e.match_length=i(e,r),e.match_length<=5&&(1===e.strategy||e.match_length===D&&4096<e.strstart-e.match_start)&&(e.match_length=D-1)),e.prev_length>=D&&e.match_length<=e.prev_length){for(n=e.strstart+e.lookahead-D,a=b._tr_tally(e,e.strstart-1-e.prev_match,e.prev_length-D),e.lookahead-=e.prev_length-1,e.prev_length-=2;++e.strstart<=n&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+D-1])&e.hash_mask,r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!=--e.prev_length;);if(e.match_available=0,e.match_length=D-1,e.strstart++,a&&(d(e,!1),0===e.strm.avail_out))return j}else if(e.match_available){if((a=b._tr_tally(e,0,e.window[e.strstart-1]))&&d(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return j}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(a=b._tr_tally(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<D-1?e.strstart:D-1,t===A?(d(e,!0),0===e.strm.avail_out?Z:X):e.last_lit&&(d(e,!1),0===e.strm.avail_out)?j:W}function g(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=S,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new T.Buf16(2*E),this.dyn_dtree=new T.Buf16(2*(2*I+1)),this.bl_tree=new T.Buf16(2*(2*B+1)),h(this.dyn_ltree),h(this.dyn_dtree),h(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new T.Buf16(R+1),this.heap=new T.Buf16(2*F+1),h(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new T.Buf16(2*F+1),h(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function s(e){var t;return e&&e.state?(e.total_in=e.total_out=0,e.data_type=L,(t=e.state).pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?z:V,e.adler=2===t.wrap?0:1,t.last_flush=N,b._tr_init(t),x):l(e,M)}function v(e){var t,r=s(e);return r===x&&((t=e.state).window_size=2*t.w_size,h(t.head),t.max_lazy_match=y[t.level].max_lazy,t.good_match=y[t.level].good_length,t.nice_match=y[t.level].nice_length,t.max_chain_length=y[t.level].max_chain,t.strstart=0,t.block_start=0,t.lookahead=0,t.insert=0,t.match_length=t.prev_length=D-1,t.match_available=0,t.ins_h=0),r}function o(e,t,r,a,n,i){if(!e)return M;var s=1;if(t===G&&(t=6),a<0?(s=0,a=-a):15<a&&(s=2,a-=16),n<1||C<n||r!==S||a<8||15<a||t<0||9<t||i<0||k<i)return l(e,M);8===a&&(a=9);var o=new g;return(e.state=o).strm=e,o.wrap=s,o.gzhead=null,o.w_bits=a,o.w_size=1<<o.w_bits,o.w_mask=o.w_size-1,o.hash_bits=n+7,o.hash_size=1<<o.hash_bits,o.hash_mask=o.hash_size-1,o.hash_shift=~~((o.hash_bits+D-1)/D),o.window=new T.Buf8(2*o.w_size),o.head=new T.Buf16(o.hash_size),o.prev=new T.Buf16(o.w_size),o.lit_bufsize=1<<n+6,o.pending_buf_size=4*o.lit_bufsize,o.pending_buf=new T.Buf8(o.pending_buf_size),o.d_buf=o.lit_bufsize>>1,o.l_buf=3*o.lit_bufsize,o.level=t,o.strategy=i,o.method=r,v(e)}var y,T=e("../utils/common"),b=e("./trees"),_=e("./adler32"),O=e("./crc32"),w=e("./messages"),N=0,A=4,x=0,M=-2,G=-1,k=4,L=2,S=8,C=9,F=286,I=30,B=19,E=2*F+1,R=15,D=3,P=258,U=P+D+1,z=42,V=113,j=1,W=2,Z=3,X=4,K=function(e,t,r,a,n){this.good_length=e,this.max_lazy=t,this.nice_length=r,this.max_chain=a,this.func=n};y=[new K(0,0,0,0,function(e,t){var r=65535;for(r>e.pending_buf_size-5&&(r=e.pending_buf_size-5);;){if(e.lookahead<=1){if(m(e),0===e.lookahead&&t===N)return j;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;var a=e.block_start+r;if((0===e.strstart||e.strstart>=a)&&(e.lookahead=e.strstart-a,e.strstart=a,d(e,!1),0===e.strm.avail_out))return j;if(e.strstart-e.block_start>=e.w_size-U&&(d(e,!1),0===e.strm.avail_out))return j}return e.insert=0,t===A?(d(e,!0),0===e.strm.avail_out?Z:X):(e.strstart>e.block_start&&(d(e,!1),e.strm.avail_out),j)}),new K(4,4,8,4,a),new K(4,5,16,8,a),new K(4,6,32,32,a),new K(4,4,16,16,n),new K(8,16,32,32,n),new K(8,16,128,128,n),new K(8,32,128,256,n),new K(32,128,258,1024,n),new K(32,258,258,4096,n)],r.deflateInit=function(e,t){return o(e,t,S,15,8,0)},r.deflateInit2=o,r.deflateReset=v,r.deflateResetKeep=s,r.deflateSetHeader=function(e,t){return e&&e.state?2!==e.state.wrap?M:(e.state.gzhead=t,x):M},r.deflate=function(e,t){var r,a,n,i;if(!e||!e.state||5<t||t<0)return e?l(e,M):M;if(a=e.state,!e.output||!e.input&&0!==e.avail_in||666===a.status&&t!==A)return l(e,0===e.avail_out?-5:M);if(a.strm=e,r=a.last_flush,a.last_flush=t,a.status===z)if(2===a.wrap)e.adler=0,f(a,31),f(a,139),f(a,8),a.gzhead?(f(a,(a.gzhead.text?1:0)+(a.gzhead.hcrc?2:0)+(a.gzhead.extra?4:0)+(a.gzhead.name?8:0)+(a.gzhead.comment?16:0)),f(a,255&a.gzhead.time),f(a,a.gzhead.time>>8&255),f(a,a.gzhead.time>>16&255),f(a,a.gzhead.time>>24&255),f(a,9===a.level?2:2<=a.strategy||a.level<2?4:0),f(a,255&a.gzhead.os),a.gzhead.extra&&a.gzhead.extra.length&&(f(a,255&a.gzhead.extra.length),f(a,a.gzhead.extra.length>>8&255)),a.gzhead.hcrc&&(e.adler=O(e.adler,a.pending_buf,a.pending,0)),a.gzindex=0,a.status=69):(f(a,0),f(a,0),f(a,0),f(a,0),f(a,0),f(a,9===a.level?2:2<=a.strategy||a.level<2?4:0),f(a,3),a.status=V);else{var s=S+(a.w_bits-8<<4)<<8;s|=(2<=a.strategy||a.level<2?0:a.level<6?1:6===a.level?2:3)<<6,0!==a.strstart&&(s|=32),s+=31-s%31,a.status=V,p(a,s),0!==a.strstart&&(p(a,e.adler>>>16),p(a,65535&e.adler)),e.adler=1}if(69===a.status)if(a.gzhead.extra){for(n=a.pending;a.gzindex<(65535&a.gzhead.extra.length)&&(a.pending!==a.pending_buf_size||(a.gzhead.hcrc&&a.pending>n&&(e.adler=O(e.adler,a.pending_buf,a.pending-n,n)),c(e),n=a.pending,a.pending!==a.pending_buf_size));)f(a,255&a.gzhead.extra[a.gzindex]),a.gzindex++;a.gzhead.hcrc&&a.pending>n&&(e.adler=O(e.adler,a.pending_buf,a.pending-n,n)),a.gzindex===a.gzhead.extra.length&&(a.gzindex=0,a.status=73)}else a.status=73;if(73===a.status)if(a.gzhead.name){n=a.pending;do{if(a.pending===a.pending_buf_size&&(a.gzhead.hcrc&&a.pending>n&&(e.adler=O(e.adler,a.pending_buf,a.pending-n,n)),c(e),n=a.pending,a.pending===a.pending_buf_size)){i=1;break}f(a,i=a.gzindex<a.gzhead.name.length?255&a.gzhead.name.charCodeAt(a.gzindex++):0)}while(0!==i);a.gzhead.hcrc&&a.pending>n&&(e.adler=O(e.adler,a.pending_buf,a.pending-n,n)),0===i&&(a.gzindex=0,a.status=91)}else a.status=91;if(91===a.status)if(a.gzhead.comment){n=a.pending;do{if(a.pending===a.pending_buf_size&&(a.gzhead.hcrc&&a.pending>n&&(e.adler=O(e.adler,a.pending_buf,a.pending-n,n)),c(e),n=a.pending,a.pending===a.pending_buf_size)){i=1;break}f(a,i=a.gzindex<a.gzhead.comment.length?255&a.gzhead.comment.charCodeAt(a.gzindex++):0)}while(0!==i);a.gzhead.hcrc&&a.pending>n&&(e.adler=O(e.adler,a.pending_buf,a.pending-n,n)),0===i&&(a.status=103)}else a.status=103;if(103===a.status&&(a.gzhead.hcrc?(a.pending+2>a.pending_buf_size&&c(e),a.pending+2<=a.pending_buf_size&&(f(a,255&e.adler),f(a,e.adler>>8&255),e.adler=0,a.status=V)):a.status=V),0!==a.pending){if(c(e),0===e.avail_out)return a.last_flush=-1,x}else if(0===e.avail_in&&u(t)<=u(r)&&t!==A)return l(e,-5);if(666===a.status&&0!==e.avail_in)return l(e,-5);if(0!==e.avail_in||0!==a.lookahead||t!==N&&666!==a.status){var o=2===a.strategy?function(e,t){for(var r;;){if(0===e.lookahead&&(m(e),0===e.lookahead)){if(t===N)return j;break}if(e.match_length=0,r=b._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,r&&(d(e,!1),0===e.strm.avail_out))return j}return e.insert=0,t===A?(d(e,!0),0===e.strm.avail_out?Z:X):e.last_lit&&(d(e,!1),0===e.strm.avail_out)?j:W}(a,t):3===a.strategy?function(e,t){for(var r,a,n,i,s=e.window;;){if(e.lookahead<=P){if(m(e),e.lookahead<=P&&t===N)return j;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=D&&0<e.strstart&&(a=s[n=e.strstart-1])===s[++n]&&a===s[++n]&&a===s[++n]){i=e.strstart+P;do{}while(a===s[++n]&&a===s[++n]&&a===s[++n]&&a===s[++n]&&a===s[++n]&&a===s[++n]&&a===s[++n]&&a===s[++n]&&n<i);e.match_length=P-(i-n),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=D?(r=b._tr_tally(e,1,e.match_length-D),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(r=b._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),r&&(d(e,!1),0===e.strm.avail_out))return j}return e.insert=0,t===A?(d(e,!0),0===e.strm.avail_out?Z:X):e.last_lit&&(d(e,!1),0===e.strm.avail_out)?j:W}(a,t):y[a.level].func(a,t);if((o===Z||o===X)&&(a.status=666),o===j||o===Z)return 0===e.avail_out&&(a.last_flush=-1),x;if(o===W&&(1===t?b._tr_align(a):5!==t&&(b._tr_stored_block(a,0,0,!1),3===t&&(h(a.head),0===a.lookahead&&(a.strstart=0,a.block_start=0,a.insert=0))),c(e),0===e.avail_out))return a.last_flush=-1,x}return t!==A?x:a.wrap<=0?1:(2===a.wrap?(f(a,255&e.adler),f(a,e.adler>>8&255),f(a,e.adler>>16&255),f(a,e.adler>>24&255),f(a,255&e.total_in),f(a,e.total_in>>8&255),f(a,e.total_in>>16&255),f(a,e.total_in>>24&255)):(p(a,e.adler>>>16),p(a,65535&e.adler)),c(e),0<a.wrap&&(a.wrap=-a.wrap),0!==a.pending?x:1)},r.deflateEnd=function(e){var t;return e&&e.state?(t=e.state.status)!==z&&69!==t&&73!==t&&91!==t&&103!==t&&t!==V&&666!==t?l(e,M):(e.state=null,t===V?l(e,-3):x):M},r.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":27,"./adler32":29,"./crc32":31,"./messages":37,"./trees":38}],33:[function(e,t){t.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],34:[function(e,t){t.exports=function(e,t){var r,a,n,i,s,o,l,u,h,c,d,f,p,m,g,v,y,T,b,_,O,w,N,A,x;r=e.state,a=e.next_in,A=e.input,n=a+(e.avail_in-5),i=e.next_out,x=e.output,s=i-(t-e.avail_out),o=i+(e.avail_out-257),l=r.dmax,u=r.wsize,h=r.whave,c=r.wnext,d=r.window,f=r.hold,p=r.bits,m=r.lencode,g=r.distcode,v=(1<<r.lenbits)-1,y=(1<<r.distbits)-1;e:do{p<15&&(f+=A[a++]<<p,p+=8,f+=A[a++]<<p,p+=8),T=m[f&v];t:for(;;){if(f>>>=b=T>>>24,p-=b,0===(b=T>>>16&255))x[i++]=65535&T;else{if(!(16&b)){if(0==(64&b)){T=m[(65535&T)+(f&(1<<b)-1)];continue t}if(32&b){r.mode=12;break e}e.msg="invalid literal/length code",r.mode=30;break e}_=65535&T,(b&=15)&&(p<b&&(f+=A[a++]<<p,p+=8),_+=f&(1<<b)-1,f>>>=b,p-=b),p<15&&(f+=A[a++]<<p,p+=8,f+=A[a++]<<p,p+=8),T=g[f&y];r:for(;;){if(f>>>=b=T>>>24,p-=b,!(16&(b=T>>>16&255))){if(0==(64&b)){T=g[(65535&T)+(f&(1<<b)-1)];continue r}e.msg="invalid distance code",r.mode=30;break e}if(O=65535&T,p<(b&=15)&&(f+=A[a++]<<p,(p+=8)<b&&(f+=A[a++]<<p,p+=8)),l<(O+=f&(1<<b)-1)){e.msg="invalid distance too far back",r.mode=30;break e}if(f>>>=b,p-=b,(b=i-s)<O){if(h<(b=O-b)&&r.sane){e.msg="invalid distance too far back",r.mode=30;break e}if(N=d,(w=0)===c){if(w+=u-b,b<_){for(_-=b;x[i++]=d[w++],--b;);w=i-O,N=x}}else if(c<b){if(w+=u+c-b,(b-=c)<_){for(_-=b;x[i++]=d[w++],--b;);if(w=0,c<_){for(_-=b=c;x[i++]=d[w++],--b;);w=i-O,N=x}}}else if(w+=c-b,b<_){for(_-=b;x[i++]=d[w++],--b;);w=i-O,N=x}for(;2<_;)x[i++]=N[w++],x[i++]=N[w++],x[i++]=N[w++],_-=3;_&&(x[i++]=N[w++],1<_&&(x[i++]=N[w++]))}else{for(w=i-O;x[i++]=x[w++],x[i++]=x[w++],x[i++]=x[w++],2<(_-=3););_&&(x[i++]=x[w++],1<_&&(x[i++]=x[w++]))}break}}break}}while(a<n&&i<o);a-=_=p>>3,f&=(1<<(p-=_<<3))-1,e.next_in=a,e.next_out=i,e.avail_in=a<n?n-a+5:5-(a-n),e.avail_out=i<o?o-i+257:257-(i-o),r.hold=f,r.bits=p}},{}],35:[function(e,t,r){function B(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function n(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new R.Buf16(320),this.work=new R.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function a(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=X,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new R.Buf32(h),t.distcode=t.distdyn=new R.Buf32(c),t.sane=1,t.back=-1,W):Z}function i(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,a(e)):Z}function s(e,t){var r,a;return e&&e.state?(a=e.state,t<0?(r=0,t=-t):(r=1+(t>>4),t<48&&(t&=15)),t&&(t<8||15<t)?Z:(null!==a.window&&a.wbits!==t&&(a.window=null),a.wrap=r,a.wbits=t,i(e))):Z}function o(e,t){var r,a;return e?(a=new n,(e.state=a).window=null,(r=s(e,t))!==W&&(e.state=null),r):Z}function E(e){if(d){var t;for(l=new R.Buf32(512),u=new R.Buf32(32),t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(z(V,e.lens,0,288,l,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;z(j,e.lens,0,32,u,0,e.work,{bits:5}),d=!1}e.lencode=l,e.lenbits=9,e.distcode=u,e.distbits=5}var l,u,R=e("../utils/common"),D=e("./adler32"),P=e("./crc32"),U=e("./inffast"),z=e("./inftrees"),V=1,j=2,W=0,Z=-2,X=1,h=852,c=592,d=!0;r.inflateReset=i,r.inflateReset2=s,r.inflateResetKeep=a,r.inflateInit=function(e){return o(e,15)},r.inflateInit2=o,r.inflate=function(e,t){var r,a,n,i,s,o,l,u,h,c,d,f,p,m,g,v,y,T,b,_,O,w,N,A,x,M,G,k,L,S,C=0,F=new R.Buf8(4),I=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return Z;12===(r=e.state).mode&&(r.mode=13),s=e.next_out,n=e.output,l=e.avail_out,i=e.next_in,a=e.input,o=e.avail_in,u=r.hold,h=r.bits,c=o,d=l,w=W;e:for(;;)switch(r.mode){case X:if(0===r.wrap){r.mode=13;break}for(;h<16;){if(0===o)break e;o--,u+=a[i++]<<h,h+=8}if(2&r.wrap&&35615===u){F[r.check=0]=255&u,F[1]=u>>>8&255,r.check=P(r.check,F,2,0),h=u=0,r.mode=2;break}if(r.flags=0,r.head&&(r.head.done=!1),!(1&r.wrap)||(((255&u)<<8)+(u>>8))%31){e.msg="incorrect header check",r.mode=30;break}if(8!=(15&u)){e.msg="unknown compression method",r.mode=30;break}if(h-=4,O=8+(15&(u>>>=4)),0===r.wbits)r.wbits=O;else if(O>r.wbits){e.msg="invalid window size",r.mode=30;break}r.dmax=1<<O,e.adler=r.check=1,r.mode=512&u?10:12,h=u=0;break;case 2:for(;h<16;){if(0===o)break e;o--,u+=a[i++]<<h,h+=8}if(r.flags=u,8!=(255&r.flags)){e.msg="unknown compression method",r.mode=30;break}if(57344&r.flags){e.msg="unknown header flags set",r.mode=30;break}r.head&&(r.head.text=u>>8&1),512&r.flags&&(F[0]=255&u,F[1]=u>>>8&255,r.check=P(r.check,F,2,0)),h=u=0,r.mode=3;case 3:for(;h<32;){if(0===o)break e;o--,u+=a[i++]<<h,h+=8}r.head&&(r.head.time=u),512&r.flags&&(F[0]=255&u,F[1]=u>>>8&255,F[2]=u>>>16&255,F[3]=u>>>24&255,r.check=P(r.check,F,4,0)),h=u=0,r.mode=4;case 4:for(;h<16;){if(0===o)break e;o--,u+=a[i++]<<h,h+=8}r.head&&(r.head.xflags=255&u,r.head.os=u>>8),512&r.flags&&(F[0]=255&u,F[1]=u>>>8&255,r.check=P(r.check,F,2,0)),h=u=0,r.mode=5;case 5:if(1024&r.flags){for(;h<16;){if(0===o)break e;o--,u+=a[i++]<<h,h+=8}r.length=u,r.head&&(r.head.extra_len=u),512&r.flags&&(F[0]=255&u,F[1]=u>>>8&255,r.check=P(r.check,F,2,0)),h=u=0}else r.head&&(r.head.extra=null);r.mode=6;case 6:if(1024&r.flags&&(o<(f=r.length)&&(f=o),f&&(r.head&&(O=r.head.extra_len-r.length,r.head.extra||(r.head.extra=new Array(r.head.extra_len)),R.arraySet(r.head.extra,a,i,f,O)),512&r.flags&&(r.check=P(r.check,a,f,i)),o-=f,i+=f,r.length-=f),r.length))break e;r.length=0,r.mode=7;case 7:if(2048&r.flags){if(0===o)break e;for(f=0;O=a[i+f++],r.head&&O&&r.length<65536&&(r.head.name+=String.fromCharCode(O)),O&&f<o;);if(512&r.flags&&(r.check=P(r.check,a,f,i)),o-=f,i+=f,O)break e}else r.head&&(r.head.name=null);r.length=0,r.mode=8;case 8:if(4096&r.flags){if(0===o)break e;for(f=0;O=a[i+f++],r.head&&O&&r.length<65536&&(r.head.comment+=String.fromCharCode(O)),O&&f<o;);if(512&r.flags&&(r.check=P(r.check,a,f,i)),o-=f,i+=f,O)break e}else r.head&&(r.head.comment=null);r.mode=9;case 9:if(512&r.flags){for(;h<16;){if(0===o)break e;o--,u+=a[i++]<<h,h+=8}if(u!==(65535&r.check)){e.msg="header crc mismatch",r.mode=30;break}h=u=0}r.head&&(r.head.hcrc=r.flags>>9&1,r.head.done=!0),e.adler=r.check=0,r.mode=12;break;case 10:for(;h<32;){if(0===o)break e;o--,u+=a[i++]<<h,h+=8}e.adler=r.check=B(u),h=u=0,r.mode=11;case 11:if(0===r.havedict)return e.next_out=s,e.avail_out=l,e.next_in=i,e.avail_in=o,r.hold=u,r.bits=h,2;e.adler=r.check=1,r.mode=12;case 12:if(5===t||6===t)break e;case 13:if(r.last){u>>>=7&h,h-=7&h,r.mode=27;break}for(;h<3;){if(0===o)break e;o--,u+=a[i++]<<h,h+=8}switch(r.last=1&u,h-=1,3&(u>>>=1)){case 0:r.mode=14;break;case 1:if(E(r),r.mode=20,6===t){u>>>=2,h-=2;break e}break;case 2:r.mode=17;break;case 3:e.msg="invalid block type",r.mode=30}u>>>=2,h-=2;break;case 14:for(u>>>=7&h,h-=7&h;h<32;){if(0===o)break e;o--,u+=a[i++]<<h,h+=8}if((65535&u)!=(u>>>16^65535)){e.msg="invalid stored block lengths",r.mode=30;break}if(r.length=65535&u,h=u=0,r.mode=15,6===t)break e;case 15:r.mode=16;case 16:if(f=r.length){if(o<f&&(f=o),l<f&&(f=l),0===f)break e;R.arraySet(n,a,i,f,s),o-=f,i+=f,l-=f,s+=f,r.length-=f;break}r.mode=12;break;case 17:for(;h<14;){if(0===o)break e;o--,u+=a[i++]<<h,h+=8}if(r.nlen=257+(31&u),u>>>=5,h-=5,r.ndist=1+(31&u),u>>>=5,h-=5,r.ncode=4+(15&u),u>>>=4,h-=4,286<r.nlen||30<r.ndist){e.msg="too many length or distance symbols",r.mode=30;break}r.have=0,r.mode=18;case 18:for(;r.have<r.ncode;){for(;h<3;){if(0===o)break e;o--,u+=a[i++]<<h,h+=8}r.lens[I[r.have++]]=7&u,u>>>=3,h-=3}for(;r.have<19;)r.lens[I[r.have++]]=0;if(r.lencode=r.lendyn,r.lenbits=7,N={bits:r.lenbits},w=z(0,r.lens,0,19,r.lencode,0,r.work,N),r.lenbits=N.bits,w){e.msg="invalid code lengths set",r.mode=30;break}r.have=0,r.mode=19;case 19:for(;r.have<r.nlen+r.ndist;){for(;v=(C=r.lencode[u&(1<<r.lenbits)-1])>>>16&255,y=65535&C,!((g=C>>>24)<=h);){if(0===o)break e;o--,u+=a[i++]<<h,h+=8}if(y<16)u>>>=g,h-=g,r.lens[r.have++]=y;else{if(16===y){for(A=g+2;h<A;){if(0===o)break e;o--,u+=a[i++]<<h,h+=8}if(u>>>=g,h-=g,0===r.have){e.msg="invalid bit length repeat",r.mode=30;break}O=r.lens[r.have-1],f=3+(3&u),u>>>=2,h-=2}else if(17===y){for(A=g+3;h<A;){if(0===o)break e;o--,u+=a[i++]<<h,h+=8}h-=g,O=0,f=3+(7&(u>>>=g)),u>>>=3,h-=3}else{for(A=g+7;h<A;){if(0===o)break e;o--,u+=a[i++]<<h,h+=8}h-=g,O=0,f=11+(127&(u>>>=g)),u>>>=7,h-=7}if(r.have+f>r.nlen+r.ndist){e.msg="invalid bit length repeat",r.mode=30;break}for(;f--;)r.lens[r.have++]=O}}if(30===r.mode)break;if(0===r.lens[256]){e.msg="invalid code -- missing end-of-block",r.mode=30;break}if(r.lenbits=9,N={bits:r.lenbits},w=z(V,r.lens,0,r.nlen,r.lencode,0,r.work,N),r.lenbits=N.bits,w){e.msg="invalid literal/lengths set",r.mode=30;break}if(r.distbits=6,r.distcode=r.distdyn,N={bits:r.distbits},w=z(j,r.lens,r.nlen,r.ndist,r.distcode,0,r.work,N),r.distbits=N.bits,w){e.msg="invalid distances set",r.mode=30;break}if(r.mode=20,6===t)break e;case 20:r.mode=21;case 21:if(6<=o&&258<=l){e.next_out=s,e.avail_out=l,e.next_in=i,e.avail_in=o,r.hold=u,r.bits=h,U(e,d),s=e.next_out,n=e.output,l=e.avail_out,i=e.next_in,a=e.input,o=e.avail_in,u=r.hold,h=r.bits,12===r.mode&&(r.back=-1);break}for(r.back=0;v=(C=r.lencode[u&(1<<r.lenbits)-1])>>>16&255,y=65535&C,!((g=C>>>24)<=h);){if(0===o)break e;o--,u+=a[i++]<<h,h+=8}if(v&&0==(240&v)){for(T=g,b=v,_=y;v=(C=r.lencode[_+((u&(1<<T+b)-1)>>T)])>>>16&255,y=65535&C,!(T+(g=C>>>24)<=h);){if(0===o)break e;o--,u+=a[i++]<<h,h+=8}u>>>=T,h-=T,r.back+=T}if(u>>>=g,h-=g,r.back+=g,r.length=y,0===v){r.mode=26;break}if(32&v){r.back=-1,r.mode=12;break}if(64&v){e.msg="invalid literal/length code",r.mode=30;break}r.extra=15&v,r.mode=22;case 22:if(r.extra){for(A=r.extra;h<A;){if(0===o)break e;o--,u+=a[i++]<<h,h+=8}r.length+=u&(1<<r.extra)-1,u>>>=r.extra,h-=r.extra,r.back+=r.extra}r.was=r.length,r.mode=23;case 23:for(;v=(C=r.distcode[u&(1<<r.distbits)-1])>>>16&255,y=65535&C,!((g=C>>>24)<=h);){if(0===o)break e;o--,u+=a[i++]<<h,h+=8}if(0==(240&v)){for(T=g,b=v,_=y;v=(C=r.distcode[_+((u&(1<<T+b)-1)>>T)])>>>16&255,y=65535&C,!(T+(g=C>>>24)<=h);){if(0===o)break e;o--,u+=a[i++]<<h,h+=8}u>>>=T,h-=T,r.back+=T}if(u>>>=g,h-=g,r.back+=g,64&v){e.msg="invalid distance code",r.mode=30;break}r.offset=y,r.extra=15&v,r.mode=24;case 24:if(r.extra){for(A=r.extra;h<A;){if(0===o)break e;o--,u+=a[i++]<<h,h+=8}r.offset+=u&(1<<r.extra)-1,u>>>=r.extra,h-=r.extra,r.back+=r.extra}if(r.offset>r.dmax){e.msg="invalid distance too far back",r.mode=30;break}r.mode=25;case 25:if(0===l)break e;if(f=d-l,r.offset>f){if((f=r.offset-f)>r.whave&&r.sane){e.msg="invalid distance too far back",r.mode=30;break}f>r.wnext?(f-=r.wnext,p=r.wsize-f):p=r.wnext-f,f>r.length&&(f=r.length),m=r.window}else m=n,p=s-r.offset,f=r.length;for(l<f&&(f=l),l-=f,r.length-=f;n[s++]=m[p++],--f;);0===r.length&&(r.mode=21);break;case 26:if(0===l)break e;n[s++]=r.length,l--,r.mode=21;break;case 27:if(r.wrap){for(;h<32;){if(0===o)break e;o--,u|=a[i++]<<h,h+=8}if(d-=l,e.total_out+=d,r.total+=d,d&&(e.adler=r.check=r.flags?P(r.check,n,d,s-d):D(r.check,n,d,s-d)),d=l,(r.flags?u:B(u))!==r.check){e.msg="incorrect data check",r.mode=30;break}h=u=0}r.mode=28;case 28:if(r.wrap&&r.flags){for(;h<32;){if(0===o)break e;o--,u+=a[i++]<<h,h+=8}if(u!==(4294967295&r.total)){e.msg="incorrect length check",r.mode=30;break}h=u=0}r.mode=29;case 29:w=1;break e;case 30:w=-3;break e;case 31:return-4;case 32:default:return Z}return e.next_out=s,e.avail_out=l,e.next_in=i,e.avail_in=o,r.hold=u,r.bits=h,(r.wsize||d!==e.avail_out&&r.mode<30&&(r.mode<27||4!==t))&&(M=(x=e).output,G=e.next_out,k=d-e.avail_out,null===(S=x.state).window&&(S.wsize=1<<S.wbits,S.wnext=0,S.whave=0,S.window=new R.Buf8(S.wsize)),k>=S.wsize?(R.arraySet(S.window,M,G-S.wsize,S.wsize,0),S.wnext=0,S.whave=S.wsize):(k<(L=S.wsize-S.wnext)&&(L=k),R.arraySet(S.window,M,G-k,L,S.wnext),(k-=L)?(R.arraySet(S.window,M,G-k,k,0),S.wnext=k,S.whave=S.wsize):(S.wnext+=L,S.wnext===S.wsize&&(S.wnext=0),S.whave<S.wsize&&(S.whave+=L))),0)?(r.mode=31,-4):(c-=e.avail_in,d-=e.avail_out,e.total_in+=c,e.total_out+=d,r.total+=d,r.wrap&&d&&(e.adler=r.check=r.flags?P(r.check,n,d,e.next_out-d):D(r.check,n,d,e.next_out-d)),e.data_type=r.bits+(r.last?64:0)+(12===r.mode?128:0)+(20===r.mode||15===r.mode?256:0),(0===c&&0===d||4===t)&&w===W&&(w=-5),w)},r.inflateEnd=function(e){if(!e||!e.state)return Z;var t=e.state;return t.window&&(t.window=null),e.state=null,W},r.inflateGetHeader=function(e,t){var r;return e&&e.state?0==(2&(r=e.state).wrap)?Z:((r.head=t).done=!1,W):Z},r.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":27,"./adler32":29,"./crc32":31,"./inffast":34,"./inftrees":36}],36:[function(e,t){var I=e("../utils/common"),B=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],E=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],R=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],D=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];t.exports=function(e,t,r,a,n,i,s,o){var l,u,h,c,d,f,p,m,g,v=o.bits,y=0,T=0,b=0,_=0,O=0,w=0,N=0,A=0,x=0,M=0,G=null,k=0,L=new I.Buf16(16),S=new I.Buf16(16),C=null,F=0;for(y=0;y<=15;y++)L[y]=0;for(T=0;T<a;T++)L[t[r+T]]++;for(O=v,_=15;1<=_&&0===L[_];_--);if(_<O&&(O=_),0===_)return n[i++]=20971520,n[i++]=20971520,o.bits=1,0;for(b=1;b<_&&0===L[b];b++);for(O<b&&(O=b),y=A=1;y<=15;y++)if(A<<=1,(A-=L[y])<0)return-1;if(0<A&&(0===e||1!==_))return-1;for(S[1]=0,y=1;y<15;y++)S[y+1]=S[y]+L[y];for(T=0;T<a;T++)0!==t[r+T]&&(s[S[t[r+T]]++]=T);if(0===e?(G=C=s,f=19):1===e?(G=B,k-=257,C=E,F-=257,f=256):(G=R,C=D,f=-1),y=b,d=i,h=-1,c=(x=1<<(w=O))-1,1===e&&852<x||2===e&&592<x)return 1;for(N=T=M=0;;){for(0,p=y-N,s[T]<f?(m=0,g=s[T]):s[T]>f?(m=C[F+s[T]],g=G[k+s[T]]):(m=96,g=0),l=1<<y-N,b=u=1<<w;n[d+(M>>N)+(u-=l)]=p<<24|m<<16|g|0,0!==u;);for(l=1<<y-1;M&l;)l>>=1;if(0!==l?(M&=l-1,M+=l):M=0,T++,0==--L[y]){if(y===_)break;y=t[r+s[T]]}if(O<y&&(M&c)!==h){for(0===N&&(N=O),d+=b,A=1<<(w=y-N);w+N<_&&!((A-=L[w+N])<=0);)w++,A<<=1;if(x+=1<<w,1===e&&852<x||2===e&&592<x)return 1;n[h=M&c]=O<<24|w<<16|d-i|0}}return 0!==M&&(n[d+M]=y-N<<24|64<<16|0),o.bits=O,0}},{"../utils/common":27}],37:[function(e,t){t.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],38:[function(e,t,r){function a(e){for(var t=e.length;0<=--t;)e[t]=0}function l(e){return e<256?V[e]:V[256+(e>>>7)]}function u(e,t){e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255}function h(e,t,r){e.bi_valid>n-r?(e.bi_buf|=t<<e.bi_valid&65535,u(e,e.bi_buf),e.bi_buf=t>>n-e.bi_valid,e.bi_valid+=r-n):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=r)}function c(e,t,r){h(e,r[2*t],r[2*t+1])}function d(e,t){for(var r=0;r|=1&e,e>>>=1,r<<=1,0<--t;);return r>>>1}function f(e,t,r){var a,n,i=new Array(L+1),s=0;for(a=1;a<=L;a++)i[a]=s=s+r[a-1]<<1;for(n=0;n<=t;n++){var o=e[2*n+1];0!==o&&(e[2*n]=d(i[o]++,o))}}function o(e){var t;for(t=0;t<x;t++)e.dyn_ltree[2*t]=0;for(t=0;t<M;t++)e.dyn_dtree[2*t]=0;for(t=0;t<G;t++)e.bl_tree[2*t]=0;e.dyn_ltree[2*C]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0}function p(e){8<e.bi_valid?u(e,e.bi_buf):0<e.bi_valid&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0}function i(e,t,r,a){var n=2*t,i=2*r;return e[n]<e[i]||e[n]===e[i]&&a[t]<=a[r]}function m(e,t,r){for(var a=e.heap[r],n=r<<1;n<=e.heap_len&&(n<e.heap_len&&i(t,e.heap[n+1],e.heap[n],e.depth)&&n++,!i(t,a,e.heap[n],e.depth));)e.heap[r]=e.heap[n],r=n,n<<=1;e.heap[r]=a}function g(e,t,r){var a,n,i,s,o=0;if(0!==e.last_lit)for(;a=e.pending_buf[e.d_buf+2*o]<<8|e.pending_buf[e.d_buf+2*o+1],n=e.pending_buf[e.l_buf+o],o++,0===a?c(e,n,t):(c(e,(i=j[n])+A+1,t),0!==(s=E[i])&&h(e,n-=W[i],s),c(e,i=l(--a),r),0!==(s=R[i])&&h(e,a-=Z[i],s)),o<e.last_lit;);c(e,C,t)}function v(e,t){var r,a,n,i=t.dyn_tree,s=t.stat_desc.static_tree,o=t.stat_desc.has_stree,l=t.stat_desc.elems,u=-1;for(e.heap_len=0,e.heap_max=k,r=0;r<l;r++)0!==i[2*r]?(e.heap[++e.heap_len]=u=r,e.depth[r]=0):i[2*r+1]=0;for(;e.heap_len<2;)i[2*(n=e.heap[++e.heap_len]=u<2?++u:0)]=1,e.depth[n]=0,e.opt_len--,o&&(e.static_len-=s[2*n+1]);for(t.max_code=u,r=e.heap_len>>1;1<=r;r--)m(e,i,r);for(n=l;r=e.heap[1],e.heap[1]=e.heap[e.heap_len--],m(e,i,1),a=e.heap[1],e.heap[--e.heap_max]=r,e.heap[--e.heap_max]=a,i[2*n]=i[2*r]+i[2*a],e.depth[n]=(e.depth[r]>=e.depth[a]?e.depth[r]:e.depth[a])+1,i[2*r+1]=i[2*a+1]=n,e.heap[1]=n++,m(e,i,1),2<=e.heap_len;);e.heap[--e.heap_max]=e.heap[1],function(e,t){var r,a,n,i,s,o,l=t.dyn_tree,u=t.max_code,h=t.stat_desc.static_tree,c=t.stat_desc.has_stree,d=t.stat_desc.extra_bits,f=t.stat_desc.extra_base,p=t.stat_desc.max_length,m=0;for(i=0;i<=L;i++)e.bl_count[i]=0;for(l[2*e.heap[e.heap_max]+1]=0,r=e.heap_max+1;r<k;r++)p<(i=l[2*l[2*(a=e.heap[r])+1]+1]+1)&&(i=p,m++),l[2*a+1]=i,u<a||(e.bl_count[i]++,s=0,f<=a&&(s=d[a-f]),o=l[2*a],e.opt_len+=o*(i+s),c&&(e.static_len+=o*(h[2*a+1]+s)));if(0!==m){do{for(i=p-1;0===e.bl_count[i];)i--;e.bl_count[i]--,e.bl_count[i+1]+=2,e.bl_count[p]--,m-=2}while(0<m);for(i=p;0!==i;i--)for(a=e.bl_count[i];0!==a;)u<(n=e.heap[--r])||(l[2*n+1]!==i&&(e.opt_len+=(i-l[2*n+1])*l[2*n],l[2*n+1]=i),a--)}}(e,t),f(i,u,e.bl_count)}function y(e,t,r){var a,n,i=-1,s=t[1],o=0,l=7,u=4;for(0===s&&(l=138,u=3),t[2*(r+1)+1]=65535,a=0;a<=r;a++)n=s,s=t[2*(a+1)+1],++o<l&&n===s||(o<u?e.bl_tree[2*n]+=o:0!==n?(n!==i&&e.bl_tree[2*n]++,e.bl_tree[2*F]++):o<=10?e.bl_tree[2*I]++:e.bl_tree[2*B]++,i=n,(o=0)===s?(l=138,u=3):n===s?(l=6,u=3):(l=7,u=4))}function T(e,t,r){var a,n,i=-1,s=t[1],o=0,l=7,u=4;for(0===s&&(l=138,u=3),a=0;a<=r;a++)if(n=s,s=t[2*(a+1)+1],!(++o<l&&n===s)){if(o<u)for(;c(e,n,e.bl_tree),0!=--o;);else 0!==n?(n!==i&&(c(e,n,e.bl_tree),o--),c(e,F,e.bl_tree),h(e,o-3,2)):o<=10?(c(e,I,e.bl_tree),h(e,o-3,3)):(c(e,B,e.bl_tree),h(e,o-11,7));i=n,(o=0)===s?(l=138,u=3):n===s?(l=6,u=3):(l=7,u=4)}}function b(e,t,r,a){var n,i,s,o;h(e,(N<<1)+(a?1:0),3),i=t,s=r,o=!0,p(n=e),o&&(u(n,s),u(n,~s)),_.arraySet(n.pending_buf,n.window,i,s,n.pending),n.pending+=s}var _=e("../utils/common"),O=0,w=1,N=0,s=29,A=256,x=A+1+s,M=30,G=19,k=2*x+1,L=15,n=16,S=7,C=256,F=16,I=17,B=18,E=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],R=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],D=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],P=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],U=new Array(2*(x+2));a(U);var z=new Array(2*M);a(z);var V=new Array(512);a(V);var j=new Array(256);a(j);var W=new Array(s);a(W);var Z=new Array(M);a(Z);var X,K,H,q=function(e,t,r,a,n){this.static_tree=e,this.extra_bits=t,this.extra_base=r,this.elems=a,this.max_length=n,this.has_stree=e&&e.length},Y=function(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t},Q=!1;r._tr_init=function(e){Q||(function(){var e,t,r,a,n,i=new Array(L+1);for(a=r=0;a<s-1;a++)for(W[a]=r,e=0;e<1<<E[a];e++)j[r++]=a;for(j[r-1]=a,a=n=0;a<16;a++)for(Z[a]=n,e=0;e<1<<R[a];e++)V[n++]=a;for(n>>=7;a<M;a++)for(Z[a]=n<<7,e=0;e<1<<R[a]-7;e++)V[256+n++]=a;for(t=0;t<=L;t++)i[t]=0;for(e=0;e<=143;)U[2*e+1]=8,e++,i[8]++;for(;e<=255;)U[2*e+1]=9,e++,i[9]++;for(;e<=279;)U[2*e+1]=7,e++,i[7]++;for(;e<=287;)U[2*e+1]=8,e++,i[8]++;for(f(U,x+1,i),e=0;e<M;e++)z[2*e+1]=5,z[2*e]=d(e,5);X=new q(U,E,A+1,x,L),K=new q(z,R,0,M,L),H=new q(new Array(0),D,0,G,S)}(),Q=!0),e.l_desc=new Y(e.dyn_ltree,X),e.d_desc=new Y(e.dyn_dtree,K),e.bl_desc=new Y(e.bl_tree,H),e.bi_buf=0,e.bi_valid=0,o(e)},r._tr_stored_block=b,r._tr_flush_block=function(e,t,r,a){var n,i,s=0;0<e.level?(2===e.strm.data_type&&(e.strm.data_type=function(e){var t,r=4093624447;for(t=0;t<=31;t++,r>>>=1)if(1&r&&0!==e.dyn_ltree[2*t])return O;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return w;for(t=32;t<A;t++)if(0!==e.dyn_ltree[2*t])return w;return O}(e)),v(e,e.l_desc),v(e,e.d_desc),s=function(e){var t;for(y(e,e.dyn_ltree,e.l_desc.max_code),y(e,e.dyn_dtree,e.d_desc.max_code),v(e,e.bl_desc),t=G-1;3<=t&&0===e.bl_tree[2*P[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t}(e),n=e.opt_len+3+7>>>3,(i=e.static_len+3+7>>>3)<=n&&(n=i)):n=i=r+5,r+4<=n&&-1!==t?b(e,t,r,a):4===e.strategy||i===n?(h(e,2+(a?1:0),3),g(e,U,z)):(h(e,4+(a?1:0),3),function(e,t,r,a){var n;for(h(e,t-257,5),h(e,r-1,5),h(e,a-4,4),n=0;n<a;n++)h(e,e.bl_tree[2*P[n]+1],3);T(e,e.dyn_ltree,t-1),T(e,e.dyn_dtree,r-1)}(e,e.l_desc.max_code+1,e.d_desc.max_code+1,s+1),g(e,e.dyn_ltree,e.dyn_dtree)),o(e),a&&p(e)},r._tr_tally=function(e,t,r){return e.pending_buf[e.d_buf+2*e.last_lit]=t>>>8&255,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&r,e.last_lit++,0===t?e.dyn_ltree[2*r]++:(e.matches++,t--,e.dyn_ltree[2*(j[r]+A+1)]++,e.dyn_dtree[2*l(t)]++),e.last_lit===e.lit_bufsize-1},r._tr_align=function(e){var t;h(e,2,3),c(e,C,U),16===(t=e).bi_valid?(u(t,t.bi_buf),t.bi_buf=0,t.bi_valid=0):8<=t.bi_valid&&(t.pending_buf[t.pending++]=255&t.bi_buf,t.bi_buf>>=8,t.bi_valid-=8)}},{"../utils/common":27}],39:[function(e,t){t.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}]},{},[9])(9)}),TONG.ThreeMFLoader=function(e){this.manager=void 0!==e?e:TONG.DefaultLoadingManager,this.availableExtensions=[]},TONG.ThreeMFLoader.prototype={constructor:TONG.ThreeMFLoader,load:function(e,t,r,a){var n=this,i=new TONG.FileLoader(n.manager);i.setResponseType("arraybuffer"),i.load(e,function(e){t(n.parse(e))},r,a)},parse:function(e){var h=this;function s(e){var t={type:e.getAttribute("type")},r=e.getAttribute("id");r&&(t.id=r);var a=e.getAttribute("pid");a&&(t.pid=a);var n=e.getAttribute("pindex");n&&(t.pindex=n);var i=e.getAttribute("thumbnail");i&&(t.thumbnail=i);var s=e.getAttribute("partnumber");s&&(t.partnumber=s);var o=e.getAttribute("name");o&&(t.name=o);var l=e.querySelector("mesh");l&&(t.mesh=function(e,t){for(var r={},a=[],n=e.querySelectorAll("vertices vertex"),i=0;i<n.length;i++){var s=n[i],o=s.getAttribute("x"),l=s.getAttribute("y"),u=s.getAttribute("z");a.push(parseFloat(o),parseFloat(l),parseFloat(u))}for(r.vertices=new Float32Array(a.length),i=0;i<a.length;i++)r.vertices[i]=a[i];var h=[],c=[],d=e.querySelectorAll("triangles triangle");for(i=0;i<d.length;i++){var f=d[i],p=f.getAttribute("v1"),m=f.getAttribute("v2"),g=f.getAttribute("v3"),v=f.getAttribute("p1"),y=f.getAttribute("p2"),T=f.getAttribute("p3"),b=f.getAttribute("pid");c.push(parseInt(p,10),parseInt(m,10),parseInt(g,10));var _={};v&&(_.p1=parseInt(v,10)),y&&(_.p2=parseInt(y,10)),T&&(_.p3=parseInt(T,10)),b&&(_.pid=b),0<Object.keys(_).length&&h.push(_)}for(r.triangleProperties=h,r.triangles=new Uint32Array(c.length),i=0;i<c.length;i++)r.triangles[i]=c[i];return r}(l));var u=e.querySelector("components");return u&&(t.components=void 0),t}function G(e){var t={unit:e.getAttribute("unit")||"millimeter"},r=e.querySelectorAll("metadata");r&&(t.metadata=function(e){for(var t={},r=0;r<e.length;r++){var a=e[r],n=a.getAttribute("name");0<=["Title","Designer","Description","Copyright","LicenseTerms","Rating","CreationDate","ModificationDate"].indexOf(n)&&(t[n]=a.textContent)}return t}(r));var a=e.querySelector("resources");a&&(t.resources=function(e){var t={},r=e.querySelector("basematerials");r&&(t.basematerial=void 0),t.object={};for(var a=e.querySelectorAll("object"),n=0;n<a.length;n++){var i=s(a[n]);t.object[i.id]=i}return t}(a));var n=e.querySelector("build");return n&&(t.build=function(e){for(var t=[],r=e.querySelectorAll("item"),a=0;a<r.length;a++){var n=r[a],i={objectid:n.getAttribute("objectid")},s=n.getAttribute("transform");if(s){var o=[];s.split(" ").forEach(function(e){o.push(parseFloat(e))});var l=new TONG.Matrix4;i.transform=l.set(o[0],o[3],o[6],o[9],o[1],o[4],o[7],o[10],o[2],o[5],o[8],o[11],0,0,0,1)}t.push(i)}return t}(n)),t}function d(e,t){var r=new TONG.BufferGeometry;r.setIndex(new TONG.BufferAttribute(e.triangles,1)),r.addAttribute("position",new TONG.BufferAttribute(e.vertices,3)),e.colors&&r.addAttribute("color",new TONG.BufferAttribute(e.colors,3)),r.computeBoundingSphere();var a={flatShading:!0};e.colors&&0<e.colors.length?a.vertexColors=TONG.VertexColors:a.color=11184895;var n=new TONG.MeshPhongMaterial(a);return new TONG.Mesh(r,n)}function f(e,t,r,a){if(e){for(var n=[],i=Object.keys(e),s=0;s<i.length;s++)for(var o=i[s],l=0;l<h.availableExtensions.length;l++){(u=h.availableExtensions[l]).ns===o&&n.push(u)}for(s=0;s<n.length;s++){var u;(u=n[s]).apply(r,e[u.ns],t)}}}var t=function(e){var t,r,a=null,n=null,i=[],s=[],o=[],l=[],u={},h={};try{a=new JSZip(e)}catch(e){if(e instanceof ReferenceError)return console.error("TONG.ThreeMFLoader: jszip missing and file is compressed."),null}for(n in a.files)n.match(/\.rels$/)?t=n:n.match(/^3D\/.*\.model$/)?i.push(n):n.match(/^3D\/Metadata\/.*\.xml$/)?s.push(n):n.match(/^3D\/Textures\/.*/)?o.push(n):n.match(/^3D\/Other\/.*/)&&l.push(n);var c,d,f,p,m,g=new Uint8Array(a.file(t).asArrayBuffer()),v=TONG.LoaderUtils.decodeText(g);c=v,d=(new DOMParser).parseFromString(c,"application/xml").querySelector("Relationship"),f=d.getAttribute("Target"),p=d.getAttribute("Id"),m=d.getAttribute("Type"),r={target:f,id:p,type:m};for(var y=0;y<i.length;y++){var T=i[y],b=new Uint8Array(a.file(T).asArrayBuffer()),_=TONG.LoaderUtils.decodeText(b),O=(new DOMParser).parseFromString(_,"application/xml");"model"!==O.documentElement.nodeName.toLowerCase()&&console.error("TONG.ThreeMFLoader: Error loading 3MF - no 3MF document found: ",T);var w=O.querySelector("model"),N={};for(y=0;y<w.attributes.length;y++){var A=w.attributes[y];A.name.match(/^xmlns:(.+)$/)&&(N[A.value]=RegExp.$1)}var x=G(w);x.xml=w,0<Object.keys(N).length&&(x.extensions=N),u[T]=x}for(y=0;y<o.length;y++){var M=o[y];h[M]=a.file(M).asBinary()}return{rels:r,model:u,printTicket:{},texture:h,other:{}}}(e);return function(e,t,r){for(var a=new TONG.Group,n=r.model[t.target.substring(1)].build,i=0;i<n.length;i++){var s=n[i],o=e[s.objectid];s.transform&&o.geometry.applyMatrix(s.transform),a.add(o)}return a}(function(e){for(var t=e.model,r={},a=Object.keys(t),n=0;n<a.length;n++)for(var i=t[a[n]],s=i.xml,o=i.extensions,l=Object.keys(i.resources.object),u=0;u<l.length;u++){var h=l[u],c=i.resources.object[h].mesh;f(o,c,s),r[h]=d(c)}return r}(t),t.rels,t)},addExtension:function(e){this.availableExtensions.push(e)}},TONG.AMFLoader=function(e){this.manager=void 0!==e?e:TONG.DefaultLoadingManager},TONG.AMFLoader.prototype={constructor:TONG.AMFLoader,load:function(e,t,r,a){var n=this,i=new TONG.FileLoader(n.manager);i.setResponseType("arraybuffer"),i.load(e,function(e){t(n.parse(e))},r,a)},parse:function(e){function t(e){for(var t="AMF Material",r=e.attributes.id.textContent,a={r:1,g:1,b:1,a:1},n=null,i=0;i<e.childNodes.length;i++){var s=e.childNodes[i];"metadata"===s.nodeName&&void 0!==s.attributes.type?"name"===s.attributes.type.value&&(t=s.textContent):"color"===s.nodeName&&(a=l(s))}return n=new TONG.MeshPhongMaterial({flatShading:!0,color:new TONG.Color(a.r,a.g,a.b),name:t}),1!==a.a&&(n.transparent=!0,n.opacity=a.a),{id:r,material:n}}function l(e){for(var t={r:1,g:1,b:1,a:1},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];"r"===a.nodeName?t.r=a.textContent:"g"===a.nodeName?t.g=a.textContent:"b"===a.nodeName?t.b=a.textContent:"a"===a.nodeName&&(t.a=a.textContent)}return t}function u(e){var t={name:"",triangles:[],materialid:null},r=e.firstElementChild;for(void 0!==e.attributes.materialid&&(t.materialId=e.attributes.materialid.nodeValue);r;){if("metadata"===r.nodeName)void 0!==r.attributes.type&&"name"===r.attributes.type.value&&(t.name=r.textContent);else if("triangle"===r.nodeName){var a=r.getElementsByTagName("v1")[0].textContent,n=r.getElementsByTagName("v2")[0].textContent,i=r.getElementsByTagName("v3")[0].textContent;t.triangles.push(a,n,i)}r=r.nextElementSibling}return t}function h(e){for(var t=[],r=[],a=e.firstElementChild;a;){if("vertex"===a.nodeName)for(var n=a.firstElementChild;n;){if("coordinates"===n.nodeName){var i=n.getElementsByTagName("x")[0].textContent,s=n.getElementsByTagName("y")[0].textContent,o=n.getElementsByTagName("z")[0].textContent;t.push(i,s,o)}else if("normal"===n.nodeName){var l=n.getElementsByTagName("nx")[0].textContent,u=n.getElementsByTagName("ny")[0].textContent,h=n.getElementsByTagName("nz")[0].textContent;r.push(l,u,h)}n=n.nextElementSibling}a=a.nextElementSibling}return{vertices:t,normals:r}}function r(e){for(var t=e.attributes.id.textContent,r={name:"amfobject",meshes:[]},a=null,n=e.firstElementChild;n;){if("metadata"===n.nodeName)void 0!==n.attributes.type&&"name"===n.attributes.type.value&&(r.name=n.textContent);else if("color"===n.nodeName)a=l(n);else if("mesh"===n.nodeName){for(var i=n.firstElementChild,s={vertices:[],normals:[],volumes:[],color:a};i;){if("vertices"===i.nodeName){var o=h(i);s.normals=s.normals.concat(o.normals),s.vertices=s.vertices.concat(o.vertices)}else"volume"===i.nodeName&&s.volumes.push(u(i));i=i.nextElementSibling}r.meshes.push(s)}n=n.nextElementSibling}return{id:t,obj:r}}var a,n,i=function(e){var t=new DataView(e);if("PK"===String.fromCharCode(t.getUint8(0),t.getUint8(1))){var r=null,a=null;console.log("TONG.AMFLoader: Loading Zip");try{r=new JSZip(e)}catch(e){if(e instanceof ReferenceError)return console.log("TONG.AMFLoader: jszip missing and file is compressed."),null}for(a in r.files)if(".amf"===a.toLowerCase().substr(-4))break;console.log("TONG.AMFLoader: Trying to load file asset: "+a),t=new DataView(r.file(a).asArrayBuffer())}var n=TONG.LoaderUtils.decodeText(t),i=(new DOMParser).parseFromString(n,"application/xml");return"amf"!==i.documentElement.nodeName.toLowerCase()?(console.log("TONG.AMFLoader: Error loading AMF - no AMF document found."),null):i}(e),s="",o="",c=function(e){var t=1,r="millimeter";void 0!==e.documentElement.attributes.unit&&(r=e.documentElement.attributes.unit.value.toLowerCase());var a={millimeter:1,inch:25.4,feet:304.8,meter:1e3,micron:.001};return void 0!==a[r]&&(t=a[r]),console.log("TONG.AMFLoader: Unit scale: "+t),t}(i),d={},f={},p=i.documentElement.childNodes;for(a=0;a<p.length;a++){var m=p[a];if("metadata"===m.nodeName)void 0!==m.attributes.type&&("name"===m.attributes.type.value?s=m.textContent:"author"===m.attributes.type.value&&(o=m.textContent));else if("material"===m.nodeName){var g=t(m);d[g.id]=g.material}else if("object"===m.nodeName){var v=r(m);f[v.id]=v.obj}}var y=new TONG.Group,T=new TONG.MeshPhongMaterial({color:11184895,flatShading:!0});for(var b in y.name=s,y.userData.author=o,y.userData.loader="AMF",f){var _=f[b],O=_.meshes,w=new TONG.Group;for(w.name=_.name||"",a=0;a<O.length;a++){var N=T,A=O[a],x=new TONG.Float32BufferAttribute(A.vertices,3),M=null;if(A.normals.length&&(M=new TONG.Float32BufferAttribute(A.normals,3)),A.color){var G=A.color;(N=T.clone()).color=new TONG.Color(G.r,G.g,G.b),1!==G.a&&(N.transparent=!0,N.opacity=G.a)}var k=A.volumes;for(n=0;n<k.length;n++){var L=k[n],S=new TONG.BufferGeometry,C=N;S.setIndex(L.triangles),S.addAttribute("position",x.clone()),M&&S.addAttribute("normal",M.clone()),void 0!==d[L.materialId]&&(C=d[L.materialId]),S.scale(c,c,c),w.add(new TONG.Mesh(S,C.clone()))}}y.add(w)}return y}},TONG.AssimpJSONLoader=function(e){this.manager=void 0!==e?e:TONG.DefaultLoadingManager},TONG.AssimpJSONLoader.prototype={constructor:TONG.AssimpJSONLoader,crossOrigin:"anonymous",load:function(e,a,t,n){var i=this,s=TONG.LoaderUtils.extractUrlBase(e);new TONG.FileLoader(this.manager).load(e,function(e){var t=JSON.parse(e),r=t.__metadata__;if(void 0!==r){if("assimp2json"!==r.format)return void n("TONG.AssimpJSONLoader: Not an assimp2json scene.");if(r.version<100&&200<=r.version)return void n("TONG.AssimpJSONLoader: Unsupported assimp2json file format version.")}a(i.parse(t,s))},t,n)},setCrossOrigin:function(e){return this.crossOrigin=e,this},parse:function(e,t){function r(e,t){for(var r=new Array(e.length),a=0;a<e.length;++a)r[a]=t.call(this,e[a]);return r}var u=new TONG.TextureLoader(this.manager);u.setPath(t).setCrossOrigin(this.crossOrigin);var a=r(e.meshes,function(e){var t,r,a,n=new TONG.BufferGeometry,i=[],s=e.vertices||[],o=e.normals||[],l=e.texturecoords||[],u=e.colors||[];for(l=l[0]||[],t=0,r=e.faces.length;t<r;t++)a=e.faces[t],i.push(a[0],a[1],a[2]);return n.setIndex(i),n.addAttribute("position",new TONG.Float32BufferAttribute(s,3)),0<o.length&&n.addAttribute("normal",new TONG.Float32BufferAttribute(o,3)),0<l.length&&n.addAttribute("uv",new TONG.Float32BufferAttribute(l,2)),0<u.length&&n.addAttribute("color",new TONG.Float32BufferAttribute(u,3)),n.computeBoundingSphere(),n}),n=r(e.materials,function(e){var t=new TONG.MeshPhongMaterial;for(var r in e.properties){var a=e.properties[r],n=a.key,i=a.value;switch(n){case"$tex.file":var s=a.semantic;if(1===s||2===s||5===s||6===s){var o;switch(s){case 1:o="map";break;case 2:o="specularMap";break;case 5:o="bumpMap";break;case 6:o="normalMap"}var l=u.load(i);l.wrapS=l.wrapT=TONG.RepeatWrapping,t[o]=l}break;case"?mat.name":t.name=i;break;case"$clr.diffuse":t.color.fromArray(i);break;case"$clr.specular":t.specular.fromArray(i);break;case"$clr.emissive":t.emissive.fromArray(i);break;case"$mat.shininess":t.shininess=i;break;case"$mat.shadingm":t.flatShading=1===i;break;case"$mat.opacity":i<1&&(t.opacity=i,t.transparent=!0)}}return t});return function e(t,r,a,n){var i,s,o=new TONG.Object3D;for(o.name=r.name||"",o.matrix=(new TONG.Matrix4).fromArray(r.transformation).transpose(),o.matrix.decompose(o.position,o.quaternion,o.scale),i=0;r.meshes&&i<r.meshes.length;i++)s=r.meshes[i],o.add(new TONG.Mesh(a[s],n[t.meshes[s].materialindex]));for(i=0;r.children&&i<r.children.length;i++)o.add(e(t,r.children[i],a,n));return o}(e,e.rootnode,a,n)}},TONG.AssimpLoader=function(e){this.manager=void 0!==e?e:TONG.DefaultLoadingManager},TONG.AssimpLoader.prototype={constructor:TONG.AssimpLoader,crossOrigin:"anonymous",load:function(e,t,r,a){var n=this,i=TONG.LoaderUtils.extractUrlBase(e),s=new TONG.FileLoader(this.manager);s.setResponseType("arraybuffer"),s.load(e,function(e){t(n.parse(e,i))},r,a)},setCrossOrigin:function(e){return this.crossOrigin=e,this},parse:function(e,t){var r=new TONG.TextureLoader(this.manager);r.setPath(t).setCrossOrigin(this.crossOrigin);var f={KeyFrame:function(e,t){this.time=e,this.matrix=t.clone(),this.position=new TONG.Vector3,this.quaternion=new TONG.Quaternion,this.scale=new TONG.Vector3(1,1,1),this.matrix.decompose(this.position,this.quaternion,this.scale),this.clone=function(){return new f.KeyFrame(this.time,this.matrix)},this.lerp=function(e,t){var r=(t-=this.time)/(e.time-this.time),a=1-r,n=this.position,i=this.quaternion,s=e.position,o=e.quaternion;return f.KeyFrame.tempAniPos.x=n.x*a+s.x*r,f.KeyFrame.tempAniPos.y=n.y*a+s.y*r,f.KeyFrame.tempAniPos.z=n.z*a+s.z*r,f.KeyFrame.tempAniQuat.set(i.x,i.y,i.z,i.w),f.KeyFrame.tempAniQuat.slerp(o,r),f.KeyFrame.tempAniMatrix.compose(f.KeyFrame.tempAniPos,f.KeyFrame.tempAniQuat,f.KeyFrame.tempAniScale)}}};f.KeyFrame.tempAniPos=new TONG.Vector3,f.KeyFrame.tempAniQuat=new TONG.Quaternion,f.KeyFrame.tempAniScale=new TONG.Vector3(1,1,1),f.KeyFrame.tempAniMatrix=new TONG.Matrix4,f.KeyFrameTrack=function(){this.keys=[],this.target=null,this.time=0,this.length=0,this._accelTable={},this.fps=20,this.addKey=function(e){this.keys.push(e)},this.init=function(){if(this.sortKeys(),0<this.keys.length?this.length=this.keys[this.keys.length-1].time:this.length=0,this.fps)for(var e=0;e<this.length*this.fps;e++)for(var t=0;t<this.keys.length;t++){if(this.keys[t].time==e){this._accelTable[e]=t;break}if(this.keys[t].time<e/this.fps&&this.keys[t+1]&&this.keys[t+1].time>=e/this.fps){this._accelTable[e]=t;break}}},this.parseFromTONG=function(e){var t=e.fps;this.target=e.node;for(var r=e.hierarchy[0].keys,a=0;a<r.length;a++)this.addKey(new f.KeyFrame(a/t||r[a].time,r[a].targets[0].data));this.init()},this.parseFromCollada=function(e){for(var t=e.keys,r=this.fps,a=0;a<t.length;a++)this.addKey(new f.KeyFrame(a/r||t[a].time,t[a].matrix));this.init()},this.sortKeys=function(){this.keys.sort(this.keySortFunc)},this.keySortFunc=function(e,t){return e.time-t.time},this.clone=function(){var e=new f.KeyFrameTrack;e.target=this.target,e.time=this.time,e.length=this.length;for(var t=0;t<this.keys.length;t++)e.addKey(this.keys[t].clone());return e.init(),e},this.reTarget=function(e,t){t||(t=f.TrackTargetNodeNameCompare),this.target=t(e,this.target)},this.keySearchAccel=function(e){return e*=this.fps,e=Math.floor(e),this._accelTable[e]||0},this.setTime=function(e){e=Math.abs(e),this.length&&(e=e%this.length+.05);for(var t=null,r=null,a=this.keySearchAccel(e);a<this.keys.length;a++){if(this.keys[a].time==e){t=this.keys[a],r=this.keys[a];break}if(this.keys[a].time<e&&this.keys[a+1]&&this.keys[a+1].time>e){t=this.keys[a],r=this.keys[a+1];break}if(this.keys[a].time<e&&a==this.keys.length-1){t=this.keys[a],(r=this.keys[0].clone()).time+=this.length+.05;break}}return t&&r&&t!==r?(this.target.matrixAutoUpdate=!1,this.target.matrix.copy(t.lerp(r,e)),void(this.target.matrixWorldNeedsUpdate=!0)):t&&r&&t==r?(this.target.matrixAutoUpdate=!1,this.target.matrix.copy(t.matrix),void(this.target.matrixWorldNeedsUpdate=!0)):void 0}},f.TrackTargetNodeNameCompare=function(e,t){return function e(t,r){if(t.name==r)return t;for(var a=0;a<t.children.length;a++){var n=e(t.children[a],r);if(n)return n}return null}(e,t.name)},f.Animation=function(){this.tracks=[],this.length=0,this.addTrack=function(e){this.tracks.push(e),this.length=Math.max(e.length,this.length)},this.setTime=function(e){this.time=e;for(var t=0;t<this.tracks.length;t++)this.tracks[t].setTime(e)},this.clone=function(e,t){t||(t=f.TrackTargetNodeNameCompare);var r=new f.Animation;r.target=e;for(var a=0;a<this.tracks.length;a++){var n=this.tracks[a].clone();n.reTarget(e,t),r.addTrack(n)}return r}};var u=4660,h=4661,c=4662,d=4663,a=4664,p=4665,m=4666,n=4667,g=4668,i=4669,s=4670,v=1,y=2,T=4,b=256,_=65536,O=1,w=4,N=1,A=3,o=1,l=6,x=8,M=10,G=4;function k(e,t){var r=new TONG.Bone;for(var a in r.matrix.copy(e.matrix),r.matrixWorld.copy(e.matrixWorld),r.position.copy(e.position),r.quaternion.copy(e.quaternion),r.scale.copy(e.scale),t.nodeCount++,r.name="bone_"+e.name+t.nodeCount.toString(),t.nodeToBoneMap[e.name]||(t.nodeToBoneMap[e.name]=[]),t.nodeToBoneMap[e.name].push(r),e.children){var n=k(e.children[a],t);n&&r.add(n)}return r}function L(e,t){for(var r=[],a=0;a<e.length;a++)r.push({i:e[a],w:t[a]});for(r.sort(function(e,t){return t.w-e.w});r.length<4;)r.push({i:0,w:0});4<r.length&&(r.length=4);var n=0;for(a=0;a<4;a++)n+=r[a].w*r[a].w;n=Math.sqrt(n);for(a=0;a<4;a++)r[a].w=r[a].w/n,e[a]=r[a].i,t[a]=r[a].w}function S(e,t){if(0==e.name.indexOf("bone_"+t))return e;for(var r in e.children){var a=S(e.children[r],t);if(a)return a}}function C(){this.mPrimitiveTypes=0,this.mNumVertices=0,this.mNumFaces=0,this.mNumBones=0,this.mMaterialIndex=0,this.mVertices=[],this.mNormals=[],this.mTangents=[],this.mBitangents=[],this.mColors=[[]],this.mTextureCoords=[[]],this.mFaces=[],this.mBones=[],this.hookupSkeletons=function(e,t){if(0!=this.mBones.length){for(var r=[],a=[],n=e.findNode(this.mBones[0].mName);n.mParent&&n.mParent.isBone;)n=n.mParent;var i=k(l=n.toTONG(e),e);this.TONGNode.add(i);for(var s=0;s<this.mBones.length;s++){if(u=S(i,this.mBones[s].mName)){var o=u;r.push(o),a.push(this.mBones[s].mOffsetMatrix.toTONG())}else{if(!(n=e.findNode(this.mBones[s].mName)))return;var l;(l=n.toTONG(e)).parent,i=k(l,e);this.TONGNode.add(i);var u;o=u=S(i,this.mBones[s].mName);r.push(o),a.push(this.mBones[s].mOffsetMatrix.toTONG())}}var h=new TONG.Skeleton(r,a);this.TONGNode.bind(h,new TONG.Matrix4),this.TONGNode.material.skinning=!0}},this.toTONG=function(e){if(this.TONGNode)return this.TONGNode;var t,r,a=new TONG.BufferGeometry;if(t=e.mMaterials[this.mMaterialIndex]?e.mMaterials[this.mMaterialIndex].toTONG(e):new TONG.MeshLambertMaterial,a.setIndex(new TONG.BufferAttribute(new Uint32Array(this.mIndexArray),1)),a.addAttribute("position",new TONG.BufferAttribute(this.mVertexBuffer,3)),this.mNormalBuffer&&0<this.mNormalBuffer.length&&a.addAttribute("normal",new TONG.BufferAttribute(this.mNormalBuffer,3)),this.mColorBuffer&&0<this.mColorBuffer.length&&a.addAttribute("color",new TONG.BufferAttribute(this.mColorBuffer,4)),this.mTexCoordsBuffers[0]&&0<this.mTexCoordsBuffers[0].length&&a.addAttribute("uv",new TONG.BufferAttribute(new Float32Array(this.mTexCoordsBuffers[0]),2)),this.mTexCoordsBuffers[1]&&0<this.mTexCoordsBuffers[1].length&&a.addAttribute("uv1",new TONG.BufferAttribute(new Float32Array(this.mTexCoordsBuffers[1]),2)),this.mTangentBuffer&&0<this.mTangentBuffer.length&&a.addAttribute("tangents",new TONG.BufferAttribute(this.mTangentBuffer,3)),this.mBitangentBuffer&&0<this.mBitangentBuffer.length&&a.addAttribute("bitangents",new TONG.BufferAttribute(this.mBitangentBuffer,3)),0<this.mBones.length){for(var n=[],i=[],s=0;s<this.mBones.length;s++)for(var o=0;o<this.mBones[s].mWeights.length;o++){var l=this.mBones[s].mWeights[o];l&&(n[l.mVertexId]||(n[l.mVertexId]=[]),i[l.mVertexId]||(i[l.mVertexId]=[]),n[l.mVertexId].push(l.mWeight),i[l.mVertexId].push(parseInt(s)))}for(var s in i)L(i[s],n[s]);var u=[],h=[];for(s=0;s<n.length;s++)for(o=0;o<4;o++)n[s]&&i[s]?(u.push(n[s][o]),h.push(i[s][o])):(u.push(0),h.push(0));a.addAttribute("skinWeight",new TONG.BufferAttribute(new Float32Array(u),G)),a.addAttribute("skinIndex",new TONG.BufferAttribute(new Float32Array(h),G))}return 0==this.mBones.length&&(r=new TONG.Mesh(a,t)),0<this.mBones.length&&(r=new TONG.SkinnedMesh(a,t)),this.TONGNode=r}}function F(){this.mNumIndices=0,this.mIndices=[]}function I(){this.x=0,this.y=0,this.z=0,this.toTONG=function(){return new TONG.Vector3(this.x,this.y,this.z)}}function B(){this.r=0,this.g=0,this.b=0,this.a=0,this.toTONG=function(){return new TONG.Color(this.r,this.g,this.b,1)}}function E(){this.x=0,this.y=0,this.z=0,this.w=0,this.toTONG=function(){return new TONG.Quaternion(this.x,this.y,this.z,this.w)}}function R(){this.mVertexId=0,this.mWeight=0}function D(){this.data=[],this.toString=function(){var t="";return this.data.forEach(function(e){t+=String.fromCharCode(e)}),t.replace(/[^\x20-\x7E]+/g,"")}}function P(){this.mTime=0,this.mValue=null}function U(){this.mTime=0,this.mValue=null}function z(){this.mName="",this.mTransformation=[],this.mNumChildren=0,this.mNumMeshes=0,this.mMeshes=[],this.mChildren=[],this.toTONG=function(e){if(this.TONGNode)return this.TONGNode;var t=new TONG.Object3D;t.name=this.mName,t.matrix=this.mTransformation.toTONG();for(var r=0;r<this.mChildren.length;r++)t.add(this.mChildren[r].toTONG(e));for(r=0;r<this.mMeshes.length;r++)t.add(e.mMeshes[this.mMeshes[r]].toTONG(e));return(this.TONGNode=t).matrix.decompose(t.position,t.quaternion,t.scale),t}}function V(){this.mName="",this.mNumWeights=0,this.mOffsetMatrix=0}function j(){this.mKey="",this.mSemantic=0,this.mIndex=0,this.mData=[],this.mDataLength=0,this.mType=0,this.dataAsColor=function(){var e=new Uint8Array(this.mData).buffer,t=new DataView(e),r=t.getFloat32(0,!0),a=t.getFloat32(4,!0),n=t.getFloat32(8,!0);return new TONG.Color(r,a,n)},this.dataAsFloat=function(){var e=new Uint8Array(this.mData).buffer;return new DataView(e).getFloat32(0,!0)},this.dataAsBool=function(){var e=new Uint8Array(this.mData).buffer;return!!new DataView(e).getFloat32(0,!0)},this.dataAsString=function(){var e=new D;return e.data=this.mData,e.toString()},this.dataAsMap=function(){var e=new D;e.data=this.mData;var t=e.toString();return-1!=(t=t.replace(/\\/g,"/")).indexOf("/")&&(t=t.substr(t.lastIndexOf("/")+1)),r.load(t)}}var W={"?mat.name":"name","$mat.shadingm":"shading","$mat.twosided":"twoSided","$mat.wireframe":"wireframe","$clr.ambient":"ambient","$clr.diffuse":"color","$clr.specular":"specular","$clr.emissive":"emissive","$clr.transparent":"transparent","$clr.reflective":"reflect","$mat.shininess":"shininess","$mat.reflectivity":"reflectivity","$mat.refracti":"refraction","$tex.file":"map"},Z={"?mat.name":"string","$mat.shadingm":"bool","$mat.twosided":"bool","$mat.wireframe":"bool","$clr.ambient":"color","$clr.diffuse":"color","$clr.specular":"color","$clr.emissive":"color","$clr.transparent":"color","$clr.reflective":"color","$mat.shininess":"float","$mat.reflectivity":"float","$mat.refracti":"float","$tex.file":"map"};function X(){this.mNumAllocated=0,this.mNumProperties=0,this.mProperties=[],this.toTONG=function(e){this.mProperties[0].dataAsString();for(var t=new TONG.MeshPhongMaterial,r=0;r<this.mProperties.length;r++)if("float"==Z[this.mProperties[r].mKey]&&(t[W[this.mProperties[r].mKey]]=this.mProperties[r].dataAsFloat()),"color"==Z[this.mProperties[r].mKey]&&(t[W[this.mProperties[r].mKey]]=this.mProperties[r].dataAsColor()),"bool"==Z[this.mProperties[r].mKey]&&(t[W[this.mProperties[r].mKey]]=this.mProperties[r].dataAsBool()),"string"==Z[this.mProperties[r].mKey]&&(t[W[this.mProperties[r].mKey]]=this.mProperties[r].dataAsString()),"map"==Z[this.mProperties[r].mKey]){var a=this.mProperties[r];a.mSemantic==o&&(t.map=this.mProperties[r].dataAsMap()),a.mSemantic==l&&(t.normalMap=this.mProperties[r].dataAsMap()),a.mSemantic==M&&(t.lightMap=this.mProperties[r].dataAsMap()),a.mSemantic==x&&(t.alphaMap=this.mProperties[r].dataAsMap())}return t.ambient.r=.53,t.ambient.g=.53,t.ambient.b=.53,t.color.r=1,t.color.g=1,t.color.b=1,t}}function K(e,t,r){var a=new TONG.Vector3,n=1-r;return a.x=e.x*r+t.x*n,a.y=e.y*r+t.y*n,a.z=e.z*r+t.z*n,a}function H(e,t,r){return e.clone().slerp(t,1-r)}function q(e,t,r,a){if(1==e.length)return e[0].mValue.toTONG();for(var n=1/0,i=null,s=null,o=0;o<e.length;o++){var l=Math.abs(e[o].mTime-t);l<n&&e[o].mTime<=t&&(n=l,i=e[o],s=e[o+1])}if(i){if(s){var u=s.mTime-i.mTime,h=(i.mTime-t)/u;return a(i.mValue.toTONG(),s.mValue.toTONG(),h)}(s=e[0].clone()).mTime+=r;u=s.mTime-i.mTime,h=(i.mTime-t)/u;return a(i.mValue.toTONG(),s.mValue.toTONG(),h)}return null}function Y(){this.mNodeName="",this.mNumPositionKeys=0,this.mNumRotationKeys=0,this.mNumScalingKeys=0,this.mPositionKeys=[],this.mRotationKeys=[],this.mScalingKeys=[],this.mPreState="",this.mPostState="",this.init=function(t){function e(e){e.mTime/=t}t||(t=1),this.mPositionKeys.forEach(e),this.mRotationKeys.forEach(e),this.mScalingKeys.forEach(e)},this.sortKeys=function(){function e(e,t){return e.mTime-t.mTime}this.mPositionKeys.sort(e),this.mRotationKeys.sort(e),this.mScalingKeys.sort(e)},this.getLength=function(){return Math.max(Math.max.apply(null,this.mPositionKeys.map(function(e){return e.mTime})),Math.max.apply(null,this.mRotationKeys.map(function(e){return e.mTime})),Math.max.apply(null,this.mScalingKeys.map(function(e){return e.mTime})))},this.toTONG=function(e,t){this.sortKeys();for(var r=this.getLength(),a=new f.KeyFrameTrack,n=0;n<r;n+=.05){var i=new TONG.Matrix4,s=n,o=q(this.mPositionKeys,s,r,K),l=q(this.mScalingKeys,s,r,K),u=q(this.mRotationKeys,s,r,H);i.compose(o,u,l);var h=new f.KeyFrame(s,i);a.addKey(h)}a.target=e.findNode(this.mNodeName).toTONG();var c=[a];if(e.nodeToBoneMap[this.mNodeName])for(n=0;n<e.nodeToBoneMap[this.mNodeName].length;n++){var d=a.clone();d.target=e.nodeToBoneMap[this.mNodeName][n],c.push(d)}return c}}function Q(){this.mName="",this.mDuration=0,this.mTicksPerSecond=0,this.mNumChannels=0,this.mChannels=[],this.toTONG=function(e){var t=new f.Animation;for(var r in this.mChannels){this.mChannels[r].init(this.mTicksPerSecond);var a=this.mChannels[r].toTONG(e);for(var n in a)a[n].init(),t.addTrack(a[n])}return t.length=Math.max.apply(null,t.tracks.map(function(e){return e.length})),t}}function J(){this.mWidth=0,this.mHeight=0,this.texAchFormatHint=[],this.pcData=[]}function $(){this.mName="",this.mType=0,this.mAttenuationConstant=0,this.mAttenuationLinear=0,this.mAttenuationQuadratic=0,this.mAngleInnerCone=0,this.mAngleOuterCone=0,this.mColorDiffuse=null,this.mColorSpecular=null,this.mColorAmbient=null}function ee(){this.mName="",this.mPosition=null,this.mLookAt=null,this.mUp=null,this.mHorizontalFOV=0,this.mClipPlaneNear=0,this.mClipPlaneFar=0,this.mAspect=0}function te(){this.mFlags=0,this.mNumMeshes=0,this.mNumMaterials=0,this.mNumAnimations=0,this.mNumTextures=0,this.mNumLights=0,this.mNumCameras=0,this.mRootNode=null,this.mMeshes=[],this.mMaterials=[],this.mAnimations=[],this.mLights=[],this.mCameras=[],this.nodeToBoneMap={},this.findNode=function(e,t){if(t||(t=this.mRootNode),t.mName==e)return t;for(var r=0;r<t.mChildren.length;r++){var a=this.findNode(e,t.mChildren[r]);if(a)return a}return null},this.toTONG=function(){this.nodeCount=0,function(e){for(var t in e.mMeshes){var r=e.mMeshes[t];for(var a in r.mBones){var n=e.findNode(r.mBones[a].mName);n&&(n.isBone=!0)}}}(this);var e=this.mRootNode.toTONG(this);for(var t in this.mMeshes)this.mMeshes[t].hookupSkeletons(this,e);if(0<this.mAnimations.length)var r=this.mAnimations[0].toTONG(this);return{object:e,animation:r}}}function re(){this.elements=[[],[],[],[]],this.toTONG=function(){for(var e=new TONG.Matrix4,t=0;t<4;++t)for(var r=0;r<4;++r)e.elements[4*t+r]=this.elements[r][t];return e}}var ae=!0;function ne(e){var t=e.getFloat32(e.readOffset,ae);return e.readOffset+=4,t}function ie(e){var t=e.getFloat64(e.readOffset,ae);return e.readOffset+=8,t}function se(e){var t=e.getUint16(e.readOffset,ae);return e.readOffset+=2,t}function oe(e){var t=e.getUint32(e.readOffset,ae);return e.readOffset+=4,t}function le(e){var t=e.getUint32(e.readOffset,ae);return e.readOffset+=4,t}function ue(e){var t=new I;return t.x=ne(e),t.y=ne(e),t.z=ne(e),t}function he(e){var t=new B;return t.r=ne(e),t.g=ne(e),t.b=ne(e),t}function ce(e){var t=new D,r=oe(e);return e.ReadBytes(t.data,1,r),t.toString()}function de(e){for(var t=new re,r=0;r<4;++r)for(var a=0;a<4;++a)t.elements[r][a]=ne(e);return t}function fe(e){var t,r,a=new U;return a.mTime=ie(e),a.mValue=(t=e,(r=new E).w=ne(t),r.x=ne(t),r.y=ne(t),r.z=ne(t),r),a}function pe(e,t,r){for(var a=0;a<r;a++)t[a]=(n=e,i=void 0,(i=new P).mTime=ie(n),i.mValue=ue(n),i);var n,i}function me(e,t,r){return e.Seek(sizeof(t)*r,Ne)}function ge(e){if(!e)throw"asset failed"}function ve(e,t){ge(le(e)==d),le(e),t.mPrimitiveTypes=oe(e),t.mNumVertices=oe(e),t.mNumFaces=oe(e),t.mNumBones=oe(e),t.mMaterialIndex=oe(e),t.mNumUVComponents=[];var r,a,n=oe(e);n&v&&(Oe?me(e,t.mVertices,t.mNumVertices):(t.mVertices=[],t.mVertexBuffer=e.subArray32(e.readOffset,e.readOffset+3*t.mNumVertices*4),e.Seek(3*t.mNumVertices*4,Ne))),n&y&&(Oe?me(e,t.mNormals,t.mNumVertices):(t.mNormals=[],t.mNormalBuffer=e.subArray32(e.readOffset,e.readOffset+3*t.mNumVertices*4),e.Seek(3*t.mNumVertices*4,Ne))),n&T&&(Oe?(me(e,t.mTangents,t.mNumVertices),me(e,t.mBitangents,t.mNumVertices)):(t.mTangents=[],t.mTangentBuffer=e.subArray32(e.readOffset,e.readOffset+3*t.mNumVertices*4),e.Seek(3*t.mNumVertices*4,Ne),t.mBitangents=[],t.mBitangentBuffer=e.subArray32(e.readOffset,e.readOffset+3*t.mNumVertices*4),e.Seek(3*t.mNumVertices*4,Ne)));for(var i=0;i<O&&n&_<<i;++i)Oe?me(e,t.mColors[i],t.mNumVertices):(t.mColors[i]=[],t.mColorBuffer=e.subArray32(e.readOffset,e.readOffset+4*t.mNumVertices*4),e.Seek(4*t.mNumVertices*4,Ne));t.mTexCoordsBuffers=[];for(i=0;i<w&&n&b<<i;++i)if(t.mNumUVComponents[i]=oe(e),Oe)me(e,t.mTextureCoords[i],t.mNumVertices);else{t.mTextureCoords[i]=[],t.mTexCoordsBuffers[i]=[];for(var s=0;s<t.mNumVertices;s++)t.mTexCoordsBuffers[i].push(ne(e)),t.mTexCoordsBuffers[i].push(ne(e)),ne(e)}if(Oe)oe(e);else{t.mFaces=[];t.mIndexArray=[];for(var o=0;o<t.mNumFaces;++o){var l=t.mFaces[o]=new F;l.mNumIndices=se(e),l.mIndices=[];for(var u=0;u<l.mNumIndices;++u)t.mNumVertices<65536?l.mIndices[u]=se(e):l.mIndices[u]=oe(e);if(3===l.mNumIndices)t.mIndexArray.push(l.mIndices[0]),t.mIndexArray.push(l.mIndices[1]),t.mIndexArray.push(l.mIndices[2]);else{if(4!==l.mNumIndices)throw new Error("Sorry, can't currently triangulate polys. Use the triangulate preprocessor in Assimp.");t.mIndexArray.push(l.mIndices[0]),t.mIndexArray.push(l.mIndices[1]),t.mIndexArray.push(l.mIndices[2]),t.mIndexArray.push(l.mIndices[2]),t.mIndexArray.push(l.mIndices[3]),t.mIndexArray.push(l.mIndices[0])}}}if(t.mNumBones){t.mBones=[];for(u=0;u<t.mNumBones;++u)t.mBones[u]=new V,r=e,a=t.mBones[u],ge(le(r)==m),le(r),a.mName=ce(r),a.mNumWeights=oe(r),a.mOffsetMatrix=de(r),Oe?me(r,a.mWeights,a.mNumWeights):(a.mWeights=[],function(e,t,r){for(var a=0;a<r;a++)t[a]=(n=e,i=void 0,(i=new R).mVertexId=oe(n),i.mWeight=ne(n),i);var n,i}(r,a.mWeights,a.mNumWeights))}}function ye(e,t){var r,a;if(ge(le(e)==i),le(e),t.mNumAllocated=t.mNumProperties=oe(e),t.mNumProperties){t.mProperties&&delete t.mProperties,t.mProperties=[];for(var n=0;n<t.mNumProperties;++n)t.mProperties[n]=new j,r=e,a=t.mProperties[n],ge(le(r)==s),le(r),a.mKey=ce(r),a.mSemantic=oe(r),a.mIndex=oe(r),a.mDataLength=oe(r),a.mType=oe(r),a.mData=[],r.ReadBytes(a.mData,1,a.mDataLength)}}function Te(e,t){ge(le(e)==a),le(e),t.mNodeName=ce(e),t.mNumPositionKeys=oe(e),t.mNumRotationKeys=oe(e),t.mNumScalingKeys=oe(e),t.mPreState=oe(e),t.mPostState=oe(e),t.mNumPositionKeys&&(Oe?me(e,t.mPositionKeys,t.mNumPositionKeys):(t.mPositionKeys=[],pe(e,t.mPositionKeys,t.mNumPositionKeys))),t.mNumRotationKeys&&(Oe?me(e,t.mRotationKeys,t.mNumRotationKeys):(t.mRotationKeys=[],function(e,t,r){for(var a=0;a<r;a++)t[a]=fe(e)}(e,t.mRotationKeys,t.mNumRotationKeys))),t.mNumScalingKeys&&(Oe?me(e,t.mScalingKeys,t.mNumScalingKeys):(t.mScalingKeys=[],pe(e,t.mScalingKeys,t.mNumScalingKeys)))}function be(e,t){if(ge(le(e)==n),le(e),t.mName=ce(e),t.mDuration=ie(e),t.mTicksPerSecond=ie(e),t.mNumChannels=oe(e),t.mNumChannels){t.mChannels=[];for(var r=0;r<t.mNumChannels;++r)t.mChannels[r]=new Y,Te(e,t.mChannels[r])}}function _e(e,t){var r,a,n,i,s,o;if(ge(le(e)==p),le(e),t.mFlags=oe(e),t.mNumMeshes=oe(e),t.mNumMaterials=oe(e),t.mNumAnimations=oe(e),t.mNumTextures=oe(e),t.mNumLights=oe(e),t.mNumCameras=oe(e),t.mRootNode=new z,t.mRootNode=function e(t,r,a){ge(le(t)==g),le(t);var n=new z;if(n.mParent=r,n.mDepth=a,n.mName=ce(t),n.mTransformation=de(t),n.mNumChildren=oe(t),n.mNumMeshes=oe(t),n.mNumMeshes){n.mMeshes=[];for(var i=0;i<n.mNumMeshes;++i)n.mMeshes[i]=oe(t)}if(n.mNumChildren)for(n.mChildren=[],i=0;i<n.mNumChildren;++i){var s=e(t,n,a++);n.mChildren[i]=s}return n}(e,null,0),t.mNumMeshes){t.mMeshes=[];for(var l=0;l<t.mNumMeshes;++l)t.mMeshes[l]=new C,ve(e,t.mMeshes[l])}if(t.mNumMaterials){t.mMaterials=[];for(l=0;l<t.mNumMaterials;++l)t.mMaterials[l]=new X,ye(e,t.mMaterials[l])}if(t.mNumAnimations){t.mAnimations=[];for(l=0;l<t.mNumAnimations;++l)t.mAnimations[l]=new Q,be(e,t.mAnimations[l])}if(t.mNumTextures){t.mTextures=[];for(l=0;l<t.mNumTextures;++l)t.mTextures[l]=new J,r=e,a=t.mTextures[l],ge(le(r)==c),le(r),a.mWidth=oe(r),a.mHeight=oe(r),r.ReadBytes(a.achFormatHint,1,4),Oe||(a.mHeight?(a.pcData=[],r.ReadBytes(a.pcData,1,a.mWidth*a.mHeight*4)):(a.pcData=[],r.ReadBytes(a.pcData,1,a.mWidth)))}if(t.mNumLights){t.mLights=[];for(l=0;l<t.mNumLights;++l)t.mLights[l]=new $,n=e,i=t.mLights[l],ge(le(n)==h),le(n),i.mName=ce(n),i.mType=oe(n),i.mType!=N&&(i.mAttenuationConstant=ne(n),i.mAttenuationLinear=ne(n),i.mAttenuationQuadratic=ne(n)),i.mColorDiffuse=he(n),i.mColorSpecular=he(n),i.mColorAmbient=he(n),i.mType==A&&(i.mAngleInnerCone=ne(n),i.mAngleOuterCone=ne(n))}if(t.mNumCameras){t.mCameras=[];for(l=0;l<t.mNumCameras;++l)t.mCameras[l]=new ee,s=e,o=t.mCameras[l],ge(le(s)==u),le(s),o.mName=ce(s),o.mPosition=ue(s),o.mLookAt=ue(s),o.mUp=ue(s),o.mHorizontalFOV=ne(s),o.mClipPlaneNear=ne(s),o.mClipPlaneFar=ne(s),o.mAspect=ne(s)}}var Oe,we,Ne=0,Ae=1;return function(e){var r,t=new te,a=new DataView(e);if((r=a).readOffset=0,r.Seek=function(e,t){t==Ne&&(r.readOffset+=e),t==Ae&&(r.readOffset=e)},r.ReadBytes=function(e,t,r){for(var a,n,i=t*r,s=0;s<i;s++)e[s]=(n=(a=this).getUint8(a.readOffset),a.readOffset+=1,n)},r.subArray32=function(e,t){var r=this.buffer.slice(e,t);return new Float32Array(r)},r.subArrayUint16=function(e,t){var r=this.buffer.slice(e,t);return new Uint16Array(r)},r.subArrayUint8=function(e,t){var r=this.buffer.slice(e,t);return new Uint8Array(r)},r.subArrayUint32=function(e,t){var r=this.buffer.slice(e,t);return new Uint32Array(r)},a.Seek(44,Ne),oe(a),oe(a),oe(a),oe(a),Oe=0<se(a),we=0<se(a),Oe)throw"Shortened binaries are not supported!";if(a.Seek(256,Ne),a.Seek(128,Ne),a.Seek(64,Ne),!we)return _e(a,t),t.toTONG();var n=le(a),i=a.FileSize()-a.Tell(),s=[];a.Read(s,1,i);var o=[];uncompress(o,n,s,i),_e(new ArrayBuffer(o),t)}(e)}},function(){function i(){this.id=0,this.data=null}function o(){}o.prototype={set:function(e,t){this[e]=t},get:function(e,t){return this.hasOwnProperty(e)?this[e]:t}},TONG.AWDLoader=function(e){this.manager=void 0!==e?e:TONG.DefaultLoadingManager,this.trunk=new TONG.Object3D,this.materialFactory=void 0,this._url="",this._baseDir="",this._data=void 0,this._ptr=0,this._version=[],this._streaming=!1,this._optimized_for_accuracy=!1,this._compression=0,this._bodylen=4294967295,this._blocks=[new i],this._accuracyMatrix=!1,this._accuracyGeo=!1,this._accuracyProps=!1},TONG.AWDLoader.prototype={constructor:TONG.AWDLoader,load:function(e,t,r,a){var n=this;this._url=e,this._baseDir=e.substr(0,e.lastIndexOf("/")+1);var i=new TONG.FileLoader(this.manager);i.setResponseType("arraybuffer"),i.load(e,function(e){t(n.parse(e))},r,a)},parse:function(e){var t=e.byteLength;for(this._ptr=0,this._data=new DataView(e),this._parseHeader(),0!=this._compression&&console.error("compressed AWD not supported"),this._streaming||this._bodylen==e.byteLength-this._ptr||console.error("AWDLoader: body len does not match file length",this._bodylen,t-this._ptr);this._ptr<t;)this.parseNextBlock();return this.trunk},parseNextBlock:function(){var e,t,r=this.readU32(),a=(this.readU8(),this.readU8()),n=(this.readU8(),this.readU32());switch(a){case 1:e=this.parseMeshData(n);break;case 22:e=this.parseContainer(n);break;case 23:e=this.parseMeshInstance(n);break;case 81:e=this.parseMaterial(n);break;case 82:e=this.parseTexture(n);break;case 101:e=this.parseSkeleton(n);break;case 112:e=this.parseMeshPoseAnimation(n,!1);break;case 113:e=this.parseVertexAnimationSet(n);break;case 102:e=this.parseSkeletonPose(n);break;case 103:e=this.parseSkeletonAnimation(n);break;case 122:e=this.parseAnimatorSet(n);break;default:this._ptr+=n}this._blocks[r]=t=new i,t.data=e,t.id=r},_parseHeader:function(){var e=this._version;if(4282180!=(this.readU8()<<16|this.readU8()<<8|this.readU8()))throw new Error("AWDLoader - bad magic");e[0]=this.readU8(),e[1]=this.readU8();var t=this.readU16();this._streaming=1==(1&t),2===e[0]&&1===e[1]&&(this._accuracyMatrix=2==(2&t),this._accuracyGeo=4==(4&t),this._accuracyProps=8==(8&t)),this._geoNrType=this._accuracyGeo?8:7,this._matrixNrType=this._accuracyMatrix?8:7,this._propsNrType=this._accuracyProps?8:7,this._optimized_for_accuracy=2==(2&t),this._compression=this.readU8(),this._bodylen=this.readU32()},parseContainer:function(e){var t=new TONG.Object3D,r=this.readU32(),a=this.parseMatrix4();return t.name=this.readUTF(),t.applyMatrix(a),(this._blocks[r].data||this.trunk).add(t),this.parseProperties({1:this._matrixNrType,2:this._matrixNrType,3:this._matrixNrType,4:4}),t.extra=this.parseUserAttributes(),t},parseMeshInstance:function(e){var t,r,a,n,i,s,o,l,u,h,c,d,f;for(s=this.readU32(),l=this.parseMatrix4(),t=this.readUTF(),o=this.readU32(),d=this.readU16(),a=this.getBlock(o),u=[],f=0;f<d;f++)c=this.readU32(),h=this.getBlock(c),u.push(h);if(i=[],1<(n=a.length))for(r=new TONG.Object3D,f=0;f<n;f++){var p=new TONG.Mesh(a[f]);i.push(p),r.add(p)}else r=new TONG.Mesh(a[0]),i.push(r);r.applyMatrix(l),r.name=t,(this.getBlock(s)||this.trunk).add(r);var m=u.length,g=Math.max(n,m);for(f=0;f<g;f++)i[f%n].material=u[f%m];return this.parseProperties(null),r.extra=this.parseUserAttributes(),r},parseMaterial:function(e){var t,r,a,n,i,s;for(t=this.readUTF(),r=this.readU8(),s=this.readU8(),a=this.parseProperties({1:3,2:23,11:21,12:7,13:21}),0;0<s;){this.readU16();this.parseProperties(null),this.parseUserAttributes()}if(i=this.parseUserAttributes(),void 0!==this.materialFactory&&(n=this.materialFactory(t)))return n;if(n=new TONG.MeshPhongMaterial,1===r)n.color.setHex(a.get(1,13421772));else if(2===r){var o=a.get(2,0);n.map=this.getBlock(o)}return n.extra=i,n.alphaThreshold=a.get(12,0),n.repeat=a.get(13,!1),n},parseTexture:function(e){var t,r;this.readUTF();if(0===this.readU8()){r=this.readU32();var a=this.readUTFBytes(r);console.log(a),t=this.loadTexture(a)}return this.parseProperties(null),this.parseUserAttributes(),t},loadTexture:function(e){var t=new TONG.Texture;return new TONG.ImageLoader(this.manager).load(this._baseDir+e,function(e){t.image=e,t.needsUpdate=!0}),t},parseSkeleton:function(e){this.readUTF();var t=this.readU16(),r=[],a=0;for(this.parseProperties(null);a<t;){var n,i;this.readU16(),(n=new TONG.Bone).parent=this.readU16()-1,n.name=this.readUTF(),i=this.parseMatrix4(),n.skinMatrix=i,this.parseProperties(null),this.parseUserAttributes(),r.push(n),a++}return this.parseUserAttributes(),r},parseSkeletonPose:function(e){this.readUTF();var t=this.readU16();this.parseProperties(null);for(var r=[],a=0;a<t;){var n;n=1===this.readU8()?this.parseMatrix4():new TONG.Matrix4,r[a]=n,a++}return this.parseUserAttributes(),r},parseSkeletonAnimation:function(e){this.readUTF();var t,r,a,n=[],i=this.readU16();this.parseProperties(null);for(var s=0;s<i;)r=this.readU32(),t=this.readU16(),a=this._blocks[r].data,n.push({pose:a,duration:t}),s++;if(0!==n.length)return this.parseUserAttributes(),n},parseVertexAnimationSet:function(e){this.readUTF();for(var t,r=this.readU16(),a=(this.parseProperties({1:5}),0),n=[];a<r;)t=this.readU32(),n.push(this._blocks[t].data),a++;return this.parseUserAttributes(),n},parseAnimatorSet:function(e){this.readUTF();var t,r,a=this.readU16(),n=this.parseProperties({1:23});t=this.readU32();for(var i=this.readU16(),s=[],o=0;o<i;o++)s.push(this.readU32());this.readU16(),Boolean(this.readU8());this.parseUserAttributes(),this.parseUserAttributes();var l,u=[];for(o=0;o<s.length;o++)u.push(this._blocks[s[o]].data);for(r=this._blocks[t].data,1==a&&(l={animationSet:r,skeleton:this._blocks[n.get(1,0)].data}),o=0;o<u.length;o++)u[o].animator=l;return l},parseMeshData:function(e){var t,r,a=this.readUTF(),n=this.readU16(),i=0,s=[];for(this.parseProperties({1:this._geoNrType,2:this._geoNrType});i<n;){var o,l,u;for((t=new TONG.BufferGeometry).name=a,s.push(t),o=this.readU32(),l=this._ptr+o,this.parseProperties({1:this._geoNrType,2:this._geoNrType});this._ptr<l;){var h=0,c=this.readU8(),d=(this.readU8(),this.readU32()),f=d+this._ptr;if(1===c)for(r=new Float32Array(d/12*3),u=new TONG.BufferAttribute(r,3),t.addAttribute("position",u),h=0;this._ptr<f;)r[h]=-this.readF32(),r[h+1]=this.readF32(),r[h+2]=this.readF32(),h+=3;else if(2===c)for(r=new Uint16Array(d/2),u=new TONG.BufferAttribute(r,1),t.setIndex(u),h=0;this._ptr<f;)r[h+1]=this.readU16(),r[h]=this.readU16(),r[h+2]=this.readU16(),h+=3;else if(3===c)for(r=new Float32Array(d/8*2),u=new TONG.BufferAttribute(r,2),t.addAttribute("uv",u),h=0;this._ptr<f;)r[h]=this.readF32(),r[h+1]=1-this.readF32(),h+=2;else if(4===c)for(r=new Float32Array(d/12*3),u=new TONG.BufferAttribute(r,3),t.addAttribute("normal",u),h=0;this._ptr<f;)r[h]=-this.readF32(),r[h+1]=this.readF32(),r[h+2]=this.readF32(),h+=3;else this._ptr=f}this.parseUserAttributes(),t.computeBoundingSphere(),i++}return this.parseUserAttributes(),s},parseMeshPoseAnimation:function(e,t){var r,a,n,i,s,o,l,u,h,c=1,d=0,f={},p=[],m=(this.readUTF(),this.readU32()),g=this.getBlock(m);if(null!==g){for((o=g.geometry).morphTargets=[],t||(c=this.readU16()),r=this.readU16(),l=this.readU16(),u=0;u<l;)p.push(this.readU16()),u++;for(h=this.parseProperties({1:21,2:21}),f.looping=h.get(1,!0),f.stitchFinalFrame=h.get(2,!1),a=0;a<c;){for(this.readU16(),n=0;n<r;)for(u=0,i=this.readU32(),s=this._ptr+i;u<l;){if(1===p[u]){var v=new Float32Array(i/4);for(o.morphTargets.push({array:v}),d=0;this._ptr<s;)v[d]=this.readF32(),v[d+1]=this.readF32(),v[d+2]=this.readF32(),d+=3;n++}else this._ptr=s;u++}a++}return this.parseUserAttributes(),null}console.log("parseMeshPoseAnimation target mesh not found at:",m)},getBlock:function(e){return this._blocks[e].data},parseMatrix4:function(){var e=new TONG.Matrix4,t=e.elements;return t[0]=this.readF32(),t[1]=this.readF32(),t[2]=this.readF32(),t[3]=0,t[4]=this.readF32(),t[5]=this.readF32(),t[6]=this.readF32(),t[7]=0,t[8]=this.readF32(),t[9]=this.readF32(),t[10]=this.readF32(),t[11]=0,t[12]=-this.readF32(),t[13]=this.readF32(),t[14]=this.readF32(),t[15]=1,e},parseProperties:function(e){var t=this.readU32(),r=this._ptr+t,a=new o;if(e)for(;this._ptr<r;){var n,i=this.readU16(),s=this.readU32();e.hasOwnProperty(i)?(n=e[i],a.set(i,this.parseAttrValue(n,s))):this._ptr+=s}return a},parseUserAttributes:function(){return this._ptr=this.readU32()+this._ptr,null},parseAttrValue:function(e,t){var r,a;switch(e){case 1:r=1,a=this.readI8;break;case 2:r=2,a=this.readI16;break;case 3:r=4,a=this.readI32;break;case 21:case 4:r=1,a=this.readU8;break;case 5:r=2,a=this.readU16;break;case 6:case 23:r=4,a=this.readU32;break;case 7:r=4,a=this.readF32;break;case 8:r=8,a=this.readF64;break;case 41:case 42:case 43:case 44:case 45:case 46:case 47:r=8,a=this.readF64}if(r<t){var n,i,s;for(n=[],i=0,s=t/r;i<s;)n.push(a.call(this)),i++;return n}return a.call(this)},readU8:function(){return this._data.getUint8(this._ptr++)},readI8:function(){return this._data.getInt8(this._ptr++)},readU16:function(){var e=this._data.getUint16(this._ptr,!0);return this._ptr+=2,e},readI16:function(){var e=this._data.getInt16(this._ptr,!0);return this._ptr+=2,e},readU32:function(){var e=this._data.getUint32(this._ptr,!0);return this._ptr+=4,e},readI32:function(){var e=this._data.getInt32(this._ptr,!0);return this._ptr+=4,e},readF32:function(){var e=this._data.getFloat32(this._ptr,!0);return this._ptr+=4,e},readF64:function(){var e=this._data.getFloat64(this._ptr,!0);return this._ptr+=8,e},readUTF:function(){var e=this.readU16();return this.readUTFBytes(e)},readUTFBytes:function(e){for(var t=[],r=0;t.length<e;){var a=this._data.getUint8(this._ptr++,!0);if(a<128)t[r++]=String.fromCharCode(a);else if(191<a&&a<224){var n=this._data.getUint8(this._ptr++,!0);t[r++]=String.fromCharCode((31&a)<<6|63&n)}else{n=this._data.getUint8(this._ptr++,!0);var i=this._data.getUint8(this._ptr++,!0);t[r++]=String.fromCharCode((15&a)<<12|(63&n)<<6|63&i)}}return t.join("")}}}(),TONG.BabylonLoader=function(e){this.manager=void 0!==e?e:TONG.DefaultLoadingManager},TONG.BabylonLoader.prototype={constructor:TONG.BabylonLoader,load:function(e,t,r,a){var n=this;new TONG.FileLoader(n.manager).load(e,function(e){t(n.parse(JSON.parse(e)))},r,a)},parse:function(e){function p(e){var t=new TONG.BufferGeometry,r=e.indices,a=e.positions,n=e.normals,i=e.uvs;t.setIndex(r);for(var s=2,o=a.length;s<o;s+=3)a[s]=-a[s];if(t.addAttribute("position",new TONG.Float32BufferAttribute(a,3)),n){for(s=2,o=n.length;s<o;s+=3)n[s]=-n[s];t.addAttribute("normal",new TONG.Float32BufferAttribute(n,3))}i&&t.addAttribute("uv",new TONG.Float32BufferAttribute(i,2));var l=e.subMeshes;if(l)for(s=0,o=l.length;s<o;s++){var u=l[s];t.addGroup(u.indexStart,u.indexCount)}return t}return function(e,t){for(var r={},a=new TONG.Scene,n=e.cameras,i=0,s=n.length;i<s;i++){var o=n[i],l=new TONG.PerspectiveCamera(o.fov/Math.PI*180,1.33,o.minZ,o.maxZ);l.name=o.name,l.position.fromArray(o.position),o.rotation&&l.rotation.fromArray(o.rotation),r[o.id]=l}var u=e.lights;for(i=0,s=u.length;i<s;i++){var h;switch((o=u[i]).type){case 0:h=new TONG.PointLight;break;case 1:h=new TONG.DirectionalLight;break;case 2:h=new TONG.SpotLight;break;case 3:h=new TONG.HemisphereLight}h.name=o.name,o.position&&h.position.set(o.position[0],o.position[1],-o.position[2]),h.color.fromArray(o.diffuse),o.groundColor&&h.groundColor.fromArray(o.groundColor),o.intensity&&(h.intensity=o.intensity),r[o.id]=h,a.add(h)}var c=e.meshes;for(i=0,s=c.length;i<s;i++){var d;if((o=c[i]).indices){var f=p(o);d=new TONG.Mesh(f,t[o.materialId])}else d=new TONG.Group;d.name=o.name,d.position.set(o.position[0],o.position[1],-o.position[2]),d.rotation.fromArray(o.rotation),o.rotationQuaternion&&d.quaternion.fromArray(o.rotationQuaternion),d.scale.fromArray(o.scaling),o.parentId?r[o.parentId].add(d):a.add(d),r[o.id]=d}return a}(e,function(e){for(var t={},r=0,a=e.materials.length;r<a;r++){var n=e.materials[r],i=new TONG.MeshPhongMaterial;i.name=n.name,i.color.fromArray(n.diffuse),i.emissive.fromArray(n.emissive),i.specular.fromArray(n.specular),i.shininess=n.specularPower,i.opacity=n.alpha,t[n.id]=i}if(e.multiMaterials)for(r=0,a=e.multiMaterials.length;r<a;r++)n=e.multiMaterials[r],console.warn("TONG.BabylonLoader: Multi materials not yet supported."),t[n.id]=new TONG.MeshPhongMaterial;return t}(e))}},TONG.ColladaLoader=function(e){this.manager=void 0!==e?e:TONG.DefaultLoadingManager},TONG.ColladaLoader.prototype={constructor:TONG.ColladaLoader,crossOrigin:"anonymous",load:function(e,t,r,a){var n=this,i=void 0===n.path?TONG.LoaderUtils.extractUrlBase(e):n.path;new TONG.FileLoader(n.manager).load(e,function(e){t(n.parse(e,i))},r,a)},setPath:function(e){return this.path=e,this},options:{set convertUpAxis(e){console.warn("TONG.ColladaLoader: options.convertUpAxis() has been removed. Up axis is converted automatically.")}},setCrossOrigin:function(e){return this.crossOrigin=e,this},parse:function(e,t){function o(e,t){for(var r=[],a=e.childNodes,n=0,i=a.length;n<i;n++){var s=a[n];s.nodeName===t&&r.push(s)}return r}function i(e){if(0===e.length)return[];for(var t=e.trim().split(/\s+/),r=new Array(t.length),a=0,n=t.length;a<n;a++)r[a]=t[a];return r}function v(e){if(0===e.length)return[];for(var t=e.trim().split(/\s+/),r=new Array(t.length),a=0,n=t.length;a<n;a++)r[a]=parseFloat(t[a]);return r}function l(e){if(0===e.length)return[];for(var t=e.trim().split(/\s+/),r=new Array(t.length),a=0,n=t.length;a<n;a++)r[a]=parseInt(t[a]);return r}function u(e){return e.substring(1)}function f(e){return 0===Object.keys(e).length}function r(e,t,r,a){var n=o(e,t)[0];if(void 0!==n)for(var i=o(n,r),s=0;s<i.length;s++)a(i[s])}function a(e,t){for(var r in e){e[r].build=t(e[r])}}function x(e,t){return void 0!==e.build||(e.build=t(e)),e.build}function s(e){for(var t={inputs:{}},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"input":var i=u(n.getAttribute("source")),s=n.getAttribute("semantic");t.inputs[s]=i}}return t}function h(e){var t={},r=e.getAttribute("target").split("/"),a=r.shift(),n=r.shift(),i=-1!==n.indexOf("("),s=-1!==n.indexOf(".");if(s)n=(r=n.split(".")).shift(),t.member=r.shift();else if(i){var o=n.split("(");n=o.shift();for(var l=0;l<o.length;l++)o[l]=parseInt(o[l].replace(/\)/,""));t.indices=o}return t.id=a,t.sid=n,t.arraySyntax=i,t.memberSyntax=s,t.sampler=u(e.getAttribute("source")),t}function n(e){var t=[],r=e.channels,a=e.samplers,n=e.sources;for(var i in r)if(r.hasOwnProperty(i)){var s=r[i],o=a[s.sampler],l=o.inputs.INPUT,u=o.inputs.OUTPUT;y(d(s,n[l],n[u]),t)}return t}function c(e){return x(Ve.animations[e],n)}function d(e,t,r){var a,n,i,s,o,l,u=Ve.nodes[e.id],h=Ge(u.id),c=u.transforms[e.sid],d=u.matrix.clone().transpose(),f={};switch(c){case"matrix":for(i=0,s=t.array.length;i<s;i++)if(a=t.array[i],n=i*r.stride,void 0===f[a]&&(f[a]={}),!0===e.arraySyntax){var p=r.array[n],m=e.indices[0]+4*e.indices[1];f[a][m]=p}else for(o=0,l=r.stride;o<l;o++)f[a][o]=r.array[n+o];break;case"translate":case"rotate":case"scale":console.warn('TONG.ColladaLoader: Animation transform type "%s" not yet implemented.',c)}var g=function(e,t){var r=[];for(var a in e)r.push({time:parseFloat(a),value:e[a]});r.sort(function(e,t){return e.time-t.time});for(var n=0;n<16;n++)T(r,n,t.elements[n]);return r}(f,d);return{name:h.uuid,keyframes:g}}var p=new TONG.Vector3,m=new TONG.Vector3,g=new TONG.Quaternion;function y(e,t){for(var r=e.keyframes,a=e.name,n=[],i=[],s=[],o=[],l=0,u=r.length;l<u;l++){var h=r[l],c=h.time,d=h.value;ve.fromArray(d).transpose(),ve.decompose(p,g,m),n.push(c),i.push(p.x,p.y,p.z),s.push(g.x,g.y,g.z,g.w),o.push(m.x,m.y,m.z)}return 0<i.length&&t.push(new TONG.VectorKeyframeTrack(a+".position",n,i)),0<s.length&&t.push(new TONG.QuaternionKeyframeTrack(a+".quaternion",n,s)),0<o.length&&t.push(new TONG.VectorKeyframeTrack(a+".scale",n,o)),t}function T(e,t,r){var a,n,i,s=!0;for(n=0,i=e.length;n<i;n++)void 0===(a=e[n]).value[t]?a.value[t]=null:s=!1;if(!0===s)for(n=0,i=e.length;n<i;n++)(a=e[n]).value[t]=r;else!function(e,t){for(var r,a,n=0,i=e.length;n<i;n++){var s=e[n];if(null===s.value[t]){if(r=b(e,n,t),a=_(e,n,t),null===r){s.value[t]=a.value[t];continue}if(null===a){s.value[t]=r.value[t];continue}O(s,r,a,t)}}}(e,t)}function b(e,t,r){for(;0<=t;){var a=e[t];if(null!==a.value[r])return a;t--}return null}function _(e,t,r){for(;t<e.length;){var a=e[t];if(null!==a.value[r])return a;t++}return null}function O(e,t,r,a){r.time-t.time!=0?e.value[a]=(e.time-t.time)*(r.value[a]-t.value[a])/(r.time-t.time)+t.value[a]:e.value[a]=t.value[a]}function w(e){for(var t=[],r=e.name,a=e.end-e.start||-1,n=e.animations,i=0,s=n.length;i<s;i++)for(var o=c(n[i]),l=0,u=o.length;l<u;l++)t.push(o[l]);return new TONG.AnimationClip(r,a,t)}function N(e){for(var t={sources:{}},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"bind_shape_matrix":t.bindShapeMatrix=v(n.textContent);break;case"source":var i=n.getAttribute("id");t.sources[i]=J(n);break;case"joints":t.joints=A(n);break;case"vertex_weights":t.vertexWeights=M(n)}}return t}function A(e){for(var t={inputs:{}},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"input":var i=n.getAttribute("semantic"),s=u(n.getAttribute("source"));t.inputs[i]=s}}return t}function M(e){for(var t={inputs:{}},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"input":var i=n.getAttribute("semantic"),s=u(n.getAttribute("source")),o=parseInt(n.getAttribute("offset"));t.inputs[i]={id:s,offset:o};break;case"vcount":t.vcount=l(n.textContent);break;case"v":t.v=l(n.textContent)}}return t}function G(e){var t={id:e.id},r=Ve.geometries[t.id];return void 0!==e.skin&&(t.skin=function(e){var t,r,a,n={joints:[],indices:{array:[],stride:4},weights:{array:[],stride:4}},i=e.sources,s=e.vertexWeights,o=s.vcount,l=s.v,u=s.inputs.JOINT.offset,h=s.inputs.WEIGHT.offset,c=e.sources[e.joints.inputs.JOINT],d=e.sources[e.joints.inputs.INV_BIND_MATRIX],f=i[s.inputs.WEIGHT.id].array,p=0;for(t=0,a=o.length;t<a;t++){var m=o[t],g=[];for(r=0;r<m;r++){var v=l[p+u],y=l[p+h],T=f[y];g.push({index:v,weight:T}),p+=2}for(g.sort(w),r=0;r<4;r++){var b=g[r];void 0!==b?(n.indices.array.push(b.index),n.weights.array.push(b.weight)):(n.indices.array.push(0),n.weights.array.push(0))}}e.bindShapeMatrix?n.bindMatrix=(new TONG.Matrix4).fromArray(e.bindShapeMatrix).transpose():n.bindMatrix=(new TONG.Matrix4).identity();for(t=0,a=c.array.length;t<a;t++){var _=c.array[t],O=(new TONG.Matrix4).fromArray(d.array,t*d.stride).transpose();n.joints.push({name:_,boneInverse:O})}return n;function w(e,t){return t.weight-e.weight}}(e.skin),r.sources.skinIndices=t.skin.indices,r.sources.skinWeights=t.skin.weights),t}function k(e){return void 0!==e.build?e.build:e.init_from}function L(e){var t=Ve.images[e];return void 0!==t?x(t,k):(console.warn("TONG.ColladaLoader: Couldn't find image with ID:",e),null)}function S(e){for(var t={surfaces:{},samplers:{}},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"newparam":C(n,t);break;case"technique":t.technique=B(n);break;case"extra":t.extra=z(n)}}return t}function C(e,t){for(var r=e.getAttribute("sid"),a=0,n=e.childNodes.length;a<n;a++){var i=e.childNodes[a];if(1===i.nodeType)switch(i.nodeName){case"surface":t.surfaces[r]=F(i);break;case"sampler2D":t.samplers[r]=I(i)}}}function F(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"init_from":t.init_from=n.textContent}}return t}function I(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"source":t.source=n.textContent}}return t}function B(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"constant":case"lambert":case"blinn":case"phong":t.type=n.nodeName,t.parameters=E(n)}}return t}function E(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"emission":case"diffuse":case"specular":case"shininess":case"transparency":t[n.nodeName]=R(n);break;case"transparent":t[n.nodeName]={opaque:n.getAttribute("opaque"),data:R(n)}}}return t}function R(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"color":t[n.nodeName]=v(n.textContent);break;case"float":t[n.nodeName]=parseFloat(n.textContent);break;case"texture":t[n.nodeName]={id:n.getAttribute("texture"),extra:D(n)}}}return t}function D(e){for(var t={technique:{}},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"extra":P(n,t)}}return t}function P(e,t){for(var r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"technique":U(n,t)}}}function U(e,t){for(var r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"repeatU":case"repeatV":case"offsetU":case"offsetV":t.technique[n.nodeName]=parseFloat(n.textContent);break;case"wrapU":case"wrapV":"TRUE"===n.textContent.toUpperCase()?t.technique[n.nodeName]=1:"FALSE"===n.textContent.toUpperCase()?t.technique[n.nodeName]=0:t.technique[n.nodeName]=parseInt(n.textContent)}}}function z(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"technique":t.technique=V(n)}}return t}function V(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"double_sided":t[n.nodeName]=parseInt(n.textContent)}}return t}function j(e){return e}function W(e){var t,r,o=(t=e.url,x(Ve.effects[t],j)),a=o.profile.technique,n=o.profile.extra;switch(a.type){case"phong":case"blinn":r=new TONG.MeshPhongMaterial;break;case"lambert":r=new TONG.MeshLambertMaterial;break;default:r=new TONG.MeshBasicMaterial}function i(e){var t=o.profile.samplers[e.id],r=null;void 0!==t?r=L(o.profile.surfaces[t.source].init_from):(console.warn("TONG.ColladaLoader: Undefined sampler. Access image directly (see #12530)."),r=L(e.id));if(null!==r){var a=function(e){var t,r=e.slice(2+(e.lastIndexOf(".")-1>>>0));switch(r=r.toLowerCase()){case"tga":t=Ee;break;default:t=De}return t}(r);if(void 0!==a){var n=a.load(r),i=e.extra;if(void 0!==i&&void 0!==i.technique&&!1===f(i.technique)){var s=i.technique;n.wrapS=s.wrapU?TONG.RepeatWrapping:TONG.ClampToEdgeWrapping,n.wrapT=s.wrapV?TONG.RepeatWrapping:TONG.ClampToEdgeWrapping,n.offset.set(s.offsetU||0,s.offsetV||0),n.repeat.set(s.repeatU||1,s.repeatV||1)}else n.wrapS=TONG.RepeatWrapping,n.wrapT=TONG.RepeatWrapping;return n}return console.warn("TONG.ColladaLoader: Loader for texture %s not found.",r),null}return console.warn("TONG.ColladaLoader: Couldn't create texture with ID:",e.id),null}r.name=e.name;var s=a.parameters;for(var l in s){var u=s[l];switch(l){case"diffuse":u.color&&r.color.fromArray(u.color),u.texture&&(r.map=i(u.texture));break;case"specular":u.color&&r.specular&&r.specular.fromArray(u.color),u.texture&&(r.specularMap=i(u.texture));break;case"shininess":u.float&&r.shininess&&(r.shininess=u.float);break;case"emission":u.color&&r.emissive&&r.emissive.fromArray(u.color),u.texture&&(r.emissiveMap=i(u.texture))}}var h=s.transparent,c=s.transparency;if(void 0===c&&h&&(c={float:1}),void 0===h&&c&&(h={opaque:"A_ONE",data:{color:[1,1,1,1]}}),h&&c)if(h.data.texture)r.transparent=!0;else{var d=h.data.color;switch(h.opaque){case"A_ONE":r.opacity=d[3]*c.float;break;case"RGB_ZERO":r.opacity=1-d[0]*c.float;break;case"A_ZERO":r.opacity=1-d[3]*c.float;break;case"RGB_ONE":r.opacity=d[0]*c.float;break;default:console.warn('TONG.ColladaLoader: Invalid opaque type "%s" of transparent tag.',h.opaque)}r.opacity<1&&(r.transparent=!0)}return void 0!==n&&void 0!==n.technique&&1===n.technique.double_sided&&(r.side=TONG.DoubleSide),r}function Z(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"technique_common":return X(r)}}return{}}function X(e){for(var t={},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];switch(a.nodeName){case"perspective":case"orthographic":t.technique=a.nodeName,t.parameters=K(a)}}return t}function K(e){for(var t={},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];switch(a.nodeName){case"xfov":case"yfov":case"xmag":case"ymag":case"znear":case"zfar":case"aspect_ratio":t[a.nodeName]=parseFloat(a.textContent)}}return t}function H(e){var t;switch(e.optics.technique){case"perspective":t=new TONG.PerspectiveCamera(e.optics.parameters.yfov,e.optics.parameters.aspect_ratio,e.optics.parameters.znear,e.optics.parameters.zfar);break;case"orthographic":var r=e.optics.parameters.ymag,a=e.optics.parameters.xmag,n=e.optics.parameters.aspect_ratio;a=void 0===a?r*n:a,r=void 0===r?a/n:r,a*=.5,r*=.5,t=new TONG.OrthographicCamera(-a,a,r,-r,e.optics.parameters.znear,e.optics.parameters.zfar);break;default:t=new TONG.PerspectiveCamera}return t.name=e.name,t}function q(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"directional":case"point":case"spot":case"ambient":t.technique=n.nodeName,t.parameters=Y(n)}}return t}function Y(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"color":var i=v(n.textContent);t.color=(new TONG.Color).fromArray(i);break;case"falloff_angle":t.falloffAngle=parseFloat(n.textContent);break;case"quadratic_attenuation":var s=parseFloat(n.textContent);t.distance=s?Math.sqrt(1/s):0}}return t}function Q(e){var t;switch(e.technique){case"directional":t=new TONG.DirectionalLight;break;case"point":t=new TONG.PointLight;break;case"spot":t=new TONG.SpotLight;break;case"ambient":t=new TONG.AmbientLight}return e.parameters.color&&t.color.copy(e.parameters.color),e.parameters.distance&&(t.distance=e.parameters.distance),t}function J(e){for(var t={array:[],stride:3},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"float_array":t.array=v(a.textContent);break;case"Name_array":t.array=i(a.textContent);break;case"technique_common":var n=o(a,"accessor")[0];void 0!==n&&(t.stride=parseInt(n.getAttribute("stride")))}}return t}function $(e){for(var t={},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];1===a.nodeType&&(t[a.getAttribute("semantic")]=u(a.getAttribute("source")))}return t}function ee(e){for(var t={type:e.nodeName,material:e.getAttribute("material"),count:parseInt(e.getAttribute("count")),inputs:{},stride:0,hasUV:!1},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"input":var i=u(n.getAttribute("source")),s=n.getAttribute("semantic"),o=parseInt(n.getAttribute("offset"));t.inputs[s]={id:i,offset:o},t.stride=Math.max(t.stride,o+1),"TEXCOORD"===s&&(t.hasUV=!0);break;case"vcount":t.vcount=l(n.textContent);break;case"p":t.p=l(n.textContent)}}return t}function te(e){for(var t=0,r=0,a=e.length;r<a;r++){!0===e[r].hasUV&&t++}0<t&&t<e.length&&(e.uvsNeedsFix=!0)}function re(e){var t={},r=e.sources,a=e.vertices,n=e.primitives;if(0===n.length)return{};var i=function(e){for(var t={},r=0;r<e.length;r++){var a=e[r];void 0===t[a.type]&&(t[a.type]=[]),t[a.type].push(a)}return t}(n);for(var s in i){var o=i[s];te(o),t[s]=ae(o,r,a)}return t}function ae(e,t,r){for(var a={},n={array:[],stride:0},i={array:[],stride:0},s={array:[],stride:0},o={array:[],stride:0},l=[],u=4,h=[],c=4,d=new TONG.BufferGeometry,f=[],p=0,m=0;m<e.length;m++){var g=e[m],v=g.inputs,y=0;switch(g.type){case"lines":case"linestrips":y=2*g.count;break;case"triangles":y=3*g.count;break;case"polylist":for(var T=0;T<g.count;T++){var b=g.vcount[T];switch(b){case 3:y+=3;break;case 4:y+=6;break;default:y+=3*(b-2)}}break;default:console.warn("TONG.ColladaLoader: Unknow primitive type:",g.type)}for(var _ in d.addGroup(p,y,m),p+=y,g.material&&f.push(g.material),v){var O=v[_];switch(_){case"VERTEX":for(var w in r){var N=r[w];switch(w){case"POSITION":var A=n.array.length;if(ne(g,t[N],O.offset,n.array),n.stride=t[N].stride,t.skinWeights&&t.skinIndices&&(ne(g,t.skinIndices,O.offset,l),ne(g,t.skinWeights,O.offset,h)),!1===g.hasUV&&!0===e.uvsNeedsFix){y=(n.array.length-A)/n.stride;for(var x=0;x<y;x++)s.array.push(0,0)}break;case"NORMAL":ne(g,t[N],O.offset,i.array),i.stride=t[N].stride;break;case"COLOR":ne(g,t[N],O.offset,o.array),o.stride=t[N].stride;break;case"TEXCOORD":ne(g,t[N],O.offset,s.array),s.stride=t[N].stride;break;default:console.warn('TONG.ColladaLoader: Semantic "%s" not handled in geometry build process.',w)}}break;case"NORMAL":ne(g,t[O.id],O.offset,i.array),i.stride=t[O.id].stride;break;case"COLOR":ne(g,t[O.id],O.offset,o.array),o.stride=t[O.id].stride;break;case"TEXCOORD":ne(g,t[O.id],O.offset,s.array),s.stride=t[O.id].stride}}}return 0<n.array.length&&d.addAttribute("position",new TONG.Float32BufferAttribute(n.array,n.stride)),0<i.array.length&&d.addAttribute("normal",new TONG.Float32BufferAttribute(i.array,i.stride)),0<o.array.length&&d.addAttribute("color",new TONG.Float32BufferAttribute(o.array,o.stride)),0<s.array.length&&d.addAttribute("uv",new TONG.Float32BufferAttribute(s.array,s.stride)),0<l.length&&d.addAttribute("skinIndex",new TONG.Float32BufferAttribute(l,u)),0<h.length&&d.addAttribute("skinWeight",new TONG.Float32BufferAttribute(h,c)),a.data=d,a.type=e[0].type,a.materialKeys=f,a}function ne(e,t,a,n){var i=e.p,r=e.stride,s=e.vcount;function o(e){for(var t=i[e+a]*u,r=t+u;t<r;t++)n.push(l[t])}var l=t.array,u=t.stride;if(void 0!==e.vcount)for(var h=0,c=0,d=s.length;c<d;c++){var f=s[c];if(4===f){var p=h+1*r,m=h+2*r,g=h+3*r;o(h+0*r),o(p),o(g),o(p),o(m),o(g)}else if(3===f){p=h+1*r,m=h+2*r;o(h+0*r),o(p),o(m)}else if(4<f)for(var v=1,y=f-2;v<=y;v++){p=h+r*v,m=h+r*(v+1);o(h+0*r),o(p),o(m)}h+=r*f}else for(c=0,d=i.length;c<d;c+=r)o(c)}function ie(e){return x(Ve.geometries[e],re)}function se(e){return void 0!==e.build?e.build:e}function oe(e,t){for(var r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"joint":t.joints[a.getAttribute("sid")]=le(a);break;case"link":t.links.push(he(a))}}}function le(e){for(var t,r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"prismatic":case"revolute":t=ue(a)}}return t}function ue(e,t){t={sid:e.getAttribute("sid"),name:e.getAttribute("name")||"",axis:new TONG.Vector3,limits:{min:0,max:0},type:e.nodeName,static:!1,zeroPosition:0,middlePosition:0};for(var r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"axis":var n=v(a.textContent);t.axis.fromArray(n);break;case"limits":var i=a.getElementsByTagName("max")[0],s=a.getElementsByTagName("min")[0];t.limits.max=parseFloat(i.textContent),t.limits.min=parseFloat(s.textContent)}}return t.limits.min>=t.limits.max&&(t.static=!0),t.middlePosition=(t.limits.min+t.limits.max)/2,t}function he(e){for(var t={sid:e.getAttribute("sid"),name:e.getAttribute("name")||"",attachments:[],transforms:[]},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"attachment_full":t.attachments.push(ce(a));break;case"matrix":case"translate":case"rotate":t.transforms.push(de(a))}}return t}function ce(e){for(var t={joint:e.getAttribute("joint").split("/").pop(),transforms:[],links:[]},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"link":t.links.push(he(a));break;case"matrix":case"translate":case"rotate":t.transforms.push(de(a))}}return t}function de(e){var t={type:e.nodeName},r=v(e.textContent);switch(t.type){case"matrix":t.obj=new TONG.Matrix4,t.obj.fromArray(r).transpose();break;case"translate":t.obj=new TONG.Vector3,t.obj.fromArray(r);break;case"rotate":t.obj=new TONG.Vector3,t.obj.fromArray(r),t.angle=TONG.Math.degToRad(r[3])}return t}function fe(e,t){for(var r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"technique_common":pe(a,t)}}}function pe(e,t){for(var r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"inertia":t.inertia=v(a.textContent);break;case"mass":t.mass=v(a.textContent)[0]}}}function me(e){for(var t={target:e.getAttribute("target").split("/").pop()},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"axis":var n=a.getElementsByTagName("param")[0];t.axis=n.textContent;var i=t.axis.split("inst_").pop().split("axis")[0];t.jointIndex=i.substr(0,i.length-1)}}return t}function ge(e){return void 0!==e.build?e.build:e}var ve=new TONG.Matrix4,ye=new TONG.Vector3;function Te(e){for(var t={name:e.getAttribute("name")||"",type:e.getAttribute("type"),id:e.getAttribute("id"),sid:e.getAttribute("sid"),matrix:new TONG.Matrix4,nodes:[],instanceCameras:[],instanceControllers:[],instanceLights:[],instanceGeometries:[],instanceNodes:[],transforms:{}},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"node":t.nodes.push(a.getAttribute("id")),Te(a);break;case"instance_camera":t.instanceCameras.push(u(a.getAttribute("url")));break;case"instance_controller":t.instanceControllers.push(be(a));break;case"instance_light":t.instanceLights.push(u(a.getAttribute("url")));break;case"instance_geometry":t.instanceGeometries.push(be(a));break;case"instance_node":t.instanceNodes.push(u(a.getAttribute("url")));break;case"matrix":var n=v(a.textContent);t.matrix.multiply(ve.fromArray(n).transpose()),t.transforms[a.getAttribute("sid")]=a.nodeName;break;case"translate":n=v(a.textContent);ye.fromArray(n),t.matrix.multiply(ve.makeTranslation(ye.x,ye.y,ye.z)),t.transforms[a.getAttribute("sid")]=a.nodeName;break;case"rotate":n=v(a.textContent);var i=TONG.Math.degToRad(n[3]);t.matrix.multiply(ve.makeRotationAxis(ye.fromArray(n),i)),t.transforms[a.getAttribute("sid")]=a.nodeName;break;case"scale":n=v(a.textContent);t.matrix.scale(ye.fromArray(n)),t.transforms[a.getAttribute("sid")]=a.nodeName;break;case"extra":break;default:console.log(a)}}return Me(t.id)?console.warn("TONG.ColladaLoader: There is already a node with ID %s. Exclude current node from further processing.",t.id):Ve.nodes[t.id]=t,t}function be(e){for(var t={id:u(e.getAttribute("url")),materials:{},skeletons:[]},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];switch(a.nodeName){case"bind_material":for(var n=a.getElementsByTagName("instance_material"),i=0;i<n.length;i++){var s=n[i],o=s.getAttribute("symbol"),l=s.getAttribute("target");t.materials[o]=u(l)}break;case"skeleton":t.skeletons.push(u(a.textContent))}}return t}function _e(e,t){var r,a,n,i=[],s=[];for(r=0;r<e.length;r++){var o=e[r];if(Me(o))Oe(Ge(o),t,i);else if(n=o,void 0!==Ve.visualScenes[n])for(var l=Ve.visualScenes[o].children,u=0;u<l.length;u++){var h=l[u];if("JOINT"===h.type)Oe(Ge(h.id),t,i)}else console.error("TONG.ColladaLoader: Unable to find root bone of skeleton with ID:",o)}for(r=0;r<t.length;r++)for(u=0;u<i.length;u++)if((a=i[u]).bone.name===t[r].name){(s[r]=a).processed=!0;break}for(r=0;r<i.length;r++)!1===(a=i[r]).processed&&(s.push(a),a.processed=!0);var c=[],d=[];for(r=0;r<s.length;r++)a=s[r],c.push(a.bone),d.push(a.boneInverse);return new TONG.Skeleton(c,d)}function Oe(e,n,i){e.traverse(function(e){if(!0===e.isBone){for(var t,r=0;r<n.length;r++){var a=n[r];if(a.name===e.name){t=a.boneInverse;break}}void 0===t&&(t=new TONG.Matrix4),i.push({bone:e,boneInverse:t,processed:!1})}})}function we(e){for(var t,r,a,n,i,s=[],o=e.matrix,l=e.nodes,u=e.type,h=e.instanceCameras,c=e.instanceControllers,d=e.instanceLights,f=e.instanceGeometries,p=e.instanceNodes,m=0,g=l.length;m<g;m++)s.push(Ge(l[m]));for(m=0,g=h.length;m<g;m++){var v=(t=h[m],void 0!==(r=Ve.cameras[t])?x(r,H):(console.warn("TONG.ColladaLoader: Couldn't find camera with ID:",t),null));null!==v&&s.push(v.clone())}for(m=0,g=c.length;m<g;m++)for(var y=c[m],T=(a=y.id,x(Ve.controllers[a],G)),b=xe(ie(T.id),y.materials),_=_e(y.skeletons,T.skin.joints),O=0,w=b.length;O<w;O++){var N;(N=b[O]).isSkinnedMesh&&(N.bind(_,T.skin.bindMatrix),N.normalizeSkinWeights()),s.push(N)}for(m=0,g=d.length;m<g;m++){var A=(n=d[m],void 0!==(i=Ve.lights[n])?x(i,Q):(console.warn("TONG.ColladaLoader: Couldn't find light with ID:",n),null));null!==A&&s.push(A.clone())}for(m=0,g=f.length;m<g;m++)for(O=0,w=(b=xe(ie((y=f[m]).id),y.materials)).length;O<w;O++)s.push(b[O]);for(m=0,g=p.length;m<g;m++)s.push(Ge(p[m]).clone());if(0===l.length&&1===s.length)N=s[0];else{N="JOINT"===u?new TONG.Bone:new TONG.Group;for(m=0;m<s.length;m++)N.add(s[m])}return""===N.name&&(N.name="JOINT"===u?e.sid:e.name),N.matrix.copy(o),N.matrix.decompose(N.position,N.quaternion,N.scale),N}var Ne=new TONG.MeshBasicMaterial({color:16711935});function Ae(e,t){for(var r,a=[],n=0,i=e.length;n<i;n++){var s=t[e[n]];void 0===s?(console.warn("TONG.ColladaLoader: Material with key %s not found. Apply fallback material.",e[n]),a.push(Ne)):a.push((r=s,x(Ve.materials[r],W)))}return a}function xe(e,t){var r=[];for(var a in e){var n=e[a],i=Ae(n.materialKeys,t);0===i.length&&("lines"===a||"linestrips"===a?i.push(new TONG.LineBasicMaterial):i.push(new TONG.MeshPhongMaterial));var s=void 0!==n.data.attributes.skinIndex;if(s)for(var o=0,l=i.length;o<l;o++)i[o].skinning=!0;var u,h=1===i.length?i[0]:i;switch(a){case"lines":u=new TONG.LineSegments(n.data,h);break;case"linestrips":u=new TONG.Line(n.data,h);break;case"triangles":case"polylist":u=s?new TONG.SkinnedMesh(n.data,h):new TONG.Mesh(n.data,h)}r.push(u)}return r}function Me(e){return void 0!==Ve.nodes[e]}function Ge(e){return x(Ve.nodes[e],we)}function ke(e){var t=new TONG.Group;t.name=e.name;for(var r=e.children,a=0;a<r.length;a++){var n=r[a];t.add(Ge(n.id))}return t}function Le(e){return x(Ve.visualScenes[e],ke)}if(0===e.length)return{scene:new TONG.Scene};var Se=o((new DOMParser).parseFromString(e,"application/xml"),"COLLADA")[0],Ce=Se.getAttribute("version");console.log("TONG.ColladaLoader: File version",Ce);var Fe,Ie,Be,Ee,Re=(Fe=o(Se,"asset")[0],{unit:(Be=o(Fe,"unit")[0],void 0!==Be&&!0===Be.hasAttribute("meter")?parseFloat(Be.getAttribute("meter")):1),upAxis:(Ie=o(Fe,"up_axis")[0],void 0!==Ie?Ie.textContent:"Y_UP")}),De=new TONG.TextureLoader(this.manager);De.setPath(t).setCrossOrigin(this.crossOrigin),TONG.TGALoader&&(Ee=new TONG.TGALoader(this.manager)).setPath(t);var Pe=[],Ue={},ze=0,Ve={animations:{},clips:{},controllers:{},images:{},effects:{},materials:{},cameras:{},lights:{},geometries:{},nodes:{},visualScenes:{},kinematicsModels:{},physicsModels:{},kinematicsScenes:{}};r(Se,"library_animations","animation",function(e){for(var t={sources:{},samplers:{},channels:{}},r=0,a=e.childNodes.length;r<a;r++){var n,i=e.childNodes[r];if(1===i.nodeType)switch(i.nodeName){case"source":n=i.getAttribute("id"),t.sources[n]=J(i);break;case"sampler":n=i.getAttribute("id"),t.samplers[n]=s(i);break;case"channel":n=i.getAttribute("target"),t.channels[n]=h(i);break;default:console.log(i)}}Ve.animations[e.getAttribute("id")]=t}),r(Se,"library_animation_clips","animation_clip",function(e){for(var t={name:e.getAttribute("id")||"default",start:parseFloat(e.getAttribute("start")||0),end:parseFloat(e.getAttribute("end")||0),animations:[]},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"instance_animation":t.animations.push(u(n.getAttribute("url")))}}Ve.clips[e.getAttribute("id")]=t}),r(Se,"library_controllers","controller",function(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"skin":t.id=u(n.getAttribute("source")),t.skin=N(n);break;case"morph":t.id=u(n.getAttribute("source")),console.warn("TONG.ColladaLoader: Morph target animation not supported yet.")}}Ve.controllers[e.getAttribute("id")]=t}),r(Se,"library_images","image",function(e){var t={init_from:o(e,"init_from")[0].textContent};Ve.images[e.getAttribute("id")]=t}),r(Se,"library_effects","effect",function(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"profile_COMMON":t.profile=S(n)}}Ve.effects[e.getAttribute("id")]=t}),r(Se,"library_materials","material",function(e){for(var t={name:e.getAttribute("name")},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"instance_effect":t.url=u(n.getAttribute("url"))}}Ve.materials[e.getAttribute("id")]=t}),r(Se,"library_cameras","camera",function(e){for(var t={name:e.getAttribute("name")},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"optics":t.optics=Z(n)}}Ve.cameras[e.getAttribute("id")]=t}),r(Se,"library_lights","light",function(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"technique_common":t=q(n)}}Ve.lights[e.getAttribute("id")]=t}),r(Se,"library_geometries","geometry",function(e){var t={name:e.getAttribute("name"),sources:{},vertices:{},primitives:[]},r=o(e,"mesh")[0];if(void 0!==r){for(var a=0;a<r.childNodes.length;a++){var n=r.childNodes[a];if(1===n.nodeType){var i=n.getAttribute("id");switch(n.nodeName){case"source":t.sources[i]=J(n);break;case"vertices":t.vertices=$(n);break;case"polygons":console.warn("TONG.ColladaLoader: Unsupported primitive type: ",n.nodeName);break;case"lines":case"linestrips":case"polylist":case"triangles":t.primitives.push(ee(n));break;default:console.log(n)}}}Ve.geometries[e.getAttribute("id")]=t}}),r(Se,"library_nodes","node",Te),r(Se,"library_visual_scenes","visual_scene",function(e){var t={name:e.getAttribute("name"),children:[]};!function(e){for(var t=e.getElementsByTagName("node"),r=0;r<t.length;r++){var a=t[r];!1===a.hasAttribute("id")&&a.setAttribute("id","TONG_default_"+ze++)}}(e);for(var r=o(e,"node"),a=0;a<r.length;a++)t.children.push(Te(r[a]));Ve.visualScenes[e.getAttribute("id")]=t}),r(Se,"library_kinematics_models","kinematics_model",function(e){for(var t={name:e.getAttribute("name")||"",joints:{},links:[]},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"technique_common":oe(a,t)}}Ve.kinematicsModels[e.getAttribute("id")]=t}),r(Se,"library_physics_models","physics_model",function(e){for(var t={name:e.getAttribute("name")||"",rigidBodies:{}},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"rigid_body":t.rigidBodies[a.getAttribute("name")]={},fe(a,t.rigidBodies[a.getAttribute("name")])}}Ve.physicsModels[e.getAttribute("id")]=t}),r(Se,"scene","instance_kinematics_scene",function(e){for(var t={bindJointAxis:[]},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"bind_joint_axis":t.bindJointAxis.push(me(a))}}Ve.kinematicsScenes[u(e.getAttribute("url"))]=t}),a(Ve.animations,n),a(Ve.clips,w),a(Ve.controllers,G),a(Ve.images,k),a(Ve.effects,j),a(Ve.materials,W),a(Ve.cameras,H),a(Ve.lights,Q),a(Ve.geometries,re),a(Ve.visualScenes,ke),function(){var e,t=Ve.clips;if(!0===f(t)){if(!1===f(Ve.animations)){var r=[];for(var a in Ve.animations)for(var n=c(a),i=0,s=n.length;i<s;i++)r.push(n[i]);Pe.push(new TONG.AnimationClip("default",-1,r))}}else for(var a in t)Pe.push((e=a,x(Ve.clips[e],w)))}(),function(){var e=Object.keys(Ve.kinematicsModels)[0],t=Object.keys(Ve.kinematicsScenes)[0],r=Object.keys(Ve.visualScenes)[0];if(void 0!==e&&void 0!==t){for(var a,n,i=(a=e,x(Ve.kinematicsModels[a],se)),s=(n=t,x(Ve.kinematicsScenes[n],ge)),o=Le(r),l=s.bindJointAxis,u={},h=0,c=l.length;h<c;h++){var d=l[h],f=Se.querySelector('[sid="'+d.target+'"]');if(f){var p=f.parentElement;g(d.jointIndex,p)}}var m=new TONG.Matrix4;Ue={joints:i&&i.joints,getJointValue:function(e){var t=u[e];if(t)return t.position;console.warn("TONG.ColladaLoader: Joint "+e+" doesn't exist.")},setJointValue:function(e,t){var r=u[e];if(r){var a=r.joint;if(t>a.limits.max||t<a.limits.min)console.warn("TONG.ColladaLoader: Joint "+e+" value "+t+" outside of limits (min: "+a.limits.min+", max: "+a.limits.max+").");else if(a.static)console.warn("TONG.ColladaLoader: Joint "+e+" is static.");else{var n=r.object,i=a.axis,s=r.transforms;ve.identity();for(var o=0;o<s.length;o++){var l=s[o];if(l.sid&&-1!==l.sid.indexOf(e))switch(a.type){case"revolute":ve.multiply(m.makeRotationAxis(i,TONG.Math.degToRad(t)));break;case"prismatic":ve.multiply(m.makeTranslation(i.x*t,i.y*t,i.z*t));break;default:console.warn("TONG.ColladaLoader: Unknown joint type: "+a.type)}else switch(l.type){case"matrix":ve.multiply(l.obj);break;case"translate":ve.multiply(m.makeTranslation(l.obj.x,l.obj.y,l.obj.z));break;case"scale":ve.scale(l.obj);break;case"rotate":ve.multiply(m.makeRotationAxis(l.obj,l.angle))}}n.matrix.copy(ve),n.matrix.decompose(n.position,n.quaternion,n.scale),u[e].position=t}}else console.log("TONG.ColladaLoader: "+e+" does not exist.")}}}function g(t,r){var a=r.getAttribute("name"),n=i.joints[t];o.traverse(function(e){e.name===a&&(u[t]={object:e,transforms:function(e){for(var t=[],r=Se.querySelector('[id="'+e.id+'"]'),a=0;a<r.childNodes.length;a++){var n=r.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"matrix":var i=v(n.textContent),s=(new TONG.Matrix4).fromArray(i).transpose();t.push({sid:n.getAttribute("sid"),type:n.nodeName,obj:s});break;case"translate":case"scale":var i=v(n.textContent),o=(new TONG.Vector3).fromArray(i);t.push({sid:n.getAttribute("sid"),type:n.nodeName,obj:o});break;case"rotate":var i=v(n.textContent),o=(new TONG.Vector3).fromArray(i),l=TONG.Math.degToRad(i[3]);t.push({sid:n.getAttribute("sid"),type:n.nodeName,obj:o,angle:l})}}return t}(r),joint:n,position:n.zeroPosition})})}}();var je=Le(u(o(o(Se,"scene")[0],"instance_visual_scene")[0].getAttribute("url")));return"Z_UP"===Re.upAxis&&je.quaternion.setFromEuler(new TONG.Euler(-Math.PI/2,0,0)),je.scale.multiplyScalar(Re.unit),{animations:Pe,kinematics:Ue,library:Ve,scene:je}}},TONG.DDSLoader=function(e){TONG.CompressedTextureLoader.call(this,e),this._parser=TONG.DDSLoader.parse},TONG.DDSLoader.prototype=Object.create(TONG.CompressedTextureLoader.prototype),TONG.DDSLoader.prototype.constructor=TONG.DDSLoader,TONG.DDSLoader.parse=function(e,t){var r={mipmaps:[],width:0,height:0,format:null,mipmapCount:1};function a(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function n(e,t,r,a){for(var n=r*a*4,i=new Uint8Array(e,t,n),s=new Uint8Array(n),o=0,l=0,u=0;u<a;u++)for(var h=0;h<r;h++){var c=i[l],d=i[++l],f=i[++l],p=i[++l];l++,s[o]=f,s[++o]=d,s[++o]=c,s[++o]=p,o++}return s}var i,s=a("DXT1"),o=a("DXT3"),l=a("DXT5"),u=a("ETC1"),h=new Int32Array(e,0,31);if(542327876!==h[0])return console.error("TONG.DDSLoader.parse: Invalid magic number in DDS header."),r;if(4&!h[20])return console.error("TONG.DDSLoader.parse: Unsupported format, must contain a FourCC code."),r;var c,d=h[21],f=!1;switch(d){case s:i=8,r.format=TONG.RGB_S3TC_DXT1_Format;break;case o:i=16,r.format=TONG.RGBA_S3TC_DXT3_Format;break;case l:i=16,r.format=TONG.RGBA_S3TC_DXT5_Format;break;case u:i=8,r.format=TONG.RGB_ETC1_Format;break;default:if(!(32===h[22]&&16711680&h[23]&&65280&h[24]&&255&h[25]&&4278190080&h[26]))return console.error("TONG.DDSLoader.parse: Unsupported FourCC code ",(c=d,String.fromCharCode(255&c,c>>8&255,c>>16&255,c>>24&255))),r;f=!0,i=64,r.format=TONG.RGBAFormat}r.mipmapCount=1,131072&h[2]&&!1!==t&&(r.mipmapCount=Math.max(1,h[7]));var p=h[28];if(r.isCubemap=!!(512&p),r.isCubemap&&(!(1024&p)||!(2048&p)||!(4096&p)||!(8192&p)||!(16384&p)||!(32768&p)))return console.error("TONG.DDSLoader.parse: Incomplete cubemap faces"),r;r.width=h[4],r.height=h[3];for(var m=h[1]+4,g=r.isCubemap?6:1,v=0;v<g;v++)for(var y=r.width,T=r.height,b=0;b<r.mipmapCount;b++){if(f)var _=(O=n(e,m,y,T)).length;else{_=Math.max(4,y)/4*Math.max(4,T)/4*i;var O=new Uint8Array(e,m,_)}var w={data:O,width:y,height:T};r.mipmaps.push(w),m+=_,y=Math.max(y>>1,1),T=Math.max(T>>1,1)}return r},function(){function b(e){var t,r=e.Content,a=e.RelativeFilename||e.Filename,n=a.slice(a.lastIndexOf(".")+1).toLowerCase();switch(n){case"bmp":t="image/bmp";break;case"jpg":case"jpeg":t="image/jpeg";break;case"png":t="image/png";break;case"tif":t="image/tiff";break;case"tga":if("function"!=typeof TONG.TGALoader)return void console.warn("FBXLoader: TONG.TGALoader is required to load TGA textures");null===TONG.Loader.Handlers.get(".tga")&&TONG.Loader.Handlers.add(/\.tga$/i,new TONG.TGALoader),t="image/tga";break;default:return void console.warn('FBXLoader: Image type "'+n+'" is not supported.')}if("string"==typeof r)return"data:"+t+";base64,"+r;var i=new Uint8Array(r);return window.URL.createObjectURL(new Blob([i],{type:t}))}function _(e,t,r,a){var n=function(e,t,r,a){var n,i,s=t.path,o=a.get(e.id).children;void 0!==o&&0<o.length&&void 0!==r[o[0].ID]&&(0!==(n=r[o[0].ID]).indexOf("blob:")&&0!==n.indexOf("data:")||t.setPath(void 0));i="tga"===e.FileName.slice(-3).toLowerCase()?TONG.Loader.Handlers.get(".tga").load(n):t.load(n);return t.setPath(s),i}(e,t,r,a);n.ID=e.id,n.name=e.attrName;var i=e.WrapModeU,s=e.WrapModeV,o=void 0!==i?i.value:0,l=void 0!==s?s.value:0;if(n.wrapS=0===o?TONG.RepeatWrapping:TONG.ClampToEdgeWrapping,n.wrapT=0===l?TONG.RepeatWrapping:TONG.ClampToEdgeWrapping,"Scaling"in e){var u=e.Scaling.value;n.repeat.x=u[0],n.repeat.y=u[1]}return n}function O(e,t,r,a){var n=t.id,i=t.attrName,s=t.ShadingModel;if("object"==typeof s&&(s=s.value),!a.has(n))return null;var o,l=function(r,e,a,t,n){var i={};e.BumpFactor&&(i.bumpScale=e.BumpFactor.value);e.Diffuse?i.color=(new TONG.Color).fromArray(e.Diffuse.value):e.DiffuseColor&&"Color"===e.DiffuseColor.type&&(i.color=(new TONG.Color).fromArray(e.DiffuseColor.value));e.DisplacementFactor&&(i.displacementScale=e.DisplacementFactor.value);e.Emissive?i.emissive=(new TONG.Color).fromArray(e.Emissive.value):e.EmissiveColor&&"Color"===e.EmissiveColor.type&&(i.emissive=(new TONG.Color).fromArray(e.EmissiveColor.value));e.EmissiveFactor&&(i.emissiveIntensity=parseFloat(e.EmissiveFactor.value));e.Opacity&&(i.opacity=parseFloat(e.Opacity.value));i.opacity<1&&(i.transparent=!0);e.ReflectionFactor&&(i.reflectivity=e.ReflectionFactor.value);e.Shininess&&(i.shininess=e.Shininess.value);e.Specular?i.specular=(new TONG.Color).fromArray(e.Specular.value):e.SpecularColor&&"Color"===e.SpecularColor.type&&(i.specular=(new TONG.Color).fromArray(e.SpecularColor.value));return n.get(t).children.forEach(function(e){var t=e.relationship;switch(t){case"Bump":i.bumpMap=a.get(e.ID);break;case"DiffuseColor":i.map=u(r,a,e.ID,n);break;case"DisplacementColor":i.displacementMap=u(r,a,e.ID,n);break;case"EmissiveColor":i.emissiveMap=u(r,a,e.ID,n);break;case"NormalMap":i.normalMap=u(r,a,e.ID,n);break;case"ReflectionColor":i.envMap=u(r,a,e.ID,n),i.envMap.mapping=TONG.EquirectangularReflectionMapping;break;case"SpecularColor":i.specularMap=u(r,a,e.ID,n);break;case"TransparentColor":i.alphaMap=u(r,a,e.ID,n),i.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("TONG.FBXLoader: %s map is not supported in TONG.js, skipping texture.",t)}}),i}(e,t,r,n,a);switch(s.toLowerCase()){case"phong":o=new TONG.MeshPhongMaterial;break;case"lambert":o=new TONG.MeshLambertMaterial;break;default:console.warn('TONG.FBXLoader: unknown material type "%s". Defaulting to MeshStandardMaterial.',s),o=new TONG.MeshStandardMaterial({color:3342591})}return o.setValues(l),o.name=i,o.needsUpdate=!0,o}function u(e,t,r,a){return"LayeredTexture"in e.Objects&&r in e.Objects.LayeredTexture&&(console.warn("TONG.FBXLoader: layered textures are not supported in TONG.js. Discarding all but first layer."),r=a.get(r).children[0].ID),t.get(r)}function w(e,a){var n=[];return e.children.forEach(function(e){var t=a[e.ID];if("Cluster"===t.attrType){var r={ID:e.ID,indices:[],weights:[],transform:(new TONG.Matrix4).fromArray(t.Transform.a),transformLink:(new TONG.Matrix4).fromArray(t.TransformLink.a),linkMode:t.Mode};"Indexes"in t&&(r.indices=t.Indexes.a,r.weights=t.Weights.a),n.push(r)}}),{rawBones:n,bones:[]}}function N(e,t,r){for(var a=[],n=0;n<e.children.length;n++){if(8===n){console.warn("FBXLoader: maximum of 8 morph targets supported. Ignoring additional targets.");break}var i=e.children[n],s=t[i.ID],o={name:s.attrName,initialWeight:s.DeformPercent,id:s.id,fullWeights:s.FullWeights.a};if("BlendShapeChannel"!==s.attrType)return;r.get(parseInt(i.ID)).children.forEach(function(e){void 0===e.relationship&&(o.geoID=e.ID)}),a.push(o)}return a}function A(e,t,r,a){switch(r.attrType){case"Mesh":return function(t,e,r,a){var n=a.skeletons,i=a.morphTargets,s=e.parents.map(function(e){return t.Objects.Model[e.ID]});if(0===s.length)return;var o=e.children.reduce(function(e,t){return void 0!==n[t.ID]&&(e=n[t.ID]),e},null),l=e.children.reduce(function(e,t){return void 0!==i[t.ID]&&(e=i[t.ID]),e},null),u=new TONG.Matrix4,h=s[0];if("GeometricRotation"in h){var c=h.GeometricRotation.value.map(TONG.Math.degToRad);c[3]="ZYX",u.makeRotationFromEuler((new TONG.Euler).fromArray(c))}"GeometricTranslation"in h&&u.setPosition((new TONG.Vector3).fromArray(h.GeometricTranslation.value));"GeometricScaling"in h&&u.scale((new TONG.Vector3).fromArray(h.GeometricScaling.value));return function(e,t,r,a,n){var i=new TONG.BufferGeometry;t.attrName&&(i.name=t.attrName);var s=function(e,t){var n={};n.vertexPositions=void 0!==e.Vertices?e.Vertices.a:[],n.vertexIndices=void 0!==e.PolygonVertexIndex?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(n.color=function(e){var t=e.MappingInformationType,r=e.ReferenceInformationType,a=e.Colors.a,n=[];"IndexToDirect"===r&&(n=e.ColorIndex.a);return{dataSize:4,buffer:a,indices:n,mappingType:t,referenceType:r}}(e.LayerElementColor[0]));e.LayerElementMaterial&&(n.material=function(e){var t=e.MappingInformationType,r=e.ReferenceInformationType;if("NoMappingInformation"===t)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:r};for(var a=e.Materials.a,n=[],i=0;i<a.length;++i)n.push(i);return{dataSize:1,buffer:a,indices:n,mappingType:t,referenceType:r}}(e.LayerElementMaterial[0]));e.LayerElementNormal&&(n.normal=function(e){var t=e.MappingInformationType,r=e.ReferenceInformationType,a=e.Normals.a,n=[];"IndexToDirect"===r&&("NormalIndex"in e?n=e.NormalIndex.a:"NormalsIndex"in e&&(n=e.NormalsIndex.a));return{dataSize:3,buffer:a,indices:n,mappingType:t,referenceType:r}}(e.LayerElementNormal[0]));if(e.LayerElementUV){n.uv=[];for(var r=0;e.LayerElementUV[r];)n.uv.push(M(e.LayerElementUV[r])),r++}n.weightTable={},null!==t&&(n.skeleton=t).rawBones.forEach(function(r,a){r.indices.forEach(function(e,t){void 0===n.weightTable[e]&&(n.weightTable[e]=[]),n.weightTable[e].push({id:a,weight:r.weights[t]})})});return n}(t,r),o=x(s),l=new TONG.Float32BufferAttribute(o.vertex,3);n.applyToBufferAttribute(l),i.addAttribute("position",l),0<o.colors.length&&i.addAttribute("color",new TONG.Float32BufferAttribute(o.colors,3));r&&(i.addAttribute("skinIndex",new TONG.Uint16BufferAttribute(o.weightsIndices,4)),i.addAttribute("skinWeight",new TONG.Float32BufferAttribute(o.vertexWeights,4)),i.FBX_Deformer=r);if(0<o.normal.length){var u=new TONG.Float32BufferAttribute(o.normal,3),h=(new TONG.Matrix3).getNormalMatrix(n);h.applyToBufferAttribute(u),i.addAttribute("normal",u)}if(o.uvs.forEach(function(e,t){var r="uv"+(t+1).toString();0===t&&(r="uv"),i.addAttribute(r,new TONG.Float32BufferAttribute(o.uvs[t],2))}),s.material&&"AllSame"!==s.material.mappingType){var c=o.materialIndex[0],d=0;if(o.materialIndex.forEach(function(e,t){e!==c&&(i.addGroup(d,t-d,c),c=e,d=t)}),0<i.groups.length){var f=i.groups[i.groups.length-1],p=f.start+f.count;p!==o.materialIndex.length&&i.addGroup(p,o.materialIndex.length-p,c)}0===i.groups.length&&i.addGroup(0,o.materialIndex.length,o.materialIndex[0])}return m=e,g=i,v=t,y=a,T=n,null!==y&&(g.morphAttributes.position=[],g.morphAttributes.normal=[],y.rawTargets.forEach(function(e){var t=m.Objects.Geometry[e.geoID];void 0!==t&&function(e,t,r,a){var n=new TONG.BufferGeometry;r.attrName&&(n.name=r.attrName);for(var i=void 0!==t.PolygonVertexIndex?t.PolygonVertexIndex.a:[],s=void 0!==t.Vertices?t.Vertices.a.slice():[],o=void 0!==r.Vertices?r.Vertices.a:[],l=void 0!==r.Indexes?r.Indexes.a:[],u=0;u<l.length;u++){var h=3*l[u];s[h]+=o[3*u],s[h+1]+=o[3*u+1],s[h+2]+=o[3*u+2]}var c=x({vertexIndices:i,vertexPositions:s}),d=new TONG.Float32BufferAttribute(c.vertex,3);d.name=r.attrName,a.applyToBufferAttribute(d),e.morphAttributes.position.push(d)}(g,v,t,T)})),i;var m,g,v,y,T}(t,r,o,l,u)}(e,t,r,a);case"NurbsCurve":return function(e){if(void 0===TONG.NURBSCurve)return console.error("TONG.FBXLoader: The loader relies on TONG.NURBSCurve for any nurbs present in the model. Nurbs will show up as empty geometry."),new TONG.BufferGeometry;var t=parseInt(e.Order);if(isNaN(t))return console.error("TONG.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new TONG.BufferGeometry;for(var r,a,n=t-1,i=e.KnotVector.a,s=[],o=e.Points.a,l=0,u=o.length;l<u;l+=4)s.push((new TONG.Vector4).fromArray(o,l));if("Closed"===e.Form)s.push(s[0]);else if("Periodic"===e.Form){r=n,a=i.length-1-r;for(var l=0;l<n;++l)s.push(s[l])}var h=new TONG.NURBSCurve(n,i,s,r,a).getPoints(7*s.length),c=new Float32Array(3*h.length);h.forEach(function(e,t){e.toArray(c,3*t)});var d=new TONG.BufferGeometry;return d.addAttribute("position",new TONG.BufferAttribute(c,3)),d}(r)}}function x(h){var c={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]},d=0,f=0,p=!1,m=[],g=[],v=[],y=[],T=[],b=[];return h.vertexIndices.forEach(function(a,n){var e=!1;a<0&&(a^=-1,e=!0);var r=[],t=[];if(m.push(3*a,3*a+1,3*a+2),h.color){var i=G(n,d,a,h.color);v.push(i[0],i[1],i[2])}if(h.skeleton){if(void 0!==h.weightTable[a]&&h.weightTable[a].forEach(function(e){t.push(e.weight),r.push(e.id)}),4<t.length){p||(console.warn("TONG.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),p=!0);var s=[0,0,0,0],o=[0,0,0,0];t.forEach(function(e,t){var n=e,i=r[t];o.forEach(function(e,t,r){if(e<n){r[t]=n,n=e;var a=s[t];s[t]=i,i=a}})}),r=s,t=o}for(;t.length<4;)t.push(0),r.push(0);for(var l=0;l<4;++l)T.push(t[l]),b.push(r[l])}if(h.normal){i=G(n,d,a,h.normal);g.push(i[0],i[1],i[2])}if(h.material&&"AllSame"!==h.material.mappingType)var u=G(n,d,a,h.material)[0];h.uv&&h.uv.forEach(function(e,t){var r=G(n,d,a,e);void 0===y[t]&&(y[t]=[]),y[t].push(r[0]),y[t].push(r[1])}),f++,e&&(!function(r,e,t,a,n,i,s,o,l,u){for(var h=2;h<u;h++)r.vertex.push(e.vertexPositions[t[0]]),r.vertex.push(e.vertexPositions[t[1]]),r.vertex.push(e.vertexPositions[t[2]]),r.vertex.push(e.vertexPositions[t[3*(h-1)]]),r.vertex.push(e.vertexPositions[t[3*(h-1)+1]]),r.vertex.push(e.vertexPositions[t[3*(h-1)+2]]),r.vertex.push(e.vertexPositions[t[3*h]]),r.vertex.push(e.vertexPositions[t[3*h+1]]),r.vertex.push(e.vertexPositions[t[3*h+2]]),e.skeleton&&(r.vertexWeights.push(o[0]),r.vertexWeights.push(o[1]),r.vertexWeights.push(o[2]),r.vertexWeights.push(o[3]),r.vertexWeights.push(o[4*(h-1)]),r.vertexWeights.push(o[4*(h-1)+1]),r.vertexWeights.push(o[4*(h-1)+2]),r.vertexWeights.push(o[4*(h-1)+3]),r.vertexWeights.push(o[4*h]),r.vertexWeights.push(o[4*h+1]),r.vertexWeights.push(o[4*h+2]),r.vertexWeights.push(o[4*h+3]),r.weightsIndices.push(l[0]),r.weightsIndices.push(l[1]),r.weightsIndices.push(l[2]),r.weightsIndices.push(l[3]),r.weightsIndices.push(l[4*(h-1)]),r.weightsIndices.push(l[4*(h-1)+1]),r.weightsIndices.push(l[4*(h-1)+2]),r.weightsIndices.push(l[4*(h-1)+3]),r.weightsIndices.push(l[4*h]),r.weightsIndices.push(l[4*h+1]),r.weightsIndices.push(l[4*h+2]),r.weightsIndices.push(l[4*h+3])),e.color&&(r.colors.push(i[0]),r.colors.push(i[1]),r.colors.push(i[2]),r.colors.push(i[3*(h-1)]),r.colors.push(i[3*(h-1)+1]),r.colors.push(i[3*(h-1)+2]),r.colors.push(i[3*h]),r.colors.push(i[3*h+1]),r.colors.push(i[3*h+2])),e.material&&"AllSame"!==e.material.mappingType&&(r.materialIndex.push(a),r.materialIndex.push(a),r.materialIndex.push(a)),e.normal&&(r.normal.push(n[0]),r.normal.push(n[1]),r.normal.push(n[2]),r.normal.push(n[3*(h-1)]),r.normal.push(n[3*(h-1)+1]),r.normal.push(n[3*(h-1)+2]),r.normal.push(n[3*h]),r.normal.push(n[3*h+1]),r.normal.push(n[3*h+2])),e.uv&&e.uv.forEach(function(e,t){void 0===r.uvs[t]&&(r.uvs[t]=[]),r.uvs[t].push(s[t][0]),r.uvs[t].push(s[t][1]),r.uvs[t].push(s[t][2*(h-1)]),r.uvs[t].push(s[t][2*(h-1)+1]),r.uvs[t].push(s[t][2*h]),r.uvs[t].push(s[t][2*h+1])})}(c,h,m,u,g,v,y,T,b,f),d++,f=0,m=[],g=[],v=[],y=[],T=[],b=[])}),c}function M(e){var t=e.MappingInformationType,r=e.ReferenceInformationType,a=e.UV.a,n=[];return"IndexToDirect"===r&&(n=e.UVIndex.a),{dataSize:2,buffer:a,indices:n,mappingType:t,referenceType:r}}TONG.FBXLoader=function(e){this.manager=void 0!==e?e:TONG.DefaultLoadingManager},Object.assign(TONG.FBXLoader.prototype,{crossOrigin:"anonymous",load:function(r,a,e,n){var i=this,s=TONG.LoaderUtils.extractUrlBase(r),t=new TONG.FileLoader(this.manager);t.setResponseType("arraybuffer"),t.load(r,function(e){try{var t=i.parse(e,s);a(t)}catch(e){setTimeout(function(){n&&n(e),i.manager.itemError(r)},0)}},e,n)},setCrossOrigin:function(e){return this.crossOrigin=e,this},parse:function(e,t){var r,a,n;if(n="Kaydara FBX Binary  \0",(a=e).byteLength>=n.length&&n===U(a,0,n.length))r=(new R).parse(e);else{var i=U(e);if(!function(r){var e=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"],a=0;function t(e){var t=r[e-1];return r=r.slice(a+e),a++,t}for(var n=0;n<e.length;++n){var i=t(1);if(i===e[n])return!1}return!0}(i))throw new Error("TONG.FBXLoader: Unknown format.");if(D(i)<7e3)throw new Error("TONG.FBXLoader: FBX version not supported, FileVersion: "+D(i));r=(new E).parse(i)}var s,o,l,u,h,c,d,f,p,m=new TONG.TextureLoader(this.manager).setPath(t).setCrossOrigin(this.crossOrigin),g=function(e){var s=new Map;if("Connections"in e){var t=e.Connections.connections;t.forEach(function(e){var t=e[0],r=e[1],a=e[2];s.has(t)||s.set(t,{parents:[],children:[]});var n={ID:r,relationship:a};s.get(t).parents.push(n),s.has(r)||s.set(r,{parents:[],children:[]});var i={ID:t,relationship:a};s.get(r).children.push(i)})}return s}(r),v=function(e,t,r){var a=new Map;if("Material"in e.Objects){var n=e.Objects.Material;for(var i in n){var s=O(e,n[i],t,r);null!==s&&a.set(parseInt(i),s)}}return a}(r,function(e,t,r,a){var n=new Map;if("Texture"in e.Objects){var i=e.Objects.Texture;for(var s in i){var o=_(i[s],t,r,a);n.set(parseInt(s),o)}}return n}(r,m,function(e){var t={},r={};if("Video"in e.Objects){var a=e.Objects.Video;for(var n in a){var i=a[n],s=parseInt(n);if(t[s]=i.RelativeFilename||i.Filename,"Content"in i){var o=i.Content instanceof ArrayBuffer&&0<i.Content.byteLength,l="string"==typeof i.Content&&""!==i.Content;if(o||l){var u=b(a[n]);r[i.RelativeFilename||i.Filename]=u}}}}for(var s in t){var h=t[s];void 0!==r[h]?t[s]=r[h]:t[s]=t[s].split("\\").pop()}return t}(r),g),g),y=function(e,t){var r={},a={};if("Deformer"in e.Objects){var n=e.Objects.Deformer;for(var i in n){var s=n[i],o=t.get(parseInt(i));if("Skin"===s.attrType){var l=w(o,n);l.ID=i,1<o.parents.length&&console.warn("TONG.FBXLoader: skeleton attached to more than one geometry is not supported."),l.geometryID=o.parents[0].ID,r[i]=l}else if("BlendShape"===s.attrType){var u={id:i};u.rawTargets=N(o,n,t),u.id=i,1<o.parents.length&&console.warn("TONG.FBXLoader: morph target attached to more than one geometry is not supported."),a[i]=u}}}return{skeletons:r,morphTargets:a}}(r,g),T=function(e,t,r){var a=new Map;if("Geometry"in e.Objects){var n=e.Objects.Geometry;for(var i in n){var s=t.get(parseInt(i)),o=A(e,s,n[i],r);a.set(parseInt(i),o)}}return a}(r,g,y);return s=r,o=g,l=y,u=T,h=v,c=new TONG.Group,d=function(e,t,r,a,n){var i=new Map,s=e.Objects.Model;for(var o in s){var l=parseInt(o),u=s[o],h=n.get(l),c=k(h,t,l,u.attrName);if(!c){switch(u.attrType){case"Camera":c=L(e,h);break;case"Light":c=S(e,h);break;case"Mesh":c=C(e,h,r,a);break;case"NurbsCurve":c=F(h,r);break;case"LimbNode":case"Null":default:c=new TONG.Group}c.name=TONG.PropertyBinding.sanitizeNodeName(u.attrName),c.ID=l}I(e,c,u),i.set(l,c)}return i}(s,l.skeletons,u,h,o),f=s.Objects.Model,d.forEach(function(r){var e=f[r.ID];!function(a,n,e,t,i){if("LookAtProperty"in e){var r=t.get(n.ID).children;r.forEach(function(e){if("LookAtProperty"===e.relationship){var t=a.Objects.Model[e.ID];if("Lcl_Translation"in t){var r=t.Lcl_Translation.value;void 0!==n.target?(n.target.position.fromArray(r),i.add(n.target)):n.lookAt((new TONG.Vector3).fromArray(r))}}})}}(s,r,e,o,c),o.get(r.ID).parents.forEach(function(e){var t=d.get(e.ID);void 0!==t&&t.add(r)}),null===r.parent&&c.add(r)}),function(e,t,a,n,i){var s=function(e){var t={};if("Pose"in e.Objects){var r=e.Objects.Pose;for(var a in r)if("BindPose"===r[a].attrType){var n=r[a].PoseNode;Array.isArray(n)?n.forEach(function(e){t[e.Node]=(new TONG.Matrix4).fromArray(e.Matrix.a)}):t[n.Node]=(new TONG.Matrix4).fromArray(n.Matrix.a)}}return t}(e);for(var r in t){var o=t[r],l=i.get(parseInt(o.ID)).parents;l.forEach(function(e){if(a.has(e.ID)){var t=e.ID,r=i.get(t);r.parents.forEach(function(e){if(n.has(e.ID)){var t=n.get(e.ID);t.bind(new TONG.Skeleton(o.bones),s[e.ID])}})}})}}(s,l.skeletons,u,d,o),function(e,t,r){r.animations=[];var a=function(e,t){if(void 0!==e.Objects.AnimationCurve){var r=function(e){var t=e.Objects.AnimationCurveNode,r=new Map;for(var a in t){var n=t[a];if(null!==n.attrName.match(/S|R|T|DeformPercent/)){var i={id:n.id,attr:n.attrName,curves:{}};r.set(i.id,i)}}return r}(e);!function(e,t,r){var a=e.Objects.AnimationCurve;for(var n in a){var i={id:a[n].id,times:a[n].KeyTime.a.map(P),values:a[n].KeyValueFloat.a},s=t.get(i.id);if(void 0!==s){var o=s.parents[0].ID,l=s.parents[0].relationship;l.match(/X/)?r.get(o).curves.x=i:l.match(/Y/)?r.get(o).curves.y=i:l.match(/Z/)?r.get(o).curves.z=i:l.match(/d|DeformPercent/)&&(r.get(o).curves.morph=i)}}}(e,t,r);var a=function(u,h,c){var e=u.Objects.AnimationLayer,t=new Map;for(var r in e){var d=[],a=h.get(parseInt(r));if(void 0!==a){var n=a.children;n.forEach(function(e,t){if(c.has(e.ID)){var r=c.get(e.ID);if(void 0!==r.curves.x||void 0!==r.curves.y||void 0!==r.curves.z){if(void 0===d[t]){h.get(e.ID).parents.forEach(function(e){void 0!==e.relationship&&(l=e.ID)});var a=u.Objects.Model[l.toString()],n={modelName:TONG.PropertyBinding.sanitizeNodeName(a.attrName),initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};"Lcl_Translation"in a&&(n.initialPosition=a.Lcl_Translation.value),"Lcl_Rotation"in a&&(n.initialRotation=a.Lcl_Rotation.value),"Lcl_Scaling"in a&&(n.initialScale=a.Lcl_Scaling.value),"PreRotation"in a&&(n.preRotations=a.PreRotation.value),d[t]=n}d[t][r.attr]=r}else if(void 0!==r.curves.morph){if(void 0===d[t]){var i;h.get(e.ID).parents.forEach(function(e){void 0!==e.relationship&&(i=e.ID)});var s=h.get(i).parents[0].ID,o=h.get(s).parents[0].ID,l=h.get(o).parents[0].ID,a=u.Objects.Model[l],n={modelName:TONG.PropertyBinding.sanitizeNodeName(a.attrName),morphName:u.Objects.Deformer[i].attrName};d[t]=n}d[t][r.attr]=r}}}),t.set(parseInt(r),d)}}return t}(e,t,r);return function(e,t,r){var a=e.Objects.AnimationStack,n={};for(var i in a){var s=t.get(parseInt(i)).children;1<s.length&&console.warn("TONG.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");var o=r.get(s[0].ID);n[i]={name:a[i].attrName,layer:o}}return n}(e,t,a)}}(e,t);if(void 0!==a)for(var n in a){var i=a[n],s=B(i,r);r.animations.push(s)}}(s,o,c),function(e,t){if("GlobalSettings"in e&&"AmbientColor"in e.GlobalSettings){var r=e.GlobalSettings.AmbientColor.value,a=r[0],n=r[1],i=r[2];if(0!==a||0!==n||0!==i){var s=new TONG.Color(a,n,i);t.add(new TONG.AmbientLight(s,1))}}}(s,c),(p=c).traverse(function(e){if(e.isMesh&&(e.geometry.morphAttributes.position||e.geometry.morphAttributes.normal)){var t=e.uuid,r=e.material.uuid,a=!1;p.traverse(function(e){e.isMesh&&e.material.uuid===r&&e.uuid!==t&&(a=!0)}),!0===a&&(e.material=e.material.clone()),e.material.morphTargets=!0}}),c}});var o=[];function G(e,t,r,a){var n;switch(a.mappingType){case"ByPolygonVertex":n=e;break;case"ByPolygon":n=t;break;case"ByVertice":n=r;break;case"AllSame":n=a.indices[0];break;default:console.warn("TONG.FBXLoader: unknown attribute mapping type "+a.mappingType)}"IndexToDirect"===a.referenceType&&(n=a.indices[n]);var i=n*a.dataSize,s=i+a.dataSize;return function(e,t,r,a){for(var n=r,i=0;n<a;n++,i++)e[i]=t[n];return e}(o,a.buffer,i,s)}function k(e,t,i,s){var o=null;return e.parents.forEach(function(a){for(var e in t){var n=t[e];n.rawBones.forEach(function(e,t){if(e.ID===a.ID){var r=o;(o=new TONG.Bone).matrixWorld.copy(e.transformLink),o.name=TONG.PropertyBinding.sanitizeNodeName(s),o.ID=i,n.bones[t]=o,null!==r&&o.add(r)}})}}),o}function L(r,e){var t,a;if(e.children.forEach(function(e){var t=r.Objects.NodeAttribute[e.ID];void 0!==t&&(a=t)}),void 0===a)t=new TONG.Object3D;else{var n=0;void 0!==a.CameraProjectionType&&1===a.CameraProjectionType.value&&(n=1);var i=1;void 0!==a.NearPlane&&(i=a.NearPlane.value/1e3);var s=1e3;void 0!==a.FarPlane&&(s=a.FarPlane.value/1e3);var o=window.innerWidth,l=window.innerHeight;void 0!==a.AspectWidth&&void 0!==a.AspectHeight&&(o=a.AspectWidth.value,l=a.AspectHeight.value);var u=o/l,h=45;void 0!==a.FieldOfView&&(h=a.FieldOfView.value);var c=a.FocalLength?a.FocalLength.value:null;switch(n){case 0:t=new TONG.PerspectiveCamera(h,u,i,s),null!==c&&t.setFocalLength(c);break;case 1:t=new TONG.OrthographicCamera(-o/2,o/2,l/2,-l/2,i,s);break;default:console.warn("TONG.FBXLoader: Unknown camera type "+n+"."),t=new TONG.Object3D}}return t}function S(r,e){var t,a;if(e.children.forEach(function(e){var t=r.Objects.NodeAttribute[e.ID];void 0!==t&&(a=t)}),void 0===a)t=new TONG.Object3D;else{var n;n=void 0===a.LightType?0:a.LightType.value;var i=16777215;void 0!==a.Color&&(i=(new TONG.Color).fromArray(a.Color.value));var s=void 0===a.Intensity?1:a.Intensity.value/100;void 0!==a.CastLightOnObject&&0===a.CastLightOnObject.value&&(s=0);var o=0;void 0!==a.FarAttenuationEnd&&(o=void 0!==a.EnableFarAttenuation&&0===a.EnableFarAttenuation.value?0:a.FarAttenuationEnd.value);switch(n){case 0:t=new TONG.PointLight(i,s,o,1);break;case 1:t=new TONG.DirectionalLight(i,s);break;case 2:var l=Math.PI/3;void 0!==a.InnerAngle&&(l=TONG.Math.degToRad(a.InnerAngle.value));var u=0;void 0!==a.OuterAngle&&(u=TONG.Math.degToRad(a.OuterAngle.value),u=Math.max(u,1)),t=new TONG.SpotLight(i,s,o,l,u,1);break;default:console.warn("TONG.FBXLoader: Unknown light type "+a.LightType.value+", defaulting to a TONG.PointLight."),t=new TONG.PointLight(i,s)}void 0!==a.CastShadows&&1===a.CastShadows.value&&(t.castShadow=!0)}return t}function C(e,t,r,a){var n,i=null,s=null,o=[];return t.children.forEach(function(e){r.has(e.ID)&&(i=r.get(e.ID)),a.has(e.ID)&&o.push(a.get(e.ID))}),1<o.length?s=o:0<o.length?s=o[0]:(s=new TONG.MeshPhongMaterial({color:13421772}),o.push(s)),"color"in i.attributes&&o.forEach(function(e){e.vertexColors=TONG.VertexColors}),i.FBX_Deformer?(o.forEach(function(e){e.skinning=!0}),n=new TONG.SkinnedMesh(i,s)):n=new TONG.Mesh(i,s),n}function F(e,r){var t=e.children.reduce(function(e,t){return r.has(t.ID)&&(e=r.get(t.ID)),e},null),a=new TONG.LineBasicMaterial({color:3342591,linewidth:1});return new TONG.Line(t,a)}function I(e,t,r){if("RotationOrder"in r){var a=parseInt(r.RotationOrder.value,10);0<a&&a<6?console.warn("TONG.FBXLoader: unsupported Euler Order: %s. Currently only XYZ order is supported. Animations and rotations may be incorrect.",["XYZ","XZY","YZX","ZXY","YXZ","ZYX","SphericXYZ"][a]):6===a&&console.warn("TONG.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect.")}if("Lcl_Translation"in r&&t.position.fromArray(r.Lcl_Translation.value),"Lcl_Rotation"in r){var n=r.Lcl_Rotation.value.map(TONG.Math.degToRad);n.push("ZYX"),t.quaternion.setFromEuler((new TONG.Euler).fromArray(n))}if("Lcl_Scaling"in r&&t.scale.fromArray(r.Lcl_Scaling.value),"PreRotation"in r){var i=r.PreRotation.value.map(TONG.Math.degToRad);i[3]="ZYX";var s=(new TONG.Euler).fromArray(i);s=(new TONG.Quaternion).setFromEuler(s),t.quaternion.premultiply(s)}}function B(e,t){var r=[];return e.layer.forEach(function(e){r=r.concat(function(e,t){var r=[];if(void 0!==e.T&&0<Object.keys(e.T.curves).length){var a=d(e.modelName,e.T.curves,e.initialPosition,"position");void 0!==a&&r.push(a)}if(void 0!==e.R&&0<Object.keys(e.R.curves).length){var n=function(e,t,r,a){void 0!==t.x&&(m(t.x),t.x.values=t.x.values.map(TONG.Math.degToRad));void 0!==t.y&&(m(t.y),t.y.values=t.y.values.map(TONG.Math.degToRad));void 0!==t.z&&(m(t.z),t.z.values=t.z.values.map(TONG.Math.degToRad));var n=p(t),i=f(n,t,r);void 0!==a&&((a=a.map(TONG.Math.degToRad)).push("ZYX"),a=(new TONG.Euler).fromArray(a),a=(new TONG.Quaternion).setFromEuler(a));for(var s=new TONG.Quaternion,o=new TONG.Euler,l=[],u=0;u<i.length;u+=3)o.set(i[u],i[u+1],i[u+2],"ZYX"),s.setFromEuler(o),void 0!==a&&s.premultiply(a),s.toArray(l,u/3*4);return new TONG.QuaternionKeyframeTrack(e+".quaternion",n,l)}(e.modelName,e.R.curves,e.initialRotation,e.preRotations);void 0!==n&&r.push(n)}if(void 0!==e.S&&0<Object.keys(e.S.curves).length){var i=d(e.modelName,e.S.curves,e.initialScale,"scale");void 0!==i&&r.push(i)}if(void 0!==e.DeformPercent){var s=(l=t,u=(o=e).DeformPercent.curves.morph,h=u.values.map(function(e){return e/100}),c=l.getObjectByName(o.modelName).morphTargetDictionary[o.morphName],new TONG.NumberKeyframeTrack(o.modelName+".morphTargetInfluences["+c+"]",u.times,h));void 0!==s&&r.push(s)}var o,l,u,h,c;return r}(e,t))}),new TONG.AnimationClip(e.name,-1,r)}function d(e,t,r,a){var n=p(t),i=f(n,t,r);return new TONG.VectorKeyframeTrack(e+"."+a,n,i)}function f(e,n,t){var i=t,s=[],o=-1,l=-1,u=-1;return e.forEach(function(e){if(n.x&&(o=n.x.times.indexOf(e)),n.y&&(l=n.y.times.indexOf(e)),n.z&&(u=n.z.times.indexOf(e)),-1!==o){var t=n.x.values[o];s.push(t),i[0]=t}else s.push(i[0]);if(-1!==l){var r=n.y.values[l];s.push(r),i[1]=r}else s.push(i[1]);if(-1!==u){var a=n.z.values[u];s.push(a),i[2]=a}else s.push(i[2])}),s}function p(e){var t=[];return void 0!==e.x&&(t=t.concat(e.x.times)),void 0!==e.y&&(t=t.concat(e.y.times)),void 0!==e.z&&(t=t.concat(e.z.times)),t=t.sort(function(e,t){return e-t}).filter(function(e,t,r){return r.indexOf(e)==t})}function m(e){for(var t=1;t<e.values.length;t++){var r=e.values[t-1],a=e.values[t]-r,n=Math.abs(a);if(180<=n){for(var i=n/180,s=a/i,o=r+s,l=e.times[t-1],u=(e.times[t]-l)/i,h=l+u,c=[],d=[];h<e.times[t];)c.push(h),h+=u,d.push(o),o+=s;e.times=g(e.times,t,c),e.values=g(e.values,t,d)}}}function E(){}function R(){}function l(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=void 0===t||t}function i(){}function D(e){var t=e.match(/FBXVersion: (\d+)/);if(t)return parseInt(t[1]);throw new Error("TONG.FBXLoader: Cannot find the version number for the file given.")}function P(e){return e/46186158e3}function h(e){return e.split(",").map(function(e){return parseFloat(e)})}function U(e,t,r){return void 0===t&&(t=0),void 0===r&&(r=e.byteLength),TONG.LoaderUtils.decodeText(new Uint8Array(e,t,r))}function g(e,t,r){return e.slice(0,t).concat(r).concat(e.slice(t))}Object.assign(E.prototype,{getPrevNode:function(){return this.nodeStack[this.currentIndent-2]},getCurrentNode:function(){return this.nodeStack[this.currentIndent-1]},getCurrentProp:function(){return this.currentProp},pushStack:function(e){this.nodeStack.push(e),this.currentIndent+=1},popStack:function(){this.nodeStack.pop(),this.currentIndent-=1},setCurrentProp:function(e,t){this.currentProp=e,this.currentPropName=t},parse:function(e){this.currentIndent=0,this.allNodes=new i,this.nodeStack=[],this.currentProp=[],this.currentPropName="";var o=this,l=e.split(/[\r\n]+/);return l.forEach(function(e,t){var r=e.match(/^[\s\t]*;/),a=e.match(/^[\s\t]*$/);if(!r&&!a){var n=e.match("^\\t{"+o.currentIndent+"}(\\w+):(.*){",""),i=e.match("^\\t{"+o.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),s=e.match("^\\t{"+(o.currentIndent-1)+"}}");n?o.parseNodeBegin(e,n):i?o.parseNodeProperty(e,i,l[++t]):s?o.popStack():e.match(/^[^\s\t}]/)&&o.parseNodePropertyContinued(e)}}),this.allNodes},parseNodeBegin:function(e,t){var r=t[1].trim().replace(/^"/,"").replace(/"$/,""),a=t[2].split(",").map(function(e){return e.trim().replace(/^"/,"").replace(/"$/,"")}),n={name:r},i=this.parseNodeAttr(a),s=this.getCurrentNode();0===this.currentIndent?this.allNodes.add(r,n):r in s?("PoseNode"===r?s.PoseNode.push(n):void 0!==s[r].id&&(s[r]={},s[r][s[r].id]=s[r]),""!==i.id&&(s[r][i.id]=n)):"number"==typeof i.id?(s[r]={},s[r][i.id]=n):"Properties70"!==r&&(s[r]="PoseNode"===r?[n]:n),"number"==typeof i.id&&(n.id=i.id),""!==i.name&&(n.attrName=i.name),""!==i.type&&(n.attrType=i.type),this.pushStack(n)},parseNodeAttr:function(e){var t=e[0];""!==e[0]&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));var r="",a="";return 1<e.length&&(r=e[1].replace(/^(\w+)::/,""),a=e[2]),{id:t,name:r,type:a}},parseNodeProperty:function(e,t,r){var a=t[1].replace(/^"/,"").replace(/"$/,"").trim(),n=t[2].replace(/^"/,"").replace(/"$/,"").trim();"Content"===a&&","===n&&(n=r.replace(/"/g,"").replace(/,$/,"").trim());var i=this.getCurrentNode();if("Properties70"!==i.name){if("C"===a){var s=n.split(",").slice(1),o=parseInt(s[0]),l=parseInt(s[1]),u=n.split(",").slice(3);a="connections",function(e,t){for(var r=0,a=e.length,n=t.length;r<n;r++,a++)e[a]=t[r]}(n=[o,l],u=u.map(function(e){return e.trim().replace(/^"/,"")})),void 0===i[a]&&(i[a]=[])}"Node"===a&&(i.id=n),a in i&&Array.isArray(i[a])?i[a].push(n):"a"!==a?i[a]=n:i.a=n,this.setCurrentProp(i,a),"a"===a&&","!==n.slice(-1)&&(i.a=h(n))}else this.parseNodeSpecialProperty(e,a,n)},parseNodePropertyContinued:function(e){var t=this.getCurrentNode();t.a+=e,","!==e.slice(-1)&&(t.a=h(t.a))},parseNodeSpecialProperty:function(e,t,r){var a=r.split('",').map(function(e){return e.trim().replace(/^\"/,"").replace(/\s/,"_")}),n=a[0],i=a[1],s=a[2],o=a[3],l=a[4];switch(i){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":l=parseFloat(l);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":l=h(l)}this.getPrevNode()[n]={type:i,type2:s,flag:o,value:l},this.setCurrentProp(this.getPrevNode(),n)}}),Object.assign(R.prototype,{parse:function(e){var t=new l(e);t.skip(23);var r=t.getUint32();console.log("TONG.FBXLoader: FBX binary version: "+r);for(var a=new i;!this.endOfContent(t);){var n=this.parseNode(t,r);null!==n&&a.add(n.name,n)}return a},endOfContent:function(e){return e.size()%16==0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()},parseNode:function(e,t){var r={},a=7500<=t?e.getUint64():e.getUint32(),n=7500<=t?e.getUint64():e.getUint32(),i=(7500<=t?e.getUint64():e.getUint32(),e.getUint8()),s=e.getString(i);if(0===a)return null;for(var o=[],l=0;l<n;l++)o.push(this.parseProperty(e));var u=0<o.length?o[0]:"",h=1<o.length?o[1]:"",c=2<o.length?o[2]:"";for(r.singleProperty=1===n&&e.getOffset()===a;a>e.getOffset();){var d=this.parseNode(e,t);null!==d&&this.parseSubNode(s,r,d)}return r.propertyList=o,"number"==typeof u&&(r.id=u),""!==h&&(r.attrName=h),""!==c&&(r.attrType=c),""!==s&&(r.name=s),r},parseSubNode:function(e,t,r){if(!0===r.singleProperty){var a=r.propertyList[0];Array.isArray(a)?(t[r.name]=r).a=a:t[r.name]=a}else if("Connections"===e&&"C"===r.name){var n=[];r.propertyList.forEach(function(e,t){0!==t&&n.push(e)}),void 0===t.connections&&(t.connections=[]),t.connections.push(n)}else if("Properties70"===r.name){Object.keys(r).forEach(function(e){t[e]=r[e]})}else if("Properties70"===e&&"P"===r.name){var i,s=r.propertyList[0],o=r.propertyList[1],l=r.propertyList[2],u=r.propertyList[3];0===s.indexOf("Lcl ")&&(s=s.replace("Lcl ","Lcl_")),0===o.indexOf("Lcl ")&&(o=o.replace("Lcl ","Lcl_")),i="Color"===o||"ColorRGB"===o||"Vector"===o||"Vector3D"===o||0===o.indexOf("Lcl_")?[r.propertyList[4],r.propertyList[5],r.propertyList[6]]:r.propertyList[4],t[s]={type:o,type2:l,flag:u,value:i}}else void 0===t[r.name]?"number"==typeof r.id?(t[r.name]={},t[r.name][r.id]=r):t[r.name]=r:"PoseNode"===r.name?(Array.isArray(t[r.name])||(t[r.name]=[t[r.name]]),t[r.name].push(r)):void 0===t[r.name][r.id]&&(t[r.name][r.id]=r)},parseProperty:function(e){var t=e.getString(1);switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":var r=e.getUint32();return e.getArrayBuffer(r);case"S":r=e.getUint32();return e.getString(r);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":var a=e.getUint32(),n=e.getUint32(),i=e.getUint32();if(0===n)switch(t){case"b":case"c":return e.getBooleanArray(a);case"d":return e.getFloat64Array(a);case"f":return e.getFloat32Array(a);case"i":return e.getInt32Array(a);case"l":return e.getInt64Array(a)}"undefined"==typeof Zlib&&console.error("TONG.FBXLoader: External library Inflate.min.js required, obtain or import from https://github.com/imaya/zlib.js");var s=new l(new Zlib.Inflate(new Uint8Array(e.getArrayBuffer(i))).decompress().buffer);switch(t){case"b":case"c":return s.getBooleanArray(a);case"d":return s.getFloat64Array(a);case"f":return s.getFloat32Array(a);case"i":return s.getInt32Array(a);case"l":return s.getInt64Array(a)}default:throw new Error("TONG.FBXLoader: Unknown property type "+t)}}}),Object.assign(l.prototype,{getOffset:function(){return this.offset},size:function(){return this.dv.buffer.byteLength},skip:function(e){this.offset+=e},getBoolean:function(){return 1==(1&this.getUint8())},getBooleanArray:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getBoolean());return t},getUint8:function(){var e=this.dv.getUint8(this.offset);return this.offset+=1,e},getInt16:function(){var e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e},getInt32:function(){var e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e},getInt32Array:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getInt32());return t},getUint32:function(){var e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e},getInt64:function(){var e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),2147483648&t?(t=4294967295&~t,4294967295===(e=4294967295&~e)&&(t=t+1&4294967295),-(4294967296*t+(e=e+1&4294967295))):4294967296*t+e},getInt64Array:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getInt64());return t},getUint64:function(){var e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),4294967296*t+e},getFloat32:function(){var e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e},getFloat32Array:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getFloat32());return t},getFloat64:function(){var e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e},getFloat64Array:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getFloat64());return t},getArrayBuffer:function(e){var t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t},getString:function(e){for(var t=new Uint8Array(e),r=0;r<e;r++)t[r]=this.getUint8();var a=t.indexOf(0);return 0<=a&&(t=t.slice(0,a)),TONG.LoaderUtils.decodeText(t)}}),Object.assign(i.prototype,{add:function(e,t){this[e]=t}})}(),TONG.GCodeLoader=function(e){this.manager=void 0!==e?e:TONG.DefaultLoadingManager,this.splitLayer=!1},TONG.GCodeLoader.prototype.load=function(e,t,r,a){var n=this;new TONG.FileLoader(n.manager).load(e,function(e){t(n.parse(e))},r,a)},TONG.GCodeLoader.prototype.parse=function(e){var r={x:0,y:0,z:0,e:0,f:0,extruding:!1,relative:!1},t=[],a=void 0,n=new TONG.LineBasicMaterial({color:16711680});n.name="path";var i=new TONG.LineBasicMaterial({color:65280});function s(e){a={vertex:[],pathVertex:[],z:e.z},t.push(a)}function o(e,t){return r.relative?t:t-e}function l(e,t){return r.relative?e+t:t}i.name="extruded";for(var u,h,c=e.replace(/;.+/g,"").split("\n"),d=0;d<c.length;d++){var f=c[d].split(" "),p=f[0].toUpperCase(),m={};if(f.splice(1).forEach(function(e){if(void 0!==e[0]){var t=e[0].toLowerCase(),r=parseFloat(e.substring(1));m[t]=r}}),"G0"===p||"G1"===p){var g={x:void 0!==m.x?l(r.x,m.x):r.x,y:void 0!==m.y?l(r.y,m.y):r.y,z:void 0!==m.z?l(r.z,m.z):r.z,e:void 0!==m.e?l(r.e,m.e):r.e,f:void 0!==m.f?l(r.f,m.f):r.f};0<o(r.e,g.e)&&(g.extruding=0<o(r.e,g.e),null!=a&&g.z==a.z||s(g)),u=r,h=g,void 0===a&&s(u),g.extruding?(a.vertex.push(u.x,u.y,u.z),a.vertex.push(h.x,h.y,h.z)):(a.pathVertex.push(u.x,u.y,u.z),a.pathVertex.push(h.x,h.y,h.z)),r=g}else if("G2"===p||"G3"===p)console.warn("TONG.GCodeLoader: Arc command not supported");else if("G90"===p)r.relative=!1;else if("G91"===p)r.relative=!0;else if("G92"===p){(g=r).x=void 0!==m.x?m.x:g.x,g.y=void 0!==m.y?m.y:g.y,g.z=void 0!==m.z?m.z:g.z,g.e=void 0!==m.e?m.e:g.e,r=g}else console.warn("TONG.GCodeLoader: Command not supported:"+p)}function v(e,t){var r=new TONG.BufferGeometry;r.addAttribute("position",new TONG.Float32BufferAttribute(e,3));var a=new TONG.LineSegments(r,t?i:n);a.name="layer"+d,y.add(a)}var y=new TONG.Group;if(y.name="gcode",this.splitLayer)for(d=0;d<t.length;d++){v((_=t[d]).vertex,!0),v(_.pathVertex,!1)}else{var T=[],b=[];for(d=0;d<t.length;d++){var _=t[d];T=T.concat(_.vertex),b=b.concat(_.pathVertex)}v(T,!0),v(b,!1)}return y.quaternion.setFromEuler(new TONG.Euler(-Math.PI/2,0,0)),y},TONG.GLTFLoader=function(){function e(e){this.manager=void 0!==e?e:TONG.DefaultLoadingManager,this.dracoLoader=null}function a(){var r={};return{get:function(e){return r[e]},add:function(e,t){r[e]=t},remove:function(e){delete r[e]},removeAll:function(){r={}}}}e.prototype={constructor:e,crossOrigin:"anonymous",load:function(e,t,r,a){var n=this,i=void 0!==this.path?this.path:TONG.LoaderUtils.extractUrlBase(e),s=new TONG.FileLoader(n.manager);s.setResponseType("arraybuffer"),s.load(e,function(e){try{n.parse(e,i,t,a)}catch(e){if(void 0===a)throw e;a(e)}},r,a)},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this},setDRACOLoader:function(e){return this.dracoLoader=e,this},parse:function(e,t,s,r){var a,o={};if("string"==typeof e)a=e;else if(TONG.LoaderUtils.decodeText(new Uint8Array(e,0,4))===p){try{o[G.KHR_BINARY_GLTF]=new m(e)}catch(e){return void(r&&r(e))}a=o[G.KHR_BINARY_GLTF].content}else a=TONG.LoaderUtils.decodeText(new Uint8Array(e));var n=JSON.parse(a);if(void 0===n.asset||n.asset.version[0]<2)r&&r(new Error("TONG.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported. Use LegacyGLTFLoader instead."));else{if(n.extensionsUsed)for(var i=0;i<n.extensionsUsed.length;++i){var l=n.extensionsUsed[i],u=n.extensionsRequired||[];switch(l){case G.KHR_LIGHTS_PUNCTUAL:o[l]=new d(n);break;case G.KHR_MATERIALS_UNLIT:o[l]=new f(n);break;case G.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:o[l]=new v;break;case G.KHR_DRACO_MESH_COMPRESSION:o[l]=new g(n,this.dracoLoader);break;case G.MSFT_TEXTURE_DDS:o[G.MSFT_TEXTURE_DDS]=new c;break;default:0<=u.indexOf(l)&&console.warn('TONG.GLTFLoader: Unknown extension "'+l+'".')}}var h=new Z(n,o,{path:t||this.path||"",crossOrigin:this.crossOrigin,manager:this.manager});h.parse(function(e,t,r,a,n){var i={scene:e,scenes:t,cameras:r,animations:a,asset:n.asset,parser:h,userData:{}};U(o,i,n),s(i)},r)}}};var G={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",MSFT_TEXTURE_DDS:"MSFT_texture_dds"};function c(){if(!TONG.DDSLoader)throw new Error("TONG.GLTFLoader: Attempting to load .dds texture without importing TONG.DDSLoader");this.name=G.MSFT_TEXTURE_DDS,this.ddsLoader=new TONG.DDSLoader}function d(e){this.name=G.KHR_LIGHTS_PUNCTUAL,this.lights={};var t=(e.extensions&&e.extensions[G.KHR_LIGHTS_PUNCTUAL]||{}).lights||{};for(var r in t){var a,n=t[r],i=new TONG.Color(16777215);void 0!==n.color&&i.fromArray(n.color);var s=0;switch(void 0!==n.range&&(s=n.range),n.type){case"directional":(a=new TONG.DirectionalLight(i)).target.position.set(0,0,1),a.add(a.target);break;case"point":(a=new TONG.PointLight(i)).distance=s;break;case"spot":(a=new TONG.SpotLight(i)).distance=s,n.spot=n.spot||{},n.spot.innerConeAngle=void 0!==n.spot.innerConeAngle?n.spot.innerConeAngle:0,n.spot.outerConeAngle=void 0!==n.spot.outerConeAngle?n.spot.outerConeAngle:Math.PI/4,a.angle=n.spot.outerConeAngle,a.penumbra=1-n.spot.innerConeAngle/n.spot.outerConeAngle,a.target.position.set(0,0,1),a.add(a.target)}a&&(a.decay=2,void 0!==n.intensity&&(a.intensity=n.intensity),a.name=n.name||"light_"+r,this.lights[r]=a)}}function f(e){this.name=G.KHR_MATERIALS_UNLIT}f.prototype.getMaterialType=function(e){return TONG.MeshBasicMaterial},f.prototype.extendParams=function(e,t,r){var a=[];e.color=new TONG.Color(1,1,1),e.opacity=1;var n=t.pbrMetallicRoughness;if(n){if(Array.isArray(n.baseColorFactor)){var i=n.baseColorFactor;e.color.fromArray(i),e.opacity=i[3]}void 0!==n.baseColorTexture&&a.push(r.assignTexture(e,"map",n.baseColorTexture.index))}return Promise.all(a)};var p="glTF",l=12,u={JSON:1313821514,BIN:5130562};function m(e){this.name=G.KHR_BINARY_GLTF,this.content=null,this.body=null;var t=new DataView(e,0,l);if(this.header={magic:TONG.LoaderUtils.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==p)throw new Error("TONG.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("TONG.GLTFLoader: Legacy binary file detected. Use LegacyGLTFLoader instead.");for(var r=new DataView(e,l),a=0;a<r.byteLength;){var n=r.getUint32(a,!0);a+=4;var i=r.getUint32(a,!0);if(a+=4,i===u.JSON){var s=new Uint8Array(e,l+a,n);this.content=TONG.LoaderUtils.decodeText(s)}else if(i===u.BIN){var o=l+a;this.body=e.slice(o,o+n)}a+=n}if(null===this.content)throw new Error("TONG.GLTFLoader: JSON content not found.")}function g(e,t){if(!t)throw new Error("TONG.GLTFLoader: No DRACOLoader instance provided.");this.name=G.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t}function v(){return{name:G.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return TONG.ShaderMaterial},extendParams:function(e,t,r){var a=t.extensions[this.name],n=TONG.ShaderLib.standard,i=TONG.UniformsUtils.clone(n.uniforms),s=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),o=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),l=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),u=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),h=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb;","material.specularRoughness = clamp( 1.0 - glossinessFactor, 0.04, 1.0 );","material.specularColor = specularFactor.rgb;"].join("\n"),c=n.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",s).replace("#include <metalnessmap_pars_fragment>",o).replace("#include <roughnessmap_fragment>",l).replace("#include <metalnessmap_fragment>",u).replace("#include <lights_physical_fragment>",h);delete i.roughness,delete i.metalness,delete i.roughnessMap,delete i.metalnessMap,i.specular={value:(new TONG.Color).setHex(1118481)},i.glossiness={value:.5},i.specularMap={value:null},i.glossinessMap={value:null},e.vertexShader=n.vertexShader,e.fragmentShader=c,e.uniforms=i,e.defines={STANDARD:""},e.color=new TONG.Color(1,1,1),e.opacity=1;var d=[];if(Array.isArray(a.diffuseFactor)){var f=a.diffuseFactor;e.color.fromArray(f),e.opacity=f[3]}if(void 0!==a.diffuseTexture&&d.push(r.assignTexture(e,"map",a.diffuseTexture.index)),e.emissive=new TONG.Color(0,0,0),e.glossiness=void 0!==a.glossinessFactor?a.glossinessFactor:1,e.specular=new TONG.Color(1,1,1),Array.isArray(a.specularFactor)&&e.specular.fromArray(a.specularFactor),void 0!==a.specularGlossinessTexture){var p=a.specularGlossinessTexture.index;d.push(r.assignTexture(e,"glossinessMap",p)),d.push(r.assignTexture(e,"specularMap",p))}return Promise.all(d)},createMaterial:function(e){var t=new TONG.ShaderMaterial({defines:e.defines,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,fog:!0,lights:!0,opacity:e.opacity,transparent:e.transparent});return t.isGLTFSpecularGlossinessMaterial=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t.extensions.derivatives=!0,t},cloneMaterial:function(e){var t=e.clone();t.isGLTFSpecularGlossinessMaterial=!0;for(var r=this.specularGlossinessParams,a=0,n=r.length;a<n;a++)t[r[a]]=e[r[a]];return t},refreshUniforms:function(e,t,r,a,n,i){if(!0===n.isGLTFSpecularGlossinessMaterial){var s,o=n.uniforms,l=n.defines;o.opacity.value=n.opacity,o.diffuse.value.copy(n.color),o.emissive.value.copy(n.emissive).multiplyScalar(n.emissiveIntensity),o.map.value=n.map,o.specularMap.value=n.specularMap,o.alphaMap.value=n.alphaMap,o.lightMap.value=n.lightMap,o.lightMapIntensity.value=n.lightMapIntensity,o.aoMap.value=n.aoMap,o.aoMapIntensity.value=n.aoMapIntensity,n.map?s=n.map:n.specularMap?s=n.specularMap:n.displacementMap?s=n.displacementMap:n.normalMap?s=n.normalMap:n.bumpMap?s=n.bumpMap:n.glossinessMap?s=n.glossinessMap:n.alphaMap?s=n.alphaMap:n.emissiveMap&&(s=n.emissiveMap),void 0!==s&&(s.isWebGLRenderTarget&&(s=s.texture),!0===s.matrixAutoUpdate&&s.updateMatrix(),o.uvTransform.value.copy(s.matrix)),o.envMap.value=n.envMap,o.envMapIntensity.value=n.envMapIntensity,o.flipEnvMap.value=n.envMap&&n.envMap.isCubeTexture?-1:1,o.refractionRatio.value=n.refractionRatio,o.specular.value.copy(n.specular),o.glossiness.value=n.glossiness,o.glossinessMap.value=n.glossinessMap,o.emissiveMap.value=n.emissiveMap,o.bumpMap.value=n.bumpMap,o.normalMap.value=n.normalMap,o.displacementMap.value=n.displacementMap,o.displacementScale.value=n.displacementScale,o.displacementBias.value=n.displacementBias,null!==o.glossinessMap.value&&void 0===l.USE_GLOSSINESSMAP&&(l.USE_GLOSSINESSMAP="",l.USE_ROUGHNESSMAP=""),null===o.glossinessMap.value&&void 0!==l.USE_GLOSSINESSMAP&&(delete l.USE_GLOSSINESSMAP,delete l.USE_ROUGHNESSMAP)}}}}function O(e,t,r,a){TONG.Interpolant.call(this,e,t,r,a)}g.prototype.decodePrimitive=function(e,t){var r=this.json,a=this.dracoLoader,n=e.extensions[this.name].bufferView,i=e.extensions[this.name].attributes,s={},o={},l={};for(var u in i)u in w&&(s[w[u]]=i[u]);for(u in e.attributes)if(void 0!==w[u]&&void 0!==i[u]){var h=r.accessors[e.attributes[u]],c=A[h.componentType];l[w[u]]=c,o[w[u]]=!0===h.normalized}return t.getDependency("bufferView",n).then(function(e){return new Promise(function(n){a.decodeDracoFile(e,function(e){for(var t in e.attributes){var r=e.attributes[t],a=o[t];void 0!==a&&(r.normalized=a)}n(e)},s,l)})})},((O.prototype=Object.create(TONG.Interpolant.prototype)).constructor=O).prototype.interpolate_=function(e,t,r,a){for(var n=this.resultBuffer,i=this.sampleValues,s=this.valueSize,o=2*s,l=3*s,u=a-t,h=(r-t)/u,c=h*h,d=c*h,f=e*l,p=f-l,m=2*d-3*c+1,g=d-2*c+h,v=-2*d+3*c,y=d-c,T=0;T!==s;T++){var b=i[p+T+s],_=i[p+T+o]*u,O=i[f+T+s],w=i[f+T]*u;n[T]=m*b+g*_+v*O+y*w}return n};var k=0,L=1,S=2,C=3,F=4,I=5,B=6,A=(Number,TONG.Matrix3,TONG.Matrix4,TONG.Vector2,TONG.Vector3,TONG.Vector4,TONG.Texture,{5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array}),y={9728:TONG.NearestFilter,9729:TONG.LinearFilter,9984:TONG.NearestMipMapNearestFilter,9985:TONG.LinearMipMapNearestFilter,9986:TONG.NearestMipMapLinearFilter,9987:TONG.LinearMipMapLinearFilter},T={33071:TONG.ClampToEdgeWrapping,33648:TONG.MirroredRepeatWrapping,10497:TONG.RepeatWrapping},b={6406:TONG.AlphaFormat,6407:TONG.RGBFormat,6408:TONG.RGBAFormat,6409:TONG.LuminanceFormat,6410:TONG.LuminanceAlphaFormat},_={5121:TONG.UnsignedByteType,32819:TONG.UnsignedShort4444Type,32820:TONG.UnsignedShort5551Type,33635:TONG.UnsignedShort565Type},x=(TONG.BackSide,TONG.FrontSide,TONG.NeverDepth,TONG.LessDepth,TONG.EqualDepth,TONG.LessEqualDepth,TONG.GreaterEqualDepth,TONG.NotEqualDepth,TONG.GreaterEqualDepth,TONG.AlwaysDepth,TONG.AddEquation,TONG.SubtractEquation,TONG.ReverseSubtractEquation,TONG.ZeroFactor,TONG.OneFactor,TONG.SrcColorFactor,TONG.OneMinusSrcColorFactor,TONG.SrcAlphaFactor,TONG.OneMinusSrcAlphaFactor,TONG.DstAlphaFactor,TONG.OneMinusDstAlphaFactor,TONG.DstColorFactor,TONG.OneMinusDstColorFactor,TONG.SrcAlphaSaturateFactor,{SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16}),w={POSITION:"position",NORMAL:"normal",TEXCOORD_0:"uv",TEXCOORD0:"uv",TEXCOORD:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",COLOR0:"color",COLOR:"color",WEIGHTS_0:"skinWeight",WEIGHT:"skinWeight",JOINTS_0:"skinIndex",JOINT:"skinIndex"},N={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},M={CUBICSPLINE:TONG.InterpolateSmooth,LINEAR:TONG.InterpolateLinear,STEP:TONG.InterpolateDiscrete},E="OPAQUE",R="MASK",D="BLEND";function P(e,t){return"string"!=typeof e||""===e?"":/^(https?:)?\/\//i.test(e)?e:/^data:.*,.*$/i.test(e)?e:/^blob:.*$/i.test(e)?e:t+e}function U(e,t,r){for(var a in r.extensions)void 0===e[a]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[a]=r.extensions[a])}function z(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(var r=0,a=t.weights.length;r<a;r++)e.morphTargetInfluences[r]=t.weights[r];if(t.extras&&Array.isArray(t.extras.targetNames)){var n=t.extras.targetNames;if(e.morphTargetInfluences.length===n.length){e.morphTargetDictionary={};for(r=0,a=n.length;r<a;r++)e.morphTargetDictionary[n[r]]=r}else console.warn("TONG.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function h(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(var r in e)if(e[r]!==t[r])return!1;return!0}function V(e,t){if(e.length!==t.length)return!1;for(var r=0,a=e.length;r<a;r++)if(e[r]!==t[r])return!1;return!0}function j(e,t){for(var r=0,a=e.length;r<a;r++){var n=e[r];if(i=n.primitive,s=t,i.indices===s.indices&&h(i.attributes,s.attributes))return n.promise}var i,s;return null}function W(e){if(e.isInterleavedBufferAttribute){for(var t=e.count,r=e.itemSize,a=e.array.slice(0,t*r),n=0;n<t;++n)a[n]=e.getX(n),2<=r&&(a[n+1]=e.getY(n)),3<=r&&(a[n+2]=e.getZ(n)),4<=r&&(a[n+3]=e.getW(n));return new TONG.BufferAttribute(a,r,e.normalized)}return e.clone()}function Z(e,t,r){this.json=e||{},this.extensions=t||{},this.options=r||{},this.cache=new a,this.primitiveCache=[],this.multiplePrimitivesCache=[],this.multiPassGeometryCache=[],this.textureLoader=new TONG.TextureLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.fileLoader=new TONG.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer")}function X(e,t,r){var a=t.attributes;for(var n in a){var i=w[n],s=r[a[n]];i&&(i in e.attributes||e.addAttribute(i,s))}void 0===t.indices||e.index||e.setIndex(r[t.indices]),void 0!==t.targets&&function(e,t,r){for(var a=!1,n=!1,i=0,s=t.length;i<s&&(void 0!==(u=t[i]).POSITION&&(a=!0),void 0!==u.NORMAL&&(n=!0),!a||!n);i++);if(a||n){var o=[],l=[];for(i=0,s=t.length;i<s;i++){var u=t[i],h="morphTarget"+i;if(a){if(void 0!==u.POSITION){var c=W(r[u.POSITION]);c.name=h;for(var d=e.attributes.position,f=0,p=c.count;f<p;f++)c.setXYZ(f,c.getX(f)+d.getX(f),c.getY(f)+d.getY(f),c.getZ(f)+d.getZ(f))}else c=e.attributes.position;o.push(c)}if(n){if(void 0!==u.NORMAL){var m;(m=W(r[u.NORMAL])).name=h;var g=e.attributes.normal;for(f=0,p=m.count;f<p;f++)m.setXYZ(f,m.getX(f)+g.getX(f),m.getY(f)+g.getY(f),m.getZ(f)+g.getZ(f))}else m=e.attributes.normal;l.push(m)}}a&&(e.morphAttributes.position=o),n&&(e.morphAttributes.normal=l)}}(e,t.targets,r),void 0!==t.extras&&(e.userData=t.extras)}return Z.prototype.parse=function(i,e){var s=this.json;this.cache.removeAll(),this.markDefs(),this.getMultiDependencies(["scene","animation","camera"]).then(function(e){var t=e.scenes||[],r=t[s.scene||0],a=e.animations||[],n=e.cameras||[];i(r,t,n,a,s)}).catch(e)},Z.prototype.markDefs=function(){for(var e=this.json.nodes||[],t=this.json.skins||[],r=this.json.meshes||[],a={},n={},i=0,s=t.length;i<s;i++)for(var o=t[i].joints,l=0,u=o.length;l<u;l++)e[o[l]].isBone=!0;for(var h=0,c=e.length;h<c;h++){var d=e[h];void 0!==d.mesh&&(void 0===a[d.mesh]&&(a[d.mesh]=n[d.mesh]=0),a[d.mesh]++,void 0!==d.skin&&(r[d.mesh].isSkinnedMesh=!0))}this.json.meshReferences=a,this.json.meshUses=n},Z.prototype.getDependency=function(e,t){var r=e+":"+t,a=this.cache.get(r);if(!a){switch(e){case"scene":a=this.loadScene(t);break;case"node":a=this.loadNode(t);break;case"mesh":a=this.loadMesh(t);break;case"accessor":a=this.loadAccessor(t);break;case"bufferView":a=this.loadBufferView(t);break;case"buffer":a=this.loadBuffer(t);break;case"material":a=this.loadMaterial(t);break;case"texture":a=this.loadTexture(t);break;case"skin":a=this.loadSkin(t);break;case"animation":a=this.loadAnimation(t);break;case"camera":a=this.loadCamera(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(r,a)}return a},Z.prototype.getDependencies=function(r){var e=this.cache.get(r);if(!e){var a=this,t=this.json[r+("mesh"===r?"es":"s")]||[];e=Promise.all(t.map(function(e,t){return a.getDependency(r,t)})),this.cache.add(r,e)}return e},Z.prototype.getMultiDependencies=function(e){for(var r={},t=[],a=0,n=e.length;a<n;a++){var i=e[a],s=this.getDependencies(i);s=s.then(function(e,t){r[e]=t}.bind(this,i+("mesh"===i?"es":"s"))),t.push(s)}return Promise.all(t).then(function(){return r})},Z.prototype.loadBuffer=function(e){var r=this.json.buffers[e],a=this.fileLoader;if(r.type&&"arraybuffer"!==r.type)throw new Error("TONG.GLTFLoader: "+r.type+" buffer type is not supported.");if(void 0===r.uri&&0===e)return Promise.resolve(this.extensions[G.KHR_BINARY_GLTF].body);var n=this.options;return new Promise(function(e,t){a.load(P(r.uri,n.path),e,void 0,function(){t(new Error('TONG.GLTFLoader: Failed to load buffer "'+r.uri+'".'))})})},Z.prototype.loadBufferView=function(e){var a=this.json.bufferViews[e];return this.getDependency("buffer",a.buffer).then(function(e){var t=a.byteLength||0,r=a.byteOffset||0;return e.slice(r,r+t)})},Z.prototype.loadAccessor=function(e){var O=this,w=this.json,N=this.json.accessors[e];if(void 0===N.bufferView&&void 0===N.sparse)return null;var t=[];return void 0!==N.bufferView?t.push(this.getDependency("bufferView",N.bufferView)):t.push(null),void 0!==N.sparse&&(t.push(this.getDependency("bufferView",N.sparse.indices.bufferView)),t.push(this.getDependency("bufferView",N.sparse.values.bufferView))),Promise.all(t).then(function(e){var t,r,a=e[0],n=x[N.type],i=A[N.componentType],s=i.BYTES_PER_ELEMENT,o=s*n,l=N.byteOffset||0,u=w.bufferViews[N.bufferView].byteStride,h=!0===N.normalized;if(u&&u!==o){var c="InterleavedBuffer:"+N.bufferView+":"+N.componentType,d=O.cache.get(c);d||(t=new i(a),d=new TONG.InterleavedBuffer(t,u/s),O.cache.add(c,d)),r=new TONG.InterleavedBufferAttribute(d,n,l/s,h)}else t=null===a?new i(N.count*n):new i(a,l,N.count*n),r=new TONG.BufferAttribute(t,n,h);if(void 0!==N.sparse){var f=x.SCALAR,p=A[N.sparse.indices.componentType],m=N.sparse.indices.byteOffset||0,g=N.sparse.values.byteOffset||0,v=new p(e[1],m,N.sparse.count*f),y=new i(e[2],g,N.sparse.count*n);null!==a&&r.setArray(r.array.slice());for(var T=0,b=v.length;T<b;T++){var _=v[T];if(r.setX(_,y[T*n]),2<=n&&r.setY(_,y[T*n+1]),3<=n&&r.setZ(_,y[T*n+2]),4<=n&&r.setW(_,y[T*n+3]),5<=n)throw new Error("TONG.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return r})},Z.prototype.loadTexture=function(e){var r,t=this,a=this.json,n=this.options,i=this.textureLoader,s=window.URL||window.webkitURL,o=a.textures[e],l=o.extensions||{},u=(r=l[G.MSFT_TEXTURE_DDS]?a.images[l[G.MSFT_TEXTURE_DDS].source]:a.images[o.source]).uri,h=!1;return void 0!==r.bufferView&&(u=t.getDependency("bufferView",r.bufferView).then(function(e){h=!0;var t=new Blob([e],{type:r.mimeType});return u=s.createObjectURL(t)})),Promise.resolve(u).then(function(r){var a=TONG.Loader.Handlers.get(r);return a||(a=l[G.MSFT_TEXTURE_DDS]?t.extensions[G.MSFT_TEXTURE_DDS].ddsLoader:i),new Promise(function(e,t){a.load(P(r,n.path),e,void 0,t)})}).then(function(e){!0===h&&s.revokeObjectURL(u),e.flipY=!1,void 0!==o.name&&(e.name=o.name),l[G.MSFT_TEXTURE_DDS]||(e.format=void 0!==o.format?b[o.format]:TONG.RGBAFormat),void 0!==o.internalFormat&&e.format!==b[o.internalFormat]&&console.warn("TONG.GLTFLoader: TONG.js does not support texture internalFormat which is different from texture format. internalFormat will be forced to be the same value as format."),e.type=void 0!==o.type?_[o.type]:TONG.UnsignedByteType;var t=(a.samplers||{})[o.sampler]||{};return e.magFilter=y[t.magFilter]||TONG.LinearFilter,e.minFilter=y[t.minFilter]||TONG.LinearMipMapLinearFilter,e.wrapS=T[t.wrapS]||TONG.RepeatWrapping,e.wrapT=T[t.wrapT]||TONG.RepeatWrapping,e})},Z.prototype.assignTexture=function(t,r,e){return this.getDependency("texture",e).then(function(e){t[r]=e})},Z.prototype.loadMaterial=function(e){this.json;var t,r=this.extensions,a=this.json.materials[e],n={},i=a.extensions||{},s=[];if(i[G.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){var o=r[G.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];t=o.getMaterialType(a),s.push(o.extendParams(n,a,this))}else if(i[G.KHR_MATERIALS_UNLIT]){var l=r[G.KHR_MATERIALS_UNLIT];t=l.getMaterialType(a),s.push(l.extendParams(n,a,this))}else{t=TONG.MeshStandardMaterial;var u=a.pbrMetallicRoughness||{};if(n.color=new TONG.Color(1,1,1),n.opacity=1,Array.isArray(u.baseColorFactor)){var h=u.baseColorFactor;n.color.fromArray(h),n.opacity=h[3]}if(void 0!==u.baseColorTexture&&s.push(this.assignTexture(n,"map",u.baseColorTexture.index)),n.metalness=void 0!==u.metallicFactor?u.metallicFactor:1,n.roughness=void 0!==u.roughnessFactor?u.roughnessFactor:1,void 0!==u.metallicRoughnessTexture){var c=u.metallicRoughnessTexture.index;s.push(this.assignTexture(n,"metalnessMap",c)),s.push(this.assignTexture(n,"roughnessMap",c))}}!0===a.doubleSided&&(n.side=TONG.DoubleSide);var d=a.alphaMode||E;return d===D?n.transparent=!0:(n.transparent=!1,d===R&&(n.alphaTest=void 0!==a.alphaCutoff?a.alphaCutoff:.5)),void 0!==a.normalTexture&&t!==TONG.MeshBasicMaterial&&(s.push(this.assignTexture(n,"normalMap",a.normalTexture.index)),n.normalScale=new TONG.Vector2(1,1),void 0!==a.normalTexture.scale&&n.normalScale.set(a.normalTexture.scale,a.normalTexture.scale)),void 0!==a.occlusionTexture&&t!==TONG.MeshBasicMaterial&&(s.push(this.assignTexture(n,"aoMap",a.occlusionTexture.index)),void 0!==a.occlusionTexture.strength&&(n.aoMapIntensity=a.occlusionTexture.strength)),void 0!==a.emissiveFactor&&t!==TONG.MeshBasicMaterial&&(n.emissive=(new TONG.Color).fromArray(a.emissiveFactor)),void 0!==a.emissiveTexture&&t!==TONG.MeshBasicMaterial&&s.push(this.assignTexture(n,"emissiveMap",a.emissiveTexture.index)),Promise.all(s).then(function(){var e;return e=t===TONG.ShaderMaterial?r[G.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(n):new t(n),void 0!==a.name&&(e.name=a.name),e.normalScale&&(e.normalScale.y=-e.normalScale.y),e.map&&(e.map.encoding=TONG.sRGBEncoding),e.emissiveMap&&(e.emissiveMap.encoding=TONG.sRGBEncoding),e.specularMap&&(e.specularMap.encoding=TONG.sRGBEncoding),a.extras&&(e.userData=a.extras),a.extensions&&U(r,e,a),e})},Z.prototype.loadGeometries=function(p){var m,g=this,o=this.extensions,l=this.primitiveCache,v=function(e){if(e.length<2)return!1;var t=e[0],r=t.targets||[];if(void 0===t.indices)return!1;for(var a=1,n=e.length;a<n;a++){var i=e[a];if(t.mode!==i.mode)return!1;if(void 0===i.indices)return!1;if(!h(t.attributes,i.attributes))return!1;var s=i.targets||[];if(r.length!==s.length)return!1;for(var o=0,l=r.length;o<l;o++)if(!h(r[o],s[o]))return!1}return!0}(p);return v&&(p=[(m=p)[0]]),this.getDependencies("accessor").then(function(f){for(var e=[],t=0,r=p.length;t<r;t++){var a=p[t],n=j(l,a);if(n)e.push(n);else if(a.extensions&&a.extensions[G.KHR_DRACO_MESH_COMPRESSION]){var i=o[G.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(a,g).then(function(e){return X(e,a,f),e});l.push({primitive:a,promise:i}),e.push(i)}else{var s=new TONG.BufferGeometry;X(s,a,f);i=Promise.resolve(s);l.push({primitive:a,promise:i}),e.push(i)}}return Promise.all(e).then(function(e){if(v){var t=e[0];if(null!==(d=function(e,t,r){for(var a=0,n=e.length;a<n;a++){var i=e[a];if(t===i.baseGeometry&&V(r,i.primitives))return i.geometry}return null}(c=g.multiPassGeometryCache,t,m)))return[d.geometry];var r=new TONG.BufferGeometry;for(var a in r.name=t.name,r.userData=t.userData,t.attributes)r.addAttribute(a,t.attributes[a]);for(var a in t.morphAttributes)r.morphAttributes[a]=t.morphAttributes[a];for(var n=[],i=0,s=0,o=m.length;s<o;s++){for(var l=f[m[s].indices],u=0,h=l.count;u<h;u++)n.push(l.array[u]);r.addGroup(i,l.count,s),i+=l.count}return r.setIndex(n),c.push({geometry:r,baseGeometry:t,primitives:m}),[r]}if(1<e.length&&void 0!==TONG.BufferGeometryUtils){for(s=1,o=p.length;s<o;s++)if(p[0].mode!==p[s].mode)return e;var c,d;if(d=function(e,t){for(var r=0,a=e.length;r<a;r++){var n=e[r];if(V(t,n.baseGeometries))return n.geometry}return null}(c=g.multiplePrimitivesCache,e)){if(null!==d.geometry)return[d.geometry]}else{r=TONG.BufferGeometryUtils.mergeBufferGeometries(e,!0);if(c.push({geometry:r,baseGeometries:e}),null!==r)return[r]}}return e})})},Z.prototype.loadMesh=function(N){var A=this,x=(this.json,this.extensions),M=this.json.meshes[N];return this.getMultiDependencies(["accessor","material"]).then(function(e){for(var O=M.primitives,w=[],t=0,r=O.length;t<r;t++)w[t]=void 0===O[t].material?new TONG.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:TONG.FrontSide}):e.materials[O[t].material];return A.loadGeometries(O).then(function(e){for(var t=1===e.length&&0<e[0].groups.length,r=[],a=0,n=e.length;a<n;a++){var i,s=e[a],o=O[a],l=t?w:w[a];if(o.mode===F||o.mode===I||o.mode===B||void 0===o.mode)i=!0===M.isSkinnedMesh?new TONG.SkinnedMesh(s,l):new TONG.Mesh(s,l),o.mode===I?i.drawMode=TONG.TriangleStripDrawMode:o.mode===B&&(i.drawMode=TONG.TriangleFanDrawMode);else if(o.mode===L)i=new TONG.LineSegments(s,l);else if(o.mode===C)i=new TONG.Line(s,l);else if(o.mode===S)i=new TONG.LineLoop(s,l);else{if(o.mode!==k)throw new Error("TONG.GLTFLoader: Primitive mode unsupported: "+o.mode);i=new TONG.Points(s,l)}0<Object.keys(i.geometry.morphAttributes).length&&z(i,M),i.name=M.name||"mesh_"+N,1<e.length&&(i.name+="_"+a),void 0!==M.extras&&(i.userData=M.extras),r.push(i);for(var u=t?i.material:[i.material],h=void 0!==s.attributes.color,c=void 0===s.attributes.normal,d=!0===i.isSkinnedMesh,f=0<Object.keys(s.morphAttributes).length,p=f&&void 0!==s.morphAttributes.normal,m=0,g=u.length;m<g;m++){l=u[m];if(i.isPoints){var v="PointsMaterial:"+l.uuid,y=A.cache.get(v);y||(y=new TONG.PointsMaterial,TONG.Material.prototype.copy.call(y,l),y.color.copy(l.color),y.map=l.map,y.lights=!1,A.cache.add(v,y)),l=y}else if(i.isLine){v="LineBasicMaterial:"+l.uuid;var T=A.cache.get(v);T||(T=new TONG.LineBasicMaterial,TONG.Material.prototype.copy.call(T,l),T.color.copy(l.color),T.lights=!1,A.cache.add(v,T)),l=T}if(h||c||d||f){v="ClonedMaterial:"+l.uuid+":";l.isGLTFSpecularGlossinessMaterial&&(v+="specular-glossiness:"),d&&(v+="skinning:"),h&&(v+="vertex-colors:"),c&&(v+="flat-shading:"),f&&(v+="morph-targets:"),p&&(v+="morph-normals:");var b=A.cache.get(v);b||(b=l.isGLTFSpecularGlossinessMaterial?x[G.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].cloneMaterial(l):l.clone(),d&&(b.skinning=!0),h&&(b.vertexColors=TONG.VertexColors),c&&(b.flatShading=!0),f&&(b.morphTargets=!0),p&&(b.morphNormals=!0),A.cache.add(v,b)),l=b}(u[m]=l).aoMap&&void 0===s.attributes.uv2&&void 0!==s.attributes.uv&&(console.log("TONG.GLTFLoader: Duplicating UVs to support aoMap."),s.addAttribute("uv2",new TONG.BufferAttribute(s.attributes.uv.array,2))),l.isGLTFSpecularGlossinessMaterial&&(i.onBeforeRender=x[G.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].refreshUniforms)}i.material=t?u:u[0]}if(1===r.length)return r[0];var _=new TONG.Group;for(a=0,n=r.length;a<n;a++)_.add(r[a]);return _})})},Z.prototype.loadCamera=function(e){var t,r=this.json.cameras[e],a=r[r.type];if(a)return"perspective"===r.type?t=new TONG.PerspectiveCamera(TONG.Math.radToDeg(a.yfov),a.aspectRatio||1,a.znear||1,a.zfar||2e6):"orthographic"===r.type&&(t=new TONG.OrthographicCamera(a.xmag/-2,a.xmag/2,a.ymag/2,a.ymag/-2,a.znear,a.zfar)),void 0!==r.name&&(t.name=r.name),r.extras&&(t.userData=r.extras),Promise.resolve(t);console.warn("TONG.GLTFLoader: Missing camera parameters.")},Z.prototype.loadSkin=function(e){var t=this.json.skins[e],r={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(r):this.getDependency("accessor",t.inverseBindMatrices).then(function(e){return r.inverseBindMatrices=e,r})},Z.prototype.loadAnimation=function(b){this.json;var _=this.json.animations[b];return this.getMultiDependencies(["accessor","node"]).then(function(e){for(var t=[],r=0,a=_.channels.length;r<a;r++){var n=_.channels[r],i=_.samplers[n.sampler];if(i){var s=n.target,o=void 0!==s.node?s.node:s.id,l=void 0!==_.parameters?_.parameters[i.input]:i.input,u=void 0!==_.parameters?_.parameters[i.output]:i.output,h=e.accessors[l],c=e.accessors[u],d=e.nodes[o];if(d){var f;switch(d.updateMatrix(),d.matrixAutoUpdate=!0,N[s.path]){case N.weights:f=TONG.NumberKeyframeTrack;break;case N.rotation:f=TONG.QuaternionKeyframeTrack;break;case N.position:case N.scale:default:f=TONG.VectorKeyframeTrack}var p=d.name?d.name:d.uuid,m=void 0!==i.interpolation?M[i.interpolation]:TONG.InterpolateLinear,g=[];N[s.path]===N.weights?d.traverse(function(e){!0===e.isMesh&&e.morphTargetInfluences&&g.push(e.name?e.name:e.uuid)}):g.push(p);for(var v=0,y=g.length;v<y;v++){var T=new f(g[v]+"."+N[s.path],TONG.AnimationUtils.arraySlice(h.array,0),TONG.AnimationUtils.arraySlice(c.array,0),m);"CUBICSPLINE"===i.interpolation&&(T.createInterpolant=function(e){return new O(this.times,this.values,this.getValueSize()/3,e)},T.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),t.push(T)}}}}o=void 0!==_.name?_.name:"animation_"+b;return new TONG.AnimationClip(o,void 0,t)})},Z.prototype.loadNode=function(e){this.json;var o=this.extensions,l=this.json.meshReferences,u=this.json.meshUses,h=this.json.nodes[e];return this.getMultiDependencies(["mesh","skin","camera","light"]).then(function(e){var t;if(!0===h.isBone)t=new TONG.Bone;else if(void 0!==h.mesh){var r=e.meshes[h.mesh];if(t=r.clone(),!0===r.isGroup)for(var a=0,n=r.children.length;a<n;a++){var i=r.children[a];i.material&&!0===i.material.isGLTFSpecularGlossinessMaterial&&(t.children[a].onBeforeRender=i.onBeforeRender)}else r.material&&!0===r.material.isGLTFSpecularGlossinessMaterial&&(t.onBeforeRender=r.onBeforeRender);1<l[h.mesh]&&(t.name+="_instance_"+u[h.mesh]++)}else if(void 0!==h.camera)t=e.cameras[h.camera];else if(h.extensions&&h.extensions[G.KHR_LIGHTS_PUNCTUAL]&&void 0!==h.extensions[G.KHR_LIGHTS_PUNCTUAL].light){t=o[G.KHR_LIGHTS_PUNCTUAL].lights[h.extensions[G.KHR_LIGHTS_PUNCTUAL].light]}else t=new TONG.Object3D;if(void 0!==h.name&&(t.name=TONG.PropertyBinding.sanitizeNodeName(h.name)),h.extras&&(t.userData=h.extras),h.extensions&&U(o,t,h),void 0!==h.matrix){var s=new TONG.Matrix4;s.fromArray(h.matrix),t.applyMatrix(s)}else void 0!==h.translation&&t.position.fromArray(h.translation),void 0!==h.rotation&&t.quaternion.fromArray(h.rotation),void 0!==h.scale&&t.scale.fromArray(h.scale);return t})},Z.prototype.loadScene=function(){function b(e,t,r,a,n){var i=a[e],s=r.nodes[e];if(void 0!==s.skin)for(var o=!0===i.isGroup?i.children:[i],l=0,u=o.length;l<u;l++){for(var h=o[l],c=n[s.skin],d=[],f=[],p=0,m=c.joints.length;p<m;p++){var g=c.joints[p],v=a[g];if(v){d.push(v);var y=new TONG.Matrix4;void 0!==c.inverseBindMatrices&&y.fromArray(c.inverseBindMatrices.array,16*p),f.push(y)}else console.warn('TONG.GLTFLoader: Joint "%s" could not be found.',g)}h.bind(new TONG.Skeleton(d,f),h.matrixWorld)}if(t.add(i),s.children){var T=s.children;for(l=0,u=T.length;l<u;l++){b(T[l],i,r,a,n)}}}return function(e){var i=this.json,s=this.extensions,o=this.json.scenes[e];return this.getMultiDependencies(["node","skin"]).then(function(e){var t=new TONG.Scene;void 0!==o.name&&(t.name=o.name),o.extras&&(t.userData=o.extras),o.extensions&&U(s,t,o);for(var r=o.nodes||[],a=0,n=r.length;a<n;a++)b(r[a],t,i,e.nodes,e.skins);return t})}}(),e}(),TONG.KTXLoader=function(e){TONG.CompressedTextureLoader.call(this,e),this._parser=TONG.KTXLoader.parse},TONG.KTXLoader.prototype=Object.create(TONG.CompressedTextureLoader.prototype),TONG.KTXLoader.prototype.constructor=TONG.KTXLoader,TONG.KTXLoader.parse=function(e,t){var r=new KhronosTextureContainer(e,1);return{mipmaps:r.mipmaps(t),width:r.pixelWidth,height:r.pixelHeight,format:r.glInternalFormat,isCubemap:6===r.numberOfFaces,mipmapCount:r.numberOfMipmapLevels}};var KhronosTextureContainer=function(){function h(e,t,r,a){this.arrayBuffer=e;var n=new Uint8Array(this.arrayBuffer,0,12);if(171===n[0]&&75===n[1]&&84===n[2]&&88===n[3]&&32===n[4]&&49===n[5]&&49===n[6]&&187===n[7]&&13===n[8]&&10===n[9]&&26===n[10]&&10===n[11]){var i=new Int32Array(this.arrayBuffer,12,13),s=16909060===i[0];this.glType=s?this.switchEndainness(i[1]):i[1],this.glTypeSize=s?this.switchEndainness(i[2]):i[2],this.glFormat=s?this.switchEndainness(i[3]):i[3],this.glInternalFormat=s?this.switchEndainness(i[4]):i[4],this.glBaseInternalFormat=s?this.switchEndainness(i[5]):i[5],this.pixelWidth=s?this.switchEndainness(i[6]):i[6],this.pixelHeight=s?this.switchEndainness(i[7]):i[7],this.pixelDepth=s?this.switchEndainness(i[8]):i[8],this.numberOfArrayElements=s?this.switchEndainness(i[9]):i[9],this.numberOfFaces=s?this.switchEndainness(i[10]):i[10],this.numberOfMipmapLevels=s?this.switchEndainness(i[11]):i[11],this.bytesOfKeyValueData=s?this.switchEndainness(i[12]):i[12],0===this.glType?(this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels),0!==this.pixelHeight&&0===this.pixelDepth?0===this.numberOfArrayElements?this.numberOfFaces===t?this.loadType=h.COMPRESSED_2D:console.warn("number of faces expected"+t+", but found "+this.numberOfFaces):console.warn("texture arrays not currently supported"):console.warn("only 2D textures currently supported")):console.warn("only compressed formats currently supported")}else console.error("texture missing KTX identifier")}return h.prototype.switchEndainness=function(e){return(255&e)<<24|(65280&e)<<8|e>>8&65280|e>>24&255},h.prototype.mipmaps=function(e){for(var t=[],r=h.HEADER_LEN+this.bytesOfKeyValueData,a=this.pixelWidth,n=this.pixelHeight,i=e?this.numberOfMipmapLevels:1,s=0;s<i;s++){for(var o=new Int32Array(this.arrayBuffer,r,1)[0],l=0;l<this.numberOfFaces;l++){var u=new Uint8Array(this.arrayBuffer,r+4,o);t.push({data:u,width:a,height:n}),r+=o+4,r+=3-(o+3)%4}a=Math.max(1,.5*a),n=Math.max(1,.5*n)}return t},h.HEADER_LEN=64,h.COMPRESSED_2D=0,h.COMPRESSED_3D=1,h.TEX_2D=2,h.TEX_3D=3,h}();void 0===TONG.LoaderSupport&&(TONG.LoaderSupport={}),TONG.LoaderSupport.Validator={isValid:function(e){return null!=e},verifyInput:function(e,t){return null==e?t:e}},TONG.LoaderSupport.Callbacks=function(){var t=TONG.LoaderSupport.Validator;function e(){this.onProgress=null,this.onMeshAlter=null,this.onLoad=null,this.onLoadMaterials=null}return e.prototype.setCallbackOnProgress=function(e){this.onProgress=t.verifyInput(e,this.onProgress)},e.prototype.setCallbackOnMeshAlter=function(e){this.onMeshAlter=t.verifyInput(e,this.onMeshAlter)},e.prototype.setCallbackOnLoad=function(e){this.onLoad=t.verifyInput(e,this.onLoad)},e.prototype.setCallbackOnLoadMaterials=function(e){this.onLoadMaterials=t.verifyInput(e,this.onLoadMaterials)},e}(),TONG.LoaderSupport.LoadedMeshUserOverride=function(){function e(e,t){this.disregardMesh=!0===e,this.alteredMesh=!0===t,this.meshes=[]}return e.prototype.addMesh=function(e){this.meshes.push(e),this.alteredMesh=!0},e.prototype.isDisregardMesh=function(){return this.disregardMesh},e.prototype.providesAlteredMeshes=function(){return this.alteredMesh},e}(),TONG.LoaderSupport.ResourceDescriptor=function(){var a=TONG.LoaderSupport.Validator;function e(e,t){var r=e.split("/");r.length<2?(this.path=null,this.name=e):(this.path=a.verifyInput(r.slice(0,r.length-1).join("/")+"/",null),this.name=r[r.length-1]),this.url=e,this.name=a.verifyInput(this.name,"Unnamed_Resource"),this.extension=a.verifyInput(t,"default"),this.extension=this.extension.trim(),this.content=null}return e.prototype.setContent=function(e){this.content=a.verifyInput(e,null)},e}(),TONG.LoaderSupport.PrepData=function(){var l=TONG.LoaderSupport.Validator;function e(e){this.logging={enabled:!0,debug:!1},this.modelName=l.verifyInput(e,""),this.resources=[],this.callbacks=new TONG.LoaderSupport.Callbacks}return e.prototype.setLogging=function(e,t){this.logging.enabled=!0===e,this.logging.debug=!0===t},e.prototype.getCallbacks=function(){return this.callbacks},e.prototype.addResource=function(e){this.resources.push(e)},e.prototype.clone=function(){var e,t,r=new TONG.LoaderSupport.PrepData(this.modelName);for(e in r.logging.enabled=this.logging.enabled,r.logging.debug=this.logging.debug,r.resources=this.resources,r.callbacks=this.callbacks,this)t=this[e],r.hasOwnProperty(e)||"function"==typeof this[e]||(r[e]=t);return r},e.prototype.checkResourceDescriptorFiles=function(e,t){var r,a,n,i,s={};for(var o in e)if(r=e[o],i=!1,l.isValid(r.name))if(l.isValid(r.content)){for(n=0;n<t.length&&!i;n++)if(a=t[n],r.extension.toLowerCase()===a.ext.toLowerCase())if(a.ignore)i=!0;else if("ArrayBuffer"===a.type){if(!(r.content instanceof ArrayBuffer||r.content instanceof Uint8Array))throw"Provided content is not of type ArrayBuffer! Aborting...";s[a.ext]=r,i=!0}else if("String"===a.type){if(!("string"==typeof r.content||r.content instanceof String))throw"Provided  content is not of type String! Aborting...";s[a.ext]=r,i=!0}if(!i)throw'Unidentified resource "'+r.name+'": '+r.url}else{if(!("string"==typeof r.name||r.name instanceof String))throw"Provided file is not properly defined! Aborting...";for(n=0;n<t.length&&!i;n++)a=t[n],r.extension.toLowerCase()===a.ext.toLowerCase()&&(a.ignore||(s[a.ext]=r),i=!0);if(!i)throw'Unidentified resource "'+r.name+'": '+r.url}return s},e}(),TONG.LoaderSupport.MeshBuilder=function(){var _=TONG.LoaderSupport.Validator;function e(){console.info("Using TONG.LoaderSupport.MeshBuilder version: 1.2.1"),this.logging={enabled:!0,debug:!1},this.callbacks=new TONG.LoaderSupport.Callbacks,this.materials=[]}return e.prototype.setLogging=function(e,t){this.logging.enabled=!0===e,this.logging.debug=!0===t},e.prototype.init=function(){var e=new TONG.MeshStandardMaterial({color:14479871});e.name="defaultMaterial";var t=new TONG.MeshStandardMaterial({color:14479871});t.name="defaultVertexColorMaterial",t.vertexColors=TONG.VertexColors;var r=new TONG.LineBasicMaterial;r.name="defaultLineMaterial";var a=new TONG.PointsMaterial({size:1});a.name="defaultPointMaterial";var n={};n[e.name]=e,n[t.name]=t,n[r.name]=r,n[a.name]=a,this.updateMaterials({cmd:"materialData",materials:{materialCloneInstructions:null,serializedMaterials:null,runtimeMaterials:n}})},e.prototype.setMaterials=function(e){var t={cmd:"materialData",materials:{materialCloneInstructions:null,serializedMaterials:null,runtimeMaterials:_.isValid(this.callbacks.onLoadMaterials)?this.callbacks.onLoadMaterials(e):e}};this.updateMaterials(t)},e.prototype._setCallbacks=function(e){_.isValid(e.onProgress)&&this.callbacks.setCallbackOnProgress(e.onProgress),_.isValid(e.onMeshAlter)&&this.callbacks.setCallbackOnMeshAlter(e.onMeshAlter),_.isValid(e.onLoad)&&this.callbacks.setCallbackOnLoad(e.onLoad),_.isValid(e.onLoadMaterials)&&this.callbacks.setCallbackOnLoadMaterials(e.onLoadMaterials)},e.prototype.processPayload=function(e){return"meshData"===e.cmd?this.buildMeshes(e):"materialData"===e.cmd?(this.updateMaterials(e),null):void 0},e.prototype.buildMeshes=function(e){var t,r,a,n=e.params.meshName,i=new TONG.BufferGeometry;i.addAttribute("position",new TONG.BufferAttribute(new Float32Array(e.buffers.vertices),3)),_.isValid(e.buffers.indices)&&i.setIndex(new TONG.BufferAttribute(new Uint32Array(e.buffers.indices),1)),_.isValid(e.buffers.colors)&&i.addAttribute("color",new TONG.BufferAttribute(new Float32Array(e.buffers.colors),3)),_.isValid(e.buffers.normals)?i.addAttribute("normal",new TONG.BufferAttribute(new Float32Array(e.buffers.normals),3)):i.computeVertexNormals(),_.isValid(e.buffers.uvs)&&i.addAttribute("uv",new TONG.BufferAttribute(new Float32Array(e.buffers.uvs),2));var s=e.materials.materialNames,o=e.materials.multiMaterial,l=[];for(a in s)r=s[a],t=this.materials[r],o&&l.push(t);if(o){t=l;var u,h=e.materials.materialGroups;for(a in h)u=h[a],i.addGroup(u.start,u.count,u.index)}var c,d,f,p=[],m=this.callbacks.onMeshAlter,g=!0,v=_.verifyInput(e.geometryType,0);if(_.isValid(m)&&(d=m({detail:{meshName:n,bufferGeometry:i,material:t,geometryType:v}}),_.isValid(d)))if(d.isDisregardMesh())g=!1;else if(d.providesAlteredMeshes()){for(var y in d.meshes)p.push(d.meshes[y]);g=!1}if(g&&(e.computeBoundingSphere&&i.computeBoundingSphere(),(c=0===v?new TONG.Mesh(i,t):1===v?new TONG.LineSegments(i,t):new TONG.Points(i,t)).name=n,p.push(c)),_.isValid(p)&&0<p.length){var T=[];for(var y in p)c=p[y],T[y]=c.name;f="Adding mesh(es) ("+T.length+": "+T+") from input mesh: "+n,f+=" ("+(100*e.progress.numericalValue).toFixed(2)+"%)"}else f="Not adding mesh: "+n,f+=" ("+(100*e.progress.numericalValue).toFixed(2)+"%)";var b=this.callbacks.onProgress;_.isValid(b)&&b(new CustomEvent("MeshBuilderEvent",{detail:{type:"progress",modelName:e.params.meshName,text:f,numericalValue:e.progress.numericalValue}}));return p},e.prototype.updateMaterials=function(e){var t,r,a=e.materials.materialCloneInstructions;if(_.isValid(a)){var n=a.materialNameOrg,i=this.materials[n];if(_.isValid(n)){t=i.clone(),r=a.materialName,t.name=r;var s=a.materialProperties;for(var o in s)t.hasOwnProperty(o)&&s.hasOwnProperty(o)&&(t[o]=s[o]);this.materials[r]=t}else console.warn('Requested material "'+n+'" is not available!')}var l=e.materials.serializedMaterials;if(_.isValid(l)&&0<Object.keys(l).length){var u,h=new TONG.MaterialLoader;for(r in l)u=l[r],_.isValid(u)&&(t=h.parse(u),this.logging.enabled&&console.info('De-serialized material with name "'+r+'" will be added.'),this.materials[r]=t)}if(l=e.materials.runtimeMaterials,_.isValid(l)&&0<Object.keys(l).length)for(r in l)t=l[r],this.logging.enabled&&console.info('Material with name "'+r+'" will be added.'),this.materials[r]=t},e.prototype.getMaterialsJSON=function(){var e,t={};for(var r in this.materials)e=this.materials[r],t[r]=e.toJSON();return t},e.prototype.getMaterials=function(){return this.materials},e}(),TONG.LoaderSupport.WorkerRunnerRefImpl=function(){function e(){var t=this;self.addEventListener("message",function(e){t.processMessage(e.data)},!1)}return e.prototype.applyProperties=function(e,t){var r,a,n;for(r in t)a="set"+r.substring(0,1).toLocaleUpperCase()+r.substring(1),n=t[r],"function"==typeof e[a]?e[a](n):e.hasOwnProperty(r)&&(e[r]=n)},e.prototype.processMessage=function(t){if("run"===t.cmd){var e={callbackMeshBuilder:function(e){self.postMessage(e)},callbackProgress:function(e){t.logging.enabled&&t.logging.debug&&console.debug("WorkerRunner: progress: "+e)}},r=new Parser;"function"==typeof r.setLogging&&r.setLogging(t.logging.enabled,t.logging.debug),this.applyProperties(r,t.params),this.applyProperties(r,t.materials),this.applyProperties(r,e),r.workerScope=self,r.parse(t.data.input,t.data.options),t.logging.enabled&&console.log("WorkerRunner: Run complete!"),e.callbackMeshBuilder({cmd:"complete",msg:"WorkerRunner completed run."})}else console.error("WorkerRunner: Received unknown command: "+t.cmd)},e}(),TONG.LoaderSupport.WorkerSupport=function(){var c=TONG.LoaderSupport.Validator,e=function(){function e(){this._reset()}return e.prototype._reset=function(){this.logging={enabled:!0,debug:!1},this.worker=null,this.runnerImplName=null,this.callbacks={meshBuilder:null,onLoad:null},this.terminateRequested=!1,this.queuedMessage=null,this.started=!1,this.forceCopy=!1},e.prototype.setLogging=function(e,t){this.logging.enabled=!0===e,this.logging.debug=!0===t},e.prototype.setForceCopy=function(e){this.forceCopy=!0===e},e.prototype.initWorker=function(e,t){this.runnerImplName=t;var r=new Blob([e],{type:"application/javascript"});this.worker=new Worker(window.URL.createObjectURL(r)),this.worker.onmessage=this._receiveWorkerMessage,(this.worker.runtimeRef=this)._postMessage()},e.prototype._receiveWorkerMessage=function(e){var t=e.data;switch(t.cmd){case"meshData":case"materialData":case"imageData":this.runtimeRef.callbacks.meshBuilder(t);break;case"complete":this.runtimeRef.queuedMessage=null,this.started=!1,this.runtimeRef.callbacks.onLoad(t.msg),this.runtimeRef.terminateRequested&&(this.runtimeRef.logging.enabled&&console.info("WorkerSupport ["+this.runtimeRef.runnerImplName+"]: Run is complete. Terminating application on request!"),this.runtimeRef._terminate());break;case"error":console.error("WorkerSupport ["+this.runtimeRef.runnerImplName+"]: Reported error: "+t.msg),this.runtimeRef.queuedMessage=null,this.started=!1,this.runtimeRef.callbacks.onLoad(t.msg),this.runtimeRef.terminateRequested&&(this.runtimeRef.logging.enabled&&console.info("WorkerSupport ["+this.runtimeRef.runnerImplName+"]: Run reported error. Terminating application on request!"),this.runtimeRef._terminate());break;default:console.error("WorkerSupport ["+this.runtimeRef.runnerImplName+"]: Received unknown command: "+t.cmd)}},e.prototype.setCallbacks=function(e,t){this.callbacks.meshBuilder=c.verifyInput(e,this.callbacks.meshBuilder),this.callbacks.onLoad=c.verifyInput(t,this.callbacks.onLoad)},e.prototype.run=function(e){if(c.isValid(this.queuedMessage))console.warn("Already processing message. Rejecting new run instruction");else{if(this.queuedMessage=e,this.started=!0,!c.isValid(this.callbacks.meshBuilder))throw'Unable to run as no "MeshBuilder" callback is set.';if(!c.isValid(this.callbacks.onLoad))throw'Unable to run as no "onLoad" callback is set.';"run"!==e.cmd&&(e.cmd="run"),c.isValid(e.logging)?(e.logging.enabled=!0===e.logging.enabled,e.logging.debug=!0===e.logging.debug):e.logging={enabled:!0,debug:!1},this._postMessage()}},e.prototype._postMessage=function(){var e;c.isValid(this.queuedMessage)&&c.isValid(this.worker)&&(this.queuedMessage.data.input instanceof ArrayBuffer?(e=this.forceCopy?this.queuedMessage.data.input.slice(0):this.queuedMessage.data.input,this.worker.postMessage(this.queuedMessage,[e])):this.worker.postMessage(this.queuedMessage))},e.prototype.setTerminateRequested=function(e){this.terminateRequested=!0===e,this.terminateRequested&&c.isValid(this.worker)&&!c.isValid(this.queuedMessage)&&this.started&&(this.logging.enabled&&console.info("Worker is terminated immediately as it is not running!"),this._terminate())},e.prototype._terminate=function(){this.worker.terminate(),this._reset()},e}();function t(){if(console.info("Using TONG.LoaderSupport.WorkerSupport version: 2.2.0"),this.logging={enabled:!0,debug:!1},void 0===window.Worker)throw"This browser does not support web workers!";if(void 0===window.Blob)throw"This browser does not support Blob!";if("function"!=typeof window.URL.createObjectURL)throw"This browser does not support Object creation from URL!";this.loaderWorker=new e}t.prototype.setLogging=function(e,t){this.logging.enabled=!0===e,this.logging.debug=!0===t,this.loaderWorker.setLogging(this.logging.enabled,this.logging.debug)},t.prototype.setForceWorkerDataCopy=function(e){this.loaderWorker.setForceCopy(e)},t.prototype.validate=function(e,t,r,a,n){if(!c.isValid(this.loaderWorker.worker)){this.logging.enabled&&(console.info("WorkerSupport: Building worker code..."),console.time("buildWebWorkerCode")),c.isValid(n)?this.logging.enabled&&console.info('WorkerSupport: Using "'+n.name+'" as Runner class for worker.'):(n=TONG.LoaderSupport.WorkerRunnerRefImpl,this.logging.enabled&&console.info('WorkerSupport: Using DEFAULT "TONG.LoaderSupport.WorkerRunnerRefImpl" as Runner class for worker.'));var i=e(u,h);i+="var Parser = "+t+";\n\n",i+=h(n.name,n),i+="new "+n.name+"();\n\n";var s=this;if(c.isValid(r)&&0<r.length){var o="",l=function(t,r){if(0===r.length)s.loaderWorker.initWorker(o+i,n.name),s.logging.enabled&&console.timeEnd("buildWebWorkerCode");else{var e=new TONG.FileLoader;e.setPath(t),e.setResponseType("text"),e.load(r[0],function(e){o+=e,l(t,r)}),r.shift()}};l(a,r)}else this.loaderWorker.initWorker(i,n.name),this.logging.enabled&&console.timeEnd("buildWebWorkerCode")}},t.prototype.setCallbacks=function(e,t){this.loaderWorker.setCallbacks(e,t)},t.prototype.run=function(e){this.loaderWorker.run(e)},t.prototype.setTerminateRequested=function(e){this.loaderWorker.setTerminateRequested(e)};var u=function(e,t){var r,a=e+" = {\n";for(var n in t)"string"==typeof(r=t[n])||r instanceof String?a+="\t"+n+': "'+(r=(r=r.replace("\n","\\n")).replace("\r","\\r"))+'",\n':r instanceof Array?a+="\t"+n+": ["+r+"],\n":Number.isInteger(r)?a+="\t"+n+": "+r+",\n":"function"==typeof r&&(a+="\t"+n+": "+r+",\n");return a+="}\n\n"},h=function(e,t,r,a,n){var i,s,o="",l=c.isValid(r)?r:t.name;for(var u in n=c.verifyInput(n,[]),t.prototype)i=t.prototype[u],"constructor"===u?s="\tfunction "+l+i.toString().replace("function","")+";\n\n":"function"==typeof i&&n.indexOf(u)<0&&(o+="\t"+l+".prototype."+u+" = "+i.toString()+";\n\n");o+="\treturn "+l+";\n",o+="})();\n\n";var h="";return c.isValid(a)&&(h+="\n",h+=l+".prototype = Object.create( "+a+".prototype );\n",h+=l+".constructor = "+l+";\n",h+="\n"),c.isValid(s)?o=e+" = (function () {\n\n"+h+s+o:(s=e+" = (function () {\n\n",o=(s+=h+"\t"+t.prototype.constructor.toString()+"\n\n")+o),o};return t}(),TONG.LoaderSupport.WorkerDirector=function(){var s=TONG.LoaderSupport.Validator;function e(e){if(console.info("Using TONG.LoaderSupport.WorkerDirector version: 2.2.1"),this.logging={enabled:!0,debug:!1},this.maxQueueSize=8192,this.maxWebWorkers=16,this.crossOrigin="anonymous",!s.isValid(e))throw"Provided invalid classDef: "+e;this.workerDescription={classDef:e,globalCallbacks:{},workerSupports:{},forceWorkerDataCopy:!0},this.objectsCompleted=0,this.instructionQueue=[],this.instructionQueuePointer=0,this.callbackOnFinishedProcessing=null}return e.prototype.setLogging=function(e,t){this.logging.enabled=!0===e,this.logging.debug=!0===t},e.prototype.getMaxQueueSize=function(){return this.maxQueueSize},e.prototype.getMaxWebWorkers=function(){return this.maxWebWorkers},e.prototype.setCrossOrigin=function(e){this.crossOrigin=e},e.prototype.setForceWorkerDataCopy=function(e){this.workerDescription.forceWorkerDataCopy=!0===e},e.prototype.prepareWorkers=function(e,t,r){s.isValid(e)&&(this.workerDescription.globalCallbacks=e),this.maxQueueSize=Math.min(t,8192),this.maxWebWorkers=Math.min(r,16),this.maxWebWorkers=Math.min(this.maxWebWorkers,this.maxQueueSize),this.objectsCompleted=0,this.instructionQueue=[];for(var a=this.instructionQueuePointer=0;a<this.maxWebWorkers;a++){var n=new TONG.LoaderSupport.WorkerSupport;n.setLogging(this.logging.enabled,this.logging.debug),n.setForceWorkerDataCopy(this.workerDescription.forceWorkerDataCopy),this.workerDescription.workerSupports[a]={instanceNo:a,inUse:!1,terminateRequested:!1,workerSupport:n,loader:null}}},e.prototype.enqueueForRun=function(e){this.instructionQueue.length<this.maxQueueSize&&this.instructionQueue.push(e)},e.prototype.isRunning=function(){var e=Object.keys(this.workerDescription.workerSupports);return 0<this.instructionQueue.length&&this.instructionQueuePointer<this.instructionQueue.length||0<e.length},e.prototype.processQueue=function(){var e,t;for(var r in this.workerDescription.workerSupports)(t=this.workerDescription.workerSupports[r]).inUse||(this.instructionQueuePointer<this.instructionQueue.length?(e=this.instructionQueue[this.instructionQueuePointer],this._kickWorkerRun(e,t),this.instructionQueuePointer++):this._deregister(t));this.isRunning()||null===this.callbackOnFinishedProcessing||(this.callbackOnFinishedProcessing(),this.callbackOnFinishedProcessing=null)},e.prototype._kickWorkerRun=function(e,t){t.inUse=!0,t.workerSupport.setTerminateRequested(t.terminateRequested),this.logging.enabled&&console.info("\nAssigning next item from queue to worker (queue length: "+this.instructionQueue.length+")\n\n");var r=this,a=e.getCallbacks(),n=this.workerDescription.globalCallbacks;t.loader=this._buildLoader(t.instanceNo);var i=new TONG.LoaderSupport.Callbacks;i.setCallbackOnLoad(function(e){s.isValid(n.onLoad)&&n.onLoad(e),s.isValid(a.onLoad)&&a.onLoad(e),r.objectsCompleted++,t.inUse=!1,r.processQueue()}),i.setCallbackOnProgress(function(e){s.isValid(n.onProgress)&&n.onProgress(e),s.isValid(a.onProgress)&&a.onProgress(e)}),i.setCallbackOnMeshAlter(function(e,t){return s.isValid(n.onMeshAlter)&&(t=n.onMeshAlter(e,t)),s.isValid(a.onMeshAlter)&&(t=n.onMeshAlter(e,t)),t}),i.setCallbackOnLoadMaterials(function(e){return s.isValid(n.onLoadMaterials)&&(e=n.onLoadMaterials(e)),s.isValid(a.onLoadMaterials)&&(e=a.onLoadMaterials(e)),e}),e.callbacks=i,t.loader.run(e,t.workerSupport)},e.prototype._buildLoader=function(e){var t=this.workerDescription.classDef,r=Object.create(t.prototype);if(t.call(r,TONG.DefaultLoadingManager),!r.hasOwnProperty("instanceNo"))throw t.name+' has no property "instanceNo".';if(r.instanceNo=e,!r.hasOwnProperty("workerSupport"))throw t.name+' has no property "workerSupport".';if("function"!=typeof r.run)throw t.name+' has no function "run".';return r.hasOwnProperty("callbacks")&&s.isValid(r.callbacks)||(console.warn(t.name+' has an invalid property "callbacks". Will change to "TONG.LoaderSupport.Callbacks"'),r.callbacks=new TONG.LoaderSupport.Callbacks),r},e.prototype._deregister=function(e){if(s.isValid(e)){e.workerSupport.setTerminateRequested(!0),this.logging.enabled&&console.info("Requested termination of worker #"+e.instanceNo+".");var t=e.loader.callbacks;s.isValid(t.onProgress)&&t.onProgress({detail:{text:""}}),delete this.workerDescription.workerSupports[e.instanceNo]}},e.prototype.tearDown=function(e){for(var t in this.logging.enabled&&console.info("WorkerDirector received the deregister call. Terminating all workers!"),this.instructionQueuePointer=this.instructionQueue.length,this.callbackOnFinishedProcessing=s.verifyInput(e,null),this.workerDescription.workerSupports)this.workerDescription.workerSupports[t].terminateRequested=!0},e}(),TONG.MTLLoader=function(e){this.manager=void 0!==e?e:TONG.DefaultLoadingManager},TONG.MTLLoader.prototype={constructor:TONG.MTLLoader,load:function(e,t,r,a){var n=this,i=new TONG.FileLoader(this.manager);i.setPath(this.path),i.load(e,function(e){t(n.parse(e))},r,a)},setPath:function(e){return this.path=e,this},setTexturePath:function(e){return this.texturePath=e,this},setBaseUrl:function(e){return console.warn("TONG.MTLLoader: .setBaseUrl() is deprecated. Use .setTexturePath( path ) for texture path or .setPath( path ) for general base path instead."),this.setTexturePath(e)},setCrossOrigin:function(e){return this.crossOrigin=e,this},setMaterialOptions:function(e){return this.materialOptions=e,this},parse:function(e){for(var t=e.split("\n"),r={},a=/\s+/,n={},i=0;i<t.length;i++){var s=t[i];if(0!==(s=s.trim()).length&&"#"!==s.charAt(0)){var o=s.indexOf(" "),l=0<=o?s.substring(0,o):s;l=l.toLowerCase();var u=0<=o?s.substring(o+1):"";if(u=u.trim(),"newmtl"===l)r={name:u},n[u]=r;else if(r)if("ka"===l||"kd"===l||"ks"===l){var h=u.split(a,3);r[l]=[parseFloat(h[0]),parseFloat(h[1]),parseFloat(h[2])]}else r[l]=u}}var c=new TONG.MTLLoader.MaterialCreator(this.texturePath||this.path,this.materialOptions);return c.setCrossOrigin(this.crossOrigin),c.setManager(this.manager),c.setMaterials(n),c}},TONG.MTLLoader.MaterialCreator=function(e,t){this.baseUrl=e||"",this.options=t,this.materialsInfo={},this.materials={},this.materialsArray=[],this.nameLookup={},this.side=this.options&&this.options.side?this.options.side:TONG.FrontSide,this.wrap=this.options&&this.options.wrap?this.options.wrap:TONG.RepeatWrapping},TONG.MTLLoader.MaterialCreator.prototype={constructor:TONG.MTLLoader.MaterialCreator,crossOrigin:"anonymous",setCrossOrigin:function(e){return this.crossOrigin=e,this},setManager:function(e){this.manager=e},setMaterials:function(e){this.materialsInfo=this.convert(e),this.materials={},this.materialsArray=[],this.nameLookup={}},convert:function(e){if(!this.options)return e;var t={};for(var r in e){var a=e[r],n={};for(var i in t[r]=n,a){var s=!0,o=a[i],l=i.toLowerCase();switch(l){case"kd":case"ka":case"ks":this.options&&this.options.normalizeRGB&&(o=[o[0]/255,o[1]/255,o[2]/255]),this.options&&this.options.ignoreZeroRGBs&&0===o[0]&&0===o[1]&&0===o[2]&&(s=!1)}s&&(n[l]=o)}}return t},preload:function(){for(var e in this.materialsInfo)this.create(e)},getIndex:function(e){return this.nameLookup[e]},getAsArray:function(){var e=0;for(var t in this.materialsInfo)this.materialsArray[e]=this.create(t),this.nameLookup[t]=e,e++;return this.materialsArray},create:function(e){return void 0===this.materials[e]&&this.createMaterial_(e),this.materials[e]},createMaterial_:function(e){var s=this,t=this.materialsInfo[e],o={name:e,side:this.side};function r(e,t){if(!o[e]){var r,a,n=s.getTextureParams(t,o),i=s.loadTexture((r=s.baseUrl,"string"!=typeof(a=n.url)||""===a?"":/^https?:\/\//i.test(a)?a:r+a));i.repeat.copy(n.scale),i.offset.copy(n.offset),i.wrapS=s.wrap,i.wrapT=s.wrap,o[e]=i}}for(var a in t){var n,i=t[a];if(""!==i)switch(a.toLowerCase()){case"kd":o.color=(new TONG.Color).fromArray(i);break;case"ks":o.specular=(new TONG.Color).fromArray(i);break;case"map_kd":r("map",i);break;case"map_ks":r("specularMap",i);break;case"norm":r("normalMap",i);break;case"map_bump":case"bump":r("bumpMap",i);break;case"ns":o.shininess=parseFloat(i);break;case"d":(n=parseFloat(i))<1&&(o.opacity=n,o.transparent=!0);break;case"tr":n=parseFloat(i),this.options&&this.options.invertTrProperty&&(n=1-n),0<n&&(o.opacity=1-n,o.transparent=!0)}}return this.materials[e]=new TONG.MeshPhongMaterial(o),this.materials[e]},getTextureParams:function(e,t){var r,a={scale:new TONG.Vector2(1,1),offset:new TONG.Vector2(0,0)},n=e.split(/\s+/);return 0<=(r=n.indexOf("-bm"))&&(t.bumpScale=parseFloat(n[r+1]),n.splice(r,2)),0<=(r=n.indexOf("-s"))&&(a.scale.set(parseFloat(n[r+1]),parseFloat(n[r+2])),n.splice(r,4)),0<=(r=n.indexOf("-o"))&&(a.offset.set(parseFloat(n[r+1]),parseFloat(n[r+2])),n.splice(r,4)),a.url=n.join(" ").trim(),a},loadTexture:function(e,t,r,a,n){var i,s=TONG.Loader.Handlers.get(e),o=void 0!==this.manager?this.manager:TONG.DefaultLoadingManager;return null===s&&(s=new TONG.TextureLoader(o)),s.setCrossOrigin&&s.setCrossOrigin(this.crossOrigin),i=s.load(e,r,a,n),void 0!==t&&(i.mapping=t),i}},TONG.KMZLoader=function(e){this.manager=void 0!==e?e:TONG.DefaultLoadingManager},TONG.KMZLoader.prototype={constructor:TONG.KMZLoader,load:function(e,t,r,a){var n=this,i=new TONG.FileLoader(n.manager);i.setResponseType("arraybuffer"),i.load(e,function(e){t(n.parse(e))},r,a)},parse:function(e){var s=new JSZip(e);function t(e){var t=decodeURI(e.init_from);t=t.replace("../","");var r=new RegExp(t+"$"),a=s.file(r);if(a.length){var n=a[0],i=new Blob([n.asArrayBuffer()],{type:"application/octet-binary"});e.build.src=URL.createObjectURL(i)}}var r=s.file(/dae$/i);if(r.length){var a=r[0],n=(new TONG.ColladaLoader).parse(a.asText()),i=n.library.images;for(var o in i)t(i[o]);return n}return console.error("KMZLoader: Couldn't find .dae file."),{scene:new TONG.Group}}},TONG.MD2Loader=function(e){this.manager=void 0!==e?e:TONG.DefaultLoadingManager},TONG.MD2Loader.prototype={constructor:TONG.MD2Loader,load:function(e,t,r,a){var n=this,i=new TONG.FileLoader(n.manager);i.setResponseType("arraybuffer"),i.load(e,function(e){t(n.parse(e))},r,a)},parse:function(){var L=[[-.525731,0,.850651],[-.442863,.238856,.864188],[-.295242,0,.955423],[-.309017,.5,.809017],[-.16246,.262866,.951056],[0,0,1],[0,.850651,.525731],[-.147621,.716567,.681718],[.147621,.716567,.681718],[0,.525731,.850651],[.309017,.5,.809017],[.525731,0,.850651],[.295242,0,.955423],[.442863,.238856,.864188],[.16246,.262866,.951056],[-.681718,.147621,.716567],[-.809017,.309017,.5],[-.587785,.425325,.688191],[-.850651,.525731,0],[-.864188,.442863,.238856],[-.716567,.681718,.147621],[-.688191,.587785,.425325],[-.5,.809017,.309017],[-.238856,.864188,.442863],[-.425325,.688191,.587785],[-.716567,.681718,-.147621],[-.5,.809017,-.309017],[-.525731,.850651,0],[0,.850651,-.525731],[-.238856,.864188,-.442863],[0,.955423,-.295242],[-.262866,.951056,-.16246],[0,1,0],[0,.955423,.295242],[-.262866,.951056,.16246],[.238856,.864188,.442863],[.262866,.951056,.16246],[.5,.809017,.309017],[.238856,.864188,-.442863],[.262866,.951056,-.16246],[.5,.809017,-.309017],[.850651,.525731,0],[.716567,.681718,.147621],[.716567,.681718,-.147621],[.525731,.850651,0],[.425325,.688191,.587785],[.864188,.442863,.238856],[.688191,.587785,.425325],[.809017,.309017,.5],[.681718,.147621,.716567],[.587785,.425325,.688191],[.955423,.295242,0],[1,0,0],[.951056,.16246,.262866],[.850651,-.525731,0],[.955423,-.295242,0],[.864188,-.442863,.238856],[.951056,-.16246,.262866],[.809017,-.309017,.5],[.681718,-.147621,.716567],[.850651,0,.525731],[.864188,.442863,-.238856],[.809017,.309017,-.5],[.951056,.16246,-.262866],[.525731,0,-.850651],[.681718,.147621,-.716567],[.681718,-.147621,-.716567],[.850651,0,-.525731],[.809017,-.309017,-.5],[.864188,-.442863,-.238856],[.951056,-.16246,-.262866],[.147621,.716567,-.681718],[.309017,.5,-.809017],[.425325,.688191,-.587785],[.442863,.238856,-.864188],[.587785,.425325,-.688191],[.688191,.587785,-.425325],[-.147621,.716567,-.681718],[-.309017,.5,-.809017],[0,.525731,-.850651],[-.525731,0,-.850651],[-.442863,.238856,-.864188],[-.295242,0,-.955423],[-.16246,.262866,-.951056],[0,0,-1],[.295242,0,-.955423],[.16246,.262866,-.951056],[-.442863,-.238856,-.864188],[-.309017,-.5,-.809017],[-.16246,-.262866,-.951056],[0,-.850651,-.525731],[-.147621,-.716567,-.681718],[.147621,-.716567,-.681718],[0,-.525731,-.850651],[.309017,-.5,-.809017],[.442863,-.238856,-.864188],[.16246,-.262866,-.951056],[.238856,-.864188,-.442863],[.5,-.809017,-.309017],[.425325,-.688191,-.587785],[.716567,-.681718,-.147621],[.688191,-.587785,-.425325],[.587785,-.425325,-.688191],[0,-.955423,-.295242],[0,-1,0],[.262866,-.951056,-.16246],[0,-.850651,.525731],[0,-.955423,.295242],[.238856,-.864188,.442863],[.262866,-.951056,.16246],[.5,-.809017,.309017],[.716567,-.681718,.147621],[.525731,-.850651,0],[-.238856,-.864188,-.442863],[-.5,-.809017,-.309017],[-.262866,-.951056,-.16246],[-.850651,-.525731,0],[-.716567,-.681718,-.147621],[-.716567,-.681718,.147621],[-.525731,-.850651,0],[-.5,-.809017,.309017],[-.238856,-.864188,.442863],[-.262866,-.951056,.16246],[-.864188,-.442863,.238856],[-.809017,-.309017,.5],[-.688191,-.587785,.425325],[-.681718,-.147621,.716567],[-.442863,-.238856,.864188],[-.587785,-.425325,.688191],[-.309017,-.5,.809017],[-.147621,-.716567,.681718],[-.425325,-.688191,.587785],[-.16246,-.262866,.951056],[.442863,-.238856,.864188],[.16246,-.262866,.951056],[.309017,-.5,.809017],[.147621,-.716567,.681718],[0,-.525731,.850651],[.425325,-.688191,.587785],[.587785,-.425325,.688191],[.688191,-.587785,.425325],[-.955423,.295242,0],[-.951056,.16246,.262866],[-1,0,0],[-.850651,0,.525731],[-.955423,-.295242,0],[-.951056,-.16246,.262866],[-.864188,.442863,-.238856],[-.951056,.16246,-.262866],[-.809017,.309017,-.5],[-.864188,-.442863,-.238856],[-.951056,-.16246,-.262866],[-.809017,-.309017,-.5],[-.681718,.147621,-.716567],[-.681718,-.147621,-.716567],[-.850651,0,-.525731],[-.688191,.587785,-.425325],[-.587785,.425325,-.688191],[-.425325,.688191,-.587785],[-.425325,-.688191,-.587785],[-.587785,-.425325,-.688191],[-.688191,-.587785,-.425325]];return function(e){console.time("MD2Loader");for(var t=new DataView(e),r={},a=["ident","version","skinwidth","skinheight","framesize","num_skins","num_vertices","num_st","num_tris","num_glcmds","num_frames","offset_skins","offset_st","offset_tris","offset_frames","offset_glcmds","offset_end"],n=0;n<a.length;n++)r[a[n]]=t.getInt32(4*n,!0);if(844121161===r.ident&&8===r.version){if(r.offset_end===t.byteLength){for(var i=new TONG.Geometry,s=[],o=r.offset_st,l=(n=0,r.num_st);n<l;n++){var u=t.getInt16(o+0,!0),h=t.getInt16(o+2,!0);s.push(new TONG.Vector2(u/r.skinwidth,1-h/r.skinheight)),o+=4}for(o=r.offset_tris,n=0,l=r.num_tris;n<l;n++){var c=t.getUint16(o+0,!0),d=t.getUint16(o+2,!0),f=t.getUint16(o+4,!0);i.faces.push(new TONG.Face3(c,d,f)),i.faceVertexUvs[0].push([s[t.getUint16(o+6,!0)],s[t.getUint16(o+8,!0)],s[t.getUint16(o+10,!0)]]),o+=12}var p=new TONG.Vector3,m=new TONG.Vector3,g=[];for(o=r.offset_frames,n=0,l=r.num_frames;n<l;n++){m.set(t.getFloat32(o+0,!0),t.getFloat32(o+4,!0),t.getFloat32(o+8,!0)),p.set(t.getFloat32(o+12,!0),t.getFloat32(o+16,!0),t.getFloat32(o+20,!0)),o+=24;for(var v=0;v<16;v++){var y=t.getUint8(o+v,!0);if(0===y)break;g[v]=y}var T={name:String.fromCharCode.apply(null,g),vertices:[],normals:[]};o+=16;for(v=0;v<r.num_vertices;v++){var b=t.getUint8(o++,!0),_=t.getUint8(o++,!0),O=t.getUint8(o++,!0),w=L[t.getUint8(o++,!0)],N=new TONG.Vector3(b*m.x+p.x,O*m.z+p.z,_*m.y+p.y),A=new TONG.Vector3(w[0],w[2],w[1]);T.vertices.push(N),T.normals.push(A)}i.morphTargets.push(T)}i.vertices=i.morphTargets[0].vertices;for(var x=i.morphTargets[0],M=(v=0,i.faces.length);v<M;v++){(k=i.faces[v]).vertexNormals=[x.normals[k.a],x.normals[k.b],x.normals[k.c]]}for(n=0,l=i.morphTargets.length;n<l;n++){x=i.morphTargets[n];var G=[];for(v=0,M=i.faces.length;v<M;v++){var k=i.faces[v];G.push({a:x.normals[k.a],b:x.normals[k.b],c:x.normals[k.c]})}i.morphNormals.push({vertexNormals:G})}return i.animations=TONG.AnimationClip.CreateClipsFromMorphTargetSequences(i.morphTargets,10),console.timeEnd("MD2Loader"),i}console.error("Corrupted MD2 file")}else console.error("Not a valid MD2 file")}}()},TONG.OBJLoader=function(e){this.manager=void 0!==e?e:TONG.DefaultLoadingManager,this.materials=null,this.regexp={vertex_pattern:/^v\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,normal_pattern:/^vn\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,uv_pattern:/^vt\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,face_vertex:/^f\s+(-?\d+)\s+(-?\d+)\s+(-?\d+)(?:\s+(-?\d+))?/,face_vertex_uv:/^f\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+))?/,face_vertex_uv_normal:/^f\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+)\/(-?\d+))?/,face_vertex_normal:/^f\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)(?:\s+(-?\d+)\/\/(-?\d+))?/,object_pattern:/^[og]\s*(.+)?/,smoothing_pattern:/^s\s+(\d+|on|off)/,material_library_pattern:/^mtllib /,material_use_pattern:/^usemtl /}},TONG.OBJLoader.prototype={constructor:TONG.OBJLoader,load:function(e,t,r,a){var n=this,i=new TONG.FileLoader(n.manager);i.setPath(this.path),i.load(e,function(e){t(n.parse(e))},r,a)},setPath:function(e){this.path=e},setMaterials:function(e){this.materials=e},_createParserState:function(){var e={objects:[],object:{},vertices:[],normals:[],uvs:[],materialLibraries:[],startObject:function(e,t){if(this.object&&!1===this.object.fromDeclaration)return this.object.name=e,void(this.object.fromDeclaration=!1!==t);var r=this.object&&"function"==typeof this.object.currentMaterial?this.object.currentMaterial():void 0;if(this.object&&"function"==typeof this.object._finalize&&this.object._finalize(!0),this.object={name:e||"",fromDeclaration:!1!==t,geometry:{vertices:[],normals:[],uvs:[]},materials:[],smooth:!0,startMaterial:function(e,t){var r=this._finalize(!1);r&&(r.inherited||r.groupCount<=0)&&this.materials.splice(r.index,1);var a={index:this.materials.length,name:e||"",mtllib:Array.isArray(t)&&0<t.length?t[t.length-1]:"",smooth:void 0!==r?r.smooth:this.smooth,groupStart:void 0!==r?r.groupEnd:0,groupEnd:-1,groupCount:-1,inherited:!1,clone:function(e){var t={index:"number"==typeof e?e:this.index,name:this.name,mtllib:this.mtllib,smooth:this.smooth,groupStart:0,groupEnd:-1,groupCount:-1,inherited:!1};return t.clone=this.clone.bind(t),t}};return this.materials.push(a),a},currentMaterial:function(){if(0<this.materials.length)return this.materials[this.materials.length-1]},_finalize:function(e){var t=this.currentMaterial();if(t&&-1===t.groupEnd&&(t.groupEnd=this.geometry.vertices.length/3,t.groupCount=t.groupEnd-t.groupStart,t.inherited=!1),e&&1<this.materials.length)for(var r=this.materials.length-1;0<=r;r--)this.materials[r].groupCount<=0&&this.materials.splice(r,1);return e&&0===this.materials.length&&this.materials.push({name:"",smooth:this.smooth}),t}},r&&r.name&&"function"==typeof r.clone){var a=r.clone(0);a.inherited=!0,this.object.materials.push(a)}this.objects.push(this.object)},finalize:function(){this.object&&"function"==typeof this.object._finalize&&this.object._finalize(!0)},parseVertexIndex:function(e,t){var r=parseInt(e,10);return 3*(0<=r?r-1:r+t/3)},parseNormalIndex:function(e,t){var r=parseInt(e,10);return 3*(0<=r?r-1:r+t/3)},parseUVIndex:function(e,t){var r=parseInt(e,10);return 2*(0<=r?r-1:r+t/2)},addVertex:function(e,t,r){var a=this.vertices,n=this.object.geometry.vertices;n.push(a[e+0]),n.push(a[e+1]),n.push(a[e+2]),n.push(a[t+0]),n.push(a[t+1]),n.push(a[t+2]),n.push(a[r+0]),n.push(a[r+1]),n.push(a[r+2])},addVertexLine:function(e){var t=this.vertices,r=this.object.geometry.vertices;r.push(t[e+0]),r.push(t[e+1]),r.push(t[e+2])},addNormal:function(e,t,r){var a=this.normals,n=this.object.geometry.normals;n.push(a[e+0]),n.push(a[e+1]),n.push(a[e+2]),n.push(a[t+0]),n.push(a[t+1]),n.push(a[t+2]),n.push(a[r+0]),n.push(a[r+1]),n.push(a[r+2])},addUV:function(e,t,r){var a=this.uvs,n=this.object.geometry.uvs;n.push(a[e+0]),n.push(a[e+1]),n.push(a[t+0]),n.push(a[t+1]),n.push(a[r+0]),n.push(a[r+1])},addUVLine:function(e){var t=this.uvs,r=this.object.geometry.uvs;r.push(t[e+0]),r.push(t[e+1])},addFace:function(e,t,r,a,n,i,s,o,l,u,h,c){var d,f=this.vertices.length,p=this.parseVertexIndex(e,f),m=this.parseVertexIndex(t,f),g=this.parseVertexIndex(r,f);if(void 0===a?this.addVertex(p,m,g):(d=this.parseVertexIndex(a,f),this.addVertex(p,m,d),this.addVertex(m,g,d)),void 0!==n){var v=this.uvs.length;p=this.parseUVIndex(n,v),m=this.parseUVIndex(i,v),g=this.parseUVIndex(s,v),void 0===a?this.addUV(p,m,g):(d=this.parseUVIndex(o,v),this.addUV(p,m,d),this.addUV(m,g,d))}if(void 0!==l){var y=this.normals.length;p=this.parseNormalIndex(l,y),m=l===u?p:this.parseNormalIndex(u,y),g=l===h?p:this.parseNormalIndex(h,y),void 0===a?this.addNormal(p,m,g):(d=this.parseNormalIndex(c,y),this.addNormal(p,m,d),this.addNormal(m,g,d))}},addLineGeometry:function(e,t){this.object.geometry.type="Line";for(var r=this.vertices.length,a=this.uvs.length,n=0,i=e.length;n<i;n++)this.addVertexLine(this.parseVertexIndex(e[n],r));var s=0;for(i=t.length;s<i;s++)this.addUVLine(this.parseUVIndex(t[s],a))}};return e.startObject("",!1),e},parse:function(e){console.time("OBJLoader");var t=this._createParserState();-1!==e.indexOf("\r\n")&&(e=e.replace(/\r\n/g,"\n")),-1!==e.indexOf("\\\n")&&(e=e.replace(/\\\n/g,""));for(var r=e.split("\n"),a="",n="",i="",s=[],o="function"==typeof"".trimLeft,l=0,u=r.length;l<u;l++)if(a=r[l],0!==(a=o?a.trimLeft():a.trim()).length&&"#"!==(n=a.charAt(0)))if("v"===n)if(" "===(i=a.charAt(1))&&null!==(s=this.regexp.vertex_pattern.exec(a)))t.vertices.push(parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3]));else if("n"===i&&null!==(s=this.regexp.normal_pattern.exec(a)))t.normals.push(parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3]));else{if("t"!==i||null===(s=this.regexp.uv_pattern.exec(a)))throw new Error("Unexpected vertex/normal/uv line: '"+a+"'");t.uvs.push(parseFloat(s[1]),parseFloat(s[2]))}else if("f"===n)if(null!==(s=this.regexp.face_vertex_uv_normal.exec(a)))t.addFace(s[1],s[4],s[7],s[10],s[2],s[5],s[8],s[11],s[3],s[6],s[9],s[12]);else if(null!==(s=this.regexp.face_vertex_uv.exec(a)))t.addFace(s[1],s[3],s[5],s[7],s[2],s[4],s[6],s[8]);else if(null!==(s=this.regexp.face_vertex_normal.exec(a)))t.addFace(s[1],s[3],s[5],s[7],void 0,void 0,void 0,void 0,s[2],s[4],s[6],s[8]);else{if(null===(s=this.regexp.face_vertex.exec(a)))throw new Error("Unexpected face line: '"+a+"'");t.addFace(s[1],s[2],s[3],s[4])}else if("l"===n){var h=a.substring(1).trim().split(" "),c=[],d=[];if(-1===a.indexOf("/"))c=h;else for(var f=0,p=h.length;f<p;f++){var m=h[f].split("/");""!==m[0]&&c.push(m[0]),""!==m[1]&&d.push(m[1])}t.addLineGeometry(c,d)}else if(null!==(s=this.regexp.object_pattern.exec(a))){var g=(" "+s[0].substr(1).trim()).substr(1);t.startObject(g)}else if(this.regexp.material_use_pattern.test(a))t.object.startMaterial(a.substring(7).trim(),t.materialLibraries);else if(this.regexp.material_library_pattern.test(a))t.materialLibraries.push(a.substring(7).trim());else{if(null===(s=this.regexp.smoothing_pattern.exec(a))){if("\0"===a)continue;throw new Error("Unexpected line: '"+a+"'")}var v=s[1].trim().toLowerCase();t.object.smooth="1"===v||"on"===v,(k=t.object.currentMaterial())&&(k.smooth=t.object.smooth)}t.finalize();var y=new TONG.Group;y.materialLibraries=[].concat(t.materialLibraries);for(l=0,u=t.objects.length;l<u;l++){var T=t.objects[l],b=T.geometry,_=T.materials,O="Line"===b.type;if(0!==b.vertices.length){var w=new TONG.BufferGeometry;w.addAttribute("position",new TONG.BufferAttribute(new Float32Array(b.vertices),3)),0<b.normals.length?w.addAttribute("normal",new TONG.BufferAttribute(new Float32Array(b.normals),3)):w.computeVertexNormals(),0<b.uvs.length&&w.addAttribute("uv",new TONG.BufferAttribute(new Float32Array(b.uvs),2));for(var N,A=[],x=0,M=_.length;x<M;x++){var G=_[x],k=void 0;if(null!==this.materials&&(k=this.materials.create(G.name),O&&k&&!(k instanceof TONG.LineBasicMaterial))){var L=new TONG.LineBasicMaterial;L.copy(k),k=L}k||((k=O?new TONG.LineBasicMaterial:new TONG.MeshPhongMaterial).name=G.name),k.shading=G.smooth?TONG.SmoothShading:TONG.FlatShading,A.push(k)}if(1<A.length){for(x=0,M=_.length;x<M;x++){G=_[x];w.addGroup(G.groupStart,G.groupCount,x)}N=O?new TONG.LineSegments(w,A):new TONG.Mesh(w,A)}else N=O?new TONG.LineSegments(w,A[0]):new TONG.Mesh(w,A[0]);N.name=T.name,y.add(N)}}return console.timeEnd("OBJLoader"),y}},TONG.PCDLoader=function(e){this.manager=void 0!==e?e:TONG.DefaultLoadingManager,this.littleEndian=!0},TONG.PCDLoader.prototype={constructor:TONG.PCDLoader,load:function(t,r,e,a){var n=this,i=new TONG.FileLoader(n.manager);i.setResponseType("arraybuffer"),i.load(t,function(e){r(n.parse(e,t))},e,a)},parse:function(e,t){var r=TONG.LoaderUtils.decodeText(e),a=function(e){var t={},r=e.search(/[\r\n]DATA\s(\S*)\s/i),a=/[\r\n]DATA\s(\S*)\s/i.exec(e.substr(r-1));if(t.data=a[1],t.headerLen=a[0].length+r,t.str=e.substr(0,t.headerLen),t.str=t.str.replace(/\#.*/gi,""),t.version=/VERSION (.*)/i.exec(t.str),t.fields=/FIELDS (.*)/i.exec(t.str),t.size=/SIZE (.*)/i.exec(t.str),t.type=/TYPE (.*)/i.exec(t.str),t.count=/COUNT (.*)/i.exec(t.str),t.width=/WIDTH (.*)/i.exec(t.str),t.height=/HEIGHT (.*)/i.exec(t.str),t.viewpoint=/VIEWPOINT (.*)/i.exec(t.str),t.points=/POINTS (.*)/i.exec(t.str),null!==t.version&&(t.version=parseFloat(t.version[1])),null!==t.fields&&(t.fields=t.fields[1].split(" ")),null!==t.type&&(t.type=t.type[1].split(" ")),null!==t.width&&(t.width=parseInt(t.width[1])),null!==t.height&&(t.height=parseInt(t.height[1])),null!==t.viewpoint&&(t.viewpoint=t.viewpoint[1]),null!==t.points&&(t.points=parseInt(t.points[1],10)),null===t.points&&(t.points=t.width*t.height),null!==t.size&&(t.size=t.size[1].split(" ").map(function(e){return parseInt(e,10)})),null!==t.count)t.count=t.count[1].split(" ").map(function(e){return parseInt(e,10)});else{t.count=[];for(var n=0,i=t.fields.length;n<i;n++)t.count.push(1)}t.offset={};var s=0;for(n=0,i=t.fields.length;n<i;n++)"ascii"===t.data?t.offset[t.fields[n]]=n:(t.offset[t.fields[n]]=s,s+=t.size[n]);return t.rowSize=s,t}(r),n=[],i=[],s=[];if("ascii"===a.data)for(var o=a.offset,l=r.substr(a.headerLen).split("\n"),u=0,h=l.length;u<h;u++)if(""!==l[u]){var c=l[u].split(" ");if(void 0!==o.x&&(n.push(parseFloat(c[o.x])),n.push(parseFloat(c[o.y])),n.push(parseFloat(c[o.z]))),void 0!==o.rgb){var d=new Float32Array([parseFloat(c[o.rgb])]),f=new DataView(d.buffer,0);s.push(f.getUint8(0)/255),s.push(f.getUint8(1)/255),s.push(f.getUint8(2)/255)}void 0!==o.normal_x&&(i.push(parseFloat(c[o.normal_x])),i.push(parseFloat(c[o.normal_y])),i.push(parseFloat(c[o.normal_z])))}if("binary_compressed"!==a.data){if("binary"===a.data){f=new DataView(e,a.headerLen),o=a.offset,u=0;for(var p=0;u<a.points;u++,p+=a.rowSize)void 0!==o.x&&(n.push(f.getFloat32(p+o.x,this.littleEndian)),n.push(f.getFloat32(p+o.y,this.littleEndian)),n.push(f.getFloat32(p+o.z,this.littleEndian))),void 0!==o.rgb&&(s.push(f.getUint8(p+o.rgb+0)/255),s.push(f.getUint8(p+o.rgb+1)/255),s.push(f.getUint8(p+o.rgb+2)/255)),void 0!==o.normal_x&&(i.push(f.getFloat32(p+o.normal_x,this.littleEndian)),i.push(f.getFloat32(p+o.normal_y,this.littleEndian)),i.push(f.getFloat32(p+o.normal_z,this.littleEndian)))}var m=new TONG.BufferGeometry;0<n.length&&m.addAttribute("position",new TONG.Float32BufferAttribute(n,3)),0<i.length&&m.addAttribute("normal",new TONG.Float32BufferAttribute(i,3)),0<s.length&&m.addAttribute("color",new TONG.Float32BufferAttribute(s,3)),m.computeBoundingSphere();var g=new TONG.PointsMaterial({size:.005});0<s.length?g.vertexColors=!0:g.color.setHex(16777215*Math.random());var v=new TONG.Points(m,g),y=t.split("").reverse().join("");return y=(y=/([^\/]*)/.exec(y))[1].split("").reverse().join(""),v.name=y,v}console.error("TONG.PCDLoader: binary_compressed files are not supported")}},function(s){var a=null;function c(){if(null===a){var e=new ArrayBuffer(2),t=new Uint8Array(e),r=new Uint16Array(e);t[0]=170,t[1]=187,a=43707===r[0]}return a}var b=[null,Float32Array,null,Int8Array,Int16Array,null,Int32Array,Uint8Array,Uint16Array,null,Uint32Array],d={Uint16Array:"getUint16",Uint32Array:"getUint32",Int16Array:"getInt16",Int32Array:"getInt32",Float32Array:"getFloat32",Float64Array:"getFloat64"};function _(e,t,r,a,n){var i,s=t.BYTES_PER_ELEMENT;if(n===c()||1===s)i=new t(e,r,a);else{var o=new DataView(e,r,a*s),l=d[t.name],u=!n,h=0;for(i=new t(a);h<a;h++)i[h]=o[l](h*s,u)}return i}s.PRWMLoader=function(e){this.manager=void 0!==e?e:s.DefaultLoadingManager},s.PRWMLoader.prototype={constructor:s.PRWMLoader,load:function(e,t,r,a){var n=this,i=new s.FileLoader(n.manager);i.setResponseType("arraybuffer"),e=e.replace(/\*/g,c()?"be":"le"),i.load(e,function(e){t(n.parse(e))},r,a)},parse:function(e){console.time("PRWMLoader");var t,r,a=function(e){var t=new Uint8Array(e),r=t[0],a=t[1],n=!!(a>>7&1),i=a>>6&1,s=1==(a>>5&1),o=31&a,l=0,u=0;if(s?(l=(t[2]<<16)+(t[3]<<8)+t[4],u=(t[5]<<16)+(t[6]<<8)+t[7]):(l=t[2]+(t[3]<<8)+(t[4]<<16),u=t[5]+(t[6]<<8)+(t[7]<<16)),0===r)throw new Error("PRWM decoder: Invalid format version: 0");if(1!==r)throw new Error("PRWM decoder: Unsupported format version: "+r);if(!n){if(0!==i)throw new Error("PRWM decoder: Indices type must be set to 0 for non-indexed geometries");if(0!==u)throw new Error("PRWM decoder: Number of indices must be set to 0 for non-indexed geometries")}var h,c,d,f,p,m,g,v,y=8,T={};for(v=0;v<o;v++){for(h="";y<t.length&&(c=t[y],y++,0!==c);)h+=String.fromCharCode(c);d=(a=t[y])>>7&1,f=1+(a>>4&3),y++,m=_(e,p=b[15&a],y=4*Math.ceil(y/4),f*l,s),y+=p.BYTES_PER_ELEMENT*f*l,T[h]={type:d,cardinality:f,values:m}}return y=4*Math.ceil(y/4),g=null,n&&(g=_(e,1===i?Uint32Array:Uint16Array,y,u,s)),{version:r,attributes:T,indices:g}}(e),n=Object.keys(a.attributes),i=new s.BufferGeometry;for(r=0;r<n.length;r++)t=a.attributes[n[r]],i.addAttribute(n[r],new s.BufferAttribute(t.values,t.cardinality,t.normalized));return null!==a.indices&&i.setIndex(new s.BufferAttribute(a.indices,1)),console.timeEnd("PRWMLoader"),i}},s.PRWMLoader.isBigEndianPlatform=function(){return c()}}(TONG),TONG.PVRLoader=function(e){TONG.CompressedTextureLoader.call(this,e),this._parser=TONG.PVRLoader.parse},TONG.PVRLoader.prototype=Object.create(TONG.CompressedTextureLoader.prototype),TONG.PVRLoader.prototype.constructor=TONG.PVRLoader,TONG.PVRLoader.parse=function(e,t){var r=new Uint32Array(e,0,13),a={buffer:e,header:r,loadMipmaps:t};return 55727696===r[0]?TONG.PVRLoader._parseV3(a):559044176===r[11]?TONG.PVRLoader._parseV2(a):void console.error("TONG.PVRLoader: Unknown PVR format.")},TONG.PVRLoader._parseV3=function(e){var t,r,a=e.header,n=a[12],i=a[2],s=a[6],o=a[7],l=a[10],u=a[11];switch(i){case 0:t=2,r=TONG.RGB_PVRTC_2BPPV1_Format;break;case 1:t=2,r=TONG.RGBA_PVRTC_2BPPV1_Format;break;case 2:t=4,r=TONG.RGB_PVRTC_4BPPV1_Format;break;case 3:t=4,r=TONG.RGBA_PVRTC_4BPPV1_Format;break;default:console.error("TONG.PVRLoader: Unsupported PVR format:",i)}return e.dataPtr=52+n,e.bpp=t,e.format=r,e.width=o,e.height=s,e.numSurfaces=l,e.numMipmaps=u,e.isCubemap=6===l,TONG.PVRLoader._extract(e)},TONG.PVRLoader._parseV2=function(e){var t,r,a=e.header,n=a[0],i=a[1],s=a[2],o=a[3],l=a[4],u=a[10],h=a[12],c=255&l,d=0<u;return 25===c?(r=d?TONG.RGBA_PVRTC_4BPPV1_Format:TONG.RGB_PVRTC_4BPPV1_Format,t=4):24===c?(r=d?TONG.RGBA_PVRTC_2BPPV1_Format:TONG.RGB_PVRTC_2BPPV1_Format,t=2):console.error("TONG.PVRLoader: Unknown PVR format:",c),e.dataPtr=n,e.bpp=t,e.format=r,e.width=s,e.height=i,e.numSurfaces=h,e.numMipmaps=o+1,e.isCubemap=6===h,TONG.PVRLoader._extract(e)},TONG.PVRLoader._extract=function(e){var t,r={mipmaps:[],width:e.width,height:e.height,format:e.format,mipmapCount:e.numMipmaps,isCubemap:e.isCubemap},a=e.buffer,n=e.dataPtr,i=e.bpp,s=e.numSurfaces,o=0,l=0,u=0,h=0,c=0;2===i?(l=8,u=4):u=l=4,t=l*u*i/8,r.mipmaps.length=e.numMipmaps*s;for(var d=0;d<e.numMipmaps;){var f=e.width>>d,p=e.height>>d;(h=f/l)<2&&(h=2),(c=p/u)<2&&(c=2),o=h*c*t;for(var m=0;m<s;m++){var g={data:new Uint8Array(a,n,o),width:f,height:p};r.mipmaps[m*e.numMipmaps+d]=g,n+=o}d++}return r},TONG.PlayCanvasLoader=function(e){this.manager=void 0!==e?e:TONG.DefaultLoadingManager},TONG.PlayCanvasLoader.prototype={constructor:TONG.PlayCanvasLoader,load:function(e,t,r,a){var n=this;new TONG.FileLoader(n.manager).load(e,function(e){t(n.parse(JSON.parse(e)))},r,a)},parse:function(e){function t(e){var t={};for(var r in e){var a,n=e[r],i=n.type,s=n.array;"float32"===i&&(a=new Float32Array(n.data)),void 0===a&&console.log("PlayCanvasLoader: TODO",i),t[r]=new TONG.BufferAttribute(a,s)}e._attributes=t}function r(e){var t=new TONG.BufferGeometry;t.setIndex(new TONG.Uint16BufferAttribute(e.indices,1));var r=o.vertices[e.vertices]._attributes;for(var a in r){var n=r[a];"texCoord0"===a&&(a="uv"),t.addAttribute(a,n)}e._geometry=t}function a(e){var t=new TONG.Group;if(t.name=e.name,void 0!==e._geometries)for(var r=new TONG.MeshPhongMaterial,a=0;a<e._geometries.length;a++){var n=e._geometries[a];t.add(new TONG.Mesh(n,r))}for(a=0;a<e.rotation.length;a++)e.rotation[a]*=Math.PI/180;t.position.fromArray(e.position),t.rotation.fromArray(e.rotation),t.scale.fromArray(e.scale),e._object=t}console.log(e);for(var n,i,s,o=e.model,l=0;l<o.vertices.length;l++)t(o.vertices[l]);for(l=0;l<o.meshes.length;l++)r(o.meshes[l]);for(l=0;l<o.meshInstances.length;l++)n=o.meshInstances[l],i=void 0,i=o.nodes[n.node],s=o.meshes[n.mesh],void 0===i._geometries&&(i._geometries=[]),i._geometries.push(s._geometry);for(l=0;l<o.nodes.length;l++)a(o.nodes[l]);for(l=0;l<o.parents.length;l++){var u=o.parents[l];-1!==u&&o.nodes[u]._object.add(o.nodes[l]._object)}return o.nodes[0]._object}},TONG.PLYLoader=function(e){this.manager=void 0!==e?e:TONG.DefaultLoadingManager,this.propertyNameMapping={}},TONG.PLYLoader.prototype={constructor:TONG.PLYLoader,load:function(e,t,r,a){var n=this,i=new TONG.FileLoader(this.manager);i.setResponseType("arraybuffer"),i.load(e,function(e){t(n.parse(e))},r,a)},setPropertyNameMapping:function(e){this.propertyNameMapping=e},parse:function(e){function t(e){var t="",r=0,a=/ply([\s\S]*)end_header\s/.exec(e);null!==a&&(t=a[1],r=a[0].length);var n,i,s,o,l,u,h={comments:[],elements:[],headerLength:r},c=t.split("\n");for(var d=0;d<c.length;d++){var f=c[d];if(""!==(f=f.trim()))switch(i=(s=f.split(/\s+/)).shift(),f=s.join(" "),i){case"format":h.format=s[0],h.version=s[1];break;case"comment":h.comments.push(f);break;case"element":void 0!==n&&h.elements.push(n),(n={}).name=s[0],n.count=parseInt(s[1]),n.properties=[];break;case"property":n.properties.push((o=s,l=m.propertyNameMapping,u=void 0,"list"===(u={type:o[0]}).type?(u.name=o[3],u.countType=o[1],u.itemType=o[2]):u.name=o[1],u.name in l&&(u.name=l[u.name]),u));break;default:console.log("unhandled",i,s)}}return void 0!==n&&h.elements.push(n),h}function l(e,t){switch(t){case"char":case"uchar":case"short":case"ushort":case"int":case"uint":case"int8":case"uint8":case"int16":case"uint16":case"int32":case"uint32":return parseInt(e);case"float":case"double":case"float32":case"float64":return parseFloat(e)}}function c(e,t){for(var r=t.split(/\s+/),a={},n=0;n<e.length;n++)if("list"===e[n].type){for(var i=[],s=l(r.shift(),e[n].countType),o=0;o<s;o++)i.push(l(r.shift(),e[n].itemType));a[e[n].name]=i}else a[e[n].name]=l(r.shift(),e[n].type);return a}function r(e,t){var r,a={indices:[],vertices:[],normals:[],uvs:[],colors:[]},n="";null!==(r=/end_header\s([\s\S]*)$/.exec(e))&&(n=r[1]);for(var i=n.split("\n"),s=0,o=0,l=0;l<i.length;l++){var u=i[l];if(""!==(u=u.trim())){o>=t.elements[s].count&&(s++,o=0);var h=c(t.elements[s].properties,u);f(a,t.elements[s].name,h),o++}}return d(a)}function d(e){var t=new TONG.BufferGeometry;return 0<e.indices.length&&t.setIndex(e.indices),t.addAttribute("position",new TONG.Float32BufferAttribute(e.vertices,3)),0<e.normals.length&&t.addAttribute("normal",new TONG.Float32BufferAttribute(e.normals,3)),0<e.uvs.length&&t.addAttribute("uv",new TONG.Float32BufferAttribute(e.uvs,2)),0<e.colors.length&&t.addAttribute("color",new TONG.Float32BufferAttribute(e.colors,3)),t.computeBoundingSphere(),t}function f(e,t,r){if("vertex"===t)e.vertices.push(r.x,r.y,r.z),"nx"in r&&"ny"in r&&"nz"in r&&e.normals.push(r.nx,r.ny,r.nz),"s"in r&&"t"in r&&e.uvs.push(r.s,r.t),"red"in r&&"green"in r&&"blue"in r&&e.colors.push(r.red/255,r.green/255,r.blue/255);else if("face"===t){var a=r.vertex_indices||r.vertex_index;3===a.length?e.indices.push(a[0],a[1],a[2]):4===a.length&&(e.indices.push(a[0],a[1],a[3]),e.indices.push(a[1],a[2],a[3]))}}function p(e,t,r,a){switch(r){case"int8":case"char":return[e.getInt8(t),1];case"uint8":case"uchar":return[e.getUint8(t),1];case"int16":case"short":return[e.getInt16(t,a),2];case"uint16":case"ushort":return[e.getUint16(t,a),2];case"int32":case"int":return[e.getInt32(t,a),4];case"uint32":case"uint":return[e.getUint32(t,a),4];case"float32":case"float":return[e.getFloat32(t,a),4];case"float64":case"double":return[e.getFloat64(t,a),8]}}function h(e,t,r,a){for(var n,i={},s=0,o=0;o<r.length;o++)if("list"===r[o].type){var l=[],u=(n=p(e,t+s,r[o].countType,a))[0];s+=n[1];for(var h=0;h<u;h++)n=p(e,t+s,r[o].itemType,a),l.push(n[0]),s+=n[1];i[r[o].name]=l}else n=p(e,t+s,r[o].type,a),i[r[o].name]=n[0],s+=n[1];return[i,s]}var a,m=this;if(e instanceof ArrayBuffer){var n=TONG.LoaderUtils.decodeText(new Uint8Array(e)),i=t(n);a="ascii"===i.format?r(n,i):function(e,t){for(var r,a={indices:[],vertices:[],normals:[],uvs:[],colors:[]},n="binary_little_endian"===t.format,i=new DataView(e,t.headerLength),s=0,o=0;o<t.elements.length;o++)for(var l=0;l<t.elements[o].count;l++){s+=(r=h(i,s,t.elements[o].properties,n))[1];var u=r[0];f(a,t.elements[o].name,u)}return d(a)}(e,i)}else a=r(e,t(e));return a}},TONG.STLLoader=function(e){this.manager=void 0!==e?e:TONG.DefaultLoadingManager},TONG.STLLoader.prototype={constructor:TONG.STLLoader,load:function(e,t,r,a){var n=this,i=new TONG.FileLoader(n.manager);i.setResponseType("arraybuffer"),i.load(e,function(e){try{t(n.parse(e))}catch(e){a&&a(e)}},r,a)},parse:function(e){var t,r=function(e){if("string"==typeof e){for(var t=new Uint8Array(e.length),r=0;r<e.length;r++)t[r]=255&e.charCodeAt(r);return t.buffer||t}return e}(e);return function(e){var t;if(84+50*(t=new DataView(e)).getUint32(80,!0)===t.byteLength)return!0;for(var r=[115,111,108,105,100],a=0;a<5;a++)if(r[a]!=t.getUint8(a,!1))return!0;return!1}(r)?function(e){for(var t,r,a,n,i,s,o,l,u=new DataView(e),h=u.getUint32(80,!0),c=!1,d=0;d<70;d++)1129270351==u.getUint32(d,!1)&&82==u.getUint8(d+4)&&61==u.getUint8(d+5)&&(c=!0,n=[],i=u.getUint8(d+6)/255,s=u.getUint8(d+7)/255,o=u.getUint8(d+8)/255,l=u.getUint8(d+9)/255);for(var f=new TONG.BufferGeometry,p=[],m=[],g=0;g<h;g++){var v=84+50*g,y=u.getFloat32(v,!0),T=u.getFloat32(v+4,!0),b=u.getFloat32(v+8,!0);if(c){var _=u.getUint16(v+48,!0);0==(32768&_)?(t=(31&_)/31,r=(_>>5&31)/31,a=(_>>10&31)/31):(t=i,r=s,a=o)}for(var O=1;O<=3;O++){var w=v+12*O;p.push(u.getFloat32(w,!0)),p.push(u.getFloat32(w+4,!0)),p.push(u.getFloat32(w+8,!0)),m.push(y,T,b),c&&n.push(t,r,a)}}return f.addAttribute("position",new TONG.BufferAttribute(new Float32Array(p),3)),f.addAttribute("normal",new TONG.BufferAttribute(new Float32Array(m),3)),c&&(f.addAttribute("color",new TONG.BufferAttribute(new Float32Array(n),3)),f.hasColors=!0,f.alpha=l),f}(r):function(e){for(var t,r=new TONG.BufferGeometry,a=/facet([\s\S]*?)endfacet/g,n=0,i=/[\s]+([+-]?(?:\d*)(?:\.\d*)?(?:[eE][+-]?\d+)?)/.source,s=new RegExp("vertex"+i+i+i,"g"),o=new RegExp("normal"+i+i+i,"g"),l=[],u=[],h=new TONG.Vector3;null!==(t=a.exec(e));){for(var c=0,d=0,f=t[0];null!==(t=o.exec(f));)h.x=parseFloat(t[1]),h.y=parseFloat(t[2]),h.z=parseFloat(t[3]),d++;for(;null!==(t=s.exec(f));)l.push(parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3])),u.push(h.x,h.y,h.z),c++;1!==d&&console.error("TONG.STLLoader: Something isn't right with the normal of face number "+n),3!==c&&console.error("TONG.STLLoader: Something isn't right with the vertices of face number "+n),n++}return r.addAttribute("position",new TONG.Float32BufferAttribute(l,3)),r.addAttribute("normal",new TONG.Float32BufferAttribute(u,3)),r}("string"!=typeof(t=e)?TONG.LoaderUtils.decodeText(new Uint8Array(t)):t)}},TONG.SVGLoader=function(e){this.manager=void 0!==e?e:TONG.DefaultLoadingManager},TONG.SVGLoader.prototype={constructor:TONG.SVGLoader,load:function(e,t,r,a){var n=this;new TONG.FileLoader(n.manager).load(e,function(e){t(n.parse(e))},r,a)},parse:function(e){function b(e,t,r,a,n,i,s,o){a=a*Math.PI/180,t=Math.abs(t),r=Math.abs(r);var l=(s.x-o.x)/2,u=(s.y-o.y)/2,h=Math.cos(a)*l+Math.sin(a)*u,c=-Math.sin(a)*l+Math.cos(a)*u,d=t*t,f=r*r,p=h*h,m=c*c,g=p/d+m/f;if(1<g){var v=Math.sqrt(g);d=(t*=v)*t,f=(r*=v)*r}var y=d*m+f*p,T=(d*f-y)/y,b=Math.sqrt(Math.max(0,T));n===i&&(b=-b);var _=b*t*c/r,O=-b*r*h/t,w=Math.cos(a)*_-Math.sin(a)*O+(s.x+o.x)/2,N=Math.sin(a)*_+Math.cos(a)*O+(s.y+o.y)/2,A=M(1,0,(h-_)/t,(c-O)/r),x=M((h-_)/t,(c-O)/r,(-h-_)/t,(-c-O)/r)%(2*Math.PI);e.currentPath.absellipse(w,N,t,r,A,A+x,0===i,a)}function M(e,t,r,a){var n=e*r+t*a,i=Math.sqrt(e*e+t*t)*Math.sqrt(r*r+a*a),s=Math.acos(Math.max(-1,Math.min(1,n/i)));return e*a-t*r<0&&(s=-s),s}function _(e,t){return t=Object.assign({},t),e.hasAttribute("fill")&&(t.fill=e.getAttribute("fill")),""!==e.style.fill&&(t.fill=e.style.fill),t}function O(e){return"none"!==e.fill&&"transparent"!==e.fill}function w(e,t){return e-(t-e)}function N(e){for(var t=e.split(/[\s,]+|(?=\s?[+\-])/),r=0;r<t.length;r++){var a=t[r];if(a.indexOf(".")!==a.lastIndexOf("."))for(var n=a.split("."),i=2;i<n.length;i++)t.splice(r+i-1,0,"0."+n[i]);t[r]=parseFloat(a)}return t}console.log("TONG.SVGLoader");var A=[];console.time("TONG.SVGLoader: DOMParser");var t=(new DOMParser).parseFromString(e,"image/svg+xml");return console.timeEnd("TONG.SVGLoader: DOMParser"),console.time("TONG.SVGLoader: Parse"),function e(t,r){if(1===t.nodeType){switch(t.nodeName){case"svg":break;case"g":r=_(t,r);break;case"path":r=_(t,r),t.hasAttribute("d")&&O(r)&&A.push(function(e,t){var r=new TONG.ShapePath;r.color.setStyle(t.fill);for(var a=new TONG.Vector2,n=new TONG.Vector2,i=e.getAttribute("d").match(/[a-df-z][^a-df-z]*/gi),s=0,o=i.length;s<o;s++){var l=i[s],u=l.charAt(0),h=l.substr(1).trim();switch(u){case"M":for(var c=N(h),d=0,f=c.length;d<f;d+=2)a.x=c[d+0],a.y=c[d+1],n.x=a.x,n.y=a.y,r.moveTo(a.x,a.y);break;case"H":for(var c=N(h),d=0,f=c.length;d<f;d++)a.x=c[d],n.x=a.x,n.y=a.y,r.lineTo(a.x,a.y);break;case"V":for(var c=N(h),d=0,f=c.length;d<f;d++)a.y=c[d],n.x=a.x,n.y=a.y,r.lineTo(a.x,a.y);break;case"L":for(var c=N(h),d=0,f=c.length;d<f;d+=2)a.x=c[d+0],a.y=c[d+1],n.x=a.x,n.y=a.y,r.lineTo(a.x,a.y);break;case"C":for(var c=N(h),d=0,f=c.length;d<f;d+=6)r.bezierCurveTo(c[d+0],c[d+1],c[d+2],c[d+3],c[d+4],c[d+5]),n.x=c[d+2],n.y=c[d+3],a.x=c[d+4],a.y=c[d+5];break;case"S":for(var c=N(h),d=0,f=c.length;d<f;d+=4)r.bezierCurveTo(w(a.x,n.x),w(a.y,n.y),c[d+0],c[d+1],c[d+2],c[d+3]),n.x=c[d+0],n.y=c[d+1],a.x=c[d+2],a.y=c[d+3];break;case"Q":for(var c=N(h),d=0,f=c.length;d<f;d+=4)r.quadraticCurveTo(c[d+0],c[d+1],c[d+2],c[d+3]),n.x=c[d+0],n.y=c[d+1],a.x=c[d+2],a.y=c[d+3];break;case"T":for(var c=N(h),d=0,f=c.length;d<f;d+=2){var p=w(a.x,n.x),m=w(a.y,n.y);r.quadraticCurveTo(p,m,c[d+0],c[d+1]),n.x=p,n.y=m,a.x=c[d+0],a.y=c[d+1]}break;case"A":for(var c=N(h),d=0,f=c.length;d<f;d+=7){var g=a.clone();a.x=c[d+5],a.y=c[d+6],n.x=a.x,n.y=a.y,b(r,c[d],c[d+1],c[d+2],c[d+3],c[d+4],g,a)}break;case"m":for(var c=N(h),d=0,f=c.length;d<f;d+=2)a.x+=c[d+0],a.y+=c[d+1],n.x=a.x,n.y=a.y,r.moveTo(a.x,a.y);break;case"h":for(var c=N(h),d=0,f=c.length;d<f;d++)a.x+=c[d],n.x=a.x,n.y=a.y,r.lineTo(a.x,a.y);break;case"v":for(var c=N(h),d=0,f=c.length;d<f;d++)a.y+=c[d],n.x=a.x,n.y=a.y,r.lineTo(a.x,a.y);break;case"l":for(var c=N(h),d=0,f=c.length;d<f;d+=2)a.x+=c[d+0],a.y+=c[d+1],n.x=a.x,n.y=a.y,r.lineTo(a.x,a.y);break;case"c":for(var c=N(h),d=0,f=c.length;d<f;d+=6)r.bezierCurveTo(a.x+c[d+0],a.y+c[d+1],a.x+c[d+2],a.y+c[d+3],a.x+c[d+4],a.y+c[d+5]),n.x=a.x+c[d+2],n.y=a.y+c[d+3],a.x+=c[d+4],a.y+=c[d+5];break;case"s":for(var c=N(h),d=0,f=c.length;d<f;d+=4)r.bezierCurveTo(w(a.x,n.x),w(a.y,n.y),a.x+c[d+0],a.y+c[d+1],a.x+c[d+2],a.y+c[d+3]),n.x=a.x+c[d+0],n.y=a.y+c[d+1],a.x+=c[d+2],a.y+=c[d+3];break;case"q":for(var c=N(h),d=0,f=c.length;d<f;d+=4)r.quadraticCurveTo(a.x+c[d+0],a.y+c[d+1],a.x+c[d+2],a.y+c[d+3]),n.x=a.x+c[d+0],n.y=a.y+c[d+1],a.x+=c[d+2],a.y+=c[d+3];break;case"t":for(var c=N(h),d=0,f=c.length;d<f;d+=2){var p=w(a.x,n.x),m=w(a.y,n.y);r.quadraticCurveTo(p,m,a.x+c[d+0],a.y+c[d+1]),n.x=p,n.y=m,a.x=a.x+c[d+0],a.y=a.y+c[d+1]}break;case"a":for(var c=N(h),d=0,f=c.length;d<f;d+=7){var g=a.clone();a.x+=c[d+5],a.y+=c[d+6],n.x=a.x,n.y=a.y,b(r,c[d],c[d+1],c[d+2],c[d+3],c[d+4],g,a)}break;case"Z":case"z":if(r.currentPath.autoClose=!0,0<r.currentPath.curves.length){var v=r.currentPath.curves[0];v.isLineCurve?(a.x=v.v1.x,a.y=v.v1.y):v.isEllipseCurve||v.isArcCurve?(a.x=v.aX,a.y=v.aY):v.isCubicBezierCurve||v.isQuadraticBezierCurve?(a.x=v.v0.x,a.y=v.v0.y):v.isSplineCurve&&(a.x=v.points[0].x,a.y=v.points[0].y),r.currentPath.currentPoint.copy(a)}break;default:console.warn(l)}}return r}(t,r));break;case"rect":O(r=_(t,r))&&A.push((c=t,d=r,f=parseFloat(c.getAttribute("x")||0),p=parseFloat(c.getAttribute("y")||0),m=parseFloat(c.getAttribute("rx")||0),g=parseFloat(c.getAttribute("ry")||0),v=parseFloat(c.getAttribute("width")),y=parseFloat(c.getAttribute("height")),(T=new TONG.ShapePath).color.setStyle(d.fill),T.moveTo(f+2*m,p),T.lineTo(f+v-2*m,p),(0!==m||0!==g)&&T.bezierCurveTo(f+v,p,f+v,p,f+v,p+2*g),T.lineTo(f+v,p+y-2*g),(0!==m||0!==g)&&T.bezierCurveTo(f+v,p+y,f+v,p+y,f+v-2*m,p+y),T.lineTo(f+2*m,p+y),(0!==m||0!==g)&&(T.bezierCurveTo(f,p+y,f,p+y,f,p+y-2*g),T.lineTo(f,p+2*g),T.bezierCurveTo(f,p,f,p,f+2*m,p)),T));break;case"polygon":O(r=_(t,r))&&A.push(function(e,t){var i=new TONG.ShapePath;i.color.setStyle(t.fill);var s=0;return e.getAttribute("points").replace(/(-?[\d\.?]+)[,|\s](-?[\d\.?]+)/g,function(e,t,r){var a=parseFloat(t),n=parseFloat(r);0===s?i.moveTo(a,n):i.lineTo(a,n),s++}),i.currentPath.autoClose=!0,i}(t,r));break;case"polyline":O(r=_(t,r))&&A.push(function(e,t){var i=new TONG.ShapePath;i.color.setStyle(t.fill);var s=0;return e.getAttribute("points").replace(/(-?[\d\.?]+)[,|\s](-?[\d\.?]+)/g,function(e,t,r){var a=parseFloat(t),n=parseFloat(r);0===s?i.moveTo(a,n):i.lineTo(a,n),s++}),i.currentPath.autoClose=!1,i}(t,r));break;case"circle":O(r=_(t,r))&&A.push(function(e,t){var r=parseFloat(e.getAttribute("cx")),a=parseFloat(e.getAttribute("cy")),n=parseFloat(e.getAttribute("r")),i=new TONG.Path;i.absarc(r,a,n,0,2*Math.PI);var s=new TONG.ShapePath;return s.color.setStyle(t.fill),s.subPaths.push(i),s}(t,r));break;case"ellipse":O(r=_(t,r))&&A.push(function(e,t){var r=parseFloat(e.getAttribute("cx")),a=parseFloat(e.getAttribute("cy")),n=parseFloat(e.getAttribute("rx")),i=parseFloat(e.getAttribute("ry")),s=new TONG.Path;s.absellipse(r,a,n,i,0,2*Math.PI);var o=new TONG.ShapePath;return o.color.setStyle(t.fill),o.subPaths.push(s),o}(t,r));break;case"line":O(r=_(t,r))&&A.push((a=t,n=parseFloat(a.getAttribute("x1")),i=parseFloat(a.getAttribute("y1")),s=parseFloat(a.getAttribute("x2")),o=parseFloat(a.getAttribute("y2")),(l=new TONG.ShapePath).moveTo(n,i),l.lineTo(s,o),l.currentPath.autoClose=!1,l));break;default:console.log(t)}for(var a,n,i,s,o,l,u=t.childNodes,h=0;h<u.length;h++)e(u[h],r)}var c,d,f,p,m,g,v,y,T}(t.documentElement,{fill:"#000"}),console.timeEnd("TONG.SVGLoader: Parse"),A}},TONG.TDSLoader=function(e){this.manager=void 0!==e?e:TONG.DefaultLoadingManager,this.debug=!1,this.group=null,this.position=0,this.materials=[],this.meshes=[]},TONG.TDSLoader.prototype={constructor:TONG.TDSLoader,load:function(e,t,r,a){var n=this,i=void 0!==this.path?this.path:TONG.LoaderUtils.extractUrlBase(e),s=new TONG.FileLoader(this.manager);s.setResponseType("arraybuffer"),s.load(e,function(e){t(n.parse(e,i))},r,a)},parse:function(e,t){this.group=new TONG.Group,this.position=0,this.materials=[],this.meshes=[],this.readFile(e,t);for(var r=0;r<this.meshes.length;r++)this.group.add(this.meshes[r]);return this.group},readFile:function(e,t){var r=new DataView(e),a=this.readChunk(r);if(a.id===MLIBMAGIC||a.id===CMAGIC||a.id===M3DMAGIC)for(var n=this.nextChunk(r,a);0!==n;){if(n===M3D_VERSION){var i=this.readDWord(r);this.debugMessage("3DS file version: "+i)}else n===MDATA?(this.resetPosition(r),this.readMeshData(r,t)):this.debugMessage("Unknown main chunk: "+n.toString(16));n=this.nextChunk(r,a)}this.debugMessage("Parsed "+this.meshes.length+" meshes")},readMeshData:function(e,t){for(var r=this.readChunk(e),a=this.nextChunk(e,r);0!==a;){if(a===MESH_VERSION){var n=+this.readDWord(e);this.debugMessage("Mesh Version: "+n)}else if(a===MASTER_SCALE){var i=this.readFloat(e);this.debugMessage("Master scale: "+i),this.group.scale.set(i,i,i)}else a===NAMED_OBJECT?(this.debugMessage("Named Object"),this.resetPosition(e),this.readNamedObject(e)):a===MAT_ENTRY?(this.debugMessage("Material"),this.resetPosition(e),this.readMaterialEntry(e,t)):this.debugMessage("Unknown MDATA chunk: "+a.toString(16));a=this.nextChunk(e,r)}},readNamedObject:function(e){var t=this.readChunk(e),r=this.readString(e,64);t.cur=this.position;for(var a=this.nextChunk(e,t);0!==a;){if(a===N_TRI_OBJECT){this.resetPosition(e);var n=this.readMesh(e);n.name=r,this.meshes.push(n)}else this.debugMessage("Unknown named object chunk: "+a.toString(16));a=this.nextChunk(e,t)}this.endChunk(t)},readMaterialEntry:function(e,t){for(var r=this.readChunk(e),a=this.nextChunk(e,r),n=new TONG.MeshPhongMaterial;0!==a;){if(a===MAT_NAME)n.name=this.readString(e,64),this.debugMessage("   Name: "+n.name);else if(a===MAT_WIRE)this.debugMessage("   Wireframe"),n.wireframe=!0;else if(a===MAT_WIRE_SIZE){var i=this.readByte(e);n.wireframeLinewidth=i,this.debugMessage("   Wireframe Thickness: "+i)}else if(a===MAT_TWO_SIDE)n.side=TONG.DoubleSide,this.debugMessage("   DoubleSided");else if(a===MAT_ADDITIVE)this.debugMessage("   Additive Blending"),n.blending=TONG.AdditiveBlending;else if(a===MAT_DIFFUSE)this.debugMessage("   Diffuse Color"),n.color=this.readColor(e);else if(a===MAT_SPECULAR)this.debugMessage("   Specular Color"),n.specular=this.readColor(e);else if(a===MAT_AMBIENT)this.debugMessage("   Ambient color"),n.color=this.readColor(e);else if(a===MAT_SHININESS){var s=this.readWord(e);n.shininess=s,this.debugMessage("   Shininess : "+s)}else a===MAT_TEXMAP?(this.debugMessage("   ColorMap"),this.resetPosition(e),n.map=this.readMap(e,t)):a===MAT_BUMPMAP?(this.debugMessage("   BumpMap"),this.resetPosition(e),n.bumpMap=this.readMap(e,t)):a===MAT_OPACMAP?(this.debugMessage("   OpacityMap"),this.resetPosition(e),n.alphaMap=this.readMap(e,t)):a===MAT_SPECMAP?(this.debugMessage("   SpecularMap"),this.resetPosition(e),n.specularMap=this.readMap(e,t)):this.debugMessage("   Unknown material chunk: "+a.toString(16));a=this.nextChunk(e,r)}this.endChunk(r),this.materials[n.name]=n},readMesh:function(e){var t=this.readChunk(e),r=this.nextChunk(e,t),a=new TONG.BufferGeometry,n=[],i=new TONG.MeshPhongMaterial,s=new TONG.Mesh(a,i);for(s.name="mesh";0!==r;){if(r===POINT_ARRAY){var o=this.readWord(e);this.debugMessage("   Vertex: "+o);for(var l=[],u=0;u<o;u++)l.push(this.readFloat(e)),l.push(this.readFloat(e)),l.push(this.readFloat(e));a.addAttribute("position",new TONG.Float32BufferAttribute(l,3))}else if(r===FACE_ARRAY)this.resetPosition(e),this.readFaceArray(e,s);else if(r===TEX_VERTS){var h=this.readWord(e);this.debugMessage("   UV: "+h);for(n=[],u=0;u<h;u++)n.push(this.readFloat(e)),n.push(this.readFloat(e));a.addAttribute("uv",new TONG.Float32BufferAttribute(n,2))}else if(r===MESH_MATRIX){this.debugMessage("   Tranformation Matrix (TODO)");var c=[];for(u=0;u<12;u++)c[u]=this.readFloat(e);var d=new TONG.Matrix4;d.elements[0]=c[0],d.elements[1]=c[6],d.elements[2]=c[3],d.elements[3]=c[9],d.elements[4]=c[2],d.elements[5]=c[8],d.elements[6]=c[5],d.elements[7]=c[11],d.elements[8]=c[1],d.elements[9]=c[7],d.elements[10]=c[4],d.elements[11]=c[10],d.elements[12]=0,d.elements[13]=0,d.elements[14]=0,d.elements[15]=1,d.transpose();var f=new TONG.Matrix4;f.getInverse(d,!0),a.applyMatrix(f),d.decompose(s.position,s.quaternion,s.scale)}else this.debugMessage("   Unknown mesh chunk: "+r.toString(16));r=this.nextChunk(e,t)}return this.endChunk(t),a.computeVertexNormals(),s},readFaceArray:function(e,t){var r=this.readChunk(e),a=this.readWord(e);this.debugMessage("   Faces: "+a);for(var n=[],i=0;i<a;++i){n.push(this.readWord(e),this.readWord(e),this.readWord(e));this.readWord(e)}for(t.geometry.setIndex(n);this.position<r.end;){if((r=this.readChunk(e)).id===MSH_MAT_GROUP){this.debugMessage("      Material Group"),this.resetPosition(e);var s=this.readMaterialGroup(e),o=this.materials[s.name];void 0!==o&&""===(t.material=o).name&&(o.name=t.name)}else this.debugMessage("      Unknown face array chunk: "+r.toString(16));this.endChunk(r)}this.endChunk(r)},readMap:function(e,t){var r=this.readChunk(e),a=this.nextChunk(e,r),n={},i=new TONG.TextureLoader(this.manager);for(i.setPath(t);0!==a;){if(a===MAT_MAPNAME){var s=this.readString(e,128);n=i.load(s),this.debugMessage("      File: "+t+s)}else a===MAT_MAP_UOFFSET?(n.offset.x=this.readFloat(e),this.debugMessage("      OffsetX: "+n.offset.x)):a===MAT_MAP_VOFFSET?(n.offset.y=this.readFloat(e),this.debugMessage("      OffsetY: "+n.offset.y)):a===MAT_MAP_USCALE?(n.repeat.x=this.readFloat(e),this.debugMessage("      RepeatX: "+n.repeat.x)):a===MAT_MAP_VSCALE?(n.repeat.y=this.readFloat(e),this.debugMessage("      RepeatY: "+n.repeat.y)):this.debugMessage("      Unknown map chunk: "+a.toString(16));a=this.nextChunk(e,r)}return this.endChunk(r),n},readMaterialGroup:function(e){this.readChunk(e);var t=this.readString(e,64),r=this.readWord(e);this.debugMessage("         Name: "+t),this.debugMessage("         Faces: "+r);for(var a=[],n=0;n<r;++n)a.push(this.readWord(e));return{name:t,index:a}},readColor:function(e){var t=this.readChunk(e),r=new TONG.Color;if(t.id===COLOR_24||t.id===LIN_COLOR_24){var a=this.readByte(e),n=this.readByte(e),i=this.readByte(e);r.setRGB(a/255,n/255,i/255),this.debugMessage("      Color: "+r.r+", "+r.g+", "+r.b)}else if(t.id===COLOR_F||t.id===LIN_COLOR_F){a=this.readFloat(e),n=this.readFloat(e),i=this.readFloat(e);r.setRGB(a,n,i),this.debugMessage("      Color: "+r.r+", "+r.g+", "+r.b)}else this.debugMessage("      Unknown color chunk: "+t.toString(16));return this.endChunk(t),r},readChunk:function(e){var t={};return t.cur=this.position,t.id=this.readWord(e),t.size=this.readDWord(e),t.end=t.cur+t.size,t.cur+=6,t},endChunk:function(e){this.position=e.end},nextChunk:function(e,t){if(t.cur>=t.end)return 0;this.position=t.cur;try{var r=this.readChunk(e);return t.cur+=r.size,r.id}catch(e){return this.debugMessage("Unable to read chunk at "+this.position),0}},resetPosition:function(){this.position-=6},readByte:function(e){var t=e.getUint8(this.position,!0);return this.position+=1,t},readFloat:function(t){try{var e=t.getFloat32(this.position,!0);return this.position+=4,e}catch(e){this.debugMessage(e+" "+this.position+" "+t.byteLength)}},readInt:function(e){var t=e.getInt32(this.position,!0);return this.position+=4,t},readShort:function(e){var t=e.getInt16(this.position,!0);return this.position+=2,t},readDWord:function(e){var t=e.getUint32(this.position,!0);return this.position+=4,t},readWord:function(e){var t=e.getUint16(this.position,!0);return this.position+=2,t},readString:function(e,t){for(var r="",a=0;a<t;a++){var n=this.readByte(e);if(!n)break;r+=String.fromCharCode(n)}return r},setPath:function(e){return this.path=e,this},debugMessage:function(e){this.debug&&console.log(e)}};var NULL_CHUNK=0,M3DMAGIC=19789,SMAGIC=11565,LMAGIC=11581,MLIBMAGIC=15786,MATMAGIC=15871,CMAGIC=49725,M3D_VERSION=2,M3D_KFVERSION=5,COLOR_F=16,COLOR_24=17,LIN_COLOR_24=18,LIN_COLOR_F=19,INT_PERCENTAGE=48,FLOAT_PERCENTAGE=49,MDATA=15677,MESH_VERSION=15678,MASTER_SCALE=256,LO_SHADOW_BIAS=5120,HI_SHADOW_BIAS=5136,SHADOW_MAP_SIZE=5152,SHADOW_SAMPLES=5168,SHADOW_RANGE=5184,SHADOW_FILTER=5200,RAY_BIAS=5216,O_CONSTS=5376,AMBIENT_LIGHT=8448,BIT_MAP=4352,SOLID_BGND=4608,V_GRADIENT=4864,USE_BIT_MAP=4353,USE_SOLID_BGND=4609,USE_V_GRADIENT=4865,FOG=8704,FOG_BGND=8720,LAYER_FOG=8962,DISTANCE_CUE=8960,DCUE_BGND=8976,USE_FOG=8705,USE_LAYER_FOG=8963,USE_DISTANCE_CUE=8961,MAT_ENTRY=45055,MAT_NAME=40960,MAT_AMBIENT=40976,MAT_DIFFUSE=40992,MAT_SPECULAR=41008,MAT_SHININESS=41024,MAT_SHIN2PCT=41025,MAT_TRANSPARENCY=41040,MAT_XPFALL=41042,MAT_USE_XPFALL=41536,MAT_REFBLUR=41043,MAT_SHADING=41216,MAT_USE_REFBLUR=41552,MAT_SELF_ILLUM=41092,MAT_TWO_SIDE=41089,MAT_DECAL=41090,MAT_ADDITIVE=41091,MAT_WIRE=41093,MAT_FACEMAP=41096,MAT_TRANSFALLOFF_IN=41098,MAT_PHONGSOFT=41100,MAT_WIREABS=41102,MAT_WIRE_SIZE=41095,MAT_TEXMAP=41472,MAT_SXP_TEXT_DATA=41760,MAT_TEXMASK=41790,MAT_SXP_TEXTMASK_DATA=41770,MAT_TEX2MAP=41786,MAT_SXP_TEXT2_DATA=41761,MAT_TEX2MASK=41792,MAT_SXP_TEXT2MASK_DATA=41772,MAT_OPACMAP=41488,MAT_SXP_OPAC_DATA=41762,MAT_OPACMASK=41794,MAT_SXP_OPACMASK_DATA=41774,MAT_BUMPMAP=41520,MAT_SXP_BUMP_DATA=41764,MAT_BUMPMASK=41796,MAT_SXP_BUMPMASK_DATA=41776,MAT_SPECMAP=41476,MAT_SXP_SPEC_DATA=41765,MAT_SPECMASK=41800,MAT_SXP_SPECMASK_DATA=41778,MAT_SHINMAP=41788,MAT_SXP_SHIN_DATA=41766,MAT_SHINMASK=41798,MAT_SXP_SHINMASK_DATA=41780,MAT_SELFIMAP=41789,MAT_SXP_SELFI_DATA=41768,MAT_SELFIMASK=41802,MAT_SXP_SELFIMASK_DATA=41782,MAT_REFLMAP=41504,MAT_REFLMASK=41804,MAT_SXP_REFLMASK_DATA=41784,MAT_ACUBIC=41744,MAT_MAPNAME=41728,MAT_MAP_TILING=41809,MAT_MAP_TEXBLUR=41811,MAT_MAP_USCALE=41812,MAT_MAP_VSCALE=41814,MAT_MAP_UOFFSET=41816,MAT_MAP_VOFFSET=41818,MAT_MAP_ANG=41820,MAT_MAP_COL1=41824,MAT_MAP_COL2=41826,MAT_MAP_RCOL=41828,MAT_MAP_GCOL=41830,MAT_MAP_BCOL=41832,NAMED_OBJECT=16384,N_DIRECT_LIGHT=17920,DL_OFF=17952,DL_OUTER_RANGE=18010,DL_INNER_RANGE=18009,DL_MULTIPLIER=18011,DL_EXCLUDE=18004,DL_ATTENUATE=17957,DL_SPOTLIGHT=17936,DL_SPOT_ROLL=18006,DL_SHADOWED=17968,DL_LOCAL_SHADOW2=17985,DL_SEE_CONE=18e3,DL_SPOT_RECTANGULAR=18001,DL_SPOT_ASPECT=18007,DL_SPOT_PROJECTOR=18003,DL_SPOT_OVERSHOOT=18002,DL_RAY_BIAS=18008,DL_RAYSHAD=17959,N_CAMERA=18176,CAM_SEE_CONE=18192,CAM_RANGES=18208,OBJ_HIDDEN=16400,OBJ_VIS_LOFTER=16401,OBJ_DOESNT_CAST=16402,OBJ_DONT_RECVSHADOW=16407,OBJ_MATTE=16403,OBJ_FAST=16404,OBJ_PROCEDURAL=16405,OBJ_FROZEN=16406,N_TRI_OBJECT=16640,POINT_ARRAY=16656,POINT_FLAG_ARRAY=16657,FACE_ARRAY=16672,MSH_MAT_GROUP=16688,SMOOTH_GROUP=16720,MSH_BOXMAP=16784,TEX_VERTS=16704,MESH_MATRIX=16736,MESH_COLOR=16741,MESH_TEXTURE_INFO=16752,KFDATA=45056,KFHDR=45066,KFSEG=45064,KFCURTIME=45065,AMBIENT_NODE_TAG=45057,OBJECT_NODE_TAG=45058,CAMERA_NODE_TAG=45059,TARGET_NODE_TAG=45060,LIGHT_NODE_TAG=45061,L_TARGET_NODE_TAG=45062,SPOTLIGHT_NODE_TAG=45063,NODE_ID=45104,NODE_HDR=45072,PIVOT=45075,INSTANCE_NAME=45073,MORPH_SMOOTH=45077,BOUNDBOX=45076,POS_TRACK_TAG=45088,COL_TRACK_TAG=45093,ROT_TRACK_TAG=45089,SCL_TRACK_TAG=45090,MORPH_TRACK_TAG=45094,FOV_TRACK_TAG=45091,ROLL_TRACK_TAG=45092,HOT_TRACK_TAG=45095,FALL_TRACK_TAG=45096,HIDE_TRACK_TAG=45097,POLY_2D=20480,SHAPE_OK=20496,SHAPE_NOT_OK=20497,SHAPE_HOOK=20512,PATH_3D=24576,PATH_MATRIX=24581,SHAPE_2D=24592,M_SCALE=24608,M_TWIST=24624,M_TEETER=24640,M_FIT=24656,M_BEVEL=24672,XZ_CURVE=24688,YZ_CURVE=24704,INTERPCT=24720,DEFORM_LIMIT=24736,USE_CONTOUR=24832,USE_TWEEN=24848,USE_SCALE=24864,USE_TWIST=24880,USE_TEETER=24896,USE_FIT=24912,USE_BEVEL=24928,DEFAULT_VIEW=12288,VIEW_TOP=12304,VIEW_BOTTOM=12320,VIEW_LEFT=12336,VIEW_RIGHT=12352,VIEW_FRONT=12368,VIEW_BACK=12384,VIEW_USER=12400,VIEW_CAMERA=12416,VIEW_WINDOW=12432,VIEWPORT_LAYOUT_OLD=28672,VIEWPORT_DATA_OLD=28688,VIEWPORT_LAYOUT=28673,VIEWPORT_DATA=28689,VIEWPORT_DATA_3=28690,VIEWPORT_SIZE=28704,NETWORK_VIEW=28720;TONG.TGALoader=function(e){this.manager=void 0!==e?e:TONG.DefaultLoadingManager},TONG.TGALoader.prototype={constructor:TONG.TGALoader,load:function(e,t,r,a){var n=this,i=new TONG.Texture,s=new TONG.FileLoader(this.manager);return s.setResponseType("arraybuffer"),s.setPath(this.path),s.load(e,function(e){i.image=n.parse(e),i.needsUpdate=!0,void 0!==t&&t(i)},r,a),i},parse:function(e){e.length<19&&console.error("TONG.TGALoader: Not enough data to contain header.");var t=new Uint8Array(e),r=0,m={id_length:t[r++],colormap_type:t[r++],image_type:t[r++],colormap_index:t[r++]|t[r++]<<8,colormap_length:t[r++]|t[r++]<<8,colormap_size:t[r++],origin:[t[r++]|t[r++]<<8,t[r++]|t[r++]<<8],width:t[r++]|t[r++]<<8,height:t[r++]|t[r++]<<8,pixel_size:t[r++],flags:t[r++]};!function(e){switch(e.image_type){case 1:case 9:(256<e.colormap_length||24!==e.colormap_size||1!==e.colormap_type)&&console.error("TONG.TGALoader: Invalid type colormap data for indexed type.");break;case 2:case 3:case 10:case 11:e.colormap_type&&console.error("TONG.TGALoader: Invalid type colormap data for colormap type.");break;case 0:console.error("TONG.TGALoader: No data.");default:console.error('TONG.TGALoader: Invalid type "%s".',e.image_type)}(e.width<=0||e.height<=0)&&console.error("TONG.TGALoader: Invalid image size."),8!==e.pixel_size&&16!==e.pixel_size&&24!==e.pixel_size&&32!==e.pixel_size&&console.error('TONG.TGALoader: Invalid pixel size "%s".',e.pixel_size)}(m),m.id_length+r>e.length&&console.error("TONG.TGALoader: No data."),r+=m.id_length;var a=!1,n=!1,c=!1;switch(m.image_type){case 9:n=a=!0;break;case 1:n=!0;break;case 10:a=!0;break;case 2:break;case 11:c=a=!0;break;case 3:c=!0}var i=document.createElement("canvas");i.width=m.width,i.height=m.height;var s=i.getContext("2d"),o=s.createImageData(m.width,m.height),l=function(e,t,r,a,n){var i,s,o,l;if(s=r.pixel_size>>3,o=r.width*r.height*s,t&&(l=n.subarray(a,a+=r.colormap_length*(r.colormap_size>>3))),e){var u,h,c;i=new Uint8Array(o);for(var d=0,f=new Uint8Array(s);d<o;)if(h=1+(127&(u=n[a++])),128&u){for(c=0;c<s;++c)f[c]=n[a++];for(c=0;c<h;++c)i.set(f,d+c*s);d+=s*h}else{for(h*=s,c=0;c<h;++c)i[d+c]=n[a++];d+=h}}else i=n.subarray(a,a+=t?r.width*r.height:o);return{pixel_data:i,palettes:l}}(a,n,m,r,t);!function(e,t,r,a,n){var i,s,o,l,u,h;switch((48&m.flags)>>4){default:case 2:u=t,s=i=0,l=o=1,h=r;break;case 0:i=0,u=t,s=r-(o=1),h=l=-1;break;case 3:i=t-1,u=o=-1,s=0,l=1,h=r;break;case 1:i=t-1,s=r-1,h=l=u=o=-1}if(c)switch(m.pixel_size){case 8:!function(e,t,r,a,n,i,s,o){var l,u,h,c=0,d=m.width;for(h=t;h!==a;h+=r)for(u=n;u!==s;u+=i,c++)l=o[c],e[4*(u+d*h)+0]=l,e[4*(u+d*h)+1]=l,e[4*(u+d*h)+2]=l,e[4*(u+d*h)+3]=255}(e,s,l,h,i,o,u,a);break;case 16:!function(e,t,r,a,n,i,s,o){var l,u,h=0,c=m.width;for(u=t;u!==a;u+=r)for(l=n;l!==s;l+=i,h+=2)e[4*(l+c*u)+0]=o[h+0],e[4*(l+c*u)+1]=o[h+0],e[4*(l+c*u)+2]=o[h+0],e[4*(l+c*u)+3]=o[h+1]}(e,s,l,h,i,o,u,a);break;default:console.error("TONG.TGALoader: Format not supported.")}else switch(m.pixel_size){case 8:!function(e,t,r,a,n,i,s,o,l){var u,h,c,d=l,f=0,p=m.width;for(c=t;c!==a;c+=r)for(h=n;h!==s;h+=i,f++)u=o[f],e[4*(h+p*c)+3]=255,e[4*(h+p*c)+2]=d[3*u+0],e[4*(h+p*c)+1]=d[3*u+1],e[4*(h+p*c)+0]=d[3*u+2]}(e,s,l,h,i,o,u,a,n);break;case 16:!function(e,t,r,a,n,i,s,o){var l,u,h,c=0,d=m.width;for(h=t;h!==a;h+=r)for(u=n;u!==s;u+=i,c+=2)l=o[c+0]+(o[c+1]<<8),e[4*(u+d*h)+0]=(31744&l)>>7,e[4*(u+d*h)+1]=(992&l)>>2,e[4*(u+d*h)+2]=(31&l)>>3,e[4*(u+d*h)+3]=32768&l?0:255}(e,s,l,h,i,o,u,a);break;case 24:!function(e,t,r,a,n,i,s,o){var l,u,h=0,c=m.width;for(u=t;u!==a;u+=r)for(l=n;l!==s;l+=i,h+=3)e[4*(l+c*u)+3]=255,e[4*(l+c*u)+2]=o[h+0],e[4*(l+c*u)+1]=o[h+1],e[4*(l+c*u)+0]=o[h+2]}(e,s,l,h,i,o,u,a);break;case 32:!function(e,t,r,a,n,i,s,o){var l,u,h=0,c=m.width;for(u=t;u!==a;u+=r)for(l=n;l!==s;l+=i,h+=4)e[4*(l+c*u)+2]=o[h+0],e[4*(l+c*u)+1]=o[h+1],e[4*(l+c*u)+0]=o[h+2],e[4*(l+c*u)+3]=o[h+3]}(e,s,l,h,i,o,u,a);break;default:console.error("TONG.TGALoader: Format not supported.")}}(o.data,m.width,m.height,l.pixel_data,l.palettes);return s.putImageData(o,0,0),i},setPath:function(e){return this.path=e,this}},TONG.UTF8Loader=function(){},TONG.UTF8Loader.prototype.load=function(e,t,r){this.downloadModelJson(e,t,r)},TONG.UTF8Loader.BufferGeometryCreator=function(){},TONG.UTF8Loader.BufferGeometryCreator.prototype.create=function(e,t){var r,a,n=t.length/3,i=new TONG.BufferGeometry,s=new Float32Array(3*n*3),o=new Float32Array(3*n*3),l=new Float32Array(3*n*2),u=e.length;for(r=a=0;r<u;r+=8)s[a++]=e[r],s[a++]=e[r+1],s[a++]=e[r+2];for(a=0,r=3;r<u;r+=8)l[a++]=e[r],l[a++]=e[r+1];for(a=0,r=5;r<u;r+=8)o[a++]=e[r],o[a++]=e[r+1],o[a++]=e[r+2];return i.setIndex(new TONG.BufferAttribute(t,1)),i.addAttribute("position",new TONG.BufferAttribute(s,3)),i.addAttribute("normal",new TONG.BufferAttribute(o,3)),i.addAttribute("uv",new TONG.BufferAttribute(l,2)),i.computeBoundingSphere(),i};var DEFAULT_DECODE_PARAMS={decodeOffsets:[-4095,-4095,-4095,0,0,-511,-511,-511],decodeScales:[1/8191,1/8191,1/8191,1/1023,1/1023,1/1023,1/1023,1/1023]};function getHttpRequest(e,t,r){(new TONG.FileLoader).load(e,t,r)}function getJsonRequest(e,t){getHttpRequest(e,function(e){t(JSON.parse(e))},function(){})}function addListeners(e,t){for(var r in t)e.addEventListener(r,t[r])}TONG.UTF8Loader.prototype.decompressAttribsInner_=function(e,t,r,a,n,i,s,o){for(var l=0,u=t;u<r;u++){var h=e.charCodeAt(u);l+=h>>1^-(1&h),a[n]=o*(l+s),n+=i}},TONG.UTF8Loader.prototype.decompressIndices_=function(e,t,r,a,n){for(var i=0,s=0;s<r;s++){var o=e.charCodeAt(t++);a[n++]=i-o,0===o&&i++}},TONG.UTF8Loader.prototype.decompressAABBs_=function(e,t,r,a,n){for(var i=6*r,s=t+i,o=0,l=new Float32Array(i),u=t;u<s;u+=6){var h=e.charCodeAt(u+0)+a[0],c=e.charCodeAt(u+1)+a[1],d=e.charCodeAt(u+2)+a[2],f=e.charCodeAt(u+3)+1>>1,p=e.charCodeAt(u+4)+1>>1,m=e.charCodeAt(u+5)+1>>1;l[o++]=n[0]*(h+f),l[o++]=n[1]*(c+p),l[o++]=n[2]*(d+m),l[o++]=n[0]*f,l[o++]=n[1]*p,l[o++]=n[2]*m}return l},TONG.UTF8Loader.prototype.decompressMesh=function(e,t,r,a,n,i){for(var s=r.decodeScales.length,o=r.decodeOffsets,l=r.decodeScales,u=t.attribRange[0],h=t.attribRange[1],c=u,d=new Float32Array(s*h),f=0;f<s;f++){var p=c+h,m=l[f];m&&this.decompressAttribsInner_(e,c,p,d,f,s,o[f],m),c=p}t.indexRange[0];var g=3*t.indexRange[1],v=new Uint16Array(g);this.decompressIndices_(e,c,g,v,0);var y=void 0,T=t.bboxes;T&&(y=this.decompressAABBs_(e,T,t.names.length,o,l)),i(a,n,d,v,y,t)},TONG.UTF8Loader.prototype.copyAttrib=function(e,t,r,a){for(var n=0;n<e;n++)r[n]=t[e*a+n]},TONG.UTF8Loader.prototype.decodeAttrib2=function(e,t,r,a,n,i,s,o,l,u){for(var h=0;h<5;h++){var c=e.charCodeAt(n+i*h+u),d=c>>1^-(1&c);l[h]+=d,o[t*u+h]=l[h],s[t*u+h]=a[h]*(l[h]+r[h])}},TONG.UTF8Loader.prototype.accumulateNormal=function(e,t,r,a,n){var i=a[8*e],s=a[8*e+1],o=a[8*e+2],l=a[8*t],u=a[8*t+1],h=a[8*t+2],c=a[8*r],d=a[8*r+1],f=a[8*r+2];l-=i,c-=i,i=(u-=s)*(f-=o)-(h-=o)*(d-=s),s=h*c-l*f,o=l*d-u*c,n[3*e]+=i,n[3*e+1]+=s,n[3*e+2]+=o,n[3*t]+=i,n[3*t+1]+=s,n[3*t+2]+=o,n[3*r]+=i,n[3*r+1]+=s,n[3*r+2]+=o},TONG.UTF8Loader.prototype.decompressMesh2=function(e,t,r,a,n,i){for(var s=r.decodeScales.length,o=r.decodeOffsets,l=r.decodeScales,u=t.attribRange[0],h=t.attribRange[1],c=t.codeRange[0],d=(t.codeRange[1],3*t.codeRange[2]),f=new Uint16Array(d),p=new Int32Array(3*h),m=new Uint16Array(s),g=new Uint16Array(s*h),v=new Float32Array(s*h),y=0,T=0,b=0;b<d;b+=3){var _=e.charCodeAt(c++),O=Math.min(b,96);if(_<O){var w,N,A,x=_%3,M=b-(_-x);switch(x){case 0:w=f[M+2],N=f[M+1],A=f[M+0];break;case 1:w=f[M+0],N=f[M+2],A=f[M+1];break;case 2:w=f[M+1],N=f[M+0],A=f[M+2]}f[T++]=w,f[T++]=N;var G=y-(_=e.charCodeAt(c++));if(f[T++]=G,0===_){for(var k=0;k<5;k++){var L=e.charCodeAt(u+h*k+y),S=(L>>1^-(1&L))+g[s*w+k]+g[s*N+k]-g[s*A+k];m[k]=S,g[s*y+k]=S,v[s*y+k]=l[k]*(S+o[k])}y++}else this.copyAttrib(s,g,m,G);this.accumulateNormal(w,N,G,g,p)}else{var C=y-(_-O);f[T++]=C,_===O?this.decodeAttrib2(e,s,o,l,u,h,v,g,m,y++):this.copyAttrib(s,g,m,C);var F=y-(_=e.charCodeAt(c++));f[T++]=F,0===_?this.decodeAttrib2(e,s,o,l,u,h,v,g,m,y++):this.copyAttrib(s,g,m,F);var I=y-(_=e.charCodeAt(c++));if(f[T++]=I,0===_){for(k=0;k<5;k++)m[k]=(g[s*C+k]+g[s*F+k])/2;this.decodeAttrib2(e,s,o,l,u,h,v,g,m,y++)}else this.copyAttrib(s,g,m,I);this.accumulateNormal(C,F,I,g,p)}}for(b=0;b<h;b++){var B=p[3*b],E=p[3*b+1],R=p[3*b+2],D=511/Math.sqrt(B*B+E*E+R*R),P=e.charCodeAt(u+5*h+b),U=e.charCodeAt(u+6*h+b),z=e.charCodeAt(u+7*h+b);v[s*b+5]=D*B+(P>>1^-(1&P)),v[s*b+6]=D*E+(U>>1^-(1&U)),v[s*b+7]=D*R+(z>>1^-(1&z))}i(a,n,v,f,void 0,t)},TONG.UTF8Loader.prototype.downloadMesh=function(e,i,s,o,l){var u=this,h=0;getHttpRequest(e,function(e){!function(e){for(;h<s.length;){var t=s[h],r=t.indexRange;if(r){var a=r[0]+3*r[1];if(e.length<a)break;u.decompressMesh(e,t,o,i,h,l)}else{var n=t.codeRange;if(a=n[0]+n[1],e.length<a)break;u.decompressMesh2(e,t,o,i,h,l)}++h}}(e)})},TONG.UTF8Loader.prototype.downloadMeshes=function(e,t,r,a){for(var n in t){var i=t[n];this.downloadMesh(e+n,n,i,r,a)}},TONG.UTF8Loader.prototype.createMeshCallback=function(e,t,u){var h=0,c=0,d={},f={},p={},r=t.urls;for(var a in r)d[a]=r[a].length,f[a]=0,c++,p[a]=new TONG.Object3D;var m=new TONG.Object3D,g=new TONG.MTLLoader.MaterialCreator(e,t.options);g.setMaterials(t.materials),g.preload();var v=new TONG.UTF8Loader.BufferGeometryCreator;return function(e,t,r,a,n,i){var s=v.create(r,a),o=g.create(i.material),l=new TONG.Mesh(s,o);p[e].add(l),f[e]++,f[e]===d[e]&&(h++,m.add(p[e]),h===c&&u(m))}},TONG.UTF8Loader.prototype.downloadModel=function(e,t,r,a){var n=this.createMeshCallback(t,r,a);this.downloadMeshes(e,r.urls,r.decodeParams,n)},TONG.UTF8Loader.prototype.downloadModelJson=function(a,n,i){getJsonRequest(a,function(e){e.decodeParams||(i&&i.decodeParams?e.decodeParams=i.decodeParams:e.decodeParams=DEFAULT_DECODE_PARAMS),e.options=i;var t=a.substr(0,a.lastIndexOf("/")+1),r=t;i&&i.geometryBase&&"/"!==(t=i.geometryBase).charAt(t.length-1)&&(t+="/"),i&&i.materialBase&&"/"!==(r=i.materialBase).charAt(r.length-1)&&(r+="/"),this.downloadModel(t,r,e,n)}.bind(this))},TONG.VRMLLoader=function(e){this.manager=void 0!==e?e:TONG.DefaultLoadingManager},TONG.VRMLLoader.prototype={constructor:TONG.VRMLLoader,isRecordingPoints:!1,isRecordingFaces:!1,points:[],indexes:[],isRecordingAngles:!1,isRecordingColors:!1,angles:[],colors:[],recordingFieldname:null,crossOrigin:"anonymous",load:function(e,t,r,a){var n=this;new TONG.FileLoader(this.manager).load(e,function(e){t(n.parse(e))},r,a)},setCrossOrigin:function(e){return this.crossOrigin=e,this},parse:function(e){var Z=this.texturePath||"",X=new TONG.TextureLoader(this.manager);X.setCrossOrigin(this.crossOrigin);for(var t=new TONG.Scene,r=e.split("\n"),a=r.length-1;-1<a;a--){var n=r[a];if(/{.*[{\[]/.test(n))(i=n.split("{").join("{\n").split("\n")).unshift(1),i.unshift(a),r.splice.apply(r,i);else if(/\].*}/.test(n)){var i;(i=n.split("]").join("]\n").split("\n")).unshift(1),i.unshift(a),r.splice.apply(r,i)}if(/}.*}/.test(n))(i=n.split("}").join("}\n").split("\n")).unshift(1),i.unshift(a),r.splice.apply(r,i);/^\b[^\s]+\b$/.test(n.trim())?(r[a+1]=n+" "+r[a+1].trim(),r.splice(a,1)):-1<n.indexOf("coord")&&n.indexOf("[")<0&&n.indexOf("{")<0&&(r[a]+=" Coordinate {}")}var s=r.shift();return/V1.0/.exec(s)?console.warn("TONG.VRMLLoader: V1.0 not supported yet."):/V2.0/.exec(s)&&function(e,V){var j={},h=/(\b|\-|\+)([\d\.e]+)/,c=/([\d\.\+\-e]+)\s+([\d\.\+\-e]+)/g,d=/([\d\.\+\-e]+)\s+([\d\.\+\-e]+)\s+([\d\.\+\-e]+)/g;function W(e,t,r,a,n){for(var i=!0===n?1:-1,s=[],o={},l={},u=0;u<r.length;u++){var h={x:i*(Math.cos(r[u])*t),y:i*(Math.sin(r[u])*t)};s.push(h)}for(var c=e.index,d=e.attributes.position,f=new TONG.BufferAttribute(new Float32Array(3*e.attributes.position.count),3),p=new TONG.Vector3,m=new TONG.Color,g=0;g<c.count;g++){var v=c.getX(g);p.fromBufferAttribute(d,v);for(var y=0;y<a.length;y++)if(0===y?(o.x=0,o.y=!0===n?t:-1*t):(o.x=s[y-1].x,o.y=s[y-1].y),void 0!==(l=s[y]))if(!0==(!0===n?p.y<=o.y&&p.y>l.y:p.y>=o.y&&p.y<l.y)){var T=a[y],b=a[y+1],_=Math.abs(p.y-o.y)/(o.y-l.y);m.copy(T).lerp(b,_),f.setXYZ(v,m.r,m.g,m.b)}else{var O=a[!0===n?a.length-1:0];f.setXYZ(v,O.r,O.g,O.b)}}e.addAttribute("color",f)}var f=[];function p(e,t){for(var r,a,n,i=[],s={},o=/[^\s,\[\]]+/g;null!==(r=o.exec(t));)i.push(r[0]);switch(a=i[0]){case"skyAngle":case"groundAngle":this.recordingFieldname=a,this.isRecordingAngles=!0,this.angles=[];break;case"skyColor":case"groundColor":this.recordingFieldname=a,this.isRecordingColors=!0,this.colors=[];break;case"point":this.recordingFieldname=a,this.isRecordingPoints=!0,this.points=[];break;case"coordIndex":case"texCoordIndex":this.recordingFieldname=a,this.isRecordingFaces=!0,this.indexes=[]}if(this.isRecordingFaces){if(0<i.length)for(var l=0;l<i.length;l++)/(-?\d+)/.test(i[l])&&("-1"===i[l]?(0<f.length&&this.indexes.push(f),f=[]):f.push(parseInt(i[l])));/]/.exec(t)&&(0<f.length&&this.indexes.push(f),f=[],this.isRecordingFaces=!1,e[this.recordingFieldname]=this.indexes)}else if(this.isRecordingPoints){if("Coordinate"==e.nodeType)for(;null!==(i=d.exec(t));)n={x:parseFloat(i[1]),y:parseFloat(i[2]),z:parseFloat(i[3])},this.points.push(n);if("TextureCoordinate"==e.nodeType)for(;null!==(i=c.exec(t));)n={x:parseFloat(i[1]),y:parseFloat(i[2])},this.points.push(n);/]/.exec(t)&&(this.isRecordingPoints=!1,e.points=this.points)}else if(this.isRecordingAngles){if(0<i.length)for(l=0;l<i.length;l++)h.test(i[l])&&this.angles.push(parseFloat(i[l]));/]/.exec(t)&&(this.isRecordingAngles=!1,e[this.recordingFieldname]=this.angles)}else if(this.isRecordingColors){for(;null!==(i=d.exec(t));){var u={r:parseFloat(i[1]),g:parseFloat(i[2]),b:parseFloat(i[3])};this.colors.push(u)}/]/.exec(t)&&(this.isRecordingColors=!1,e[this.recordingFieldname]=this.colors)}else if("NULL"!==i[i.length-1]&&"children"!==a){switch(a){case"diffuseColor":case"emissiveColor":case"specularColor":case"color":if(4!==i.length){console.warn("TONG.VRMLLoader: Invalid color format detected for %s.",a);break}s={r:parseFloat(i[1]),g:parseFloat(i[2]),b:parseFloat(i[3])};break;case"location":case"direction":case"translation":case"scale":case"size":if(4!==i.length){console.warn("TONG.VRMLLoader: Invalid vector format detected for %s.",a);break}s={x:parseFloat(i[1]),y:parseFloat(i[2]),z:parseFloat(i[3])};break;case"intensity":case"cutOffAngle":case"radius":case"topRadius":case"bottomRadius":case"height":case"transparency":case"shininess":case"ambientIntensity":if(2!==i.length){console.warn("TONG.VRMLLoader: Invalid single float value specification detected for %s.",a);break}s=parseFloat(i[1]);break;case"rotation":if(5!==i.length){console.warn("TONG.VRMLLoader: Invalid quaternion format detected for %s.",a);break}s={x:parseFloat(i[1]),y:parseFloat(i[2]),z:parseFloat(i[3]),w:parseFloat(i[4])};break;case"on":case"ccw":case"solid":case"colorPerVertex":case"convex":if(2!==i.length){console.warn("TONG.VRMLLoader: Invalid format detected for %s.",a);break}s="TRUE"===i[1]}e[a]=s}return s}!function e(t,r){var a;if("string"!=typeof t){a=r,-1<t.string.indexOf("AmbientLight")&&"PointLight"===t.nodeType&&(t.nodeType="AmbientLight");var n=void 0===t.on||t.on,i=void 0!==t.intensity?t.intensity:1,s=new TONG.Color;if(t.color&&s.copy(t.color),"AmbientLight"===t.nodeType)(a=new TONG.AmbientLight(s,i)).visible=n,r.add(a);else if("PointLight"===t.nodeType){var o=0;void 0!==t.radius&&t.radius<1e3&&(o=t.radius),(a=new TONG.PointLight(s,i,o)).visible=n,r.add(a)}else if("SpotLight"===t.nodeType){i=1,o=0;var l=Math.PI/3;n=!0,void 0!==t.radius&&t.radius<1e3&&(o=t.radius),void 0!==t.cutOffAngle&&(l=t.cutOffAngle),(a=new TONG.SpotLight(s,i,o,l,0)).visible=n,r.add(a)}else if("Transform"===t.nodeType||"Group"===t.nodeType){if(a=new TONG.Object3D,/DEF/.exec(t.string)&&(a.name=/DEF\s+([^\s]+)/.exec(t.string)[1],j[a.name]=a),void 0!==t.translation){var u=t.translation;a.position.set(u.x,u.y,u.z)}if(void 0!==t.rotation){var h=t.rotation;a.quaternion.setFromAxisAngle(new TONG.Vector3(h.x,h.y,h.z),h.w)}if(void 0!==t.scale){var c=t.scale;a.scale.set(c.x,c.y,c.z)}r.add(a)}else if("Shape"===t.nodeType)a=new TONG.Mesh,/DEF/.exec(t.string)&&(a.name=/DEF\s+([^\s]+)/.exec(t.string)[1],j[a.name]=a),r.add(a);else if("Background"===t.nodeType){var d=2e4,f=new TONG.SphereBufferGeometry(d,20,20),p=new TONG.MeshBasicMaterial({fog:!1,side:TONG.BackSide});if(1<t.skyColor.length)W(f,d,t.skyAngle,t.skyColor,!0),p.vertexColors=TONG.VertexColors;else{var m=t.skyColor[0];p.color.setRGB(m.r,m.b,m.g)}if(V.add(new TONG.Mesh(f,p)),void 0!==t.groundColor){d=12e3;var g=new TONG.SphereBufferGeometry(d,20,20,0,2*Math.PI,.5*Math.PI,1.5*Math.PI),v=new TONG.MeshBasicMaterial({fog:!1,side:TONG.BackSide,vertexColors:TONG.VertexColors});W(g,d,t.groundAngle,t.groundColor,!1),V.add(new TONG.Mesh(g,v))}}else{if(/geometry/.exec(t.string)){if("Box"===t.nodeType)c=t.size,r.geometry=new TONG.BoxBufferGeometry(c.x,c.y,c.z);else if("Cylinder"===t.nodeType)r.geometry=new TONG.CylinderBufferGeometry(t.radius,t.radius,t.height);else if("Cone"===t.nodeType)r.geometry=new TONG.CylinderBufferGeometry(t.topRadius,t.bottomRadius,t.height);else if("Sphere"===t.nodeType)r.geometry=new TONG.SphereBufferGeometry(t.radius);else if("IndexedFaceSet"===t.nodeType){var y,T,b,_,O,w=new TONG.BufferGeometry,N=[],A=[];for(I=0,b=t.children.length;I<b;I++){if("TextureCoordinate"===(B=t.children[I]).nodeType&&B.points)for(_=0,O=B.points.length;_<O;_++)T=B.points[_],A.push(T.x,T.y);if("Coordinate"===B.nodeType){if(B.points)for(_=0,O=B.points.length;_<O;_++)y=B.points[_],N.push(y.x,y.y,y.z);if(-1<B.string.indexOf("DEF")){var x=/DEF\s+([^\s]+)/.exec(B.string)[1];j[x]=N.slice(0)}-1<B.string.indexOf("USE")&&(z=/USE\s+([^\s]+)/.exec(B.string)[1],N=j[z])}}var M=0;if(t.coordIndex){var G=[],k=[];for(y=new TONG.Vector3,T=new TONG.Vector2,I=0,b=t.coordIndex.length;I<b;I++){var L=t.coordIndex[I];for(M=0;3<=L.length&&M<L.length-2;){void 0===t.ccw&&(t.ccw=!0);var S=L[0],C=L[M+(t.ccw?1:2)],F=L[M+(t.ccw?2:1)];y.fromArray(N,3*S),T.fromArray(A,2*S),G.push(y.x,y.y,y.z),k.push(T.x,T.y),y.fromArray(N,3*C),T.fromArray(A,2*C),G.push(y.x,y.y,y.z),k.push(T.x,T.y),y.fromArray(N,3*F),T.fromArray(A,2*F),G.push(y.x,y.y,y.z),k.push(T.x,T.y),M++}}N=G,A=k}else r.parent.remove(r);!1===t.solid&&(r.material.side=TONG.DoubleSide),w.solid=t.solid,w.addAttribute("position",new TONG.Float32BufferAttribute(N,3)),0<A.length&&w.addAttribute("uv",new TONG.Float32BufferAttribute(A,2)),w.computeVertexNormals(),w.computeBoundingSphere(),/DEF/.exec(t.string)&&(w.name=/DEF ([^\s]+)/.exec(t.string)[1],j[w.name]=w),r.geometry=w}return}if(/appearance/.exec(t.string)){for(var I=0;I<t.children.length;I++){var B;if("Material"===(B=t.children[I]).nodeType){var E=new TONG.MeshPhongMaterial;if(void 0!==B.diffuseColor){var R=B.diffuseColor;E.color.setRGB(R.r,R.g,R.b)}if(void 0!==B.emissiveColor){var D=B.emissiveColor;E.emissive.setRGB(D.r,D.g,D.b)}void 0!==B.specularColor&&(c=B.specularColor,E.specular.setRGB(c.r,c.g,c.b)),void 0!==B.transparency&&(u=B.transparency,E.opacity=Math.abs(1-u),E.transparent=!0),/DEF/.exec(t.string)&&(E.name=/DEF ([^\s]+)/.exec(t.string)[1],j[E.name]=E),r.material=E}if("ImageTexture"===B.nodeType){var P=/"([^"]+)"/.exec(B.children[0]);P&&(r.material.name=P[1],r.material.map=X.load(Z+P[1]))}}return}}I=0;for(var U=t.children.length;I<U;I++)e(t.children[I],a)}else if(/USE/.exec(t)){var z=/USE\s+?([^\s]+)/.exec(t)[1];null==j[z]?console.warn("TONG.VRMLLoader: %s is not defined.",z):/appearance/.exec(t)&&z?r.material=j[z].clone():/geometry/.exec(t)&&z?(r.geometry=j[z].clone(),void 0!==j[z].solid&&!1===j[z].solid&&(r.geometry.solid=!1,r.material.side=TONG.DoubleSide)):z&&(a=j[z].clone(),r.add(a))}}(function(e){for(var t,r,a={string:"Scene",children:[]},n=a,i=0;i<e.length;i++){var s="",o=e[i];if(null===/^\s+?$/g.exec(o)&&""!==(o=o.trim())){if(/#/.exec(o)){var l=o.split("#");o=l[0],s=l[1]}if(t=/([^\s]*){1}(?:\s+)?{/.exec(o)){var u={nodeType:t[1],string:o,parent:n,children:[],comment:s};n.children.push(u),n=u,/}/.exec(o)&&(r=/{(.*)}/.exec(o)[1],u.children.push(r),p(n,r),n=n.parent)}else/}/.exec(o)?n=n.parent:""!==o&&(p(n,o),n.children.push(o))}}return a}(e),V)}(r,t),t}},TONG.VTKLoader=function(e){this.manager=void 0!==e?e:TONG.DefaultLoadingManager},Object.assign(TONG.VTKLoader.prototype,TONG.EventDispatcher.prototype,{load:function(e,t,r,a){var n=this,i=new TONG.FileLoader(n.manager);i.setResponseType("arraybuffer"),i.load(e,function(e){t(n.parse(e))},r,a)},parse:function(e){function t(e){for(var t="",r=new Uint8Array(e),a=0,n=r.length;n--;)t+=String.fromCharCode(r[a++]);return t}var r=TONG.LoaderUtils.decodeText(new Uint8Array(e,0,250)).split("\n");return-1!==r[0].indexOf("xml")?function(e){function O(e){var t,r,a,n,i,s,o="undefined"!=typeof Uint8Array?Uint8Array:Array,l=[],u=[],h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",c=h.length;for(t=0;t<c;t++)l[t]=h[t];for(t=0;t<c;++t)u[h.charCodeAt(t)]=t;if(u["-".charCodeAt(0)]=62,u["_".charCodeAt(0)]=63,0<(c=e.length)%4)throw new Error("Invalid string. Length must be a multiple of 4");s=new o(3*c/4-(i="="===e[c-2]?2:"="===e[c-1]?1:0)),a=0<i?c-4:c;var d=0;for(r=t=0;t<a;t+=4,r+=3)n=u[e.charCodeAt(t)]<<18|u[e.charCodeAt(t+1)]<<12|u[e.charCodeAt(t+2)]<<6|u[e.charCodeAt(t+3)],s[d++]=(16711680&n)>>16,s[d++]=(65280&n)>>8,s[d++]=255&n;return 2===i?(n=u[e.charCodeAt(t)]<<2|u[e.charCodeAt(t+1)]>>4,s[d++]=255&n):1===i&&(n=u[e.charCodeAt(t)]<<10|u[e.charCodeAt(t+1)]<<4|u[e.charCodeAt(t+2)]>>2,s[d++]=n>>8&255,s[d++]=255&n),s}function t(e,t){var r,a,n,i,s,o,l,u,h=0;if("UInt64"===w.attributes.header_type?h=8:"UInt32"===w.attributes.header_type&&(h=4),"binary"===e.attributes.format&&t){var c,d,f,p,m,g;if("Float32"===e.attributes.type)var v=new Float32Array;else"Int64"===e.attributes.type&&(v=new Int32Array);d=(c=O(e["#text"]))[0];for(var y=1;y<h-1;y++)d|=c[y]<<y*h;for(p=(d+3)*h,g=p+=0<p%3?3-p%3:0,(m=[]).push(g),f=3*h,y=0;y<d;y++){for(var T=c[y*h+f],b=1;b<h-1;b++)T|=c[y*h+f+b]<<8*b;g+=T,m.push(g)}for(y=0;y<m.length-1;y++)_=(_=new Zlib.Inflate(c.slice(m[y],m[y+1]),{resize:!0,verify:!0}).decompress()).buffer,"Float32"===e.attributes.type?(_=new Float32Array(_),o=_,u=void 0,l=(s=v).length,(u=new Float32Array(l+o.length)).set(s),u.set(o,l),v=u):"Int64"===e.attributes.type&&(_=new Int32Array(_),a=_,i=void 0,n=(r=v).length,(i=new Int32Array(n+a.length)).set(r),i.set(a,n),v=i);delete e["#text"],"Float32"===e.attributes.type?"binary"===e.attributes.format&&(t||(v=v.filter(function(e,t){if(0!==t)return!0}))):"Int64"===e.attributes.type&&"binary"===e.attributes.format&&(t||(v=v.filter(function(e,t){if(0!==t)return!0})),v=v.filter(function(e,t){if(t%2!=1)return!0}))}else{if("binary"!==e.attributes.format||t)if(e["#text"])var _=e["#text"].split(/\s+/).filter(function(e){if(""!==e)return e});else _=new Int32Array(0).buffer;else _=(_=O(e["#text"])).slice(h).buffer;delete e["#text"],"Float32"===e.attributes.type?v=new Float32Array(_):"Int32"===e.attributes.type?v=new Int32Array(_):"Int64"===e.attributes.type&&(v=new Int32Array(_),"binary"===e.attributes.format&&(v=v.filter(function(e,t){if(t%2!=1)return!0})))}return v}var r=null;if(window.DOMParser)try{r=(new DOMParser).parseFromString(e,"text/xml")}catch(e){r=null}else{if(!window.ActiveXObject)throw new Error("Cannot parse xml string!");try{if((r=new ActiveXObject("Microsoft.XMLDOM")).async=!1,!r.loadXML())throw new Error(r.parseError.reason+r.parseError.srcText)}catch(e){r=null}}var w=function e(t){var r={};if(1===t.nodeType){if(t.attributes&&0<t.attributes.length){r.attributes={};for(var a=0;a<t.attributes.length;a++){var n=t.attributes.item(a);r.attributes[n.nodeName]=n.nodeValue.trim()}}}else 3===t.nodeType&&(r=t.nodeValue.trim());if(t.hasChildNodes())for(var i=0;i<t.childNodes.length;i++){var s=t.childNodes.item(i),o=s.nodeName;if(void 0===r[o])""!==(u=e(s))&&(r[o]=u);else{if(void 0===r[o].push){var l=r[o];r[o]=[l]}var u;""!==(u=e(s))&&r[o].push(u)}}return r}(r.documentElement),a=[],n=[],i=[];if(w.PolyData){for(var s=w.PolyData.Piece,o=w.attributes.hasOwnProperty("compressor"),l=["PointData","Points","Strips","Polys"],u=0,h=l.length;u<h;){var c=s[l[u]];if(c&&c.DataArray){if("[object Array]"===Object.prototype.toString.call(c.DataArray))var d=c.DataArray;else d=[c.DataArray];for(var f=0,p=d.length;f<p;)"#text"in d[f]&&0<d[f]["#text"].length&&(d[f].text=t(d[f],o)),f++;switch(l[u]){case"PointData":var m=parseInt(s.attributes.NumberOfPoints),g=c.attributes.Normals;if(0<m)for(var v=0,y=d.length;v<y;v++)if(g===d[v].attributes.Name){var T=d[v].attributes.NumberOfComponents;(n=new Float32Array(m*T)).set(d[v].text,0)}break;case"Points":0<(m=parseInt(s.attributes.NumberOfPoints))&&(T=c.DataArray.attributes.NumberOfComponents,(a=new Float32Array(m*T)).set(c.DataArray.text,0));break;case"Strips":var b=parseInt(s.attributes.NumberOfStrips);if(0<b){var _=new Int32Array(c.DataArray[0].text.length),N=new Int32Array(c.DataArray[1].text.length);_.set(c.DataArray[0].text,0),N.set(c.DataArray[1].text,0);var A=b+_.length;i=new Uint32Array(3*A-9*b);var x=0;for(v=0,y=b;v<y;v++){for(var M=[],G=0,k=N[v],L=0;G<k-L;G++)M.push(_[G]),0<v&&(L=N[v-1]);var S=0;for(k=N[v],L=0;S<k-L-2;S++)S%2?(i[x++]=M[S],i[x++]=M[S+2],i[x++]=M[S+1]):(i[x++]=M[S],i[x++]=M[S+1],i[x++]=M[S+2]),0<v&&(L=N[v-1])}}break;case"Polys":var C=parseInt(s.attributes.NumberOfPolys);if(0<C){_=new Int32Array(c.DataArray[0].text.length),N=new Int32Array(c.DataArray[1].text.length),_.set(c.DataArray[0].text,0),N.set(c.DataArray[1].text,0),A=C+_.length,i=new Uint32Array(3*A-9*C);var F=x=0;for(y=C,L=v=0;v<y;){var I=[];for(G=0,k=N[v];G<k-L;)I.push(_[F++]),G++;for(S=1;S<k-L-1;)i[x++]=I[0],i[x++]=I[S],i[x++]=I[S+1],S++;L=N[++v-1]}}}}u++}var B=new TONG.BufferGeometry;return B.setIndex(new TONG.BufferAttribute(i,1)),B.addAttribute("position",new TONG.BufferAttribute(a,3)),n.length===a.length&&B.addAttribute("normal",new TONG.BufferAttribute(n,3)),B}}(t(e)):r[2].includes("ASCII")?function(e){var t,r=[],a=[],n=[],i=[],s=/(\-?\d+\.?[\d\-\+e]*)\s+(\-?\d+\.?[\d\-\+e]*)\s+(\-?\d+\.?[\d\-\+e]*)/g,o=/^(\d+)\s+([\s\d]*)/,l=/^POINTS /,u=/^POLYGONS /,h=/^TRIANGLE_STRIPS /,c=/^POINT_DATA[ ]+(\d+)/,d=/^CELL_DATA[ ]+(\d+)/,f=/^COLOR_SCALARS[ ]+(\w+)[ ]+3/,p=/^NORMALS[ ]+(\w+)[ ]+(\w+)/,m=!1,g=!1,v=!1,y=!1,T=!1,b=!1,_=!1,O=e.split("\n");for(var w in O){var N=O[w];if(m)for(;null!==(t=s.exec(N));){var A=parseFloat(t[1]),x=parseFloat(t[2]),M=parseFloat(t[3]);a.push(A,x,M)}else if(g){if(null!==(t=o.exec(N))){var G=parseInt(t[1]),k=t[2].split(/\s+/);if(3<=G)for(var L=parseInt(k[0]),S=1,C=0;C<G-2;++C)F=parseInt(k[S]),I=parseInt(k[S+1]),r.push(L,F,I),S++}}else if(v){if(null!==(t=o.exec(N))){var F,I;if(G=parseInt(t[1]),k=t[2].split(/\s+/),3<=G)for(C=0;C<G-2;C++)C%2==1?(L=parseInt(k[C]),F=parseInt(k[C+2]),I=parseInt(k[C+1])):(L=parseInt(k[C]),F=parseInt(k[C+1]),I=parseInt(k[C+2])),r.push(L,F,I)}}else if(y||T)if(b)for(;null!==(t=s.exec(N));){var B=parseFloat(t[1]),E=parseFloat(t[2]),R=parseFloat(t[3]);n.push(B,E,R)}else if(_)for(;null!==(t=s.exec(N));){var D=parseFloat(t[1]),P=parseFloat(t[2]),U=parseFloat(t[3]);i.push(D,P,U)}null!==u.exec(N)?v=m=!(g=!0):null!==l.exec(N)?v=!(m=!(g=!1)):null!==h.exec(N)?v=!(m=g=!1):null!==c.exec(N)?v=g=m=!(y=!0):null!==d.exec(N)?v=g=m=!(T=!0):null!==f.exec(N)?v=g=m=_=!(b=!0):null!==p.exec(N)&&(v=g=m=b=!(_=!0))}var z=new TONG.BufferGeometry;if(z.setIndex(r),z.addAttribute("position",new TONG.Float32BufferAttribute(a,3)),i.length===a.length&&z.addAttribute("normal",new TONG.Float32BufferAttribute(i,3)),n.length!==r.length)n.length===a.length&&z.addAttribute("color",new TONG.Float32BufferAttribute(n,3));else{var V=(z=z.toNonIndexed()).attributes.position.count/3;if(n.length===3*V){var j=[];for(w=0;w<V;w++)B=n[3*w+0],E=n[3*w+1],R=n[3*w+2],j.push(B,E,R),j.push(B,E,R),j.push(B,E,R);z.addAttribute("color",new TONG.Float32BufferAttribute(j,3))}}return z}(t(e)):function(e){var t,r,a,n,i,s,o,l=new Uint8Array(e),u=new DataView(e),h=[],c=[],d=[],f=[],p=0;function m(e,t){for(var r=t,a=e[r],n=[];10!==a;)n.push(String.fromCharCode(a)),a=e[++r];return{start:t,end:r,next:r+1,parsedString:n.join("")}}for(;;){if(0===(o=(s=m(l,p)).parsedString).indexOf("POINTS")){for(f.push(o),t=4*(n=parseInt(o.split(" ")[1],10))*3,h=new Float32Array(3*n),r=s.next,a=0;a<n;a++)h[3*a]=u.getFloat32(r,!1),h[3*a+1]=u.getFloat32(r+4,!1),h[3*a+2]=u.getFloat32(r+8,!1),r+=12;s.next=s.next+t+1}else if(0===o.indexOf("TRIANGLE_STRIPS")){var g=parseInt(o.split(" ")[1],10);t=4*(_=parseInt(o.split(" ")[2],10)),d=new Uint32Array(3*_-9*g);var v=0;for(r=s.next,a=0;a<g;a++){var y=u.getInt32(r,!1),T=[];for(r+=4,i=0;i<y;i++)T.push(u.getInt32(r,!1)),r+=4;for(var b=0;b<y-2;b++)b%2?(d[v++]=T[b],d[v++]=T[b+2],d[v++]=T[b+1]):(d[v++]=T[b],d[v++]=T[b+1],d[v++]=T[b+2])}s.next=s.next+t+1}else if(0===o.indexOf("POLYGONS")){var _;for(g=parseInt(o.split(" ")[1],10),t=4*(_=parseInt(o.split(" ")[2],10)),d=new Uint32Array(3*_-9*g),v=0,r=s.next,a=0;a<g;a++){for(y=u.getInt32(r,!1),T=[],r+=4,i=0;i<y;i++)T.push(u.getInt32(r,!1)),r+=4;for(b=1;b<y-1;b++)d[v++]=T[0],d[v++]=T[b],d[v++]=T[b+1]}s.next=s.next+t+1}else if(0===o.indexOf("POINT_DATA")){for(n=parseInt(o.split(" ")[1],10),s=m(l,s.next),t=4*n*3,c=new Float32Array(3*n),r=s.next,a=0;a<n;a++)c[3*a]=u.getFloat32(r,!1),c[3*a+1]=u.getFloat32(r+4,!1),c[3*a+2]=u.getFloat32(r+8,!1),r+=12;s.next=s.next+t}if((p=s.next)>=l.byteLength)break}var O=new TONG.BufferGeometry;return O.setIndex(new TONG.BufferAttribute(d,1)),O.addAttribute("position",new TONG.BufferAttribute(h,3)),c.length===h.length&&O.addAttribute("normal",new TONG.BufferAttribute(c,3)),O}(e)}}),function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e.TONG=e.TONG||{},e.TONG.XLoader=t())}(this,function(){var r=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},e=function(){function a(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,r){return t&&a(e.prototype,t),r&&a(e,r),e}}(),u=function e(){r(this,e),this.boneName="",this.BoneIndex=0,this.Indeces=[],this.Weights=[],this.initMatrix=null,this.OffsetMatrix=null},a=function e(){r(this,e),this.animeName="",this.boneName="",this.targetBone=null,this.keyType=4,this.frameStartLv=0,this.keyFrames=[],this.InverseMx=null},n=function(){function t(e){r(this,t),this.fps=30,this.name="xanimation",this.length=0,this.hierarchy=[],this.putFlags=e,void 0===this.putFlags.putPos&&(this.putFlags.putPos=!0),void 0===this.putFlags.putRot&&(this.putFlags.putRot=!0),void 0===this.putFlags.putScl&&(this.putFlags.putScl=!0)}return e(t,[{key:"make",value:function(e){for(var t=0;t<e.length;t++)this.hierarchy.push(this.makeBonekeys(e[t]));this.length=this.hierarchy[0].keys[this.hierarchy[0].keys.length-1].time}},{key:"clone",value:function(){return Object.assign({},this)}},{key:"makeBonekeys",value:function(e){var t={};return t.name=e.boneName,t.parent="",t.keys=this.keyFrameRefactor(e),t.copy=function(){return Object.assign({},this)},t}},{key:"keyFrameRefactor",value:function(e){for(var t=[],r=0;r<e.keyFrames.length;r++){var a={};a.time=e.keyFrames[r].time*this.fps,e.keyFrames[r].pos&&this.putFlags.putPos&&(a.pos=e.keyFrames[r].pos),e.keyFrames[r].rot&&this.putFlags.putRot&&(a.rot=e.keyFrames[r].rot),e.keyFrames[r].scl&&this.putFlags.putScl&&(a.scl=e.keyFrames[r].scl),e.keyFrames[r].matrix&&(a.matrix=e.keyFrames[r].matrix,this.putFlags.putPos&&(a.pos=(new TONG.Vector3).setFromMatrixPosition(a.matrix)),this.putFlags.putRot&&(a.rot=(new TONG.Quaternion).setFromRotationMatrix(a.matrix)),this.putFlags.putScl&&(a.scl=(new TONG.Vector3).setFromMatrixScale(a.matrix))),t.push(a)}return t}}]),t}(),c=function e(){r(this,e),this.index=0,this.Frame=0,this.time=0,this.matrix=null};return function(){function t(e){r(this,t),this.debug=!1,this.manager=void 0!==e?e:new TONG.DefaultLoadingManager,this.texloader=new TONG.TextureLoader(this.manager),this.url="",this.baseDir="",this._putMatLength=0,this._nowMat=null,this._nowFrameName="",this.frameHierarchie=[],this.Hierarchies={},this.HieStack=[],this._currentObject={},this._currentFrame={},this._data=null,this.onLoad=null,this.IsUvYReverse=!0,this.Meshes=[],this.animations=[],this.animTicksPerSecond=30,this._currentGeo=null,this._currentAnime=null,this._currentAnimeFrames=null}return e(t,[{key:"_setArgOption",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;if(e){for(var r=t;r<e.length;r++)switch(r){case 0:this.url=e[r];break;case 1:this.options=e[r]}void 0===this.options&&(this.options={})}}},{key:"load",value:function(e,t,r,a){var n=this;this._setArgOption(e);var i=new TONG.FileLoader(this.manager);i.setResponseType("arraybuffer"),i.load(this.url,function(e){n._parse(e,t)},r,a)}},{key:"fromResponsedData",value:function(e,t,r){this._setArgOption(t),this._parse(e,r)}},{key:"_readLine",value:function(e){for(var t=0;;){var r=-1;if(-1===(r=e.indexOf("//",t))&&(r=e.indexOf("#",t)),!(-1<r&&r<2))break;var a=-1;t=0<(a=e.indexOf("\r\n",t))?a+2:0<(a=e.indexOf("\r",t))?a+1:e.indexOf("\n",t)+1}return e.substr(t)}},{key:"_readLine",value:function(e){for(var t=0;;){var r=-1;if(-1===(r=e.indexOf("//",t))&&(r=e.indexOf("#",t)),!(-1<r&&r<2))break;var a=-1;t=0<(a=e.indexOf("\r\n",t))?a+2:0<(a=e.indexOf("\r",t))?a+1:e.indexOf("\n",t)+1}return e.substr(t)}},{key:"_isBinary",value:function(e){var t=new DataView(e);if(84+50*t.getUint32(80,!0)===t.byteLength)return!0;for(var r=t.byteLength,a=0;a<r;a++)if(127<t.getUint8(a,!1))return!0;return!1}},{key:"ensureBinary",value:function(e){if("string"==typeof e){for(var t=new Uint8Array(e.length),r=0;r<e.length;r++)t[r]=255&e.charCodeAt(r);return t.buffer||t}return e}},{key:"ensureString",value:function(e){return"string"!=typeof e?TONG.LoaderUtils.decodeText(new Uint8Array(e)):e}},{key:"_parse",value:function(e,t){var r=this.ensureBinary(e);return this._data=this.ensureString(e),this.onLoad=t,this._isBinary(r)?this._parseBinary(r):this._parseASCII()}},{key:"_parseBinary",value:function(e){return this._parseASCII(TONG.LoaderUtils.decodeText(new Uint8Array(e)))}},{key:"_parseASCII",value:function(){0<this.url.lastIndexOf("/")&&(this.baseDir=this.url.substr(0,this.url.lastIndexOf("/")+1));this.Hierarchies.children=[],this._hierarchieParse(this.Hierarchies,16),this._changeRoot(),this._currentObject=this.Hierarchies.children.shift(),this.mainloop()}},{key:"_hierarchieParse",value:function(e,t){for(var r=t;;){var a=this._data.indexOf("{",r)+1,n=this._data.indexOf("}",r),i=this._data.indexOf("{",a)+1;if(!(0<a&&a<n)){r=-1===a?this._data.length:n+1;break}var s={children:[]},o=this._readLine(this._data.substr(r,a-r-1)).trim(),l=o.split(/ /g);if(0<l.length?(s.type=l[0],2<=l.length?s.name=l[1]:s.name=l[0]+this.Hierarchies.children.length):(s.name=o,s.type=""),"Animation"===s.type){s.data=this._data.substr(i,n-i).trim();var u=this._hierarchieParse(s,n+1);r=u.end,s.children=u.parent.children}else{var h=this._data.lastIndexOf(";",0<i?Math.min(i,n):n);if(s.data=this._data.substr(a,h-a).trim(),i<=0||n<i)r=n+1;else{var c=Math.max(h+1,a),d=this._hierarchieParse(s,c);r=d.end,s.children=d.parent.children}}s.parent=e,"template"!=s.type&&e.children.push(s)}return{parent:e,end:r}}},{key:"mainloop",value:function(){var e=this;this.mainProc(),this._currentObject.parent||0<this._currentObject.children.length||!this._currentObject.worked?setTimeout(function(){e.mainloop()},1):setTimeout(function(){e.onLoad({models:e.Meshes,animations:e.animations})},1)}},{key:"mainProc",value:function(){for(var e=!1;;){if(!this._currentObject.worked){switch(this._currentObject.type){case"template":break;case"AnimTicksPerSecond":this.animTicksPerSecond=parseInt(this._currentObject.data);break;case"Frame":this._setFrame();break;case"FrameTransformMatrix":this._setFrameTransformMatrix();break;case"Mesh":this._changeRoot(),this._currentGeo={},this._currentGeo.name=this._currentObject.name.trim(),this._currentGeo.parentName=this._getParentName(this._currentObject).trim(),this._currentGeo.VertexSetedBoneCount=[],this._currentGeo.GeometryData={vertices:[],normals:[],uvs:[],skinIndices:[],skinWeights:[],indices:[],materialIndices:[]},this._currentGeo.Materials=[],this._currentGeo.normalVectors=[],this._currentGeo.BoneInfs=[],this._currentGeo.baseFrame=this._currentFrame,this._makeBoneFrom_CurrentFrame(),this._readVertexDatas(),e=!0;break;case"MeshNormals":this._readVertexDatas();break;case"MeshTextureCoords":this._setMeshTextureCoords();break;case"VertexDuplicationIndices":break;case"MeshMaterialList":this._setMeshMaterialList();break;case"Material":this._setMaterial();break;case"SkinWeights":this._setSkinWeights();break;case"AnimationSet":this._changeRoot(),this._currentAnime={},this._currentAnime.name=this._currentObject.name.trim(),this._currentAnime.AnimeFrames=[];break;case"Animation":this._currentAnimeFrames&&this._currentAnime.AnimeFrames.push(this._currentAnimeFrames),this._currentAnimeFrames=new a,this._currentAnimeFrames.boneName=this._currentObject.data.trim();break;case"AnimationKey":this._readAnimationKey(),e=!0}this._currentObject.worked=!0}if(0<this._currentObject.children.length){if(this._currentObject=this._currentObject.children.shift(),this.debug&&console.log("processing "+this._currentObject.name),e)break}else if(this._currentObject.worked&&this._currentObject.parent&&!this._currentObject.parent.parent&&this._changeRoot(),this._currentObject.parent?this._currentObject=this._currentObject.parent:e=!0,e)break}}},{key:"_changeRoot",value:function(){null!=this._currentGeo&&this._currentGeo.name&&this._makeOutputGeometry(),this._currentGeo={},null!=this._currentAnime&&this._currentAnime.name&&(this._currentAnimeFrames&&(this._currentAnime.AnimeFrames.push(this._currentAnimeFrames),this._currentAnimeFrames=null),this._makeOutputAnimation()),this._currentAnime={}}},{key:"_getParentName",value:function(e){return e.parent?e.parent.name?e.parent.name:this._getParentName(e.parent):""}},{key:"_setFrame",value:function(){this._nowFrameName=this._currentObject.name.trim(),this._currentFrame={},this._currentFrame.name=this._nowFrameName,this._currentFrame.children=[],this._currentObject.parent&&this._currentObject.parent.name&&(this._currentFrame.parentName=this._currentObject.parent.name),this.frameHierarchie.push(this._nowFrameName),this.HieStack[this._nowFrameName]=this._currentFrame}},{key:"_setFrameTransformMatrix",value:function(){this._currentFrame.FrameTransformMatrix=new TONG.Matrix4;var e=this._currentObject.data.split(",");this._ParseMatrixData(this._currentFrame.FrameTransformMatrix,e),this._makeBoneFrom_CurrentFrame()}},{key:"_makeBoneFrom_CurrentFrame",value:function(){if(this._currentFrame.FrameTransformMatrix){var e=new TONG.Bone;if(e.name=this._currentFrame.name,e.applyMatrix(this._currentFrame.FrameTransformMatrix),e.matrixWorld=e.matrix,e.FrameTransformMatrix=this._currentFrame.FrameTransformMatrix,this._currentFrame.putBone=e,this._currentFrame.parentName)for(var t in this.HieStack)this.HieStack[t].name===this._currentFrame.parentName&&this.HieStack[t].putBone.add(this._currentFrame.putBone)}}},{key:"_readVertexDatas",value:function(){for(var e=0,t=0,r=0,a=0;;){var n=!1;if(0===r){e=this._readInt1(e).endRead,r=1,(a=this._currentObject.data.indexOf(";;",e)+1)<=0&&(a=this._currentObject.data.length)}else{var i=0;switch(t){case 0:i=this._currentObject.data.indexOf(",",e)+1;break;case 1:i=this._currentObject.data.indexOf(";,",e)+1}switch((0===i||a<i)&&(i=a,n=!(r=0)),this._currentObject.type){case"Mesh":switch(t){case 0:this._readVertex1(this._currentObject.data.substr(e,i-e));break;case 1:this._readFace1(this._currentObject.data.substr(e,i-e))}break;case"MeshNormals":switch(t){case 0:this._readNormalVector1(this._currentObject.data.substr(e,i-e))}}e=i+1,n&&t++}if(e>=this._currentObject.data.length)break}}},{key:"_readInt1",value:function(e){var t=this._currentObject.data.indexOf(";",e);return{refI:parseInt(this._currentObject.data.substr(e,t-e)),endRead:t+1}}},{key:"_readVertex1",value:function(e){var t=this._readLine(e.trim()).substr(0,e.length-2).split(";");this._currentGeo.GeometryData.vertices.push(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2])),this._currentGeo.GeometryData.skinIndices.push(0,0,0,0),this._currentGeo.GeometryData.skinWeights.push(1,0,0,0),this._currentGeo.VertexSetedBoneCount.push(0)}},{key:"_readFace1",value:function(e){var t=this._readLine(e.trim()).substr(2,e.length-4).split(",");this._currentGeo.GeometryData.indices.push(parseInt(t[0],10),parseInt(t[1],10),parseInt(t[2],10))}},{key:"_readNormalVector1",value:function(e){var t=this._readLine(e.trim()).substr(0,e.length-2).split(";");this._currentGeo.GeometryData.normals.push(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]))}},{key:"_buildGeometry",value:function(){for(var e=new TONG.BufferGeometry,t=[],r=[],a=[],n=[],i=[],s=this._currentGeo.GeometryData,o=0,l=s.indices.length;o<l;o++){var u=2*s.indices[o],h=3*s.indices[o],c=4*s.indices[o];t.push(s.vertices[h],s.vertices[h+1],s.vertices[h+2]),r.push(s.normals[h],s.normals[h+1],s.normals[h+2]),n.push(s.skinIndices[c],s.skinIndices[c+1],s.skinIndices[c+2],s.skinIndices[c+3]),i.push(s.skinWeights[c],s.skinWeights[c+1],s.skinWeights[c+2],s.skinWeights[c+3]),a.push(s.uvs[u],s.uvs[u+1])}return e.addAttribute("position",new TONG.Float32BufferAttribute(t,3)),e.addAttribute("normal",new TONG.Float32BufferAttribute(r,3)),e.addAttribute("uv",new TONG.Float32BufferAttribute(a,2)),e.addAttribute("skinIndex",new TONG.Uint16BufferAttribute(n,4)),e.addAttribute("skinWeight",new TONG.Float32BufferAttribute(i,4)),this._computeGroups(e,s.materialIndices),e}},{key:"_computeGroups",value:function(e,t){for(var r,a=[],n=void 0,i=0;i<t.length;i++){var s=t[i];s!==n&&(n=s,void 0!==r&&(r.count=3*i-r.start,a.push(r)),r={start:3*i,materialIndex:n})}void 0!==r&&(r.count=3*i-r.start,a.push(r)),e.groups=a}},{key:"_setMeshTextureCoords",value:function(){for(var e=0,t=0,r=0;;){switch(t){case 0:if(0===r){e=this._readInt1(0).endRead,r=1}else{var a=this._currentObject.data.indexOf(",",e)+1;0===a&&(a=this._currentObject.data.length,t=2,r=0);var n=this._currentObject.data.substr(e,a-e),i=this._readLine(n.trim()).split(";");this.IsUvYReverse?this._currentGeo.GeometryData.uvs.push(parseFloat(i[0]),1-parseFloat(i[1])):this._currentGeo.GeometryData.uvs.push(parseFloat(i[0]),parseFloat(i[1])),e=a+1}}if(e>=this._currentObject.data.length)break}}},{key:"_setMeshMaterialList",value:function(){for(var e=0,t=0,r=0;;){if(r<2){e=this._readInt1(e).endRead,r++}else{var a=this._currentObject.data.indexOf(";",e);-1===a&&(a=this._currentObject.data.length,t=3,r=0);for(var n=this._currentObject.data.substr(e,a-e),i=this._readLine(n.trim()).split(","),s=0;s<i.length;s++)this._currentGeo.GeometryData.materialIndices[s]=parseInt(i[s]);e=this._currentObject.data.length}if(e>=this._currentObject.data.length||3<=t)break}}},{key:"_setMaterial",value:function(){var e=new TONG.MeshPhongMaterial({color:16777215*Math.random()});e.side=TONG.FrontSide,e.name=this._currentObject.name;var t=0,r=this._currentObject.data.indexOf(";;",t),a=this._currentObject.data.substr(t,r-t),n=this._readLine(a.trim()).split(";");e.color.r=parseFloat(n[0]),e.color.g=parseFloat(n[1]),e.color.b=parseFloat(n[2]),t=r+2,r=this._currentObject.data.indexOf(";",t),a=this._currentObject.data.substr(t,r-t),e.shininess=parseFloat(this._readLine(a)),t=r+1,r=this._currentObject.data.indexOf(";;",t),a=this._currentObject.data.substr(t,r-t);var i=this._readLine(a.trim()).split(";");e.specular.r=parseFloat(i[0]),e.specular.g=parseFloat(i[1]),e.specular.b=parseFloat(i[2]),t=r+2,-1===(r=this._currentObject.data.indexOf(";;",t))&&(r=this._currentObject.data.length),a=this._currentObject.data.substr(t,r-t);var s=this._readLine(a.trim()).split(";");e.emissive.r=parseFloat(s[0]),e.emissive.g=parseFloat(s[1]),e.emissive.b=parseFloat(s[2]);for(var o=null;0<this._currentObject.children.length;){o=this._currentObject.children.shift(),this.debug&&console.log("processing "+o.name);var l=o.data.substr(1,o.data.length-2);switch(o.type){case"TextureFilename":e.map=this.texloader.load(this.baseDir+l);break;case"BumpMapFilename":e.bumpMap=this.texloader.load(this.baseDir+l),e.bumpScale=.05;break;case"NormalMapFilename":e.normalMap=this.texloader.load(this.baseDir+l),e.normalScale=new TONG.Vector2(2,2);break;case"EmissiveMapFilename":e.emissiveMap=this.texloader.load(this.baseDir+l);break;case"LightMapFilename":e.lightMap=this.texloader.load(this.baseDir+l)}}this._currentGeo.Materials.push(e)}},{key:"_setSkinWeights",value:function(){var e=new u,t=0,r=this._currentObject.data.indexOf(";",t),a=this._currentObject.data.substr(t,r-t);t=r+1,e.boneName=a.substr(1,a.length-2),e.BoneIndex=this._currentGeo.BoneInfs.length,t=(r=this._currentObject.data.indexOf(";",t))+1,r=this._currentObject.data.indexOf(";",t),a=this._currentObject.data.substr(t,r-t);for(var n=this._readLine(a.trim()).split(","),i=0;i<n.length;i++)e.Indeces.push(parseInt(n[i]));t=r+1,r=this._currentObject.data.indexOf(";",t),a=this._currentObject.data.substr(t,r-t);for(var s=this._readLine(a.trim()).split(","),o=0;o<s.length;o++)e.Weights.push(parseFloat(s[o]));t=r+1,(r=this._currentObject.data.indexOf(";",t))<=0&&(r=this._currentObject.data.length),a=this._currentObject.data.substr(t,r-t);var l=this._readLine(a.trim()).split(",");e.OffsetMatrix=new TONG.Matrix4,this._ParseMatrixData(e.OffsetMatrix,l),this._currentGeo.BoneInfs.push(e)}},{key:"_makePutBoneList",value:function(e,t){var r=!1;for(var a in this.HieStack)if(this.HieStack[a].name===e||r){r=!0;var n=new TONG.Bone;if(n.name=this.HieStack[a].name,n.applyMatrix(this.HieStack[a].FrameTransformMatrix),n.matrixWorld=n.matrix,n.FrameTransformMatrix=this.HieStack[a].FrameTransformMatrix,n.pos=(new TONG.Vector3).setFromMatrixPosition(n.FrameTransformMatrix).toArray(),n.rotq=(new TONG.Quaternion).setFromRotationMatrix(n.FrameTransformMatrix).toArray(),n.scl=(new TONG.Vector3).setFromMatrixScale(n.FrameTransformMatrix).toArray(),this.HieStack[a].parentName&&0<this.HieStack[a].parentName.length)for(var i=0;i<t.length;i++)if(this.HieStack[a].parentName===t[i].name){t[i].add(n),n.parent=i;break}t.push(n)}}},{key:"_makeOutputGeometry",value:function(){var e=null;if(0<this._currentGeo.BoneInfs.length){var t=[];this._makePutBoneList(this._currentGeo.baseFrame.parentName,t);for(var r=0;r<this._currentGeo.BoneInfs.length;r++){for(var a=0,n=0;n<t.length;n++)if(t[n].name===this._currentGeo.BoneInfs[r].boneName){t[a=n].OffsetMatrix=new TONG.Matrix4,t[n].OffsetMatrix.copy(this._currentGeo.BoneInfs[r].OffsetMatrix);break}for(var i=0;i<this._currentGeo.BoneInfs[r].Indeces.length;i++){var s=this._currentGeo.BoneInfs[r].Indeces[i],o=this._currentGeo.BoneInfs[r].Weights[i],l=4*s;switch(this._currentGeo.VertexSetedBoneCount[s]){case 0:this._currentGeo.GeometryData.skinIndices[l]=a,this._currentGeo.GeometryData.skinWeights[l]=o;break;case 1:this._currentGeo.GeometryData.skinIndices[l+1]=a,this._currentGeo.GeometryData.skinWeights[l+1]=o;break;case 2:this._currentGeo.GeometryData.skinIndices[l+2]=a,this._currentGeo.GeometryData.skinWeights[l+2]=o;break;case 3:this._currentGeo.GeometryData.skinIndices[l+3]=a,this._currentGeo.GeometryData.skinWeights[l+3]=o}this._currentGeo.VertexSetedBoneCount[s]++,4<this._currentGeo.VertexSetedBoneCount[s]&&console.log("warn! over 4 bone weight! :"+s)}}for(var u=0;u<this._currentGeo.Materials.length;u++)this._currentGeo.Materials[u].skinning=!0;for(var h=[],c=0;c<t.length;c++)t[c].OffsetMatrix?h.push(t[c].OffsetMatrix):h.push(new TONG.Matrix4);var d=this._buildGeometry();d.bones=t,(e=new TONG.SkinnedMesh(d,1===this._currentGeo.Materials.length?this._currentGeo.Materials[0]:this._currentGeo.Materials)).skeleton.boneInverses=h}else{var f=this._buildGeometry();e=new TONG.Mesh(f,1===this._currentGeo.Materials.length?this._currentGeo.Materials[0]:this._currentGeo.Materials)}e.name=this._currentGeo.name;var p=new TONG.Matrix4,m=this._currentGeo.baseFrame.putBone;if(m&&m.parent){for(;m=m.parent;)p.multiply(m.FrameTransformMatrix);e.applyMatrix(p)}this.Meshes.push(e)}},{key:"_readAnimationKey",value:function(){var e=0,t=this._currentObject.data.indexOf(";",e),r=this._currentObject.data.substr(e,t-e);e=t+1;var a=parseInt(this._readLine(r));e=(t=this._currentObject.data.indexOf(";",e))+1,r=this._currentObject.data.substr(e);for(var n=this._readLine(r.trim()).split(";;,"),i=0;i<n.length;i++){var s=n[i].split(";"),o=new c;if(o.type=a,o.Frame=parseInt(s[0]),o.index=this._currentAnimeFrames.keyFrames.length,o.time=o.Frame,4!=a){for(var l=!1,u=0;u<this._currentAnimeFrames.keyFrames.length;u++)if(this._currentAnimeFrames.keyFrames[u].Frame===o.Frame){o=this._currentAnimeFrames.keyFrames[u],l=!0;break}var h=s[2].split(",");switch(a){case 0:o.rot=new TONG.Quaternion(parseFloat(h[1]),parseFloat(h[2]),parseFloat(h[3]),-1*parseFloat(h[0]));break;case 1:o.scl=new TONG.Vector3(parseFloat(h[0]),parseFloat(h[1]),parseFloat(h[2]));break;case 2:o.pos=new TONG.Vector3(parseFloat(h[0]),parseFloat(h[1]),parseFloat(h[2]))}l||this._currentAnimeFrames.keyFrames.push(o)}else o.matrix=new TONG.Matrix4,this._ParseMatrixData(o.matrix,s[2].split(",")),this._currentAnimeFrames.keyFrames.push(o)}}},{key:"_makeOutputAnimation",value:function(){var e=new n(this.options);e.fps=this.animTicksPerSecond,e.name=this._currentAnime.name,e.make(this._currentAnime.AnimeFrames),this.animations.push(e)}},{key:"assignAnimation",value:function(e,t,r){var a=e,n=t;if(a||(a=this.Meshes[0]),n||(n=this.animations[0]),!a||!n)return null;var i={};i.fps=n.fps,i.name=n.name,i.length=n.length,i.hierarchy=[];for(var s=0;s<a.skeleton.bones.length;s++){for(var o=!1,l=0;l<n.hierarchy.length;l++)if(a.skeleton.bones[s].name===n.hierarchy[l].name){o=!0;var u=n.hierarchy[l].copy();if(u.parent=-1,a.skeleton.bones[s].parent&&"Bone"===a.skeleton.bones[s].parent.type)for(var h=0;h<i.hierarchy.length;h++)i.hierarchy[h].name===a.skeleton.bones[s].parent.name&&(u.parent=h,u.parentName=a.skeleton.bones[s].parent.name);i.hierarchy.push(u);break}if(!o){var c=n.hierarchy[0].copy();c.name=a.skeleton.bones[s].name,c.parent=-1;for(var d=0;d<c.keys.length;d++)c.keys[d].pos&&c.keys[d].pos.set(0,0,0),c.keys[d].scl&&c.keys[d].scl.set(1,1,1),c.keys[d].rot&&c.keys[d].rot.set(0,0,0,1);i.hierarchy.push(c)}}return a.geometry.animations||(a.geometry.animations=[]),a.geometry.animations.push(TONG.AnimationClip.parseAnimation(i,a.skeleton.bones)),a.animationMixer||(a.animationMixer=new TONG.AnimationMixer(a)),i}},{key:"_ParseMatrixData",value:function(e,t){e.set(parseFloat(t[0]),parseFloat(t[4]),parseFloat(t[8]),parseFloat(t[12]),parseFloat(t[1]),parseFloat(t[5]),parseFloat(t[9]),parseFloat(t[13]),parseFloat(t[2]),parseFloat(t[6]),parseFloat(t[10]),parseFloat(t[14]),parseFloat(t[3]),parseFloat(t[7]),parseFloat(t[11]),parseFloat(t[15]))}}]),t}()});var LZMA=LZMA||{};"object"==typeof module&&(module.exports=LZMA),LZMA.OutWindow=function(){this._windowSize=0},LZMA.OutWindow.prototype.create=function(e){this._buffer&&this._windowSize===e||(this._buffer=[]),this._windowSize=e,this._pos=0,this._streamPos=0},LZMA.OutWindow.prototype.flush=function(){var e=this._pos-this._streamPos;if(0!==e){for(;e--;)this._stream.writeByte(this._buffer[this._streamPos++]);this._pos>=this._windowSize&&(this._pos=0),this._streamPos=this._pos}},LZMA.OutWindow.prototype.releaseStream=function(){this.flush(),this._stream=null},LZMA.OutWindow.prototype.setStream=function(e){this.releaseStream(),this._stream=e},LZMA.OutWindow.prototype.init=function(e){e||(this._streamPos=0,this._pos=0)},LZMA.OutWindow.prototype.copyBlock=function(e,t){var r=this._pos-e-1;for(r<0&&(r+=this._windowSize);t--;)r>=this._windowSize&&(r=0),this._buffer[this._pos++]=this._buffer[r++],this._pos>=this._windowSize&&this.flush()},LZMA.OutWindow.prototype.putByte=function(e){this._buffer[this._pos++]=e,this._pos>=this._windowSize&&this.flush()},LZMA.OutWindow.prototype.getByte=function(e){var t=this._pos-e-1;return t<0&&(t+=this._windowSize),this._buffer[t]},LZMA.RangeDecoder=function(){},LZMA.RangeDecoder.prototype.setStream=function(e){this._stream=e},LZMA.RangeDecoder.prototype.releaseStream=function(){this._stream=null},LZMA.RangeDecoder.prototype.init=function(){var e=5;for(this._code=0,this._range=-1;e--;)this._code=this._code<<8|this._stream.readByte()},LZMA.RangeDecoder.prototype.decodeDirectBits=function(e){for(var t,r=0,a=e;a--;)this._range>>>=1,t=this._code-this._range>>>31,this._code-=this._range&t-1,r=r<<1|1-t,0==(4278190080&this._range)&&(this._code=this._code<<8|this._stream.readByte(),this._range<<=8);return r},LZMA.RangeDecoder.prototype.decodeBit=function(e,t){var r=e[t],a=(this._range>>>11)*r;return(2147483648^this._code)<(2147483648^a)?(this._range=a,e[t]+=2048-r>>>5,0==(4278190080&this._range)&&(this._code=this._code<<8|this._stream.readByte(),this._range<<=8),0):(this._range-=a,this._code-=a,e[t]-=r>>>5,0==(4278190080&this._range)&&(this._code=this._code<<8|this._stream.readByte(),this._range<<=8),1)},LZMA.initBitModels=function(e,t){for(;t--;)e[t]=1024},LZMA.BitTreeDecoder=function(e){this._models=[],this._numBitLevels=e},LZMA.BitTreeDecoder.prototype.init=function(){LZMA.initBitModels(this._models,1<<this._numBitLevels)},LZMA.BitTreeDecoder.prototype.decode=function(e){for(var t=1,r=this._numBitLevels;r--;)t=t<<1|e.decodeBit(this._models,t);return t-(1<<this._numBitLevels)},LZMA.BitTreeDecoder.prototype.reverseDecode=function(e){for(var t,r=1,a=0,n=0;n<this._numBitLevels;++n)r=r<<1|(t=e.decodeBit(this._models,r)),a|=t<<n;return a},LZMA.reverseDecode2=function(e,t,r,a){for(var n,i=1,s=0,o=0;o<a;++o)i=i<<1|(n=r.decodeBit(e,t+i)),s|=n<<o;return s},LZMA.LenDecoder=function(){this._choice=[],this._lowCoder=[],this._midCoder=[],this._highCoder=new LZMA.BitTreeDecoder(8),this._numPosStates=0},LZMA.LenDecoder.prototype.create=function(e){for(;this._numPosStates<e;++this._numPosStates)this._lowCoder[this._numPosStates]=new LZMA.BitTreeDecoder(3),this._midCoder[this._numPosStates]=new LZMA.BitTreeDecoder(3)},LZMA.LenDecoder.prototype.init=function(){var e=this._numPosStates;for(LZMA.initBitModels(this._choice,2);e--;)this._lowCoder[e].init(),this._midCoder[e].init();this._highCoder.init()},LZMA.LenDecoder.prototype.decode=function(e,t){return 0===e.decodeBit(this._choice,0)?this._lowCoder[t].decode(e):0===e.decodeBit(this._choice,1)?8+this._midCoder[t].decode(e):16+this._highCoder.decode(e)},LZMA.Decoder2=function(){this._decoders=[]},LZMA.Decoder2.prototype.init=function(){LZMA.initBitModels(this._decoders,768)},LZMA.Decoder2.prototype.decodeNormal=function(e){for(var t=1;(t=t<<1|e.decodeBit(this._decoders,t))<256;);return 255&t},LZMA.Decoder2.prototype.decodeWithMatchByte=function(e,t){var r,a,n=1;do{if(r=t>>7&1,t<<=1,n=n<<1|(a=e.decodeBit(this._decoders,(1+r<<8)+n)),r!==a){for(;n<256;)n=n<<1|e.decodeBit(this._decoders,n);break}}while(n<256);return 255&n},LZMA.LiteralDecoder=function(){},LZMA.LiteralDecoder.prototype.create=function(e,t){var r;if(!this._coders||this._numPrevBits!==t||this._numPosBits!==e)for(this._numPosBits=e,this._posMask=(1<<e)-1,this._numPrevBits=t,this._coders=[],r=1<<this._numPrevBits+this._numPosBits;r--;)this._coders[r]=new LZMA.Decoder2},LZMA.LiteralDecoder.prototype.init=function(){for(var e=1<<this._numPrevBits+this._numPosBits;e--;)this._coders[e].init()},LZMA.LiteralDecoder.prototype.getDecoder=function(e,t){return this._coders[((e&this._posMask)<<this._numPrevBits)+((255&t)>>>8-this._numPrevBits)]},LZMA.Decoder=function(){this._outWindow=new LZMA.OutWindow,this._rangeDecoder=new LZMA.RangeDecoder,this._isMatchDecoders=[],this._isRepDecoders=[],this._isRepG0Decoders=[],this._isRepG1Decoders=[],this._isRepG2Decoders=[],this._isRep0LongDecoders=[],this._posSlotDecoder=[],this._posDecoders=[],this._posAlignDecoder=new LZMA.BitTreeDecoder(4),this._lenDecoder=new LZMA.LenDecoder,this._repLenDecoder=new LZMA.LenDecoder,this._literalDecoder=new LZMA.LiteralDecoder,this._dictionarySize=-1,this._dictionarySizeCheck=-1,this._posSlotDecoder[0]=new LZMA.BitTreeDecoder(6),this._posSlotDecoder[1]=new LZMA.BitTreeDecoder(6),this._posSlotDecoder[2]=new LZMA.BitTreeDecoder(6),this._posSlotDecoder[3]=new LZMA.BitTreeDecoder(6)},LZMA.Decoder.prototype.setDictionarySize=function(e){return!(e<0)&&(this._dictionarySize!==e&&(this._dictionarySize=e,this._dictionarySizeCheck=Math.max(this._dictionarySize,1),this._outWindow.create(Math.max(this._dictionarySizeCheck,4096))),!0)},LZMA.Decoder.prototype.setLcLpPb=function(e,t,r){var a=1<<r;return!(8<e||4<t||4<r)&&(this._literalDecoder.create(t,e),this._lenDecoder.create(a),this._repLenDecoder.create(a),this._posStateMask=a-1,!0)},LZMA.Decoder.prototype.init=function(){var e=4;for(this._outWindow.init(!1),LZMA.initBitModels(this._isMatchDecoders,192),LZMA.initBitModels(this._isRep0LongDecoders,192),LZMA.initBitModels(this._isRepDecoders,12),LZMA.initBitModels(this._isRepG0Decoders,12),LZMA.initBitModels(this._isRepG1Decoders,12),LZMA.initBitModels(this._isRepG2Decoders,12),LZMA.initBitModels(this._posDecoders,114),this._literalDecoder.init();e--;)this._posSlotDecoder[e].init();this._lenDecoder.init(),this._repLenDecoder.init(),this._posAlignDecoder.init(),this._rangeDecoder.init()},LZMA.Decoder.prototype.decode=function(e,t,r){var a,n,i,s,o,l,u=0,h=0,c=0,d=0,f=0,p=0,m=0;for(this._rangeDecoder.setStream(e),this._outWindow.setStream(t),this.init();r<0||p<r;)if(a=p&this._posStateMask,0===this._rangeDecoder.decodeBit(this._isMatchDecoders,(u<<4)+a))n=this._literalDecoder.getDecoder(p++,m),m=7<=u?n.decodeWithMatchByte(this._rangeDecoder,this._outWindow.getByte(h)):n.decodeNormal(this._rangeDecoder),this._outWindow.putByte(m),u=u<4?0:u-(u<10?3:6);else{if(1===this._rangeDecoder.decodeBit(this._isRepDecoders,u))(i=0)===this._rangeDecoder.decodeBit(this._isRepG0Decoders,u)?0===this._rangeDecoder.decodeBit(this._isRep0LongDecoders,(u<<4)+a)&&(u=u<7?9:11,i=1):(0===this._rangeDecoder.decodeBit(this._isRepG1Decoders,u)?s=c:(0===this._rangeDecoder.decodeBit(this._isRepG2Decoders,u)?s=d:(s=f,f=d),d=c),c=h,h=s),0===i&&(i=2+this._repLenDecoder.decode(this._rangeDecoder,a),u=u<7?8:11);else if(f=d,d=c,c=h,i=2+this._lenDecoder.decode(this._rangeDecoder,a),u=u<7?7:10,4<=(o=this._posSlotDecoder[i<=5?i-2:3].decode(this._rangeDecoder))){if(h=(2|1&o)<<(l=(o>>1)-1),o<14)h+=LZMA.reverseDecode2(this._posDecoders,h-o-1,this._rangeDecoder,l);else if(h+=this._rangeDecoder.decodeDirectBits(l-4)<<4,(h+=this._posAlignDecoder.reverseDecode(this._rangeDecoder))<0){if(-1===h)break;return!1}}else h=o;if(p<=h||h>=this._dictionarySizeCheck)return!1;this._outWindow.copyBlock(h,i),p+=i,m=this._outWindow.getByte(0)}return this._outWindow.flush(),this._outWindow.releaseStream(),this._rangeDecoder.releaseStream(),!0},LZMA.Decoder.prototype.setDecoderProperties=function(e){var t,r,a,n,i;return!(e.size<5)&&(r=(t=e.readByte())%9,a=(t=~~(t/9))%5,n=~~(t/5),!!this.setLcLpPb(r,a,n)&&(i=e.readByte(),i|=e.readByte()<<8,i|=e.readByte()<<16,i+=16777216*e.readByte(),this.setDictionarySize(i)))},LZMA.decompress=function(e,t,r,a){var n=new LZMA.Decoder;if(!n.setDecoderProperties(e))throw"Incorrect stream properties";if(!n.decode(t,r,a))throw"Error in data stream";return!0};var CTM=CTM||{};"object"==typeof module&&(module.exports=CTM),CTM.CompressionMethod={RAW:5718354,MG1:3229517,MG2:3295053},CTM.Flags={NORMALS:1},CTM.File=function(e){this.load(e)},CTM.File.prototype.load=function(e){this.header=new CTM.FileHeader(e),this.body=new CTM.FileBody(this.header),this.getReader().read(e,this.body)},CTM.File.prototype.getReader=function(){var e;switch(this.header.compressionMethod){case CTM.CompressionMethod.RAW:e=new CTM.ReaderRAW;break;case CTM.CompressionMethod.MG1:e=new CTM.ReaderMG1;break;case CTM.CompressionMethod.MG2:e=new CTM.ReaderMG2}return e},CTM.FileHeader=function(e){e.readInt32(),this.fileFormat=e.readInt32(),this.compressionMethod=e.readInt32(),this.vertexCount=e.readInt32(),this.triangleCount=e.readInt32(),this.uvMapCount=e.readInt32(),this.attrMapCount=e.readInt32(),this.flags=e.readInt32(),this.comment=e.readString()},CTM.FileHeader.prototype.hasNormals=function(){return this.flags&CTM.Flags.NORMALS},CTM.FileBody=function(e){var t=3*e.triangleCount,r=3*e.vertexCount,a=e.hasNormals()?3*e.vertexCount:0,n=2*e.vertexCount,i=4*e.vertexCount,s=0,o=new ArrayBuffer(4*(t+r+a+n*e.uvMapCount+i*e.attrMapCount));if(this.indices=new Uint32Array(o,0,t),this.vertices=new Float32Array(o,4*t,r),e.hasNormals()&&(this.normals=new Float32Array(o,4*(t+r),a)),e.uvMapCount)for(this.uvMaps=[],s=0;s<e.uvMapCount;++s)this.uvMaps[s]={uv:new Float32Array(o,4*(t+r+a+s*n),n)};if(e.attrMapCount)for(this.attrMaps=[],s=0;s<e.attrMapCount;++s)this.attrMaps[s]={attr:new Float32Array(o,4*(t+r+a+n*e.uvMapCount+s*i),i)}},CTM.FileMG2Header=function(e){e.readInt32(),this.vertexPrecision=e.readFloat32(),this.normalPrecision=e.readFloat32(),this.lowerBoundx=e.readFloat32(),this.lowerBoundy=e.readFloat32(),this.lowerBoundz=e.readFloat32(),this.higherBoundx=e.readFloat32(),this.higherBoundy=e.readFloat32(),this.higherBoundz=e.readFloat32(),this.divx=e.readInt32(),this.divy=e.readInt32(),this.divz=e.readInt32(),this.sizex=(this.higherBoundx-this.lowerBoundx)/this.divx,this.sizey=(this.higherBoundy-this.lowerBoundy)/this.divy,this.sizez=(this.higherBoundz-this.lowerBoundz)/this.divz},CTM.ReaderRAW=function(){},CTM.ReaderRAW.prototype.read=function(e,t){this.readIndices(e,t.indices),this.readVertices(e,t.vertices),t.normals&&this.readNormals(e,t.normals),t.uvMaps&&this.readUVMaps(e,t.uvMaps),t.attrMaps&&this.readAttrMaps(e,t.attrMaps)},CTM.ReaderRAW.prototype.readIndices=function(e,t){e.readInt32(),e.readArrayInt32(t)},CTM.ReaderRAW.prototype.readVertices=function(e,t){e.readInt32(),e.readArrayFloat32(t)},CTM.ReaderRAW.prototype.readNormals=function(e,t){e.readInt32(),e.readArrayFloat32(t)},CTM.ReaderRAW.prototype.readUVMaps=function(e,t){for(var r=0;r<t.length;++r)e.readInt32(),t[r].name=e.readString(),t[r].filename=e.readString(),e.readArrayFloat32(t[r].uv)},CTM.ReaderRAW.prototype.readAttrMaps=function(e,t){for(var r=0;r<t.length;++r)e.readInt32(),t[r].name=e.readString(),e.readArrayFloat32(t[r].attr)},CTM.ReaderMG1=function(){},CTM.ReaderMG1.prototype.read=function(e,t){this.readIndices(e,t.indices),this.readVertices(e,t.vertices),t.normals&&this.readNormals(e,t.normals),t.uvMaps&&this.readUVMaps(e,t.uvMaps),t.attrMaps&&this.readAttrMaps(e,t.attrMaps)},CTM.ReaderMG1.prototype.readIndices=function(e,t){e.readInt32(),e.readInt32();var r=new CTM.InterleavedStream(t,3);LZMA.decompress(e,e,r,r.data.length),CTM.restoreIndices(t,t.length)},CTM.ReaderMG1.prototype.readVertices=function(e,t){e.readInt32(),e.readInt32();var r=new CTM.InterleavedStream(t,1);LZMA.decompress(e,e,r,r.data.length)},CTM.ReaderMG1.prototype.readNormals=function(e,t){e.readInt32(),e.readInt32();var r=new CTM.InterleavedStream(t,3);LZMA.decompress(e,e,r,r.data.length)},CTM.ReaderMG1.prototype.readUVMaps=function(e,t){for(var r=0;r<t.length;++r){e.readInt32(),t[r].name=e.readString(),t[r].filename=e.readString(),e.readInt32();var a=new CTM.InterleavedStream(t[r].uv,2);LZMA.decompress(e,e,a,a.data.length)}},CTM.ReaderMG1.prototype.readAttrMaps=function(e,t){for(var r=0;r<t.length;++r){e.readInt32(),t[r].name=e.readString(),e.readInt32();var a=new CTM.InterleavedStream(t[r].attr,4);LZMA.decompress(e,e,a,a.data.length)}},CTM.ReaderMG2=function(){},CTM.ReaderMG2.prototype.read=function(e,t){this.MG2Header=new CTM.FileMG2Header(e),this.readVertices(e,t.vertices),this.readIndices(e,t.indices),t.normals&&this.readNormals(e,t),t.uvMaps&&this.readUVMaps(e,t.uvMaps),t.attrMaps&&this.readAttrMaps(e,t.attrMaps)},CTM.ReaderMG2.prototype.readVertices=function(e,t){e.readInt32(),e.readInt32();var r=new CTM.InterleavedStream(t,3);LZMA.decompress(e,e,r,r.data.length);var a=this.readGridIndices(e,t);CTM.restoreVertices(t,this.MG2Header,a,this.MG2Header.vertexPrecision)},CTM.ReaderMG2.prototype.readGridIndices=function(e,t){e.readInt32(),e.readInt32();var r=new Uint32Array(t.length/3),a=new CTM.InterleavedStream(r,1);return LZMA.decompress(e,e,a,a.data.length),CTM.restoreGridIndices(r,r.length),r},CTM.ReaderMG2.prototype.readIndices=function(e,t){e.readInt32(),e.readInt32();var r=new CTM.InterleavedStream(t,3);LZMA.decompress(e,e,r,r.data.length),CTM.restoreIndices(t,t.length)},CTM.ReaderMG2.prototype.readNormals=function(e,t){e.readInt32(),e.readInt32();var r=new CTM.InterleavedStream(t.normals,3);LZMA.decompress(e,e,r,r.data.length);var a=CTM.calcSmoothNormals(t.indices,t.vertices);CTM.restoreNormals(t.normals,a,this.MG2Header.normalPrecision)},CTM.ReaderMG2.prototype.readUVMaps=function(e,t){for(var r=0;r<t.length;++r){e.readInt32(),t[r].name=e.readString(),t[r].filename=e.readString();var a=e.readFloat32();e.readInt32();var n=new CTM.InterleavedStream(t[r].uv,2);LZMA.decompress(e,e,n,n.data.length),CTM.restoreMap(t[r].uv,2,a)}},CTM.ReaderMG2.prototype.readAttrMaps=function(e,t){for(var r=0;r<t.length;++r){e.readInt32(),t[r].name=e.readString();var a=e.readFloat32();e.readInt32();var n=new CTM.InterleavedStream(t[r].attr,4);LZMA.decompress(e,e,n,n.data.length),CTM.restoreMap(t[r].attr,4,a)}},CTM.restoreIndices=function(e,t){var r=3;for(0<t&&(e[2]+=e[0],e[1]+=e[0]);r<t;r+=3)e[r]+=e[r-3],e[r]===e[r-3]?e[r+1]+=e[r-2]:e[r+1]+=e[r],e[r+2]+=e[r]},CTM.restoreGridIndices=function(e,t){for(var r=1;r<t;++r)e[r]+=e[r-1]},CTM.restoreVertices=function(e,t,r,a){for(var n,i,s,o,l,u=new Uint32Array(e.buffer,e.byteOffset,e.length),h=t.divx,c=h*t.divy,d=2147483647,f=0,p=0,m=0,g=r.length;p<g;m+=3)s=n=r[p++],s-=~~((l=~~(s/c))*c),s-=~~((o=~~(s/h))*h),i=u[m],n===d&&(i+=f),e[m]=t.lowerBoundx+s*t.sizex+a*i,e[m+1]=t.lowerBoundy+o*t.sizey+a*u[m+1],e[m+2]=t.lowerBoundz+l*t.sizez+a*u[m+2],d=n,f=i},CTM.restoreNormals=function(e,t,r){for(var a,n,i,s,o,l,u,h,c,d,f=new Uint32Array(e.buffer,e.byteOffset,e.length),p=0,m=e.length,g=1.5707963267948966;p<m;p+=3)a=f[p]*r,0===(n=f[p+1])?(e[p]=t[p]*a,e[p+1]=t[p+1]*a,e[p+2]=t[p+2]*a):(i=n<=4?(f[p+2]-2)*g:(4*f[p+2]/n-2)*g,n*=r*g,o=(s=a*Math.sin(n))*Math.cos(i),l=s*Math.sin(i),u=a*Math.cos(n),c=t[p+1],h=t[p]-t[p+2],1e-20<(d=Math.sqrt(2*c*c+h*h))&&(h/=d,c/=d),e[p]=t[p]*u+(t[p+1]*c-t[p+2]*h)*l-c*o,e[p+1]=t[p+1]*u-(t[p+2]+t[p])*c*l+h*o,e[p+2]=t[p+2]*u+(t[p]*h+t[p+1]*c)*l+c*o)},CTM.restoreMap=function(e,t,r){for(var a,n,i,s=new Uint32Array(e.buffer,e.byteOffset,e.length),o=0,l=e.length;o<t;++o)for(a=0,i=o;i<l;i+=t)a+=1&(n=s[i])?-(n+1>>1):n>>1,e[i]=a*r},CTM.calcSmoothNormals=function(e,t){var r,a,n,i,s,o,l,u,h,c,d,f,p,m,g,v=new Float32Array(t.length);for(m=0,g=e.length;m<g;)r=3*e[m++],a=3*e[m++],n=3*e[m++],l=t[a]-t[r],c=t[n]-t[r],u=t[a+1]-t[r+1],d=t[n+1]-t[r+1],h=t[a+2]-t[r+2],i=u*(f=t[n+2]-t[r+2])-h*d,s=h*c-l*f,o=l*d-u*c,1e-10<(p=Math.sqrt(i*i+s*s+o*o))&&(i/=p,s/=p,o/=p),v[r]+=i,v[r+1]+=s,v[r+2]+=o,v[a]+=i,v[a+1]+=s,v[a+2]+=o,v[n]+=i,v[n+1]+=s,v[n+2]+=o;for(m=0,g=v.length;m<g;m+=3)1e-10<(p=Math.sqrt(v[m]*v[m]+v[m+1]*v[m+1]+v[m+2]*v[m+2]))&&(v[m]/=p,v[m+1]/=p,v[m+2]/=p);return v},CTM.isLittleEndian=function(){var e=new ArrayBuffer(2),t=new Uint8Array(e),r=new Uint16Array(e);return(t[0]=1)===r[0]}(),CTM.InterleavedStream=function(e,t){this.data=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),this.offset=CTM.isLittleEndian?3:0,this.count=4*t,this.len=this.data.length},CTM.InterleavedStream.prototype.writeByte=function(e){this.data[this.offset]=e,this.offset+=this.count,this.offset>=this.len&&(this.offset-=this.len-4,this.offset>=this.count&&(this.offset-=this.count+(CTM.isLittleEndian?1:-1)))},CTM.Stream=function(e){this.data=e,this.offset=0},CTM.Stream.prototype.TWO_POW_MINUS23=Math.pow(2,-23),CTM.Stream.prototype.TWO_POW_MINUS126=Math.pow(2,-126),CTM.Stream.prototype.readByte=function(){return 255&this.data[this.offset++]},CTM.Stream.prototype.readInt32=function(){var e=this.readByte();return e|=this.readByte()<<8,(e|=this.readByte()<<16)|this.readByte()<<24},CTM.Stream.prototype.readFloat32=function(){var e=this.readByte();e+=this.readByte()<<8;var t=this.readByte(),r=this.readByte();e+=(127&t)<<16;var a=(127&r)<<1|(128&t)>>>7,n=128&r?-1:1;return 255===a?0!==e?NaN:n*(1/0):0<a?n*(1+e*this.TWO_POW_MINUS23)*Math.pow(2,a-127):0!==e?n*e*this.TWO_POW_MINUS126:0*n},CTM.Stream.prototype.readString=function(){var e=this.readInt32();return this.offset+=e,String.fromCharCode.apply(null,this.data.subarray(this.offset-e,this.offset))},CTM.Stream.prototype.readArrayInt32=function(e){for(var t=0,r=e.length;t<r;)e[t++]=this.readInt32();return e},CTM.Stream.prototype.readArrayFloat32=function(e){for(var t=0,r=e.length;t<r;)e[t++]=this.readFloat32();return e},TONG.CTMLoader=function(){TONG.Loader.call(this)},TONG.CTMLoader.prototype=Object.create(TONG.Loader.prototype),TONG.CTMLoader.prototype.constructor=TONG.CTMLoader,TONG.CTMLoader.prototype.loadParts=function(e,o,l){l=l||{};var u=this,h=new XMLHttpRequest,c=l.basePath?l.basePath:this.extractUrlBase(e);h.onreadystatechange=function(){if(4===h.readyState&&(200===h.status||0===h.status)){var t=JSON.parse(h.responseText),r=[],a=[],n=0;for(var e=0;e<t.materials.length;e++)r[e]=u.createMaterial(t.materials[e],c);var i=c+t.data,s={useWorker:l.useWorker,worker:l.worker,offsets:t.offsets};u.load(i,function(e){n+=1,a.push(e),n===t.offsets.length&&o(a,r)},s)}},h.open("GET",e,!0),h.setRequestHeader("Content-Type","text/plain"),h.send(null)},TONG.CTMLoader.prototype.load=function(i,o,l){var u=this,h=void 0!==(l=l||{}).offsets?l.offsets:[0],c=new XMLHttpRequest;c.onreadystatechange=function(){if(4===c.readyState)if(200===c.status||0===c.status){var e=new Uint8Array(c.response),s=Date.now();if(l.useWorker){var t=l.worker||new Worker("js/loaders/ctm/CTMWorker.js");t.onmessage=function(e){for(var t=e.data,r=0;r<t.length;r++){var a=t[r],n=Date.now();u.createModel(a,o);var i=Date.now();console.log("model load time [worker]: "+(i-n)+" ms, total: "+(i-s))}},t.postMessage({data:e,offsets:h},[e.buffer])}else for(var r=0;r<h.length;r++){var a=new CTM.Stream(e);a.offset=h[r];var n=new CTM.File(a);u.createModel(n,o)}}else console.error("Couldn't load ["+i+"] ["+c.status+"]");else 3===c.readyState||2===c.readyState&&c.getResponseHeader("Content-Length")},c.open("GET",i,!0),c.responseType="arraybuffer",c.send(null)},TONG.CTMLoader.prototype.createModel=function(o,e){var t=function(){TONG.BufferGeometry.call(this),this.materials=[];var e,t,r=o.body.indices,a=o.body.vertices,n=o.body.normals,i=o.body.uvMaps;void 0!==i&&0<i.length&&(e=i[0].uv);var s=o.body.attrMaps;void 0!==s&&0<s.length&&"Color"===s[0].name&&(t=s[0].attr),this.setIndex(new TONG.BufferAttribute(r,1)),this.addAttribute("position",new TONG.BufferAttribute(a,3)),void 0!==n&&this.addAttribute("normal",new TONG.BufferAttribute(n,3)),void 0!==e&&this.addAttribute("uv",new TONG.BufferAttribute(e,2)),void 0!==t&&this.addAttribute("color",new TONG.BufferAttribute(t,4))},r=new((t.prototype=Object.create(TONG.BufferGeometry.prototype)).constructor=t);void 0===r.attributes.normal&&r.computeVertexNormals(),e(r)},TONG.OBJExporter=function(){},TONG.OBJExporter.prototype={constructor:TONG.OBJExporter,parse:function(e){var h,c,i,d,f,p="",m=0,g=0,v=0,y=new TONG.Vector3,T=new TONG.Vector3,b=new TONG.Vector2,_=[];return e.traverse(function(e){e instanceof TONG.Mesh&&function(e){var t=0,r=0,a=0,n=e.geometry,i=new TONG.Matrix3;if(n instanceof TONG.Geometry&&(n=(new TONG.BufferGeometry).setFromObject(e)),n instanceof TONG.BufferGeometry){var s=n.getAttribute("position"),o=n.getAttribute("normal"),l=n.getAttribute("uv"),u=n.getIndex();if(p+="o "+e.name+"\n",e.material&&e.material.name&&(p+="usemtl "+e.material.name+"\n"),void 0!==s)for(h=0,d=s.count;h<d;h++,t++)y.x=s.getX(h),y.y=s.getY(h),y.z=s.getZ(h),y.applyMatrix4(e.matrixWorld),p+="v "+y.x+" "+y.y+" "+y.z+"\n";if(void 0!==l)for(h=0,d=l.count;h<d;h++,a++)b.x=l.getX(h),b.y=l.getY(h),p+="vt "+b.x+" "+b.y+"\n";if(void 0!==o)for(i.getNormalMatrix(e.matrixWorld),h=0,d=o.count;h<d;h++,r++)T.x=o.getX(h),T.y=o.getY(h),T.z=o.getZ(h),T.applyMatrix3(i),p+="vn "+T.x+" "+T.y+" "+T.z+"\n";if(null!==u)for(h=0,d=u.count;h<d;h+=3){for(f=0;f<3;f++)c=u.getX(h+f)+1,_[f]=m+c+"/"+(l?g+c:"")+"/"+(v+c);p+="f "+_.join(" ")+"\n"}else for(h=0,d=s.count;h<d;h+=3){for(f=0;f<3;f++)c=h+f+1,_[f]=m+c+"/"+(l?g+c:"")+"/"+(v+c);p+="f "+_.join(" ")+"\n"}}else console.warn("THREE.OBJExporter.parseMesh(): geometry type unsupported",n);m+=t,g+=a,v+=r}(e),e instanceof TONG.Line&&function(e){var t=0,r=e.geometry,a=e.type;if(r instanceof TONG.Geometry&&(r=(new TONG.BufferGeometry).setFromObject(e)),r instanceof TONG.BufferGeometry){var n=r.getAttribute("position");if(r.getIndex(),p+="o "+e.name+"\n",void 0!==n)for(h=0,d=n.count;h<d;h++,t++)y.x=n.getX(h),y.y=n.getY(h),y.z=n.getZ(h),y.applyMatrix4(e.matrixWorld),p+="v "+y.x+" "+y.y+" "+y.z+"\n";if("Line"===a){for(p+="l ",c=1,d=n.count;c<=d;c++)p+=m+c+" ";p+="\n"}if("LineSegments"===a)for(i=1+(c=1),d=n.count;c<d;i=(c+=2)+1)p+="l "+(m+c)+" "+(m+i)+"\n"}else console.warn("THREE.OBJExporter.parseLine(): geometry type unsupported",r);m+=t}(e)}),p}},TONG.STLExporter=function(){},TONG.STLExporter.prototype={constructor:TONG.STLExporter,parse:function(){var c=new TONG.Vector3,d=new TONG.Matrix3;return function(e){var h="";return h+="solid exported\n",e.traverse(function(e){if(e instanceof TONG.Mesh){var t=e.geometry,r=e.matrixWorld;if(t instanceof TONG.BufferGeometry&&(t=(new TONG.Geometry).fromBufferGeometry(t)),t instanceof TONG.Geometry){var a=t.vertices,n=t.faces;d.getNormalMatrix(r);for(var i=0,s=n.length;i<s;i++){var o=n[i];c.copy(o.normal).applyMatrix3(d).normalize(),h+="\tfacet normal "+c.x+" "+c.y+" "+c.z+"\n",h+="\t\touter loop\n";for(var l=[o.a,o.b,o.c],u=0;u<3;u++)c.copy(a[l[u]]).applyMatrix4(r),h+="\t\t\tvertex "+c.x+" "+c.y+" "+c.z+"\n";h+="\t\tendloop\n",h+="\tendfacet\n"}}}}),h+="endsolid exported\n"}}()};