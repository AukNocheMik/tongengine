var isEditor=!0;function trim(e){return e.replace(/\s|\xA0/g,"")}function removeSpace(e){return e.replace(/\s/g,"")}function combindStrFunction(e){for(var t=e.match(/(?=var)(.*?)(?=\s*=)/g),o=e.match(/(?=function)(.*?)(?=\s*\{)/g),i="\nreturn {",a=0;a<t.length;a++)i+=t[a].trim().replace("var","")+":"+t[a].trim().replace("var",""),a<t.length-1&&(i+=",");return e+=i+="}}"+o[0].replace("function","")}function stringToObject(v){var obj=JSON.parse(v,function(key,value){var prefix;return"string"!=typeof value?value:-1!=value.search(/^(?:new\s*\S*\([\s\S]*\))/)?eval(value):(prefix=value.substring(0,8),"function"===prefix?eval("("+value+")"):"_PxEgEr_"===prefix?eval(value.slice(8)):"_NuFrRa_"===prefix?eval(value.slice(8)):value)});return obj}function stringToValue(e){var t=e;try{t=JSON.parse(e)}catch(e){}return t}function getTime(){return Date.now()}function createCanvas(e,t){var o=document.createElement("canvas");return o.width=e,o.height=t,o}var isEmptyObject=function(e){var t;for(t in e)return!1;return!0};function isPowerOfTwo(e){return Math.log(e)/Math.log(2)%1==0}function getObjectClassName(e){if(e){if(e.constructor.fullname)return e.constructor.fullname;if(e.constructor.name)return e.constructor.name;var t=e.constructor.toString().match(/function\s*(\w+)/);return t&&2==t.length?t[1]:void 0}}function getComponentName(e){if(e)return e.title&&"Component"!=e.title?e.title:getObjectClassName(e)}function getMaterialName(e){return void 0===e||e.isNoneMaterial?null:TONG.MaterialClasses[e.name]instanceof TONG.Material?e.name:e.type&&"Material"!=e.type?e.type:getObjectClassName(e)}function getString(e){return"string"==typeof e?e:"[object String]"==Object.prototype.toString.call(e)&&e.toString()}var arrayInsert=function(e,t,o){e.splice(t,0,o)};function ComponentContainer(){this._components=[],this.missing_components=null}TONG.Behavior=function(){},TONG.Pad=function(e,t){TONG.Behavior.call(this);var o=Array.isArray(e)&&2==e.length?e:[.5,.5];this.callback=null,t&&(t instanceof Function?this.callback=t:t.callback&&(this.callback=t.callback)),this.must=!1,this.alias=null,t&&(t instanceof Object&&null!=t.must&&(this.must=t.must),t instanceof Object&&null!=t.alias&&(this.alias=t.alias)),this.options=t,this.getValue=function(){return o},this.setValue=function(e,t){return Array.isArray(e)&&2==e.length&&(o=e,t||null==this.callback||this.callback(o)),this},this.fromArray=function(e){return o=e,this},this.toArray=function(){return o}},TONG.Pad.prototype=Object.create(TONG.Behavior.prototype),TONG.Pad.prototype.constructor=TONG.Pad,TONG.Polyline=function(e,t){TONG.Behavior.call(this);var o=Array.isArray(e)&&Array.isArray(e[0])?e:[[0,.5],[1,.5]];this.callback=null,t&&(t instanceof Function?this.callback=t:t.callback&&(this.callback=t.callback)),this.must=!1,this.alias=null,t&&(t instanceof Object&&null!=t.must&&(this.must=t.must),t instanceof Object&&null!=t.alias&&(this.alias=t.alias)),this.options=t,this.getValue=function(){return o},this.setValue=function(e,t){return Array.isArray(e)&&Array.isArray(e[0])&&(o=e,t||null==this.callback||this.callback(o)),this},this.fromArray=function(e){return o=e,this},this.toArray=function(){return o}},TONG.Polyline.prototype=Object.create(TONG.Behavior.prototype),TONG.Polyline.prototype.constructor=TONG.Polyline,TONG.Menu=function(e,t){var o=getString(e);if(o){this.callback=null,this.options=t||{},t&&(t instanceof Function?t={callback:this.callback=t}:t.callback&&(this.callback=t.callback));var i=FileNameHelper.GetWholeName(TONG.RM.getMenuNames(),o);TONG.RM.addMenuBar(i,this.options),this.getValue=function(){return i}}},TONG.Enum=function(t,e){var o=null;if(e&&(e instanceof Function?e={callback:o=e}:e.callback&&(o=e.callback)),this.isCompile=!1,e&&e instanceof Object&&null!=e.isCompile&&(this.isCompile=e.isCompile),this.must=!1,this.alias=null,e&&(e instanceof Object&&null!=e.must&&(this.must=e.must),e instanceof Object&&null!=e.alias&&(this.alias=e.alias)),this.options=e,!(t instanceof Array))throw"First argument of ENUM must be an array";var i={},a=this;this.getNames=function(){return t},this.addElement=function(e){return t.push(e),t},this.getValueIndex=function(){for(var e=0;e<t.length;e++)if(t[e]==this.getValue())return e;return-1},this.Enum=function(e,t){return this._value=e,o&&!t&&o(e),e=i[e],a.Enum[e]};for(var n=0,r=t.length;n<r;n++){var s=t[n];s instanceof Array||(s=[s]);var l=Math.pow(2,n),c=s[0];i[c]=c;for(var u=0,d=s.length;u<d;u++){var h=s[u],p=new Number(l);p.asString=h,p.asLowerCase=h.toLowerCase(),p.asUpperCase=h.toUpperCase(),p.asInteger=l,p.ENUM=this.Enum,0==u?(this.Enum[h]=p,i[l]=c):i[h]=c}}this.setValue(t[0],!0)},TONG.Enum.prototype.setValue=function(e,t){return this._value=e,this.Enum(e,t),this},TONG.Enum.prototype.getValue=function(){return this._value},TONG.Slider=function(e,t){TONG.Behavior.call(this);var o=0,i=1,a=.1,n=e||.1,r=null;return this.element=null,this.alias=null,t&&(t instanceof Function?r=t:t.callback&&(r=t.callback)),this.must=!1,t&&t instanceof Object&&null!=t.must&&(this.must=t.must),"object"!=typeof(this.options=t)||null==t||isEmptyObject(t)||(t.min&&(o=t.min),t.max&&(i=t.max),t.step&&(a=t.step),t.value&&(n=t.value),t.callback&&(r=t.callback),t.alias&&(this.alias=t.alias)),this.fromArray=function(e){return Array.isArray(e)&&(n=e[0],o=e[1],i=e[2],a=e[3]),this},this.toArray=function(){return[n,o,i,a]},this.getMin=function(){return o},this.setMin=function(e){o=e},this.getMax=function(){return i},this.setMax=function(e){i=e},this.setStep=function(e){a=e},this.getStep=function(){return a},this.setValue=function(e,t){e=e,t||null==r||r(e)},this.getValue=function(){return n},this},TONG.Slider.prototype=Object.create(TONG.Behavior.prototype),TONG.Slider.prototype.constructor=TONG.Slider,TONG.Event={bind:function(e,t,o,i){if(!e)throw"cannot bind event to null";if(!o)throw"cannot bind to null callback";if(e.constructor===String)throw"cannot bind event to a string";var a=e.__tevents;a||(Object.defineProperty(e,"__tevents",{value:{},enumerable:!1}),a=e.__tevents),a.hasOwnProperty(t)?a[t].push([o,i]):a[t]=[[o,i]],e.onEventBinded&&e.onEventBinded(t,o,i)},unbind:function(e,t,o,i){if(!e)throw"cannot unbind event to null";if(!o)throw"cannot unbind from null callback";if(e.constructor===String)throw"cannot bind event to a string";var a=e.__tevents;if(a&&a.hasOwnProperty(t)){for(var n=0,r=a[t].length;n<r;++n){var s=a[t][n];if(s[0]===o&&s[1]===i){a[t].splice(n,1);break}}0==a[t].length&&delete a[t],e.onEventUnbinded&&e.onEventUnbinded(t,o,i)}},unbindAll:function(e,t,o){if(!e)throw"cannot unbind events in null";var i=e.__tevents;if(i)if(e.onEventUnbindAll&&e.onEventUnbindAll(t,o),t)for(var a in i)for(var n=i[a],r=n.length-1;0<=r;--r)n[r][1]!=t||o&&o!==n[r][0]||n.splice(r,1);else delete e.__tevents},unbindAllEvent:function(e,t){if(!e)throw"cannot unbind events in null";var o=e.__tevents;o&&(delete o[t],e.onEventUnbindAll&&e.onEventUnbindAll(t,target_instance,callback))},isBind:function(e,t,o,i){if(!e)throw"LEvent cannot have null as instance";var a=e.__tevents;if(a){if(!a.hasOwnProperty(t))return!1;for(var n=0,r=a[t].length;n<r;++n){var s=a[t][n];if(s[0]===o&&s[1]===i)return!0}return!1}},hasBind:function(e,t){if(!e)throw"LEvent cannot have null as instance";var o=e.__tevents;return!!(o&&o.hasOwnProperty(t)&&o[t].length)},hasBindTo:function(e,t){if(!e)throw"LEvent cannot have null as instance";var o=e.__tevents;if(!o)return!1;for(var i in o)for(var a=o[i],n=0;n<a.length;++n)if(a[n][1]===t)return!0;return!1},trigger:function(e,t,o,i,a){if(!e)throw"cannot trigger event from null";if(e.constructor===String)throw"cannot bind event to a string";var n=e.__tevents;if(!n||!n.hasOwnProperty(t))return!1;var r=n[t];if(i)for(var s=r.length-1;0<=s;--s){var l=r[s];if(a){if(l&&!0===l[0].apply(l[1],o))return!0}else if(l&&!0===l[0].call(l[1],t,o))return!0}else{s=0;for(var c=r.length;s<c;++s){l=r[s];if(a){if(l&&!0===l[0].apply(l[1],o))return!0}else if(l&&!0===l[0].call(l[1],t,o))return!0}}return!1},triggerArray:function(e,t,o,i,a){for(var n=!1,r=0,s=e.length;r<s;++r){var l=e[r];if(!l)throw"cannot trigger event from null";if(l.constructor===String)throw"cannot bind event to a string";var c=l.__tevents;if(c&&c.hasOwnProperty(t))if(i)for(var u=c[t].length-1;0<=u;--u){var d=c[t][u];if(a){if(!0===d[0].apply(d[1],o)){n=!0;break}}else if(!0===d[0].call(d[1],t,o)){n=!0;break}}else{u=0;for(var h=c[t].length;u<h;++u){d=c[t][u];if(a){if(!0===d[0].apply(d[1],o)){n=!0;break}}else if(!0===d[0].call(d[1],t,o)){n=!0;break}}}}return n},extendObject:function(e){e.bind=function(e,t,o){return TONG.Event.bind(this,e,t,o)},e.trigger=function(e,t){return TONG.Event.trigger(this,e,t)},e.unbind=function(e,t,o){return TONG.Event.unbind(this,e,t,instance)},e.unbindAll=function(e,t){return TONG.Event.unbindAll(this,e,t)}},extendClass:function(e){this.extendObject(e.prototype)}},TONG.Value=function(e){TONG.Behavior.call(this),this.options=e,this.applyValue=function(e){for(var t in this.value=null!=e.value?e.value:null,this.callback=e.callback?e.callback:null,this.must=void 0!==e.must&&e.must,this.alias=void 0!==e.alias?e.alias:null,this.setValue=function(e,t){this.value&&this.value.setValue?this.value.setValue(e):this.value=e,this.callback&&!t&&this.callback.call(this,e)},this.getValue=function(){return this.value},e)this[t]||(this[t]=e[t])},this.applyValue(e),this.setOptions=function(e){this.options=e,this.applyValue(e)},this.getOptions=function(){return this.options},this.getOptionsEV=function(){var e={};for(var t in this.options)"value"!=t&&(e[t]=this.options[t]);return e},this.getOptionsEVC=function(){var e={};for(var t in this.options)"value"!=t&&"callback"!=t&&(e[t]=this.options[t]);return e}},TONG.Value.prototype=Object.create(TONG.Behavior.prototype),TONG.Value.prototype.constructor=TONG.Value,TONG.Component=function(e){this.target=e||this,this.title=this.constructor.name,this.icon="css/pic/hierarchy/hieIcon.png",this.helpIcon="css/pic/inspector/help.png",this.settingsIcon="css/pic/inspector/settings.png",this.helpUrl="http://showdoc.tong3d.com",this._uuid=this.uuid="",this.isComponent=!0,this.signalInit=!1,this.collapsed=!1,this._root=!1,this.sectionEle=!1,this.inspector=!1,this.isAdjustUI=!1,this.isRefreshUI=!1,this.isInit=!1,this.traversePower=[TONG.Behavior,TONG.Enum,TONG.Component,TONG.Texture,Array],this.selected=!1,this.editor=!1,this.isNested=!1,this.className=this.constructor.name,this.require=null,this.isSelectedObject=!1,this.object_class=this},TONG.Component.prototype.getMesh=function(){return this._root},TONG.Component.prototype.renameTitle=function(e){this.title=e;for(var t=this.sectionEle.querySelector(".wsectiontitle"),o=0;o<t.childNodes.length;o++)t.childNodes[o]instanceof HTMLElement||(t.childNodes[o].nodeValue=" "+e)},TONG.Component.prototype.serialize=function(){var o={},that=this;for(var key in this.uuid&&(o.uuid=this.uuid),o.target=this.target.uuid,o.title=this.title,o.className=""==this.className?this.title:this.className,o._root=this._root.uuid,that)if(this[key]instanceof HTMLElement||null!=(new TONG.Component)[key])this[key],HTMLElement;else{function applyValue(key,keyOfValue,tValue){switch(typeof keyOfValue){case"boolean":case"string":case"number":o[key]=keyOfValue;break;case"object":if(keyOfValue instanceof TONG.Value)applyValue(key,keyOfValue.getValue(),keyOfValue);else if(keyOfValue instanceof TONG.Vector2)o[key]={value:keyOfValue.toArray(),type:"TONG.Vector2"};else if(keyOfValue instanceof TONG.Vector3)o[key]={value:keyOfValue.toArray(),type:"TONG.Vector3"};else if(keyOfValue instanceof TONG.Quaternion)o[key]={value:keyOfValue.toArray(),type:"TONG.Quaternion"};else if(keyOfValue instanceof TONG.Vector4)o[key]={value:keyOfValue.toArray(),type:"TONG.Vector4"};else if(keyOfValue instanceof TONG.Euler)o[key]={value:keyOfValue.toArray(),type:"TONG.Euler"};else if(keyOfValue instanceof TONG.Color)o[key]={value:keyOfValue.getHex(),type:"TONG.Color"};else if(keyOfValue instanceof TONG.Texture)o[key]={uuid:keyOfValue.uuid,type:"TONG.Texture"};else if(keyOfValue instanceof TONG.Object3D){var currObj3d=EditorModule.target.scene.getObjectByProperty("uuid",keyOfValue.uuid,!0);currObj3d||(keyOfValue=new TONG.Object3D,that[key]instanceof TONG.Value?that[key].setValue(keyOfValue):that[key]=keyOfValue),o[key]={uuid:keyOfValue.uuid,type:"TONG.Object3D"}}else if(keyOfValue instanceof TONG.Material){var currMat=TONG.RM.getResourceByUUID(keyOfValue.uuid);!currMat&&keyOfValue.resource_type&&(keyOfValue=new TONG.NoneMaterial,keyOfValue.needsUpdate=!0,that[key]instanceof TONG.Value?that[key].setValue(keyOfValue):that[key]=keyOfValue),o[key]={uuid:keyOfValue.uuid,type:"TONG.Material"}}else if(keyOfValue instanceof TONG.Script)o[key]={uuid:keyOfValue.uuid,type:"TONG.Script"};else if(keyOfValue instanceof TONG.MeshAsset){var currMesh=TONG.RM.getResourceByUUID(keyOfValue.uuid);currMesh||(keyOfValue=new TONG.MeshAsset,that[key]instanceof TONG.Value?that[key].setValue(keyOfValue):that[key]=keyOfValue),o[key]={uuid:!!keyOfValue.uuid&&keyOfValue.uuid,type:"TONG.MeshAsset"}}else if(keyOfValue instanceof TONG.AnimationAsset){var currAniAsset=TONG.RM.getResourceByUUID(keyOfValue.uuid);currAniAsset||(keyOfValue=new TONG.AnimationAsset,that[key]instanceof TONG.Value?that[key].setValue(keyOfValue):that[key]=keyOfValue),o[key]={uuid:!!keyOfValue.uuid&&keyOfValue.uuid,type:"TONG.AnimationAsset"}}else if(keyOfValue instanceof TONG.AudioAsset){var currAudioAsset=TONG.RM.getResourceByUUID(keyOfValue.uuid);currAudioAsset||(keyOfValue=new TONG.AudioAsset,that[key]instanceof TONG.Value?that[key].setValue(keyOfValue):that[key]=keyOfValue),o[key]={uuid:!!keyOfValue.uuid&&keyOfValue.uuid,type:"TONG.AudioAsset"}}else if(keyOfValue instanceof TONG.VideoAsset){var currVideoAsset=TONG.RM.getResourceByUUID(keyOfValue.uuid);currVideoAsset||(keyOfValue=new TONG.VideoAsset,that[key]instanceof TONG.Value?that[key].setValue(keyOfValue):that[key]=keyOfValue),o[key]={uuid:!!keyOfValue.uuid&&keyOfValue.uuid,type:"TONG.VideoAsset"}}else if(keyOfValue instanceof TONG.RenderTexture){var currRenderTexture=TONG.RM.getResourceByUUID(keyOfValue.uuid);currRenderTexture||(keyOfValue=new TONG.RenderTexture,that[key]instanceof TONG.Value?that[key].setValue(keyOfValue):that[key]=keyOfValue),o[key]={uuid:!!keyOfValue.uuid&&keyOfValue.uuid,type:"TONG.RenderTexture"},keyOfValue.isApplyTexture&&(o[key].isTexture=!0)}else if(keyOfValue instanceof TONG.FontAsset){var currFontAsset=TONG.RM.getResourceByUUID(keyOfValue.uuid);currFontAsset||(keyOfValue=new TONG.FontAsset,that[key]instanceof TONG.Value?that[key].setValue(keyOfValue):that[key]=keyOfValue),o[key]={uuid:!!keyOfValue.uuid&&keyOfValue.uuid,type:"TONG.FontAsset"}}else if(keyOfValue instanceof TONG.Component)o[key]={uuid:keyOfValue.uuid,type:"TONG.Component"};else if(keyOfValue instanceof TONG.Enum){var v=keyOfValue.getValue();keyOfValue.isCompile&&(v=eval(v+"")),o[key]={value:v,type:"TONG.Enum"}}else keyOfValue instanceof TONG.Slider?o[key]={value:keyOfValue.toArray(),type:"TONG.Slider"}:keyOfValue instanceof TONG.Pad?o[key]={value:keyOfValue.toArray(),type:"TONG.Pad"}:keyOfValue instanceof TONG.Polyline&&(o[key]={value:keyOfValue.toArray(),type:"TONG.Polyline"})}}applyValue(key,this[key])}return o},TONG.Component.prototype.RequireComponent=function(e){this.require=e},TONG.Component.prototype.configure=function(info){function applyValue(target,key,value){switch(typeof value){case"number":case"string":case"boolean":target[key]=value;break;case"object":if(null!=value.uuid){if("TONG.Texture"==value.type){var textureObj=TONG.RM.getResourceByUUID(value.uuid);textureObj&&(target[key]instanceof TONG.Value?target[key].setValue(textureObj,!0):target[key]=textureObj)}else if("TONG.MeshAsset"==value.type){var meshDataObj=TONG.RM.getResourceByUUID(value.uuid);meshDataObj&&(target[key]instanceof TONG.Value?target[key].setValue(meshDataObj,!0):target[key]=meshDataObj)}else if("TONG.AnimationAsset"==value.type){var aniDataObj=TONG.RM.getResourceByUUID(value.uuid);aniDataObj&&(target[key]instanceof TONG.Value?target[key].setValue(aniDataObj,!0):target[key]=aniDataObj)}else if("TONG.AudioAsset"==value.type){var audioDataObj=TONG.RM.getResourceByUUID(value.uuid);audioDataObj&&(target[key]instanceof TONG.Value?target[key].setValue(audioDataObj,!0):target[key]=audioDataObj)}else if("TONG.VideoAsset"==value.type){var videoDataObj=TONG.RM.getResourceByUUID(value.uuid);videoDataObj&&(target[key]instanceof TONG.Value?target[key].setValue(videoDataObj,!0):target[key]=videoDataObj)}else if("TONG.RenderTexture"==value.type){var renderDataObj=TONG.RM.getResourceByUUID(value.uuid);renderDataObj&&(value.isTexture&&(renderDataObj.isApplyTexture=!0),target[key]instanceof TONG.Value?target[key].setValue(renderDataObj,!0):target[key]=renderDataObj)}else if("TONG.FontAsset"==value.type){var fontDataObj=TONG.RM.getResourceByUUID(value.uuid);fontDataObj&&(target[key]instanceof TONG.Value?target[key].setValue(fontDataObj,!0):target[key]=fontDataObj)}else if("TONG.Material"==value.type){var typeObj=TONG.RM.getResourceByUUID(value.uuid);null==typeObj&&(typeObj=EditorModule.target.objectMaterialByUUID(value.uuid)),typeObj&&(target[key]instanceof TONG.Value?target[key].setValue(typeObj,!0):target[key]=typeObj)}else if("TONG.Script"==value.type){var scriptObj=EditorModule.target.getAllResourceByUUID(value.uuid);target[key]instanceof TONG.Value?target[key].setValue(scriptObj,!0):target[key]=scriptObj}else if("TONG.Object3D"==value.type){var obj3d=EditorModule.target.objectByUuid(value.uuid);target[key]instanceof TONG.Value?target[key].setValue(obj3d,!0):target[key]=obj3d}else if("TONG.Component"==value.type){var comp=EditorModule.target.getAllResourceByUUID(value.uuid);target[key]instanceof TONG.Value?target[key].setValue(comp,!0):target[key]=comp}}else if(null!=value.value)switch(value.type){case"TONG.Enum":""!=value.value&&(target[key]=target[key].setValue(value.value));break;case"TONG.Slider":case"TONG.Pad":case"TONG.Polyline":Array.isArray(value.value)&&(target[key]=target[key].fromArray(value.value));break;default:target[key]=eval("new "+value.type+"()").fromArray(value.value)}}}function configureData(target,isRoot){if(null!=target){var targetObj=EditorModule.target.getAllResourceByUUID(target.target),targetResult=targetObj,componentResult=null,componentTitle=target.title,scriptFile=TONG.RM.getResource(componentTitle);if(null!=scriptFile){var resultCompile=scriptFile.getCompileScript();resultCompile.uuid=target.uuid,resultCompile.script=scriptFile,resultCompile.title=componentTitle,null==targetResult&&(targetResult=resultCompile),resultCompile.target=targetResult,componentResult=resultCompile}else{var componentClassObjName="new "+target.className+"()",component=eval(componentClassObjName);component.uuid=target.uuid,null==targetResult&&(targetResult=component),component.target=targetResult,componentResult=component}for(var key in target)"target"!=key&&applyValue(targetResult,key,target[key]);return componentResult}}var comResult=configureData(info,!0);return comResult},TONG.Component.prototype.clone=function(){var e=new this.constructor;for(var t in this)this[t]instanceof HTMLElement||null!=(new TONG.Component)[t]||(e[t]=this[t]);return e},TONG.Component.prototype.createProperty=function(e,t,o,i,a){if(void 0===this[e]){if(o&&("String"!=o&&"Number"!=o&&"Boolean"!=o||(o=o.toLowerCase()),this.constructor["@"+e]="object"==typeof o?o:{type:o},o instanceof TONG.Component)){var n=this,r="_"+e;return Object.defineProperty(n,e,{get:function(){return this[r]?this[r]:null},set:function(e){this[r]=e?e.constructor===String?e:e.uuid:e},enumerable:!0}),this.mesh.array[o]&&(o={type:typeof o,component_class:o.constructor===String?o:this.getClassName(o)}),void(this.constructor[""+e]="object"==typeof o?o:{type:o})}if(null!=t&&t.constructor!==Number&&t.constructor!==String&&t.constructor!==Boolean||i||a){r="_"+e;if(!Object.hasOwnProperty(this,r)){n=this;if(t&&t.constructor===Float32Array)t=new Float32Array(t),this[r]=t,Object.defineProperty(n,e,{get:a||function(){return t},set:i||function(e){t.set(e)},enumerable:!0});else{Object.defineProperty(n,r,{value:t,enumerable:!1,writable:!0});Object.defineProperty(n,e,{get:a||function(){return this[r]},set:i||function(e){this[r]=e},enumerable:!0})}}}else this[e]=t}},TONG.Component.prototype.getClassName=function(e){if(e){if(e.name)return e.name;if(e.toString){var t=e.toString().match(/function\s*(\w+)/);if(t&&2==t.length)return t[1]}}},TONG.Component.prototype.createAction=function(e,t,o){var i=e.replace(/ /gi,"_");this[i]=t,this.constructor[""+i]=o||{type:"function",button_text:e,widget:"button",callback:t}},TONG.Component.prototype.getLocator=function(e){return this._root?e?(this[e],this._root.uuid+"/"+this.uuid+"/"+e):this._root.uuid+"/"+this.uuid:""},TONG.Component.prototype.onInspectorTitle=function(e){var t=this,o={collapsed:this.collapsed,callback:function(e){t.collapsed=!e}},i="";""!=this.icon&&(i="<span class='icon' style='width: 20px'><img src='"+this.icon+"' class='icon'/></span> ");var a=this.title,n=""==this.helpIcon?"none":"",r=""==this.settingsIcon?"none":"",s="<span class='buttons'><img class='options_section_help' style='display:"+n+"' src='"+this.helpIcon+"' class='icon'/><img class='options_section' style='display:"+r+"' src='"+this.settingsIcon+"'></span>";if(this.uuid&&(o.id=this.uuid.substr(1)),!this.inspector||e){e||(this.inspector=new LiteGUI.Inspector),this.sectionEle=this.inspector.addSection(i+a+s,o),this.sectionEle.querySelector(".options_section_help").addEventListener("click",function(e){t.helpUrl&&""!=t.helpUrl&&window.open(""+t.helpUrl);e.preventDefault(),e.stopPropagation()}),this.sectionEle.querySelector(".wsectiontitle").addEventListener("contextmenu",function(e){return 2!=e.button||e.preventDefault(),!1}.bind(this)),this.sectionEle.querySelector(".options_section").addEventListener("click",function(e){window.SELECTED=this,t.showComponentContextMenu(e),e.preventDefault(),e.stopPropagation()});var l=0;this.sectionEle.addEventListener("dragover",function(e){e.preventDefault()}),this.sectionEle.addEventListener("dragenter",function(e){l++,-1!=e.dataTransfer.types.indexOf("type")&&1==l&&(this.style.opacity="0.8"),e.preventDefault()},!0),this.sectionEle.addEventListener("dragleave",function(e){0==--l&&(this.style.opacity=null),e.preventDefault()},!0),this.sectionEle.addEventListener("drop",function(e){e.preventDefault(),this.style.opacity=null;var t=e.dataTransfer.getData("uuid");if("Component"==e.dataTransfer.getData("type")){var o=TONG.GlobalScene.findComponentByUId(t);this!=o&&this.root==o.root&&index,e.stopPropagation(),e.stopImmediatePropagation()}})}},TONG.Component.prototype.showComponentContextMenu=function(e,t){var o=TONG.Component.getActions(this);if(o){var i=this.title,a=this,n=new LiteGUI.ContextMenu(o,{ignore_item_callbacks:!0,event:e,parentMenu:t,title:i,callback:function(e,t,o){TONG.Component.doAction(a,e)}});if(this.root.isRegisterComponent(this))for(var r=1;r<n.root.children.length;r++)"Copy"!=n.root.children[r].textContent&&"Delete"!=n.root.children[r].textContent||(n.root.children[r].style.color="#555");var s=LiteGUI.getLocalClipboard();if(!s)for(r=1;r<n.root.children.length;r++)"Paste"==n.root.children[r].textContent&&(n.root.children[r].style.color="#555");i=n.root.querySelector(".litemenu-title");var l=this.getComponentIconHTML();return i.insertBefore(l,i.firstChild),n}},TONG.Component.prototype.getComponentIconHTML=function(){LiteGUI.missing_icons||(LiteGUI.missing_icons={});var e="imgs/mini-icon-question.png";this.icon&&!LiteGUI.missing_icons[this.icon]&&(e=this.icon);var t=document.createElement("span");t.className="icon",t.style.width="20px",t.setAttribute("draggable",!0),t.innerHTML="<img title='Drag icon to transfer' src='"+e+"'/>",t.addEventListener("dragstart",function(e){if(e.dataTransfer.setData("uid",this.uuid),!this._root)return!1;var t,o=this.title;t=e.shiftKey?this.getLocator():this._root.name+"/"+o,e.dataTransfer.setData("locator",t),e.dataTransfer.setData("type","Component"),e.dataTransfer.setData("node_uid",this._root.uuid),e.dataTransfer.setData("class",o),this.setDragData&&this.setDragData(e)}),t.addEventListener("click",function(e){e.stopPropagation(),e.stopImmediatePropagation()});var o=t.querySelector(".icon img");return o&&(o.onerror=function(){LiteGUI.missing_icons[this.icon]=!0,this.src="imgs/mini-icon-question.png",this.onerror=null}),t},TONG.Component.prototype.onInspectorGUI=function(editor){"Component"==this.title&&(this.title=this.className);var signals=editor.signals;this.target||(this.target=this),this.isSelectedObject&&(this.target=editor.selected),this.editor=editor,this.selected=editor.selected;var that=this;function applyOptions(e,t){var o={};return t&&(t instanceof TONG.Value?o=t.getOptionsEV():t.options&&(o=t.options)),o.callback=e,o}that.updateUI=function(a){for(var e in that)null!=(new TONG.Component)[e]||that[e]instanceof Function||that[e]instanceof HTMLElement||null==a[e]||null==that[e]||(this.applyOptionsUI=function(e,t,o){switch(typeof t){case"boolean":(i=a!=that?a[e]:a[e]instanceof TONG.Value?a[e].getValue():a[e])!=that[e+"Widget"].data&&(that.isAdjustUI?that.isAdjustUI=!1:(that[e+"Widget"].setValue(i),o&&o.setValue(i)));break;case"object":if(t instanceof TONG.Vector3)(i=a!=that?a[e]:a[e]instanceof TONG.Value?a[e].getValue():a[e]).x==that[e+"Widget"].getValue()[0]&&i.y==that[e+"Widget"].getValue()[1]&&i.z==that[e+"Widget"].getValue()[2]||(that.isAdjustUI?that.isAdjustUI=!1:(that[e+"Widget"].setValue([i.x,i.y,i.z]),o&&o.setValue(new TONG.Vector3(i.x,i.y,i.z))));else if(t instanceof TONG.Enum)that[e+"Widget"].getValue()!=t.getValue()&&(that.isAdjustUI?that.isAdjustUI=!1:(that[e+"Widget"].setValue(t.getValue()),o&&o.setValue(t.getValue())));else if(t instanceof TONG.Euler){(i=a!=that?a[e]:a[e]instanceof TONG.Value?a[e].getValue():a[e]).x*TONG.Math.RAD2DEG==that[e+"Widget"].getValue()[0]&&i.y*TONG.Math.RAD2DEG==that[e+"Widget"].getValue()[1]&&i.z*TONG.Math.RAD2DEG==that[e+"Widget"].getValue()[2]||(that.isAdjustUI?that.isAdjustUI=!1:(that[e+"Widget"].setValue([i.x*TONG.Math.RAD2DEG,i.y*TONG.Math.RAD2DEG,i.z*TONG.Math.RAD2DEG]),o&&o.setValue(new TONG.Euler(i.x*TONG.Math.RAD2DEG,i.y*TONG.Math.RAD2DEG,i.z*TONG.Math.RAD2DEG,i.order))))}else if(t instanceof TONG.Vector2){(i=a!=that?a[e]:a[e]instanceof TONG.Value?a[e].getValue():a[e]).x==that[e+"Widget"].getValue()[0]&&i.y==that[e+"Widget"].getValue()[1]||(that.isAdjustUI?that.isAdjustUI=!1:(that[e+"Widget"].setValue([i.x,i.y]),o&&o.setValue(new TONG.Vector2(i.x,i.y))))}else if(t instanceof TONG.Vector4||t instanceof TONG.Quaternion){(i=a!=that?a[e]:a[e]instanceof TONG.Value?a[e].getValue():a[e]).x==that[e+"Widget"].getValue()[0]&&i.y==that[e+"Widget"].getValue()[1]&&i.z==that[e+"Widget"].getValue()[2]&&i.w==that[e+"Widget"].getValue()[3]||(that.isAdjustUI?that.isAdjustUI=!1:(that[e+"Widget"].setValue([i.x,i.y,i.z,i.w]),o&&(t instanceof TONG.Quaternion?o.setValue(new TONG.Quaternion(i.x,i.y,i.z,i.w)):t instanceof TONG.Vector4&&o.setValue(new TONG.Vector4(i.x,i.y,i.z,i.w)))))}else if(t instanceof TONG.Object3D);else if(t instanceof TONG.Texture);else if(t instanceof TONG.Color){(i=a!=that?a[e]:a[e]instanceof TONG.Value?a[e].getValue():a[e]).r==that[e+"Widget"][0]&&i.g==that[e+"Widget"][1]&&i.b==that[e+"Widget"][2]||(that.isAdjustUI?that.isAdjustUI=!1:(that[e+"Widget"].setValue([i.r,i.g,i.b]),o&&o.setValue(new TONG.Color(i.r,i.g,i.b))))}else t instanceof TONG.Value&&this.applyOptionsUI(e,t.getValue(),t);break;case"string":case"number":var i;(i=a!=that?a[e]:a[e]instanceof TONG.Value?a[e].getValue():a[e])!=that[e+"Widget"].getValue()&&(that.isAdjustUI?that.isAdjustUI=!1:(that[e+"Widget"].setValue(i),o&&o.setValue(i)))}},this.applyOptionsUI(e,that[e]));that.isRefreshUI=!1},this.onInspectorInit=function(){for(var key in this){for(var isHasPower=!1,i=0;i<this.traversePower.length;i++)if(this[key]instanceof this.traversePower[i]){this!=this.target&&void 0!==this.target[key]&&this.target[key]instanceof this.traversePower[i]&&"target"!=key&&(this[key]=this.target[key]),isHasPower=!0,void 0!==this.target[key]||this[key].must||(isHasPower=!1);break}void 0!==(new TONG.Component)[key]||this[key]instanceof Function||void 0===this.target[key]&&!isHasPower||(this!=this.target&&(isHasPower?this[key]instanceof TONG.Behavior&&void 0!==this.target[key]&&null!=this.target[key]&&this[key].setValue(this.target[key],!0):this[key]instanceof TONG.Behavior?this[key].setValue(this.target[key],!0):this[key]=this.target[key]),this.applyInit=function(key,keyOfValue,tValue){switch(typeof keyOfValue){case"boolean":function callback(e,t){var o=that.target[key];that[key]instanceof TONG.Value&&(o=that[key].getValue()),e!=o&&(that.isAdjustUI=!0,that!=that.target&&(that[key]instanceof TONG.Value?that[key].setValue(e):that[key]=e),editor.execute(new SetValueCommand(that.target,key,e,o)))}var opts=applyOptions(callback,tValue),name=tValue&&void 0!==tValue.options.alias?tValue.options.alias:key;opts.pretitle=AnimationModule.getKeyframeCode(this._root.uuid+"."+this.className,key),this[key+"Widget"]=this.inspector.addCheckbox(name,keyOfValue,opts);break;case"object":if(keyOfValue instanceof TONG.Vector3){function callback(e,t){var o=new TONG.Vector3(e[0],e[1],e[2]);if(that.target instanceof TONG.Object3D){if("position"==key){var i=that.target[key];that[key]instanceof TONG.Value&&(i=that[key].getValue()),.01<=i.distanceTo(o)&&(that.isAdjustUI=!0,that!=that.target&&(that[key]instanceof TONG.Value?that[key].setValue(o):that[key]=o),editor.execute(new SetPositionCommand(that.target,o)))}else if("scale"==key){i=that.target[key];that[key]instanceof TONG.Value&&(i=that[key].getValue()),.01<=i.distanceTo(o)&&(that.isAdjustUI=!0,that!=that.target&&(that[key]instanceof TONG.Value?that[key].setValue(o):that[key]=o),editor.execute(new SetScaleCommand(that.target,o)))}}else{i=that.target[key];that[key]instanceof TONG.Value&&(i=that[key].getValue()),.01<=i.distanceTo(o)&&(that.isAdjustUI=!0,that!=that.target&&(that[key]instanceof TONG.Value?that[key].setValue(o):that[key]=o),editor.execute(new SetValueCommand(that.target,key,o,i)))}}var opts=applyOptions(callback,tValue),name=tValue&&void 0!==tValue.options.alias?tValue.options.alias:key;opts.pretitle=AnimationModule.getKeyframeCode(this._root.uuid+"."+this.className,key),this[key+"Widget"]=this.inspector.addVector3(name,[keyOfValue.x,keyOfValue.y,keyOfValue.z],opts)}else if(keyOfValue instanceof TONG.Enum){var enumValue="";if(this.target!=this&&null!=this.target[key])if(keyOfValue.isCompile){for(var namesArr=keyOfValue.getNames(),enumI=0;enumI<namesArr.length;enumI++)if(eval(namesArr[enumI])==this.target[key]){keyOfValue.setValue(namesArr[enumI]),enumValue=namesArr[enumI];break}}else keyOfValue.setValue(this.target[key]),enumValue=this.target[key];else if(this.target==this)enumValue=this.target[key].getValue();else{if(!keyOfValue.must)break;enumValue=this[key].getValue()}function callback(value,name){var targetEnum=that[key],isCompile=!1;targetEnum instanceof TONG.Value&&(targetEnum=that[key].getValue()),isCompile=targetEnum.isCompile;var oldVal=targetEnum.getValue();if(value!=targetEnum.getValue()){if(that.isAdjustUI=!0,isCompile)return that.target!=that&&that[key].setValue(value),void editor.execute(new SetValueCommand(that.target,key,eval(value)));editor.execute(new SetValueCommand(that,key,value,oldVal))}}var resOptions=applyOptions(callback,keyOfValue);resOptions.values=keyOfValue.getNames(),!this.isNested&&(resOptions.pretitle=AnimationModule.getKeyframeCode(this._root.uuid+"."+this.className,key,{visible:!1}));var name=keyOfValue.options&&void 0!==keyOfValue.options.alias?keyOfValue.options.alias:key;this[key+"Widget"]=this.inspector.addCombo(name,enumValue,resOptions)}else if(keyOfValue instanceof TONG.Euler){function callback(e,t){var o=new TONG.Euler(e[0]*TONG.Math.DEG2RAD,e[1]*TONG.Math.DEG2RAD,e[2]*TONG.Math.DEG2RAD);if(that.target instanceof TONG.Object3D){if("rotation"==key){var i=that.target[key].toVector3(),a=that.target[key];that[key]instanceof TONG.Value&&(a=that[key].getValue(),i=that[key].getValue().toVector3()),.01<=i.distanceTo(o.toVector3())&&(that.isAdjustUI=!0,that!=that.target&&(that[key]instanceof TONG.Value?that[key].setValue(o):that[key]=o),editor.execute(new SetRotationCommand(that.target,o,a)))}}else{var n=that.target[key];that[key]instanceof TONG.Value&&(n=that[key].getValue()),.01<=n.toVector3().distanceTo(o.toArray())&&(that.isAdjustUI=!0,that!=that.target&&(that[key]instanceof TONG.Value?that[key].setValue(o):that[key]=o),editor.execute(new SetValueCommand(that.target,key,o,n)))}}var opts=applyOptions(callback,tValue),name=tValue&&void 0!==tValue.options.alias?tValue.options.alias:key;opts.pretitle=AnimationModule.getKeyframeCode(this._root.uuid+"."+this.className,key),this[key+"Widget"]=this.inspector.addVector3(name,[keyOfValue.x*TONG.Math.DEG2RAD,keyOfValue.y*TONG.Math.DEG2RAD,keyOfValue.z*TONG.Math.DEG2RAD],opts)}else if(keyOfValue instanceof TONG.Vector2){function callback(e,t){var o=new TONG.Vector2(e[0],e[1]),i=that.target[key];that[key]instanceof TONG.Value&&(i=that[key].getValue()),.01<=i.distanceTo(o)&&(that.isAdjustUI=!0,that!=that.target&&(that[key]instanceof TONG.Value?that[key].setValue(o):that[key]=o),editor.execute(new SetValueCommand(that.target,key,o,i)))}var opts=applyOptions(callback,tValue),name=tValue&&void 0!==tValue.options.alias?tValue.options.alias:key;opts.pretitle=AnimationModule.getKeyframeCode(this._root.uuid+"."+this.className,key),this[key+"Widget"]=this.inspector.addVector2(name+"",[keyOfValue.x,keyOfValue.y],opts)}else if(keyOfValue instanceof TONG.Vector4||keyOfValue instanceof TONG.Quaternion){function callback(e,t){var o=new TONG.Vector4(e[0],e[1],e[2],e[3]),i=that.target[key];that[key]instanceof TONG.Value&&(i=that[key].getValue()),i.x==o.x&&i.y==o.y&&i.z==o.z&&i.w==o.w||(that.isAdjustUI=!0,that!=that.target&&(that[key]instanceof TONG.Value?that[key].setValue(o):that[key]=o),editor.execute(new SetValueCommand(that.target,key,o,i)))}var opts=applyOptions(callback,tValue),name=tValue&&void 0!==tValue.options.alias?tValue.options.alias:key;opts.pretitle=AnimationModule.getKeyframeCode(this._root.uuid+"."+this.className,key),this[key+"Widget"]=this.inspector.addVector4(name,[keyOfValue.x,keyOfValue.y,keyOfValue.z,keyOfValue.w],opts)}else if(keyOfValue instanceof TONG.Object3D){function callback(e,t){if(tValue&&e!=that[key].value||!tValue&&e!=that[key]){var o=that[key]instanceof TONG.Value?that[key].getValue():that[key];that!=that.target&&(that[key]instanceof TONG.Value?that[key].setValue(e):that[key]=e),editor.execute(new SetValueCommand(that.target,key,e,o))}}var name=tValue&&void 0!==tValue.options.alias?tValue.options.alias:key,resOpt=applyOptions(callback,tValue);resOpt.disabled?resOpt.disabled:resOpt.disabled=!0,this[key+"Widget"]=this.inspector.addObject3D(name,keyOfValue,resOpt)}else if(keyOfValue instanceof TONG.Slider){function callback(e){if(e!=that[key].getValue()){var t=that[key].toArray(),o=t[0];t[0]=e,that!=that.target&&that[key].setValue(e),editor.execute(new SetValueCommand(that.target,key,e,o))}}var resOpt=applyOptions(callback,keyOfValue),name=null!=keyOfValue.alias?keyOfValue.alias:key;resOpt.pretitle=AnimationModule.getKeyframeCode(this._root.uuid+"."+this.className,key),this[key+"Widget"]=this.inspector.addSlider(name,keyOfValue.getValue(),resOpt)}else if(keyOfValue instanceof TONG.Pad){function callback(e){var t=that[key].getValue();that!=that.target&&that[key].setValue(e),editor.execute(new SetValueCommand(that.target,key,e,t))}var resOpt=applyOptions(callback,keyOfValue),name=null!=keyOfValue.alias?keyOfValue.alias:key;resOpt.pretitle=AnimationModule.getKeyframeCode(this._root.uuid+"."+this.className,key),this[key+"Widget"]=this.inspector.addPad(name,keyOfValue.getValue(),resOpt)}else if(keyOfValue instanceof TONG.Polyline){function callback(e){var t=that[key].getValue();that!=that.target&&that[key].setValue(e),editor.execute(new SetValueCommand(that.target,key,e,t))}var resOpt=applyOptions(callback,keyOfValue),name=null!=keyOfValue.alias?keyOfValue.alias:key;resOpt.pretitle=AnimationModule.getKeyframeCode(this._root.uuid+"."+this.className,key,{visible:!1}),this[key+"Widget"]=this.inspector.addLine(name,keyOfValue.getValue(),resOpt)}else if(keyOfValue instanceof TONG.Texture||keyOfValue instanceof TONG.RenderTexture&&keyOfValue.isApplyTexture){if(void 0===this.target[key])break;function callback(e){that.isAdjustUI=!0;var t=that[key];that[key]instanceof TONG.Value&&(t=that[key].getValue()),TONG.RM.addTexture(e),e.image&&TONG.RM.addImage(e.image),that.target instanceof TONG.Material?(void 0!==e.needsUpdate&&(e.needsUpdate=!0),that!=that.target&&(that[key]instanceof TONG.Value?that[key].setValue(e):that[key]=e),editor.execute(new SetMaterialMapCommand(that.target,key,e,0))):(void 0!==e.needsUpdate&&(e.needsUpdate=!0),that!=that.target&&(that[key]instanceof TONG.Value?that[key].setValue(e):that[key]=e),editor.execute(new SetValueCommand(that.target,key,e,t)))}(this.target[key]instanceof TONG.Texture||this.target[key]instanceof TONG.RenderTexture)&&(tValue?tValue.setValue(this.target[key]):keyOfValue=this.target[key]);var optionsRes=applyOptions(callback,tValue);optionsRes.channel=key,optionsRes.material=this.target,optionsRes.disabled?optionsRes.disabled:optionsRes.disabled=!0,optionsRes.pretitle=AnimationModule.getKeyframeCode(this._root.uuid+"."+this.className,key,{visible:!1});var name=tValue&&void 0!==tValue.options.alias?tValue.options.alias:key;this[key+"Widget"]=this.inspector.addTexture(name,keyOfValue,optionsRes)}else if(keyOfValue instanceof TONG.Color){function callback(e,t){var o=that.target[key];if(that[key]instanceof TONG.Value&&(o=that[key].getValue()),o.r!=e[0]||o.g!=e[1]||o.b!=e[2]){that.isAdjustUI=!0;var i=that[key]instanceof TONG.Value?that[key].getValue():that[key],a=new TONG.Color(e[0],e[1],e[2]);that!=that.target&&(that[key]instanceof TONG.Value?that[key].setValue(a):that[key]=a),editor.execute(new SetValueCommand(that.target,key,a,i))}}var opts=applyOptions(callback,tValue),name=tValue&&void 0!==tValue.options.alias?tValue.options.alias:key;opts.pretitle=AnimationModule.getKeyframeCode(this._root.uuid+"."+this.className,key),this[key+"Widget"]=this.inspector.addColor(name,[keyOfValue.r,keyOfValue.g,keyOfValue.b],opts)}else if(keyOfValue instanceof TONG.Value)this.applyInit(key,keyOfValue.getValue(),keyOfValue);else if(keyOfValue instanceof TONG.Script){function callback(e,t){if(e!=keyOfValue.title){var o=TONG.RM.getResource(e),i=that._root,a=o.compile();a.script=o;var n=new TONG.Script.Compile;for(var r in n.title=o.filename,a)n[r]=a[r];TONG.Components.switchScriptComponent(i,that,n),EditorModule.refreshInspector()}}var name=tValue&&void 0!==tValue.options.alias?tValue.options.alias:key,resOpt=applyOptions(callback,tValue);resOpt.disabled?resOpt.disabled:resOpt.disabled=!0,resOpt.pretitle=AnimationModule.getKeyframeCode(this._root.uuid+"."+this.className,key,{visible:!1}),this[key+"Widget"]=this.inspector.addScript(name,keyOfValue,resOpt)}else if(keyOfValue instanceof TONG.Component)if(keyOfValue.isNested){var currentComponent=keyOfValue;currentComponent._root=that._root,currentComponent.onInspectorTitle(),currentComponent.onInspectorGUI(editor),that[key+"Widget"]=that.inspector.addContainer(),that[key+"Widget"].appendChild(currentComponent.inspector.root)}else{if("Component"==keyOfValue.title||""==keyOfValue.title)return;function callback(e,t){if(e&&e!=keyOfValue&&e.uuid!=keyOfValue.uuid){var o=that[key]instanceof TONG.Value?that[key].getValue():that[key];that!=that.target&&(that[key]instanceof TONG.Value?that[key].setValue(e):that[key]=e),editor.execute(new SetValueCommand(that.target,key,e,o))}}var name=tValue&&void 0!==tValue.options.alias?tValue.options.alias:key,resOpt=applyOptions(callback,tValue);resOpt.pretitle=AnimationModule.getKeyframeCode(this._root.uuid+"."+this.className,key,{visible:!1}),resOpt.disabled?resOpt.disabled:resOpt.disabled=!0,this[key+"Widget"]=this.inspector.addComponent(name,keyOfValue,resOpt)}else if(keyOfValue instanceof TONG.Material){function callback(e,t){if(tValue&&e!=that[key].value||!tValue&&e!=that[key]){var o=tValue&&that[key].value?that[key].value:that[key];TONG.RM.addMaterial(e),that!=that.target&&(that[key]instanceof TONG.Value?that[key].setValue(e):that[key]=e),editor.execute(new SetValueCommand(that.target,key,e,o))}}"Material"!=keyOfValue.type||(keyOfValue=new TONG.NoneMaterial,that[key]instanceof TONG.Value&&!(that.target[key]instanceof TONG.Value)&&that[key].setValue(keyOfValue),!(that[key]instanceof TONG.Value||that.target==that)&&(that[key]=keyOfValue));var name=tValue&&void 0!==tValue.options.alias?tValue.options.alias:key,resOpt=applyOptions(callback,tValue);resOpt.pretitle=AnimationModule.getKeyframeCode(this._root.uuid+"."+this.className,key,{visible:!1}),resOpt.disabled?resOpt.disabled:resOpt.disabled=!0,this[key+"Widget"]=this.inspector.addMaterial(name,keyOfValue,resOpt)}else if(keyOfValue instanceof Array){function callback(e,t,o,i,a){var n=this;if(TONG.MaterialClasses[e.name]instanceof TONG.Material&&that.target==editor.selected.material){var r=e;null==i&&Array.isArray(that.target),that!=that.target&&(that[key]instanceof TONG.Value?that[key].setValue(n.value):that[key]=n.value),editor.execute(new SetMaterialCommand(editor.selected,r,t,i,a),"New Material: "+e),tValue.options.target=n.getOptions().target=that.target=editor.selected.material}else if(tValue.options&&tValue.options.data_type&&that.target==editor.selected.material&&tValue.options.data_type==TONG.Resource.TYPE.Material){r=null==e?new TONG.MeshStandardMaterial:e,null==i&&Array.isArray(that.target),that!=that.target&&(that[key]instanceof TONG.Value?that[key].setValue(n.value):that[key]=n.value),editor.execute(new SetMaterialCommand(editor.selected,r,t,i,a),"New Material: "+e),tValue.options.target=that.target=editor.selected.material}}var optionsRes=applyOptions(callback,tValue);optionsRes.callback_ele=!0;var name=tValue&&void 0!==tValue.options.alias?tValue.options.alias:key;if(that.title==GetLanguage("MaterialEditor"))this[key+"Widget"]=this.inspector.addArrayList(name,keyOfValue,optionsRes);else{var arrWidgets=new LiteGUI.Inspector;arrWidgets.addSection(name),arrWidgets.addArray(name,keyOfValue,{callback:function(){}}),that[key+"Widget"]=that.inspector.addContainer(),that[key+"Widget"].appendChild(arrWidgets.root)}}else if(keyOfValue instanceof TONG.Resource||keyOfValue instanceof TONG.MeshAsset||keyOfValue instanceof TONG.AnimationAsset||keyOfValue instanceof TONG.AudioAsset||keyOfValue instanceof TONG.VideoAsset||keyOfValue instanceof TONG.RenderTexture||keyOfValue instanceof TONG.FontAsset){function callback(e,t){if(e&&e!=keyOfValue&&e.uuid!=keyOfValue.uuid){var o=that[key]instanceof TONG.Value?that[key].getValue():that[key];that!=that.target&&(that[key]instanceof TONG.Value?that[key].setValue(e):that[key]=e),editor.execute(new SetValueCommand(that.target,key,e,o))}}var name=tValue&&void 0!==tValue.options.alias?tValue.options.alias:key,resOpt=applyOptions(callback,tValue);resOpt.pretitle=AnimationModule.getKeyframeCode(this._root.uuid+"."+this.className,key,{visible:!1}),resOpt.disabled?resOpt.disabled:resOpt.disabled=!0,this[key+"Widget"]=this.inspector.addResource(name,keyOfValue,resOpt,keyOfValue.resource_type)}break;case"string":function callback(e,t){var o=that.target[key];that[key]instanceof TONG.Value&&(o=that[key].getValue()),o!=e&&(that.isAdjustUI=!0,that!=that.target&&(that[key]instanceof TONG.Value?that[key].setValue(e):that[key]=e),editor.execute(new SetValueCommand(that.target,key,e,o)))}var opts=applyOptions(callback,tValue),name=tValue&&void 0!==tValue.options.alias?tValue.options.alias:key;opts.pretitle=AnimationModule.getKeyframeCode(this._root.uuid+"."+this.className,key);var isTextArea=!(!tValue||!tValue.options.textarea)&&tValue.options.textarea;this[key+"Widget"]=isTextArea?this.inspector.addTextarea(name,keyOfValue,opts):this.inspector.addString(name,keyOfValue,opts);break;case"number":function callback(e,t){var o=that.target[key];that[key]instanceof TONG.Value&&(o=that[key].getValue()),o!=e&&(that.isAdjustUI=!0,that!=that.target&&(that[key]instanceof TONG.Value?that[key].setValue(e):that[key]=e),editor.execute(new SetValueCommand(that.target,key,e,o)))}var opts=applyOptions(callback,tValue);opts.pretitle=AnimationModule.getKeyframeCode(this._root.uuid+"."+this.className,key);var name=tValue&&void 0!==tValue.options.alias?tValue.options.alias:key;this[key+"Widget"]=this.inspector.addNumber(name,keyOfValue,opts)}},this.applyInit(key,this[key]))}},this.signalInit||(this.signalInit=!0,signals.objectChanged.add(function(e,t){if(!(e instanceof TONG.Object3D)||e===editor.selected&&0!=e._getComponents(that).length){var o=e instanceof TONG.Component?e._root:e;o&&that._root==o&&that.OnEditorObjectChanged&&that.OnEditorObjectChanged(o,t),e===that.target&&that.updateUI&&!that.isRefreshUI&&(that.isRefreshUI=!0,that.updateUI(e))}}),signals.objectRemoved.add(function(e){e&&that._root==e&&e.traverse(function(e){for(var t=0;t<e.components.length;t++)e.components[t].OnEditorRemoveObject&&e.components[t].OnEditorRemoveObject(e)})}),signals.refreshSidebarObject3D.add(function(e){e instanceof TONG.Object3D&&(e!==editor.selected||0==e._getComponents(that).length)||e===that.target&&that.updateUI&&!that.isRefreshUI&&(that.isRefreshUI=!0,that.updateUI(e))}),signals.materialChanged.add(function(e){if(that.target instanceof TONG.Material&&that.selected===editor.selected&&(that.target=e,that.updateUI&&!that.isRefreshUI&&(that.inspector.clear(),that.collapsed=!1,that.onInspectorTitle(!0),that.onInspectorInit(),that._root)))for(var t=0;t<that._root.components.length;t++)that._root.components[t].OnEditorMaterialChange&&that._root.components[t].OnEditorMaterialChange(e.material)}),signals.geometryChanged.add(function(e){if(that.selected===e&&e.geometry&&e.geometry.type&&(that.target instanceof TONG.BufferGeometry||that.target instanceof TONG.Geometry)&&that.target.type!=e.geometry.type&&(that.target=e.geometry,that.updateUI&&!that.isRefreshUI)){that.inspector.clear(),that.collapsed=!1,that.onInspectorTitle(!0),that.onInspectorInit(),that.geometryChange&&that.geometryChange();for(var t=0;t<e.components.length;t++)e.components[t].OnEditorGeometryChange&&e.components[t].OnEditorGeometryChange(e.geometry)}})),this.onInspectorInit&&!this.isInit?(this.isInit=!0,this.OnInspectorAwake&&this.OnInspectorAwake(),this.onInspectorInit(),this.OnInspectorStart&&this.OnInspectorStart()):this.refreshInspector(),this.require&&this.Require(this.require)},TONG.Component.prototype.OnEditorRemoveObject=function(e){},TONG.Component.prototype.OnInspectorUpdate=function(){},TONG.Component.prototype.OnEditorObjectChanged=function(e,t){},TONG.Component.prototype.OnEditorMaterialChange=function(e){},TONG.Component.prototype.OnEditorGeometryChange=function(e){},TONG.Component.prototype.refreshInspector=function(){this.inspector&&isEditor&&(this.inspector.clear(),this.onInspectorTitle(!0),this.onInspectorInit())},TONG.Component.prototype.sendMessage=function(e,t){var o=this._root;o&&o.sendMessage(e,t)},TONG.Component.prototype.getComponents=function(e){return this._root?this._root.getComponents(e):null},TONG.Component.prototype.bind=function(e,t,o){if(!(3<arguments.length)&&(e&&o))return this.__targeted_instances||Object.defineProperty(this,"__targeted_instances",{value:[],enumerable:!1,writable:!0}),-1==this.__targeted_instances.indexOf(e)&&this.__targeted_instances.push(e),TONG.Event.bind(e,t,o,this)},TONG.Component.prototype.unbind=function(e,t,o){var i=TONG.Event.unbind(e,t,o,this);if(this.__targeted_instances){if(!TONG.Event.hasBindTo(e,this))return i;var a=this.__targeted_instances.indexOf(e);-1==a&&this.__targeted_instances.splice(a,1),0==this.__targeted_instances.length&&delete this.__targeted_instances}return i},TONG.Component.prototype.unbindAll=function(){if(this.__targeted_instances){for(var e=0;e<this.__targeted_instances.length;++e)TONG.Event.unbindAll(this.__targeted_instances[e],this);this.__targeted_instances=null}},TONG.Component.prototype.OnAddedToNode=function(e){},TONG.Component.prototype.OnInspectorChange=function(e){},TONG.Component.prototype.OnInspectorSelect=function(e){},TONG.Component.prototype.OnRemovedFromNode=function(e){},TONG.Component.prototype.OnAddedToScene=function(e){},TONG.Component.prototype.OnRemovedFromScene=function(e){},TONG.Component.prototype.onRefreshEditorScene=function(){isEditor&&EditorModule.target.signals.sceneGraphChanged.dispatch()},TONG.Component.prototype.getResources=function(){return TONG.RM.getResource(this.name)},TONG.Component.prototype.OnResourceRenamed=function(e,t,o){},TONG.Component.prototype.Require=function(e){if(!e)throw"no component class specified";var t="string"==typeof e?e:(new e).title;if(!(e=TONG.Components[t]))return null;if(0==this._root._getComponents(t).length){var o=new e;return this._root.addComponent(o),EditorModule.target.execute(new AddComponentCommand(this._root,o)),CORE.userAction("component_created",o),o}},TONG.Component.addExtraMethods=function(e){Object.defineProperty(e.prototype,"uuid",{set:function(e){e&&e!=this._uuid&&(this._uuid=e)},get:function(){return this._uuid},enumerable:!1}),Object.defineProperty(e.prototype,"root",{set:function(e){throw"root cannot be set, call addComponent to the root"},get:function(){return this._root},enumerable:!1}),Object.defineProperty(e.prototype,"mesh",{set:function(e){throw"root cannot be set, call addComponent to the root"},get:function(){return this._root},enumerable:!1}),Object.defineProperty(e.prototype,"gameObject",{set:function(e){throw"root cannot be set, call addComponent to the root"},get:function(){return this._root},enumerable:!1})},TONG.Component.addExtraMethods(TONG.Component),TONG.Object3D.actions={},TONG.Object3D.prototype.getActions=function(e){for(var t in e=e||{},TONG.Object3D.actions)e[t]=TONG.Object3D.actions[t];return e},TONG.Object3D.prototype.doAction=function(e){if(e){var t=null;if(e.constructor===String){var o=this.getActions();if(!o||!o[e])return!1;t=o[e]}else t=e;return!!t.callback&&t.callback.call(this)}},TONG.Object3D.actions.select={title:"Select",callback:function(){SelectionModule.setSelection(this)}},TONG.Object3D.actions.select_children={title:"Select Children",callback:function(){var e=this.getDescendants();e.push(this),SelectionModule.setMultipleSelection(e)}},TONG.Object3D.actions.clone={title:"Clone",callback:function(){EditorModule.cloneNode(this,!0)}},TONG.Object3D.actions.move_before={title:"Move before sibling",callback:function(){this.moveBefore()}},TONG.Object3D.actions.move_after={title:"Move after sibling",callback:function(){this.moveAfter()}},TONG.Object3D.actions.create_child_node={title:"Create Child Node",callback:function(){EditorModule.createNullNode(this)}},TONG.Object3D.actions.create_prefab={title:"Create Prefab",callback:function(){PackTools.showCreatePrefabDialog(this)}},TONG.Object3D.actions.use_prefab={title:"Assign Prefab",callback:function(){var t=this;EditorModule.showSelectResource({type:"Prefab",on_complete:function(e){t.prefab=e,EditorModule.showNodeInfo(t)}})}},TONG.Object3D.actions.inspect_in_dialog={title:"Inspect in dialog",callback:function(){EditorModule.inspectInDialog(this)}},TONG.Object3D.actions.info={title:"Show Information",callback:function(){EditorModule.showNodeInfo(this)}},TONG.Object3D.actions.addcomponent={title:"Add Component",callback:function(){EditorModule.showAddComponentToNode(this,function(){EditorModule.refreshAttributes()})}},TONG.Object3D.actions.layers={title:"Show Layers",callback:function(){var t=this;EditorModule.showLayersEditor(t.layers,function(e){t.layers=e,RenderModule.requestFrame()})}},TONG.Object3D.actions.delete={title:"Delete",callback:function(){EditorModule.deleteNode(this)}},TONG.Components={},TONG.Components.onRenameComponent=function(p,m,g){function f(e,t,o,i){if(t instanceof TONG.Script.Compile){if(t.script==g){for(var a in t.renameTitle(m),t)"target"!=a&&null==(new TONG.Component)[a]&&t[a]!=t&&f(a,t[a],null,t);delete TONG.Components[p],TONG.Components[m]=t}}else if(t instanceof TONG.Script)(t==g||"script"==e&&i&&i instanceof TONG.Script.Compile)&&("script"==e&&i&&i instanceof TONG.Script.Compile&&(t=i),null!=e&&t[e+"Widget"]&&t[e+"Widget"].setValue(m,!0));else if(t instanceof TONG.Material){if(t==g&&(t.fullpath=t.filename=t.name=m,null!=e&&i[e+"Widget"]&&i[e+"Widget"].setValue(m,!0)),!(g instanceof TONG.Material))if(null!=t.editorTarget){var n=t.editorTarget.shader.getNames(),r=t.editorTarget.shader.getValue();if(t instanceof TONG.ShaderMaterial&&g instanceof TONG.ShaderCode&&r==p){for(var s=[],l=0;l<n.length;l++)n[l]==p?s[l]=m:s[l]=n[l];t.editorTarget.shaderWidget.setOptionValues(s),t.editorTarget.shaderWidget.setValue(m)}else f("editorTarget",t.editorTarget)}else if(t instanceof TONG.ShaderMaterial&&t.shader==p)t.shader=m;else for(var c in t)f(c,t[c],null,t)}else if(t instanceof TONG.Texture)g instanceof TONG.Texture&&t.image==g.image&&(t.fullpath=t.filename=t.name=m,null!=e&&i[e+"Widget"]&&i[e+"Widget"].setValue(m,!0));else if(t instanceof TONG.ShaderCode)t==g&&null!=e&&i[e+"Widget"]&&i[e+"Widget"].setValue(m,!0);else if(t instanceof TONG.Value)f(e,t.getValue(),t,i);else if(t instanceof Array){if(o&&o instanceof TONG.Value&&null!=o.options.data_type)for(var u=-1,d=0;d<t.length;d++)if(t[d]==p&&(t[d]=m,-1!=(u=d)&&null!=e&&i[e+"Widget"]&&i[e+"Widget"].widgets[u].setValue(m,!0)),null!=e&&i[e+"Widget"]){var h=i[e+"Widget"].widgets[d].resource;h&&f(e,h,null,i)}}else if(t instanceof HTMLElement);else if(t instanceof TONG.Component)for(var a in t)"target"!=a&&null==(new TONG.Component)[a]&&t[a]!=t&&f(a,t[a],null,t)}for(var e in TONG.RM.resources)TONG.RM.resources[e]instanceof TONG.Material&&(g instanceof TONG.Texture||g instanceof TONG.ShaderCode)&&f(null,TONG.RM.resources[e]);EditorModule.target.scene.traverse(function(e){var t=e._getComponents();if(e.material&&(g instanceof TONG.Material||g instanceof TONG.Texture))if(e.material instanceof TONG.Material)f(e,e.material);else if(e.material instanceof Array)for(var o=0;o<e.material.length;o++)f(e,e.material[o]);for(var i=0;i<t.length;i++)f(null,t[i])})},TONG.Components.registerScriptComponent=function(e){var t=getComponentName(e);((TONG.Components[t]=e).constructor.is_component=!0,e.constructor.resource_type=TONG.Resource.TYPE.Script,!!e.OnAddedToNode!=!!e.OnRemovedFromNode||(e.OnAddedToScene,e.OnRemovedFromScene),e.getResources&&e.OnResourceRenamed,e.constructor.actions||(e.constructor.actions={}),EditorModule.Debug)&&e.serialize().object_class;TONG.Event.trigger(TONG.Components,"component_registered",e)},TONG.Components.switchScriptComponent=function(e,t,o){for(var i=0;i<e.components.length;++i)e.components[i]==t&&(e.removeComponent(t),e.addComponent(o,i<e.components.length?i:void 0))},TONG.Components.replaceScriptComponent=function(scene,name,compile){var num=0,scriptsComp=[];return scene.traverse(function(obj){var node=obj;if(node.components){for(var scriptClone=new compile,className=FileSystem.getNameWithoutExtension(name),scriptPrototype=eval("new "+className+"Prototype()"),j=0;j<node.components.length;++j){var comp=node.components[j];if(comp.className==className){for(var key in comp)null==scriptPrototype[key]||comp[key]instanceof HTMLElement||(scriptClone[key].setValue?scriptClone[key].setValue(comp[key].getValue?comp[key].getValue():comp[key]):scriptClone[key]=comp[key].getValue?comp[key].getValue():comp[key]);node.removeComponent(comp),node.addComponent(scriptClone,j<node.components.length?j:void 0),scriptClone.uuid=scriptClone._uuid=comp.uuid,scriptsComp.push(scriptClone),num++}}if(node._missing_components)for(var j=0;j<node._missing_components.length;++j){var comp_info=node._missing_components[j];if(comp_info[0]===old_class_name){node._missing_components.splice(j,1);var new_comp=new proposed_class;node.addComponent(new_comp,comp_info[2]<node.components.length?comp_info[2]:void 0),new_comp.configure(comp_info[1]),j--,num++}}}}),scriptsComp},TONG.Components.getUUIDTypeMap=function(e,t){if(null==t||""==t)return null;for(var o in e)if(e[o]instanceof Array)for(var i=0;i<e[o].length;i++){if(e[o][i].uuid==t)return(r={})[o]=e[o][i],r}else if(e[o]instanceof Object)if("components"==o)for(var a in e[o])for(var n in e[o][a]){var r={};if(e[o][a][n].uuid==t)return r[o]=e[o][a][n],r}else for(var a in e[o]){if(e[o][a].uuid==t)return(r={})[o]=e[o][a],r}return null},TONG.Components.configureComponents=function(sceneJson,sceneObj,materials){function objectMaterialByUUID(e){for(var t in materials)if(t==e)return materials[t];return null}function applyValue(target,key,value){if(null!=value)switch(typeof value){case"number":case"string":case"boolean":var kVal=value;target[key]instanceof TONG.Value?target[key].setValue(kVal,!0):target[key]=kVal;break;case"object":if(null!=value.uuid)switch(value.type){case"TONG.Texture":var textureObj=TONG.RM.getResourceByUUID(value.uuid),textureSystem=TONG.RM.getTextureByUUID(value.uuid);textureObj?target[key]instanceof TONG.Value?target[key].setValue(textureObj,!0):target[key]=textureObj:textureSystem&&(target[key]instanceof TONG.Value?target[key].setValue(textureSystem,!0):target[key]=textureSystem);break;case"TONG.MeshAsset":var meshDataObj=TONG.RM.getResourceByUUID(value.uuid);meshDataObj&&(target[key]instanceof TONG.Value?target[key].setValue(meshDataObj,!0):target[key]=meshDataObj);break;case"TONG.AnimationAsset":var aniDataObj=TONG.RM.getResourceByUUID(value.uuid);aniDataObj&&(target[key]instanceof TONG.Value?target[key].setValue(aniDataObj,!0):target[key]=aniDataObj);break;case"TONG.AudioAsset":var audioDataObj=TONG.RM.getResourceByUUID(value.uuid);audioDataObj&&(target[key]instanceof TONG.Value?target[key].setValue(audioDataObj,!0):target[key]=audioDataObj);break;case"TONG.VideoAsset":var videoDataObj=TONG.RM.getResourceByUUID(value.uuid);videoDataObj&&(target[key]instanceof TONG.Value?target[key].setValue(videoDataObj,!0):target[key]=videoDataObj);break;case"TONG.RenderTexture":var renderDataObj=TONG.RM.getResourceByUUID(value.uuid);renderDataObj&&(value.isTexture&&(renderDataObj.isApplyTexture=!0),target[key]instanceof TONG.Value?target[key].setValue(renderDataObj,!0):target[key]=renderDataObj);break;case"TONG.FontAsset":var fontDataObj=TONG.RM.getResourceByUUID(value.uuid);fontDataObj&&(target[key]instanceof TONG.Value?target[key].setValue(fontDataObj,!0):target[key]=fontDataObj);break;case"TONG.Material":var typeObj=TONG.RM.getResourceByUUID(value.uuid);null==typeObj&&(typeObj=objectMaterialByUUID(value.uuid)),typeObj&&(target[key]instanceof TONG.Value?target[key].setValue(typeObj,!0):target[key]=typeObj);break;case"TONG.Object3D":var currentObj=sceneObj.getObjectByProperty("uuid",value.uuid,!0);currentObj?target[key]instanceof TONG.Value?target[key].setValue(currentObj,!0):target[key]=currentObj:value.uuid&&""!=value.uuid&&(target[key].uuid=value.uuid);break;case"TONG.Script":var scriptObj=TONG.RM.getResourceByUUID(value.uuid);scriptObj&&(target[key]instanceof TONG.Value?target[key].setValue(scriptObj,!0):target[key]=scriptObj);break;case"TONG.Component":var comJson=TONG.Components.getUUIDTypeMap(sceneJson,value.uuid);if(null!=comJson){var comRes=null;for(var comKey in comJson)comRes=comJson[comKey];var confiData=configureData(sceneJson,comRes,!1);target[key]instanceof TONG.Value?target[key].setValue(sceneObj.getObjectByProperty("uuid",comRes._root,!0).addComponent(confiData),!0):target[key]=sceneObj.getObjectByProperty("uuid",comRes._root,!0).addComponent(confiData)}}else if(null!=value.value)switch(value.type){case"TONG.Enum":""!=value.value&&(target[key]=target[key].setValue(value.value));break;case"TONG.Pad":case"TONG.Polyline":case"TONG.Slider":Array.isArray(value.value)&&(target[key]=target[key].fromArray(value.value));break;case"TONG.Color":var colorVal=(new TONG.Color).setHex(value.value);target[key]instanceof TONG.Value?target[key].setValue(colorVal,!0):target[key]=colorVal;break;default:var valTarget=eval("new "+value.type+"()").fromArray(value.value);target[key]instanceof TONG.Value?target[key].setValue(valTarget,!0):target[key]=valTarget}}}function configureData(sceneJson,target,isRoot){if(null!=target){var targetData=null,targetTypesKey=null,targetTypesValue=null;targetData=target.target,"object"==typeof targetData&&targetData.uuid&&(targetData=targetData.uuid);var typesMap=TONG.Components.getUUIDTypeMap(sceneJson,targetData);if(null!=typesMap)for(var key in typesMap){targetTypesKey=key,targetTypesValue=typesMap[key];break}var targetResult=null;if("components"==targetTypesKey&&null!=targetTypesValue&&targetTypesValue.uuid!=target.uuid)targetResult=configureData(sceneJson,targetTypesValue,!1),targetResult=sceneObj.getObjectByProperty("uuid",targetResult._root.uuid,!0).addComponent(targetResult);else if("textures"==targetTypesKey){var textureResource=TONG.RM.getResource(targetTypesValue.fullpath||targetTypesValue.filename);targetResult=textureResource}else if("objects"==targetTypesKey){var objectTarget=sceneObj.getObjectByProperty("uuid",targetTypesValue.uuid,!0);targetResult=objectTarget}else if("materials"==targetTypesKey){var typeObj=TONG.RM.getResourceByUUID(targetTypesValue.uuid);null==typeObj&&(typeObj=objectMaterialByUUID(targetTypesValue.uuid)),targetResult=typeObj}var componentResult=null,componentTitle=target.className+".js",scriptFile=TONG.RM.getResource(componentTitle);if(null!=scriptFile){var resultCompile=scriptFile.getCompileScript();resultCompile.uuid=target.uuid,resultCompile.script=scriptFile,resultCompile.title=componentTitle,null==targetResult&&(targetResult=resultCompile),resultCompile.target=targetResult,componentResult=resultCompile}else{var componentClassObjName="new "+target.className+"()",component=eval(componentClassObjName);component.uuid=target.uuid,null==targetResult&&(targetResult=component),component.target=targetResult,componentResult=component}for(var key in target)"target"!=key&&applyValue(targetResult,key,target[key]);return componentResult}}function traverseComponents(l){var c=l.components;c&&0!=c.length&&function e(t){var o=t.components;if(o&&0<o.length)for(var i=0;i<o.length;i++)for(var a=0;a<c.length;a++)if(c[a].uuid==o[i]){var n=configureData(l,c[a],!0),r=sceneObj.getObjectByProperty("uuid",t.uuid,!0);r.addComponent(n)}if(t.children)for(var s=0;s<t.children.length;s++)e(t.children[s])}(l.object)}traverseComponents(sceneJson)},TONG.Components.registerComponent=function(e,t){var o=getComponentName(new e);if(t&&t.constructor!==String)throw"old_classname must be null or a String";TONG.Components[t||o];((TONG.Components[o]=e).is_component=!0,e.resource_type="Component",!!e.prototype.OnAddedToNode!=!!e.prototype.OnRemovedFromNode||(e.prototype.OnAddedToScene,e.prototype.OnRemovedFromScene),e.prototype.getResources&&e.prototype.OnResourceRenamed,e.actions||(e.actions={}),TONG.Component.addExtraMethods(e),EditorModule.Debug)&&(new e).serialize().object_class;TONG.Event.trigger(TONG.Components,"component_registered",e)},TONG.Components.unregisterComponent=function(e){TONG.Components[e]&&delete TONG.Components[e]},TONG.Components.isClassComponent=function(e){return!!TONG.Components[getObjectClassName(e)]},TONG.Components.replaceComponentClass=function(e,t,o){var i=o.constructor===String?TONG.Components[o]:o;if(!i)return 0;t.constructor===String&&(t=TONG.Components[t].title);for(var a=0,n=0;n<e.children.length;++n){for(var r=e.children[n],s=0;s<r.components.length;++s){var l=r.components[s];if(l.constructor!==i){var c=getObjectClassName(l);if(c==t||c==o){var u=l.serialize();r.removeComponent(l);var d=new i;r.addComponent(d,s<r.components.length?s:void 0),d.configure(u),a++}}}if(r._missing_components)for(s=0;s<r._missing_components.length;++s){var h=r._missing_components[s];if(h[0]===t){r._missing_components.splice(s,1);d=new i;r.addComponent(d,h[2]<r.components.length?h[2]:void 0),d.configure(h[1]),s--,a++}}}return a},TONG.Component.actions={},TONG.Component.getActions=function(e){var t={};for(var o in TONG.Component.actions)t[o]=TONG.Component.actions[o];if(e.constructor.actions)for(var o in e.constructor.actions){var i=e.constructor.actions[o];i.callback_show&&0==i.callback_show.call(e)||(t[o]=i)}return e.getActions&&(t=e.getActions(t)),t},TONG.Component.doAction=function(e,t){if(t){var o=null;if(t.constructor===String){var i=this.getActions(e);if(!i||!i[t])return!1;o=i[t]}else o=t;return!!o.callback&&o.callback.call(e)}},TONG.Component.actions.enable={title:"Enable/Disable",callback:function(){this.enabled=!this.enabled}},TONG.Component.actions.copy={title:"Copy",callback:function(){this.root.isRegisterComponent(this)||EditorModule.copyComponentToClipboard(this)}},TONG.Component.actions.paste={title:"Paste",callback:function(){EditorModule.pasteComponentFromClipboard(this)}},TONG.Component.actions.delete={title:"Delete",callback:function(){this.root.isRegisterComponent(this)||EditorModule.deleteNodeComponent(this)}},TONG.Component.actions.reset={title:"Reset",callback:function(){EditorModule.resetNodeComponent(this)}},TONG.Component.actions.share={title:"Share",callback:function(){}},ComponentContainer.prototype.configureComponents=function(e){if(e._components){for(var t=[],o=0,i=e._components.length;o<i;++o){var a=e._components[o],n=a[0],r=null;if("Transform"==n&&0==o&&this.transform)r=this.transform;else{var s=this._components[n];if(!s){this.missing_components||(this.missing_components=[]),a[2]=o,this.missing_components.push(a);continue}r=new s,this.addComponent(r)}t.push(r,a[1]),r.constructor===TONG.Components.ScriptFromFile&&(r._filename=a[1].filename),a[1].editor&&(r._editor=a[1].editor),a[1].uuid&&a[1].uuid!==r.uuid&&(r.uuid=a[1].uuid)}for(o=0,i=t.length;o<i;o+=2)t[o].configure(t[o+1])}},ComponentContainer.prototype.isRegisterComponent=function(e){e.constructor===String&&0<(e=this._getComponents(e)).length&&(e=e[0]);for(var t=0;t<this.registerComponents.length;t++){var o=this.registerComponents[t].name;if(e.constructor.name==o)return!0}return!1},ComponentContainer.prototype.serializeComponents=function(){if(this._components){for(var e={array:[]},t=0,o=this._components.length;t<o;++t){var i=this._components[t];if(i.serialize&&!i.skip_serialize&&!this.isRegisterComponent(i)){var a=i.serialize();i._editor&&(a.editor=i._editor),i.hasOwnProperty("uuid")&&!a.uuid&&(a.uuid=i.uuid);var n=i.title;e.array.push([n,a])}}if(this.missing_components&&this.missing_components.length)for(t=0;t<this.missing_components.length;++t){var r=this.missing_components[t];e.array.splice(r[2]||0,0,r)}return e}},ComponentContainer.prototype.addComponent=function(e,t){if(!e)throw"addComponent cannot receive null";if(this._components||(Object.defineProperty(this,"_components",{value:[],enumerable:!1}),Object.defineProperty(this,"components",{set:function(e){this._components=e},get:function(){for(var e=0;e<this.registerComponents.length;e++)this.addComponent(this.registerComponents[e],e);return this._components},enumerable:!1})),e.constructor===String){if(0<(e=this._getComponents(e)).length)return e[0]}else if(e instanceof Function&&!((e=new e(this))instanceof TONG.Component))throw"component class not extends of TONG.Component ";if(!(e instanceof TONG.Component))throw"component class not extends of TONG.Component ";var o=this._getComponents(e.title);return 0<o.length?o[0]:(e._root=this,null!=e.uuid&&""!=e.uuid||(e.uuid=TONG.Math.generateUUID()),null==e.target&&(e.isSelectedObject?e.target=e._root:e.target=e),-1!=this._components.indexOf(e)||(void 0!==t&&t<=this._components.length?this._components.splice(t,0,e):this._components.push(e),(this[e.className]=e).OnAddedToNode&&e.OnAddedToNode(this),TONG.Event.trigger(this,"componentAdded",e),isEditor&&EditorModule.refreshInspector()),e)},ComponentContainer.prototype.isContainRequireCurrentComponent=function(e){for(var t=e.constructor.name,o=this._getComponents(),i=0;i<o.length;i++)if(null!=o[i].require){var a="string"==typeof o[i].require?o[i].require:(new o[i].require).constructor.name;if(a==t&&o[i]!=e)return!0}return!1},ComponentContainer.prototype.removeComponent=function(e){if(this.isContainRequireCurrentComponent(e))return!1;if(!e)throw"removeComponent cannot receive null";TONG.Event.unbindAll(this,e);var t=this._components.indexOf(e);return e.OnRemovedFromNode&&e.OnRemovedFromNode(this),e._root=null,-1!=t&&this._components.splice(t,1),TONG.Event.trigger(this,"componentRemoved",e),!0},ComponentContainer.prototype.removeAllComponents=function(){for(;this._components.length;)this.removeComponent(this._components[0]),TONG.Event.trigger(this,"componentRemoved",component);this.missing_components=null},ComponentContainer.prototype.hasComponent=function(e,t){if(!this._components&&!this.missing_components)return!1;if(t&&this.missing_components&&this.missing_components.length){e.constructor!==String&&(e=this.registerComponents(e));for(var o=0,i=this.missing_components.length;o<i;++o)if(this.missing_components[o][0]==e)return!0}if(e.constructor===String&&!(e=this._components[e]))return!1;for(o=0,i=this._components.length;o<i;++o)if(this._components[o].constructor===e)return!0;return!1},ComponentContainer.prototype.getComponents=function(e){this._components||(Object.defineProperty(this,"_components",{value:[],enumerable:!1}),Object.defineProperty(this,"components",{set:function(e){this._components=e},get:function(){for(var e=0;e<this.registerComponents.length;e++)this.addComponent(this.registerComponents[e],e);return this._components},enumerable:!1}));this.components;if(e){var t=[];if(e.constructor===String){for(var o=0,i=this._components.length;o<i;++o)this._components[o].title==e&&t.push(this._components[o]);if(0==t.length)for(o=0,i=this._components.length;o<i;++o)this._components[o].className==e&&t.push(this._components[o])}else for(o=0,i=this._components.length;o<i;++o){var a=this._components[o];a.uuid===e.uuid&&t.push(a)}return t}return this._components},ComponentContainer.prototype._getComponents=function(e){if(this._components||(Object.defineProperty(this,"_components",{value:[],enumerable:!1}),Object.defineProperty(this,"components",{set:function(e){this._components=e},get:function(){for(var e=0;e<this.registerComponents.length;e++)this.addComponent(this.registerComponents[e],e);return this._components},enumerable:!1})),e){var t=[];if(e.constructor===String){for(var o=0,i=this._components.length;o<i;++o)this._components[o].title==e&&t.push(this._components[o]);if(0==t.length)for(o=0,i=this._components.length;o<i;++o)this._components[o].className==e&&t.push(this._components[o])}else for(o=0,i=this._components.length;o<i;++o){var a=this._components[o];a.uuid===e.uuid&&t.push(a)}return t}return this._components},ComponentContainer.prototype.getComponentByName=function(e){if(!this.components)return null;for(var t=0,o=this._components.length;t<o;++t)if(this._components[t].className==e)return this._components[t];return null},ComponentContainer.prototype.getComponentByUUID=function(e){if(!this.components)return null;for(var t=0,o=this._components.length;t<o;++t)if(this._components[t].uuid==e)return this._components[t];return null},ComponentContainer.prototype.getIndexOfComponent=function(e){return this.components?this._components.indexOf(e):-1},ComponentContainer.prototype.getComponentByIndex=function(e){return this.components?this._components[e]:null},ComponentContainer.prototype.setComponentIndex=function(e,t){if(!this._components)return null;t<0&&(t=0);var o=this._components.indexOf(e);-1!=o&&(this._components.splice(o,1),t>=this._components.length?this._components.push(e):this._components.splice(t,0,e))},ComponentContainer.prototype.requireComponent=function(e,t){if(!e)throw"no component class specified";if(e.constructor===String&&!(e=this._components[e]))return null;for(var o=this._components.length,i=0;i<o;++i)if(this._components[i].constructor===e)return this._components[i];var a=new e;return this.addComponent(a,o),t&&a.configure(t),a},ComponentContainer.prototype.requireScript=function(e){if(!e)throw"no url specified";var t=TONG.Components.ScriptFromFile;e=TONG.ResourcesManager.cleanFullpath(e);for(var o=this._components.length,i=0;i<o;++i){var a=this._components[i];if(a.constructor===t&&a._filename==e)return a}var n=new t;return n.filename=e,this.addComponent(n,o),n},ComponentContainer.prototype.processActionInComponents=function(e,t,o){if(this._components&&this._components.length)for(var i=0,a=this._components.length;i<a;++i){var n=this._components[i];n[e]&&n[e].constructor===Function?t&&t.constructor===Array?n[e].apply(n,t):n[e].call(n,t):o||n._script&&n._script.callMethod(e,t,!0)}},ComponentContainer.prototype.sendMessage=function(e,t){if(this.processActionInComponents(e,t),this.children&&this.children.length)for(var o=0,i=this.children.length;o<i;++o)this.children[o].broadcastMessage(e,t)},ComponentContainer.prototype.sendResourceRenamedEvent=function(r,s,l){this.traverse(function(e){e.prefab&&e.prefab.filename===r&&(e.prefab.filename=s);for(var t=0;t<e._getComponents().length;t++){var o=e._getComponents()[t];o.OnResourceRenamed&&o.OnResourceRenamed(r,s,l)}if(e.material)if(e.material instanceof Array||e.material.name!=r){function i(e){e&&e.OnResourceRenamed&&(e.OnResourceRenamed(r,s,l)&&TONG.RM.resourceModified(e))}var a=e.material;if(a instanceof Array)for(var n=0;n<a.length;n++)i(a[n]);else i(a)}else e.material.name=s,e.material.filename&&(e.material.filename=s)})},extendClass(TONG.Object3D,ComponentContainer);var AnimationAsset=function(){};TONG.AnimationData=TONG.AnimationAsset=AnimationAsset;var MeshAsset=function(){};TONG.MeshAsset=MeshAsset;var VideoAsset=function(){};TONG.VideoAsset=VideoAsset;var AudioAsset=function(){};TONG.AudioAsset=AudioAsset;var RenderTexture=function(e,t,o){e=e||512,t=t||512,TONG.WebGLRenderTarget.call(this,e,t,o)};function EditorResource(l){TONG.Component.call(this),this.title=0==Language.current?"资源属性":"Resource",this.icon="css/pic/resource/resource.png",this.helpIcon="",this.settingsIcon="",this.target=l;var c=this,u=""!=l.filename&&null!=l.filename?l.filename:l.name;this.filename=new TONG.Value({value:u,alias:GetLanguage("name"),callback:function(e){var t=TONG.RM.getResource(u);if(t){var o=TONG.RM.getExtension(e),i=TONG.RM.getExtension(u);if(o!=i&&(e+="."+i),e!=u){e=FileNameHelper.GetNextFileName(e),c.filenameWidget.setValue(e,!0),l.fullpath=l.filename=l.name=e;var a=c.target.fullpath||c.target.filename,n=TONG.RM.getFolder(a),r=u,s=TONG.RM.cleanFullpath(n+"/"+e);TONG.RM.renameResource(r,s),u=s,t.filename=e,DriveModule.refreshContent(),TONG.Components.onRenameComponent(r,s,t)}}else l.fullpath=l.filename=l.name=e}}),this.resource_type=new TONG.Value({value:l.resource_type,alias:GetLanguage("type"),disabled:!0}),l.resource_type!=TONG.Resource.TYPE.Json&&l.resource_type!=TONG.Resource.TYPE.Text&&l.resource_type!=TONG.Resource.TYPE.Script&&l.resource_type!=TONG.Resource.TYPE.ShaderCode||(this.data=new TONG.Value({value:l.data,alias:null,disabled:!0,textarea:!0,height:500})),this.size=new TONG.Value({value:l.size,alias:GetLanguage("size"),disabled:!0}),this.wrapS=new TONG.Enum(["TONG.ClampToEdgeWrapping","TONG.RepeatWrapping","TONG.MirroredRepeatWrapping"],{isCompile:!0,alias:GetLanguage("wrapS")}),this.wrapT=new TONG.Enum(["TONG.ClampToEdgeWrapping","TONG.RepeatWrapping","TONG.MirroredRepeatWrapping"],{isCompile:!0,alias:GetLanguage("wrapT")}),this.minFilter=new TONG.Enum(["TONG.NearestFilter","TONG.LinearFilter","TONG.NearestMipMapNearestFilter","TONG.NearestMipMapLinearFilter","TONG.LinearMipMapNearestFilter","TONG.LinearMipMapLinearFilter"],{isCompile:!0,alias:GetLanguage("minFilter")}),this.magFilter=new TONG.Enum(["TONG.NearestFilter","TONG.LinearFilter"],{isCompile:!0,alias:GetLanguage("magFilter")}),l instanceof TONG.Texture&&(this.repeat=new TONG.Value({value:new TONG.Vector2(1,1),alias:GetLanguage("repeat")}),this.offset=new TONG.Value({value:new TONG.Vector2(0,0),alias:GetLanguage("offset"),min:0,max:1}))}function Resource(){}TONG.RenderTexture=RenderTexture,TONG.RenderTexture.prototype=Object.create(TONG.WebGLRenderTarget.prototype),TONG.RenderTexture.prototype.constructor=TONG.RenderTexture,TONG.RenderTexture.prototype.isRenderTexture=!0,TONG.RenderTexture.prototype.isApplyTexture=!1,TONG.Prefab={},EditorResource.prototype=Object.create(TONG.Component.prototype),EditorResource.prototype.constructor=EditorResource,Object.defineProperty(Resource.prototype,"data",{set:function(e){this._data=e,this._modified=!0},get:function(){return this._data},enumerable:!0}),Resource.prototype.register=function(){TONG.ResourcesManager.registerResource(this.fullpath||this.filename,this)},Resource.prototype.rename=function(e){TONG.ResourcesManager.renameResource(this.fullpath||this.filename,e)},Resource.getDataToStore=function(e,t){var o=null,i="text",a="";if(e.getDataToStore)(o=e.getDataToStore())&&o.constructor==ArrayBuffer&&(i="binary");else if(e._original_file)(o=e._original_file)&&o.constructor!==File&&(o.constructor,Blob),i="file";else if(e._original_data)(o=e._original_data)&&o.constructor===ArrayBuffer&&(i="binary");else if(e.toBinary)o=e.toBinary(),i="binary",a=e.constructor.binary_extension?e.constructor.binary_extension:"wbin";else if(e.toBlob&&t)o=e.toBlob(),i="file";else if(e.toBase64)o=e.toBase64(),i="base64";else if(e.serialize){var n=e.serialize();delete n.filename,delete n.fullpath,delete n.remotepath,delete n._preview_url,o=JSON.stringify(n)}else o=e.data?e.data:JSON.stringify(e);return o.buffer&&o.buffer.constructor==ArrayBuffer&&(o=o.buffer),{data:o,encoding:i,extension:a}},Resource.prototype.serialize=function(e){return{uuid:this.uuid,filename:this.filename,fullpath:this.fullpath,resource_type:this.resource_type,data:this.data}},Resource.prototype.clone=function(){var e=new TONG.Resource;e.uuid=this.uuid;var t=FileNameHelper.GetNextFileName(this.filename);return e.fullpath=e.filename=t,e.data=this.data,e},Resource.prototype.getData=function(){return this._data},Resource.prototype.setData=function(e,t){this._original_data&&(this._original_data=null),this._data=e,t||(this._modified=!0)},Resource.prototype.getDataToStore=function(){var e=this.data||"";return e.constructor===Object&&(e=JSON.stringify(e)),e},Resource.prototype.getCategory=function(){var e=this.fullpath||this.filename;return"js"==TONG.ResourcesManager.getExtension(e)?"Script":"Data"},Resource.prototype.assignToNode=function(e){if(!e)return!1;var t=this.fullpath||this.filename;if("Script"==this.getCategory()){var o=new TONG.Components.ScriptFromFile({filename:t});e.addComponent(o)}return!0},Resource.prototype.getAsSubfiles=function(){return this._data?ResourcesManager.processFileAtlas(this._data):null},Resource.prototype.getAsHTML=function(){if(!this._data||this._data.constructor!==String)return null;var e=document.createElement("div");return e.innerHTML=this._data,e},Resource.prototype.hasEditableText=function(){return this._data&&this._data.constructor===String},Resource.hasPreview=!1,TONG.Resource=Resource,TONG.Formats={supported:{},safe_parsing:!1,merge_smoothgroups:!1,addSupportedFormat:function(e,t){e.constructor===String&&(e=e.split(","));for(var o=0;o<e.length;++o){var i=e[o].toLowerCase();this.supported[i],this.supported[i]=t}},parse:function(e,t,o){o=o||{};var i=this.getFileFormatInfo(e);if(!i)return null;o.extension?i.extension=o.extension:i.extension=TONG.ResourcesManager.getExtension(e);var a=this.supported[i.extension];if(!a||!a.parse)return null;var n=null;if(this.safe_parsing)try{n=a.parse(t,o,e)}catch(e){return null}else n=a.parse(t,o,e);return n&&(n.name=e),n},TEXT_FORMAT:"text",JSON_FORMAT:"json",XML_FORMAT:"xml",BINARY_FORMAT:"binary",MESH_DATA:"MESH",IMAGE_DATA:"IMAGE",NONATIVE_IMAGE_DATA:"NONATIVE_IMAGE",SCENE_DATA:"SCENE",GENERIC_DATA:"GENERIC",getFileFormatInfo:function(e){var t=e.substr(e.lastIndexOf(".")+1).toLowerCase();return this.supported[t]},guessType:function(e){if(!e)return null;var t=TONG.RM.getExtension(e).toLowerCase(),o=this.supported[t];return o?o.resource:null},convertToDataURL:function(e){var t=document.createElement("canvas");t.width=e.width,t.height=e.height;var o=t.getContext("2d"),i=o.createImageData(e.width,e.height);t.width,t.height;if(3==e.bytesPerPixel)for(var a=0;a<t.width;++a)for(var n=0;n<t.height;++n){var r=n*t.width*4+4*a,s=(t.height-n-1)*t.width*3+3*a;i.data[r+2]=e.pixels[s],i.data[r+1]=e.pixels[s+1],i.data[r+0]=e.pixels[s+2],i.data[r+3]=255}else for(a=0;a<t.width;++a)for(n=0;n<t.height;++n){r=n*t.width*4+4*a,s=(t.height-n-1)*t.width*4+4*a;i.data[r+0]=e.pixels[s+2],i.data[r+1]=e.pixels[s+1],i.data[r+2]=e.pixels[s+0],i.data[r+3]=e.pixels[s+3]}return o.putImageData(i,0,0),e.dataurl=t.toDataURL("image/png"),e.dataurl},computeMeshBounding:function(e){for(var t=[e[0],e[1],e[2]],o=[e[0],e[1],e[2]],i=0;i<e.length;i+=3){var a=[e[i],e[i+1],e[i+2]];a[0]<t[0]?t[0]=a[0]:a[0]>o[0]&&(o[0]=a[0]),a[1]<t[1]?t[1]=a[1]:a[1]>o[1]&&(o[1]=a[1]),a[2]<t[2]?t[2]=a[2]:a[2]>o[2]&&(o[2]=a[2])}var n=[.5*(t[0]+o[0]),.5*(t[1]+o[1]),.5*(t[2]+o[2])],r=[t[0]-n[0],t[1]-n[1],t[2]-n[2]];return BBox.setCenterHalfsize(BBox.create(),n,r)}},TONG.Formats.addSupportedFormat("png,jpg,jpeg,webp,bmp,gif",{native:!0,dataType:"arraybuffer",resource:"Texture",resourceClass:TONG.Texture,has_preview:!0,type:"image"}),TONG.Formats.addSupportedFormat("wbin",{dataType:"arraybuffer"}),TONG.Formats.addSupportedFormat("json,js,txt,html,css,csv",{dataType:"text"}),TONG.Formats.addSupportedFormat("glsl",{dataType:"text",resource:"ShaderCode",resourceClass:TONG.BasicShader}),TONG.Formats.addSupportedFormat("zip",{dataType:"arraybuffer"}),TONG.Formats.addSupportedFormat("gcode,obj,awd,amf,assimp,babylon,blend,3ds,dae,drc,gltf,glb,ply,vtk,vtp,prwm,wrl,vrml,fbx,x,pcd,svg,stl",{dataType:"arraybuffer",resource:"MeshAsset",resourceClass:TONG.MeshAsset}),TONG.Formats.addSupportedFormat("anim",{dataType:"arraybuffer",resource:"AnimationAsset",resourceClass:TONG.AnimationAsset}),TONG.Formats.addSupportedFormat("mp3,wav,wma,msc",{dataType:"arraybuffer",resource:"AudioAsset",resourceClass:TONG.AudioAsset}),TONG.Formats.addSupportedFormat("mp4,ogv",{dataType:"arraybuffer",resource:"VideoAsset",resourceClass:TONG.VideoAsset}),TONG.Formats.addSupportedFormat("rpic",{dataType:"arraybuffer",resource:"RenderTexture",resourceClass:TONG.RenderTexture}),TONG.Formats.addSupportedFormat("fnt,font,ttf,otf,ttc,otc",{dataType:"arraybuffer",resource:"FontAsset",resourceClass:TONG.FontAsset});var ResourcesManager={path:"",proxy:"",ignore_cache:!1,free_data:!1,keep_files:!1,keep_urls:!1,allow_base_files:!1,scene_external_repository:null,ResourceClasses:{},resources:{},meshes:{},images:{},textures:{},fontAssets:{},meshAssets:{},skeletons:{},menus:{},firstConfigureTexture:!0,materials:{},geometries:{},animationClips:{},animations:{},shapes:{},materials_by_uid:{},resources_not_found:{},resources_being_loaded:{},resources_being_processed:{},resources_renamed_recently:{},num_resources_being_loaded:0,MAX_TEXTURE_SIZE:4096,resource_pre_callbacks:{},resource_post_callbacks:{},resource_once_callbacks:{},virtual_file_systems:{},skip_proxy_extensions:["mp3","wav","ogg"],force_nocache_extensions:["js","glsl","json"],nocache_files:{},valid_resource_name_reg:/^[A-Za-z\d\s\/\_\-\.]+$/,getNoCache:function(e){return this.ignore_cache||e?"nocache="+getTime()+Math.floor(1e3*Math.random()):""},reset:function(){this.resources={},this.meshes={},this.meshAssets={},this.textures={},this.materials={},this.geometries={},this.shapes={},this.materials_by_uid={},this.fontAssets={},this.skeletons={},this.scene_external_repository=null},getClassName:function(e){if(e){if(e.name)return e.name;if(e.toString){var t=e.toString().match(/function\s*(\w+)/);if(t&&2==t.length)return t[1]}}},registerResourceClass:function(e){var t=this.getClassName(e);(this.ResourceClasses[t]=e)instanceof Function?e.prototype.is_resource=!0:e.is_resource=!0},processImage:function(t,o,i,a){var e=TONG.ResourcesManager.getExtension(t),n="application/octet-stream";if("jpg"==e||"jpeg"==e)n="image/jpg";else if("webp"==e)n="image/webp";else if("gif"==e)n="image/gif";else if("png"==e)n="image/png";else{var r=TONG.Formats.supported[e];if(!r.mimetype)return void u(this.processImageNonNative(t,o,i));n=r.mimetype}this.mimetype=n;var s=null;if(-1==o.indexOf("data:")){var l=new Blob([o],{type:n});s=URL.createObjectURL(l)}else s=o;var c=new Image;function u(e){e&&TONG.ResourcesManager.keep_files&&(e._original_data=o),TONG.ResourcesManager.keep_urls?e._local_url=s:URL.revokeObjectURL(s),a&&a(t,e,i)}return c.src=s,c.real_filename=t,c.onload=function(){var e=this.real_filename;u(TONG.ResourcesManager.processTexture(e,this,i))},c.onerror=function(e){URL.revokeObjectURL(s),a&&a(t,null,i)},!0},serializeAllResource:function(o,e){function t(e,t){return t.uuid&&""!=t.uuid||(t.uuid=TONG.Math.generateUUID()),void 0===e[t.uuid]&&(e[t.uuid]=t.serialize(o)),t.uuid}function i(e){var t=[];for(var o in e){var i=e[o];delete i.metadata,t.push(i)}return t}var a=TONG.RM.resources;for(var n in a)switch(a[n].resource_type){case TONG.Resource.TYPE.Text:case TONG.Resource.TYPE.Json:t(o.files,a[n]);break;case TONG.Resource.TYPE.Script:t(o.scripts,a[n]);break;case TONG.Resource.TYPE.Texture:t(o.textures,a[n]);break;case TONG.Resource.TYPE.Material:t(o.materials,a[n]);break;case TONG.Resource.TYPE.Pack:t(o.packs,a[n]);break;case TONG.Resource.TYPE.ShaderCode:t(o.shaders,a[n]);break;case TONG.Resource.TYPE.Mesh:t(o.meshes,a[n]);break;case TONG.Resource.TYPE.Animation:t(o.animations,a[n]);break;case TONG.Resource.TYPE.Audio:t(o.audios,a[n]);break;case TONG.Resource.TYPE.Video:t(o.videos,a[n]);break;case TONG.Resource.TYPE.RenderTexture:t(o.rpics,a[n]);break;case TONG.Resource.TYPE.Font:t(o.fonts,a[n]);break;default:a[n]instanceof TONG.Material&&t(o.materials,a[n])}var r=i(o.files),s=i(o.scripts),l=i(o.textures),c=i(o.materials),u=i(o.packs),d=i(o.shaders),h=i(o.meshes),p=i(o.animations),m=i(o.audios),g=i(o.videos),f=i(o.rpics),v=i(o.fonts),y=i(o.geometries),T=i(o.images),O=i(o.shapes),N=i(o.components),G=i(o.skeletons);0<r.length&&(e.files=r),0<s.length&&(e.scripts=s),0<l.length&&(e.textures=l),0<c.length&&(e.materials=c),0<u.length&&(e.packs=u),0<d.length&&(e.shaders=d),0<h.length&&(e.meshes=h),0<p.length&&(e.animations=p),0<m.length&&(e.audios=m),0<g.length&&(e.videos=g),0<f.length&&(e.rpics=f),0<v.length&&(e.fonts=v),0<y.length&&(e.geometries=y),0<T.length&&(e.images=T),0<O.length&&(e.shapes=O),0<N.length&&(e.components=N),0<G.length&&(e.skeletons=G)},processImageNonNative:function(e,t,o){var i,a=new Uint8Array(t).buffer,n=TONG.Formats.parse(e,a,o);return n?n.constructor==TONG.Texture?((i=n).filename=e,i._original_data=a,i):i=TONG.ResourcesManager.processTexture(e,n):null},processTexture:function(e,t,o){var i=null;if(t.width==t.height/6||-1!=e.indexOf("CUBECROSS")){var a={wrapS:TONG.MirroredRepeatWrapping,wrapT:TONG.MirroredRepeatWrapping,magFilter:TONG.LinearFilter,minFilter:TONG.LinearMipMapLinearFilter};if(-1!=e.indexOf("CUBECROSSL")&&(a.is_cross=1),!(i=new TONG.CubeTexture(t,!1,a.wrapS,a.wrapT,a.magFilter,a.minFilter)))return}else{var n=TONG.LinearFilter,r=TONG.RepeatWrapping,s=TONG.LinearMipMapLinearFilter;isPowerOfTwo(t.width)&&isPowerOfTwo(t.height)||(s=TONG.LinearFilter,r=TONG.ClampToEdgeWrapping),i=new TONG.Texture(t,!1,r,r,n,s)}return i.filename=e,i},registerResourcePreProcessor:function(e,t,o,i){if(e){var a=e.split(",");for(var n in a){var r=a[n].toLowerCase();this.resource_pre_callbacks[r]=t}}},configureMaterial:function(e,t,o){var i=new MaterialLoader;i.setTextures(t);var a=i.parse(e);return a.name=a.filename=e.filename,a instanceof TONG.ShaderMaterial&&null!=e.shader&&(a.shader=e.shader),o||(a.resource_type=TONG.Resource.TYPE.Material,a.is_material=!0,a.fullpath=e.fullpath,TONG.RM.registerResource(e.fullpath,a),TONG.MaterialClasses.registerMaterialClass(a),TONG.RM.resourceModified(a)),a},configureTexture:function(e,t,o){if(this.firstConfigureTexture){this.firstConfigureTexture=!1,isEditor&&(EditorModule.target.resources.images=t.images);for(var i=0;i<t.images.length;i++){var a=new Image;a.src=t.images[i].url,a.uuid=t.images[i].uuid,isEditor&&EditorModule.target.addImage(a),this.addImage(a)}}var n=(new TONG.ObjectLoader).parseTextures([e],TONG.RM.images)[e.uuid];return n.filename=e.filename,n.fullpath=e.fullpath,o||(TONG.RM.registerResource(n.filename,n),n._preview_url=DriveModule.generatePreview(n.fullpath||n.filename)),n},getMenuBar:function(e){return this.menus[e]},addMenuBar:function(e,t){e="/"==e.substring(0,1)?"tong3d"+e:"tong3d/"+e;var o=EditorModule.mainmenu.add(e,t);if(this.menus[e]=o.current,t.rule){var i={};for(var a in o.current)i[a]=o.current[a];i.name="",arrayInsert(o.parent,o.position+1,i)}return this.menus[e]},getMenuNames:function(){var e=[];for(var t in this.menus)e.push(t);return e},removeMenuBar:function(e){return delete this.menus[e],this.menus},changeMenuBar:function(e,t){var o=this.menus[e];return void 0!==o&&(delete this.menus[e],this.menus[t]=o),this.menus},configureScript:function(e){var t=new TONG.Script;return t.uuid=e.uuid,t.title=t.filename=e.filename,t.fullpath=e.fullpath,t.setData(e.data),t.register(),TONG.Components.registerScriptComponent(t),t},configureRenderTexture:function(e){var t=new TONG.RenderTexture;return t.uuid=e.uuid,t.filename=e.filename,t.fullpath=e.fullpath,t.width=e.width,t.height=e.height,t.register(),t},configureShaderCode:function(e){var t=new TONG.ShaderCode;t.filename=e.filename,t.uuid=e.uuid;TONG.RM.removeExtension(e.filename);t.fullpath=e.fullpath,t.code=t.data=e.data,TONG.ResourcesManager.registerResource(t.fullpath||t.filename,t);for(var o=TONG.RM.getResourceByType(TONG.Resource.TYPE.Material),i=0;i<o.length;i++)if(o[i]instanceof TONG.ShaderMaterial&&o[i].editorTarget){var a=o[i].editorTarget.shader.getValue(),n=o[i].editorTarget.shader.addElement(t.filename);o[i].editorTarget.shaderWidget&&o[i].editorTarget.shaderWidget.setOptionValues(n,a)}return t},configureFiles:function(e){var t=new TONG.Resource;return t.filename=e.filename,t.resource_type=e.resource_type,t.fullpath=e.fullpath,t.data=e.data,t.register(),t},saveResourceStorage:function(e,t){if(isEditor){var o=t.serialize();!t.resource_type&&t instanceof TONG.Material&&(o=t.toJSON()),null==EditorModule.target.resources[e]&&(EditorModule.target.resources[e]=[]),EditorModule.target.resources[e].push(o)}},configureMeshes:function(e,t,o){var i=new MeshAsset,a=new ObjectLoader,n=this.geometries,r=this.materials,s=a.parseObject(e.data.object,n,r,t);return o.skeletons&&(this.skeletons=isEmptyObject(this.skeletons)?a.parseSkeletons(o.skeletons,s):this.skeletons,a.bindSkeletons(s,this.skeletons)),this.addMesh(s),i.setData(s),i.filename=e.filename,i.fullpath=e.fullpath,i.size=e.size,i.uuid=e.uuid,i.register(),i},configureAudios:function(e,t){var o=new TONG.AudioAsset,i=(new AudioLoader).parse(e);return o.uuid=i.uuid,o.fullpath=o.filename=e.filename,o.size=e.size,o.setData(i),o.register(),o},configureVideos:function(e,t){var o=new TONG.VideoAsset,i=(new VideoLoader).parse(e);return o.uuid=i.uuid,o.fullpath=o.filename=e.filename,o.size=e.size,o.setData(i),o.register(),o},configureFonts:function(e,t){var o=new TONG.FontAsset,i=new TONG.Font(e.data);return o.uuid=i.uuid=e.uuid,o.fullpath=o.filename=e.filename,o.size=e.size,o.setData(i),o.register(),o},configureResource:function(e,t,o){var i=null;if(null!=t.resource_type){if(t.resource_type==TONG.Resource.TYPE.Material)i=this.configureMaterial(t,this.textures);else if(t.resource_type==TONG.Resource.TYPE.Script)i=this.configureScript(t);else if(t.resource_type==TONG.Resource.TYPE.Texture)i=this.configureTexture(t,o);else if(t.resource_type==TONG.Resource.TYPE.RenderTexture)i=this.configureRenderTexture(t);else if(t.resource_type==TONG.Resource.TYPE.ShaderCode)i=this.configureShaderCode(t);else if(t.resource_type==TONG.Resource.TYPE.Pack);else if(t.resource_type==TONG.Resource.TYPE.Mesh)i=this.configureMeshes(t,this.textures,o);else if(t.resource_type==TONG.Resource.TYPE.Font)i=this.configureFonts(t);else if(t.resource_type==TONG.Resource.TYPE.Audio)i=this.configureAudios(t,o);else if(t.resource_type==TONG.Resource.TYPE.Video)i=this.configureVideos(t,o);else if(t.resource_type==TONG.Resource.TYPE.Animation){if(isEmptyObject(this.animationClips)){s=new ObjectLoader;for(var a in this.animationClips=s.parseAnimations(o.animations),this.animations)i=this.animations[a],isEditor&&i&&this.saveResourceStorage(e,i);i=null}}else i=this.configureFiles(t);isEditor&&i&&this.saveResourceStorage(e,i),DriveModule.refreshContent()}else if("textures"==e)(i=this.configureTexture(t,o,!0)).resource_type=void 0,isEditor&&EditorModule.target.addTexture(i),this.addTexture(i);else if("materials"==e)this.materials[t.uuid]||(i=this.configureMaterial(t,this.textures,!0),isEditor&&EditorModule.target.addMaterial(i),this.addMaterial(i));else if("geometries"==e){if(isEmptyObject(this.geometries)){var n=new ObjectLoader,r=n.parseShape(o.shapes);this.shapes=r,this.geometries=n.parseGeometries(o.geometries,r)}}else if("animations"==e&&isEmptyObject(this.animationClips)){var s=new ObjectLoader;for(var a in this.animationClips=s.parseAnimations(o.animations),this.animations)i=this.animations[a],isEditor&&i&&this.saveResourceStorage(e,i)}},updateShaderContent:function(e){var t=TONG.RM.getResourceByType(TONG.Resource.TYPE.Material),o=TONG.RM.getResource(e);if(o)for(var i=0;i<t.length;i++)t[i]instanceof TONG.ShaderMaterial&&t[i].editorTarget&&null!=t[i].editorTarget.shader&&t[i].editorTarget.shader.getValue()==e&&ReCompileShader(o,t[i].editorTarget,!0)},processFileAtlas:function(e,t){for(var o=e.split("\n"),i={},a=[],n="",r=0,s=o.length;r<s;r++){var l=t?o[r]:o[r].trim();l.length&&("\\"==l[0]?(a.length&&(i[n]=a.join("\n")),a.length=0,n=l.substr(1)):a.push(l))}return a.length&&(i[n]=a.join("\n")),i},registerResourcePostProcessor:function(e,t){this.resource_post_callbacks[e]=t},getExtension:function(e,t){if(!e)return"";var o=e.indexOf("?");-1!=o&&(e=e.substr(0,o));var i=t?e.indexOf("."):e.lastIndexOf(".");return-1==i?"":e.substr(i+1).toLowerCase().trim()},removeExtension:function(e,t){if(!e)return"";var o=e.indexOf("?");-1!=o&&(e=e.substr(0,o));var i=t?e.indexOf("."):e.lastIndexOf(".");return-1==i?e:e.substr(0,i)},getFilename:function(e){if(!e)return"";var t=e.lastIndexOf("/"),o=e.lastIndexOf("?");return o=(-1==o?e.length:o-1)-t,e.substr(t+1,o)},getFolder:function(e){if(!e)return"";var t=e.lastIndexOf("/");return e.substr(0,t)},getBasename:function(e){if(!e)return"";var t=this.getFilename(e),o=t.indexOf(".");return-1==o?t:t.substr(0,o)},getProtocol:function(e){if(!e)return"";var t=e.substr(0,10).indexOf(":"),o="";return-1!=t&&(o=e.substr(0,t)),o},cleanFullpath:function(e){return e?-1==e.indexOf("//")?47==e.charCodeAt(0)?e.substr(1):e:-1==e.indexOf("://")?e.split("/").filter(function(e){return!!e}).join("/"):e:""},loadResources:function(e,t){if(e){for(var o in e)o&&":"!=o[0]&&"_"!=o[0]&&this.load(o,t);return this._total_resources_to_load=this.num_resources_being_loaded,TONG.trigger(this,"start_loading_resources",this._total_resources_to_load),this._total_resources_to_load||TONG.trigger(this,"end_loading_resources"),this._total_resources_to_load}},setPath:function(e){this.path=e},setProxy:function(e){e?-1!=e.indexOf("@")?this.proxy="http://"+e.replace("@",window.location.host):this.proxy=e:this.proxy=null},getFullURL:function(e,t){if(!e)return null;var o=e.substr(0,10).indexOf(":"),i="";-1!=o&&(i=e.substr(0,o));var a=this.path;if(this.scene_external_repository&&(a=this.scene_external_repository),t&&t.force_local_url&&(a="."),t&&t.external_repository&&(a=t.external_repository),!i)return a+"/"+e;switch(i){case"http":case"https":var n=e,r=this.getExtension(e).toLowerCase();return this.proxy&&-1==this.skip_proxy_extensions.indexOf(r)&&(!t||t&&!t.ignore_proxy)?this.proxy+e:n;case"blob":case"":return e;default:return":"==e[0]||"_"==e[0]?e:(this.virtual_file_systems[i]||a)+"/"+e.substr(o+1)}},registerFileSystem:function(e,t){this.virtual_file_systems[e]=t},getResource:function(e,t){if(!e)return null;if(e=this.cleanFullpath(e),!t)return this.resources[e];var o=this.resources[e];return o&&o.constructor===t?o:null},getResourceType:function(e){return e?e.object_class?e.object_class:e.constructor.resource_type?e.constructor.resource_type:e.resource_type?e.resource_type:e.type:null},getResourceByType:function(e){var t=[];for(var o in this.resources)this.resources[o].resource_type==e&&t.push(this.resources[o]);return t},getResourceByUUID:function(e){for(var t in this.resources)if(this.resources[t].uuid==e)return this.resources[t];return null},getTextureByUUID:function(e){for(var t in this.textures)if(t==e)return this.textures[t];return null},getResourcesData:function(e,t){for(var o={},i=0;i<e.length;++i){var a=e[i],n=TONG.ResourcesManager.resources[a];if(n){var r=null;if(n._original_data)r=n._original_data;else r=TONG.Resource.getDataToStore(n).data;if(r){if(r.constructor===Blob||r.constructor===File){if(!(t||r.data&&r.data.constructor===ArrayBuffer))continue;r=r.data}o[a]=r}}}return o},resourceModified:function(e){if(e&&e.constructor!==String){if(delete e._original_data,delete e._original_file,e.remotepath&&(e._modified=!0),TONG.Event.trigger(this,"resource_modified",e),e.from_pack&&e.from_pack.constructor===String){var t=TONG.ResourcesManager.getResource(e.from_pack);t&&this.resourceModified(t)}if(e.from_prefab&&e.from_prefab.constructor===String){var o=TONG.ResourcesManager.getResource(e.from_prefab);o&&this.resourceModified(o)}}},resourceSaved:function(e){e&&(delete e._modified,e.remotepath=e.fullpath,TONG.Event.trigger(this,"resource_saved",e))},load:function(o,t,e,i,a){if(o){t&&t.constructor===Function&&!e&&(e=t,t=null);var n=this.resources[o];if(!(null==n||n.is_preview||t&&t.force||i))return e&&e(n,o),!0;t=t||{};var r=this.getExtension(o);if(!r&&!this.resources[o])return!1;if(!this.resources_not_found[o])if(this.resources_being_loaded[o])this.resources_being_loaded[o].push({options:t,callback:e});else if(!this.resources_being_processed[o]){if(this.allow_base_files||-1!=o.indexOf("/")){this.resources_being_loaded[o]=[{options:t,callback:e}],TONG.Event.trigger(TONG.ResourcesManager,"resource_loading",o),this.num_resources_being_loaded++;var s=this.getFullURL(o);(l=TONG.Formats.getFileFormatInfo(r))&&l.has_preview&&!t.is_preview&&TONG.Event.trigger(this,"load_resource_preview",o);var l,c={url:s,success:function(e){TONG.ResourcesManager.processResource(o,e,t,TONG.ResourcesManager._resourceLoadedEnd,!0)},error:function(e){TONG.ResourcesManager._resourceLoadedError(o,e),a&&a(o)},progress:function(e){var t=0;e.total&&(t=e.loaded/e.total),TONG.Event.hasBind(TONG.ResourcesManager,"resource_loading_progress")&&TONG.Event.trigger(TONG.ResourcesManager,"resource_loading_progress",{url:o,event:e,progress:t}),TONG.Event.hasBind(TONG.ResourcesManager,"loading_resources_progress")&&TONG.Event.trigger(TONG.ResourcesManager,"loading_resources_progress",1-(TONG.ResourcesManager.num_resources_being_loaded-t)/TONG.ResourcesManager._total_resources_to_load)}};return c.nocache=this.ignore_cache||this.force_nocache_extensions[r]||this.nocache_files[o],(l=TONG.Formats.supported[r])&&l.dataType&&(c.dataType=l.dataType),TONG.Network.request(c),!1}this._parsing_local_file}}},processDataResource:function(e,t,o,i){if(t.constructor===String&&(t=JSON.parse(t)),t.constructor==ArrayBuffer)return n=WBin.load(t),i&&i(e,n,o),n;var a=t.object_class;if(a&&LS.Classes[a]){var n=null;return LS.Classes[a].prototype.configure?(n=new LS.Classes[a]).configure(t):n=new LS.Classes[a](t),i&&i(e,n,o),n}return!1},processResource:function(e,i,t,a,n){if((t=t||{})&&t.constructor!==Object)throw"processResource options must be object";if(null==i)throw"No data found when processing resource: "+e;var o=null,r=this.getExtension(e),s=null;r&&(s=TONG.Formats.supported[r]);var l=function(e,t,o){t?(s&&s.convert_to&&r!=s.convert_to&&(e+="."+s.convert_to,t.filename+="."+s.convert_to,t.fullpath&&(t.fullpath+="."+s.convert_to),o.filename&&(o.filename+="."+s.convert_to)),TONG.ResourcesManager.processFinalResource(e,t,o,a,n),t.size=o.size,!TONG.ResourcesManager.keep_files||i.constructor!=ArrayBuffer&&i.constructor!=String||t._original_data||t._original_file||(t._original_data=i)):TONG.ResourcesManager._resourceLoadedEnd(e,null)};if(this.resources_being_processed[e]=!0,!r)return this.processDataResource(e,i,t,l);var c=this.resource_pre_callbacks[r.toLowerCase()];if(c){if(!0===(o=c(e,i,t,l)))return;if(!o)return void this._resourceLoadedError(e,"Resource couldn't be processed");l(e,o,t)}else if(s&&(s.type||s.parse)){o=null;switch(s.type){case"scene":o=TONG.ResourcesManager.processScene(e,i,t,l);break;case"mesh":o=TONG.ResourcesManager.processTextMesh(e,i,t,l);break;case"texture":case"image":o=TONG.ResourcesManager.processImage(e,i,t,l);break;case"data":default:if(s.parse)(o=s.parse(i))&&l(e,o,t)}o&&!0!==o&&l(e,o,t)}else{o=null;if(s&&s.resourceClass)o=new s.resourceClass;else{var u=this.resources[e];u&&u.constructor===TONG.Resource?(delete(o=u)._original_data,delete o._original_file,o._modified=!1):o=new TONG.Resource}if(!o.setData)throw"Resource without setData, cannot assign";o.setData(i.data,!0),o&&(o.filename=o.fullpath=e,o.size=t.size,l(e,o,t))}},processFinalResource:function(e,t,o,i,a){if(!t||t.constructor===String)return TONG.ResourcesManager._resourceLoadedError(e,"error processing the resource");t.filename=e,o.filename&&(t.filename=o.filename),o.is_local?e=t.fullpath=t.filename:t.fullpath=e,o.from_prefab&&(t.from_prefab=o.from_prefab),o.from_pack&&(t.from_pack=o.from_pack),a&&(t.remotepath=e),o.is_preview&&(t.is_preview=!0),TONG.ResourcesManager.resources_being_processed[e]&&delete TONG.ResourcesManager.resources_being_processed[e],t.getResources&&ResourcesManager.loadResources(t.getResources({})),TONG.ResourcesManager.registerResource(e,t),o.preview_of&&TONG.ResourcesManager.registerResource(o.preview_of,t),i&&i(e,t,o)},registerResource:function(e,t){if(!e||!t)throw"registerResource missing filename or resource";if(":"!=e[0]&&this.valid_resource_name_reg.test(e),e=this.cleanFullpath(e),!(this.resources[e]===t||t.is_preview&&this.resources[e])){t.filename=e,t.object_class||(t.object_class=t);var o=t.object_class;t.constructor.resource_type&&(o=t.constructor.resource_type),null!=(this.resources[e]=t).uuid&&""!=t.uuid||(t.uuid=TONG.Math.generateUUID()),t instanceof TONG.Texture?this.addTexture(t):t instanceof TONG.Material?this.addMaterial(t):t instanceof Image?this.addImage(t):t instanceof TONG.AnimationAsset?this.addAnimation(t):t instanceof TONG.RenderTexture?this.addTexture(t):t instanceof TONG.FontAsset?this.addFontAssets(t):t instanceof TONG.MeshAsset&&(t.data&&t.data.skeleton&&this.addSkeleton(t.data.skeleton),this.addMeshAssets(t),this.addMesh(t.data));var i=this.resource_post_callbacks[o];i&&i(e,t),t.is_preview||TONG.Event.trigger(this,"resource_registered",t)}},unregisterResource:function(e){var t=this.resources[e];return!!t&&(delete this.resources[e],this.meshAssets[t.uuid]&&delete this.meshAssets[t.uuid],this.textures[t.uuid]&&delete this.textures[t.uuid],this.materials[t.uuid]&&delete this.materials[t.uuid],t.constructor!==TONG.Pack&&t.constructor!==TONG.Prefab||t.setResourcesLink(null),TONG.Event.trigger(this,"resource_unregistered",t),!0)},getURLasFile:function(o,i){var a=new XMLHttpRequest;a.open("GET",this.getFullURL(o),!0),a.responseType="blob",a.onload=function(e){var t=a.response;i&&i(t,o)},a.send()},renameResource:function(e,t,o){var i=this.resources[e];if(!i)return!1;for(var a in this.resources[t],i.filename=t,i.fullpath&&(i.fullpath=t),this.resources[t]=i,delete this.resources[e],o||EditorModule.target.scene.sendResourceRenamedEvent(e,t,i),this.resources){var n=this.resources[a];n!=i&&n.OnResourceRenamed&&n.OnResourceRenamed(e,t,i)}return this.meshAssets[i.uuid]&&(delete this.meshAssets[i.uuid],this.meshAssets[i.uuid]=i),this.textures[i.uuid]&&(delete this.textures[i.uuid],this.textures[i.uuid]=i),this.materials[i.uuid]&&(delete this.materials[i.uuid],this.materials[i.uuid]=i),this.resources_renamed_recently[e]=t,o||TONG.Event.trigger(TONG.ResourcesManager,"resource_renamed",[e,t,i]),!0},isLoading:function(e){return e?!(!this.resources_being_loaded[e]&&!this.resources_being_processed[e]):0<this.num_resources_being_loaded},clearNotFoundResources:function(){this.resources_not_found={}},computeImageMetadata:function(e){return{width:e.width,height:e.height}},getTexture:function(e){return e?e.constructor===String?this.textures[e]:e.constructor===TONG.Texture?e:null:null},addTexture:function(e){this.textures[e.uuid]=e},getSkeleton:function(e){return this.skeletons[e]},addSkeleton:function(e){this.skeletons[e.uuid]=e},addFontAssets:function(e){this.fontAssets[e.uuid]=e},addAnimClip:function(e){this.animationClips[e.uuid]=e},addAnimation:function(e){this.animations[e.uuid]=e},getAnimations:function(){return this.animations},getAnimClips:function(){return this.animationClips},addMesh:function(e){this.meshes[e.uuid]=e},getMesh:function(e){return this.meshes[e]},addMeshAssets:function(e){this.meshAssets[e.uuid]=e},getMeshAssets:function(e){return this.meshAssets[e]},addMaterial:function(e){this.materials[e.uuid]=e},addGeometry:function(e){this.geometries[e.uuid]=e},addShape:function(e){this.shapes[e.uuid]=e},addImage:function(e){this.images[e.uuid]=e},getMaterial:function(e){if(e)return"@"==e[0]?this.materials_by_uid[e]:this.materials[e]},onceLoaded:function(e,t){var o=this.resource_once_callbacks[e];if(o){if(-1==o.indexOf(t))return o.push(t),o.length-1}else this.resource_once_callbacks[e]=[t]},cancelOnceLoaded:function(e,t){var o=this.resource_once_callbacks[e];o&&(o[t]=null)},_resourceLoadedEnd:function(e,t){if(TONG.ResourcesManager.debug,t){var o;if(o=TONG.ResourcesManager.resources_being_loaded[e])for(var i=0;i<o.length;++i)null!=o[i].callback&&o[i].callback(t,e);if(o=TONG.ResourcesManager.resource_once_callbacks[e]){for(i=0;i<o.length;++i)o[i]&&o[i](e,t);delete TONG.ResourcesManager.resource_once_callbacks[e]}}TONG.ResourcesManager.resources_being_loaded[e]&&(delete TONG.ResourcesManager.resources_being_loaded[e],TONG.ResourcesManager.num_resources_being_loaded--,t?TONG.Event.trigger(TONG.ResourcesManager,"resource_loaded",e):TONG.Event.trigger(TONG.ResourcesManager,"resource_problem_loading",e),TONG.Event.trigger(TONG.ResourcesManager,"loading_resources_progress",1-TONG.ResourcesManager.num_resources_being_loaded/TONG.ResourcesManager._total_resources_to_load),0==TONG.ResourcesManager.num_resources_being_loaded&&(TONG.Event.trigger(TONG.ResourcesManager,"end_loading_resources",!0),TONG.ResourcesManager._total_resources_to_load=0))},_resourceLoadedError:function(e,t){delete TONG.ResourcesManager.resources_being_loaded[e],delete TONG.ResourcesManager.resource_once_callbacks[e],TONG.ResourcesManager.resources_not_found[e]=!0,TONG.Event.trigger(TONG.ResourcesManager,"resource_not_found",e),TONG.ResourcesManager.num_resources_being_loaded--,0==TONG.ResourcesManager.num_resources_being_loaded&&TONG.Event.trigger(TONG.ResourcesManager,"end_loading_resources",!1)},showSelectResource:function(o){var i=new LiteGUI.Dialog({id:"select-resource-dialog",title:"Select resource",close:!0,width:800,height:500,scroll:!1,resizable:!0,draggable:!0}),e=new ResourcesPanelWidget(o,{skip_actions:!0});return o.type&&e.filterByCategory(o.type),e.showMemoryResources(),LiteGUI.bind(e,"resource_selected",function(e){var t=e.detail;o.allow_multiple&&e&&e.shiftKey||i.close();o.on_complete&&o.on_complete(t);t&&!o.skip_load&&TONG.ResourcesManager.load(t,null,o.on_load);return!0}),document.body.appendChild(i.root),i.add(e),i.show(),i.center(),i}};function FileNameHelper(){}TONG.RM=TONG.ResourcesManager=ResourcesManager,FileNameHelper.GetNextFileName=function(e){for(var t=e,o="."+TONG.RM.getExtension(e);TONG.RM.getResource(t);){var i=TONG.RM.removeExtension(t),a=FileNameHelper.GetBaseAndCount(i),n=a.count;t=(i=a.name)+"_"+ ++n+o}return t},FileNameHelper.GetWholeName=function(e,t){for(var o=t;e[o];){var i=o,a=FileNameHelper.GetBaseAndCount(i),n=a.count;o=(i=a.name)+"_"+ ++n}return o},FileNameHelper.GetBaseAndCount=function(e){var t,o=0,i=e;if(""!=(t=e).trim()&&null!=t&&null!=t){var a=e.lastIndexOf("_");if(0<=a){var n=e.length;o=parseInt(e.substring(a+1,n)),i=e.substring(0,a)}}return{name:i,count:o}},Resource.icons={Texture:"imgs/mini-icon-texture.png",Sampler:"imgs/mini-icon-texture.png",Mesh:"imgs/mini-icon-meshres.png",MeshAsset:"imgs/mini-icon-meshres.png",Node:"imgs/mini-icon-node.png",node:"imgs/mini-icon-node.png",Component:"imgs/mini-icon-component.png",component:"imgs/mini-icon-component.png",Material:"imgs/mini-icon-materialres.png",material:"imgs/mini-icon-materialres.png",Script:"imgs/mini-icon-js.png",AnimationAsset:"imgs/animat.png",AudioAsset:"imgs/music.png",VideoAsset:"imgs/video.png",RenderTexture:"imgs/renderPic.png",FontAsset:"imgs/misc/font_mini.png"},Resource.panel={},Resource.panel.icons={Texture:"imgs/misc/images/tong/图片.png",Sampler:"imgs/misc/images/tong/图片.png",Mesh:"imgs/misc/images/tong/模型.png",MeshAsset:"imgs/misc/images/tong/模型.png",Node:"imgs/misc/images/tong/模型.png",node:"imgs/misc/images/tong/模型.png",Component:"imgs/misc/images/tong/组件.png",component:"imgs/misc/images/tong/组件.png",Material:"imgs/misc/images/tong/着色器.png",material:"imgs/misc/images/tong/着色器.png",Script:"imgs/misc/images/tong/脚本.png",AnimationAsset:"imgs/misc/images/tong/动画.png",Text:"imgs/misc/images/tong/文本.png",Json:"imgs/misc/images/tong/json文件.png",Pack:"imgs/misc/images/tong/包文件.png",ShaderCode:"imgs/misc/images/tong/glsl.png",VideoAsset:"imgs/misc/images/tong/视频.png",AudioAsset:"imgs/misc/images/tong/音频.png",RenderTexture:"imgs/misc/images/tong/renderTexture.png",FontAsset:"imgs/misc/font.png"},TONG.TYPES={BOOLEAN:"boolean",NUMBER:"number",STRING:"string",VEC2:"vec2",VEC3:"vec3",VEC4:"vec3",COLOR:"color",COLOR4:"color4",RESOURCE:"resource",TEXTURE:"texture",MESH:"mesh",OBJECT:"object",SCENE:"scene",SCENENODE:"node",SCENENODE_ID:"node_id",COMPONENT:"component",COMPONENT_ID:"component_id",MATERIAL:"material",ANIMATION:"animation",ARRAY:"array"},TONG.Resource.TYPE={Default:"",Script:"Script",ShaderCode:"ShaderCode",Texture:"Texture",Mesh:"MeshAsset",Object:"Object",Scene:"Scene",Material:"Material",Animation:"AnimationAsset",Text:"Text",Json:"Json",Pack:"Pack",Font:"FontAsset",Component:"Component",Audio:"AudioAsset",Video:"VideoAsset",RenderTexture:"RenderTexture"},TONG.Resource.prototype.assignToScene=function(e,t){t=void 0===t?null:t},TONG.Resource.prototype.filename=null,TONG.Resource.prototype.fullpath=null,TONG.Resource.prototype.remotepath=null,TONG.Resource.prototype.resource_type=TONG.Resource.TYPE.Resource,TONG.Resource.prototype._data=null,TONG.Resource.prototype.size=null,TONG.Resource.prototype.is_resource=!0,TONG.Resource.prototype.mimetype="",TONG.Resource.prototype.editorTarget=null,TONG.Resource.prototype.onDblclick=function(){},TONG.Resource.prototype.callEditorTarget=function(){return this.editorTarget||(this.editorTarget=new EditorResource(this)),this.editorTarget},TONG.Texture.prototype.editorTarget=null,TONG.Texture.prototype.callEditorTarget=function(){return this.editorTarget||(this.editorTarget=new EditorResource(this)),this.editorTarget},TONG.Texture.prototype.resource_type=TONG.Resource.TYPE.Texture,TONG.Texture.prototype.serialize=function(e){var t=this.toJSON(e);return t.filename=this.filename,t.fullpath=this.fullpath,t.resource_type=this.resource_type,t.size=this.size,t},TONG.Texture.prototype.clone=function(){var e=(new this.constructor).copy(this),t=FileNameHelper.GetNextFileName(e.name);return e.editorTarget=null,e.fullpath=e.filename=e.name=t,e},TONG.Texture.prototype.texture="",TONG.RM.registerResourceClass(TONG.Resource),TONG.RM.registerResourceClass(TONG.Texture);var MeshInfo=function(e){EditorResource.call(this,e),this.icon="css/pic/inspector/model.png",this.title=GetLanguage("MeshInfo"),this.target=e};TONG.MeshInfo=MeshInfo,TONG.MeshInfo.prototype=Object.create(EditorResource.prototype),TONG.MeshInfo.prototype.constructor=TONG.MeshInfo,extendClass(TONG.MeshAsset,TONG.Resource),TONG.MeshAsset.prototype.resource_type=TONG.Resource.TYPE.Mesh,TONG.MeshAsset.prototype.assignToNode=function(e){var t=null;this._data.animations?(t=TONG.AnimationUtils.clone(this._data)).addComponent(Animation):t=this._data.clone(),EditorModule.target.execute(new DropModelCommand(t,e))},TONG.MeshAsset.prototype.assignToScene=function(e){var t=null;this._data.animations?(t=TONG.AnimationUtils.clone(this._data)).addComponent(Animation):t=this._data.clone(),t.position.copy(e),EditorModule.target.execute(new DropModelCommand(t,EditorModule.target.scene))},TONG.RM.registerResourceClass(TONG.MeshAsset),TONG.Component.addExtraMethods(TONG.MeshInfo),TONG.MeshAsset.prototype.editorTarget=null,TONG.MeshAsset.prototype.callEditorTarget=function(){return this.editorTarget||(this.editorTarget=new MeshInfo(this)),this.editorTarget},TONG.MeshAsset.prototype.serialize=function(e){null==this.uuid&&(this.uuid=TONG.Math.generateUUID());var t=this._data.toJSON(e);return{uuid:this.uuid,size:this.size,filename:this.filename,fullpath:this.fullpath,resource_type:TONG.Resource.TYPE.Mesh,data:t}},TONG.MeshAsset.prototype.clone=function(){var e=new TONG.MeshAsset,t=FileNameHelper.GetNextFileName(this.filename);return e.filename=e.fullpath=t,e.setData(this.getData()),e.size=this.size,e.resource_type=TONG.Resource.TYPE.Mesh,e.uuid=TONG.Math.generateUUID(),e};var CameraTexture=function(e){EditorResource.call(this,e),this.icon="imgs/components/rpic.png",this.title=GetLanguage("RenderTexture"),this.target=e,this.width=new TONG.Value({value:e.width,alias:GetLanguage("width")}),this.height=new TONG.Value({value:e.height,alias:GetLanguage("height")})};TONG.CameraTexture=CameraTexture,TONG.CameraTexture.prototype=Object.create(EditorResource.prototype),TONG.CameraTexture.prototype.constructor=TONG.CameraTexture,TONG.Component.addExtraMethods(TONG.CameraTexture),extendClass(TONG.RenderTexture,TONG.Resource),TONG.RenderTexture.prototype.resource_type=TONG.Resource.TYPE.RenderTexture,TONG.RenderTexture.prototype.serialize=function(e){this.uuid||(this.uuid=TONG.Math.generateUUID());var t={};return t.uuid=this.uuid,t.width=this.width?this.width:512,t.height=this.height?this.height:512,t.filename=this.filename,t.fullpath=this.fullpath,t.resource_type=TONG.Resource.TYPE.RenderTexture,t},TONG.RenderTexture.prototype.clone=function(){var e=new TONG.RenderTexture,t=FileNameHelper.GetNextFileName(this.filename);return e.uuid=TONG.Math.generateUUID(),e.copy(this),e.fullpath=e.filename=e.name=t,e.register(),e},TONG.RM.registerResourceClass(TONG.RenderTexture),TONG.RenderTexture.prototype.editorTarget=null,TONG.RenderTexture.prototype.callEditorTarget=function(){return this.editorTarget||(this.editorTarget=new CameraTexture(this)),this.editorTarget};var AudioInfo=function(e){EditorResource.call(this,e),this.icon="css/pic/inspector/audio.png",this.title=GetLanguage("AudioInfo"),this.target=e};TONG.AudioInfo=AudioInfo,TONG.AudioInfo.prototype=Object.create(EditorResource.prototype),TONG.AudioInfo.prototype.constructor=TONG.AudioInfo,TONG.Component.addExtraMethods(TONG.AudioInfo),extendClass(TONG.AudioAsset,TONG.Resource),TONG.AudioAsset.prototype.resource_type=TONG.Resource.TYPE.Audio,TONG.AudioAsset.prototype.serialize=function(e){var t=this._data.toJSON(e);return this.uuid=t.uuid=this.getData().uuid,t.filename=this.filename,t.fullpath=this.fullpath,t.size=this.size,t.resource_type=TONG.Resource.TYPE.Audio,t},TONG.AudioAsset.prototype.onDblclick=function(){},TONG.AudioAsset.prototype.clone=function(){var e=new TONG.AudioAsset,t=FileNameHelper.GetNextFileName(this.filename),o=null;return o=this.getData()?new Audio(this.getData().data):new Audio,e.setData(o),e.uuid=o.uuid,e.size=this.size,e.fullpath=e.filename=e.name=t,e.register(),e},TONG.RM.registerResourceClass(TONG.AudioAsset),TONG.AudioAsset.prototype.editorTarget=null,TONG.AudioAsset.prototype.callEditorTarget=function(){return this.editorTarget||(this.editorTarget=new AudioInfo(this)),this.editorTarget};var VideoInfo=function(e){EditorResource.call(this,e),this.icon="css/pic/inspector/video.png",this.title=GetLanguage("VideoInfo"),this.target=e};TONG.VideoInfo=VideoInfo,TONG.VideoInfo.prototype=Object.create(EditorResource.prototype),TONG.VideoInfo.prototype.constructor=TONG.VideoInfo,TONG.Component.addExtraMethods(TONG.VideoInfo),extendClass(TONG.VideoAsset,TONG.Resource),TONG.VideoAsset.prototype.resource_type=TONG.Resource.TYPE.Video,TONG.VideoAsset.prototype.serialize=function(e){var t=this._data.toJSON(e);return this.uuid=t.uuid=this.getData().uuid,t.filename=this.filename,t.fullpath=this.fullpath,t.size=this.size,t.resource_type=TONG.Resource.TYPE.Video,t},TONG.VideoAsset.prototype.onDblclick=function(){},TONG.VideoAsset.prototype.clone=function(){var e=new TONG.VideoAsset,t=FileNameHelper.GetNextFileName(this.filename),o=null;return o=this.getData()?new Video(this.getData().arraybuffer,this.getData().encoding):new Video,e.setData(o),e.uuid=o.uuid,e.size=this.size,e.fullpath=e.filename=e.name=t,e.register(),e},TONG.RM.registerResourceClass(TONG.VideoAsset),TONG.VideoAsset.prototype.editorTarget=null,TONG.VideoAsset.prototype.callEditorTarget=function(){return this.editorTarget||(this.editorTarget=new VideoInfo(this)),this.editorTarget},extendClass(TONG.AnimationAsset,TONG.Resource),TONG.AnimationAsset.prototype.resource_type=TONG.Resource.TYPE.Animation,TONG.AnimationAsset.prototype.serialize=function(e){var t=TONG.AnimationClip.toJSON(this.getData());return this.uuid=t.uuid,t.filename=this.filename,t.fullpath=this.fullpath,t.resource_type=TONG.Resource.TYPE.Animation,t},TONG.AnimationAsset.prototype.onDblclick=function(){AnimationModule.showTimeline(this)},TONG.AnimationAsset.prototype.clone=function(){var e=new TONG.AnimationAsset,t=FileNameHelper.GetNextFileName(this.filename),o=new TONG.AnimationClip(t,this.getData().duration,this.getData().tracks.concat());return e.setData(o),e.uuid=o.uuid,e.fullpath=e.filename=e.name=t,e.register(),e},TONG.RM.registerResourceClass(TONG.AnimationAsset);var FontInfo=function(e){EditorResource.call(this,e),this.icon="css/pic/inspector/font.png",this.title=GetLanguage("FontInfo"),this.target=e};function addGenericResource(t,o,i,a){i=i||{},o=o||"";var n=this;a=a||i.resource_classname;var r=null,e=null,s=null;if(o instanceof TONG.Texture||o instanceof TONG.RenderTexture&&o.isApplyTexture)e=r=o,o=o.name,!0;else if(o instanceof TONG.Material){var l=TONG.RM.getResource(o.name);s=o.type,l&&(s=o.name),e=o,i.placeHolder="None (Material)","NoneMaterial"==s||"Material"==s?(o="","Material"==s&&(e=new TONG.NoneMaterial)):o=s+" (Material)"}else if(o instanceof TONG.Script){l=TONG.RM.getResource(o.filename);s=o.filename,e=o,o=s}else if(o instanceof TONG.Object3D){s=o.type,e=o;var c=EditorModule.target.scene.getObjectByProperty("uuid",o.uuid,!0),u="None";i.placeHolder=u+" ("+s+")",c?(u=o.name,o=u+" ("+s+")"):o=""}else if(o instanceof TONG.Resource||o instanceof TONG.MeshAsset||o instanceof TONG.AnimationAsset||o instanceof TONG.AudioAsset||o instanceof TONG.VideoAsset||o instanceof TONG.RenderTexture||o instanceof TONG.FontAsset){l=TONG.RM.getResource(o.filename);e=o,i.placeHolder="None ("+o.resource_type+")",l?(s=o.filename,o=s+" ("+o.resource_type+")"):o=""}else o.constructor!==String&&(o="@Object");this.values[t]=o;var d=this.createWidget(t,"<span class='inputfield button'><input type='text' tabIndex='"+this.tab_index+"' class='text string' value='"+o+"' "+(i.disabled?"disabled":"")+"/></span><button title='show folders' class='micro'>"+(i.button||LiteGUI.special_codes.open_folder)+"</button>",i),h=((d.resource=e).widget=d).querySelector(".wcontent input");e||(h.style.color="#F43"),i.align&&"right"==i.align&&(h.style.direction="rtl"),i.placeHolder?h.setAttribute("placeHolder",i.placeHolder):a&&h.setAttribute("placeHolder",a);var p=function(e){e=e;if(d.resource instanceof TONG.Material)e=d.resource;else if(d.resource instanceof TONG.Texture||d.resource instanceof TONG.RenderTexture&&d.resource.isApplyTexture){if(d.resource instanceof TONG.RenderTexture)(r=d.resource).name=r.filename=r.fullpath=d.resource.filename;else if(""!=e)r instanceof TONG.RenderTexture&&(r=new TONG.Texture),r.isTexture=!0,r.copy(d.resource),r.needsUpdate=!0,r.name=r.filename=r.fullpath=d.resource.filename;else if(r instanceof TONG.RenderTexture)(r=new TONG.Texture).isTexture=!1,r.name=r.filename=r.fullpath="";else{if(!r.image)return;r.image=null,r.isTexture=!1,r.name=r.filename=r.fullpath=""}d.resource=e=r}else d.resource instanceof TONG.Object3D?e=d.resource:(d.resource instanceof TONG.MeshAsset||d.resource instanceof TONG.AnimationAsset||d.resource instanceof TONG.AudioAsset||d.resource instanceof TONG.VideoAsset||d.resource instanceof TONG.RenderTexture||d.resource instanceof TONG.FontAsset)&&(e=d.resource);e.widget=d,LiteGUI.Inspector.onWidgetChange.call(n,d,t,e,i)};function m(e){h.value=o=e,p(h.value)}function g(e){i.callback_load&&i.callback_load.call(d,e)}return d.setIcon=function(e){e?(h.style.background="transparent url('"+e+"') no-repeat left 4px center",h.style.paddingLeft="1.7em"):(h.style.background="",h.style.paddingLeft="")},i.icon?d.setIcon(i.icon):Resource.icons[a]&&d.setIcon(Resource.icons[a]),d.querySelector(".wcontent button").addEventListener("click",function(e){switch(a){case TONG.Resource.TYPE.Material:EditorModule.showAddMaterialToNode(EditorModule.target.selected,function(e){if("Material"!=d.resource.type&&"NoneMaterial"!=d.resource.type||"NoneMaterial"!=e.type){(d.resource=e).widget=d;var t=getMaterialName(e);m(t=t?t+" (Material)":"")}},!0);break;case TONG.Resource.TYPE.Script:EditorModule.showAddResourceToNode(null,function(e){m((d.resource=e)?e.title:"")},TONG.Resource.TYPE.Script);break;case TONG.Resource.TYPE.RenderTexture:EditorModule.showAddResourceToNode(null,function(e){e?d.resource=e:(d.resource=new TONG.RenderTexture,d.resource.uuid=!1);var t=e?e.filename:"";m(t=""!=t?t+" (RenderTexture)":"")},TONG.Resource.TYPE.RenderTexture);break;case TONG.Resource.TYPE.Font:EditorModule.showAddResourceToNode(null,function(e){e?d.resource=e:(d.resource=new TONG.FontAsset,d.resource.setData(Settings.defaultFont),d.resource.uuid=!1);var t=e?e.filename:"";m(t=""!=t?t+" (FontAsset)":"")},TONG.Resource.TYPE.Font);break;case TONG.Resource.TYPE.Texture:EditorModule.showAddResourceToNode(null,function(e){e&&(d.resource=e),e instanceof TONG.RenderTexture&&(d.resource.isApplyTexture=!0),m(e?e.filename:"")},[TONG.Resource.TYPE.Texture,TONG.Resource.TYPE.RenderTexture]);break;case TONG.Resource.TYPE.Animation:EditorModule.showAddResourceToNode(null,function(e){e?d.resource=e:(d.resource=new AnimationAsset,d.resource.uuid=!1);var t=e?e.filename:"";m(t=""!=t?t+" (AnimationAsset)":"")},TONG.Resource.TYPE.Animation);break;case TONG.Resource.TYPE.Audio:EditorModule.showAddResourceToNode(null,function(e){e?d.resource=e:(d.resource=new AudioAsset,d.resource.uuid=!1);var t=e?e.filename:"";m(t=""!=t?t+" (AudioAsset)":"")},TONG.Resource.TYPE.Audio);break;case TONG.Resource.TYPE.Video:EditorModule.showAddResourceToNode(null,function(e){e?d.resource=e:(d.resource=new VideoAsset,d.resource.uuid=!1);var t=e?e.filename:"";m(t=""!=t?t+" (VideoAsset)":"")},TONG.Resource.TYPE.Video);break;case TONG.Resource.TYPE.Mesh:EditorModule.showAddResourceToNode(null,function(e){e&&(d.resource=e);var t=e?e.filename:"";m(t=""!=t?t+" (MeshAsset)":"")},TONG.Resource.TYPE.Mesh);break;case"Object3D":EditorModule.showSelectNode(function(e){""!=(d.resource=e).name?m(e.name+" ("+e.type+")"):m("")},{type:d.resource,title:"Selected "+d.resource.type,value:new TONG.Object3D});break;default:var t={type:a,on_complete:m};i.skip_load?t.skip_load=!0:t.on_load=g,i.channel&&(t.channel=i.channel),i.material&&(t.material=i.material),TONG.RM.showSelectResource(t),i.callback_button&&i.callback_button.call(d,h.value)}}),d.addEventListener("dragover",function(e){var t=e.dataTransfer.getData("res-fullpath");e.dataTransfer.getData("res-type");t&&e.preventDefault()},!0),d.addEventListener("drop",function(e){var t=e.dataTransfer.getData("res-fullpath");return t?(d.resource=TONG.RM.getResource(t),o=h.value=t,p(h.value),e.stopPropagation()):e.dataTransfer.files.length?(ImporterModule.importFile(e.dataTransfer.files[0],function(e){o=h.value=e,p(h.value)}),e.stopPropagation()):e.dataTransfer.getData("text/uri-list")&&(o=h.value=e.dataTransfer.getData("text/uri-list"),p(h.value),e.stopPropagation()),e.preventDefault(),!1},!0),d.setValue=function(e,t){h.value=o=e,t||p(h.value)},d.getValue=function(){return o},d.getOptions=function(){return i},d.resourceType=a,this.tab_index+=1,this.append(d,i),d}TONG.FontInfo=FontInfo,TONG.FontInfo.prototype=Object.create(EditorResource.prototype),TONG.FontInfo.prototype.constructor=TONG.FontInfo,TONG.Component.addExtraMethods(TONG.FontInfo),extendClass(TONG.FontAsset,TONG.Resource),TONG.FontAsset.prototype.resource_type=TONG.Resource.TYPE.Font,TONG.FontAsset.prototype.serialize=function(e){var t=this.data?this.data.toJSON({fonts:{}}):{};return t.filename=this.filename,t.fullpath=this.fullpath,t.size=this.size,t.resource_type=TONG.Resource.TYPE.Font,t.uuid||(this.uuid=t.uuid=TONG.Math.generateUUID()),t},TONG.FontAsset.prototype.onDblclick=function(){},TONG.FontAsset.prototype.clone=function(){var e=new TONG.FontAsset,t=FileNameHelper.GetNextFileName(this.filename);return e.data=this.data.clone(),e.size=this.size,e.fullpath=e.filename=e.name=t,e.register(),e},TONG.RM.registerResourceClass(TONG.FontAsset),TONG.FontAsset.prototype.editorTarget=null,TONG.FontAsset.prototype.callEditorTarget=function(){return this.editorTarget||(this.editorTarget=new FontInfo(this)),this.editorTarget},TONG.RM.registerResourcePreProcessor("wbin",function(e,t,o){if(t.constructor===Object&&t.object_class){if(TONG.RM.ResourceClasses[t.object_class]){var i=TONG.RM.ResourceClasses[t.object_class]||window[t.object_class];if(i&&i.fromBinary)return i.fromBinary(t,e);if(i&&i.prototype.fromBinary){var a=new i;return a.fromBinary(object,e),a}}return t}return WBin.load(t,!1,e)},"binary"),TONG.RM.registerResourcePreProcessor("json",function(e,t,o){var i=t;if(t.constructor===String)try{t=JSON.parse(t)}catch(e){return null}var a=t.object_class||t.object_type;if(a&&!t.is_data){var n=TONG.RM.ResourceClasses[a]||window[a];if(!n)return null;n.prototype.configure?(i=new n).configure(t):i=new n(t)}else(i=new TONG.Resource).filename=e,i._data=t,i.type="json",i.category="json";return i}),TONG.RM.registerResourcePreProcessor("zip",function(e,t,a){if(!global.JSZip)throw"JSZip not found. To use ZIPs you must have the JSZip.js library included in the website.";return(new JSZip).loadAsync(t).then(function(e){e.forEach(function(t,e){if(!e.dir){var o=TONG.RM.getExtension(t),i=TONG.Formats.supported[o];e.async(i&&"text"==i.dataType?"string":"arraybuffer").then(function(e){"scene.json"!=t||a&&a.to_memory?TONG.RM.processResource(t,e):LS.GlobalScene.configure(JSON.parse(e))})}})}),!0},"binary"),LiteGUI.Inspector.prototype.addComponent=function(o,i,a){a=a||{},i=i||null;var n=this,e="";(this.values[o]=i)&&i.constructor.is_component&&(e=i.getLocator(),i.root&&(e=i.root.name+" ("+i.constructor.name+")"));var r=this.createWidget(o,"<span class='inputfield button'><input type='text' tabIndex='"+this.tab_index+"' class='text string' value='"+e+"' "+(a.disabled?"disabled":"")+"/></span><button class='micro'>"+(a.button||"...")+"</button>",a),s=r.querySelector(".wcontent input");s.addEventListener("change",function(e){var t=null;e.target.value&&(t=LSQ.get(e.target.value)),LiteGUI.Inspector.onWidgetChange.call(n,r,o,t,a)});var l=a.callback;return a.callback=function(e,t){if(i==e)return;i=e,s.value=e.root.name+" ("+i.constructor.name+")",t&&"change"!==t.type&&LiteGUI.trigger(s,"change");l&&l.call(r,i,o)},s.style.background="transparent url('"+Resource.icons.component+"') no-repeat left 4px center",s.style.paddingLeft="1.7em",s.setAttribute("placeHolder","None ("+i.constructor.name+")"),r.querySelector(".wcontent button").addEventListener("click",function(e){EditorModule.showSelectComponent(i,i.title,a.callback,r),a.callback_button&&a.callback_button.call(r,i,o)}),r.addEventListener("drop",function(e){e.preventDefault(),e.stopPropagation();var t=e.dataTransfer.getData("locator"),o=LSQ.get(t);if(o&&o.constructor.is_component&&(!a.component_class||o.constructor===TONG.Components[i.title]))return s.value=o.getLocator(),LiteGUI.trigger(s,"change"),!1},!0),this.tab_index+=1,this.append(r),r},LiteGUI.Inspector.widget_constructors[TONG.TYPES.COMPONENT]="addComponent",LiteGUI.Inspector.prototype.addComponentUID=function(t,i,a){a=a||{},i=i||"";var o=this;this.values[t]=i;var n=this.createWidget(t,"<span class='inputfield button'><input type='text' tabIndex='"+this.tab_index+"' class='text string' value='"+i+"' "+(a.disabled?"disabled":"")+"/></span><button class='micro'>"+(a.button||"...")+"</button>",a),r=n.querySelector(".wcontent input");r.addEventListener("change",function(e){LiteGUI.Inspector.onWidgetChange.call(o,n,t,e.target.value,a)});var s=a.callback;return a.callback=function(e,t){var o=null;o=e&&e.constructor!==String?e.uid:e;if(i==o)return;i=o||"",r.value!=i&&(r.value=i);t&&"change"!==t.type&&LiteGUI.trigger(r,"change");s&&s.call(n,i)},r.style.background="transparent url('"+Resource.icons.component+"') no-repeat left 4px center",r.style.paddingLeft="1.7em",r.setAttribute("placeHolder",i.constructor.name),n.querySelector(".wcontent button").addEventListener("click",function(e){EditorModule.showSelectComponent(i,a.filter||a.component_class,a.callback,n),a.callback_button&&a.callback_button.call(n,r.value)}),n.addEventListener("drop",function(e){e.preventDefault(),e.stopPropagation();var t=e.dataTransfer.getData("locator"),o=LSQ.get(t);if(!a.component_class||o.constructor===TONG.Components[a.component_class])return o&&o.constructor.is_component&&(r.value=t,LiteGUI.trigger(r,"change")),!1},!0),this.tab_index+=1,this.append(n),n},LiteGUI.Inspector.widget_constructors[TONG.TYPES.COMPONENT_ID]="addComponentUID",LiteGUI.Inspector.prototype.addArrayList=function(c,r,u){var d=this;if(r&&r.constructor===Array){d.value=r;var h=(u=this.processOptions(u)).data_type||"string",p=u.max_items||100,s=null,l=!(this.widgets_per_row=3);this.addInfo(c,null,{name_width:"100%",width:"100% - 200px",height:"21px"});var m=this.addString("length",r.length||"0",{width:120,callback:function(e){e=parseInt(e);r<0&&(r=0);var t=r.length;if(t<e){l=!0,r.length=e;for(var o=t;o<e;o++)r[o]=u.default;for(f.call(s);t<e;t++)u.callback&&u.callback_ele&&u.callback.call(s,r[t],t,c,l)}else{if(e<t){l=!0;var i=e,a=r.slice();return r.length=e,f.call(s),void(u.callback&&u.callback_ele&&(l=!1,u.callback.call(s,a[i],i,c,l,t-e)))}if(u.callback&&!u.callback_ele){var n=r.length-1;l||(n=r.length),u.callback.call(s,r,n,c,l)}r.length=e,f.call(s)}}});this.addButtons(null,["+","-"],{width:60,callback:function(e){if("+"==e)l=!0,r.length=r.length+1,r[r.length-1]=u.default,u.callback&&u.callback_ele&&u.callback.call(s,r[r.length-1],r.length-1,c,!0);else if(0<r.length){l=!1;var t=r[r.length-1];return r.length=r.length-1,m.setValue(r.length),f.call(s),void(u.callback&&u.callback_ele&&u.callback.call(s,t,r.length,c,!1))}m.setValue(r.length),f.call(s)}}),this.widgets_per_row=1,(s=this.addContainer(c,u)).value=r,s.widgets=[];var g=u.disabled;u.default;return f.call(s),s.setValue=function(e){d.value=e,f.call(s)},s.getValue=function(){return d.value},s.getName=function(){return c},s.getOptions=function(){return u},s}function f(){var t=this,o=t.value,e=Math.min(o.length,p);d.widgets_per_row=2,t.innerHTML="";for(var i=0;i<e;++i){var a=null;void 0!==o[i]&&(a=o[i]);var n={icon:u.icon,edit_target:u.edit_target,disabled:g,widget_parent:t,name_width:30,width:"100% - 40px",index:i,callback:v.bind({value:d.value,index:i})};if(u.data_options)for(var r in u.data_options)n[r]=u.data_options[r];var s=d.add(h,i,a,n);function l(e){u.callback_dblclick&&u.callback_dblclick.call(d,s)}t.widgets[i]=s,g&&u.callback_dblclick&&s.addEventListener("dblclick",l),d.addButton(null,"<img src='imgs/mini-icon-trash.png'/>",{widget_parent:t,index:i,width:30,callback:function(){if(o&&o.length>this.options.index-1){var e=o[this.options.index];if(u.callback){if(u.callback_ele)return o.splice(this.options.index,1),m.setValue(o.length,!0),f.call(t),void u.callback.call(t,e,this.options.index,c,!1);u.callback.call(t,o,this.options.index,c,!1)}o.splice(this.options.index,1),m.setValue(o.length,!0),f.call(t)}}})}d.widgets_per_row=1}function v(e){d.value[this.index]=e,u.callback&&(u.callback_ele?u.callback.call(s,d.value[this.index],this.index,c):u.callback.call(s,d.value,this.index,c))}},LiteGUI.Inspector.prototype.addArray=function(e,t,s){var l=this;if(t&&t.constructor===Array){var c=(s=this.processOptions(s)).data_type||"string",u=s.max_items||100,o=null;this.widgets_per_row=3,this.addInfo(e,null,{name_width:"100%",width:"100% - 200px",height:"21px"});var d=this.addString("length",t.length||"0",{width:120,callback:function(e){e=parseInt(e);t<0&&(t=0),t.length=e,h.call(o)}});return this.addButtons(null,["+","-"],{width:60,callback:function(e){"+"==e?t.length=t.length+1:0<t.length&&(t.length=t.length-1),d.setValue(t.length),h.call(o)}}),this.widgets_per_row=1,(o=this.addContainer(e,s)).value=t,h.call(o),o.setValue=function(e){this.value=e,h.call(o)},o.getValue=function(){return this.value=v},o}function h(){var e=this,t=e.value,o=Math.min(t.length,u);l.widgets_per_row=2,e.innerHTML="";for(var i=0;i<o;++i){var a=null;void 0!==t[i]&&(a=t[i]);var n={widget_parent:e,name_width:30,width:"100% - 40px",callback:p.bind({value:this.value,index:i})};if(s.data_options)for(var r in s.data_options)n[r]=s.data_options[r];l.add(c,i,a,n);l.addButton(null,"<img src='imgs/mini-icon-trash.png'/>",{widget_parent:e,index:i,width:30,callback:function(){t&&t.length>this.options.index-1&&(t.splice(this.options.index,1),d.setValue(t.length,!0),h.call(e))}})}l.widgets_per_row=1}function p(e){this.value[this.index]=e,s.callback&&s.callback.call(o,this.value,this.index)}},LiteGUI.Inspector.prototype.addResource=function(e,t,o,i){return addGenericResource.call(this,e,t,o,i)},LiteGUI.Inspector.widget_constructors.resource="addResource",LiteGUI.Inspector.prototype.addTexture=function(e,t,o){(o=o||{}).width="79%",o.name_width=80,this.widgets_per_row+=2;var i=addGenericResource.call(this,e,t,o,"Texture"),a=i.parentNode,n=this.addButton(null,"<img src='imgs/edit.png'/>",{width:"10%",callback:function(){if(!o.callback_edit||!o.callback_edit.call(this)){var e=i.resource;e.image&&EditorModule.inspect(e.callEditorTarget(),EditorModule.inspector.componentWidgets)}}});return a.appendChild(n),o.not_trash||this.addButton(null,"<img src='imgs/mini-icon-trash.png'/>",{width:"10%",callback:function(){i.setValue("")}}),this.widgets_per_row-=2,i},LiteGUI.Inspector.widget_constructors.texture="addTexture",LiteGUI.Inspector.prototype.addCubemap=LiteGUI.Inspector.prototype.addTexture,LiteGUI.Inspector.widget_constructors.cubemap="addCubemap",LiteGUI.Inspector.prototype.addObject3D=function(e,t,o){return addGenericResource.call(this,e,t,o,"Object3D")},LiteGUI.Inspector.widget_constructors.object3d="addObject3D",LiteGUI.Inspector.prototype.addMaterial=function(e,t,o){(o=o||{}).width="79%",o.name_width=80,this.widgets_per_row+=2;var i=addGenericResource.call(this,e,t,o,"Material"),a=i.parentNode,n=this.addButton(null,"<img src='imgs/edit.png'/>",{width:"10%",callback:function(){if(!o.callback_edit||!o.callback_edit.call(this)){var e=i.resource;e.callEditorTarget&&EditorModule.inspect(e.callEditorTarget(),EditorModule.inspector.componentWidgets)}}});return a.appendChild(n),o.not_trash||this.addButton(null,"<img src='imgs/mini-icon-trash.png'/>",{width:"10%",callback:function(){"Material"!=i.resource.type&&"NoneMaterial"!=i.resource.type&&(i.resource=new TONG.NoneMaterial,i.setValue(""))}}),this.widgets_per_row-=2,i},LiteGUI.Inspector.widget_constructors.material="addMaterial",LiteGUI.Inspector.prototype.addScript=function(e,t,o){(o=o||{}).width||(o.width="100% - 30px"),this.widgets_per_row+=1;var i=addGenericResource.call(this,e,t,o,"Script");return this.addButton(null,"{}",{width:"30px",callback:function(){var e=i.getValue();if(!e||-1!=e.indexOf(".js")){var o=i.resource,t=TONG.Script.setScript(o.filename,"javascript",o._data,o);TONG.Event.bind(t,"editInfo",function(e,t){o._code?o._code=t:o._data=t},t)}}}),this.widgets_per_row-=1,i},LiteGUI.Inspector.widget_constructors.script="addScript",LiteGUI.Inspector.prototype.addAnimation=function(e,t,o){(o=o||{}).width="85%",this.widgets_per_row+=1;var i=addGenericResource.call(this,e,t,o,"Animation");return this.addButton(null,"Edit",{width:"15%",widget_parent:o.widget_parent,callback:function(){var e=i.getValue(),t=null;e?t=TONG.RM.getResource(e,TONG.Animation):(e="@scene",TONG.GlobalScene.animation||TONG.GlobalScene.createAnimation(),t=TONG.GlobalScene.animation),t?AnimationModule.showTimeline(t):"@scene"!=e&&TONG.RM.load(e,null,function(e){AnimationModule.showTimeline(e)})}}),this.widgets_per_row-=1,i},LiteGUI.Inspector.widget_constructors.animation="addAnimation",LiteGUI.Inspector.prototype.addTextureSampler=function(i,a,n){n=n||{},a=a||{};var r=this,e="";(this.values[i]=a).name&&(e="string"==typeof a.name?a.name:":Texture");var s=this.createWidget(i,"<span class='inputfield button'><input type='text' tabIndex='"+this.tab_index+"' class='text string' value='"+e+"' "+(n.disabled?"disabled":"")+"/></span><button class='micro'>"+(n.button||"...")+"</button>",n),l=s.querySelector(".wcontent input");l.value=a&&a.name?a.name:"",s.options=n,l.style.background="transparent url('"+Resource.icons.Texture+"') no-repeat left 4px center",l.style.paddingLeft="1.7em",l.setAttribute("placeHolder","Texture");var t=n.callback;return n.callback=function(e){l.value=e&&e.filename?e.filename:"",e.name=e.filename,t&&t.call(s,e)},l.addEventListener("change",function(e){var t=e.target.value,o=a;t&&":"!=t[0]&&!n.skip_load&&TONG.ResourcesManager.load(t,null,function(e,t){o.image=e.image,a.needsUpdate=!0}),a.name=a.filename=t,l.value=a&&a.filename?a.filename:"",LiteGUI.Inspector.onWidgetChange.call(r,s,i,a,n)}),s.querySelector(".wcontent button").addEventListener("click",function(e){EditorModule.showTextureSamplerInfo(a,n)}),s.addEventListener("dragover",function(e){var t=e.dataTransfer.getData("res-fullpath");e.dataTransfer.getData("res-type");t&&e.preventDefault()},!0),s.addEventListener("drop",function(e){var t=e.dataTransfer.getData("res-fullpath");return t?(l.value=t,LiteGUI.trigger(l,"change"),e.stopPropagation()):e.dataTransfer.files.length?(ImporterModule.importFile(e.dataTransfer.files[0],function(e){l.value=e,LiteGUI.trigger(l,"change")}),e.stopPropagation()):e.dataTransfer.getData("text/uri-list")&&(l.value=e.dataTransfer.getData("text/uri-list"),LiteGUI.trigger(l,"change"),e.stopPropagation()),e.preventDefault(),!1},!0),this.tab_index+=1,this.append(s,n),s},LiteGUI.Inspector.widget_constructors.sampler="addTextureSampler",LiteGUI.Inspector.widget_constructors.position="addVector3",LiteGUI.Inspector.prototype.addLayers=function(e,a,n){n=n||{};var t=TONG.GlobalScene.getLayerNames(a).join(",");n.callback_button=function(){EditorModule.showLayersEditor(a,function(e,t,o){a=e;var i=TONG.GlobalScene.getLayerNames(a).join(",");r.setValue(i),n.callback&&n.callback.call(r,e,t,o)})};var r=this.addStringButton(e,t,n);return r},LiteGUI.Inspector.widget_constructors.layers="addLayers",LiteGUI.Inspector.prototype.addRenderSettings=function(e,t,o){return(o=o||{}).callback=function(){EditorModule.showRenderSettingsDialog(t)},this.addButton(e,"Edit",o)},LiteGUI.Inspector.widget_constructors.RenderSettings="addRenderSettings",LiteGUI.Inspector.prototype.addRenderFrameContext=function(e,t,o){return(o=o||{}).callback=function(){EditorModule.showRenderFrameContextDialog(t)},this.addButton(e,"Edit",o)},LiteGUI.Inspector.widget_constructors.RenderFrameContext="addRenderFrameContext",LiteGUI.Inspector.prototype.addRenderState=function(e,t,o){return(o=o||{}).callback=function(){EditorModule.showRenderStateDialog(t)},this.addButton(e,"Edit",o)},LiteGUI.Inspector.widget_constructors.RenderState="addRenderState",LiteGUI.Inspector.prototype.addShader=function(e,i,a){var n=this;(a=a||{}).width="80%",a.resource_classname="ShaderCode",n.widgets_per_row+=1;var r=n.addResource(e,i,a);return n.addButtons(null,[LiteGUI.special_codes.refresh,"{}"],{skip_wchange:!0,width:"20%",callback:function(e){if(e==LiteGUI.htmlEncode(LiteGUI.special_codes.refresh))a.callback_refresh&&a.callback_refresh.call(r);else if("{}"==e){if(!i)return void o();var t=TONG.RM.resources[i];t?CodingModule.editInstanceCode(t,null,!0):LiteGUI.confirm("ShaderCode not found, do you want to create it?",function(e){e&&o()})}function o(){DriveModule.showCreateShaderDialog({filename:"my_shader.glsl",on_complete:function(e,t,o,i){a.callback_open&&a.callback_open.call(r,i||t),a.callback&&a.callback.call(r,i||t),CodingModule.editInstanceCode(e,null,!0)}})}n.refresh()}}),n.widgets_per_row-=1,r},LiteGUI.Inspector.widget_constructors.shader="addShader",LiteGUI.Inspector.prototype.addColor=LiteGUI.Inspector.prototype.addColor,LiteGUI.Inspector.prototype.addColorUpdate=function(e,t,o){o=o||{};var i=100/this.widgets_per_row,a=.9*i;o.width=a+"%",this.widgets_per_row+=1,o.name_width||(o.name_width="40%");var n=this.addColorOld(e,t,o),r=colorPickerTool.icon;function s(e){e&&(n.setValue(e),RenderModule.requestFrame())}return this.addButton(null,"<img src="+r+">",{skip_wchange:!0,width:i-a+"%",callback:function(e){colorPickerTool.oneClick(s)}}),this.widgets_per_row-=1,n},LiteGUI.Inspector.widget_constructors.colorUpdate="addColorUpdate";var OrbitControls=function(){TONG.Component.call(this),this.icon="imgs/components/orbit.png",this.title=GetLanguage("OrbitControls");var e=new TONG.Object3D;this.targetObject=new TONG.Value({value:e,alias:GetLanguage("targetObject")}),this.needsButtonPressed=new TONG.Value({value:!0,alias:GetLanguage("needsButtonPressed")}),this.zoomEnabled=new TONG.Value({value:!0,alias:GetLanguage("zoomEnabled")}),this.movementEnabled=new TONG.Value({value:!0,alias:GetLanguage("movementEnabled")}),this.distance=new TONG.Value({value:4,alias:GetLanguage("distance")}),this.maxDistance=new TONG.Value({value:20,alias:GetLanguage("maxDistance")}),this.minDistance=new TONG.Value({value:2,alias:GetLanguage("minDistance")}),this.sensitivity=new TONG.Value({value:.002,alias:GetLanguage("sensitivity")}),this.zoomSensitivity=new TONG.Value({value:.001,alias:GetLanguage("zoomSensitivity")}),this.limitUp=new TONG.Value({value:1.57,alias:GetLanguage("limitUp")}),this.limitDown=new TONG.Value({value:-1.57,alias:GetLanguage("limitDown")}),this.center=null,this.vector=null,this.mouse=null,this.keyboard=null,this.tempVector=null,this.Awake=function(){this.center=new TONG.Vector3(0,0,0),this.targetObject.value!=e&&this.center.copy(this.targetObject.value.position),this.vector=new TONG.Vector2(0,0),this.mouse=this.scene.mouse,this.keyboard=this.scene.keyboard,this.tempVector=new TONG.Vector3,this.updateControls()},this.Update=function(){var e=!1;if(this.needsButtonPressed.value&&!this.mouse.buttonPressed(Mouse.LEFT)||(this.vector.y-=this.sensitivity.value*this.mouse.delta.y,this.vector.x-=this.sensitivity.value*this.mouse.delta.x,e=!0),this.zoomEnabled.value&&(0!==this.mouse.wheel&&(this.distance.value+=this.mouse.wheel*this.zoomSensitivity.value*this.root.position.distanceTo(this.center),e=!0),this.mouse.buttonPressed(Mouse.MIDDLE)&&(this.distance.value+=this.mouse.delta.y*this.zoomSensitivity.value,e=!0)),this.movementEnabled.value&&this.mouse.buttonPressed(Mouse.RIGHT)){var t=this.getWorldDirection(this.tempVector);t.y=0,t.normalize();var o=this.mouse.delta.y*this.sensitivity*this.distance;this.center.x-=t.x*o,this.center.z-=t.z*o,t.applyAxisAngle(OrbitControls.UP,1.57);var i=this.mouse.delta.x*this.sensitivity.value*this.distance.value;this.center.x-=t.x*i,this.center.z-=t.z*i,e=!0}e&&this.updateControls()},this.updateControls=function(){this.vector.y<this.limitDown.value?this.vector.y=this.limitDown.value:this.vector.y>this.limitUp.value&&(this.vector.y=this.limitUp.value),this.distance.value<this.minDistance.value?this.distance.value=this.minDistance.value:this.distance.value>this.maxDistance.value&&(this.distance.value=this.maxDistance.value);var e=this.distance.value*Math.cos(this.vector.y);this.root.position.set(Math.cos(this.vector.x)*e,this.distance.value*Math.sin(this.vector.y),Math.sin(this.vector.x)*e),this.root.position.add(this.center);var t=new TONG.Matrix4;t.lookAt(this.root.position,this.center,OrbitControls.UP),this.root.quaternion.setFromRotationMatrix(t)}};OrbitControls.UP=new TONG.Vector3(0,1,0),OrbitControls.ZERO=new TONG.Vector3(0,0,0),OrbitControls.prototype=Object.create(TONG.Component.prototype),OrbitControls.prototype.constructor=OrbitControls,TONG.Components.registerComponent(OrbitControls);var FirstPersonControls=function(){TONG.Component.call(this),this.icon="imgs/components/first-person.png",this.title=GetLanguage("FirstPersonControls"),this.sensitivity=new TONG.Value({value:.005,alias:GetLanguage("sensitivity")}),this.needsButtonPressed=new TONG.Value({value:!0,alias:GetLanguage("needsButtonPressed")}),this.movementEnabled=new TONG.Value({value:!0,alias:GetLanguage("movementEnabled")}),this.moveSpeed=new TONG.Value({value:.05,alias:GetLanguage("moveSpeed")}),this.moveOnPlane=new TONG.Value({value:!1,alias:GetLanguage("moveOnPlane")});var t=[Keyboard.W,Keyboard.S,Keyboard.A,Keyboard.D];this.vector=null,this.mouse=null,this.keyboard=null,this.tempVector=null,this.Awake=function(){this.mouse=this.scene.mouse,this.keyboard=this.scene.keyboard,this.vector=new TONG.Vector2(0,0),this.tempVector=new TONG.Vector3,this.updateControls()},this.Update=function(){if(this.needsButtonPressed.value&&!this.mouse.buttonPressed(Mouse.LEFT)||(this.vector.y-=this.sensitivity.value*this.mouse.delta.y,this.vector.x-=this.sensitivity.value*this.mouse.delta.x,this.vector.y<-1.57?this.vector.y=-1.57:1.57<this.vector.y&&(this.vector.y=1.57),this.updateControls()),this.movementEnabled.value){if(this.keyboard.keyPressed(t[0])){var e=this.root.getWorldDirection(this.tempVector);this.moveOnPlane.value&&(e.y=0),e.normalize(),e.multiplyScalar(this.root instanceof TONG.Camera?-this.moveSpeed.value:this.moveSpeed.value),this.root.position.sub(e)}if(this.keyboard.keyPressed(t[1])){e=this.root.getWorldDirection(this.tempVector);this.moveOnPlane.value&&(e.y=0),e.normalize(),e.multiplyScalar(this.root instanceof TONG.Camera?-this.moveSpeed.value:this.moveSpeed.value),this.root.position.add(e)}if(this.keyboard.keyPressed(t[2]))(e=new TONG.Vector3(Math.sin(this.vector.x-1.57),0,Math.cos(this.vector.x-1.57))).normalize(),e.multiplyScalar(this.moveSpeed.value),this.root.position.sub(e);if(this.keyboard.keyPressed(t[3]))(e=new TONG.Vector3(Math.sin(this.vector.x+1.57),0,Math.cos(this.vector.x+1.57))).normalize(),e.multiplyScalar(this.moveSpeed.value),this.root.position.sub(e)}},this.updateControls=function(){var e=Math.cos(this.vector.y),t=new TONG.Vector3(Math.sin(this.vector.x)*e,Math.sin(this.vector.y),Math.cos(this.vector.x)*e);t.add(this.root.position);var o=new TONG.Matrix4;o.lookAt(this.root.position,t,FirstPersonControls.UP),this.root.quaternion.setFromRotationMatrix(o)},this.getDirection=function(){var e=this.root.getWorldDirection(this.tempVector);return e.normalize(),e}};FirstPersonControls.UP=new TONG.Vector3(0,1,0),FirstPersonControls.prototype=Object.create(TONG.Component.prototype),FirstPersonControls.prototype.constructor=FirstPersonControls,TONG.Components.registerComponent(FirstPersonControls);var KeyFrameData=function(e,t,o,i,a,n){this.interpolation=e,this.initialValue=t,this.channel=o,this.currentValue=i,this.timeController=n,this.time=a},AnimationKeyFrame=function(t){switch(TONG.Component.call(this),this.icon="css/pic/inspector/keyframe.png",this.title=GetLanguage("Keyframe"),this.target=t,this.interpolation=new TONG.Enum(["TONG.InterpolateLinear","TONG.InterpolateDiscrete","TONG.InterpolateSmooth"],{alias:GetLanguage("interpolation"),callback:function(e){},isCompile:!0}),t.interpolation){case 2300:this.interpolation.setValue("TONG.InterpolateDiscrete",!0);break;case 2301:this.interpolation.setValue("TONG.InterpolateLinear",!0);break;case 2302:this.interpolation.setValue("TONG.InterpolateSmooth",!0)}this.currentValue=new TONG.Value({alias:GetLanguage("Value"),value:t.currentValue,callback:function(e){t.timeController.setKeyFrame(t.channel,t.time,[e.x,e.y,e.z])}})};AnimationKeyFrame.prototype=Object.create(TONG.Component.prototype),AnimationKeyFrame.prototype.constructor=AnimationKeyFrame;var MoviePlayer=function(){TONG.Component.call(this),this.title=GetLanguage("MoviePlayer"),this.icon="imgs/components/movie.png";var o=this;this.video=new TONG.Value({value:new TONG.VideoAsset,alias:GetLanguage("videoAsset")}),this.autoplay=new TONG.Value({value:!0,alias:GetLanguage("isAutoPlay"),callback:function(e){o.videoTexture&&o.videoTexture.setAutoPlay(e)}}),this.volume=new TONG.Slider(1,{min:0,max:1,step:.1,alias:GetLanguage("volume"),callback:function(e){o.videoTexture&&o.videoTexture.setVolume(e)}}),this.playbackRate=new TONG.Value({value:1,min:1,max:2,alias:GetLanguage("playbackRate"),callback:function(e){o.videoTexture&&o.videoTexture.setPlaybackRate(e)}}),this.loop=new TONG.Value({value:!0,alias:GetLanguage("isLoop"),callback:function(e){o.videoTexture&&o.videoTexture.setLoop(e)}}),this.startTime=new TONG.Value({min:0,value:0,alias:GetLanguage("startTime"),callback:function(e){o.videoTexture&&o.videoTexture.setTime(e)}}),this.Awake=function(){if(this.root.material){var e=this.video.getValue().getData();if(this.autoplay.getValue()&&e){var t=e;this.videoTexture=new VideoTexture(t),o.videoTexture.setAutoPlay(this.autoplay.getValue()),o.videoTexture.setVolume(this.volume.getValue()),o.videoTexture.setPlaybackRate(this.playbackRate.getValue()),o.videoTexture.setLoop(this.loop.getValue()),o.videoTexture.setTime(this.startTime.getValue()),this.root.material&&(this.root.material instanceof Array?(this.root.material[0].map=this.videoTexture,this.root.material[0].needsUpdate=!0):(this.root.material.map=this.videoTexture,this.root.material.needsUpdate=!0)),this.videoTexture.needsUpdate=!0}}},this.Stop=function(){this.videoTexture&&this.videoTexture.pause()},this.Dispose=function(){this.videoTexture&&(this.videoTexture.dispose(),this.root.material instanceof Array?(this.root.material[0].map=null,this.root.material[0].needsUpdate=!0):(this.root.material.map=null,this.root.material.needsUpdate=!0))}};MoviePlayer.prototype=Object.create(TONG.Component.prototype),MoviePlayer.prototype.constructor=MoviePlayer,TONG.Components.registerComponent(MoviePlayer);var Rigidbody=function(){TONG.Component.call(this),this.title=GetLanguage("Rigidbody"),this.icon="imgs/components/rigidbody.png";var i=this;this.mass=new TONG.Value({value:1,min:0,alias:GetLanguage("mass"),callback:function(e){i.body&&(i.body.mass=e)}}),this.drag=new TONG.Value({value:0,min:0,alias:GetLanguage("linearDamping")}),this.angular=new TONG.Value({value:.05,min:0,alias:GetLanguage("angularDamping")}),this.isKinematic=new TONG.Value({value:!1,alias:GetLanguage("isKinematic")}),this.useGravity=new TONG.Value({alias:GetLanguage("useGravity"),value:!0,callback:function(e){}}),this.Awake=function(){var e;e=this.scene,i.body=i.root.body,i.body.type=CANNON.Body.DYNAMIC,i.isKinematic.getValue()&&(i.body.type=CANNON.Body.KINEMATIC),i.body.linearDamping=i.drag.getValue(),i.body.angularDamping=i.angular.getValue(),e.world.addBody(i.body);var t=i.body,o=this.root.worldPosition;t.position.copy(o),t.quaternion.copy(this._root.worldQuaternion),i.body.updateMassProperties(),i.body.updateBoundingRadius(),i.body.aabbNeedsUpdate=!0},this.Update=function(){this.useGravity.getValue()&&this.scene.usePhysics&&0==this.body.shapes.length&&i.root.position.copy(this.body.position)}};Rigidbody.prototype=Object.create(TONG.Component.prototype),Rigidbody.prototype.constructor=Rigidbody,TONG.Components.registerComponent(Rigidbody);var Joint=function(){TONG.Component.call(this),this.RequireComponent(Rigidbody),this.title=GetLanguage("Joint"),this.icon="imgs/components/rigidbody.png";var t=this;this.type=new TONG.Enum(["PointConstraint","HingeConstraint","SliderConstraint","ConeTwistConstraint","DOFConstraint"],function(e){switch(e){case"PointConstraint":break;case"HingeConstraint":t.axis=new TONG.Vector3(0,1,0),t.limit=new TONG.Vector4(-1,1,0,0),t.refreshInspector()}}),this.connectBody=new Rigidbody;var e=null,o=!(this.Awake=function(){if(""!=this.connectBody.uuid){switch(this.type.getValue()){case"HingeConstraint":e=new Physijs.HingeConstraint(this.root,this.connectBody.root,this.connectBody.mesh.position,this.axis);break;case"SliderConstraint":e=new Physijs.SliderConstraint(this.root,this.connectBody.root,new TONG.Vector3(0,2,0),new TONG.Vector3(0,1,0));break;case"ConeTwistConstraint":e=new Physijs.ConeTwistConstraint(this.connectBody.root,this.root,this.connectBody.root.position);break;case"DOFConstraint":e=new Physijs.DOFConstraint(this.root,this.connectBody.root,this.connectBody.mesh.position);break;case"PointConstraint":default:e=new Physijs.PointConstraint(this.root,this.connectBody.root,this.connectBody.mesh.position)}e&&this.scene.addConstraint(e)}});this.Update=function(){o||(o=!0)}};Joint.prototype=Object.create(TONG.Component.prototype),Joint.prototype.constructor=Joint;var Collider=function(){TONG.Component.call(this),this.title=GetLanguage("Collider"),this.icon="css/pic/collision.png",this.helpUrl="http://showdoc.tong3d.com";var d=this;function h(e){d.body=d.root.body,d.body.material.friction=d.friction.getValue(),d.body.material.restitution=d.restitution.getValue(),e.world.addBody(d.body)}this.type=new TONG.Enum(["BoxCollider","SphereCollider","CylinderCollider","MeshCollider"],{alias:GetLanguage("type"),callback:function(e){}}),this.isCollion=new TONG.Value({value:!0,alias:GetLanguage("isCollion")}),this.friction=new TONG.Value({value:.1,min:0,alias:GetLanguage("friction")}),this.restitution=new TONG.Value({value:.1,min:0,alias:GetLanguage("restitution")}),this.center=new TONG.Value({value:new TONG.Vector3(0,0,0),alias:GetLanguage("center"),callback:function(e){t.tmpPosition.set(e.x,e.y,e.z)}}),this.size=new TONG.Value({value:new TONG.Vector3(1,1,1),alias:GetLanguage("size"),callback:function(e){t.tmpScale.set(e.x,e.y,e.z)}}),this.radius=new TONG.Value({value:.5,alias:GetLanguage("radius"),callback:function(e){t.tmpScale.set(2*e,2*e,2*e)}}),this.OnEditorGeometryChange=function(e){switch(e.type){case"PlaneBufferGeometry":case"BoxBufferGeometry":case"CircleBufferGeometry":this.type.setValue("BoxCollider");break;case"CylinderBufferGeometry":this.type.setValue("CylinderCollider");break;case"SphereBufferGeometry":case"IcosahedronGeometry":this.type.setValue("SphereCollider");break;case"TorusBufferGeometry":case"TorusKnotBufferGeometry":this.type.setValue("TrimeshCollider");break;case"LatheBufferGeometry":this.type.setValue("MeshCollider")}};var t=null;this.OnRemovedFromNode=function(){isEditor&&EditorModule.target.removePhysicsHelper(t)},this.OnInspectorAwake=function(){if(!d.body){var e=PhysicsGenerator.createSingleShape(this.root);switch(this._root.addShape(e),e.type){case CANNON.Shape.types.BOX:this.type.setValue("BoxCollider",!0),this.radius=null;break;case CANNON.Shape.types.SPHERE:this.type.setValue("SphereCollider",!0),this.size=null;break;case CANNON.Shape.types.TRIMESH:this.type.setValue("TrimeshCollider",!0),this.center=null,this.radius=null,this.size=null;break;case CANNON.Shape.types.CONVEXPOLYHEDRON:this.type.setValue("MeshCollider",!0),this.center=null,this.radius=null,this.size=null;break;case CANNON.Shape.types.CYLINDER:this.type.setValue("CylinderCollider",!0),this.center=null,this.radius=null,this.size=null}h(EditorModule.target.scene)}d.body.position.copy(this._root.position),d.body.quaternion.copy(this._root.quaternion),t=new PhysicsObjectHelper(this._root),this.center&&t.tmpPosition.set(this.center.getValue().x,this.center.getValue().y,this.center.getValue().z),this.size&&t.tmpScale.set(this.size.getValue().x,this.size.getValue().y,this.size.getValue().z),this.radius&&t.tmpScale.set(2*this.radius.getValue(),2*this.radius.getValue(),2*this.radius.getValue()),EditorModule.target.addPhysicsHelper(t)},this.OnEditorRemovedFromNode=function(){isEditor&&EditorModule.target.removePhysicsHelper(t)},this.OnEditorRemoveObject=function(){isEditor&&EditorModule.target.removePhysicsHelper(t)},this.OnInspectorUpdate=function(){t&&t.update()},this.OnInspectorChange=function(e){EditorModule.target.removePhysicsHelper(t),t=null},this.OnInspectorSelect=function(e){t=new PhysicsObjectHelper(this._root),this.center&&t.tmpPosition.set(this.center.getValue().x,this.center.getValue().y,this.center.getValue().z),this.size&&t.tmpScale.set(this.size.getValue().x,this.size.getValue().y,this.size.getValue().z),this.radius&&t.tmpScale.set(2*this.radius.getValue(),2*this.radius.getValue(),2*this.radius.getValue()),EditorModule.target.addPhysicsHelper(t)},this.Start=function(){h(this.scene);var e=null;switch(this.type.getValue()){case"BoxCollider":e=PhysicsGenerator.createSingleShape(this.root,PhysicsGenerator.Type.BOX);break;case"SphereCollider":e=PhysicsGenerator.createSingleShape(this.root,PhysicsGenerator.Type.SPHERE);break;case"CylinderCollider":e=PhysicsGenerator.createSingleShape(this.root,PhysicsGenerator.Type.CYLINDER);break;case"MeshCollider":default:e=PhysicsGenerator.createSingleShape(this.root,PhysicsGenerator.Type.HULL)}d.body.addShape(e);var t=d.body,o=this.root.worldPosition,i=this.root.worldScale;t.position.copy(o),t.quaternion.copy(this._root.worldQuaternion);var a=new CANNON.Vec3;this.shapeOffsetPosition=new CANNON.Vec3;var n=new CANNON.Vec3,r=new CANNON.Vec3(1,1,1);this.center&&this.shapeOffsetPosition.set(this.center.getValue().x,this.center.getValue().y,this.center.getValue().z),this.size&&r.set(this.size.getValue().x,this.size.getValue().y,this.size.getValue().z),this.radius&&r.set(2*this.radius.getValue(),2*this.radius.getValue(),2*this.radius.getValue());var s=r.x*i.x/2,l=r.y*i.y/2,c=r.z*i.z/2;if(e.type==CANNON.Shape.types.SPHERE){var u=Math.max(Math.abs(s),Math.abs(l),Math.abs(c));e.radius=u}else e.halfExtents.set(s,l,c);t.quaternion.vmult(t.shapeOffsets[0],a),t.position.vadd(a,a),t.position.vadd(this.shapeOffsetPosition,a),t.quaternion.mult(t.shapeOrientations[0],n),e.updateConvexPolyhedronRepresentation(),e.updateBoundingSphereRadius(),d.body.updateMassProperties(),d.body.updateBoundingRadius(),d.body.aabbNeedsUpdate=!0},this.matrix=new TONG.Matrix4,this.bodyMatrix=new TONG.Matrix4,this.Update=function(e){this.scene.usePhysics&&(d.root.position.copy(this.body.position),this.root.quaternion.copy(d.body.quaternion))}};Collider.prototype=Object.create(TONG.Component.prototype),Collider.prototype.constructor=Collider,TONG.Components.registerComponent(Collider);var AudioPlayer=function(){TONG.Component.call(this),this.title=GetLanguage("AudioPlayer"),this.icon="imgs/components/audio.png";var t=this;this.audio=new TONG.Value({value:new TONG.AudioAsset,alias:GetLanguage("audioAsset")}),this.autoplay=new TONG.Value({value:!0,alias:GetLanguage("isAutoPlay")}),this.volume=new TONG.Slider(1,{min:0,max:1,step:.1,alias:GetLanguage("volume"),callback:function(e){t.setVolume(e)}}),this.playbackRate=new TONG.Value({value:1,min:1,max:2,alias:GetLanguage("playbackRate"),callback:function(e){t.setPlaybackRate(e)}}),this.startTime=new TONG.Value({min:0,value:0,alias:GetLanguage("startTime"),callback:function(e){t.setStartTime(e)}}),this.loop=new TONG.Value({value:!0,alias:GetLanguage("isLoop"),callback:function(e){t.setLoop(e)}}),this.onEndCallback=null,this.Start=function(){this.audio.getValue().getData()&&(this.audioObj=this.audio.getValue().getData(),this.audioObj.setVolume(this.volume.getValue()),this.audioObj.setStartTime(this.startTime.getValue()),this.audioObj.setLoop(this.loop.getValue()),this.audioObj.setPlaybackRate(this.playbackRate.getValue()),this.autoplay.getValue()&&this.play())},this.getIsReady=function(){return!!this.audioObj&&this.audioObj.isReady},this.play=function(){this.audioObj&&this.audioObj.play()},this.pause=function(){this.audioObj&&this.audioObj.pause()},this.stop=function(){this.audioObj&&this.audioObj.stop()},this.Stop=function(){this.stop()},this.setAudioAsset=function(e){this.audio.setValue(e),null!==this.audio.getValue().getData().buffer&&(this.audio.getValue().getData().isPlaying&&this.audio.getValue().getData().stop(),this.audio.getValue().getData().disconnect());var t=this;this.audio.getValue().getData().getAudioBuffer(this.context,function(e){t.audio.getValue().getData().setBuffer(e)})},this.getVolume=function(){return this.volume.getValue()},this.getCurrentTime=function(){return this.audioObj?this.audioObj.getCurrentTime():0},this.setVolume=function(e){this.volume.setValue(e,!0),this.audioObj&&this.audioObj.setVolume(e)},this.setLoop=function(e){this.loop.setValue(e,!0),this.audioObj&&this.audioObj.setLoop(e)},this.getLoop=function(){return this.loop.getValue()},this.setPlaybackRate=function(e){this.playbackRate.setValue(e,!0),this.audioObj&&this.audioObj.setPlaybackRate(e)},this.getPlaybackRate=function(){return this.playbackRate.getValue()},this.getFilters=function(){return this.audioObj?this.audioObj.getFilters():[]},this.setFilters=function(e){this.audioObj&&this.audioObj.setFilters(e)},this.getFilter=function(e){return this.audioObj?this.audioObj.getFilter(e):null},this.setFilter=function(e){this.audioObj&&this.audioObj.setFilter(e)},this.setNodeSource=function(e){this.audioObj&&this.audioObj.setNodeSource(e)},this.getOutput=function(){return this.audioObj?this.audioObj.getOutput():null},this.dispose=function(){if(this.audioObj)return this.audioObj.dispose()},this.Dispose=function(){this.dispose()}};AudioPlayer.prototype=Object.create(TONG.Component.prototype),AudioPlayer.prototype.constructor=AudioPlayer,TONG.Components.registerComponent(AudioPlayer);var Webcam=function(){TONG.Component.call(this),this.title=GetLanguage("Webcam"),this.icon="css/pic/inspector/webcam.png";var e=this;function t(){Webcam.Texture&&(Webcam.Texture.mode="Front"==e.facing.getValue()?WebcamTexture.USER:WebcamTexture.ENVIRONMENT),e.root.material&&(e.root.material instanceof Array?(e.root.material[0].map=Webcam.Texture,e.root.material[0].needsUpdate=!0):(e.root.material.map=Webcam.Texture,e.root.material.needsUpdate=!0))}this.facing=new TONG.Enum(["Front","Backend"],{alias:GetLanguage("facingMode"),callback:function(e){"Front"==e?Webcam.Texture&&(Webcam.Texture.mode=WebcamTexture.USER):"Backend"==e&&Webcam.Texture&&(Webcam.Texture.mode=WebcamTexture.ENVIRONMENT)}}),this.isAuto=new TONG.Value({value:!0,alias:GetLanguage("autoConnect")}),this.Awake=function(){e.root.material&&this.isAuto.getValue()&&this.connect()},this.connect=function(){Webcam.Texture||(Webcam.Texture=new WebcamTexture),t()},this.Stop=function(){this.disconnect()},this.disconnect=function(){Webcam.Texture&&Webcam.Texture.disconnect()},this.dispose=function(){Webcam.Texture&&(Webcam.Texture.dispose(),Webcam.Texture=null)},this.Dispose=function(){this.dispose(),t()}};Webcam.Texture=null,Webcam.prototype=Object.create(TONG.Component.prototype),Webcam.prototype.constructor=Webcam,TONG.Components.registerComponent(Webcam);var Animation=function(e){TONG.Component.call(this),this.icon="imgs/components/animation.png",this.title=GetLanguage("Animation"),this.current=new TONG.Enum([]),this.file=new TONG.Value({value:new TONG.AnimationAsset,alias:GetLanguage("animationAsset")}),this.isAutoPlay=new TONG.Value({value:!0,alias:GetLanguage("isAutoPlay")}),this.isLoop=new TONG.Value({value:!0,alias:GetLanguage("isLoop")});var t=0,c=!0;this.OnInspectorAwake=function(){if(this.root.animations){this.file=null;for(var e=[],t=0;t<this.root.animations.length;t++)e[t]=this.root.animations[t].name;this.current=new TONG.Enum(e,{alias:GetLanguage("currentAnimation")})}else this.current=null},this.Awake=function(){if(this.root.animations)return this.mixer=new TONG.AnimationMixer(this.root),this.clip=this.root.animations[0],this.action=this.mixer.clipAction(this.clip).play(),void(this.isAutoPlay.getValue()||(c=!1));if(this.file.getValue().filename){this.mixer=new TONG.AnimationMixer(this.root);for(var e=this.file.getValue().getData(),t=[],o=0,i=e.tracks.length;o!==i;++o){var a=TONG.KeyframeTrack.toJSON(e.tracks[o]),n=a.name.indexOf("."),r=a.name.substring(n),s=this.root.uuid+r;a.name=s,t.push(a)}var l=TONG.AnimationClip.toJSON(e);l.tracks=t,this.clip=TONG.AnimationClip.parse(l),this.action=this.mixer.clipAction(this.clip).play(),this.isAutoPlay.getValue()||(c=!1)}},this.play=function(e){t=e,c=!0},this.stop=function(){c=!1,t=0},this.Update=function(e){this.mixer&&c&&(t+=e.delta,this.action.time=t,this.mixer.update(e.delta),this.isLoop.getValue()&&t>this.clip.duration?t=0:this.isLoop.getValue()||t>=this.clip.duration&&(c=!1))}};Animation.prototype=Object.create(TONG.Component.prototype),Animation.prototype.constructor=Animation,TONG.Components.registerComponent(Animation);var Setting=function(){TONG.Component.call(this),this.icon="css/pic/settingBtn.png",this.title=GetLanguage("Settings"),this.Background=new TONG.Value({alias:GetLanguage("Background"),value:new TONG.Color,callback:function(e){EditorModule.target.signals.sceneBackgroundChanged.dispatch(e.getHex())}});var r=this;function s(e,t,o,i,a){t instanceof TONG.Value?t=t.getValue():null==t&&(t=new TONG.Color(1,1,1)),EditorModule.target.signals.sceneFogChanged.dispatch(e,t.getHex(),o,i,a)}this.Fog=new TONG.Enum(["None","Fog","FogExp2"],{alias:GetLanguage("Fog"),callback:function(t){var e=EditorModule.target.scene.fog;if(e)o=e.color,i=e.near?e.near:.1,a=e.far?e.far:50,n=e.density?e.density:.1;else var o=new TONG.Color(1,1,1),i=.1,a=50,n=.1;switch(t){case"None":r.FogColor=null,r.FogNear=null,r.FogFar=null,r.FogDensity=null;break;case"Fog":r.FogDensity=null;case"FogExp2":o instanceof TONG.Color&&(r.FogColor=new TONG.Value({alias:GetLanguage("FogColor"),value:o,callback:function(e){s(t,e,i,a,n)}})),"number"==typeof i&&"Fog"==t&&(r.FogNear=new TONG.Value({alias:GetLanguage("FogNear"),value:i,callback:function(e){s(t,o,e,a,n)}})),"number"==typeof a&&"Fog"==t&&(r.FogFar=new TONG.Value({alias:GetLanguage("FogFar"),value:a,callback:function(e){s(t,o,i,e,n)}})),"number"==typeof n&&"FogExp2"==t&&(r.FogNear=null,r.FogFar=null,r.FogDensity=new TONG.Value({alias:GetLanguage("FogDensity"),value:n,callback:function(e){s(t,o,i,a,e)}}))}r.refreshInspector(),s(t,o,i,a,n)}}),this.FogColor=null,this.FogNear=null,this.FogFar=null,this.FogDensity=null,this.Gravity=new TONG.Value({alias:GetLanguage("Gravity"),value:new TONG.Vector3(0,-10,0),callback:function(e){EditorModule.target.config.setKey("gravity",{x:e.x,y:e.y,z:e.z})}}),this.AutoSave=new TONG.Value({alias:GetLanguage("AutoSave"),value:!0,callback:function(e){EditorModule.target.config.setKey("autosave",e),!0===e&&EditorModule.target.signals.sceneGraphChanged.dispatch()}});var e=new TONG.Value({alias:GetLanguage("Antialia"),value:!1,callback:function(e){EditorModule.target.config.setKey("project/renderer/antialias",e),l()}}),t=new TONG.Value({alias:GetLanguage("Shadow"),value:!1,callback:function(e){EditorModule.target.config.setKey("project/renderer/shadows",e),l()}});function l(){!function(e,t,o,i){if(EditorModule.viewport.renderer)null!=e&&(Settings.render.antialiasing=e),null!=t&&(Settings.render.shadows=t),Settings.render.gammaInput=o,Settings.render.gammaOutput=i,EditorModule.viewport.resetRenderer()}(r.Antialia?r.Antialia.getValue():null,r.Shadow?r.Shadow.getValue():null,r.gammaInput.getValue(),r.gammaOutput.getValue())}this.Antialia=e,this.Shadow=t,this.gammaInput=new TONG.Value({alias:GetLanguage("GammaInput"),value:!1,callback:function(e){EditorModule.target.config.setKey("project/renderer/gammaInput",e),l()}}),this.gammaOutput=new TONG.Value({alias:GetLanguage("GammaOutput"),value:!1,callback:function(e){EditorModule.target.config.setKey("project/renderer/gammaOutput",e),l()}}),this.VR=new TONG.Value({alias:GetLanguage("VR"),value:!1,callback:function(e){EditorModule.target.config.setKey("project/vr",e)}}),this.OnInspectorAwake=function(){this.Background.setValue(EditorModule.target.scene.background);var e=EditorModule.target.scene.fog;e&&(e instanceof TONG.FogExp2?(this.Fog.setValue("FogExp2",!0),this.FogDensity=e.density):this.Fog.setValue("Fog",!0),this.FogColor=e.color,this.FogNear=e.near,this.FogFar=e.far);var t=EditorModule.target.config.getKey("gravity");t&&this.Gravity.setValue(new TONG.Vector3(t.x,t.y,t.z),!0);var o=EditorModule.target.config.getKey("autosave");null!=o&&null!=o&&this.AutoSave.setValue(o,!0);var i=EditorModule.target.config.getKey("project/vr");null!=i&&null!=i&&this.VR.setValue(i,!0);var a=EditorModule.target.config.getKey("project/renderer/antialias");a&&this.Antialia.setValue(a,!0);var n=EditorModule.target.config.getKey("project/renderer/shadows");n&&this.Shadow.setValue(n,!0);var r=EditorModule.target.config.getKey("project/renderer/gammaInput");r&&this.gammaInput.setValue(r,!0);var s=EditorModule.target.config.getKey("project/renderer/gammaOutput");s&&this.gammaOutput.setValue(s,!0),l()}};function Pack(e){this.resource_names=[],this.metadata=null,this._data={},this._resources_data={},e&&this.configure(e)}Setting.prototype=Object.create(TONG.Component.prototype),Setting.prototype.constructor=Setting,Pack.version="0.2",extendClass(Pack,TONG.Resource),Pack.prototype.configure=function(e){if(this._data=LS.cloneObject(e),this.resource_names=e["@resource_names"],this._resources_data={},this.resource_names)for(var t in delete this._data["@resource_names"],this.resource_names)this._resources_data[this.resource_names[t]]=e["@RES_"+t],delete this._data["@RES_"+t];this.processResources()},Object.defineProperty(Pack.prototype,"bindata",{set:function(e){throw"Pack bindata cannot be assigned"},get:function(){return this._original_data||(this._original_data=TONG.Pack.packResources(this.resource_names,this._data)),this._original_data},enumerable:!0}),Pack.fromBinary=function(e){return e.constructor==ArrayBuffer&&(e=WBin.load(e,!0)),new TONG.Pack(e)},Pack.prototype.processResources=function(){if(this.resource_names){for(var e=this.fullpath||this.filename,t=0;t<this.resource_names.length;++t){var o=this.resource_names[t];TONG.ResourcesManager.resources[o]||(TONG.ResourcesManager.resources_being_processed[o]=!0)}for(t=0;t<this.resource_names.length;++t){o=this.resource_names[t];if(!TONG.ResourcesManager.resources[o]){var i=this._resources_data[o];if(i)TONG.ResourcesManager.processResource(o,i,{is_local:!0,from_pack:e})}}}},Pack.prototype.setResources=function(e,t){this.resource_names=[],this._resources_data={};for(var o=this.fullpath||this.filename,i=0;i<e.length;++i){var a=e[i];if(-1==this.resource_names.indexOf(a)){var n=TONG.ResourcesManager.resources[a];n&&(t&&(n.from_pack=o),this.resource_names.push(a))}}this._original_data=TONG.Pack.packResources(e,this.getBaseData()),this._modified=!0},Pack.prototype.getBaseData=function(){return{"@metadata":this.metadata,"@version":TONG.Pack.version}},Pack.prototype.setResourcesLink=function(e){for(var t=0;t<this.resource_names.length;++t){var o=this.resource_names[t],i=TONG.ResourcesManager.resources[o];i&&(e?i.from_pack=e:delete i.from_pack)}},Pack.prototype.addResources=function(e,t){e&&(e.constructor!==Array&&(e=[e]),this.setResources(this.resource_names.concat(e),t))},Pack.prototype.clone=function(){var e=FileNameHelper.GetNextFileName(this.filename),t=Pack.createPack(e,this.resource_names);return t.uuid=TONG.Math.generateUUID(),t},Pack.prototype.serialize=function(){return{uuid:this.uuid&&""!=this.uuid?this.uuid:TONG.Math.generateUUID(),filename:this.filename,resource_names:this.resource_names}},Pack.createPack=function(e,t,o,i){if(e){if(!t||t.constructor!==Array)throw"Pack.createPack resources must be array with names";if(o&&o.constructor!==Object)throw"Pack.createPack extra_data must be an object with the chunks to store";e=e.replace(/ /gi,"_");var a=new TONG.Pack;e+=".wbin",a.filename=e,o&&(a._data=o),a.resource_names=t;for(var n=0;n<t.length;++n){var r=t[n],s=TONG.ResourcesManager.resources[r];s&&(i&&(s.from_pack=a.filename))}this.metadata=o;var l=TONG.Pack.packResources(t,a.getBaseData());return a._original_data=l,a}},Pack.packResources=function(e,t){for(var o=t||{},i=[],a=0;a<e.length;++a){var n=e[a],r=TONG.ResourcesManager.resources[n];if(r){var s=null;if(r._original_data)s=r._original_data;else s=TONG.Resource.getDataToStore(r).data;if(s){if(s.constructor===Blob||s.constructor===File){if(!s.data||s.data.constructor!==ArrayBuffer)continue;s=s.data}o["@RES_"+i.length]=s,i.push(n)}}}return o["@resource_names"]=i,WBin.create(o,"Pack")},Pack.prototype.flagResources=function(){if(this.resource_names)for(var e=0;e<this.resource_names.length;++e){var t=this.resource_names[e],o=TONG.ResourcesManager.resources[t];o&&(o.from_pack=this.fullpath||this.filename)}},Pack.prototype.getDataToStore=function(){return TONG.Pack.packResources(this.resource_names,this.getBaseData())},Pack.prototype.checkResourceNames=function(){if(!this.resource_names)return 0;for(var e=0,t=0;t<this.resource_names.length;++t){var o=this.resource_names[t],i=o,a=TONG.ResourcesManager.resources[o];if(a){0==TONG.ResourcesManager.valid_resource_name_reg.test(o)&&(o=o.replace(/[^a-zA-Z0-9-_\.\/]/g,"_"));var n=TONG.ResourcesManager.getExtension(o);n||(n=a.constructor.EXTENSION)&&(o=o+"."+n),i!=o&&(this.resource_names[t]=o,TONG.ResourcesManager.renameResource(i,o),e++)}}return e&&TONG.ResourcesManager.resourceModified(this),e},Pack.prototype.onResourceRenamed=function(e,t,o){if(this.resource_names){var i=this.resource_names[e];-1!=i&&(this.resource_names[i]=t,TONG.ResourcesManager.resourceModified(this))}},Pack.prototype.containsResources=function(){return!!(this.resource_names&&0<this.resource_names.length)},TONG.Pack=Pack,Pack.prototype.resource_type=TONG.Resource.TYPE.Pack,TONG.RM.registerResourceClass(TONG.Pack);var PackTools={init:function(){},showCreatePrefabDialog:function(r){if(r=r||EditorModule.target.selected){var s=new LiteGUI.Dialog({id:"dialog_create_prefab",title:"Create Prefab",close:!0,width:500,height:270,scroll:!1,draggable:!0,resizable:!0});s.show();var e=new LiteGUI.Inspector({}),t=r.getResources({},!0);r.prefab&&delete t[r.prefab];var o={};for(var i in t){var a=i,n=LS.ResourcesManager.resources[a];n&&(n.getResources&&n.getResources(o))}for(var i in o)t[i]=o[i];var l=[];for(var i in t)i&&l.push(i);var c=LS.RM.getBasename(r.name);r.prefab&&(c=LS.ResourcesManager.getBasename(r.prefab));var u=e.addString("Filename",c),d=e.addList("Include assets",l,{multiselection:!0,height:140});e.addButtons("Select",["Meshes","Textures","Materials","Animations","All"],{callback:function(e){if("All"==e)d.selectAll();else for(var t=0;t<l.length;++t){var o=l[t],i=LS.RM.getResource(o);i&&((i.constructor===GL.Mesh&&"Meshes"==e||i.constructor===GL.Texture&&"Textures"==e||i.constructor.is_material&&"Materials"==e||i.constructor===LS.Animation&&"Animations"==e)&&d.selectIndex(t,!0))}}}),e.widgets_per_row=2;var h=!0;e.addCheckbox("Clear UIDs",h,{callback:function(e){h=e}});var p=!0;e.addCheckbox("Replace with Prefab",p,{name_width:120,callback:function(e){p=e}});var m=!(e.widgets_per_row=1);e.addCheckbox("Use node as prefab root",m,{name_width:160,callback:function(e){m=e}}),e.addInfo("Warning","Turning this ON will make the root node components not be saved in the prefab."),e.addSeparator();var g="";e.addFolder("Save to",g,{callback:function(e){g=e}}),e.addSeparator(),e.addButton(null,"Create Prefab",{callback:function(){var e=u.getValue(),t=r.transform.serialize(),o=r.serialize();r.transform.reset(),h&&LS.clearUIds(o),m||(o={object_class:"SceneNode",children:[o]}),s.close();var i=d.getSelected(),a=null;if(0==i.length?("json"!=LS.RM.getExtension(e)&&(e+=".PREFAB.json"),(a=new LS.Prefab).setData(o),a.filename=e):("wbin"!=LS.RM.getExtension(e)&&(e+=".wbin"),a=PackTools.createPrefab(e,o,i)),NotifyModule.show("Prefab Created","good big"),g){var n=LS.RM.cleanFullpath(g+"/"+a.filename);LS.RM.renameResource(a.filename,n),a.fullpath=n,DriveModule.saveResource(a)}else LS.RM.registerResource(a.filename,a);p?(m||r.removeAllComponents(),r.prefab=a.fullpath||a.filename,r.reloadFromPrefab(),r.transform||r.addComponent(new LS.Transform),r.transform.configure(t),EditorModule.refreshAttributes()):r.transform.configure(t)}}),s.add(e),s.adjustSize(5),document.body.appendChild(s.root)}else document.body.appendChild(LiteGUI.alert("No node selected").root)},createPrefab:function(e,t,o){if(e){e=e.replace(/ /gi,"_");var i=LS.Prefab.createPrefab(e,t,o);return LS.ResourcesManager.registerResource(i.filename,i),i}},updatePrefabFromNode:function(e){if(e&&e.prefab){var t=LS.RM.resources[e.prefab];if(t){var o=!0;t.prefab_data&&t.prefab_data.uid&&(o=!1),t.updateFromNode(e,o),LS.RM.resourceModified(t),t.applyToNodes(LS.GlobalScene)}}},showCreatePackDialog:function(e,i){e=e||{};var a=new LiteGUI.Dialog({id:"dialog_create_prefab",title:GetLanguage("Create Pack"),close:!0,width:360,height:270,scroll:!1,draggable:!0,resizable:!0}),n=e.filename||"unnamePack",r=e.folder||"",s=[],l=new LiteGUI.Inspector({});function t(){l.clear(),l.addString(GetLanguage("Filename"),n,function(e){n=e}),l.addTitle(GetLanguage("Resources")),l.startContainer(null,{height:200}).style.backgroundColor="#252525";for(var e=0;e<s.length;++e)l.addStringButton(null,s[e],{index:e,callback:function(e){e&&(s[this.options.index]=e)},callback_button:function(){s.splice(this.options.index,1),l.refresh()},button:"<img src='imgs/mini-icon-trash.png'/>"});l.endContainer(),l.addButtons(null,["Add locals","Add all"],{callback:function(e){for(var t in TONG.RM.resources){var o=TONG.RM.resources[t];"Add locals"==e&&(o.remotepath||-1!=s.indexOf(t))||s.push(t)}l.refresh()}}),l.addSeparator(),l.addResource(GetLanguage("Add Resource"),"",{name_width:140,callback:function(e){-1==s.indexOf(e)&&s.push(e),l.refresh()}}),l.addFolder(GetLanguage("Save to folder"),r,{callback:function(e){r=e}}),l.addButton(null,GetLanguage("Create Pack"),function(){a.close();var e=FileNameHelper.GetNextFileName(n),t=PackTools.createPack(e,s);if(r){var o=r+"/"+e;t.fullpath=o,"wbin"!=TONG.RM.getExtension(t.fullpath)&&(t.filename+=".wbin",t.fullpath+=".wbin"),DriveModule.saveResource(t)}else document.body.appendChild(LiteGUI.alert("Pack created").root);i&&i(t)}),a.adjustSize(5)}(l.on_refresh=t)(),a.show(),a.add(l),a.adjustSize(5),document.body.appendChild(a.root)},createPack:function(e,t,o){if(e){-1==(e=e.replace(/ /gi,"_")).indexOf(".PACK")&&(e+=".PACK");var i=TONG.Pack.createPack(e,t,o);return TONG.ResourcesManager.registerResource(i.filename,i),i}},showPackDialog:function(e){if(e){var t=e.resource_type,o=new LiteGUI.Dialog({id:"dialog_show_pack",title:t,close:!0,width:360,height:270,scroll:!1,draggable:!0,resizable:!0}),i=new LiteGUI.Inspector;(i.on_refresh=a)(),o.show(),o.add(i),o.adjustSize(5),document.body.appendChild(o.root)}function a(){i.clear(),e.inspect(i,!0),o.adjustSize(5)}}};function SceneTreeWidget(t,e){(e=e||{}).constructor,String;var r=this;this.locked=!1,this.root=document.createElement("div"),this.root.className="scene-tree",e.id&&(this.root.id=e.id),this.search=new LiteGUI.SearchBox("",{placeholder:"search...",callback:function(e){e=e.trim().toLowerCase(),r.tree.filterByRule(r.testFilteringRule,e)}}),this.search.root.querySelector("input").style="height:30px;background:url(css/pic/search.png) right center no-repeat",this.root.appendChild(this.search.root),this.root.addEventListener("drop",function(e){!0===EditorModule.onDropOnNode(EditorModule.target.scene,e)&&(e.stopPropagation(),e.stopImmediatePropagation(),e.preventDefault())});var o=t.uuid;EditorModule.target.signals.sceneInitFinish.add(function(e){o=e.uuid,r._scene=e,r.tree=new LiteGUI.Tree({id:r.getIdString(o),uid:o,content:e.name,precontent:"<span class='nodecontrols'></span>"},{allow_rename:!1,allow_drag:!0,allow_multiselection:!1}),r.content=r.tree,r.root.appendChild(r.tree.root),r.tree.onContextMenu=function(e){r.showContextMenu(e)},r.tree.root.querySelector(".collapsebox").firstElementChild.style.background="left center no-repeat";r.tree;r._ignore_events=!1,r.tree.onBackgroundClicked=function(){ResourcesPanelWidget.Deselect(),EditorModule.target.select(null)},r.tree.root.addEventListener("item_selected",function(e){if(this._ignore_events)return;if(!r._scene)return;var t=e.detail;if(!t.item)return;var o=t.data,i=null;ResourcesPanelWidget.Deselect(!0),o.uid&&((i=EditorModule.target.objectByUuid(o.uid))?(r.trigger_clicks&&TONG.Event.trigger(r._scene,"node_clicked",i),EditorModule.target.select(i),window.NODE=i):r.tree.removeItem(o.uid))}.bind(r)),r.tree.root.addEventListener("item_add_to_selection",function(e){if(this._ignore_events)return;var t=e.detail;if(!t.item)return;var o=t.data,i=null;o.uid&&((i=EditorModule.target.objectByUuid(o.uid))?SelectionModule.addToSelection(i):r.tree.removeItem(o.uid))}.bind(r)),r.tree.root.addEventListener("item_moved",function(e){var t=e.detail,o=t.item,i=(t.next,t.parent_item);if(this._ignore_events)return;var a=EditorModule.target.objectByUuid(o.data.uid),n=EditorModule.target.objectByUuid(i.data.uid);n||(n=r._scene);if(!a||!n)return;this._ignore_events=!0,this._ignore_events=!1}.bind(r)),r.tree.root.addEventListener("item_renamed",function(e){if(this._ignore_events)return;var t=e.detail.item,o=r._scene.getNode(data.old_name);if(!o)return;o.setName(data.new_name),t.parentNode.data.node_name=data.new_name}.bind(r)),r.tree.root.addEventListener("item_collapse_change",function(e){if(this._ignore_events)return;var t=e.detail,o=t.item,i=EditorModule.target.objectByUuid(o.data.uid);if(!i)return;i._editor||(i._editor={});i._editor.collapsed="closed"==t.data}.bind(r)),r.tree.root.addEventListener("mousedown",function(){LiteGUI.focus_widget=r}),r.tree.onItemContextMenu=function(e,t){if(t&&t.data){var o=t.data.uid,i=EditorModule.target.objectByUuid(o);if(i)return EditorModule.showNodeContextMenu(i,e),e.preventDefault(),!1}},r.tree.onDropItem=function(e,t,o,i){var a=t.uid,n=EditorModule.target.objectByUuid(a);n&&(!0===EditorModule.onDropOnNode(n,event)&&(e.stopPropagation(),e.stopImmediatePropagation(),e.preventDefault()))}}),$(this.root).bind("DOMNodeInserted",function(e){"scene-tree"==e.target.className&&(r.bindEvents(EditorModule.target.scene),TONG.Event.bind(CORE,"global_scene_selected",r.onGlobalSceneSelected,r))}),$(this.root).bind("DOMNodeRemoved",function(e){"scene-tree"==e.target.className&&(r.unbindEvents(),TONG.Event.unbind(CORE,"global_scene_selected",r.onGlobalSceneSelected,r))}),EditorModule.target.signals.objectSelected.add(function(e){TONG.Event.trigger(t,"selected_node_changed",null!==e?e:null)}),this.refresh()}TONG.Pack.prototype.inspect=function(i,e){var o=this,t=o.resource_type,a=o.fullpath||o.filename||"",n=o.resource_names||[];i.addString("Filename",a,function(e){}),i.addTitle("Resources"),i.startContainer(null,{height:200}).style.backgroundColor="#252525",i.widgets_per_row=2;for(var r=0;r<n.length;++r)i.addButton(null,LiteGUI.special_codes.open_folder,{width:40,index:r,callback:function(){var e=n[this.options.index],t=TONG.RM.resources[e];window.RESOURCE=t,EditorModule.inspect(t)}}),i.addStringButton(null,n[r],{index:r,width:"calc(100% - 40px)",callback:function(e){e&&(n[this.options.index]=e)},callback_button:function(){n.splice(this.options.index,1),i.refresh()},button:"<img src='imgs/mini-icon-trash.png'/>"});if(i.widgets_per_row=1,i.endContainer(),i.addButton(null,"Check names",{callback:function(e){var t=o.checkResourceNames();LiteGUI.alert("Changed resources: "+t),i.refresh()}}),i.addButtons(null,["Add locals","Add all"],{callback:function(e){for(var t in TONG.RM.resources){var o=TONG.RM.resources[t];"Add locals"==e&&(o.remotepath||-1!=resources.indexOf(t))||n.push(t)}i.refresh()}}),o._data){i.addTitle("Extra data");var s=[];for(var r in o._data)s.push(r);i.addList(null,s),o._data["scene.json"]&&i.addButton(null,"Show Scene JSON",{callback:function(e){EditorModule.checkJSON(o._data["scene.json"])}})}"Prefab"==t&&i.addButton(null,"Show JSON Data",{callback:function(e){EditorModule.checkJSON(o.prefab_data)}}),i.addSeparator(),i.addResource("Add Resource","",{name_width:140,callback:function(e){-1==n.indexOf(e)&&n.push(e),i.refresh()}}),i.addButton(null,"Update "+t,function(){o.setResources(n,!0),o.fullpath?DriveModule.saveResource(o,function(e){LiteGUI.alert(t+" updated & saved")}):LiteGUI.alert(t+" updated")}),e||DriveModule.addResourceInspectorFields(o,i)},CORE.registerModule(PackTools),SceneTreeWidget.prototype.getIdString=function(e){return"uid_"+e.replace(/\W/g,"_")},SceneTreeWidget.widget_name="Scene Tree",SceneTreeWidget.createDialog=function(){var e=new LiteGUI.Dialog(null,{title:"Select Node",fullcontent:!0,closable:!0,draggable:!0,minimize:!0,resizable:!0,parent:parent,width:500,height:500}),t=new SceneTreeWidget;return e.add(t),e.on_close=function(){t.unbindEvents()},e},SceneTreeWidget.prototype.destroy=function(){this.unbindEvents(),this.root.parentNode&&this.root.parentNode.removeChild(this.root)},SceneTreeWidget.prototype.onGlobalSceneSelected=function(e,t){this._scene!=t&&(this.bindEvents(t),this.refresh())},SceneTreeWidget.prototype.onKeyDown=function(e){if(8==e.keyCode||46==e.keyCode)return EditorModule.removeSelectedNodes(),!1},SceneTreeWidget.prototype.bindEvents=function(e){if(!e)throw"bindEvents require Scene";var n=this;function t(){n.updateRootUID(e)}this._scene&&this._scene!=e&&this.unbindEvents(),this._scene=e,TONG.Event.bind(e,"preConfigure",function(e,t){n.locked=!0},this),TONG.Event.bind(e,"configure",function(e,t){n.locked=!1,n.refresh()},this),TONG.Event.bind(e,"nodeAdded",function(e,i){if(!this._ignore_events&&!n.locked){this.addNode(i);var a=this;i.traverse(function(e){if(e!=i){var t=e.parent,o=n.getIdString(t.uuid);a.addNode(e,o)}})}},this),TONG.Event.bind(e,"nodeRemoved",function(e,t){this._ignore_events||this.removeNode(t)},this),TONG.Event.bind(e,"clear",function(e){this.clear(),SelectionModule.setSelection(null),t()},this),TONG.Event.bind(e,"configure",t,this),TONG.Event.bind(e,"selected_node_changed",function(e,t){this.tree.setSelectedItem(t?n.getIdString(t.uuid):null,!0)},this),TONG.Event.bind(e,"other_node_selected",function(e,t){this.tree.addItemToSelection(t?n.getIdString(t.uuid):null)},this),TONG.Event.bind(e,"other_node_deselected",function(e,t){this.tree.removeItemFromSelection(t?n.getIdString(t.uuid):null)},this),TONG.Event.bind(e,"node_rearranged",function(e,t){this.refresh()},this),TONG.Event.bind(e,"nodeChangeParent",function(e,t,o){},this),TONG.Event.bind(e,"node_name_changed",function(e,t){var o=n.getIdString(t.uuid);this.tree.updateItem(o,{id:o,uid:t.uuid,node_name:t.name,content:t.name})},this),TONG.Event.bind(e,"node_uid_changed",function(e,t){n.changeNodeUID(LS.SceneNode._last_uid_changed,t.uid)},this)},SceneTreeWidget.prototype.unbindEvents=function(){this._scene&&TONG.Event.unbindAll(this._scene,this),this._scene=null},SceneTreeWidget.prototype.clear=function(){this.tree&&this.tree.clear(!0)},SceneTreeWidget.prototype.showContextMenu=function(e){var t=this;new LiteGUI.ContextMenu(["Refresh","Scene"],{event:event,callback:function(e){"Refresh"==e?t.refresh():"Scene"==e&&EditorModule.inspect(TONG.GlobalScene)}})},SceneTreeWidget.prototype.addNode=function(e,t){var o=this.getIdString(e.uuid);""==e.name&&(e.name="tong_obj"),!t&&e.parent&&e.parent!=this._scene&&(t=this.getIdString(e.parent.uuid));var i=EditorModule.target.selected==e,a=!(!e||!e._editor)&&e._editor.collapsed,n=this.tree.insertItem({id:o,uid:e.uuid,node_name:e.name,content:e.name,precontent:"<span class='nodecontrols'><span title='visible' class='togglevisible "+(e.visible?"on":"")+"'></span></span>",allow_rename:null!=t,onDragData:function(){return{uid:e.uuid,class:"SceneNode",type:"SceneNode",locator:e.uuid,node_name:e.name,node_uid:e.uuid}}},t,void 0,{selected:i,collapsed:a}),r=n.querySelector(".collapsebox");r.firstElementChild.style.width="8px",r.firstElementChild.style.height="0px";return e.insidePrefab&&n.classList.add("prefab"),n.querySelector(".nodecontrols").addEventListener("click",function(e){e.stopPropagation()}),n.querySelector(".togglevisible").addEventListener("click",function(e){if(e.stopPropagation(),n.data){var t=n.data.uid,o=EditorModule.target.objectByUuid(t);o&&(this.classList.contains("on")?o.visible=!1:o.visible=!0,this.classList.toggle("on"))}}),o},SceneTreeWidget.prototype.removeNode=function(e){if(this.tree){var t=this.getIdString(e.uuid);this.tree.removeItem(t,!0)}},SceneTreeWidget.prototype.refresh=function(){this._scene&&(this.clear(),EditorModule.target.scene.traverse(function(e){e.parent==EditorModule.target.scene&&"Sky"!=e.type&&TONG.Event.trigger(EditorModule.target.scene,"nodeAdded",e)}))},SceneTreeWidget.prototype.serialize=function(){for(var e={selected:null,collapsed:{}},t=TONG.GlobalScene._nodes,o=0;o<t.length;++o){var i=t[o],a=this.tree.root.querySelector(".ltreeitem-"+this.getIdString(i.uid));if(a){var n=a.querySelector(".listbox");n&&n.classList.contains("listclosed")&&(e.collapsed[i.uid]=!0)}}return e},SceneTreeWidget.prototype.configure=function(e){for(var t=TONG.GlobalScene._nodes,o=0;o<t.length;++o){var i=t[o],a=this.tree.root.querySelector(".ltreeitem-"+this.getIdString(i.uid));if(a){var n=a.querySelector(".listbox");n&&e.collapsed[i.uid]&&n.collapse()}}},SceneTreeWidget.prototype.changeNodeUID=function(e,t){var o=this.getIdString(e),i=this.getIdString(t),a=this.tree.root.querySelector(".ltreeitem-"+o);a&&a.dataset.item_id!=i&&(this.tree.updateItemId(o,i),a.classList.remove("ltreeitem-"+o),a.classList.add("ltreeitem-"+i),a.dataset.item_id=i,a.data.uid=t)},SceneTreeWidget.prototype.updateRootUID=function(e){var t=(e=e||TONG.GlobalScene).root.uid,o=(this.getIdString(t),this.tree.root.querySelector(".root_item"));if(o){var i=o.data.uid;this.changeNodeUID(i,t)}},SceneTreeWidget.prototype.testFilteringRule=function(e,t,o){var i=EditorModule.target.objectByUuid(e.uid);if(i){if(0==o.length)return!0;if("."==o[0])for(var a=o.substr(1),n=0;n<i.components.length;++n){if(-1!=i.components[n].title.toLowerCase().indexOf(a))return!0}else if(-1!=i.name.toLowerCase().indexOf(o))return!0;return!1}},TONG.Script=function(){TONG.Component.call(this),this.title="Script",this.icon="css/pic/js.png",this.helpUrl="http://showdoc.tong3d.com";var that=this;this.compile=function(){var scriptData=this._data,className=FileSystem.getNameWithoutExtension(this.filename);try{var ScriptClass=window[className+"Prototype"]=new Function(scriptData).bind(this)}catch(e){return-1==this.element.className.indexOf("modified")&&(this.element.className+=" modified"),this.scriptObject=null,null}return-1!=this.element.className.indexOf("modified")&&this.element.className.replace("modified",""),window[className]=function(){TONG.Script.Compile.call(this),this.script=that,this.title=className+"(Script)",this.className=FileSystem.getNameWithoutExtension(that.filename),eval(scriptData)},window[className].prototype=Object.create(TONG.Script.Compile.prototype),window[className].constructor=window[className],extendClass(window[className],ScriptClass),window[className]},this.getCompileScript=function(){var className=FileSystem.getNameWithoutExtension(this.filename),sobject=this.compile(),scriptComObj=eval("new "+className+"()");return scriptComObj}},TONG.Script.Compile=function(){TONG.Component.call(this),this.icon="css/pic/js.png"},TONG.Script.Compile.prototype=Object.create(TONG.Component.prototype),TONG.Script.Compile.constructor=TONG.Script.Compile,TONG.Script.getScript=function(){return this.codeEditorObject},TONG.Script.setScript=function(e,i,t,o){var a=this;function n(){if(TONG.Event.unbindAllEvent(TONG.Script.getScript(),"editInfo"),"javascript"==a.codeEditorObject.codeMirror.mode){if(a.resource&&a.resource instanceof TONG.Script){var e=a.resource.title,t=a.resource.compile();if(null==t)return;for(var o=TONG.Components.replaceScriptComponent(EditorModule.target.scene,e,t),i=0;i<o.length;i++)EditorModule.target.changeComponentSerialize(o[i])}}else if("glsl"==a.codeEditorObject.codeMirror.mode&&a.resource&&a.resource instanceof TONG.ShaderCode){e=a.resource.filename;TONG.RM.updateShaderContent(e)}}if(this.codeEditorObject)return this.isClose?(this.isClose=!1,TONG.Event.unbindAllEvent(this.codeEditorObject,"editInfo")):(n(),EditorModule.target.signals.editFile.dispatch(a.resource)),this.codeEditorObject.title.setValue(e),this.codeEditorObject.codeMirror.mode=i,this.codeEditorObject.codeMirror.setValue(t),this.codeEditorObject.container.setDisplay(""),this.codeEditorObject.codeMirror.refresh(),this.resource=o,this.codeEditorObject;this.resource=o;var r=EditorModule.target,s=r.signals,l=new UI.Panel;l.setId("script"),l.setPosition("absolute"),l.setBackgroundColor("#272822"),l.setDisplay("none"),document.body.appendChild(l.dom);var c=new UI.Panel;c.setPadding("10px"),l.add(c),e=e||"";var u=new UI.Text(e).setColor("#fff");c.add(u);var d,h,p,m,g=function(){var e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("width",32),e.setAttribute("height",32);var t=document.createElementNS("http://www.w3.org/2000/svg","path");return t.setAttribute("d","M 12,12 L 22,22 M 22,12 12,22"),t.setAttribute("stroke","#fff"),e.appendChild(t),e}(),f=new UI.Element(g);f.setPosition("absolute"),f.setTop("3px"),f.setRight("1px"),f.setCursor("pointer"),f.onClick(function(){l.setDisplay("none"),a.isClose=!0,n(),s.editFile.dispatch(a.resource)}),s.editFile.add(function(e){if(null!=e){var t=r.resources;for(var o in t)if(void 0!==t[o])for(var i=0;i<t[o].length;i++)if(t[o][i].uuid==e.uuid)return void(t[o][i].data=e.data)}}),c.add(f),s.rendererChanged.add(function(e){d=e});var v=CodeMirror(l.dom,{value:"",lineNumbers:!0,matchBrackets:!0,indentWithTabs:!0,tabSize:4,indentUnit:4,hintOptions:{completeSingle:!1}});v.setOption("theme","monokai"),v.on("change",function(){!1!==v.state.focused&&(clearTimeout(h),h=setTimeout(function(){var e=v.getValue();if(TONG.Event.trigger(TONG.Script.getScript(),"editInfo",e),"txt"==TONG.Script.getScript().mode||O(e))if("object"!=typeof p){if("programInfo"===p){var t,o=JSON.parse(e);if(JSON.stringify(m.material.defines)!==JSON.stringify(o.defines))(t=new SetMaterialValueCommand(m,"defines",o.defines)).updatable=!1,r.execute(t);if(JSON.stringify(m.material.uniforms)!==JSON.stringify(o.uniforms))(t=new SetMaterialValueCommand(m,"uniforms",o.uniforms)).updatable=!1,r.execute(t);if(JSON.stringify(m.material.attributes)!==JSON.stringify(o.attributes))(t=new SetMaterialValueCommand(m,"attributes",o.attributes)).updatable=!1,r.execute(t)}}else e!==p.source&&r.execute(new SetScriptValueCommand(m,p,"source",e))},300))}),v.getWrapperElement().addEventListener("keydown",function(e){e.stopPropagation()});var y=[],T=[],O=function(s,l){var c,u=[];return v.operation(function(){for(;0<y.length;)v.removeLineClass(y.shift(),"background","errorLine");for(;0<T.length;)v.removeLineWidget(T.shift());switch(l||v.mode){case"javascript":try{var e=esprima.parse(s,{tolerant:!0});u=e.errors}catch(i){u.push({lineNumber:i.lineNumber-1,message:i.message})}for(var t=0;t<u.length;t++){(i=u[t]).message=i.message.replace(/Line [0-9]+: /,"")}break;case"json":u=[],jsonlint.parseError=function(e,t){e=e.split("\n")[3],u.push({lineNumber:t.loc.first_line-1,message:e})};try{jsonlint.parse(s)}catch(i){}break;case"glsl":var o=ShaderCode.ParseGLSL(s);O(o.js,"javascript");try{glslprep.parseGlsl(o.vs,glslprep.Shader.VERTEX)}catch(i){i instanceof glslprep.SyntaxError&&u.push({lineNumber:i.line,message:"Syntax Error: "+i.message})}try{glslprep.parseGlsl(o.fs,glslprep.Shader.FRAGMENT)}catch(i){i instanceof glslprep.SyntaxError&&u.push({lineNumber:i.line,message:"Syntax Error: "+i.message})}if(0!==u.length)break;if(d instanceof TONG.WebGLRenderer==!1)break;c=!0}for(t=0;t<u.length;t++){var i=u[t],a=document.createElement("div");a.className="esprima-error",a.textContent=i.message;var n=Math.max(i.lineNumber,0);y.push(n),v.addLineClass(n,"background","errorLine");var r=v.addLineWidget(n,a);T.push(r)}return void 0!==c?c:0===u.length})},N=new CodeMirror.TernServer({caseInsensitive:!0,plugins:{tongjs:null}});return v.setOption("extraKeys",{"Ctrl-P":function(e){N.complete(e)},"Ctrl-I":function(e){N.showType(e)},"Ctrl-O":function(e){N.showDocs(e)},"Alt-.":function(e){N.jumpToDef(e)},"Alt-,":function(e){N.jumpBack(e)},"Ctrl-Q":function(e){N.rename(e)},"Ctrl-.":function(e){N.selectName(e)},"Ctrl-S":function(e){s.saveScript.dispatch(e)},"Command-S":function(e){s.saveScript.dispatch(e)}}),v.on("cursorActivity",function(e){"javascript"===i&&N.updateArgHints(e)}),v.on("keypress",function(e,t){if("javascript"===i){var o=String.fromCharCode(t.which||t.keyCode);/[\w\.]/.exec(o)&&N.complete(e)}}),s.editorCleared.add(function(){l.setDisplay("none")}),s.editScript.add(function(e,t){var o,i,a;if("object"==typeof t)o="javascript",i=t.name,a=t.source,u.setValue(e.name+" / "+i);else{switch(t){case"vertexShader":o="glsl",i="Vertex Shader",a=e.material.vertexShader||"";break;case"fragmentShader":o="glsl",i="Fragment Shader",a=e.material.fragmentShader||"";break;case"programInfo":o="json",i="Program Properties";var n={defines:e.material.defines,uniforms:e.material.uniforms,attributes:e.material.attributes};a=JSON.stringify(n,null,"\t")}u.setValue(e.material.name+" / "+i)}p=t,m=e,l.setDisplay(""),v.setValue(a),v.clearHistory(),"json"===o&&(o={name:"javascript",json:!0}),v.setOption("mode",o)}),v.setValue(t),s.scriptRemoved.add(function(e){p===e&&l.setDisplay("none")}),this.isClose=!1,this.codeEditorObject={title:u,container:l,codeMirror:v},this.codeEditorObject},TONG.Script.templates={},TONG.Script.templates.script=function(e){return"//"+e+"\n\n\n this.Start=function()\n{\n}\n\n this.Update=function(e)\n{\n\t//scene refresh();\n}"},TONG.Script.prototype=Object.create(TONG.Component.prototype),TONG.Script.prototype.constructor=TONG.Script,extendClass(TONG.Script,TONG.Resource),TONG.Script.prototype.resource_type=TONG.Resource.TYPE.Script,TONG.RM.registerResourceClass(TONG.Script),TONG.Component.addExtraMethods(TONG.Script),TONG.Script.prototype.serialize=function(e){return null==this.uuid&&(this.uuid=TONG.Math.generateUUID()),{uuid:this.uuid,title:this.title,filename:this.filename,fullpath:this.fullpath,resource_type:TONG.Resource.TYPE.Script,data:this._data}},TONG.Script.prototype.clone=function(){var e=new TONG.Script,t=FileNameHelper.GetNextFileName(this.filename);return e.title=e.filename=e.fullpath=t,e.setData(this.getData()),e.resource_type=TONG.Resource.TYPE.Script,e.uuid=TONG.Math.generateUUID(),e};var ShadersManager={default_xml_url:"data/shaders.xml",snippets:{},shader_blocks:new Map,compiled_programs:{},compiled_shaders:{},global_shaders:{},templates:{},default_shader:null,dump_compile_errors:!0,on_compile_error:null,num_shaderblocks:0,init:function(e,t){this.default_shader=null,this.compiled_programs={},this.compiled_shaders={},this.global_shaders={},this.global_extra_code=String.fromCharCode(10)+"#define WEBGL"+String.fromCharCode(10),(2==gl.webgl_version||gl.extensions.OES_standard_derivatives)&&(this.global_extra_code="#define STANDARD_DERIVATIVES"+String.fromCharCode(10)),(2==gl.webgl_version||gl.extensions.WEBGL_draw_buffers)&&(this.global_extra_code="#define DRAW_BUFFERS"+String.fromCharCode(10)),this.createDefaultShaders(),this.default_shader=this.get("flat"),e=e||this.default_xml_url,this.last_shaders_url=e,this.loadFromXML(e,!1,t)},reloadShaders:function(e){this.loadFromXML(this.last_shaders_url,!0,!0,e)},resolve:function(e){return this.get(e.name,e.macros)},clearCache:function(){this.compiled_programs={},this.compiled_shaders={}},get:function(e,t){if(!e)return this.default_shader;if(!t&&(s=this.compiled_programs[e]))return s;var o=this.global_shaders[e];if(null==o)return this.default_shader;var i=e+":",a="";if(0!=o.num_macros)for(var n in t)o.macros[n]&&(i+=n+"="+t[n]+":",a+=String.fromCharCode(10)+"#define "+n+" "+t[n]+String.fromCharCode(10));var r=i.hashCode();if(null!=this.compiled_programs[r])return this.compiled_programs[r];this.debug&&getTime();var s,l=a+o.vs_code,c=a+o.fs_code;if(o.imports){var u={},d=function(e){var t=e.split('"')[1];if(u[t])return"//already imported: "+t+"\n";var o=ShadersManager.snippets[t];return u[t]=!0,o?o.code:"//snippet not found: "+t+"\n"};l=l.replace(/#import\s+\"(\w+)\"\s*\n/g,d),u={},c=c.replace(/#import\s+\"(\w+)\"\s*\n/g,d)}return(s=this.compileShader(l,c,i))&&(s.global=o),this.debug,this.registerCompiledShader(s,r,e)},getGlobalShaderInfo:function(e){return this.global_shaders[e]},compileShader:function(t,o,i){if(!i)throw"compileShader must have a name specified";if(!gl)return null;var e=null;try{t=this.global_extra_code+t,o=this.global_extra_code+o;var a=this.compiled_shaders[i+":VS"];a||(a=this.compiled_shaders[i+":VS"]=GL.Shader.compileSource(gl.VERTEX_SHADER,t));var n=this.compiled_shaders[i+":FS"];n||(n=this.compiled_shaders[i+":FS"]=GL.Shader.compileSource(gl.FRAGMENT_SHADER,o));getTime();e=new GL.Shader(a,n),this.debug,e.name=i}catch(e){return this.dump_compile_errors&&(this.dumpShaderError(i,e,t,o),this.dump_compile_errors=!1),this.on_compile_error&&this.on_compile_error(e),null}return e},dumpShaderError:function(e,t,o,i){var a=(this.global_extra_code+o).split("\n");for(var n in a);for(var n in a=(this.global_extra_code+i).split("\n"));},registerCompiledShader:function(e,t,o){return null==e?(this.compiled_programs[t]=this.default_shader,this.default_shader):(e.id=o,e.key=t,this.compiled_programs[t]=e)},loadFromXML:function(e,t,o,i){var a=o?"?nocache="+getTime()+Math.floor(1e3*Math.random()):"";LS.Network.request({url:e+a,dataType:"xml",success:function(e){t&&(LS.ShadersManager.global_shaders={},LS.ShadersManager.compiled_programs={},LS.ShadersManager.compiled_shaders={}),LS.ShadersManager.processShadersXML(e),i&&i()},error:function(e){throw"Error parsing Shaders XML: "+e}})},processShadersXML:function(e){var t=e.querySelectorAll("shader");for(var o in t){var i=t[o];if(i&&i.attributes)if(v=i.attributes.id){v=v.value;var a="",n="",r="",s=i.attributes.macros;s&&(r+=s.value);var l=i.querySelector("macros");l&&(r+=l.textContent);var c=r.split(","),u={};for(var o in c)u[c[o].trim()]=!0;if(a=i.querySelector("code[type='vertex_shader']").textContent,n=i.querySelector("code[type='pixel_shader']").textContent,a&&n){var d={},h=i.getAttribute("multipass");h&&(d.multipass="1"==h||"true"==h);var p=i.getAttribute("imports");p&&(d.imports="1"==p||"true"==p);var m=i.getAttribute("events");m&&(d.events="1"==m||"true"==m),LS.ShadersManager.registerGlobalShader(a,n,v,u,d)}}}var g=e.querySelectorAll("snippet");for(o=0;o<g.length;++o){var f=g[o],v=f.getAttribute("id"),y=f.textContent;this.registerSnippet(v,y)}var T=e.querySelectorAll("template");for(o=0;o<T.length;++o){var O=T[o],N=(v=O.getAttribute("id"),a=O.querySelector("code[type='vertex_shader']").textContent,n=O.querySelector("code[type='fragment_shader']").textContent,this.processTemplateCode(a)),G=this.processTemplateCode(n);O[v]={id:v,vs_info:N,fs_info:G}}this.ready=!0,this.on_ready&&this.on_ready(),LEvent.trigger(this,"ready")},registerGlobalShader:function(e,t,o,i,a){var n=0;for(var r in i)n+=1;gl&&!gl.extensions.WEBGL_draw_buffers&&(t=t.replace("#extension GL_EXT_draw_buffers : enable",""));var s={vs_code:e,fs_code:t,macros:i,num_macros:n};if(a){for(var r in a)s[r]=a[r];if(a.events){var l=function(e){e.split('"')[1];return""};s.vs_code=e.replace(/#event\s+\"(\w+)\"\s*\n/g,l),s.fs_code=t.replace(/#event\s+\"(\w+)\"\s*\n/g,l)}}return this.global_shaders[o]=s,LEvent.trigger(LS.ShadersManager,"newShader"),s},registerSnippet:function(e,t){this.snippets[e]={id:e,code:t}},getSnippet:function(e){return this.snippets[e]},registerShaderBlock:function(e,t){var o=-1;o=this.shader_blocks.get(e)?this.shader_blocks.get(e).flag_id:this.num_shaderblocks++,t.flag_id=o,t.flag_mask=1<<o,this.shader_blocks.set(o,t),this.shader_blocks.set(e,t)},getShaderBlock:function(e){return this.shader_blocks.get(e)},common_vscode:"\n\t\tprecision mediump float;\n\t\tattribute vec3 a_vertex;\n\t\tattribute vec3 a_normal;\n\t\tattribute vec2 a_coord;\n\t\tuniform mat4 u_model;\n\t\tuniform mat4 u_viewprojection;\n\t",common_fscode:"\n\t\tprecision mediump float;\n\t",createDefaultShaders:function(){this.registerGlobalShader(this.common_vscode+"\t\t\tvoid main() {\t\t\t\tmat4 mvp = u_viewprojection * u_model;\t\t\t\tgl_Position = mvp * vec4(a_vertex,1.0);\t\t\t}\t\t\t",this.common_fscode+"\t\t\tuniform vec4 u_material_color;\t\t\tvoid main() {\t\t\t  gl_FragColor = vec4(u_material_color);\t\t\t}\t\t","flat"),this.registerGlobalShader(this.common_vscode+"\t\t\tvarying vec2 v_uvs;\t\t\tvoid main() {\n\t\t\t\tv_uvs = a_coord;\n\t\t\t\tmat4 mvp = u_viewprojection * u_model;\t\t\t\tgl_Position = mvp * vec4(a_vertex,1.0);\t\t\t}\t\t\t",this.common_fscode+"\t\t\tuniform vec4 u_material_color;\t\t\tvarying vec2 v_uvs;\t\t\tuniform sampler2D texture;\t\t\tvoid main() {\t\t\t\tgl_FragColor = u_material_color * texture2D(texture,v_uvs);\t\t\t}\t\t","texture_flat"),this.registerGlobalShader(this.common_vscode+"\t\t\tvarying vec2 coord;\t\t\tvoid main() {\t\t\tcoord = a_coord;\t\t\tgl_Position = vec4(coord * 2.0 - 1.0, 0.0, 1.0);\t\t}\t\t",this.common_fscode+"\t\t\tuniform sampler2D texture;\t\t\tuniform vec4 color;\t\t\tvarying vec2 coord;\t\t\tvoid main() {\t\t\tgl_FragColor = texture2D(texture, coord) * color;\t\t\t}\t\t","screen")},processTemplateCode:function(e){for(var t={},o=[],i=[],a=(e=e.replace(/(\/\*([\s\S]*?)\*\/)|(\/\/(.*)$)/gm,"")).split("\n"),n=0;n<a.length;n++){var r=a[n].trim();if(r.length)if("#"==r[0]){var s=r.split(" ");if("#pragma"==s[0])switch(s[1]){case"import":i.length&&(o.push(["code",i.join("\n")]),i=[]),o.push(["import",s[3]]);break;case"hook":i.length&&(o.push(["code",i.join("\n")]),i=[]),t[s[3]],t[s[3]]=o.length,o.push(["hook",s[3]]);break;default:i.push(r)}else i.push(r)}else i.push(r)}return{code:e,parts:o,hooks:t}}};function ShaderQuery(e,t){if(this.name=e,this.macros={},this.hooks={},t)for(var o in t)this.macros[o]=t[o]}function ShaderBlock(e){if(this.dependency_blocks=[],this.flag_id=-1,this.flag_mask=0,!e)throw"ShaderBlock must have a name";if(-1!=e.indexOf(" "))throw"ShaderBlock name cannot have spaces: "+e;this.name=e,this.code_map=new Map,this.context_macros=null}function GLSLCode(e){this.code=e,this.blocks=[],this.pragmas={},this.uniforms={},this.attributes={},this.includes={},this.snippets={},this.shader_blocks={},this.is_dynamic=!1,e&&this.parse()}TONG.SM=TONG.ShadersManager=ShadersManager,ShaderQuery.prototype.clear=function(){this.macros={},this.hooks={}},ShaderQuery.prototype.add=function(e){if(e)for(var t in e.macros)this.macros[t]=e.macros[t]},ShaderQuery.prototype.setMacro=function(e,t){this.macros[e]=t||""},ShaderQuery.prototype.resolve=function(){return TONG.ShadersManager.resolve(this)},TONG.ShaderQuery=ShaderQuery,ShaderBlock.prototype.defineContextMacros=function(e){this.context_macros=e},ShaderBlock.prototype.addCode=function(e,t,o,i){t=t||"",o=o||"";var a={enabled:new TONG.GLSLCode(t),disabled:new TONG.GLSLCode(o),macros:i};this.code_map.set(e,a)},ShaderBlock.prototype.getFinalCode=function(e,t,o){t=t||0;var i=this.code_map.get(e);if(!i)return null;var a=(t&this.flag_mask?i.enabled:i.disabled).getFinalCode(e,t,o);if(i.macros){var n="";for(var r in i.macros)n+="#define "+r+i.macros[r]+"\n";a=n+a}return a},ShaderBlock.prototype.register=function(){LS.ShadersManager.registerShaderBlock(this.name,this)},ShaderBlock.prototype.checkDependencies=function(e){},TONG.ShaderBlock=ShaderBlock,TONG.GLSLCode=GLSLCode,GLSLCode.pragma_methods={},GLSLCode.CODE=1,GLSLCode.PRAGMA=2,GLSLCode.INCLUDE=1,GLSLCode.SHADERBLOCK=2,GLSLCode.SNIPPET=3,GLSLCode.prototype.parse=function(){var e=this.code.replace(/(\/\*([\s\S]*?)\*\/)|(\/\/(.*)$)/gm,"");this.fragments=[],this.pragmas={},this.uniforms={},this.streams={},this.includes={},this.snippets={},this.shader_blocks={},this.is_dynamic=!1;for(var t=[],o=e.split("\n"),i=0;i<o.length;i++){var a=o[i].trim();if(a.length)if("#"==a[0]){var n=a.split(" ");if("#pragma"==n[0]){var r;(r=t.join("\n")).trim()&&this.fragments.push({type:GLSLCode.CODE,code:r}),this.is_dynamic=!0,this.pragmas[n[2]]=!0;var s=n[1];t.length=0;var l={type:GLSLCode.PRAGMA,line:a,action:s,param:n[2]},c=TONG.GLSLCode.pragma_methods[s];if(!c||!c.parse)continue;if(!1===c.parse.call(this,l,n))continue;this.fragments.push(l)}else t.push(a)}else{var u=a.split(" ");if("uniform"==u[0]){var d=u[2].split(";");this.uniforms[d[0]]=u[1]}else if("attribute"==u[0]){d=u[2].split(";");this.attributes[d[0]]=u[1]}t.push(a)}}t.length&&((r=t.join("\n")).trim()&&this.fragments.push({type:GLSLCode.CODE,code:r}));return!0},GLSLCode.prototype.getFinalCode=function(e,t,o){if(!this.is_dynamic)return this.code;var i="";o=o||{};for(var a=this.fragments,n=0;n<a.length;++n){var r=a[n];if(r.type!==GLSLCode.CODE){var s=GLSLCode.pragma_methods[r.action];if(s&&s.getCode){var l=s.getCode.call(this,e,r,t,o);l&&(i+=l)}}else i+=r.code}return i},GLSLCode.pragma_methods.include={parse:function(e,t){if(!t[2])return!1;e.action_type=GLSLCode.INCLUDE;var o=t[2].substr(1,t[2].length-2).split(":"),i=o[0],a=o[1];e.include=i,e.include_subfile=a,this.includes[e.include]=!0},getCode:function(e,t,o,i){var a="",n=t.include;if(TONG.ResourcesManager.getExtension(n)){var r=TONG.ResourcesManager.getResource(n,TONG.ShaderCode);if(!r)return TONG.ResourcesManager.load(n),null;if(t.include_subfile){var s=r._subfiles[t.include_subfile];if(void 0===s)return null;a="\n"+s+"\n"}else a="\n"+r._subfiles[""]+"\n"}else{var l=TONG.ShadersManager.getSnippet(n);if(!l)return null;a="\n"+l.code+"\n"}return a}},GLSLCode.pragma_methods.define={parse:function(e,t){var o=t[2],i=t[3];if(!o||!i)return!1;e.define=[o,i.substr(1,i.length-2)]},getCode:function(e,t,o,i){i[t.define[0]]=t.define[1]}},GLSLCode.pragma_methods.shaderblock={parse:function(e,t){if(!t[2])return!1;e.action_type=GLSLCode.SHADERBLOCK;var o=t[2];'"'==o[0]?(e.shader_block=[1,o.substr(1,o.length-2)],this.shader_blocks[e.shader_block[1]]=!0):(e.shader_block=[2,o],t[3]&&(e.shader_block.push(t[3].substr(1,t[3].length-2)),this.shader_blocks[e.shader_block[2]]=!0))},getCode:function(e,t,o,i){var a=t.shader_block[1];if(2==t.shader_block[0]&&!(a=i[a]?i[a]:t.shader_block[2]))return null;var n=TONG.ShadersManager.getShaderBlock(a);if(!n)return null;var r=n.getFinalCode(e,o,i);return r?n.flag_mask&o?"\n#define BLOCK_"+n.name.toUpperCase()+"\n"+r+"\n":r+"\n":null}},GLSLCode.pragma_methods.snippet={parse:function(e,t){if(!t[2])return!1;e.action_type=GLSLCode.SNIPPET;var o=t[2].substr(1,t[2].length-2);e.snippet=o,this.snippets[o]=!0},getCode:function(e,t,o,i){var a=TONG.ShadersManager.getSnippet(t.snippet);return a?"\n"+a.code+"\n":null}},GLSLCode.breakLines=function(e){for(var t=[],o=0;o<e.length;o++){var i=e[o].trim();if(i){var a=i.lastIndexOf(";");if(-1==a||a==e.length-1)t.push(i);else for(var n=i.split(";"),r=0;r<n.length;++r)n[r]&&t.push(n[r]+";")}}return t};var ShaderCode=function(e){this._code=null,this._data={},this._functions={},this._global_uniforms={},this._global_defines={},this._global_attributes={},this._global_extensions={},this._code_parts={},this._code_js={},this._subfiles={},this._compiled_shaders={},this._shaderblock_flags_num=0,this._shaderblock_flags={},this._version=0,e&&(this.code=e)};ShaderCode.help_url="https://github.com/jagenjo/litescene.js/blob/master/guides/shaders.md",ShaderCode.CODE=1,ShaderCode.PRAGMA=2,ShaderCode.INCLUDE=1,ShaderCode.SHADERBLOCK=2,ShaderCode.SNIPPET=3,Object.defineProperty(ShaderCode.prototype,"code",{enumerable:!0,get:function(){return this._code},set:function(e){this._code!=e&&(this._code=e,this.processCode())}}),Object.defineProperty(ShaderCode.prototype,"version",{enumerable:!1,get:function(){return this._version},set:function(e){}}),ShaderCode.prototype.processFileAtlas=function(e,t){for(var o=e.split("\n"),i={},a=[],n="",r=0,s=o.length;r<s;r++){var l=t?o[r]:o[r].trim();l.length&&("\\"==l[0]?(a.length&&(i[n]=a.join("\n")),a.length=0,n=l.substr(1)):a.push(l))}return a.length&&(i[n]=a.join("\n")),i},ShaderCode.prototype.processCode=function(){var code=this._code;this._global_uniforms={},this._global_defines={},this._global_attributes={},this._global_extensions={},this._code_parts={},this._code_js="function run(){var Extention={};var Define={};var Attribute={};var Uniforms={};",this._compiled_shaders={},this._functions={},this._shaderblock_flags_num=0,this._shaderblock_flags={},this._shaderblock_vars=null,this._has_error=!1;var subfiles=this.processFileAtlas(this._code);this._subfiles=subfiles;var num_subfiles=0,init_code=null;for(var i in subfiles){var subfile_name=i,subfile_data=subfiles[i];if(num_subfiles++,subfile_name)if("js"!=subfile_name){var name=TONG.ResourcesManager.removeExtension(subfile_name);"default"==name&&(name="color");var extension=TONG.ResourcesManager.getExtension(subfile_name);if("vs"==extension||"fs"==extension){var code_part=this._code_parts[name];code_part||(code_part=this._code_parts[name]={});var glslcode=new GLSLCode(subfile_data);for(var j in glslcode.blocks){var pragma_info=glslcode.blocks[j];pragma_info&&pragma_info.type==ShaderCode.PRAGMA&&(pragma_info.shader_block_flag=this._shaderblock_flags_num,this._shaderblock_flags[pragma_info.shader_block]=pragma_info.shader_block_flag,this._shaderblock_flags_num+=1)}code_part[extension]=glslcode}}else{init_code=subfile_data,this._code_js+=init_code;var combindFunc=combindStrFunction(this._code_js),compileJs=eval(combindFunc),shaderInfo=compileJs;for(var attr in shaderInfo)"Extention"!=attr&&"Define"!=attr&&"Attribute"!=attr&&"Uniforms"!=attr&&(shaderInfo.Uniforms[attr]=shaderInfo[attr]);this._global_attributes=shaderInfo.Attribute,this._global_extensions=shaderInfo.Extention,this._global_defines=shaderInfo.Defines;var resUniforms={};for(var uniKey in shaderInfo.Uniforms)resUniforms[uniKey]={value:shaderInfo.Uniforms[uniKey]};this._global_uniforms=resUniforms}}var shader=this.getShader();if(shader){if(init_code&&(init_code=TONG.ShaderCode.removeComments(init_code),init_code))if(LS.catch_exceptions)try{this._functions.init=new Function(init_code)}catch(e){LS.dispatchCodeError(e,LScript.computeLineFromError(e),this)}else this._functions.init=new Function(init_code);this.validatePublicUniforms(shader),TONG.Event.trigger(TONG.ShaderCode,"modified",this),this._version+=1}},ShaderCode.prototype.setData=function(e,t){this.code=e,t||(this._modified=!0)},ShaderCode.prototype.getData=function(){return this.code},ShaderCode.prototype.getDataToStore=function(){return this.code},ShaderCode.prototype.getShader=function(e,t){if(this._has_error)return null;e=e||"template",t=t||0;var o=this._compiled_shaders[e];if(o){var i=o.get(t);if(i)return i}var a=this._code_parts[e];if(!a)return null;for(var n={},r=0;r<TONG.ShadersManager.num_shaderblocks;++r){if(t&1<<r)if((d=TONG.ShadersManager.shader_blocks.get(r))&&d.context_macros)for(var s in d.context_macros)n[s]=d.context_macros[s]}var l=null;if("fx"==e)l=ShaderCode.SCREEN_VERTEX_SHADER;else{if(!a.vs)return null;l=a.vs.getFinalCode(ShaderCode.VERTEX_SHADER,t,n)}if(a.fs){var c=a.fs.getFinalCode(ShaderCode.FRAGMENT_SHADER,t,n);if(!l||!c)return this._has_error=!0,null;if(!i)return null;if(EditorModule.Debug){var u=[];for(r=0;r<TONG.ShadersManager.num_shaderblocks;++r){var d;if(t&1<<r)(d=TONG.ShadersManager.shader_blocks.get(r))&&u.push(d)}i._shadercode_info={vs:l,fs:c,context:n,blocks:u,flags:t}}return this._compiled_shaders[e]||(this._compiled_shaders[e]=new Map),this._compiled_shaders[e].set(t,i),i}},ShaderCode.prototype.compileShader=function(t,o){if(this._has_error)return null;if(EditorModule.Debug,!LS.catch_exceptions)return new GL.Shader(t,o);try{return new GL.Shader(t,o)}catch(e){this._has_error=!0,LS.ShadersManager.dumpShaderError(this.filename,e,t,o);var i=GL.Shader.parseError(e,t,o),a=(i.line_number,this._code.split("\n")),n=-1;if(i.line_code){for(var r=i.line_code.trim(),s=0;s<a.length;++s)a[s]=a[s].trim();n=a.indexOf(r)}LS.dispatchCodeError(e,n,this,"shader")}return null},ShaderCode.prototype.validatePublicUniforms=function(e){if(!e)throw"ShaderCode: Shader cannot be null";for(var t in this._global_uniforms){var o=this._global_uniforms[t];e.uniformInfo[o.uniform]||(info.disabled=!0)}},ShaderCode.prototype.register=function(){TONG.ResourcesManager.registerResource(this.fullpath||this.filename,this)},ShaderCode.prototype.applyToMaterials=function(e){e=e||LS.GlobalScene;var t=this.fullpath||this.filename;for(var o in LS.ResourcesManager.resources){var i=LS.ResourcesManager.resources[o];i.constructor===LS.ShaderMaterial&&i._shader==t&&i.processShaderCode()}var a=e.getNodes();for(o=0;o<a.length;++o){var n=a[o];n.material&&n.material.constructor===LS.ShaderMaterial&&n.material._shader==t&&n.material.processShaderCode()}},ShaderCode.prototype.hasEditableText=function(){return!0},ShaderCode.removeComments=function(e){return e.replace(/(\/\*([\s\S]*?)\*\/)|(\/\/(.*)$)/gm,"")},ShaderCode.parseShaderLab=function(e){for(var t={},o=t,i=[],a=[],n=0,r="",s=ShaderCode.removeComments(e).split("\n"),l=0;l<s.length;++l){var c=s[l].trim(),u=c.match(/[^\s"]+|"([^"]*)"/gi);if(u)if(0==n)for(var d=0;d<u.length;++d){var h;if("{"==(h=u[d]))o[(p={name:i[0],params:i.slice(1).join(" "),content:{}}).name]=p,i=[],a.push(o),o=p.content;else if("}"==h){if(0==a.length)return null;i.length&&(o[i[0]]=i.join(" "),i=[]),o=a.pop()}else if("{}"==h){var p;o[(p={name:i[0],params:i.slice(1).join(" "),content:{}}).name]=p,i=[]}else"GLSLPROGRAM"==h||"CGPROGRAM"==h?(n="GLSLPROGRAM"==h?1:2,r=""):i.push(h)}else"ENDGLSL"==(h=u[0].trim())||"ENDCG"==h?(n=0,o.codetype=n,o.code=r,r=""):r+=c+"\n"}return t},ShaderCode.flat_code="\\color.vs\n\tprecision mediump float;\n\tattribute vec3 a_vertex;\n\tuniform mat4 u_model;\n\tuniform mat4 u_viewprojection;\n\tvoid main() {\n\t\tvec4 vertex4 = vec4(a_vertex,1.0);\n\t\tgl_Position = (u_viewprojection * u_model) * vertex4;\n\t}\n\\color.fs\n\tprecision mediump float;\n\tuniform vec4 u_material_color;\n\tvoid main() {\n\t\tgl_FragColor = u_material_color;\n\t}\n\\picking.vs\n\tprecision mediump float;\n\tattribute vec3 a_vertex;\n\tuniform mat4 u_model;\n\tuniform mat4 u_viewprojection;\n\tvoid main() {\n\t\tvec4 vertex4 = vec4(a_vertex,1.0);\n\t\tgl_Position = (u_viewprojection * u_model) * vertex4;\n\t}\n\\picking.fs\n\tprecision mediump float;\n\tuniform vec4 u_material_color;\n\tvoid main() {\n\t\tgl_FragColor = u_material_color;\n\t}\n\\shadow.vs\n\tprecision mediump float;\n\tattribute vec3 a_vertex;\n\tuniform mat4 u_model;\n\tuniform mat4 u_viewprojection;\n\tvoid main() {\n\t\tvec4 vertex4 = vec4(a_vertex,1.0);\n\t\tgl_Position = (u_viewprojection * u_model) * vertex4;\n\t}\n\\shadow.fs\n\tprecision mediump float;\n\tuniform vec4 u_material_color;\n\tvoid main() {\n\t\tgl_FragColor = u_material_color;\n\t}\n",TONG.ShaderCode=ShaderCode,extendClass(TONG.ShaderCode,TONG.Resource),TONG.ShaderCode.prototype.resource_type=TONG.Resource.TYPE.ShaderCode,TONG.ShaderCode.prototype.serialize=function(e){return{uuid:this.uuid,title:this.title,filename:this.filename,fullpath:this.fullpath,resource_type:TONG.Resource.TYPE.ShaderCode,data:this._data}},TONG.ShaderCode.prototype.clone=function(){var e=new TONG.ShaderCode,t=FileNameHelper.GetNextFileName(this.filename);e.fullpath=e.filename=t,e.uuid=TONG.Math.generateUUID(),e.data=e.code=this._data;for(var o=TONG.RM.getResourceByType(TONG.Resource.TYPE.Material),i=0;i<o.length;i++)if(o[i]instanceof TONG.ShaderMaterial&&o[i].editorTarget){var a=o[i].editorTarget.shader.getValue(),n=o[i].editorTarget.shader.addElement(e.filename);o[i].editorTarget.shaderWidget&&o[i].editorTarget.shaderWidget.setOptionValues(n,a)}return e},ShaderCode.ParseGLSL=function(e,t){for(var o=e.split("\n"),i={},a=!1,n="",r=!1,s="",l=!1,c="",u=0,d=o.length;u<d;u++){var h=t?o[u]:o[u].trim();"\\js"==h||a?"\\js"!=h||a?a&&("\\"==h[0]&&-1!=h.lastIndexOf(".vs")&&(r=!0),r?"\\"==h[0]&&-1!=h.lastIndexOf(".vs")?(n+="\n",s+="\n",c+="\n"):("\\"==h[0]&&-1!=h.lastIndexOf(".fs")&&(l=!0),l?"\\"==h[0]&&-1!=h.lastIndexOf(".fs")?(n+="\n",s+="\n",c+="\n"):(n+="\n",s+="\n",c+=h+"\n"):(n+="\n",s+=h+"\n",c+="\n")):(n+=h+"\n",s+="\n",c+="\n")):(a=!0,n+=h="\n",s+=h,c+=h):(n+=h="\n",s+=h,c+=h)}return i.js=n,i.vs=s,i.fs=c,i},TONG.RM.registerResourceClass(TONG.ShaderCode),ShaderCode.VERTEX_SHADER=glslprep.Shader.VERTEX,ShaderCode.FRAGMENT_SHADER=glslprep.Shader.FRAGMENT,ShaderCode.DEFAULT_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec3 a_normal;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec3 v_position;\n\t\t\tvarying vec3 v_normal;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform mat4 u_model;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tvoid main() {\n\t\t\t\tv_position = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\tv_normal = (u_model * vec4(a_normal,0.0)).xyz;\n\t\t\t\tv_coord = a_coord;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\n\t\t\t",ShaderCode.SCREEN_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() { \n\t\t\t\tv_coord = a_coord; \n\t\t\t\tgl_Position = vec4(a_coord * 2.0 - 1.0, 0.0, 1.0); \n\t\t\t}\n\t\t\t",ShaderCode.SCREEN_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t",ShaderCode.SCREEN_FRAGMENT_FX="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvarying vec2 v_coord;\n\t\t\t#ifdef FX_UNIFORMS\n\t\t\t\tFX_UNIFORMS\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = v_coord;\n\t\t\t\tvec4 color = texture2D(u_texture, uv);\n\t\t\t\t#ifdef FX_CODE\n\t\t\t\t\tFX_CODE ;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\n\t\t\t",ShaderCode.SCREEN_COLORED_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t",ShaderCode.BLEND_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_texture2;\n\t\t\tuniform float u_factor;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = mix( texture2D(u_texture, v_coord), texture2D(u_texture2, v_coord), u_factor);\n\t\t\t}\n\t\t\t",ShaderCode.SCREEN_FLAT_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color;\n\t\t\t}\n\t\t\t",ShaderCode.QUAD_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec2 u_position;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform mat3 u_transform;\n\t\t\tvoid main() { \n\t\t\t\tvec3 pos = vec3(u_position + vec2(a_coord.x,1.0 - a_coord.y)  * u_size, 1.0);\n\t\t\t\tv_coord = a_coord; \n\t\t\t\tpos = u_transform * pos;\n\t\t\t\tpos.z = 0.0;\n\t\t\t\t//normalize\n\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t}\n\t\t\t",ShaderCode.QUAD_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t",ShaderCode.QUAD2_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tuniform vec4 u_texture_area;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t    vec2 uv = vec2( mix(u_texture_area.x, u_texture_area.z, v_coord.x), 1.0 - mix(u_texture_area.w, u_texture_area.y, v_coord.y) );\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, uv);\n\t\t\t}\n\t\t\t",ShaderCode.PRIMITIVE2D_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform mat3 u_transform;\n\t\t\tvoid main() { \n\t\t\t\tvec3 pos = a_vertex;\n\t\t\t\tpos = u_transform * pos;\n\t\t\t\tpos.z = 0.0;\n\t\t\t\t//normalize\n\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t}\n\t\t\t",ShaderCode.FLAT_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tvoid main() { \n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0); \n\t\t\t}\n\t\t\t",ShaderCode.FLAT_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color;\n\t\t\t}\n\t\t\t",TONG.ShaderCode.examples={},TONG.ShaderCode.examples.default=function(e){return"\n\n\\js\n\n\n\n\n\n \n\\"+e+".vs\n\nvoid main() {\n    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}\n\\"+e+".fs\n\nvoid main() {\n    gl_FragColor = vec4(1.0,0.0,0.0,1.0 );\n}\n"},TONG.ShaderCode.examples.UseUniform=function(e){return"\n\n\\js\n\n\n\n\nvar time=0 \n\n\n\\"+e+".vs\n\nuniform float time;\nvarying vec3 vPosition;\nvoid main() {\n    vPosition = position;\n    vPosition.x += sin( time + vPosition.z * 4.0 ) / 4.0;\n    vPosition.y += cos( time + vPosition.z * 4.0 ) / 4.0;\n    gl_Position = projectionMatrix * modelViewMatrix * vec4( vPosition, 1.0 );\n}\n\\"+e+".fs\n\nvarying vec3 vPosition;\nvoid main() {\n    gl_FragColor = vec4( vPosition * 2.0, 1.0 );\n}\n"},TONG.ShaderCode.examples.UseDefine=function(e){return"\n        \n        \\js\n        \n\n\n\nDefine.FOO=15 \n\n        \n        \\"+e+".vs\n\nvarying vec3 vPosition;\nvoid main() {\n    vPosition = position;\n    vPosition.x += sin( time + vPosition.z * 4.0 ) / 4.0;\n    vPosition.y += cos( time + vPosition.z * 4.0 ) / 4.0;\n    vPosition.z=FOO;\n    gl_Position = projectionMatrix * modelViewMatrix * vec4( vPosition, 1.0 );\n}\n\\"+e+".fs\n\nvarying vec3 vPosition;\nvoid main() {\n    gl_FragColor = vec4( vPosition * 2.0, 1.0 );\n}\n"};var InspectorPanel=function(i){var a=i.signals;LiteGUI.init(),(EditorModule.inspector=this).container=new UI.Panel,this.container.setId("Inspector");var n=new UI.Panel;n.setClass("Content"),n.setId("ComponentContent"),this.container.add(n),this.componentWidgets=new LiteGUI.Inspector,n.dom.appendChild(this.componentWidgets.root),LiteGUI.createDropArea(n.dom,this.onItemDrop.bind(this));var r=this;this.refreshInspector=function(e){if(null!==e){InspectorPanel.ClearContent(),r.componentWidgets.clear();for(var t=0;t<e.getComponents().length;t++){var o=e.getComponents()[t];r.showComponent(o,r.componentWidgets)}r.componentWidgets.addSection(),r.componentWidgets.addButton(null,GetLanguage("Add component"),{callback:function(e){EditorModule.showAddComponentToNode(i.selected,function(){a.objectSelected.dispatch(i.selected)})}}),n.setDisplay(""),AnimationModule.attachKeyframesBehaviour(r.componentWidgets)}else InspectorPanel.ClearContent()},a.objectSelected.add(function(e){r.refreshInspector(e)}),this.showComponent=function(e,t){if(e){e.constructor;e.onInspectorTitle&&(e.onInspectorTitle(),t.root.appendChild(e.inspector.root)),e.onInspectorGUI&&e.onInspectorGUI(i)}},InspectorPanel.ClearContent()};InspectorPanel.prototype.onRefresh=function(e){this.componentWidgets.refresh()},InspectorPanel.prototype.onItemDrop=function(e){var t=e.dataTransfer.getData("uid"),o=e.dataTransfer.getData("class"),i=e.dataTransfer.getData("res-fullpath"),a=e.dataTransfer.getData("res-type"),n=null;if(i&&(n=TONG.ResourcesManager.resources[i],this.instance&&this.instance.constructor===TONG.SceneNode)){var r=null;TONG.RM.getExtension(i);switch(a){case"Script":r=new TONG.Components.ScriptFromFile({filename:i});break;case"Mesh":r=new TONG.Components.MeshRenderer({mesh:i});break;case"Prefab":this.instance.prefab=i,this.inspector.refresh()}if(r)return this.instance.addComponent(r),n&&TONG.ResourcesManager.load(i),void this.inspector.refresh()}if(o)switch(o){case"SceneNode":n=TONG.GlobalScene.getNode(t);break;case"Material":n=TONG.ResourcesManager.getMaterial(t);break;default:TONG.Components[o]?n=TONG.GlobalScene.findComponentByUId(t):TONG.MaterialClasses[o]&&(n=TONG.ResourcesManager.getMaterial(t))}n&&this.inspect(n)};var InspectorNone=function(){TONG.Component.call(this),this.title=GetLanguage("Inspector"),this.helpIcon="",this.settingsIcon=""};InspectorNone.prototype=Object.create(TONG.Component.prototype),InspectorNone.prototype.constructor=InspectorNone,InspectorPanel.ClearContent=function(){EditorModule.inspector.componentWidgets.clear(),EditorModule.inspector.showComponent(new InspectorNone,EditorModule.inspector.componentWidgets)};var Entity=function(e){TONG.Component.call(this),this.title=GetLanguage("Transform"),this.icon="css/pic/inspector/3d.png",this.helpUrl="http://showdoc.tong3d.com";var t=this;this.isSelectedObject=!0,this.name=new TONG.Value({value:e.name,alias:GetLanguage("name"),callback:function(e){TONG.Event.trigger(EditorModule.target.scene,"node_name_changed",t.root)}}),this.visible=new TONG.Value({value:e.visible,alias:GetLanguage("visible")}),this.position=new TONG.Value({value:e.position,alias:GetLanguage("position")}),this.rotation=new TONG.Value({value:e.rotation,alias:GetLanguage("rotation")}),this.scale=new TONG.Value({value:e.scale,alias:GetLanguage("scale")})};Entity.prototype=Object.create(TONG.Component.prototype),Entity.prototype.constructor=Entity,TONG.Object3D.prototype.registerComponents=[Entity];var SceneEntity=function(e){TONG.Component.call(this),this.title=GetLanguage("Scene"),this.icon="css/pic/inspector/scene.png",this.helpUrl="http://showdoc.tong3d.com";var t=this,o=null;this.isSelectedObject=!0,this.name=new TONG.Value({value:e.name,alias:GetLanguage("name"),callback:function(e){TONG.Event.trigger(EditorModule.target.scene,"node_name_changed",t.root)}}),this.OnInspectorAwake=function(){o=this._root.Sky,this.distance=new TONG.Value({must:!0,min:800,value:o.distance,alias:GetLanguage("sunDistance"),callback:function(e){o.distance=e,o.updateSky()}}),this.inclination=new TONG.Value({must:!0,min:-1,step:.01,max:1,value:o.inclination,alias:GetLanguage("inclination"),callback:function(e){o.inclination=e,o.updateSky()}}),this.azimuth=new TONG.Value({must:!0,min:0,max:1,step:.01,value:o.azimuth,alias:GetLanguage("azimuth"),callback:function(e){o.azimuth=e,o.updateSky()}}),this.turbidity=new TONG.Value({must:!0,min:1,max:20,value:o.turbidity,alias:GetLanguage("turbidity"),callback:function(e){o.turbidity=e,o.updateSky()}}),this.rayleigh=new TONG.Value({must:!0,min:0,max:4,step:.01,value:o.rayleigh,alias:GetLanguage("rayleigh"),callback:function(e){o.rayleigh=e,o.updateSky()}}),this.luminance=new TONG.Value({must:!0,min:0,max:1.1,step:.01,value:o.luminance,alias:GetLanguage("luminance"),callback:function(e){o.luminance=e,o.updateSky()}}),this.mieCoefficient=new TONG.Slider(o.mieCoefficient,{must:!0,min:0,max:.1,step:.001,alias:GetLanguage("mieCoefficient"),callback:function(e){o.mieCoefficient=e,o.updateSky()}}),this.mieDirectionalG=new TONG.Slider(o.mieDirectionalG,{must:!0,min:0,max:1,step:.001,alias:GetLanguage("mieDirectionalG"),callback:function(e){o.mieDirectionalG=e,o.updateSky()}}),this.castShadow=new TONG.Value({must:!0,value:o.sun.castShadow,alias:GetLanguage("castShadow"),callback:function(e){o.sun.castShadow=e}}),this.intensity=new TONG.Value({must:!0,min:0,max:1,value:o.sun.intensity,alias:GetLanguage("intensity"),callback:function(e){o.sun.intensity=e}})}};SceneEntity.prototype=Object.create(TONG.Component.prototype),SceneEntity.prototype.constructor=SceneEntity,TONG.Scene.prototype.registerComponents=[SceneEntity];var Model=function(){TONG.Component.call(this),this.title=GetLanguage("Model"),this.icon="css/pic/inspector/model.png",this.helpUrl="http://showdoc.tong3d.com",this.isSelectedObject=!0;this.material=new Material,this.material.isNested=!0,this.geometry=new Geometry,this.geometry.isNested=!0,this.castShadow=new TONG.Value({value:!0,alias:GetLanguage("castShadow")}),this.receiveShadow=new TONG.Value({value:!0,alias:GetLanguage("receiveShadow")})};Model.prototype=Object.create(TONG.Component.prototype),Model.prototype.constructor=Model,TONG.Mesh.prototype.registerComponents=[Entity,Model];var TextGeometry=function(){TONG.Component.call(this),this.title=GetLanguage("3DTextEditor"),this.icon="",this.helpUrl="",this.helpIcon="",this.settingsIcon="",this.collapsed=!0,this.isSelectedObject=!0;var t=this;this.fontAsset=new TONG.Value({must:!0,value:new TONG.FontAsset,alias:GetLanguage("font"),callback:function(e){e.data.font||e.data.loadTTF(),t.root.setFont(e.data)}}),this.bevel=new TONG.Value({value:!1,alias:GetLanguage("bevel"),callback:function(e){t.root.bevel=e,t.root.updateGeometry()}}),this.size=new TONG.Value({value:1,alias:GetLanguage("size"),callback:function(e){t.root.size=e,t.root.updateGeometry()}}),this.text=new TONG.Value({value:"text",alias:GetLanguage("text"),textarea:!0,callback:function(e){t.root.setText(e)}}),this.bevelThickness=new TONG.Value({value:.1,alias:GetLanguage("thickness"),callback:function(e){t.root.bevelThickness=e,t.root.updateGeometry()}}),this.bevelSize=new TONG.Value({value:.05,alias:GetLanguage("bevelSize"),callback:function(e){t.root.bevelSize=e,t.root.updateGeometry()}}),this.curveSegments=new TONG.Value({value:15,min:0,alias:GetLanguage("curve"),callback:function(e){t.root.curveSegments=e,t.root.updateGeometry()}}),this.height=new TONG.Value({value:.5,alias:GetLanguage("height"),callback:function(e){t.root.height=e,t.root.updateGeometry()}})};TextGeometry.prototype=Object.create(TONG.Component.prototype),TextGeometry.prototype.constructor=TextGeometry;var TextModel=function(){TONG.Component.call(this),this.title=GetLanguage("3D Text"),this.icon="css/pic/inspector/3dtext.png",this.helpUrl="http://showdoc.tong3d.com",this.isSelectedObject=!0;this.material=new Material,this.material.isNested=!0,this.geometry=new TextGeometry,this.geometry.isNested=!0,this.castShadow=new TONG.Value({value:!0,alias:GetLanguage("castShadow")}),this.receiveShadow=new TONG.Value({value:!0,alias:GetLanguage("receiveShadow")})};TextModel.prototype=Object.create(TONG.Component.prototype),TextModel.prototype.constructor=TextModel,TONG.Text3D.prototype.registerComponents=[Entity,TextModel];var SkeletalAnimation=function(e){TONG.Component.call(this),this.title=GetLanguage("SkeletalEditor"),this.icon="",this.helpUrl="",this.helpIcon="",this.settingsIcon="",this.collapsed=!0,this.isSelectedObject=!0};SkeletalAnimation.prototype=Object.create(TONG.Component.prototype),SkeletalAnimation.prototype.constructor=SkeletalAnimation;var SkinnedModel=function(e){TONG.Component.call(this),this.title=GetLanguage("SkinnedModel"),this.icon="css/pic/inspector/skinnedMesh.png",this.helpUrl="http://showdoc.tong3d.com",this.isSelectedObject=!0;this.material=new Material(e),this.material.isNested=!0,this.skeletal=new TONG.Value({value:new SkeletalAnimation(e),must:!0}),this.skeletal.value.isNested=!0,this.castShadow=new TONG.Value({value:!0,alias:GetLanguage("castShadow")}),this.receiveShadow=new TONG.Value({value:!0,alias:GetLanguage("receiveShadow")}),this.Awake=function(){this.skeletal.value.scene=this.scene,this.skeletal.value.Awake()},this.Update=function(e){this.skeletal.value.Update(e)}};SkinnedModel.prototype=Object.create(TONG.Component.prototype),SkinnedModel.prototype.constructor=SkinnedModel,SkinnedMesh.prototype.registerComponents=[Entity,SkinnedModel];var Geometry=function(){TONG.Component.call(this),this.title=GetLanguage("GeometryEditor"),this.icon="",this.helpUrl="",this.helpIcon="",this.settingsIcon="",this.collapsed=!0;var p=this;this.type=new TONG.Enum(["BoxBufferGeometry","CircleBufferGeometry","SphereBufferGeometry","CylinderBufferGeometry","PlaneBufferGeometry","TorusBufferGeometry","TorusKnotBufferGeometry","LatheBufferGeometry","IcosahedronGeometry"],{alias:GetLanguage("type"),callback:function(e){p.selected&&p.selected.geometry&&p.selected.geometry.type==e||function(e){if(p.selected&&p.selected.geometry){var t=null;switch(e){case"BoxBufferGeometry":t=new TONG.BoxBufferGeometry(1,1,1);break;case"CircleBufferGeometry":var o=1,i=32;t=new TONG.CircleBufferGeometry(o,i);break;case"SphereBufferGeometry":var o=1,a=16,n=0,r=2*Math.PI,s=Math.PI;t=new TONG.SphereBufferGeometry(o,32,a,n,r,0,s);break;case"CylinderBufferGeometry":var a=1;t=new TONG.CylinderBufferGeometry(1,1,2,32,a,!1);break;case"PlaneBufferGeometry":t=new TONG.PlaneBufferGeometry(2,2);break;case"TorusBufferGeometry":var o=2,l=1,c=32,u=12,d=2*Math.PI;t=new TONG.TorusBufferGeometry(o,l,c,u,d);break;case"TorusKnotBufferGeometry":var o=2,l=.8,u=64,c=12;t=new TONG.TorusKnotBufferGeometry(o,l,u,c,2,3);break;case"LatheBufferGeometry":var h=[new TONG.Vector2(0,0),new TONG.Vector2(4,0),new TONG.Vector2(3.5,.5),new TONG.Vector2(1,.75),new TONG.Vector2(.8,1),new TONG.Vector2(.8,4),new TONG.Vector2(1,4.2),new TONG.Vector2(1.4,4.8),new TONG.Vector2(2,5),new TONG.Vector2(2.5,5.4),new TONG.Vector2(3,12)],i=20,n=0,r=2*Math.PI;t=new TONG.LatheBufferGeometry(h,i,n,r);break;case"IcosahedronGeometry":var o=1;t=new TONG.IcosahedronGeometry(o,2)}p.editor.execute(new SetGeometryCommand(p.selected,t))}}(e)}}),this.OnInspectorAwake=function(){this.target=this.selected.geometry},this.OnInspectorStart=function(){this.geometryChange()},this.geometryChange=function(){if(this.selected&&this.selected.geometry){var e=this.selected.geometry;"BufferGeometry"===e.type||"Geometry"===e.type?new Sidebar.Geometry.Modifiers(this.editor,this.selected,this.inspector):void 0!==Sidebar.Geometry[e.type]&&new Sidebar.Geometry[e.type](this.editor,this.selected,this.inspector)}}};Geometry.prototype=Object.create(TONG.Component.prototype),Geometry.prototype.constructor=Geometry,TONG.NoneMaterial=function(e){TONG.Material.call(this),this.type="NoneMaterial",this.isNoneMaterial=!0,this.defines={},this.uniforms={},this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 1.0, 1.0 );\n}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},this.toJSON=function(){var e={};return e.uuid=this.uuid,e.type="NoneMaterial",e},(this.index0AttributeName=void 0)!==e&&(e.attributes,this.setValues(e))},TONG.NoneMaterial.prototype=Object.create(TONG.Material.prototype),TONG.NoneMaterial.prototype.constructor=TONG.NoneMaterial;var Material=function(){TONG.Component.call(this),this.title=GetLanguage("MaterialEditor"),this.icon="",this.helpIcon="",this.settingsIcon="",this.collapsed=!0,this.materials=null;var i=this;this.OnInspectorAwake=function(){i.target=i.selected.material;var e=[];if(i.target instanceof Array){for(var t=0;t<i.target.length;t++){(o=TONG.RM.getResource(i.target[t].name))&&(i.target[t]=i.selected.material[t]=o),e[t]=i.target[t]}1==i.target.length&&(i.target=i.selected.material=i.selected.material[0])}else{var o;(o=TONG.RM.getResource(i.target.name))&&(i.target=i.selected.material=o),e[0]=i.target}i.materials=new TONG.Value({alias:GetLanguage("materials"),must:!0,value:e,target:i.target,disabled:!0,default:e[0],data_type:TONG.Resource.TYPE.Material})}};function ReCompileShader(shader_target,editor_target,is_extend){var shaderTarget=shader_target,defines={},attributes={},extensions={},uniforms={},vertexShader=null,fragmentShader=null;null==editor_target.target.shader||shaderTarget.filename!=editor_target.target.shader||is_extend?(shaderTarget.processCode(),defines=shaderTarget._global_defines,attributes=shaderTarget._global_attributes,extensions=shaderTarget._global_extensions,uniforms=shaderTarget._global_uniforms):(defines=editor_target.target.defines,attributes=editor_target.target.defaultAttributeValues,extensions=editor_target.target.extensions,uniforms=editor_target.target.uniforms,vertexShader=editor_target.target.vertexShader,fragmentShader=editor_target.target.fragmentShader);var uniformsResult={};for(var key in editor_target.uniform?editor_target.uniform.inspector&&(editor_target.uniformWidget.removeChild(editor_target.uniform.inspector.root),editor_target.uniform.inspector=null,editor_target.uniform.isInit=!1):(editor_target.uniform=new UniformClass,editor_target.uniform.isNested=!0),editor_target.uniform)void 0===(new TONG.Component)[key]&&(editor_target.uniform[key]instanceof HTMLElement?editor_target.uniform[key]=void 0:is_extend?is_extend&&null==uniforms[key]&&(editor_target.uniform[key]=void 0):editor_target.uniform[key]=void 0);for(var key in uniforms){function applyUniformsToMat(key){if(null==editor_target.uniform[key])if(uniforms[key].value instanceof TONG.Enum){var value=uniforms[key].value.getValue();uniforms[key].value.isCompile&&(value=eval(value)),uniforms[key].value.callback=function(v){var value=v;uniforms[key].value.isCompile&&(value=eval(value)),editor_target.target.uniforms[key].value=value,EditorModule.target.changeResourceValue(editor_target.target,"uniforms."+key+".value",value)},uniformsResult[key]={},uniformsResult[key].value=value,editor_target.uniform[key]=uniforms[key].value}else if(uniforms[key].value instanceof TONG.Value){var value=uniforms[key].value.getValue();uniforms[key].value.callback=function(e){var t=e;editor_target.target.uniforms[key].value=t,EditorModule.target.changeResourceValue(editor_target.target,"uniforms."+key+".value",t)},uniformsResult[key]={},uniformsResult[key].value=value,editor_target.uniform[key]=uniforms[key].value}else{var value=new TONG.Value({value:uniforms[key].value,callback:function(e){var t=e;editor_target.target.uniforms[key].value=t,EditorModule.target.changeResourceValue(editor_target.target,"uniforms."+key+".value",t)}});uniformsResult[key]={},uniformsResult[key].value=uniforms[key].value,editor_target.uniform[key]=value}else{var vRes=editor_target.uniform[key].getValue();editor_target.uniform[key]instanceof TONG.Enum&&uniforms[key].value.isCompile&&(vRes=eval(editor_target.uniform[key].getValue())),uniformsResult[key]={},uniformsResult[key].value=vRes}}applyUniformsToMat(key)}if(isEmptyObject(uniforms)||editor_target.applyInit("uniform",editor_target.uniform),!vertexShader&&!fragmentShader){var runCount=0;for(var key in shaderTarget._code_parts){if(shaderTarget._code_parts[key].vs&&(runCount++,vertexShader=shaderTarget._code_parts[key].vs.code,2==runCount))break;if(shaderTarget._code_parts[key].fs&&(runCount++,fragmentShader=shaderTarget._code_parts[key].fs.code,2==runCount))break}vertexShader&&fragmentShader&&(removeSpace(editor_target.target.vertexShader)==removeSpace(vertexShader)&&removeSpace(editor_target.target.fragmentShader)==removeSpace(fragmentShader)||(editor_target.target.needsUpdate=!0,editor_target.target.defaultAttributeValues=attributes,editor_target.target.extensions=extensions,editor_target.target.defines=defines,editor_target.target.uniforms=uniformsResult,editor_target.target.vertexShader=vertexShader,editor_target.target.fragmentShader=fragmentShader,EditorModule.target.changeResourceValue(editor_target.target,{defaultAttributeValues:editor_target.target.defaultAttributeValues,extensions:editor_target.target.extensions,defines:editor_target.target.defines,uniforms:editor_target.target.uniforms,vertexShader:editor_target.target.vertexShader,fragmentShader:editor_target.target.fragmentShader})))}}Material.prototype=Object.create(TONG.Component.prototype),Material.prototype.constructor=Material;var MaterialClass=function(r){TONG.Component.call(this),this.title=GetLanguage("Material"),this.icon="imgs/components/mat_.png",this.helpIcon="",this.settingsIcon="",this.target=r;var s=this,l=r.name?"mat"!=TONG.RM.getExtension(r.name)?r.name+".mat":r.name:"";this.filename=new TONG.Value({alias:GetLanguage("Filename"),value:l,callback:function(e){var t=TONG.RM.getResource(l);if(t){if("mat"!=TONG.RM.getExtension(e)&&r instanceof TONG.Material&&(e+=".mat"),s.filenameWidget.setValue(e,!0),s.filename.setValue(e,!0),e!=l){r.name&&(r.name=e),TONG.MaterialClasses.unRegisterMaterialClass(s.target);var o=s.target.fullpath||s.target.filename,i=TONG.RM.getFolder(o),a=TONG.RM.getFilename(o),n=TONG.RM.cleanFullpath(i+"/"+e);TONG.RM.renameResource(a,n),l=n,TONG.MaterialClasses.registerMaterialClass(s.target),TONG.RM.resourceModified(s.target),EditorModule.target.changeResourceValue(r,{fullpath:n,filename:n,name:n}),DriveModule.refreshContent(),TONG.Components.onRenameComponent(a,n,t)}}else r.name&&(r.name=e)}}),this.shader=null,this.uniform=null,this.OnInspectorAwake=function(){if(this.target instanceof TONG.ShaderMaterial){for(var e=TONG.RM.getResourceByType(TONG.Resource.TYPE.ShaderCode),t=["default"],o=0;o<e.length;o++)t[o+1]=e[o].filename;this.shader=new TONG.Enum(t,{alias:GetLanguage("shader"),must:!0,callback:function(e){"default"!=e?ReCompileShader(TONG.RM.getResource(e),s):(s.shaderWidget.setOptionValues(s.shader.getNames()),s.shaderWidget.setValue("default"),s.uniformWidget.removeChild(s.uniform.inspector.root),s.uniform.inspector=null,s.uniform.isInit=!1,s.target.needsUpdate=!0,s.target.defaultAttributeValues={},s.target.extensions={},s.target.defines={},s.target.uniforms={},s.target.vertexShader="void main() {\n gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n}\n",s.target.fragmentShader="void main() {\n    gl_FragColor = vec4(1.0,0.0,0.0,1.0 );\n\n}\n"),EditorModule.target.changeResourceValue(s,{shader:"default"==s.shader.getValue()?null:s.shader.getValue(),defaultAttributeValues:s.target.defaultAttributeValues,extensions:s.target.extensions,defines:s.target.defines,uniforms:s.target.uniforms,vertexShader:s.target.vertexShader,fragmentShader:s.target.fragmentShader})}})}},this.OnInspectorStart=function(){null!=this.target.shader&&"default"!=this.target.shader&&this.shader.setValue(this.target.shader)},this.color=new TONG.Value({alias:GetLanguage("color"),value:new TONG.Color(1,1,1)}),this.roughness=new TONG.Value({alias:GetLanguage("roughness"),value:.5}),this.metalness=new TONG.Value({alias:GetLanguage("metalness"),value:.5}),this.emissive=new TONG.Value({alias:GetLanguage("emissive"),value:new TONG.Color(0,0,0)}),this.specular=new TONG.Value({alias:GetLanguage("specular"),value:new TONG.Color(1/16,1/16,1/16)}),this.shininess=new TONG.Value({alias:GetLanguage("shininess"),value:30}),this.clearCoat=new TONG.Value({alias:GetLanguage("clearCoat"),value:1}),this.clearCoatRoughness=new TONG.Value({alias:GetLanguage("clearCoatRoughness"),value:1}),this.vertexColors=new TONG.Enum(["TONG.NoColors","TONG.VertexColors","TONG.FaceColors"],{alias:GetLanguage("vertexColors"),isCompile:!0}),this.bumpScale=new TONG.Value({alias:GetLanguage("bumpScale"),value:1}),this.normalScale=new TONG.Value({alias:GetLanguage("normalScale"),value:1}),this.displacementScale=new TONG.Value({alias:GetLanguage("displacementScale"),value:1}),this.displacementBias=new TONG.Value({alias:GetLanguage("displacementBias"),value:0}),this.envMapIntensity=new TONG.Value({alias:GetLanguage("envMapIntensity"),value:1}),this.lightMapIntensity=new TONG.Value({alias:GetLanguage("lightMapIntensity"),value:1}),this.aoMapIntensity=new TONG.Value({alias:GetLanguage("aoMapIntensity"),value:1}),this.side=new TONG.Enum(["TONG.FrontSide","TONG.BackSide","TONG.DoubleSide"],{alias:GetLanguage("side"),isCompile:!0}),this.flatShading=new TONG.Value({alias:GetLanguage("flatShading"),value:!1}),this.blending=new TONG.Enum(["TONG.NoBlending","TONG.NormalBlending","TONG.AdditiveBlending","TONG.SubtractiveBlending","TONG.MultiplyBlending","TONG.CustomBlending"],{alias:GetLanguage("blending"),isCompile:!0}),this.transparent=new TONG.Value({alias:GetLanguage("transparent"),value:!1}),this.opacity=new TONG.Value({alias:GetLanguage("opacity"),value:1}),this.alphatest=new TONG.Value({alias:GetLanguage("alphatest"),value:0}),this.wireframe=new TONG.Value({alias:GetLanguage("wireframe"),value:!1}),this.wireframeLinewidth=new TONG.Value({alias:GetLanguage("wireframeLinewidth"),value:1}),this.map=new TONG.Value({alias:GetLanguage("map"),value:new TONG.Texture}),this.alphaMap=new TONG.Value({alias:GetLanguage("alphaMap"),value:new TONG.Texture}),this.normalMap=new TONG.Value({alias:GetLanguage("normalMap"),value:new TONG.Texture}),this.bumpMap=new TONG.Value({alias:GetLanguage("bumpMap"),value:new TONG.Texture}),this.displacementMap=new TONG.Value({alias:GetLanguage("displacementMap"),value:new TONG.Texture}),this.roughnessMap=new TONG.Value({alias:GetLanguage("roughnessMap"),value:new TONG.Texture}),this.metalnessMap=new TONG.Value({alias:GetLanguage("metalnessMap"),value:new TONG.Texture}),this.specularMap=new TONG.Value({alias:GetLanguage("specularMap"),value:new TONG.Texture}),this.envMap=new TONG.Value({alias:GetLanguage("envMap"),value:new TONG.Texture}),this.lightMap=new TONG.Value({alias:GetLanguage("lightMap"),value:new TONG.Texture}),this.aoMap=new TONG.Value({alias:GetLanguage("aoMap"),value:new TONG.Texture}),this.emissiveMap=new TONG.Value({alias:GetLanguage("emissiveMap"),value:new TONG.Texture}),this.dashSize=new TONG.Value({alias:GetLanguage("dashSize"),value:3}),this.gapSize=new TONG.Value({value:1,alias:GetLanguage("gapSize")}),this.linewidth=new TONG.Value({value:1,alias:GetLanguage("linewidth")})};MaterialClass.prototype=Object.create(TONG.Component.prototype),MaterialClass.prototype.constructor=MaterialClass;var UniformClass=function(){TONG.Component.call(this),this.title="Uniforms",this.icon="imgs/components/uniform.png",this.helpIcon="",this.settingsIcon=""};UniformClass.prototype=Object.create(TONG.Component.prototype),UniformClass.prototype.constructor=UniformClass,TONG.MaterialClasses={},TONG.MaterialClasses.registerMaterialClass=function(e){var t=null,o=null;e.is_material=!0,e instanceof TONG.Material?(o=(t=e).name,TONG.MaterialClasses[o]=t):(e.prototype.editorTarget=null,e.prototype.callEditorTarget=function(){return this.editorTarget||(this.editorTarget=new MaterialClass(this)),this.editorTarget},o=getMaterialName(t=new e),TONG.MaterialClasses[o]=e),TONG.RM.registerResourceClass(e),TONG.Event.trigger(TONG.MaterialClasses,"materialclass_registered",e)},TONG.MaterialClasses.unRegisterMaterialClass=function(e){var t=null;t=e instanceof TONG.Material?e.name:getMaterialName(new e),delete TONG.MaterialClasses[t],TONG.RM.registerResourceClass(e),TONG.Event.trigger(TONG.MaterialClasses,"materialclass_registered",e)},TONG.Material.prototype.toJSON=function(e){var t=void 0===e||"string"==typeof e;t&&(e={textures:{},images:{}});var o={metadata:{version:4.5,type:"Material",generator:"Material.toJSON"}};function i(e){var t=[];for(var o in e){var i=e[o];delete i.metadata,t.push(i)}return t}if(o.uuid=this.uuid,o.type=this.type,""!==this.name&&(o.name=this.name),this.color&&this.color.isColor&&(o.color=this.color.getHex()),void 0!==this.roughness&&(o.roughness=this.roughness),void 0!==this.metalness&&(o.metalness=this.metalness),this.emissive&&this.emissive.isColor&&(o.emissive=this.emissive.getHex()),1!==this.emissiveIntensity&&(o.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(o.specular=this.specular.getHex()),void 0!==this.shininess&&(o.shininess=this.shininess),void 0!==this.clearCoat&&(o.clearCoat=this.clearCoat),void 0!==this.clearCoatRoughness&&(o.clearCoatRoughness=this.clearCoatRoughness),this.map&&this.map.isTexture?o.map=this.map.toJSON(e).uuid:this.map&&this.map.isRenderTexture&&(o.map={uuid:this.map.uuid},this.map.isApplyTexture&&(o.map.isTexture=!0)),this.alphaMap&&this.alphaMap.isTexture?o.alphaMap=this.alphaMap.toJSON(e).uuid:this.alphaMap&&this.alphaMap.isRenderTexture&&(o.alphaMap={uuid:this.alphaMap.uuid},this.alphaMap.isApplyTexture&&(o.alphaMap.isTexture=!0)),this.lightMap&&this.lightMap.isTexture?o.lightMap=this.lightMap.toJSON(e).uuid:this.lightMap&&this.lightMap.isRenderTexture&&(o.lightMap={uuid:this.lightMap.uuid},this.lightMap.isApplyTexture&&(o.lightMap.isTexture=!0)),this.aoMap&&this.aoMap.isTexture?(o.aoMap=this.aoMap.toJSON(e).uuid,o.aoMapIntensity=this.aoMapIntensity):this.aoMap&&this.aoMap.isRenderTexture&&(o.aoMap={uuid:this.aoMap.uuid},this.aoMap.isApplyTexture&&(o.aoMap.isTexture=!0),o.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture?(o.bumpMap=this.bumpMap.toJSON(e).uuid,o.bumpScale=this.bumpScale):this.bumpMap&&this.bumpMap.isRenderTexture&&(o.bumpMap={uuid:this.bumpMap.uuid},this.bumpMap.isApplyTexture&&(o.bumpMap.isTexture=!0),o.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture?(o.normalMap=this.normalMap.toJSON(e).uuid,o.normalMapType=this.normalMapType,o.normalScale=this.normalScale.toArray()):this.normalMap&&this.normalMap.isRenderTexture&&(o.normalMap={uuid:this.normalMap.uuid},this.normalMap.isApplyTexture&&(o.normalMap.isTexture=!0),o.normalMapType=this.normalMapType,o.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture?(o.displacementMap=this.displacementMap.toJSON(e).uuid,o.displacementScale=this.displacementScale,o.displacementBias=this.displacementBias):this.displacementMap&&this.displacementMap.isRenderTexture&&(o.displacementMap={uuid:this.displacementMap.uuid},this.displacementMap.isApplyTexture&&(o.displacementMap.isTexture=!0),o.displacementScale=this.displacementScale,o.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture?o.roughnessMap=this.roughnessMap.toJSON(e).uuid:this.roughnessMap&&this.roughnessMap.isRenderTexture&&(o.roughnessMap={uuid:this.roughnessMap.uuid},this.roughnessMap.isApplyTexture&&(o.roughnessMap.isTexture=!0)),this.metalnessMap&&this.metalnessMap.isTexture?o.metalnessMap=this.metalnessMap.toJSON(e).uuid:this.metalnessMap&&this.metalnessMap.isRenderTexture&&(o.metalnessMap={uuid:this.metalnessMap.uuid},this.metalnessMap.isApplyTexture&&(o.metalnessMap.isTexture=!0)),this.emissiveMap&&this.emissiveMap.isTexture?o.emissiveMap=this.emissiveMap.toJSON(e).uuid:this.emissiveMap&&this.emissiveMap.isRenderTexture&&(o.emissiveMap={uuid:this.emissiveMap.uuid},this.emissiveMap.isApplyTexture&&o.emissiveMap.isTexture),this.specularMap&&this.specularMap.isTexture?o.specularMap=this.specularMap.toJSON(e).uuid:this.specularMap&&this.specularMap.isRenderTexture&&(o.specularMap={uuid:this.specularMap.uuid},this.specularMap.isApplyTexture&&(o.specularMap.isTexture=!0)),this.envMap&&this.envMap.isTexture?(o.envMap=this.envMap.toJSON(e).uuid,o.reflectivity=this.reflectivity):this.envMap&&this.envMap.isRenderTexture&&(o.envMap={uuid:this.envMap.uuid},this.envMap.isApplyTexture&&(o.envMap.isTexture=!0),o.reflectivity=this.reflectivity),this.gradientMap&&this.gradientMap.isTexture?o.gradientMap=this.gradientMap.toJSON(e).uuid:this.gradientMap&&this.gradientMap.isRenderTexture&&(o.gradientMap={uuid:this.gradientMap.uuid},this.gradientMap.isApplyTexture&&(o.gradientMap.isTexture=!0)),void 0!==this.size&&(o.size=this.size),void 0!==this.sizeAttenuation&&(o.sizeAttenuation=this.sizeAttenuation),this.blending!==TONG.NormalBlending&&(o.blending=this.blending),!0===this.flatShading&&(o.flatShading=this.flatShading),this.side!==TONG.FrontSide&&(o.side=this.side),this.vertexColors!==TONG.NoColors&&(o.vertexColors=this.vertexColors),this.opacity<1&&(o.opacity=this.opacity),!0===this.transparent&&(o.transparent=this.transparent),o.depthFunc=this.depthFunc,o.depthTest=this.depthTest,o.depthWrite=this.depthWrite,0!==this.rotation&&(o.rotation=this.rotation),1!==this.linewidth&&(o.linewidth=this.linewidth),void 0!==this.dashSize&&(o.dashSize=this.dashSize),void 0!==this.gapSize&&(o.gapSize=this.gapSize),void 0!==this.scale&&(o.scale=this.scale),!0===this.dithering&&(o.dithering=!0),0<this.alphaTest&&(o.alphaTest=this.alphaTest),!0===this.premultipliedAlpha&&(o.premultipliedAlpha=this.premultipliedAlpha),!0===this.wireframe&&(o.wireframe=this.wireframe),1<this.wireframeLinewidth&&(o.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(o.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(o.wireframeLinejoin=this.wireframeLinejoin),!0===this.morphTargets&&(o.morphTargets=!0),!0===this.skinning&&(o.skinning=!0),!1===this.visible&&(o.visible=!1),"{}"!==JSON.stringify(this.userData)&&(o.userData=this.userData),t){var a=i(e.textures),n=i(e.images);0<a.length&&(o.textures=a),0<n.length&&(o.images=n)}return o},TONG.Material.prototype.serialize=function(e){var t=this.toJSON(e);return t.filename=this.filename,t.fullpath=this.fullpath,this instanceof TONG.ShaderMaterial&&null!=this.shader&&(t.shader=this.shader),t.resource_type=TONG.Resource.TYPE.Material,t},TONG.Material.prototype.clone=function(){var e=(new this.constructor).copy(this),t=FileNameHelper.GetNextFileName(e.name);return e.fullpath=e.name=e.filename=t,e.resource_type=TONG.Resource.TYPE.Material,e.is_material=!0,e},TONG.MaterialClasses.registerMaterialClass(TONG.ShaderMaterial),TONG.MaterialClasses.registerMaterialClass(TONG.LineBasicMaterial),TONG.MaterialClasses.registerMaterialClass(TONG.LineDashedMaterial),TONG.MaterialClasses.registerMaterialClass(TONG.MeshBasicMaterial),TONG.MaterialClasses.registerMaterialClass(TONG.MeshDepthMaterial),TONG.MaterialClasses.registerMaterialClass(TONG.MeshLambertMaterial),TONG.MaterialClasses.registerMaterialClass(TONG.MeshNormalMaterial),TONG.MaterialClasses.registerMaterialClass(TONG.MeshPhongMaterial),TONG.MaterialClasses.registerMaterialClass(TONG.MeshPhysicalMaterial),TONG.MaterialClasses.registerMaterialClass(TONG.MeshStandardMaterial),TONG.MaterialClasses.registerMaterialClass(TONG.MeshToonMaterial),TONG.MaterialClasses.registerMaterialClass(TONG.PointsMaterial),TONG.MaterialClasses.registerMaterialClass(TONG.ShadowMaterial),TONG.MaterialClasses.registerMaterialClass(TONG.SpriteMaterial);var MenuBar=function(){this.newMenu=new TONG.Menu(GetLanguage("File/New"),function(){EditorModule.target.stopAutoSave(),$("#TransparentBackPanel").css("display",""),$("#scenesManagerPanel").css("display",""),ScenesManagerPanel.RefreshPanel(EditorModule.target)}),this.openMenu=new TONG.Menu(GetLanguage("File/Open"),{rule:!0,callback:function(){EditorModule.target.stopAutoSave(),$("#TransparentBackPanel").css("display",""),$("#scenesManagerPanel").css("display",""),ScenesManagerPanel.RefreshPanel(EditorModule.target)}});var t=document.createElement("input");function i(e,t){save(new Blob([e],{type:"text/plain"}),t)}function e(e,t,o){Utils.Building(EditorModule.target,t,o)}t.type="file",t.addEventListener("change",function(e){EditorModule.target.loader.loadFile(t.files[0])}),this.exportGeometry=new TONG.Menu(GetLanguage("File/Export Geometry"),function(){var e=EditorModule.target.selected;if(null!==e){var t=e.geometry;if(void 0!==t){var o=t.toJSON();try{o=(o=JSON.stringify(o,Utils.parseNumber,"\t")).replace(/[\n\t]+([\d\.e\-\[\]]+)/g,"$1")}catch(e){o=JSON.stringify(o)}i(o,"geometry.json")}else alert("The selected object doesn't have geometry.")}else alert("No object selected.")}),this.exportObject=new TONG.Menu(GetLanguage("File/Export Object"),function(){var e=EditorModule.target.selected;if(null!==e){var t=e.toJSON();try{t=(t=JSON.stringify(t,Utils.parseNumber,"\t")).replace(/[\n\t]+([\d\.e\-\[\]]+)/g,"$1")}catch(e){t=JSON.stringify(t)}i(t,"model.json")}else alert("No object selected")}),this.exportScene=new TONG.Menu(GetLanguage("File/Export Scene"),function(){var t=EditorModule.target.scene.toJSON();try{t=(t=JSON.stringify(t,Utils.parseNumber,"\t")).replace(/[\n\t]+([\d\.e\-\[\]]+)/g,"$1")}catch(e){t=JSON.stringify(t)}i(t,"scene.json")}),this.exportOBJ=new TONG.Menu(GetLanguage("File/Export OBJ"),function(){var e=EditorModule.target.selected;null!==e?i((new TONG.OBJExporter).parse(e),"model.obj"):alert("No object selected.")}),this.exportSTL=new TONG.Menu(GetLanguage("File/Export STL"),{rule:!0,callback:function(){i((new TONG.STLExporter).parse(EditorModule.target.scene),"model.stl")}}),this.buildCurrentScene=new TONG.Menu(GetLanguage("File/Build Current Scene"),function(){e(0,!1,!0)}),this.buildCurrentProject=new TONG.Menu(GetLanguage("File/Build Current Project"),function(){e(0,!0,!0)}),this.undo=new TONG.Menu(GetLanguage("Edit/Undo")+"(Ctrl+Z)",function(){EditorModule.target.undo()}),this.reUndo=new TONG.Menu(GetLanguage("Edit/Redo")+"(Ctrl+Shift+Z)",function(){EditorModule.target.redo()}),this.clearHistory=new TONG.Menu(GetLanguage("Edit/Clear History"),{rule:!0,callback:function(){confirm("The Undo/Redo History will be cleared. Are you sure?")&&EditorModule.target.history.clear()}}),this.clone=new TONG.Menu(GetLanguage("Edit/Clone"),function(){var e=EditorModule.target.selected;null!==e.parent&&(e=e.clone(),EditorModule.target.execute(new AddObjectCommand(e)))}),this.delete=new TONG.Menu(GetLanguage("Edit/Delete")+"(Del)",{rule:!0,callback:function(){var e=EditorModule.target.selected;!1!==confirm("Delete "+e.name+"?")&&(void 0!==e.parent&&EditorModule.target.execute(new RemoveObjectCommand(e)))}}),this.minifyShaders=new TONG.Menu(GetLanguage("Edit/Minify Shaders"),{rule:!1,callback:function(){var e=EditorModule.target.selected||EditorModule.target.scene,a=[],n=0,r=[];var s=[];e.traverse(function(t){var e=t.material;if(e instanceof TONG.ShaderMaterial)try{var o=glslprep.minifyGlsl([e.vertexShader,e.fragmentShader]);s.push(new SetMaterialValueCommand(t,"vertexShader",o[0])),s.push(new SetMaterialValueCommand(t,"fragmentShader",o[1])),++n}catch(e){var i=function e(t){r.length=0;var o=t.parent;return void 0!==o&&e(o),r.push(t.name||t.uuid),r}(t).join("/");e instanceof glslprep.SyntaxError?a.push(i+":"+e.line+":"+e.column+": "+e.message):a.push(i+": Unexpected error (see console for details).")}}),0<n&&EditorModule.target.execute(new MultiCmdsCommand(s),"Minify Shaders"),window.alert(n+" material(s) were changed.\n"+a.join("\n"))}});var a=0,o=0,n=0;EditorModule.target.signals.historyChanged.add(function(){var e=EditorModule.target.history;e.undos.length,e.redos.length}),EditorModule.target.signals.editorCleared.add(function(){n=o=a=0}),this.group=new TONG.Menu(GetLanguage("Add/Group"),{rule:!0,callback:function(){var e=new TONG.Group;e.name=GetLanguage("Group")+" "+ ++a,EditorModule.target.execute(new AddObjectCommand(e))}}),this.plane=new TONG.Menu(GetLanguage("Add/Plane"),function(){var e=new TONG.PlaneBufferGeometry(2,2),t=new TONG.MeshStandardMaterial,o=new TONG.Mesh(e,t);o.name=GetLanguage("Plane")+" "+ ++a,EditorModule.target.execute(new AddObjectCommand(o))}),this.box=new TONG.Menu(GetLanguage("Add/Box"),function(){var e=new TONG.BoxBufferGeometry(1,1,1),t=new TONG.Mesh(e,new TONG.MeshStandardMaterial);t.name=GetLanguage("Box")+" "+ ++a,EditorModule.target.execute(new AddObjectCommand(t))}),this.circle=new TONG.Menu(GetLanguage("Add/Circle"),function(){var e=new TONG.CircleBufferGeometry(1,32),t=new TONG.Mesh(e,new TONG.MeshStandardMaterial);t.name=GetLanguage("Circle")+" "+ ++a,EditorModule.target.execute(new AddObjectCommand(t))}),this.cylinder=new TONG.Menu(GetLanguage("Add/Cylinder"),function(){var e=new TONG.CylinderBufferGeometry(1,1,2,32,1,!1),t=new TONG.Mesh(e,new TONG.MeshStandardMaterial);t.name=GetLanguage("Cylinder")+" "+ ++a,EditorModule.target.execute(new AddObjectCommand(t))}),this.sphere=new TONG.Menu(GetLanguage("Add/Sphere"),function(){var e=2*Math.PI,t=Math.PI,o=new TONG.SphereBufferGeometry(1,32,16,0,e,0,t),i=new TONG.Mesh(o,new TONG.MeshStandardMaterial);i.name=GetLanguage("Sphere")+" "+ ++a,EditorModule.target.execute(new AddObjectCommand(i))}),this.icosahedron=new TONG.Menu(GetLanguage("Add/Icosahedron"),function(){var e=new TONG.IcosahedronGeometry(1,2),t=new TONG.Mesh(e,new TONG.MeshStandardMaterial);t.name=GetLanguage("Icosahedron")+" "+ ++a,EditorModule.target.execute(new AddObjectCommand(t))}),this.torus=new TONG.Menu(GetLanguage("Add/Torus"),function(){var e=2*Math.PI,t=new TONG.TorusBufferGeometry(2,1,32,12,e),o=new TONG.Mesh(t,new TONG.MeshStandardMaterial);o.name=GetLanguage("Torus")+" "+ ++a,EditorModule.target.execute(new AddObjectCommand(o))}),this.torusKnot=new TONG.Menu(GetLanguage("Add/TorusKnot"),function(){var e=new TONG.TorusKnotBufferGeometry(2,.8,64,12,2,3),t=new TONG.Mesh(e,new TONG.MeshStandardMaterial);t.name=GetLanguage("TorusKnot")+" "+ ++a,EditorModule.target.execute(new AddObjectCommand(t))}),this.lathe=new TONG.Menu(GetLanguage("Add/Lathe"),function(){var e=[new TONG.Vector2(0,0),new TONG.Vector2(4,0),new TONG.Vector2(3.5,.5),new TONG.Vector2(1,.75),new TONG.Vector2(.8,1),new TONG.Vector2(.8,4),new TONG.Vector2(1,4.2),new TONG.Vector2(1.4,4.8),new TONG.Vector2(2,5),new TONG.Vector2(2.5,5.4),new TONG.Vector2(3,12)],t=2*Math.PI,o=new TONG.LatheBufferGeometry(e,20,0,t),i=new TONG.Mesh(o,new TONG.MeshStandardMaterial({side:TONG.DoubleSide}));i.name=GetLanguage("Lathe")+" "+ ++a,EditorModule.target.execute(new AddObjectCommand(i))}),this.partical=new TONG.Menu(GetLanguage("Add/Partical"),{rule:!0,callback:function(){var e=new ParticleEmitter;e.name=GetLanguage("particle"),EditorModule.target.execute(new AddObjectCommand(e))}}),this.text3D=new TONG.Menu(GetLanguage("Add/3D Text"),function(){var e=new Text3D("text",Settings.defaultMaterial,Settings.defaultFont);e.name=GetLanguage("3D Text"),EditorModule.target.execute(new AddObjectCommand(e))}),this.pointLight=new TONG.Menu(GetLanguage("Add/PointLight"),function(){var e=new TONG.PointLight(16777215,1,0);e.name=GetLanguage("PointLight")+" "+ ++o,EditorModule.target.execute(new AddObjectCommand(e))}),this.spotLight=new TONG.Menu(GetLanguage("Add/SpotLight"),function(){var e=.1*Math.PI,t=new TONG.SpotLight(16777215,1,0,e,0);t.name=GetLanguage("SpotLight")+" "+ ++o,t.position.set(5,10,7.5),EditorModule.target.execute(new AddObjectCommand(t))}),this.directionLight=new TONG.Menu(GetLanguage("Add/DirectionalLight"),function(){var e=new TONG.DirectionalLight(16777215,1);e.name=GetLanguage("DirectionalLight")+" "+ ++o,e.position.set(5,10,7.5),EditorModule.target.execute(new AddObjectCommand(e))}),this.hemisphereLight=new TONG.Menu(GetLanguage("Add/HemisphereLight"),function(){var e=new TONG.HemisphereLight(43775,16755200,1);e.name=GetLanguage("HemisphereLight")+" "+ ++o,e.position.set(0,10,0),EditorModule.target.execute(new AddObjectCommand(e))}),this.ambientLight=new TONG.Menu(GetLanguage("Add/AmbientLight"),{rule:!0,callbak:function(){var e=new TONG.AmbientLight(2236962);e.name=GetLanguage("AmbientLight")+" "+ ++o,EditorModule.target.execute(new AddObjectCommand(e))}}),this.perspectiveCamera=new TONG.Menu(GetLanguage("Add/PerspectiveCamera"),function(){var e=new PerspectiveCamera(50,1,1,1e4);e.name=GetLanguage("PerspectiveCamera")+" "+ ++n,EditorModule.target.execute(new AddObjectCommand(e))}),this.orthographicCamera=new TONG.Menu(GetLanguage("Add/OrthographicCamera"),function(){var e=new OrthographicCamera;e.name=GetLanguage("OrthographicCamera")+" "+ ++n,EditorModule.target.execute(new AddObjectCommand(e))}),this.play=new TONG.Menu(GetLanguage("Play"),{rule:!0,callback:function(e){e.name==GetLanguage("Play")?EditorModule.target.signals.startPlayer.dispatch():EditorModule.target.signals.stopPlayer.dispatch()}}),this.help=new TONG.Menu(GetLanguage("Help"),function(){window.open("http://www.tongworld.cn/a/news/xingyezhishi","_blank")})},InspectorTypeSelectPanel=function(e,t,o){var i=new UI.Panel;i.setId("InspectorTypeSelectPanel"),i.setPosition("relative"),i.setHeight("90px");var a=Utils.Panel.Row(),n=new UI.Text("Type");n.setClass("type"),a.add(n);var r=new UI.Select;r.setOptions(t),r.setClass("typeSelect"),a.add(r);var s=new UI.Button("");s.setClass("typeEditBtn"),a.add(s);var l=new UI.Row,c=new UI.Button("");l.add(c),c.setClass("SelectIcon");var u=new UI.Text(o);u.setClass("TypeTargetName");var d=new UI.Button("");d.setClass("EditBtn");var h=new UI.Button("");h.setClass("DeleteBtn"),l.add(u),l.add(d),l.add(h);var p=new UI.Row,m=new UI.Button("Material Standard ( Material )");return m.setClass("SelectButton"),p.add(m),i.add(a),i.add(l),i.add(p),{container:i,typeSelect:r,typeEditBtn:s,selectBtn:m,matEditBtn:d}},LightComponent=function(){TONG.Component.call(this),this.title=GetLanguage("Light"),this.helpUrl="http://showdoc.tong3d.com",this.icon="css/pic/inspector/light.png",this.isSelectedObject=!0,this.type=new TONG.Enum(["AmbientLight","DirectionalLight","HemisphereLight","PointLight","RectAreaLight","SpotLight"],{alias:GetLanguage("type"),callback:function(e){if(this.selected.type!=e){var t=new TONG[e];t.name=this.selected.name,t.uuid=this.selected.uuid;for(var o=this.selected.position.clone(),i=this.selected.rotation.clone(),a=this.selected.scale.clone(),n=0;n<this.selected.getComponents().length;n++)t.addComponent(this.selected.getComponents()[n]);this.editor.execute(new RemoveObjectCommand(this.selected)),t.position.copy(o),t.rotation.copy(i),t.scale.copy(a),this.editor.execute(new AddObjectCommand(t)),this.refreshInspector()}}.bind(this)}),this.intensity=new TONG.Value({value:1,alias:GetLanguage("intensity")}),this.color=new TONG.Value({value:new TONG.Color(1,1,1),alias:GetLanguage("color")}),this.groundColor=new TONG.Value({value:new TONG.Color(1,1,1),alias:GetLanguage("groundColor")}),this.distance=new TONG.Value({value:100,alias:GetLanguage("distance")}),this.angle=new TONG.Value({value:45,alias:GetLanguage("angle")}),this.penumbra=new TONG.Value({value:1,alias:GetLanguage("penumbra")}),this.decay=new TONG.Value({value:1,alias:GetLanguage("decay")}),this.castShadow=new TONG.Value({value:!0,alias:GetLanguage("castShadow")}),this.receiveShadow=new TONG.Value({value:!0,alias:GetLanguage("receiveShadow")}),this.shadow=1};LightComponent.prototype=Object.create(TONG.Component.prototype),LightComponent.prototype.constructor=LightComponent,TONG.Light.prototype.registerComponents=[Entity,LightComponent];var CameraComponent=function(root){TONG.Component.call(this),this.title=GetLanguage("Camera"),this.helpUrl="http://showdoc.tong3d.com",this.icon="css/pic/inspector/camera.png";var that=this;this.isSelectedObject=!0,this.type=new TONG.Enum(["PerspectiveCamera","OrthographicCamera"],{callback:function(value){if(this.selected.type!=value){var cameraTarget=eval("new "+value);cameraTarget.name=this.selected.name,cameraTarget.uuid=this.selected.uuid;for(var objPos=this.selected.position.clone(),objRot=this.selected.rotation.clone(),objScale=this.selected.scale.clone(),i=0;i<this.selected.getComponents().length;i++)cameraTarget.addComponent(this.selected.getComponents()[i]);this.editor.execute(new RemoveObjectCommand(this.selected)),cameraTarget.position.copy(objPos),cameraTarget.rotation.copy(objRot),cameraTarget.scale.copy(objScale),this.editor.execute(new AddObjectCommand(cameraTarget)),this.refreshInspector()}}.bind(this),alias:GetLanguage("type")}),this.cameraTexture=new TONG.Value({must:!0,value:root.renderTexture,alias:GetLanguage("renderTexture"),callback:function(e){that._root.renderTexture=e}}),this.far=new TONG.Value({value:1e3,alias:GetLanguage("far")}),this.near=new TONG.Value({value:.01,alias:GetLanguage("near")}),this.fov=new TONG.Value({value:50,alias:GetLanguage("fov")}),this.layers=new TONG.Value({value:0,alias:GetLanguage("layers")}),this.filmOffset=new TONG.Value({value:0,alias:GetLanguage("filmOffset")}),this.filmGauge=new TONG.Value({value:35,alias:GetLanguage("filmGauge")}),this.zoom=new TONG.Value({value:1,alias:GetLanguage("zoom")}),this.offset=new TONG.Value({value:this._root.offset,alias:GetLanguage("offset")}),this.viewport=new TONG.Value({value:this._root.viewport,alias:GetLanguage("viewport")}),this.OnInspectorUpdate=function(){this.cameraTexture.value.uuid},this.Update=function(){this.cameraTexture.value.uuid}};CameraComponent.prototype=Object.create(TONG.Component.prototype),CameraComponent.prototype.constructor=CameraComponent,TONG.Camera.prototype.registerComponents=[Entity,CameraComponent];"use strict";function OrthographicCamera(e,t,o,i,a){TONG.OrthographicCamera.call(this,-1,1,1,-1,i,a),this.name="camera",this.size=null!=e?e:10,this.aspect=null!=t?t:1,this.mode=void 0!==o?o:OrthographicCamera.RESIZE_HORIZONTAL,this.offset=new TONG.Vector2(0,0),this.viewport=new TONG.Vector2(1,1),this.clearColor=!0,this.clearDepth=!0,this.clearStencil=!0,this.order=0,this.renderTexture=new TONG.RenderTexture,this.updateProjectionMatrix();var n=new RenderPass;n.renderToScreen=!0,this.composer=new EffectComposer,this.composer.addPass(n)}function PerspectiveCamera(e,t,o,i){this.offset=new TONG.Vector2(0,0),this.viewport=new TONG.Vector2(1,1),TONG.PerspectiveCamera.call(this,e,t,o,i),this.name="camera",this.clearColor=!0,this.clearDepth=!0,this.clearStencil=!0,this.order=0,this.renderTexture=new TONG.RenderTexture;var a=new RenderPass;a.renderToScreen=!0,this.composer=new EffectComposer,this.composer.addPass(a)}function CubeCamera(e,t,o,i){TONG.Object3D.call(this),this.name="cubecamera",this.type="CubeCamera",this.near=void 0!==e?e:.01,this.far=void 0!==t?t:1e4,this.resolution=void 0!==o?o:256,this.autoUpdate=void 0!==i&&i,this.cameras=[];for(var a=0;a<6;a++){var n=new TONG.PerspectiveCamera(90,1,this.near,this.far);(n.parent=this).cameras.push(n)}this.cameras[0].up.set(0,-1,0),this.cameras[0].lookAt(new TONG.Vector3(1,0,0)),this.cameras[1].up.set(0,-1,0),this.cameras[1].lookAt(new TONG.Vector3(-1,0,0)),this.cameras[2].up.set(0,0,1),this.cameras[2].lookAt(new TONG.Vector3(0,1,0)),this.cameras[3].up.set(0,0,-1),this.cameras[3].lookAt(new TONG.Vector3(0,-1,0)),this.cameras[4].up.set(0,-1,0),this.cameras[4].lookAt(new TONG.Vector3(0,0,1)),this.cameras[5].up.set(0,-1,0),this.cameras[5].lookAt(new TONG.Vector3(0,0,-1)),this.target=new TONG.WebGLRenderTargetCube(this.resolution,this.resolution,{format:TONG.RGBFormat,magFilter:TONG.LinearFilter,minFilter:TONG.LinearFilter}),this.cube=this.target.texture,this.cube.generateMipmaps=!1,this.cube.name="cube",this.scene=null,this.renderer=null}OrthographicCamera.prototype=Object.create(TONG.OrthographicCamera.prototype),OrthographicCamera.prototype.constructor=OrthographicCamera,OrthographicCamera.RESIZE_HORIZONTAL=0,OrthographicCamera.RESIZE_VERTICAL=1,OrthographicCamera.prototype.render=function(e,t){this.composer.render(e,t,this,.016),this.renderTexture.uuid&&e.render(t,this,this.renderTexture,!0)},OrthographicCamera.prototype.resize=function(e,t){this.composer.setSize(e*this.viewport.x,t*this.viewport.y);for(var o=0;o<this.children.length;o++)this.children[o].resize(e,t)},OrthographicCamera.prototype.destroy=function(){var e=this.getScene();null!==e&&e.removeCamera(this),TONG.Object3D.prototype.destroy.call(this)},OrthographicCamera.prototype.updateProjectionMatrix=function(){this.mode===OrthographicCamera.RESIZE_HORIZONTAL?(this.top=this.size/2,this.bottom=-this.top,this.right=this.top*this.aspect*(this.viewport.x/this.viewport.y),this.left=-this.right):this.mode===OrthographicCamera.RESIZE_VERTICAL&&(this.right=this.size/2,this.left=-this.right,this.top=this.right/this.aspect*(this.viewport.x/this.viewport.y),this.bottom=-this.top),TONG.OrthographicCamera.prototype.updateProjectionMatrix.call(this)},OrthographicCamera.prototype.toJSON=function(e){var t=TONG.OrthographicCamera.prototype.toJSON.call(this,e);return t.object.renderTexture=this.renderTexture.uuid?this.renderTexture.uuid:null,t.object.size=this.size,t.object.aspect=this.aspect,t.object.mode=this.mode,t.object.clearColor=this.clearColor,t.object.clearDepth=this.clearDepth,t.object.clearStencil=this.clearStencil,t.object.viewport=this.viewport.toArray(),t.object.offset=this.offset.toArray(),t.object.order=this.order,t.object.composer=this.composer.toJSON(),t},PerspectiveCamera.prototype=Object.create(TONG.PerspectiveCamera.prototype),PerspectiveCamera.prototype.constructor=PerspectiveCamera,PerspectiveCamera.prototype.render=function(e,t){this.composer.render(e,t,this,.016),this.renderTexture.uuid&&e.render(t,this,this.renderTexture,!0)},PerspectiveCamera.prototype.resize=function(e,t){this.composer.setSize(e*this.viewport.x,t*this.viewport.y);for(var o=0;o<this.children.length;o++)this.children[o].resize(e,t)},PerspectiveCamera.prototype.destroy=function(){var e=this.getScene();null!==e&&e.removeCamera(this),TONG.Object3D.prototype.destroy.call(this)},PerspectiveCamera.prototype.updateProjectionMatrix=function(){var e=this.near*Math.tan(.5*TONG.Math.DEG2RAD*this.fov)/this.zoom,t=2*e,o=this.aspect*t*this.viewport.x/this.viewport.y,i=-.5*o;0!==this.filmOffset&&(i+=this.near*this.filmOffset/this.getFilmWidth()),this.projectionMatrix.makePerspective(i,i+o,e,e-t,this.near,this.far)},PerspectiveCamera.prototype.toJSON=function(e){var t=TONG.PerspectiveCamera.prototype.toJSON.call(this,e);return t.object.renderTexture=this.renderTexture.uuid?this.renderTexture.uuid:null,t.object.clearColor=this.clearColor,t.object.clearDepth=this.clearDepth,t.object.clearStencil=this.clearStencil,t.object.viewport=this.viewport.toArray(),t.object.offset=this.offset.toArray(),t.object.order=this.order,t.object.composer=this.composer.toJSON(),t},TONG._CubeCamera=TONG.CubeCamera,TONG.CubeCamera=CubeCamera,CubeCamera.prototype=Object.create(TONG.Object3D.prototype),CubeCamera.prototype.initialize=function(){for(var e=this;null!==e.parent;)(e=e.parent)instanceof Scene?this.scene=e:e instanceof Program&&(this.renderer=e.renderer);TONG.Object3D.prototype.initialize.call(this)},CubeCamera.prototype.update=function(e){this.autoUpdate&&this.updateCubeMap(this.renderer,this.scene),TONG.Object3D.prototype.update.call(this,e)},CubeCamera.prototype.setResolution=function(e){this.resolution=e,this.target.setSize(e,e)},CubeCamera.prototype.updateCubeMap=function(e,t){var o=e.autoClear;e.autoClear=!0;for(var i=0;i<6;i++)this.cameras[i].updateMatrixWorld(),this.target.activeCubeFace=i,e.render(t,this.cameras[i],this.target);e.autoClear=o},CubeCamera.prototype.dispose=function(){TONG.Object3D.prototype.dispose.call(this)},CubeCamera.prototype.toJSON=function(e){var t=TONG.Object3D.prototype.toJSON.call(this,e);return t.object.near=this.near,t.object.far=this.far,t.object.resolution=this.resolution,t.object.autoUpdate=this.autoUpdate,t};var Bottom=function(e){var t=new UI.Panel;return t.setPosition("absolute"),t.setBottom("0px"),t.setHeight("20px"),t.setLeft("0px"),t.setRight("0px"),t.setBackgroundColor("#111"),t},AddAssetsMenubar=function(e){var t=new UI.Panel;t.setPosition("absolute"),t.setClass("menu"),t.setId("AddAssetsMenubar"),t.setDisplay("none");var o,i=new UI.Panel;return i.setClass("options"),t.add(i),(o=new UI.Row).setClass("option"),o.setTextContent("Folder"),o.setBackgroundImage("url(css/pic/folder.png)"),o.setBackgroundPosition("90% 50%"),o.setBackgroundRepeat("no-repeat"),o.onMouseDown(function(){Utils.AddAssets.Execute(AssetsType.folder)}),i.add(o),i.add(new UI.HorizontalRule),(o=new UI.Row).setClass("option"),o.setTextContent("Material"),o.onMouseDown(function(){Utils.AddAssets.Execute(AssetsType.mat)}),i.add(o),i.add(new UI.HorizontalRule),(o=new UI.Row).setClass("option"),o.setTextContent("JavaScript"),o.onMouseDown(function(){Utils.AddAssets.Execute(AssetsType.js)}),i.add(o),i.add(new UI.HorizontalRule),(o=new UI.Row).setClass("option"),o.setTextContent("Text"),o.onMouseDown(function(){Utils.AddAssets.Execute(AssetsType.text)}),i.add(o),i.add(new UI.HorizontalRule),(o=new UI.Row).setClass("option"),o.setTextContent("Shader"),o.onMouseDown(function(){Utils.AddAssets.Execute(AssetsType.shader)}),i.add(o),i.add(new UI.HorizontalRule),(o=new UI.Row).setClass("option"),o.setTextContent("Html"),o.onMouseDown(function(){Utils.AddAssets.Execute(AssetsType.html)}),i.add(o),i.add(new UI.HorizontalRule),(o=new UI.Row).setClass("option"),o.setTextContent("Css"),o.onMouseDown(function(){Utils.AddAssets.Execute(AssetsType.css)}),i.add(o),$(document).on("mousedown",function(e){var t=$("#AddAssetsMenubar").css("display");"addAssetsBtn"!=e.target.id&&"AddAssetsMenubar"!=e.target.id&&"none"!=t&&$("#AddAssetsMenubar").css("display","none")}),t},isRedo=!1,SetAssetsCommand=function(e){Command.call(this),this.type="AddAssetsCommand",this.name="Change Assets",this.assets=JSON.stringify(e),isRedo=!0};SetAssetsCommand.AssetsArray=[],SetAssetsCommand.prototype={execute:function(){this.editor.assets=JSON.parse(this.assets),SetAssetsCommand.AssetsArray.push(this.assets),this.editor.signals.assetsChange.dispatch(!isRedo,!1,this.editor.assets),this.editor.signals.assetsSave.dispatch(),isRedo=!1},undo:function(){var e=SetAssetsCommand.AssetsArray.indexOf(this.assets);-1!==e&&0<e&&(this.editor.assets=JSON.parse(SetAssetsCommand.AssetsArray[e-1]),this.editor.signals.assetsChange.dispatch(!1,!0,this.editor.assets),this.editor.signals.assetsSave.dispatch(),SetAssetsCommand.AssetsArray.splice(e,1))},toJSON:function(){var e=Command.prototype.toJSON.call(this);return e.assets=this.assets,e},fromJSON:function(e){Command.prototype.fromJSON.call(this,e),this.assets=e.assets}},function(e){"function"==typeof define&&define.amd?define(["jquery"],e):"object"==typeof exports?module.exports=e(require("jquery")):e(jQuery)}(function(e){var C=!1,_=!1,k=0,S=2e3,M=0,I=e,E=document,V=window,R=I(V),A=[],U=V.requestAnimationFrame||V.webkitRequestAnimationFrame||V.mozRequestAnimationFrame||!1,L=V.cancelAnimationFrame||V.webkitCancelAnimationFrame||V.mozCancelAnimationFrame||!1;if(U)V.cancelAnimationFrame||(L=function(e){});else{var n=0;U=function(e,t){var o=(new Date).getTime(),i=Math.max(0,16-(o-n)),a=V.setTimeout(function(){e(o+i)},i);return n=o+i,a},L=function(e){V.clearTimeout(e)}}var t,o,i,P=V.MutationObserver||V.WebKitMutationObserver||!1,j=Date.now||function(){return(new Date).getTime()},D={zindex:"auto",cursoropacitymin:0,cursoropacitymax:1,cursorcolor:"#424242",cursorwidth:"6px",cursorborder:"1px solid #fff",cursorborderradius:"5px",scrollspeed:40,mousescrollstep:27,touchbehavior:!1,emulatetouch:!1,hwacceleration:!0,usetransition:!0,boxzoom:!1,dblclickzoom:!0,gesturezoom:!0,grabcursorenabled:!0,autohidemode:!0,background:"",iframeautoresize:!0,cursorminheight:32,preservenativescrolling:!0,railoffset:!1,railhoffset:!1,bouncescroll:!0,spacebarenabled:!0,railpadding:{top:0,right:0,left:0,bottom:0},disableoutline:!0,horizrailenabled:!0,railalign:"right",railvalign:"bottom",enabletranslate3d:!0,enablemousewheel:!0,enablekeyboard:!0,smoothscroll:!0,sensitiverail:!0,enablemouselockapi:!0,cursorfixedheight:!1,directionlockdeadzone:6,hidecursordelay:400,nativeparentscrolling:!0,enablescrollonselection:!0,overflowx:!0,overflowy:!0,cursordragspeed:.3,rtlmode:"auto",cursordragontouch:!1,oneaxismousemode:"auto",scriptpath:(o=E.currentScript||!!(t=E.getElementsByTagName("script")).length&&t[t.length-1],i=o?o.src.split("?")[0]:"",0<i.split("/").length?i.split("/").slice(0,-1).join("/")+"/":""),preventmultitouchscrolling:!0,disablemutationobserver:!1,enableobserver:!0,scrollbarid:!1},B=!1,s=function(e,t){function o(){var e=y.doc.css(N.trstyle);return!(!e||"matrix"!=e.substr(0,6))&&e.replace(/^.*\((.*)\)$/g,"$1").replace(/px/g,"").split(/, +/)}function r(e,t,o){var i=e.css(t),a=parseFloat(i);if(isNaN(a)){var n=3==(a=h[i]||0)?o?y.win.outerHeight()-y.win.innerHeight():y.win.outerWidth()-y.win.innerWidth():1;return y.isie8&&a&&(a+=1),n?a:0}return a}function n(o,i,a,e){y._bind(o,i,function(e){var t={original:e=e||V.event,target:e.target||e.srcElement,type:"wheel",deltaMode:"MozMousePixelScroll"==e.type?0:1,deltaX:0,deltaZ:0,preventDefault:function(){return e.preventDefault?e.preventDefault():e.returnValue=!1,!1},stopImmediatePropagation:function(){e.stopImmediatePropagation?e.stopImmediatePropagation():e.cancelBubble=!0}};return"mousewheel"==i?(e.wheelDeltaX&&(t.deltaX=-.025*e.wheelDeltaX),e.wheelDeltaY&&(t.deltaY=-.025*e.wheelDeltaY),!t.deltaY&&!t.deltaX&&(t.deltaY=-.025*e.wheelDelta)):t.deltaY=e.detail,a.call(o,t)},e)}function s(e,t,o,i){y.scrollrunning||(y.newscrolly=y.getScrollTop(),y.newscrollx=y.getScrollLeft(),G=j());var a=j()-G;if(G=j(),350<a?b=1:b+=(2-b)/10,t=t*b|0,e=e*b|0){if(i)if(e<0){if(y.getScrollLeft()>=y.page.maxw)return!0}else if(y.getScrollLeft()<=0)return!0;var n=0<e?1:-1;v!==n&&(y.scrollmom&&y.scrollmom.stop(),y.newscrollx=y.getScrollLeft(),v=n),y.lastdeltax-=e}if(t){if(function(){var e=y.getScrollTop();if(t<0){if(e>=y.page.maxh)return!0}else if(e<=0)return!0}()){if(O.nativeparentscrolling&&o&&!y.ispage&&!y.zoomactive)return!0;var r=y.view.h>>1;y.newscrolly<-r?(y.newscrolly=-r,t=-1):y.newscrolly>y.page.maxh+r?(y.newscrolly=y.page.maxh+r,t=1):t=0}var s=0<t?1:-1;f!==s&&(y.scrollmom&&y.scrollmom.stop(),y.newscrolly=y.getScrollTop(),f=s),y.lastdeltay-=t}(t||e)&&y.synched("relativexy",function(){var e=y.lastdeltay+y.newscrolly;y.lastdeltay=0;var t=y.lastdeltax+y.newscrollx;y.lastdeltax=0,y.rail.drag||y.doScrollPos(t,e)})}function a(e,t,o){var i,a;return!(o||!w)||(0===e.deltaMode?(i=-e.deltaX*(O.mousescrollstep/54)|0,a=-e.deltaY*(O.mousescrollstep/54)|0):1===e.deltaMode&&(i=-e.deltaX*O.mousescrollstep*50/80|0,a=-e.deltaY*O.mousescrollstep*50/80|0),t&&O.oneaxismousemode&&0===i&&a&&(i=a,a=0,o&&(i<0?y.getScrollLeft()>=y.page.maxw:y.getScrollLeft()<=0)&&(a=i,i=0)),y.isrtlmode&&(i=-i),s(i,a,o,!0)?void(o&&(w=!0)):(w=!1,e.stopImmediatePropagation(),e.preventDefault()))}var y=this;this.version="3.7.4",this.name="nicescroll",this.me=t;var T=I("body"),O=this.opt={doc:T,win:!1};if(I.extend(O,D),O.snapbackspeed=80,e)for(var i in O)void 0!==e[i]&&(O[i]=e[i]);if(O.disablemutationobserver&&(P=!1),this.doc=O.doc,this.iddoc=this.doc&&this.doc[0]&&this.doc[0].id||"",this.ispage=/^BODY|HTML/.test(O.win?O.win[0].nodeName:this.doc[0].nodeName),this.haswrapper=!1!==O.win,this.win=O.win||(this.ispage?R:this.doc),this.docscroll=this.ispage&&!this.haswrapper?R:this.win,this.body=T,this.viewport=!1,this.isfixed=!1,this.iframe=!1,this.isiframe="IFRAME"==this.doc[0].nodeName&&"IFRAME"==this.win[0].nodeName,this.istextarea="TEXTAREA"==this.win[0].nodeName,this.forcescreen=!1,this.canshowonmouseevent="scroll"!=O.autohidemode,this.onmousedown=!1,this.onmouseup=!1,this.onmousemove=!1,this.onmousewheel=!1,this.onkeypress=!1,this.ongesturezoom=!1,this.onclick=!1,this.onscrollstart=!1,this.onscrollend=!1,this.onscrollcancel=!1,this.onzoomin=!1,this.onzoomout=!1,this.view=!1,this.page=!1,this.scroll={x:0,y:0},this.scrollratio={x:0,y:0},this.cursorheight=20,this.scrollvaluemax=0,"auto"==O.rtlmode){var l=this.win[0]==V?this.body:this.win,c=l.css("writing-mode")||l.css("-webkit-writing-mode")||l.css("-ms-writing-mode")||l.css("-moz-writing-mode");"horizontal-tb"==c||"lr-tb"==c||""===c?(this.isrtlmode="rtl"==l.css("direction"),this.isvertical=!1):(this.isrtlmode="vertical-rl"==c||"tb"==c||"tb-rl"==c||"rl-tb"==c,this.isvertical="vertical-rl"==c||"tb"==c||"tb-rl"==c)}else this.isrtlmode=!0===O.rtlmode,this.isvertical=!1;if(this.scrollrunning=!1,this.scrollmom=!1,this.observer=!1,this.observerremover=!1,(this.observerbody=!1)!==O.scrollbarid)this.id=O.scrollbarid;else for(;this.id="ascrail"+S++,E.getElementById(this.id););this.rail=!1,this.cursor=!1,this.cursorfreezed=!1,this.selectiondrag=!1,this.zoom=!1,this.zoomactive=!1,this.hasfocus=!1,this.hasmousefocus=!1,this.visibility=!0,this.railslocked=!1,this.locked=!1,this.hidden=!1,this.cursoractive=!0,this.wheelprevented=!1,this.overflowx=O.overflowx,this.overflowy=O.overflowy,this.nativescrollingarea=!1,this.checkarea=0,this.events=[],this.saved={},this.delaylist={},this.synclist={},this.lastdeltax=0,this.lastdeltay=0,this.detected=function(){if(B)return B;var e=E.createElement("DIV"),n=e.style,t=navigator.userAgent,o=navigator.platform,r={};return r.haspointerlock="pointerLockElement"in E||"webkitPointerLockElement"in E||"mozPointerLockElement"in E,r.isopera="opera"in V,r.isopera12=r.isopera&&"getUserMedia"in navigator,r.isoperamini="[object OperaMini]"===Object.prototype.toString.call(V.operamini),r.isie="all"in E&&"attachEvent"in e&&!r.isopera,r.isieold=r.isie&&!("msInterpolationMode"in n),r.isie7=r.isie&&!r.isieold&&(!("documentMode"in E)||7===E.documentMode),r.isie8=r.isie&&"documentMode"in E&&8===E.documentMode,r.isie9=r.isie&&"performance"in V&&9===E.documentMode,r.isie10=r.isie&&"performance"in V&&10===E.documentMode,r.isie11="msRequestFullscreen"in e&&11<=E.documentMode,r.ismsedge="msCredentials"in V,r.ismozilla="MozAppearance"in n,r.iswebkit=!r.ismsedge&&"WebkitAppearance"in n,r.ischrome=r.iswebkit&&"chrome"in V,r.ischrome38=r.ischrome&&"touchAction"in n,r.ischrome22=!r.ischrome38&&r.ischrome&&r.haspointerlock,r.ischrome26=!r.ischrome38&&r.ischrome&&"transition"in n,r.cantouch="ontouchstart"in E.documentElement||"ontouchstart"in V,r.hasw3ctouch=!!V.PointerEvent&&(0<navigator.MaxTouchPoints||0<navigator.msMaxTouchPoints),r.hasmstouch=!r.hasw3ctouch&&(V.MSPointerEvent||!1),r.ismac=/^mac$/i.test(o),r.isios=r.cantouch&&/iphone|ipad|ipod/i.test(o),r.isios4=r.isios&&!("seal"in Object),r.isios7=r.isios&&"webkitHidden"in E,r.isios8=r.isios&&"hidden"in E,r.isios10=r.isios&&V.Proxy,r.isandroid=/android/i.test(t),r.haseventlistener="addEventListener"in e,r.trstyle=!1,r.hastransform=!1,r.hastranslate3d=!1,r.transitionstyle=!1,r.hastransition=!1,r.transitionend=!1,r.trstyle="transform",r.hastransform="transform"in n||function(){for(var e=["msTransform","webkitTransform","MozTransform","OTransform"],t=0,o=e.length;t<o;t++)if(void 0!==n[e[t]]){r.trstyle=e[t];break}r.hastransform=!!r.trstyle}(),r.hastransform&&(n[r.trstyle]="translate3d(1px,2px,3px)",r.hastranslate3d=/translate3d/.test(n[r.trstyle])),r.transitionstyle="transition",r.prefixstyle="",r.transitionend="transitionend",r.hastransition="transition"in n||function(){r.transitionend=!1;for(var e=["webkitTransition","msTransition","MozTransition","OTransition","OTransition","KhtmlTransition"],t=["-webkit-","-ms-","-moz-","-o-","-o","-khtml-"],o=["webkitTransitionEnd","msTransitionEnd","transitionend","otransitionend","oTransitionEnd","KhtmlTransitionEnd"],i=0,a=e.length;i<a;i++)if(e[i]in n){r.transitionstyle=e[i],r.prefixstyle=t[i],r.transitionend=o[i];break}r.ischrome26&&(r.prefixstyle=t[1]),r.hastransition=r.transitionstyle}(),r.cursorgrabvalue=function(){var e=["grab","-webkit-grab","-moz-grab"];(r.ischrome&&!r.ischrome38||r.isie)&&(e=[]);for(var t=0,o=e.length;t<o;t++){var i=e[t];if(n.cursor=i,n.cursor==i)return i}return"url(https://cdnjs.cloudflare.com/ajax/libs/slider-pro/1.3.0/css/images/openhand.cur),n-resize"}(),r.hasmousecapture="setCapture"in e,r.hasMutationObserver=!1!==P,e=null,B=r}();var N=I.extend({},this.detected);this.canhwscroll=N.hastransform&&O.hwacceleration,this.ishwscroll=this.canhwscroll&&y.haswrapper,this.isrtlmode?this.isvertical?this.hasreversehr=!(N.iswebkit||N.isie||N.isie11):this.hasreversehr=!(N.iswebkit||N.isie&&!N.isie10&&!N.isie11):this.hasreversehr=!1,this.istouchcapable=!1,(N.cantouch||!N.hasw3ctouch&&!N.hasmstouch)&&(!N.cantouch||N.isios||N.isandroid||!N.iswebkit&&!N.ismozilla)||(this.istouchcapable=!0),O.enablemouselockapi||(N.hasmousecapture=!1,N.haspointerlock=!1),this.debounced=function(e,t,o){y&&(y.delaylist[e]||(y.delaylist[e]={h:U(function(){y.delaylist[e].fn.call(y),y.delaylist[e]=!1},o)},t.call(y)),y.delaylist[e].fn=t)},this.synched=function(e,t){y.synclist[e]?y.synclist[e]=t:(y.synclist[e]=t,U(function(){y&&(y.synclist[e]&&y.synclist[e].call(y),y.synclist[e]=null)}))},this.unsynched=function(e){y.synclist[e]&&(y.synclist[e]=!1)},this.css=function(e,t){for(var o in t)y.saved.css.push([e,o,e.css(o)]),e.css(o,t[o])},this.scrollTop=function(e){return void 0===e?y.getScrollTop():y.setScrollTop(e)},this.scrollLeft=function(e){return void 0===e?y.getScrollLeft():y.setScrollLeft(e)};var u=function(e,t,o,i,a,n,r){this.st=e,this.ed=t,this.spd=o,this.p1=i||0,this.p2=a||1,this.p3=n||0,this.p4=r||1,this.ts=j(),this.df=t-e};if(u.prototype={B2:function(e){return 3*(1-e)*(1-e)*e},B3:function(e){return 3*(1-e)*e*e},B4:function(e){return e*e*e},getPos:function(){return(j()-this.ts)/this.spd},getNow:function(){var e=(j()-this.ts)/this.spd,t=this.B2(e)+this.B3(e)+this.B4(e);return 1<=e?this.ed:this.st+this.df*t|0},update:function(e,t){return this.st=this.getNow(),this.ed=e,this.spd=t,this.ts=j(),this.df=this.ed-this.st,this}},this.ishwscroll){this.doc.translate={x:0,y:0,tx:"0px",ty:"0px"},N.hastranslate3d&&N.isios&&this.doc.css("-webkit-backface-visibility","hidden"),this.getScrollTop=function(e){if(!e){var t=o();if(t)return 16==t.length?-t[13]:-t[5];if(y.timerscroll&&y.timerscroll.bz)return y.timerscroll.bz.getNow()}return y.doc.translate.y},this.getScrollLeft=function(e){if(!e){var t=o();if(t)return 16==t.length?-t[12]:-t[4];if(y.timerscroll&&y.timerscroll.bh)return y.timerscroll.bh.getNow()}return y.doc.translate.x},this.notifyScrollEvent=function(e){var t=E.createEvent("UIEvents");t.initUIEvent("scroll",!1,!1,V,1),t.niceevent=!0,e.dispatchEvent(t)};var d=this.isrtlmode?1:-1;N.hastranslate3d&&O.enabletranslate3d?(this.setScrollTop=function(e,t){y.doc.translate.y=e,y.doc.translate.ty=-1*e+"px",y.doc.css(N.trstyle,"translate3d("+y.doc.translate.tx+","+y.doc.translate.ty+",0)"),t||y.notifyScrollEvent(y.win[0])},this.setScrollLeft=function(e,t){y.doc.translate.x=e,y.doc.translate.tx=e*d+"px",y.doc.css(N.trstyle,"translate3d("+y.doc.translate.tx+","+y.doc.translate.ty+",0)"),t||y.notifyScrollEvent(y.win[0])}):(this.setScrollTop=function(e,t){y.doc.translate.y=e,y.doc.translate.ty=-1*e+"px",y.doc.css(N.trstyle,"translate("+y.doc.translate.tx+","+y.doc.translate.ty+")"),t||y.notifyScrollEvent(y.win[0])},this.setScrollLeft=function(e,t){y.doc.translate.x=e,y.doc.translate.tx=e*d+"px",y.doc.css(N.trstyle,"translate("+y.doc.translate.tx+","+y.doc.translate.ty+")"),t||y.notifyScrollEvent(y.win[0])})}else this.getScrollTop=function(){return y.docscroll.scrollTop()},this.setScrollTop=function(e){y.docscroll.scrollTop(e)},this.getScrollLeft=function(){return y.hasreversehr?y.detected.ismozilla?y.page.maxw-Math.abs(y.docscroll.scrollLeft()):y.page.maxw-y.docscroll.scrollLeft():y.docscroll.scrollLeft()},this.setScrollLeft=function(e){return setTimeout(function(){if(y)return y.hasreversehr&&(e=y.detected.ismozilla?-(y.page.maxw-e):y.page.maxw-e),y.docscroll.scrollLeft(e)},1)};this.getTarget=function(e){return!!e&&(e.target?e.target:!!e.srcElement&&e.srcElement)},this.hasParent=function(e,t){if(!e)return!1;for(var o=e.target||e.srcElement||e||!1;o&&o.id!=t;)o=o.parentNode||!1;return!1!==o};var h={thin:1,medium:3,thick:5};this.getDocumentScrollOffset=function(){return{top:V.pageYOffset||E.documentElement.scrollTop,left:V.pageXOffset||E.documentElement.scrollLeft}},this.getOffset=function(){if(y.isfixed){var e=y.win.offset(),t=y.getDocumentScrollOffset();return e.top-=t.top,e.left-=t.left,e}var o=y.win.offset();if(!y.viewport)return o;var i=y.viewport.offset();return{top:o.top-i.top,left:o.left-i.left}},this.updateScrollBar=function(e){var t,o;if(y.ishwscroll)y.rail.css({height:y.win.innerHeight()-(O.railpadding.top+O.railpadding.bottom)}),y.railh&&y.railh.css({width:y.win.innerWidth()-(O.railpadding.left+O.railpadding.right)});else{var i=y.getOffset();if((t={top:i.top,left:i.left-(O.railpadding.left+O.railpadding.right)}).top+=r(y.win,"border-top-width",!0),t.left+=y.rail.align?y.win.outerWidth()-r(y.win,"border-right-width")-y.rail.width:r(y.win,"border-left-width"),(o=O.railoffset)&&(o.top&&(t.top+=o.top),o.left&&(t.left+=o.left)),y.railslocked||y.rail.css({top:t.top,left:t.left,height:(e?e.h:y.win.innerHeight())-(O.railpadding.top+O.railpadding.bottom)}),y.zoom&&y.zoom.css({top:t.top+1,left:1==y.rail.align?t.left-20:t.left+y.rail.width+4}),y.railh&&!y.railslocked){t={top:i.top,left:i.left},(o=O.railhoffset)&&(o.top&&(t.top+=o.top),o.left&&(t.left+=o.left));var a=y.railh.align?t.top+r(y.win,"border-top-width",!0)+y.win.innerHeight()-y.railh.height:t.top+r(y.win,"border-top-width",!0),n=t.left+r(y.win,"border-left-width");y.railh.css({top:a-(O.railpadding.top+O.railpadding.bottom),left:n,width:y.railh.width})}}},this.doRailClick=function(e,t,o){var i,a,n,r;y.railslocked||(y.cancelEvent(e),"pageY"in e||(e.pageX=e.clientX+E.documentElement.scrollLeft,e.pageY=e.clientY+E.documentElement.scrollTop),t?(i=o?y.doScrollLeft:y.doScrollTop,n=o?(e.pageX-y.railh.offset().left-y.cursorwidth/2)*y.scrollratio.x:(e.pageY-y.rail.offset().top-y.cursorheight/2)*y.scrollratio.y,y.unsynched("relativexy"),i(0|n)):(i=o?y.doScrollLeftBy:y.doScrollBy,n=o?y.scroll.x:y.scroll.y,r=o?e.pageX-y.railh.offset().left:e.pageY-y.rail.offset().top,a=o?y.view.w:y.view.h,i(r<=n?a:-a)))},y.newscrolly=y.newscrollx=0,y.hasanimationframe="requestAnimationFrame"in V,y.hascancelanimationframe="cancelAnimationFrame"in V,y.hasborderbox=!1,this.init=function(){if(y.saved.css=[],N.isoperamini)return!0;if(N.isandroid&&!("hidden"in E))return!0;O.emulatetouch=O.emulatetouch||O.touchbehavior,y.hasborderbox=V.getComputedStyle&&"border-box"===V.getComputedStyle(E.body)["box-sizing"];var o={"overflow-y":"hidden"};if((N.isie11||N.isie10)&&(o["-ms-overflow-style"]="none"),y.ishwscroll&&(this.doc.css(N.transitionstyle,N.prefixstyle+"transform 0ms ease-out"),N.transitionend&&y.bind(y.doc,N.transitionend,y.onScrollTransitionEnd,!1)),y.zindex="auto",y.ispage||"auto"!=O.zindex?y.zindex=O.zindex:y.zindex=function(){var e=y.win;if("zIndex"in e)return e.zIndex();for(;0<e.length;){if(9==e[0].nodeType)return!1;var t=e.css("zIndex");if(!isNaN(t)&&0!==t)return parseInt(t);e=e.parent()}return!1}()||"auto",!y.ispage&&"auto"!=y.zindex&&y.zindex>M&&(M=y.zindex),y.isie&&0===y.zindex&&"auto"==O.zindex&&(y.zindex="auto"),!y.ispage||!N.isieold){var e=y.docscroll;y.ispage&&(e=y.haswrapper?y.win:y.doc),y.css(e,o),y.ispage&&(N.isie11||N.isie)&&y.css(I("html"),o),!N.isios||y.ispage||y.haswrapper||y.css(T,{"-webkit-overflow-scrolling":"touch"});var t=I(E.createElement("div"));t.css({position:"relative",top:0,float:"right",width:O.cursorwidth,height:0,"background-color":O.cursorcolor,border:O.cursorborder,"background-clip":"padding-box","-webkit-border-radius":O.cursorborderradius,"-moz-border-radius":O.cursorborderradius,"border-radius":O.cursorborderradius}),t.addClass("nicescroll-cursors"),y.cursor=t;var i=I(E.createElement("div"));i.attr("id",y.id),i.addClass("nicescroll-rails nicescroll-rails-vr");var a,n,r=["left","right","top","bottom"];for(var s in r)n=r[s],(a=O.railpadding[n]||0)&&i.css("padding-"+n,a+"px");i.append(t),i.width=Math.max(parseFloat(O.cursorwidth),t.outerWidth()),i.css({width:i.width+"px",zIndex:y.zindex,background:O.background,cursor:"default"}),i.visibility=!0,i.scrollable=!0,i.align="left"==O.railalign?0:1,y.rail=i;var l,c=y.rail.drag=!1;if(!O.boxzoom||y.ispage||N.isieold||(c=E.createElement("div"),y.bind(c,"click",y.doZoom),y.bind(c,"mouseenter",function(){y.zoom.css("opacity",O.cursoropacitymax)}),y.bind(c,"mouseleave",function(){y.zoom.css("opacity",O.cursoropacitymin)}),y.zoom=I(c),y.zoom.css({cursor:"pointer",zIndex:y.zindex,backgroundImage:"url("+O.scriptpath+"zoomico.png)",height:18,width:18,backgroundPosition:"0 0"}),O.dblclickzoom&&y.bind(y.win,"dblclick",y.doZoom),N.cantouch&&O.gesturezoom&&(y.ongesturezoom=function(e){return 1.5<e.scale&&y.doZoomIn(e),e.scale<.8&&y.doZoomOut(e),y.cancelEvent(e)},y.bind(y.win,"gestureend",y.ongesturezoom))),y.railh=!1,O.horizrailenabled&&(y.css(e,{overflowX:"hidden"}),(t=I(E.createElement("div"))).css({position:"absolute",top:0,height:O.cursorwidth,width:0,backgroundColor:O.cursorcolor,border:O.cursorborder,backgroundClip:"padding-box","-webkit-border-radius":O.cursorborderradius,"-moz-border-radius":O.cursorborderradius,"border-radius":O.cursorborderradius}),N.isieold&&t.css("overflow","hidden"),t.addClass("nicescroll-cursors"),y.cursorh=t,(l=I(E.createElement("div"))).attr("id",y.id+"-hr"),l.addClass("nicescroll-rails nicescroll-rails-hr"),l.height=Math.max(parseFloat(O.cursorwidth),t.outerHeight()),l.css({height:l.height+"px",zIndex:y.zindex,background:O.background}),l.append(t),l.visibility=!0,l.scrollable=!0,l.align="top"==O.railvalign?0:1,y.railh=l,y.railh.drag=!1),y.ispage)i.css({position:"fixed",top:0,height:"100%"}),i.css(i.align?{right:0}:{left:0}),y.body.append(i),y.railh&&(l.css({position:"fixed",left:0,width:"100%"}),l.css(l.align?{bottom:0}:{top:0}),y.body.append(l));else{if(y.ishwscroll){"static"==y.win.css("position")&&y.css(y.win,{position:"relative"});var u="HTML"==y.win[0].nodeName?y.body:y.win;I(u).scrollTop(0).scrollLeft(0),y.zoom&&(y.zoom.css({position:"absolute",top:1,right:0,"margin-right":i.width+4}),u.append(y.zoom)),i.css({position:"absolute",top:0}),i.css(i.align?{right:0}:{left:0}),u.append(i),l&&(l.css({position:"absolute",left:0,bottom:0}),l.css(l.align?{bottom:0}:{top:0}),u.append(l))}else{y.isfixed="fixed"==y.win.css("position");var d=y.isfixed?"fixed":"absolute";y.isfixed||(y.viewport=y.getViewport(y.win[0])),y.viewport&&(y.body=y.viewport,/fixed|absolute/.test(y.viewport.css("position"))||y.css(y.viewport,{position:"relative"})),i.css({position:d}),y.zoom&&y.zoom.css({position:d}),y.updateScrollBar(),y.body.append(i),y.zoom&&y.body.append(y.zoom),y.railh&&(l.css({position:d}),y.body.append(l))}N.isios&&y.css(y.win,{"-webkit-tap-highlight-color":"rgba(0,0,0,0)","-webkit-touch-callout":"none"}),O.disableoutline&&(N.isie&&y.win.attr("hideFocus","true"),N.iswebkit&&y.win.css("outline","none"))}if(!1===O.autohidemode?(y.autohidedom=!1,y.rail.css({opacity:O.cursoropacitymax}),y.railh&&y.railh.css({opacity:O.cursoropacitymax})):!0===O.autohidemode||"leave"===O.autohidemode?(y.autohidedom=I().add(y.rail),N.isie8&&(y.autohidedom=y.autohidedom.add(y.cursor)),y.railh&&(y.autohidedom=y.autohidedom.add(y.railh)),y.railh&&N.isie8&&(y.autohidedom=y.autohidedom.add(y.cursorh))):"scroll"==O.autohidemode?(y.autohidedom=I().add(y.rail),y.railh&&(y.autohidedom=y.autohidedom.add(y.railh))):"cursor"==O.autohidemode?(y.autohidedom=I().add(y.cursor),y.railh&&(y.autohidedom=y.autohidedom.add(y.cursorh))):"hidden"==O.autohidemode&&(y.autohidedom=!1,y.hide(),y.railslocked=!1),N.cantouch||y.istouchcapable||O.emulatetouch||N.hasmstouch){y.scrollmom=new z(y),y.ontouchstart=function(e){if(y.locked)return!1;if(e.pointerType&&("mouse"===e.pointerType||e.pointerType===e.MSPOINTER_TYPE_MOUSE))return!1;if(y.hasmoving=!1,y.scrollmom.timer&&(y.triggerScrollEnd(),y.scrollmom.stop()),!y.railslocked){var t=y.getTarget(e);if(t&&/INPUT/i.test(t.nodeName)&&/range/i.test(t.type))return y.stopPropagation(e);var o="mousedown"===e.type;if(!("clientX"in e)&&"changedTouches"in e&&(e.clientX=e.changedTouches[0].clientX,e.clientY=e.changedTouches[0].clientY),y.forcescreen){var i=e;(e={original:e.original?e.original:e}).clientX=i.screenX,e.clientY=i.screenY}if(y.rail.drag={x:e.clientX,y:e.clientY,sx:y.scroll.x,sy:y.scroll.y,st:y.getScrollTop(),sl:y.getScrollLeft(),pt:2,dl:!1,tg:t},y.ispage||!O.directionlockdeadzone)y.rail.drag.dl="f";else{var a=R.width(),n=R.height(),r=y.getContentSize(),s=r.h-n,l=r.w-a;y.rail.scrollable&&!y.railh.scrollable?y.rail.drag.ck=0<s&&"v":!y.rail.scrollable&&y.railh.scrollable?y.rail.drag.ck=0<l&&"h":y.rail.drag.ck=!1}if(O.emulatetouch&&y.isiframe&&N.isie){var c=y.win.position();y.rail.drag.x+=c.left,y.rail.drag.y+=c.top}if(y.hasmoving=!1,y.lastmouseup=!1,y.scrollmom.reset(e.clientX,e.clientY),t&&o){if(!/INPUT|SELECT|BUTTON|TEXTAREA/i.test(t.nodeName))return N.hasmousecapture&&t.setCapture(),O.emulatetouch?(t.onclick&&!t._onclick&&(t._onclick=t.onclick,t.onclick=function(e){if(y.hasmoving)return!1;t._onclick.call(this,e)}),y.cancelEvent(e)):y.stopPropagation(e);/SUBMIT|CANCEL|BUTTON/i.test(I(t).attr("type"))&&(y.preventclick={tg:t,click:!1})}}},y.ontouchend=function(e){if(!y.rail.drag)return!0;if(2==y.rail.drag.pt){if(e.pointerType&&("mouse"===e.pointerType||e.pointerType===e.MSPOINTER_TYPE_MOUSE))return!1;y.rail.drag=!1;var t="mouseup"===e.type;if(y.hasmoving&&(y.scrollmom.doMomentum(),y.lastmouseup=!0,y.hideCursor(),N.hasmousecapture&&E.releaseCapture(),t))return y.cancelEvent(e)}else if(1==y.rail.drag.pt)return y.onmouseup(e)};var m=O.emulatetouch&&y.isiframe&&!N.hasmousecapture,g=.3*O.directionlockdeadzone|0;y.ontouchmove=function(e,t){if(!y.rail.drag)return!0;if(e.targetTouches&&O.preventmultitouchscrolling&&1<e.targetTouches.length)return!0;if(e.pointerType&&("mouse"===e.pointerType||e.pointerType===e.MSPOINTER_TYPE_MOUSE))return!0;if(2==y.rail.drag.pt){var o,i;if("changedTouches"in e&&(e.clientX=e.changedTouches[0].clientX,e.clientY=e.changedTouches[0].clientY),i=o=0,m&&!t){var a=y.win.position();i=-a.left,o=-a.top}var n=e.clientY+o,r=n-y.rail.drag.y,s=e.clientX+i,l=s-y.rail.drag.x,c=y.rail.drag.st-r;if(y.ishwscroll&&O.bouncescroll)c<0?c=Math.round(c/2):c>y.page.maxh&&(c=y.page.maxh+Math.round((c-y.page.maxh)/2));else if(c<0?n=c=0:c>y.page.maxh&&(c=y.page.maxh,n=0),0===n&&!y.hasmoving)return y.ispage||(y.rail.drag=!1),!0;var u=y.getScrollLeft();if(y.railh&&y.railh.scrollable&&(u=y.isrtlmode?l-y.rail.drag.sl:y.rail.drag.sl-l,y.ishwscroll&&O.bouncescroll?u<0?u=Math.round(u/2):u>y.page.maxw&&(u=y.page.maxw+Math.round((u-y.page.maxw)/2)):(u<0&&(s=u=0),u>y.page.maxw&&(u=y.page.maxw,s=0))),!y.hasmoving){if(y.rail.drag.y===e.clientY&&y.rail.drag.x===e.clientX)return y.cancelEvent(e);var d=Math.abs(r),h=Math.abs(l),p=O.directionlockdeadzone;if(y.rail.drag.ck?"v"==y.rail.drag.ck?p<h&&d<=g?y.rail.drag=!1:p<d&&(y.rail.drag.dl="v"):"h"==y.rail.drag.ck&&(p<d&&h<=g?y.rail.drag=!1:p<h&&(y.rail.drag.dl="h")):p<d&&p<h?y.rail.drag.dl="f":p<d?y.rail.drag.dl=g<h?"f":"v":p<h&&(y.rail.drag.dl=g<d?"f":"h"),!y.rail.drag.dl)return y.cancelEvent(e);y.triggerScrollStart(e.clientX,e.clientY,0,0,0),y.hasmoving=!0}return y.preventclick&&!y.preventclick.click&&(y.preventclick.click=y.preventclick.tg.onclick||!1,y.preventclick.tg.onclick=y.onpreventclick),y.rail.drag.dl&&("v"==y.rail.drag.dl?u=y.rail.drag.sl:"h"==y.rail.drag.dl&&(c=y.rail.drag.st)),y.synched("touchmove",function(){y.rail.drag&&2==y.rail.drag.pt&&(y.prepareTransition&&y.resetTransition(),y.rail.scrollable&&y.setScrollTop(c),y.scrollmom.update(s,n),y.railh&&y.railh.scrollable?(y.setScrollLeft(u),y.showCursor(c,u)):y.showCursor(c),N.isie10&&E.selection.clear())}),y.cancelEvent(e)}return 1==y.rail.drag.pt?y.onmousemove(e):void 0},y.ontouchstartCursor=function(e,t){if(!y.rail.drag||3==y.rail.drag.pt){if(y.locked)return y.cancelEvent(e);y.cancelScroll(),y.rail.drag={x:e.touches[0].clientX,y:e.touches[0].clientY,sx:y.scroll.x,sy:y.scroll.y,pt:3,hr:!!t};var o=y.getTarget(e);return!y.ispage&&N.hasmousecapture&&o.setCapture(),y.isiframe&&!N.hasmousecapture&&(y.saved.csspointerevents=y.doc.css("pointer-events"),y.css(y.doc,{"pointer-events":"none"})),y.cancelEvent(e)}},y.ontouchendCursor=function(e){if(y.rail.drag){if(N.hasmousecapture&&E.releaseCapture(),y.isiframe&&!N.hasmousecapture&&y.doc.css("pointer-events",y.saved.csspointerevents),3!=y.rail.drag.pt)return;return y.rail.drag=!1,y.cancelEvent(e)}},y.ontouchmoveCursor=function(e){if(y.rail.drag){if(3!=y.rail.drag.pt)return;if(y.cursorfreezed=!0,y.rail.drag.hr){y.scroll.x=y.rail.drag.sx+(e.touches[0].clientX-y.rail.drag.x),y.scroll.x<0&&(y.scroll.x=0);var t=y.scrollvaluemaxw;y.scroll.x>t&&(y.scroll.x=t)}else{y.scroll.y=y.rail.drag.sy+(e.touches[0].clientY-y.rail.drag.y),y.scroll.y<0&&(y.scroll.y=0);var o=y.scrollvaluemax;y.scroll.y>o&&(y.scroll.y=o)}return y.synched("touchmove",function(){y.rail.drag&&3==y.rail.drag.pt&&(y.showCursor(),y.rail.drag.hr?y.doScrollLeft(Math.round(y.scroll.x*y.scrollratio.x),O.cursordragspeed):y.doScrollTop(Math.round(y.scroll.y*y.scrollratio.y),O.cursordragspeed))}),y.cancelEvent(e)}}}if(y.onmousedown=function(e,t){if(!y.rail.drag||1==y.rail.drag.pt){if(y.railslocked)return y.cancelEvent(e);y.cancelScroll(),y.rail.drag={x:e.clientX,y:e.clientY,sx:y.scroll.x,sy:y.scroll.y,pt:1,hr:t||!1};var o=y.getTarget(e);return N.hasmousecapture&&o.setCapture(),y.isiframe&&!N.hasmousecapture&&(y.saved.csspointerevents=y.doc.css("pointer-events"),y.css(y.doc,{"pointer-events":"none"})),y.hasmoving=!1,y.cancelEvent(e)}},y.onmouseup=function(e){if(y.rail.drag)return 1!=y.rail.drag.pt||(N.hasmousecapture&&E.releaseCapture(),y.isiframe&&!N.hasmousecapture&&y.doc.css("pointer-events",y.saved.csspointerevents),y.rail.drag=!1,y.cursorfreezed=!1,y.hasmoving&&y.triggerScrollEnd(),y.cancelEvent(e))},y.onmousemove=function(e){if(y.rail.drag){if(1!==y.rail.drag.pt)return;if(N.ischrome&&0===e.which)return y.onmouseup(e);if(y.cursorfreezed=!0,y.hasmoving||y.triggerScrollStart(e.clientX,e.clientY,0,0,0),y.hasmoving=!0,y.rail.drag.hr){y.scroll.x=y.rail.drag.sx+(e.clientX-y.rail.drag.x),y.scroll.x<0&&(y.scroll.x=0);var t=y.scrollvaluemaxw;y.scroll.x>t&&(y.scroll.x=t)}else{y.scroll.y=y.rail.drag.sy+(e.clientY-y.rail.drag.y),y.scroll.y<0&&(y.scroll.y=0);var o=y.scrollvaluemax;y.scroll.y>o&&(y.scroll.y=o)}return y.synched("mousemove",function(){y.cursorfreezed&&(y.showCursor(),y.rail.drag.hr?y.scrollLeft(Math.round(y.scroll.x*y.scrollratio.x)):y.scrollTop(Math.round(y.scroll.y*y.scrollratio.y)))}),y.cancelEvent(e)}y.checkarea=0},N.cantouch||O.emulatetouch)y.onpreventclick=function(e){if(y.preventclick)return y.preventclick.tg.onclick=y.preventclick.click,y.preventclick=!1,y.cancelEvent(e)},y.onclick=!N.isios&&function(e){return!y.lastmouseup||(y.lastmouseup=!1,y.cancelEvent(e))},O.grabcursorenabled&&N.cursorgrabvalue&&(y.css(y.ispage?y.doc:y.win,{cursor:N.cursorgrabvalue}),y.css(y.rail,{cursor:N.cursorgrabvalue}));else{var h=function(e){if(y.selectiondrag){if(e){var t=y.win.outerHeight(),o=e.pageY-y.selectiondrag.top;0<o&&o<t&&(o=0),t<=o&&(o-=t),y.selectiondrag.df=o}if(0!==y.selectiondrag.df){var i=-2*y.selectiondrag.df/6|0;y.doScrollBy(i),y.debounced("doselectionscroll",function(){h()},50)}}};y.hasTextSelected="getSelection"in E?function(){return 0<E.getSelection().rangeCount}:"selection"in E?function(){return"None"!=E.selection.type}:function(){return!1},y.onselectionstart=function(e){y.ispage||(y.selectiondrag=y.win.offset())},y.onselectionend=function(e){y.selectiondrag=!1},y.onselectiondrag=function(e){y.selectiondrag&&y.hasTextSelected()&&y.debounced("selectionscroll",function(){h(e)},250)}}if(N.hasw3ctouch?(y.css(y.ispage?I("html"):y.win,{"touch-action":"none"}),y.css(y.rail,{"touch-action":"none"}),y.css(y.cursor,{"touch-action":"none"}),y.bind(y.win,"pointerdown",y.ontouchstart),y.bind(E,"pointerup",y.ontouchend),y.delegate(E,"pointermove",y.ontouchmove)):N.hasmstouch?(y.css(y.ispage?I("html"):y.win,{"-ms-touch-action":"none"}),y.css(y.rail,{"-ms-touch-action":"none"}),y.css(y.cursor,{"-ms-touch-action":"none"}),y.bind(y.win,"MSPointerDown",y.ontouchstart),y.bind(E,"MSPointerUp",y.ontouchend),y.delegate(E,"MSPointerMove",y.ontouchmove),y.bind(y.cursor,"MSGestureHold",function(e){e.preventDefault()}),y.bind(y.cursor,"contextmenu",function(e){e.preventDefault()})):N.cantouch&&(y.bind(y.win,"touchstart",y.ontouchstart,!1,!0),y.bind(E,"touchend",y.ontouchend,!1,!0),y.bind(E,"touchcancel",y.ontouchend,!1,!0),y.delegate(E,"touchmove",y.ontouchmove,!1,!0)),O.emulatetouch&&(y.bind(y.win,"mousedown",y.ontouchstart,!1,!0),y.bind(E,"mouseup",y.ontouchend,!1,!0),y.bind(E,"mousemove",y.ontouchmove,!1,!0)),(O.cursordragontouch||!N.cantouch&&!O.emulatetouch)&&(y.rail.css({cursor:"default"}),y.railh&&y.railh.css({cursor:"default"}),y.jqbind(y.rail,"mouseenter",function(){if(!y.ispage&&!y.win.is(":visible"))return!1;y.canshowonmouseevent&&y.showCursor(),y.rail.active=!0}),y.jqbind(y.rail,"mouseleave",function(){y.rail.active=!1,y.rail.drag||y.hideCursor()}),O.sensitiverail&&(y.bind(y.rail,"click",function(e){y.doRailClick(e,!1,!1)}),y.bind(y.rail,"dblclick",function(e){y.doRailClick(e,!0,!1)}),y.bind(y.cursor,"click",function(e){y.cancelEvent(e)}),y.bind(y.cursor,"dblclick",function(e){y.cancelEvent(e)})),y.railh&&(y.jqbind(y.railh,"mouseenter",function(){if(!y.ispage&&!y.win.is(":visible"))return!1;y.canshowonmouseevent&&y.showCursor(),y.rail.active=!0}),y.jqbind(y.railh,"mouseleave",function(){y.rail.active=!1,y.rail.drag||y.hideCursor()}),O.sensitiverail&&(y.bind(y.railh,"click",function(e){y.doRailClick(e,!1,!0)}),y.bind(y.railh,"dblclick",function(e){y.doRailClick(e,!0,!0)}),y.bind(y.cursorh,"click",function(e){y.cancelEvent(e)}),y.bind(y.cursorh,"dblclick",function(e){y.cancelEvent(e)})))),O.cursordragontouch&&(this.istouchcapable||N.cantouch)&&(y.bind(y.cursor,"touchstart",y.ontouchstartCursor),y.bind(y.cursor,"touchmove",y.ontouchmoveCursor),y.bind(y.cursor,"touchend",y.ontouchendCursor),y.cursorh&&y.bind(y.cursorh,"touchstart",function(e){y.ontouchstartCursor(e,!0)}),y.cursorh&&y.bind(y.cursorh,"touchmove",y.ontouchmoveCursor),y.cursorh&&y.bind(y.cursorh,"touchend",y.ontouchendCursor)),N.cantouch||O.emulatetouch?(y.bind(N.hasmousecapture?y.win:E,"mouseup",y.ontouchend),y.onclick&&y.bind(E,"click",y.onclick),O.cursordragontouch?(y.bind(y.cursor,"mousedown",y.onmousedown),y.bind(y.cursor,"mouseup",y.onmouseup),y.cursorh&&y.bind(y.cursorh,"mousedown",function(e){y.onmousedown(e,!0)}),y.cursorh&&y.bind(y.cursorh,"mouseup",y.onmouseup)):(y.bind(y.rail,"mousedown",function(e){e.preventDefault()}),y.railh&&y.bind(y.railh,"mousedown",function(e){e.preventDefault()}))):(y.bind(N.hasmousecapture?y.win:E,"mouseup",y.onmouseup),y.bind(E,"mousemove",y.onmousemove),y.onclick&&y.bind(E,"click",y.onclick),y.bind(y.cursor,"mousedown",y.onmousedown),y.bind(y.cursor,"mouseup",y.onmouseup),y.railh&&(y.bind(y.cursorh,"mousedown",function(e){y.onmousedown(e,!0)}),y.bind(y.cursorh,"mouseup",y.onmouseup)),!y.ispage&&O.enablescrollonselection&&(y.bind(y.win[0],"mousedown",y.onselectionstart),y.bind(E,"mouseup",y.onselectionend),y.bind(y.cursor,"mouseup",y.onselectionend),y.cursorh&&y.bind(y.cursorh,"mouseup",y.onselectionend),y.bind(E,"mousemove",y.onselectiondrag)),y.zoom&&(y.jqbind(y.zoom,"mouseenter",function(){y.canshowonmouseevent&&y.showCursor(),y.rail.active=!0}),y.jqbind(y.zoom,"mouseleave",function(){y.rail.active=!1,y.rail.drag||y.hideCursor()}))),O.enablemousewheel&&(y.isiframe||y.mousewheel(N.isie&&y.ispage?E:y.win,y.onmousewheel),y.mousewheel(y.rail,y.onmousewheel),y.railh&&y.mousewheel(y.railh,y.onmousewheelhr)),y.ispage||N.cantouch||/HTML|^BODY/.test(y.win[0].nodeName)||(y.win.attr("tabindex")||y.win.attr({tabindex:++k}),y.bind(y.win,"focus",function(e){C=y.getTarget(e).id||y.getTarget(e)||!1,y.hasfocus=!0,y.canshowonmouseevent&&y.noticeCursor()}),y.bind(y.win,"blur",function(e){C=!1,y.hasfocus=!1}),y.bind(y.win,"mouseenter",function(e){_=y.getTarget(e).id||y.getTarget(e)||!1,y.hasmousefocus=!0,y.canshowonmouseevent&&y.noticeCursor()}),y.bind(y.win,"mouseleave",function(e){_=!1,y.hasmousefocus=!1,y.rail.drag||y.hideCursor()})),y.onkeypress=function(e){if(y.railslocked&&0===y.page.maxh)return!0;e=e||V.event;var t=y.getTarget(e);if(t&&/INPUT|TEXTAREA|SELECT|OPTION/.test(t.nodeName)&&(!t.getAttribute("type")&&!t.type||!/submit|button|cancel/i.tp))return!0;if(I(t).attr("contenteditable"))return!0;if(y.hasfocus||y.hasmousefocus&&!C||y.ispage&&!C&&!_){var o=e.keyCode;if(y.railslocked&&27!=o)return y.cancelEvent(e);var i=e.ctrlKey||!1,a=e.shiftKey||!1,n=!1;switch(o){case 38:case 63233:y.doScrollBy(72),n=!0;break;case 40:case 63235:y.doScrollBy(-72),n=!0;break;case 37:case 63232:y.railh&&(i?y.doScrollLeft(0):y.doScrollLeftBy(72),n=!0);break;case 39:case 63234:y.railh&&(i?y.doScrollLeft(y.page.maxw):y.doScrollLeftBy(-72),n=!0);break;case 33:case 63276:y.doScrollBy(y.view.h),n=!0;break;case 34:case 63277:y.doScrollBy(-y.view.h),n=!0;break;case 36:case 63273:y.railh&&i?y.doScrollPos(0,0):y.doScrollTo(0),n=!0;break;case 35:case 63275:y.railh&&i?y.doScrollPos(y.page.maxw,y.page.maxh):y.doScrollTo(y.page.maxh),n=!0;break;case 32:O.spacebarenabled&&(a?y.doScrollBy(y.view.h):y.doScrollBy(-y.view.h),n=!0);break;case 27:y.zoomactive&&(y.doZoom(),n=!0)}if(n)return y.cancelEvent(e)}},O.enablekeyboard&&y.bind(E,N.isopera&&!N.isopera12?"keypress":"keydown",y.onkeypress),y.bind(E,"keydown",function(e){e.ctrlKey&&(y.wheelprevented=!0)}),y.bind(E,"keyup",function(e){e.ctrlKey||(y.wheelprevented=!1)}),y.bind(V,"blur",function(e){y.wheelprevented=!1}),y.bind(V,"resize",y.onscreenresize),y.bind(V,"orientationchange",y.onscreenresize),y.bind(V,"load",y.lazyResize),N.ischrome&&!y.ispage&&!y.haswrapper){var p=y.win.attr("style"),f=parseFloat(y.win.css("width"))+1;y.win.css("width",f),y.synched("chromefix",function(){y.win.attr("style",p)})}y.onAttributeChange=function(e){y.lazyResize(y.isieold?250:30)},O.enableobserver&&(y.isie11||!1===P||(y.observerbody=new P(function(e){if(e.forEach(function(e){if("attributes"==e.type)return T.hasClass("modal-open")&&T.hasClass("modal-dialog")&&!I.contains(I(".modal-dialog")[0],y.doc[0])?y.hide():y.show()}),y.me.clientWidth!=y.page.width||y.me.clientHeight!=y.page.height)return y.lazyResize(30)}),y.observerbody.observe(E.body,{childList:!0,subtree:!0,characterData:!1,attributes:!0,attributeFilter:["class"]})),y.ispage||y.haswrapper||(!1!==P?(y.observer=new P(function(e){e.forEach(y.onAttributeChange)}),y.observer.observe(y.win[0],{childList:!0,characterData:!1,attributes:!0,subtree:!1}),y.observerremover=new P(function(e){e.forEach(function(e){if(0<e.removedNodes.length)for(var t in e.removedNodes)if(y&&e.removedNodes[t]==y.win[0])return y.remove()})}),y.observerremover.observe(y.win[0].parentNode,{childList:!0,characterData:!1,attributes:!1,subtree:!1})):(y.bind(y.win,N.isie&&!N.isie9?"propertychange":"DOMAttrModified",y.onAttributeChange),N.isie9&&y.win[0].attachEvent("onpropertychange",y.onAttributeChange),y.bind(y.win,"DOMNodeRemoved",function(e){e.target==y.win[0]&&y.remove()})))),!y.ispage&&O.boxzoom&&y.bind(V,"resize",y.resizeZoom),y.istextarea&&(y.bind(y.win,"keydown",y.lazyResize),y.bind(y.win,"mouseup",y.lazyResize)),y.lazyResize(30)}if("IFRAME"==this.doc[0].nodeName){var v=function(){var t;y.iframexd=!1;try{(t="contentDocument"in this?this.contentDocument:this.contentWindow._doc).domain}catch(e){t=!(y.iframexd=!0)}if(y.iframexd)return!0;if(y.forcescreen=!0,y.isiframe&&(y.iframe={doc:I(t),html:y.doc.contents().find("html")[0],body:y.doc.contents().find("body")[0]},y.getContentSize=function(){return{w:Math.max(y.iframe.html.scrollWidth,y.iframe.body.scrollWidth),h:Math.max(y.iframe.html.scrollHeight,y.iframe.body.scrollHeight)}},y.docscroll=I(y.iframe.body)),!N.isios&&O.iframeautoresize&&!y.isiframe){y.win.scrollTop(0),y.doc.height("");var e=Math.max(t.getElementsByTagName("html")[0].scrollHeight,t.body.scrollHeight);y.doc.height(e)}y.lazyResize(30),y.css(I(y.iframe.body),o),N.isios&&y.haswrapper&&y.css(I(t.body),{"-webkit-transform":"translate3d(0,0,0)"}),"contentWindow"in this?y.bind(this.contentWindow,"scroll",y.onscroll):y.bind(t,"scroll",y.onscroll),O.enablemousewheel&&y.mousewheel(t,y.onmousewheel),O.enablekeyboard&&y.bind(t,N.isopera?"keypress":"keydown",y.onkeypress),N.cantouch?(y.bind(t,"touchstart",y.ontouchstart),y.bind(t,"touchmove",y.ontouchmove)):O.emulatetouch&&(y.bind(t,"mousedown",y.ontouchstart),y.bind(t,"mousemove",function(e){return y.ontouchmove(e,!0)}),O.grabcursorenabled&&N.cursorgrabvalue&&y.css(I(t.body),{cursor:N.cursorgrabvalue})),y.bind(t,"mouseup",y.ontouchend),y.zoom&&(O.dblclickzoom&&y.bind(t,"dblclick",y.doZoom),y.ongesturezoom&&y.bind(t,"gestureend",y.ongesturezoom))};this.doc[0].readyState&&"complete"===this.doc[0].readyState&&setTimeout(function(){v.call(y.doc[0],!1)},500),y.bind(this.doc,"load",v)}},this.showCursor=function(e,t){if(y.cursortimeout&&(clearTimeout(y.cursortimeout),y.cursortimeout=0),y.rail){if(y.autohidedom&&(y.autohidedom.stop().css({opacity:O.cursoropacitymax}),y.cursoractive=!0),y.rail.drag&&1==y.rail.drag.pt||(void 0!==e&&!1!==e&&(y.scroll.y=e/y.scrollratio.y|0),void 0!==t&&(y.scroll.x=t/y.scrollratio.x|0)),y.cursor.css({height:y.cursorheight,top:y.scroll.y}),y.cursorh){var o=y.hasreversehr?y.scrollvaluemaxw-y.scroll.x:y.scroll.x;y.cursorh.css({width:y.cursorwidth,left:!y.rail.align&&y.rail.visibility?o+y.rail.width:o}),y.cursoractive=!0}y.zoom&&y.zoom.stop().css({opacity:O.cursoropacitymax})}},this.hideCursor=function(e){y.cursortimeout||y.rail&&y.autohidedom&&(y.hasmousefocus&&"leave"===O.autohidemode||(y.cursortimeout=setTimeout(function(){y.rail.active&&y.showonmouseevent||(y.autohidedom.stop().animate({opacity:O.cursoropacitymin}),y.zoom&&y.zoom.stop().animate({opacity:O.cursoropacitymin}),y.cursoractive=!1),y.cursortimeout=0},e||O.hidecursordelay)))},this.noticeCursor=function(e,t,o){y.showCursor(t,o),y.rail.active||y.hideCursor(e)},this.getContentSize=y.ispage?function(){return{w:Math.max(E.body.scrollWidth,E.documentElement.scrollWidth),h:Math.max(E.body.scrollHeight,E.documentElement.scrollHeight)}}:y.haswrapper?function(){return{w:y.doc[0].offsetWidth,h:y.doc[0].offsetHeight}}:function(){return{w:y.docscroll[0].scrollWidth,h:y.docscroll[0].scrollHeight}},this.onResize=function(e,t){if(!y||!y.win)return!1;var o=y.page.maxh,i=y.page.maxw,a=y.view.h,n=y.view.w;if(y.view={w:y.ispage?y.win.width():y.win[0].clientWidth,h:y.ispage?y.win.height():y.win[0].clientHeight},y.page=t||y.getContentSize(),y.page.maxh=Math.max(0,y.page.h-y.view.h),y.page.maxw=Math.max(0,y.page.w-y.view.w),y.page.maxh==o&&y.page.maxw==i&&y.view.w==n&&y.view.h==a){if(y.ispage)return y;var r=y.win.offset();if(y.lastposition){var s=y.lastposition;if(s.top==r.top&&s.left==r.left)return y}y.lastposition=r}return 0===y.page.maxh?(y.hideRail(),y.scrollvaluemax=0,y.scroll.y=0,y.scrollratio.y=0,y.cursorheight=0,y.setScrollTop(0),y.rail&&(y.rail.scrollable=!1)):(y.page.maxh-=O.railpadding.top+O.railpadding.bottom,y.rail.scrollable=!0),0===y.page.maxw?(y.hideRailHr(),y.scrollvaluemaxw=0,y.scroll.x=0,y.scrollratio.x=0,y.cursorwidth=0,y.setScrollLeft(0),y.railh&&(y.railh.scrollable=!1)):(y.page.maxw-=O.railpadding.left+O.railpadding.right,y.railh&&(y.railh.scrollable=O.horizrailenabled)),y.railslocked=y.locked||0===y.page.maxh&&0===y.page.maxw,y.railslocked?(y.ispage||y.updateScrollBar(y.view),!1):(y.hidden||y.visibility?!y.railh||y.hidden||y.railh.visibility||y.showRailHr():y.showRail().showRailHr(),y.istextarea&&y.win.css("resize")&&"none"!=y.win.css("resize")&&(y.view.h-=20),y.cursorheight=Math.min(y.view.h,Math.round(y.view.h*(y.view.h/y.page.h))),y.cursorheight=O.cursorfixedheight?O.cursorfixedheight:Math.max(O.cursorminheight,y.cursorheight),y.cursorwidth=Math.min(y.view.w,Math.round(y.view.w*(y.view.w/y.page.w))),y.cursorwidth=O.cursorfixedheight?O.cursorfixedheight:Math.max(O.cursorminheight,y.cursorwidth),y.scrollvaluemax=y.view.h-y.cursorheight-(O.railpadding.top+O.railpadding.bottom),y.hasborderbox||(y.scrollvaluemax-=y.cursor[0].offsetHeight-y.cursor[0].clientHeight),y.railh&&(y.railh.width=0<y.page.maxh?y.view.w-y.rail.width:y.view.w,y.scrollvaluemaxw=y.railh.width-y.cursorwidth-(O.railpadding.left+O.railpadding.right)),y.ispage||y.updateScrollBar(y.view),y.scrollratio={x:y.page.maxw/y.scrollvaluemaxw,y:y.page.maxh/y.scrollvaluemax},y.getScrollTop()>y.page.maxh?y.doScrollTop(y.page.maxh):(y.scroll.y=y.getScrollTop()/y.scrollratio.y|0,y.scroll.x=y.getScrollLeft()/y.scrollratio.x|0,y.cursoractive&&y.noticeCursor()),y.scroll.y&&0===y.getScrollTop()&&y.doScrollTo(y.scroll.y*y.scrollratio.y|0),y)},this.resize=y.onResize;var p=0;this.onscreenresize=function(e){clearTimeout(p);var t=!y.ispage&&!y.haswrapper;t&&y.hideRails(),p=setTimeout(function(){y&&(t&&y.showRails(),y.resize()),p=0},120)},this.lazyResize=function(e){return clearTimeout(p),p=setTimeout(function(){y&&y.resize(),p=0},e||240),y},this.jqbind=function(e,t,o){y.events.push({e:e,n:t,f:o,q:!0}),I(e).on(t,o)};var m=!(this.mousewheel=function(e,t,o){var i="jquery"in e?e[0]:e;if("onwheel"in E.createElement("div"))y._bind(i,"wheel",t,o||!1);else{var a=void 0!==E.onmousewheel?"mousewheel":"DOMMouseScroll";n(i,a,t,o||!1),"DOMMouseScroll"==a&&n(i,"MozMousePixelScroll",t,o||!1)}});if(N.haseventlistener){try{var g=Object.defineProperty({},"passive",{get:function(){m=!0}});V.addEventListener("test",null,g)}catch(e){}this.stopPropagation=function(e){return!!e&&((e=e.original?e.original:e).stopPropagation(),!1)},this.cancelEvent=function(e){return e.cancelable&&e.preventDefault(),e.stopImmediatePropagation(),e.preventManipulation&&e.preventManipulation(),!1}}else Event.prototype.preventDefault=function(){this.returnValue=!1},Event.prototype.stopPropagation=function(){this.cancelBubble=!0},V.constructor.prototype.addEventListener=E.constructor.prototype.addEventListener=Element.prototype.addEventListener=function(e,t,o){this.attachEvent("on"+e,t)},V.constructor.prototype.removeEventListener=E.constructor.prototype.removeEventListener=Element.prototype.removeEventListener=function(e,t,o){this.detachEvent("on"+e,t)},this.cancelEvent=function(e){return(e=e||V.event)&&(e.cancelBubble=!0,e.cancel=!0,e.returnValue=!1),!1},this.stopPropagation=function(e){return(e=e||V.event)&&(e.cancelBubble=!0),!1};this.delegate=function(e,t,o,i,a){var n=A[t]||!1;n||(n={a:[],l:[],f:function(e){for(var t=n.l,o=!1,i=t.length-1;0<=i;i--)if(!1===(o=t[i].call(e.target,e)))return!1;return o}},y.bind(e,t,n.f,i,a),A[t]=n),y.ispage?(n.a=[y.id].concat(n.a),n.l=[o].concat(n.l)):(n.a.push(y.id),n.l.push(o))},this.undelegate=function(e,t,o,i,a){var n=A[t]||!1;if(n)for(var r=0,s=n.l.length;r<s;r++)n.a[r]===y.id&&(n.a.splice(r),n.l.splice(r),0===n.a.length&&(y._unbind(e,t,del.f),A[t]=null))},this.bind=function(e,t,o,i,a){var n="jquery"in e?e[0]:e;y._bind(n,t,o,i||!1,a||!1)},this._bind=function(e,t,o,i,a){y.events.push({e:e,n:t,f:o,b:i,q:!1}),m&&a?e.addEventListener(t,o,{passive:!1,capture:i}):e.addEventListener(t,o,i||!1)},this._unbind=function(e,t,o,i){A[t]?y.undelegate(e,t,o,i):e.removeEventListener(t,o,i)},this.unbindAll=function(){for(var e=0;e<y.events.length;e++){var t=y.events[e];t.q?t.e.unbind(t.n,t.f):y._unbind(t.e,t.n,t.f,t.b)}},this.showRails=function(){return y.showRail().showRailHr()},this.showRail=function(){return 0===y.page.maxh||!y.ispage&&"none"==y.win.css("display")||(y.visibility=!0,y.rail.visibility=!0,y.rail.css("display","block")),y},this.showRailHr=function(){return y.railh&&(0===y.page.maxw||!y.ispage&&"none"==y.win.css("display")||(y.railh.visibility=!0,y.railh.css("display","block"))),y},this.hideRails=function(){return y.hideRail().hideRailHr()},this.hideRail=function(){return y.visibility=!1,y.rail.visibility=!1,y.rail.css("display","none"),y},this.hideRailHr=function(){return y.railh&&(y.railh.visibility=!1,y.railh.css("display","none")),y},this.show=function(){return y.hidden=!1,y.railslocked=!1,y.showRails()},this.hide=function(){return y.hidden=!0,y.railslocked=!0,y.hideRails()},this.toggle=function(){return y.hidden?y.show():y.hide()},this.remove=function(){for(var e in y.stop(),y.cursortimeout&&clearTimeout(y.cursortimeout),y.delaylist)y.delaylist[e]&&L(y.delaylist[e].h);y.doZoomOut(),y.unbindAll(),N.isie9&&y.win[0].detachEvent("onpropertychange",y.onAttributeChange),!1!==y.observer&&y.observer.disconnect(),!1!==y.observerremover&&y.observerremover.disconnect(),!1!==y.observerbody&&y.observerbody.disconnect(),y.events=null,y.cursor&&y.cursor.remove(),y.cursorh&&y.cursorh.remove(),y.rail&&y.rail.remove(),y.railh&&y.railh.remove(),y.zoom&&y.zoom.remove();for(var t=0;t<y.saved.css.length;t++){var o=y.saved.css[t];o[0].css(o[1],void 0===o[2]?"":o[2])}y.saved=!1,y.me.data("__nicescroll","");var i=I.nicescroll;for(var a in i.each(function(e){if(this&&this.id===y.id){delete i[e];for(var t=++e;t<i.length;t++,e++)i[e]=i[t];--i.length&&delete i[i.length]}}),y)y[a]=null,delete y[a];y=null},this.scrollstart=function(e){return this.onscrollstart=e,y},this.scrollend=function(e){return this.onscrollend=e,y},this.scrollcancel=function(e){return this.onscrollcancel=e,y},this.zoomin=function(e){return this.onzoomin=e,y},this.zoomout=function(e){return this.onzoomout=e,y},this.isScrollable=function(e){var t=e.target?e.target:e;if("OPTION"==t.nodeName)return!0;for(;t&&1==t.nodeType&&t!==this.me[0]&&!/^BODY|HTML/.test(t.nodeName);){var o=I(t),i=o.css("overflowY")||o.css("overflowX")||o.css("overflow")||"";if(/scroll|auto/.test(i))return t.clientHeight!=t.scrollHeight;t=!!t.parentNode&&t.parentNode}return!1},this.getViewport=function(e){for(var t=!(!e||!e.parentNode)&&e.parentNode;t&&1==t.nodeType&&!/^BODY|HTML/.test(t.nodeName);){var o=I(t);if(/fixed|absolute/.test(o.css("position")))return o;var i=o.css("overflowY")||o.css("overflowX")||o.css("overflow")||"";if(/scroll|auto/.test(i)&&t.clientHeight!=t.scrollHeight)return o;if(0<o.getNiceScroll().length)return o;t=!!t.parentNode&&t.parentNode}return!1},this.triggerScrollStart=function(e,t,o,i,a){if(y.onscrollstart){var n={type:"scrollstart",current:{x:e,y:t},request:{x:o,y:i},end:{x:y.newscrollx,y:y.newscrolly},speed:a};y.onscrollstart.call(y,n)}},this.triggerScrollEnd=function(){if(y.onscrollend){var e=y.getScrollLeft(),t=y.getScrollTop(),o={type:"scrollend",current:{x:e,y:t},end:{x:e,y:t}};y.onscrollend.call(y,o)}};var f=0,v=0,G=0,b=1,w=!1;if(this.onmousewheel=function(e){if(y.wheelprevented||y.locked)return!1;if(y.railslocked)return y.debounced("checkunlock",y.resize,250),!1;if(y.rail.drag)return y.cancelEvent(e);if("auto"===O.oneaxismousemode&&0!==e.deltaX&&(O.oneaxismousemode=!1),O.oneaxismousemode&&0===e.deltaX&&!y.rail.scrollable)return!y.railh||!y.railh.scrollable||y.onmousewheelhr(e);var t=j(),o=!1;if(O.preservenativescrolling&&y.checkarea+600<t&&(y.nativescrollingarea=y.isScrollable(e),o=!0),y.checkarea=t,y.nativescrollingarea)return!0;var i=a(e,!1,o);return i&&(y.checkarea=0),i},this.onmousewheelhr=function(e){if(!y.wheelprevented){if(y.railslocked||!y.railh.scrollable)return!0;if(y.rail.drag)return y.cancelEvent(e);var t=j(),o=!1;return O.preservenativescrolling&&y.checkarea+600<t&&(y.nativescrollingarea=y.isScrollable(e),o=!0),y.checkarea=t,!!y.nativescrollingarea||(y.railslocked?y.cancelEvent(e):a(e,!0,o))}},this.stop=function(){return y.cancelScroll(),y.scrollmon&&y.scrollmon.stop(),y.cursorfreezed=!1,y.scroll.y=Math.round(y.getScrollTop()*(1/y.scrollratio.y)),y.noticeCursor(),y},this.getTransitionSpeed=function(e){return 80+e/72*O.scrollspeed|0},O.smoothscroll)if(y.ishwscroll&&N.hastransition&&O.usetransition&&O.smoothscroll){var x="";this.resetTransition=function(){x="",y.doc.css(N.prefixstyle+"transition-duration","0ms")},this.prepareTransition=function(e,t){var o=t?e:y.getTransitionSpeed(e),i=o+"ms";return x!==i&&(x=i,y.doc.css(N.prefixstyle+"transition-duration",i)),o},this.doScrollLeft=function(e,t){var o=y.scrollrunning?y.newscrolly:y.getScrollTop();y.doScrollPos(e,o,t)},this.doScrollTop=function(e,t){var o=y.scrollrunning?y.newscrollx:y.getScrollLeft();y.doScrollPos(o,e,t)},this.cursorupdate={running:!1,start:function(){var e=this;if(!e.running){e.running=!0;var t=function(){e.running&&U(t),y.showCursor(y.getScrollTop(),y.getScrollLeft()),y.notifyScrollEvent(y.win[0])};U(t)}},stop:function(){this.running=!1}},this.doScrollPos=function(e,t,o){var i=y.getScrollTop(),a=y.getScrollLeft();if(((y.newscrolly-i)*(t-i)<0||(y.newscrollx-a)*(e-a)<0)&&y.cancelScroll(),O.bouncescroll?(t<0?t=t/2|0:t>y.page.maxh&&(t=y.page.maxh+(t-y.page.maxh)/2|0),e<0?e=e/2|0:e>y.page.maxw&&(e=y.page.maxw+(e-y.page.maxw)/2|0)):(t<0?t=0:t>y.page.maxh&&(t=y.page.maxh),e<0?e=0:e>y.page.maxw&&(e=y.page.maxw)),y.scrollrunning&&e==y.newscrollx&&t==y.newscrolly)return!1;y.newscrolly=t,y.newscrollx=e;var n=y.getScrollTop(),r=y.getScrollLeft(),s={};s.x=e-r,s.y=t-n;var l=0|Math.sqrt(s.x*s.x+s.y*s.y),c=y.prepareTransition(l);y.scrollrunning||(y.scrollrunning=!0,y.triggerScrollStart(r,n,e,t,c),y.cursorupdate.start()),y.scrollendtrapped=!0,N.transitionend||(y.scrollendtrapped&&clearTimeout(y.scrollendtrapped),y.scrollendtrapped=setTimeout(y.onScrollTransitionEnd,c)),y.setScrollTop(y.newscrolly),y.setScrollLeft(y.newscrollx)},this.cancelScroll=function(){if(!y.scrollendtrapped)return!0;var e=y.getScrollTop(),t=y.getScrollLeft();return y.scrollrunning=!1,N.transitionend||clearTimeout(N.transitionend),y.scrollendtrapped=!1,y.resetTransition(),y.setScrollTop(e),y.railh&&y.setScrollLeft(t),y.timerscroll&&y.timerscroll.tm&&clearInterval(y.timerscroll.tm),y.timerscroll=!1,y.cursorfreezed=!1,y.cursorupdate.stop(),y.showCursor(e,t),y},this.onScrollTransitionEnd=function(){if(y.scrollendtrapped){var e=y.getScrollTop(),t=y.getScrollLeft();if(e<0?e=0:e>y.page.maxh&&(e=y.page.maxh),t<0?t=0:t>y.page.maxw&&(t=y.page.maxw),e!=y.newscrolly||t!=y.newscrollx)return y.doScrollPos(t,e,O.snapbackspeed);y.scrollrunning&&y.triggerScrollEnd(),y.scrollrunning=!1,y.scrollendtrapped=!1,y.resetTransition(),y.timerscroll=!1,y.setScrollTop(e),y.railh&&y.setScrollLeft(t),y.cursorupdate.stop(),y.noticeCursor(!1,e,t),y.cursorfreezed=!1}}}else this.doScrollLeft=function(e,t){var o=y.scrollrunning?y.newscrolly:y.getScrollTop();y.doScrollPos(e,o,t)},this.doScrollTop=function(e,t){var o=y.scrollrunning?y.newscrollx:y.getScrollLeft();y.doScrollPos(o,e,t)},this.doScrollPos=function(e,t,o){var i=y.getScrollTop(),a=y.getScrollLeft();((y.newscrolly-i)*(t-i)<0||(y.newscrollx-a)*(e-a)<0)&&y.cancelScroll();var n=!1;if(y.bouncescroll&&y.rail.visibility||(t<0?n=!(t=0):t>y.page.maxh&&(t=y.page.maxh,n=!0)),y.bouncescroll&&y.railh.visibility||(e<0?n=!(e=0):e>y.page.maxw&&(e=y.page.maxw,n=!0)),y.scrollrunning&&y.newscrolly===t&&y.newscrollx===e)return!0;y.newscrolly=t,y.newscrollx=e,y.dst={},y.dst.x=e-a,y.dst.y=t-i,y.dst.px=a,y.dst.py=i;var r=0|Math.sqrt(y.dst.x*y.dst.x+y.dst.y*y.dst.y),s=y.getTransitionSpeed(r);y.bzscroll={};var l=n?1:.58;y.bzscroll.x=new u(a,y.newscrollx,s,0,0,l,1),y.bzscroll.y=new u(i,y.newscrolly,s,0,0,l,1),j();var c=function(){if(y.scrollrunning){var e=y.bzscroll.y.getPos();y.setScrollLeft(y.bzscroll.x.getNow()),y.setScrollTop(y.bzscroll.y.getNow()),e<=1?y.timer=U(c):(y.scrollrunning=!1,y.timer=0,y.triggerScrollEnd())}};y.scrollrunning||(y.triggerScrollStart(a,i,e,t,s),y.scrollrunning=!0,y.timer=U(c))},this.cancelScroll=function(){return y.timer&&L(y.timer),y.timer=0,y.bzscroll=!1,y.scrollrunning=!1,y};else this.doScrollLeft=function(e,t){var o=y.getScrollTop();y.doScrollPos(e,o,t)},this.doScrollTop=function(e,t){var o=y.getScrollLeft();y.doScrollPos(o,e,t)},this.doScrollPos=function(e,t,o){var i=e>y.page.maxw?y.page.maxw:e;i<0&&(i=0);var a=t>y.page.maxh?y.page.maxh:t;a<0&&(a=0),y.synched("scroll",function(){y.setScrollTop(a),y.setScrollLeft(i)})},this.cancelScroll=function(){};this.doScrollBy=function(e,t){s(0,e)},this.doScrollLeftBy=function(e,t){s(e,0)},this.doScrollTo=function(e,t){var o=t?Math.round(e*y.scrollratio.y):e;o<0?o=0:o>y.page.maxh&&(o=y.page.maxh),y.cursorfreezed=!1,y.doScrollTop(e)},this.checkContentSize=function(){var e=y.getContentSize();e.h==y.page.h&&e.w==y.page.w||y.resize(!1,e)},y.onscroll=function(e){y.rail.drag||y.cursorfreezed||y.synched("scroll",function(){y.scroll.y=Math.round(y.getScrollTop()/y.scrollratio.y),y.railh&&(y.scroll.x=Math.round(y.getScrollLeft()/y.scrollratio.x)),y.noticeCursor()})},y.bind(y.docscroll,"scroll",y.onscroll),this.doZoomIn=function(e){if(!y.zoomactive){y.zoomactive=!0,y.zoomrestore={style:{}};var t=["position","top","left","zIndex","backgroundColor","marginTop","marginBottom","marginLeft","marginRight"],o=y.win[0].style;for(var i in t){var a=t[i];y.zoomrestore.style[a]=void 0!==o[a]?o[a]:""}y.zoomrestore.style.width=y.win.css("width"),y.zoomrestore.style.height=y.win.css("height"),y.zoomrestore.padding={w:y.win.outerWidth()-y.win.width(),h:y.win.outerHeight()-y.win.height()},N.isios4&&(y.zoomrestore.scrollTop=R.scrollTop(),R.scrollTop(0)),y.win.css({position:N.isios4?"absolute":"fixed",top:0,left:0,zIndex:M+100,margin:0});var n=y.win.css("backgroundColor");return(""===n||/transparent|rgba\(0, 0, 0, 0\)|rgba\(0,0,0,0\)/.test(n))&&y.win.css("backgroundColor","#fff"),y.rail.css({zIndex:M+101}),y.zoom.css({zIndex:M+102}),y.zoom.css("backgroundPosition","0 -18px"),y.resizeZoom(),y.onzoomin&&y.onzoomin.call(y),y.cancelEvent(e)}},this.doZoomOut=function(e){if(y.zoomactive)return y.zoomactive=!1,y.win.css("margin",""),y.win.css(y.zoomrestore.style),N.isios4&&R.scrollTop(y.zoomrestore.scrollTop),y.rail.css({"z-index":y.zindex}),y.zoom.css({"z-index":y.zindex}),y.zoomrestore=!1,y.zoom.css("backgroundPosition","0 0"),y.onResize(),y.onzoomout&&y.onzoomout.call(y),y.cancelEvent(e)},this.doZoom=function(e){return y.zoomactive?y.doZoomOut(e):y.doZoomIn(e)},this.resizeZoom=function(){if(y.zoomactive){var e=y.getScrollTop();y.win.css({width:R.width()-y.zoomrestore.padding.w+"px",height:R.height()-y.zoomrestore.padding.h+"px"}),y.onResize(),y.setScrollTop(Math.min(y.page.maxh,e))}},this.init(),I.nicescroll.push(this)},z=function(e){var g=this;this.nc=e,this.lastx=0,this.lasty=0,this.speedx=0,this.speedy=0,this.lasttime=0,this.steptime=0,this.snapx=!1,this.snapy=!1,this.demulx=0,this.demuly=0,this.lastscrollx=-1,this.lastscrolly=-1,this.chkx=0,this.chky=0,this.timer=0,this.reset=function(e,t){g.stop(),g.steptime=0,g.lasttime=j(),g.speedx=0,g.speedy=0,g.lastx=e,g.lasty=t,g.lastscrollx=-1,g.lastscrolly=-1},this.update=function(e,t){var o=j();g.steptime=o-g.lasttime,g.lasttime=o;var i=t-g.lasty,a=e-g.lastx,n=g.nc.getScrollTop()+i,r=g.nc.getScrollLeft()+a;g.snapx=r<0||r>g.nc.page.maxw,g.snapy=n<0||n>g.nc.page.maxh,g.speedx=a,g.speedy=i,g.lastx=e,g.lasty=t},this.stop=function(){g.nc.unsynched("domomentum2d"),g.timer&&clearTimeout(g.timer),g.timer=0,g.lastscrollx=-1,g.lastscrolly=-1},this.doSnapy=function(e,t){var o=!1;t<0?o=!(t=0):t>g.nc.page.maxh&&(t=g.nc.page.maxh,o=!0),e<0?o=!(e=0):e>g.nc.page.maxw&&(e=g.nc.page.maxw,o=!0),o?g.nc.doScrollPos(e,t,g.nc.opt.snapbackspeed):g.nc.triggerScrollEnd()},this.doMomentum=function(e){var t=j(),o=e?t+e:g.lasttime,i=g.nc.getScrollLeft(),a=g.nc.getScrollTop(),n=g.nc.page.maxh,r=g.nc.page.maxw;g.speedx=0<r?Math.min(60,g.speedx):0,g.speedy=0<n?Math.min(60,g.speedy):0;var s=o&&t-o<=60;(a<0||n<a||i<0||r<i)&&(s=!1);var l=!(!g.speedy||!s)&&g.speedy,c=!(!g.speedx||!s)&&g.speedx;if(l||c){var u=Math.max(16,g.steptime);if(50<u){var d=u/50;g.speedx*=d,g.speedy*=d,u=50}g.demulxy=0,g.lastscrollx=g.nc.getScrollLeft(),g.chkx=g.lastscrollx,g.lastscrolly=g.nc.getScrollTop(),g.chky=g.lastscrolly;var h=g.lastscrollx,p=g.lastscrolly,m=function(){var e=600<j()-t?.04:.02;g.speedx&&(h=Math.floor(g.lastscrollx-g.speedx*(1-g.demulxy)),((g.lastscrollx=h)<0||r<h)&&(e=.1)),g.speedy&&(p=Math.floor(g.lastscrolly-g.speedy*(1-g.demulxy)),((g.lastscrolly=p)<0||n<p)&&(e=.1)),g.demulxy=Math.min(1,g.demulxy+e),g.nc.synched("domomentum2d",function(){g.speedx&&(g.nc.getScrollLeft(),g.chkx=h,g.nc.setScrollLeft(h)),g.speedy&&(g.nc.getScrollTop(),g.chky=p,g.nc.setScrollTop(p)),g.timer||(g.nc.hideCursor(),g.doSnapy(h,p))}),g.demulxy<1?g.timer=setTimeout(m,u):(g.stop(),g.nc.hideCursor(),g.doSnapy(h,p))};m()}else g.doSnapy(g.nc.getScrollLeft(),g.nc.getScrollTop())}},a=e.fn.scrollTop;e.cssHooks.pageYOffset={get:function(e,t,o){var i=I.data(e,"__nicescroll")||!1;return i&&i.ishwscroll?i.getScrollTop():a.call(e)},set:function(e,t){var o=I.data(e,"__nicescroll")||!1;return o&&o.ishwscroll?o.setScrollTop(parseInt(t)):a.call(e,t),this}},e.fn.scrollTop=function(t){if(void 0===t){var e=!!this[0]&&(I.data(this[0],"__nicescroll")||!1);return e&&e.ishwscroll?e.getScrollTop():a.call(this)}return this.each(function(){var e=I.data(this,"__nicescroll")||!1;e&&e.ishwscroll?e.setScrollTop(parseInt(t)):a.call(I(this),t)})};var r=e.fn.scrollLeft;I.cssHooks.pageXOffset={get:function(e,t,o){var i=I.data(e,"__nicescroll")||!1;return i&&i.ishwscroll?i.getScrollLeft():r.call(e)},set:function(e,t){var o=I.data(e,"__nicescroll")||!1;return o&&o.ishwscroll?o.setScrollLeft(parseInt(t)):r.call(e,t),this}},e.fn.scrollLeft=function(t){if(void 0===t){var e=!!this[0]&&(I.data(this[0],"__nicescroll")||!1);return e&&e.ishwscroll?e.getScrollLeft():r.call(this)}return this.each(function(){var e=I.data(this,"__nicescroll")||!1;e&&e.ishwscroll?e.setScrollLeft(parseInt(t)):r.call(I(this),t)})};var l=function(e){var t=this;if(this.length=0,this.name="nicescrollarray",this.each=function(e){return I.each(t,e),t},this.push=function(e){t[t.length]=e,t.length++},this.eq=function(e){return t[e]},e)for(var o=0;o<e.length;o++){var i=I.data(e[o],"__nicescroll")||!1;i&&(this[this.length]=i,this.length++)}return this};!function(e,t,o){for(var i=0,a=t.length;i<a;i++)o(e,t[i])}(l.prototype,["show","hide","toggle","onResize","resize","remove","stop","doScrollPos"],function(e,t){e[t]=function(){var e=arguments;return this.each(function(){this[t].apply(this,e)})}}),e.fn.getNiceScroll=function(e){return void 0===e?new l(this):this[e]&&I.data(this[e],"__nicescroll")||!1},(e.expr.pseudos||e.expr[":"]).nicescroll=function(e){return void 0!==I.data(e,"__nicescroll")},I.fn.niceScroll=function(a,n){void 0!==n||"object"!=typeof a||"jquery"in a||(n=a,a=!1);var r=new l;return this.each(function(){var e=I(this),t=I.extend({},n);if(a){var o=I(a);t.doc=1<o.length?I(a,e):o,t.win=e}!("doc"in t)||"win"in t||(t.win=e);var i=e.data("__nicescroll")||!1;i||(t.doc=t.doc||e,i=new s(t,e),e.data("__nicescroll",i)),r.push(i)}),1===r.length?r[0]:r},V.NiceScroll={getjQuery:function(){return e}},I.nicescroll||(I.nicescroll=new l,I.nicescroll.options=D)});var projectSelector=null,sourceCurrentProjectName="",scenesList=null,ScenesManagerPanel=function(a){var e=a.signals,t=new UI.Panel;t.setId("scenesManagerPanel");var o=new UI.Row;t.add(o),e.projectInfoChange.add(function(e,t,o){a.saveProjectInfoToStorage(allProjectJsonDictionary)});var i=new UI.Panel;i.setId("projectBuildPanel");var n=new UI.ButtonIcon("css/pic/logoWhite.png","","center center","");n.setPosition("relative"),n.setWidth("190px"),n.setHeight("190px"),n.dom.title=GetLanguage("Splash Image"),i.add(n),i.add(new UI.HorizontalRule),(projectSelector=new UI.Panel).setId("projectSelector"),i.add(projectSelector);var r=new UI.HorizontalRule;i.add(r);var s=new UI.Row,l=new UI.ButtonIcon("css/pic/plus.png","","10% center",GetLanguage("New Project"));l.setBackgroundColor("#262626"),l.setPosition("absolute"),l.setLeft("5px"),l.setWidth("120px"),l.dom.title=GetLanguage("create new project"),l.onClick(function(e){var t=Utils.RenameFunc(allProjectJsonDictionary,"",GetLanguage("New Tong Project")),o=new ScenesManagerPanel.ProjectSelectorEle(a,t);projectSelector.add(o.element),allProjectJsonDictionary.get("metadata")||allProjectJsonDictionary.put("metadata",{type:"TongProject"}),a.setProjectInfo(t,"","")}),s.add(l);var c=new UI.ButtonIcon("css/pic/edit.png","","center center","");c.setPosition("absolute"),c.setLeft("135px"),c.setWidth("20px"),c.setHeight("20px"),c.dom.title=GetLanguage("rename project"),s.add(c),c.onClick(function(e){sourceCurrentProjectName=$("#projectSelector .Button.active").text(),$("#projectSelector .Input.active").text(sourceCurrentProjectName+""),$("#projectSelector .Button.active").text(""),$("#projectSelector .Input.active").css("display",""),$("#projectSelector .Input.active")[0].focus(),$("#projectSelector .Input.active").select()});var u=new UI.ButtonIcon("css/pic/crash.png","","center center","");u.setPosition("absolute"),u.setLeft("165px"),u.setWidth("20px"),u.setHeight("20px"),u.dom.title=GetLanguage("delete project"),u.onClick(function(e){var t=$("#projectSelector .Button.active").text(),o=allProjectJsonDictionary.get(t).renameRef,i=allProjectJsonDictionary.get(o+"");i&&Utils.ChangeRenameId(i,!1),$(".projectSelectorRow.active").remove(),delete allProjectJsonDictionary.data[t+""],a.setProjectInfo("","","")}),s.add(u),i.add(s),o.add(i);var d=new UI.Row;d.setPosition("absolute"),d.setBottom("2px"),d.setLeft("5px"),i.add(d);var h=new UI.ButtonIcon("css/pic/server.png","#262626","10% center",GetLanguage("Data From Server"));h.setWidth("150px"),h.setLeft("15px"),d.add(h);Utils.OnClick(h,function(e,t){},!0,!1,"#262626","#153c5e");var p=new UI.Panel;p.setPosition("absolute"),p.setId("scenesBuildPanel"),o.add(p);var m=Utils.Panel.AddHeader("Row",GetLanguage("Scenes"),"ScenesBtn",null,"css/pic/sceneIcon.png");p.add(m),(scenesList=new UI.Panel).setClass("ScenesListManager"),scenesList.setPosition("relative"),scenesList.setWidth("100%"),scenesList.setHeight("502px"),p.add(scenesList),p.add(new UI.HorizontalRule);var g=new UI.Row,f=new UI.ButtonIcon("css/pic/plus.png","#262626","5% center",GetLanguage("Add New Scene"));f.setPosition("absolute"),f.setWidth("190px"),f.setRight("400px"),f.onClick(function(e){0!=$("#projectSelector .Button.active").length&&ScenesManagerPanel.AddNewSceneInCurrent(a,$("#projectSelector .Button.active").text(),GetLanguage("New Tong Scene"))}),g.add(f);var v=new UI.ButtonIcon("css/pic/upload.png","#262626","5% center",GetLanguage("Upload Project To Server"));v.setPosition("absolute"),v.setWidth("190px"),v.setRight("195px"),g.add(v);var y=new UI.ButtonIcon("css/pic/export.png","#262626","5% center",GetLanguage("Build Current Project"));return y.setPosition("absolute"),y.setWidth("170px"),y.setRight("10px"),g.add(y),y.onClick(function(){Utils.Building(a,!0)}),p.add(g),t},currentSceneJsonData=null,allProjectJsonDictionary=new Utils.Dictionary;ScenesManagerPanel.ApplyStorageData=function(e,t){for(var o in e.projectsJsonData=allProjectJsonDictionary=new Utils.Dictionary(t),allProjectJsonDictionary.data)if("metadata"!=o){var i=new ScenesManagerPanel.ProjectSelectorEle(e,o+"");projectSelector.add(i.element)}},ScenesManagerPanel.RefreshPanel=function(e){for(var t in $(".projectSelectorRow").remove(),$(".scenesEle").remove(),allProjectJsonDictionary.data)if("metadata"!=t){var o=new ScenesManagerPanel.ProjectSelectorEle(e,t+"");projectSelector.add(o.element)}},ScenesManagerPanel.AddNewSceneInCurrent=function(e,t,o,i){var a=allProjectJsonDictionary.get(t),n=null;n=i?o:Utils.RenameFunc(a,"",o+"");var r=ScenesManagerPanel.ScenesSelectorPanel(e,n);scenesList.add(r.eleRow);var s=a[n].sceneTime,l="";if(s)r.eleTime.dom.value=s+"",l=s;else{var c=Utils.GetCurrentFullTime();a[n].sceneTime=c,r.eleTime.dom.value=c+"",l=c}return i||e.setProjectInfo(e.currentProjectName,n,l),a[n].metadata={},a[n].metadata.type="TongScene",r},ScenesManagerPanel.ScenesSelectorPanel=function(n,a){var r=new UI.Button("");r.setClass("scenesEle"),r.onClick(function(e){$(".scenesEle").attr("class","scenesEle"),r.setClass("scenesEle active")}),r.onDblClick(function(e){var t=allProjectJsonDictionary.get($("#projectSelector .Button.active").text()+"");n.setProjectInfo($("#projectSelector .Button.active").text(),s.getValue(),u.getValue(),!0);var o=t[s.getValue()+""];if($("#TransparentBackPanel").css("display","none"),o&&currentSceneJsonData&&o.GUID==currentSceneJsonData.GUID)$("#scenesManagerPanel").css("display","none");else{if((currentSceneJsonData=o).data){JSON.parse(JSON.stringify(currentSceneJsonData.data));n.fromJSON(currentSceneJsonData.data)}else{var i=n.getDefaultJson(s.getValue()+"");allProjectJsonDictionary.get($("#projectSelector .Button.active").text()+"")[s.getValue()+""].data=i,n.fromJSON(i)}var a=n.config.getKey("selected");void 0!==a&&n.selectByUuid(a),$("#scenesManagerPanel").css("display","none"),n.saveProjectInfoToStorage(allProjectJsonDictionary),n.signals.storageGetFinish.dispatch(),n.startAutoSave()}});var e=new UI.Checkbox(!0);e.setPosition("absolute"),e.setLeft("1%"),e.setTop("40%"),r.add(e);var s=new UI.Input(""+a);s.setPosition("absolute"),s.setLeft("5%"),s.setTop("20%"),s.setBackground("Transparent"),s.setColor("#bbbbbb"),s.setDisabled("disabled"),r.add(s);var i=!1,l=!1,c="";function t(e){var t="";if(!l||!i){if(c!=s.getValue()&&""!=Utils.Trim(s.getValue())){var o=allProjectJsonDictionary.get($("#projectSelector .Button.active").text()+"");t=Utils.RenameFunc(o,c,s.getValue()),n.currentSceneName=t,n.currentSceneTime=o.sceneTime,n.setProjectInfo(n.currentProjectName,n.currentSceneName,n.currentSceneTime)}else t=c;s.setDisabled("disabled"),s.dom.value=t,c=""}}s.onBlur(function(e){i=!0,t(),l=!1}),s.onKeyDown(function(e){13==e.keyCode&&(i=!(l=!0),t())});var u=new UI.Input("");u.setClass("CreateTime"),u.setPosition("absolute"),u.setLeft("5%"),u.setTop("60%"),u.setBackground("Transparent"),u.setDisabled("disabled"),r.add(u);var o=new UI.ButtonIcon("css/pic/crash.png","","center center","");o.setPosition("absolute"),o.setRight("20px"),o.setTop("40%"),o.setWidth("14px"),o.setHeight("14px"),o.onClick(function(e){var t=$("#projectSelector .Button.active").text(),o=allProjectJsonDictionary.get(t),i=o[o[a+""].renameRef+""];i&&Utils.ChangeRenameId(i,!1),delete o[a+""],n.setProjectInfo(t+"","",""),$(r.dom).remove()}),r.add(o);var d=new UI.ButtonIcon("css/pic/edit.png","","center center","");return d.setPosition("absolute"),d.setRight("60px"),d.setTop("40%"),d.setWidth("14px"),d.setHeight("14px"),d.setStyle("z-index",[1]),d.onClick(function(e){c=s.getValue(),$(s.dom).removeAttr("disabled"),$(s.dom).focus(),$(s.dom).select()}),r.add(d),{eleRow:r,eleTime:u}},ScenesManagerPanel.ProjectSelectorEle=function(i,e){var a=new UI.Row;a.setPosition("relative"),a.setHeight("40px"),a.setClass("projectSelectorRow");var n=new UI.Button(e+"");n.setPosition("absolute"),n.setWidth("190px"),n.setHeight("40px"),n.setBorder("1px solid #262626");var r=new UI.Input(e+"");r.setDisplay("none"),r.setPosition("absolute"),r.setBorder("0px"),r.setBackground("none"),r.setHeight("40px"),r.setWidth("190px"),r.setTextAlign("center"),a.add(n),a.add(r),n.onClick(function(e){$(".scenesEle").remove(),$("#projectSelector .Button").attr("class","Button"),$(e.target).attr("class","Button active"),$("#projectSelector .Input").attr("class","Input"),$(r.dom).attr("class","Input active"),$(".projectSelectorRow").attr("class","projectSelectorRow"),$(a.dom).attr("class","projectSelectorRow active");var t=allProjectJsonDictionary.get(n.dom.textContent);if(t)for(var o in t)"renameRef"!=o&&"renameId"!=o&&"metadata"!=o&&"GUID"!=o&&ScenesManagerPanel.AddNewSceneInCurrent(i,n.dom.textContent,o+"",!0)});var o=!1,s=!1;function t(e){var t="";s&&o||(sourceCurrentProjectName!=r.getValue()&&""!=Utils.Trim(r.getValue())?(t=Utils.RenameFunc(allProjectJsonDictionary,sourceCurrentProjectName,r.getValue()),i.currentProjectName=t,i.setProjectInfo(i.currentProjectName,"","")):t=sourceCurrentProjectName,r.setDisplay("none"),n.setTextContent(t),sourceCurrentProjectName="")}return r.onBlur(function(e){o=!0,t(),s=!1}),r.onKeyDown(function(e){13==e.keyCode&&(o=!(s=!0),t())}),{element:a,eleBtn:n,eleText:r}};var TransparentBackPanel=function(e){var t=new UI.Panel;return t.setPosition("absolute"),t.setLeft("0px"),t.setTop("0px"),t.setId("TransparentBackPanel"),Utils.OnStart.add(function(){function e(){t.setWidth(document.body.clientWidth+"px"),t.setHeight(document.body.clientWidth+"px")}e(),$(window).resize(function(){e()})}),t.setBackgroundColor("#222"),t.setOpacity("0.7"),t},LoginAndSignUp=function(e){var t=new UI.Panel,o=new LoginAndSignUp.Login(e);t.add(o);var i=new LoginAndSignUp.Register(e);return i.setDisplay("none"),t.add(i),t};LoginAndSignUp.Register=function(e){var t=new UI.Panel;t.setId("RegisterPanel"),t.setPosition("absolute"),t.setWidth("385px"),t.setHeight("425px"),t.setBackgroundColor("#303030"),t.setLeft("40%"),t.setTop("20%"),t.setBorder("1px solid #303030");var o=new UI.Form("post");o.setAttribute("action","http://account.tong3d.com/member/email-register"),o.setId("RegisterForm"),Utils.OnStart.add(function(){$("#RegisterForm :input").blur(function(){if($(this).is(c.dom))""==Utils.Trim(this.value)||Utils.Trim(this.value).length<3?(this.title="请输入至少3位的用户名",O.contain(l)||O.push(l)):(this.title="",O.contain(l)&&(O.remove(l),l.setDisplay("none")));else if($(this).is(h.dom))if(""==Utils.Trim(this.value)||""!=Utils.Trim(this.value)&&!/.+@.+\.[a-zA-Z]{2,4}$/.test(Utils.Trim(this.value))){this.title="请输入正确的E-Mail地址",O.contain(d)||O.push(d)}else{this.title="",O.contain(d)&&(O.remove(d),d.setDisplay("none"))}else $(this).is(g.dom)?""==Utils.Trim(this.value)||Utils.Trim(this.value).length<6?(this.title="请输入至少6位的密码",O.contain(m)||O.push(m)):(this.title="",O.contain(m)&&(O.remove(m),m.setDisplay("none"))):$(this).is(T.dom)&&(Utils.Trim(this.value)!=g.dom.value?(this.title="密码输入不一致",O.contain(v)||O.push(v)):""==Utils.Trim(this.value)?(this.title="确认密码不能为空",O.contain(v)||O.push(v)):(this.title="",O.contain(v)&&(O.remove(v),v.setDisplay("none"))))}).keyup(function(){$(this).triggerHandler("blur")}).focus(function(){$(this).triggerHandler("blur")})}),t.add(o);var i=new UI.Row;i.setPosition("relative"),i.setWidth("385px"),i.setHeight("130px"),o.add(i);var a=new UI.Button("Login");a.setPosition("absolute"),a.setWidth("150px"),a.setHeight("130px"),a.setBackgroundColor("#262626"),a.onClick(function(){$("#LoginPanel").css("display",""),t.setDisplay("none")}),i.add(a);var n=new UI.ButtonIcon("css/pic/toolBar/logoMini.png","#262626","50% 50%","");n.setPosition("absolute"),n.setLeft("150px"),n.setWidth("85px"),n.setHeight("130px"),n.setBackgroundColor("#262626"),i.add(n),(y=new UI.Button("Register")).setPosition("absolute"),y.setLeft("235px"),y.setWidth("150px"),y.setHeight("130px"),y.setBackgroundColor("#262626"),y.setBackground("url('css/pic/angleLeft.png') no-repeat 76% 50% #262626"),i.add(y);var r=new UI.Row;r.setPosition("relative"),r.setWidth("385px"),r.setHeight("125px"),o.add(r);var s=new UI.Row("");s.setPosition("absolute"),s.setWidth("379px"),s.setHeight("62.5px"),s.setBackgroundColor("#282828"),s.setBorder("1px solid #303030"),r.add(s);var l=new UI.ButtonIcon("css/pic/stop.png","#282828","50% 50%","");l.setPosition("absolute"),l.setDisplay("none"),l.setTop("35%"),l.setRight("5%"),l.setWidth("16px"),l.setHeight("16px"),l.setZIndex("1"),s.add(l);var c=new UI.Input("");c.setPosition("absolute"),c.setLeft("20px"),c.setWidth("357px"),c.setHeight("56px"),c.setBackgroundColor("#282828"),c.dom.placeholder="User Name",c.dom.type="text",c.dom.title="请输入至少3位的用户名",c.setAttribute("maxlength","15"),c.setAttribute("name","username"),s.add(c);var u=new UI.Row("");u.setPosition("absolute"),u.setTop("62.5px"),u.setWidth("379px"),u.setHeight("62.5px"),u.setBackgroundColor("#282828"),u.setBorder("1px solid #303030"),r.add(u);var d=new UI.ButtonIcon("css/pic/stop.png","#282828","50% 50%","");d.setPosition("absolute"),d.setTop("35%"),d.setRight("5%"),d.setWidth("16px"),d.setHeight("16px"),d.setDisplay("none"),d.setZIndex("1"),u.add(d);var h=new UI.Input("");h.setPosition("absolute"),h.setLeft("20px"),h.setWidth("357px"),h.setHeight("56px"),h.setBackgroundColor("#282828"),h.dom.placeholder="Email",h.dom.title="请输入正确的E-Mail地址",h.setAttribute("name","email"),u.add(h);var p=new UI.Row;p.setPosition("absolute"),p.setTop("125px"),p.setWidth("379px"),p.setHeight("62.5px"),p.setBackgroundColor("#282828"),p.setBorder("1px solid #303030"),r.add(p);var m=new UI.ButtonIcon("css/pic/stop.png","#282828","50% 50%","");m.setPosition("absolute"),m.setTop("35%"),m.setWidth("16px"),m.setHeight("16px"),m.setRight("5%"),m.setDisplay("none"),m.setZIndex("1"),p.add(m);var g=new UI.Input("");g.setPosition("absolute"),g.setLeft("20px"),g.setWidth("357px"),g.setHeight("56px"),g.setBackgroundColor("#282828"),g.dom.placeholder="Password",g.dom.type="password",g.dom.title="请输入至少6位的密码",g.setAttribute("name","password"),p.add(g);var f=new UI.Row;f.setPosition("absolute"),f.setTop("187.5px"),f.setWidth("379px"),f.setHeight("62.5px"),f.setBackgroundColor("#282828"),f.setBorder("1px solid #303030"),r.add(f);var v=new UI.ButtonIcon("css/pic/stop.png","#282828","50% 50%","");v.setPosition("absolute"),v.setTop("35%"),v.setWidth("16px"),v.setHeight("16px"),v.setRight("5%"),v.setZIndex("1"),v.setDisplay("none"),f.add(v);var y,T=new UI.Input("");T.setPosition("absolute"),T.setLeft("20px"),T.setWidth("357px"),T.setHeight("56px"),T.setBackgroundColor("#282828"),T.dom.placeholder="Re-Type Password",T.dom.type="password",T.dom.title="确认密码不能为空",T.setAttribute("name","password2"),f.add(T),(y=new UI.Button("Register")).setPosition("absolute"),y.setTop("382px"),y.setWidth("385px"),y.setHeight("51px"),y.setBackground("#262626"),y.onClick(function(){if(0<O.length)for(var e=0;e<O.length;e++)$(O[e].dom).css("display","");else $.post("http://account.tong3d.com/member/email-register",{email:h.getValue(),username:c.getValue(),password:g.getValue(),password2:T.getValue()},function(e){alert(e)})}),o.add(y);var O=[l,d,m,v],N=new UI.Text("Or Use");N.setPosition("relative"),N.setLeft("172px"),N.setTop("200px"),N.setFontSize("10px"),N.setHeight("51px"),N.setColor("#aaa"),t.add(N);var G=new UI.Row;G.setPosition("relative"),G.setBackgroundColor("#262626"),G.setTop("180px"),G.setWidth("385px"),G.setHeight("51px"),G.setBorder("1px solid #303030"),t.add(G);var b=new UI.ButtonIcon("css/pic/mobile.png","#262626","2% 50%","Mobile Phone Registration");return b.setPosition("absolute"),b.setLeft("1%"),b.setTop("15%"),b.setWidth("200px"),b.setHeight("32px"),G.add(b),t},LoginAndSignUp.Login=function(e){var t=new UI.Panel;t.setId("LoginPanel"),t.setPosition("absolute"),t.setWidth("385px"),t.setHeight("305px"),t.setBackgroundColor("#303030"),t.setLeft("40%"),t.setTop("20%"),t.setBorder("1px solid #303030");var o=new UI.Form("post");o.setId("LoginForm"),t.add(o);var i=new UI.Row;i.setPosition("relative"),i.setWidth("385px"),i.setHeight("130px"),o.add(i),(p=new UI.Button("Login")).setPosition("absolute"),p.setWidth("150px"),p.setHeight("130px"),p.setBackgroundColor("#262626"),p.setBackground("url('css/pic/angleRight.png') no-repeat 30% 50% #262626"),i.add(p);var a=new UI.ButtonIcon("css/pic/toolBar/logoMini.png","#262626","50% 50%","");a.setPosition("absolute"),a.setLeft("150px"),a.setWidth("85px"),a.setHeight("130px"),a.setBackgroundColor("#262626"),i.add(a);var n=new UI.Button("Register");n.setPosition("absolute"),n.setLeft("235px"),n.setWidth("150px"),n.setHeight("130px"),n.setBackgroundColor("#262626"),n.onClick(function(){$("#RegisterPanel").css("display",""),t.setDisplay("none")}),i.add(n);var r=new UI.Row;r.setPosition("relative"),r.setWidth("385px"),r.setHeight("125px"),o.add(r);var s=new UI.Row("");s.setPosition("absolute"),s.setWidth("379px"),s.setHeight("62.5px"),s.setBackgroundColor("#282828"),s.setBorder("1px solid #303030"),r.add(s);var l=new UI.Input("");l.setPosition("absolute"),l.setLeft("20px"),l.setWidth("357px"),l.setHeight("56px"),l.setBackgroundColor("#282828"),l.dom.placeholder="User Name",s.add(l);var c=new UI.ButtonIcon("css/pic/stop.png","#282828","50% 50%","");c.setPosition("absolute"),c.setDisplay("none"),c.setTop("35%"),c.setRight("5%"),c.setWidth("16px"),c.setHeight("16px"),c.setZIndex("1"),s.add(c);var u=new UI.Row;u.setPosition("absolute"),u.setTop("62.5px"),u.setWidth("379px"),u.setHeight("62.5px"),u.setBackgroundColor("#282828"),u.setBorder("1px solid #303030"),r.add(u);var d=new UI.Input("");d.setPosition("absolute"),d.setLeft("20px"),d.setWidth("357px"),d.setHeight("56px"),d.setBackgroundColor("#282828"),d.dom.placeholder="Password",d.dom.type="password";var h=new UI.ButtonIcon("css/pic/stop.png","#282828","50% 50%","");h.setPosition("absolute"),h.setTop("35%"),h.setRight("5%"),h.setWidth("16px"),h.setHeight("16px"),h.setDisplay("none"),h.setZIndex("1"),u.add(d),u.add(h);var p,m=[c,h];Utils.OnStart.add(function(){$("#LoginForm :input").blur(function(){$(this).is(l.dom)?""==Utils.Trim(this.value)||Utils.Trim(this.value).length<3?(this.title="请输入至少3位的用户名",m.contain(c)||m.push(c)):(this.title="",m.contain(c)&&(m.remove(c),c.setDisplay("none"))):$(this).is(d.dom)&&(""==Utils.Trim(this.value)||Utils.Trim(this.value).length<6?(this.title="请输入至少6位的密码",m.contain(h)||m.push(h)):(this.title="",m.contain(h)&&(m.remove(h),h.setDisplay("none"))))}).keyup(function(){$(this).triggerHandler("blur")}).focus(function(){$(this).triggerHandler("blur")})}),(p=new UI.Button("Login")).setPosition("relative"),p.setWidth("385px"),p.setHeight("51px"),p.setBackground("#262626"),p.onClick(function(){if(0<m.length)for(var e=0;e<m.length;e++)$(m[e].dom).css("display","");else $.post("http://account.tong3d.com/member/email-register",{username:l.getValue(),password:d.getValue()},function(e){alert(e)})}),o.add(p);var g=new UI.Text("Or Use");g.setPosition("relative"),g.setLeft("172px"),g.setTop("20px"),g.setFontSize("10px"),g.setHeight("51px"),g.setColor("#aaa"),t.add(g);var f=new UI.Row;f.setPosition("relative"),f.setBackgroundColor("#262626"),f.setWidth("385px"),f.setHeight("51px"),f.setBorder("1px solid #303030"),t.add(f);var v=new UI.ButtonIcon("css/pic/qq.png","#262626","50% 50%","");v.setPosition("absolute"),v.setLeft("20%"),v.setTop("15%"),v.setWidth("32px"),v.setHeight("32px"),f.add(v);var y=new UI.ButtonIcon("css/pic/weibo.png","#262626","50% 50%","");y.setPosition("absolute"),y.setLeft("45%"),y.setTop("15%"),y.setWidth("32px"),y.setHeight("32px"),f.add(y);var T=new UI.ButtonIcon("css/pic/wechat.png","#262626","50% 50%","");return T.setPosition("absolute"),T.setLeft("70%"),T.setTop("15%"),T.setWidth("32px"),T.setHeight("32px"),f.add(T),t};var progressBarTipText=null,progress=null,ProgressPanel=function(e){e.signals;var t=new UI.Panel;t.setId("progressPanel"),t.setPosition("absolute"),t.setWidth("300px"),t.setHeight("75px"),t.setLeft("40%"),t.setTop("35%"),t.setBackgroundColor("#262626"),t.setBorder("2px solid  #303030"),(progressBarTipText=new UI.Text("Import")).setId("progressTipText"),progressBarTipText.setPosition("absolute"),progressBarTipText.setLeft("30px"),progressBarTipText.setTop("5px"),t.add(progressBarTipText);var o=new UI.ButtonIcon("css/pic/toolBar/logoMini.png","#262626","50% 50%","");return o.setClass("progressIcon"),o.setPosition("absolute"),o.setWidth("40px"),o.setHeight("40px"),o.setLeft("45%"),o.setTop("-35px"),t.add(o),(progress=new UI.Progress(30,100)).setId("progressBar"),progress.setPosition("absolute"),progress.setWidth("80%"),progress.setHeight("15px"),progress.setLeft("30px"),progress.setTop("40%"),t.add(progress),t};ProgressPanel.setProgress=function(e,t){null!=progressBarTipText&&null!=progress&&(progressBarTipText.setValue(e),progress.setValue(t))};var AddComponentMenubar=function(e){var t=e.signals,o=new UI.Panel;o.setPosition("absolute"),o.setClass("menu"),o.setId("AddComponentMenubar"),o.setDisplay("none");var i,a=new UI.Panel;return a.setClass("options"),o.add(a),(i=new UI.Row).setClass("option"),i.setTextContent("Audio"),i.setBackgroundPosition("90% 50%"),i.setBackgroundRepeat("no-repeat"),i.onMouseDown(function(){}),a.add(i),a.add(new UI.HorizontalRule),(i=new UI.Row).setClass("option"),i.setTextContent("Constraint"),i.setBackgroundPosition("90% 50%"),i.setBackgroundRepeat("no-repeat"),i.onMouseDown(function(){$("#JointComponent").length<1&&t.constraintComponentChange.dispatch(e.selected,ConstraintStateEnum.Add)}),a.add(i),a.add(new UI.HorizontalRule),(i=new UI.Row).setClass("option"),i.setTextContent("Collision"),i.onMouseDown(function(){$("#ColliderComponent").length<1&&t.colliderComponentChange.dispatch(e.selected,ColliderStateEnum.Add)}),a.add(i),a.add(new UI.HorizontalRule),(i=new UI.Row).setClass("option"),i.setTextContent("RigidBody"),i.onMouseDown(function(){}),a.add(i),a.add(new UI.HorizontalRule),(i=new UI.Row).setClass("option"),i.setTextContent("MoviePlayer"),i.onMouseDown(function(){}),a.add(i),a.add(new UI.HorizontalRule),(i=new UI.Row).setClass("option"),i.setTextContent("ParticalSystem"),i.onMouseDown(function(){}),a.add(i),a.add(new UI.HorizontalRule),(i=new UI.Row).setClass("option"),i.setTextContent("Script"),i.onMouseDown(function(){}),a.add(i),a.add(new UI.HorizontalRule),(i=new UI.Row).setClass("option"),i.setTextContent("Animation"),i.onMouseDown(function(){}),a.add(i),$(document).on("mousedown",function(e){var t=$("#AddComponentMenubar").css("display");".AddComponentBtn"!=e.target.class&&"AddComponentMenubar"!=e.target.id&&"none"!=t&&$("#AddComponentMenubar").css("display","none")}),o};function OBB(e,t,o){Object.defineProperties(this,{position:{value:e||new TONG.Vector3,configurable:!1,enumerable:!0,writable:!0},halfSizes:{value:t||new TONG.Vector3,configurable:!1,enumerable:!0,writable:!0},basis:{value:o||new TONG.Matrix4,configurable:!1,enumerable:!0,writable:!0},_EPSILON:{value:.001,configurable:!1,enumerable:!1,writable:!1}})}OBB.prototype.setFromObject=function(){var a=new TONG.Vector3;return function(e){var t,o,i;return null===e.geometry.boundingBox&&e.geometry.computeBoundingBox(),e.updateMatrixWorld(),o=e.geometry.boundingBox,i=e.matrixWorld.elements,o.getCenter(this.position).applyMatrix4(e.matrixWorld),this.basis.extractRotation(e.matrixWorld),o.getSize(this.halfSizes).multiplyScalar(.5),t=a.set(i[0],i[1],i[2]).length(),this.halfSizes.multiplyScalar(t),this}}(),OBB.prototype.setFromAABB=function(e){return e.getCenter(this.position),e.getSize(this.halfSizes).multiplyScalar(.5),this.basis.identity(),this},OBB.prototype.setFromSphere=function(e){return this.position.copy(e.center),this.halfSizes.set(e.radius,e.radius,e.radius),this.basis.identity(),this},OBB.prototype.closestPoint=function(){var n=new TONG.Vector3,r=new TONG.Vector3,s=new TONG.Vector3,l=new TONG.Vector3;return function(e){var t,o,i=[],a=new TONG.Vector3;for(this.basis.extractBasis(r,s,l),i.push(r,s,l),n.subVectors(e,this.position),a.copy(this.position),t=0;t<3;t++)o=TONG.Math.clamp(n.dot(i[t]),-this.halfSizes.getComponent(t),this.halfSizes.getComponent(t)),a.add(i[t].multiplyScalar(o));return a}}(),OBB.prototype.isPointContained=function(){var t=new TONG.Vector3,o=new TONG.Vector3,i=new TONG.Vector3,a=new TONG.Vector3;return function(e){return t.subVectors(e,this.position),this.basis.extractBasis(o,i,a),Math.abs(t.dot(o))<=this.halfSizes.x&&Math.abs(t.dot(i))<=this.halfSizes.y&&Math.abs(t.dot(a))<=this.halfSizes.z}}(),OBB.prototype.isAABBContained=function(){var o=[new TONG.Vector3,new TONG.Vector3,new TONG.Vector3,new TONG.Vector3,new TONG.Vector3,new TONG.Vector3,new TONG.Vector3,new TONG.Vector3];return function(e){o[0].set(e.min.x,e.min.y,e.min.z),o[1].set(e.min.x,e.min.y,e.max.z),o[2].set(e.min.x,e.max.y,e.min.z),o[3].set(e.min.x,e.max.y,e.max.z),o[4].set(e.max.x,e.min.y,e.min.z),o[5].set(e.max.x,e.min.y,e.max.z),o[6].set(e.max.x,e.max.y,e.min.z),o[7].set(e.max.x,e.max.y,e.max.z);for(var t=0;t<8;++t)if(!1===this.isPointContained(o[t]))return!1;return!0}}(),OBB.prototype.isLineContained=function(e){return this.isPointContained(e.start)&&this.isPointContained(e.end)},OBB.prototype.isTriangleContained=function(e){return this.isPointContained(e.a)&&this.isPointContained(e.b)&&this.isPointContained(e.c)},OBB.prototype.intersectsAABB=function(e){return this.intersectsOBB((new OBB).setFromAABB(e))},OBB.prototype.intersectsSphere=function(e){return null!==this.intersectSphere(e)},OBB.prototype.intersectsOBB=function(){var u=new TONG.Vector3,d=new TONG.Vector3,h=new TONG.Vector3,p=new TONG.Vector3,m=new TONG.Vector3,g=new TONG.Vector3,f=new TONG.Vector3,v=new TONG.Vector3;return function(e){var t,o,i,a,n=[],r=[],s=[[],[],[]],l=[[],[],[]];for(this.basis.extractBasis(u,d,h),e.basis.extractBasis(p,m,g),n.push(u,d,h),r.push(p,m,g),v.subVectors(e.position,this.position),a=0;a<3;a++)f.setComponent(a,v.dot(n[a]));for(a=0;a<3;a++)for(var c=0;c<3;c++)s[a][c]=n[a].dot(r[c]),l[a][c]=Math.abs(s[a][c])+this._EPSILON;for(a=0;a<3;a++)if(v.set(l[a][0],l[a][1],l[a][2]),t=this.halfSizes.getComponent(a),o=e.halfSizes.dot(v),Math.abs(f.getComponent(a))>t+o)return!1;for(a=0;a<3;a++)if(v.set(l[0][a],l[1][a],l[2][a]),t=this.halfSizes.dot(v),o=e.halfSizes.getComponent(a),v.set(s[0][a],s[1][a],s[2][a]),i=f.dot(v),Math.abs(i)>t+o)return!1;return t=this.halfSizes.y*l[2][0]+this.halfSizes.z*l[1][0],o=e.halfSizes.y*l[0][2]+e.halfSizes.z*l[0][1],i=f.z*s[1][0]-f.y*s[2][0],!(Math.abs(i)>t+o)&&(t=this.halfSizes.y*l[2][1]+this.halfSizes.z*l[1][1],o=e.halfSizes.x*l[0][2]+e.halfSizes.z*l[0][0],i=f.z*s[1][1]-f.y*s[2][1],!(Math.abs(i)>t+o)&&(t=this.halfSizes.y*l[2][2]+this.halfSizes.z*l[1][2],o=e.halfSizes.x*l[0][1]+e.halfSizes.y*l[0][0],i=f.z*s[1][2]-f.y*s[2][2],!(Math.abs(i)>t+o)&&(t=this.halfSizes.x*l[2][0]+this.halfSizes.z*l[0][0],o=e.halfSizes.y*l[1][2]+e.halfSizes.z*l[1][1],i=f.x*s[2][0]-f.z*s[0][0],!(Math.abs(i)>t+o)&&(t=this.halfSizes.x*l[2][1]+this.halfSizes.z*l[0][1],o=e.halfSizes.x*l[1][2]+e.halfSizes.z*l[1][0],i=f.x*s[2][1]-f.z*s[0][1],!(Math.abs(i)>t+o)&&(t=this.halfSizes.x*l[2][2]+this.halfSizes.z*l[0][2],o=e.halfSizes.x*l[1][1]+e.halfSizes.y*l[1][0],i=f.x*s[2][2]-f.z*s[0][2],!(Math.abs(i)>t+o)&&(t=this.halfSizes.x*l[1][0]+this.halfSizes.y*l[0][0],o=e.halfSizes.y*l[2][2]+e.halfSizes.z*l[2][1],i=f.y*s[0][0]-f.x*s[1][0],!(Math.abs(i)>t+o)&&(t=this.halfSizes.x*l[1][1]+this.halfSizes.y*l[0][1],o=e.halfSizes.x*l[2][2]+e.halfSizes.z*l[2][0],i=f.y*s[0][1]-f.x*s[1][1],!(Math.abs(i)>t+o)&&(t=this.halfSizes.x*l[1][2]+this.halfSizes.y*l[0][2],o=e.halfSizes.x*l[2][1]+e.halfSizes.y*l[2][0],i=f.y*s[0][2]-f.x*s[1][2],!(Math.abs(i)>t+o)))))))))}}(),OBB.prototype.intersectsPlane=function(){var i=new TONG.Vector3,a=new TONG.Vector3,n=new TONG.Vector3;return function(e){var t,o;return this.basis.extractBasis(i,a,n),t=this.halfSizes.x*Math.abs(e.normal.dot(i))+this.halfSizes.y*Math.abs(e.normal.dot(a))+this.halfSizes.z*Math.abs(e.normal.dot(n)),o=e.normal.dot(this.position)-e.constant,Math.abs(o)<=t}}(),OBB.prototype.intersectsRay=function(e){return null!==this.intersectRay(e)},OBB.prototype.intersectRay=function(){var o=new TONG.Vector3,i=new TONG.Vector3,a=new TONG.Box3,n=new TONG.Ray,r=new TONG.Matrix4,s=new TONG.Matrix4;return function(e){var t;return this.size(i),a.setFromCenterAndSize(o,i),r.copy(this.basis),r.setPosition(this.position),n.copy(e),n.applyMatrix4(s.getInverse(r)),null!==(t=n.intersectBox(a))&&t.applyMatrix4(r),t}}(),OBB.prototype.intersectSphere=function(e){var t=this.closestPoint(e.center);return t.distanceToSquared(e.center)<=e.radius*e.radius?t:null},OBB.prototype.size=function(e){return(e||new TONG.Vector3).copy(this.halfSizes).multiplyScalar(2)},OBB.prototype.translate=function(e){return this.position.add(e),this},OBB.prototype.copy=function(e){return this.position.copy(e.position),this.halfSizes.copy(e.halfSizes),this.basis.copy(e.basis),this},OBB.prototype.clone=function(){return(new OBB).copy(this)};var TongUtils=TongUtils||{};TongUtils.Geometry=TongUtils.Geometry||{},TongUtils.Geometry.scale=function(e,t){for(var o=0;o<e.vertices.length;o++){e.vertices[o].position.multiplySelf(t)}return e.__dirtyVertices=!0,this},TongUtils.Geometry.translate=function(e,t){for(var o=0;o<e.vertices.length;o++){e.vertices[o].position.addSelf(t)}return e.__dirtyVertices=!0,this},TongUtils.Geometry.middlePoint=function(e){e.computeBoundingBox();var t=new TONG.Vector3;return t.x=(e.boundingBox.x[1]+e.boundingBox.x[0])/2,t.y=(e.boundingBox.y[1]+e.boundingBox.y[0])/2,t.z=(e.boundingBox.z[1]+e.boundingBox.z[0])/2,t},TongUtils.Geometry.center=function(e,t,o,i){var a=this.middlePoint(e).negate();return t&&(a.x=0),o&&(a.y=0),i&&(a.z=0),this.translate(e,a)},TongUtils.Geometry.attachRightLeft=function(e,t,o){void 0===o&&(o=0),e.computeBoundingBox(),t.computeBoundingBox();var i=e.boundingBox.x[1],a=t.boundingBox.x[0],n=new TONG.Vector3;return n.x=i+-a+o,this.translate(t,n),this};var Constraint=function(){TONG.Component.call(this),this.RequireComponent(Rigidbody),this.title=GetLanguage("Constraint"),this.icon="css/pic/inspector/joint.png";var t=this;this.type=new TONG.Enum(["LockConstraint","PointConstraint","DistanceConstraint","HingeConstraint","ConeTwistConstraint"],{alias:GetLanguage("type"),callback:function(e){if(!isPlay){switch(e){case"LockConstraint":t.pivotA=null,t.pivotB=null,t.axisA=null,t.axisB=null,t.distance=null,t.angle=null;break;case"PointConstraint":t.axisA=null,t.axisB=null,t.pivotA=new TONG.Value({value:(new TONG.Vector3).copy(t.root.position),alias:GetLanguage("pivotA")}),t.pivotB=new TONG.Value({value:(new TONG.Vector3).copy(t.connectBody.root?t.connectBody.root.position:new TONG.Vector3),alias:GetLanguage("pivotB")}),t.distance=null,t.angle=null;break;case"DistanceConstraint":t.pivotA=null,t.pivotB=null,t.axisA=null,t.axisB=null,t.distance=new TONG.Value({value:1,alias:GetLanguage("distance")}),t.angle=null;break;case"HingeConstraint":t.distance=null,t.pivotA=new TONG.Value({value:(new TONG.Vector3).copy(t.root.position),alias:GetLanguage("pivotA")}),t.pivotB=new TONG.Value({value:(new TONG.Vector3).copy(t.connectBody.root?t.connectBody.root.position:new TONG.Vector3),alias:GetLanguage("pivotB")}),t.axisA=new TONG.Value({value:new TONG.Vector3(1,0,0),alias:GetLanguage("axisA")}),t.axisB=new TONG.Value({value:new TONG.Vector3(1,0,0),alias:GetLanguage("axisB")}),t.angle=null;break;case"ConeTwistConstraint":t.pivotA=new TONG.Value({value:(new TONG.Vector3).copy(t.root.position),alias:GetLanguage("pivotA")}),t.pivotB=new TONG.Value({value:(new TONG.Vector3).copy(t.connectBody.root?t.connectBody.root.position:new TONG.Vector3),alias:GetLanguage("pivotB")}),t.axisA=new TONG.Value({value:new TONG.Vector3(1,0,0),alias:GetLanguage("axisA")}),t.axisB=new TONG.Value({value:new TONG.Vector3(1,0,0),alias:GetLanguage("axisB")}),t.angle=new TONG.Value({value:0,alias:GetLanguage("angle")})}t.refreshInspector()}}}),this.connectBody=new TONG.Value({value:new Rigidbody,alias:GetLanguage("connectBody"),callback:function(e){t.pivotB&&(t.pivotB.setValue(e.root.position,!0),t.refreshInspector())}}),this.maxForce=new TONG.Value({value:10,alias:GetLanguage("maxForce")}),this.distance=new TONG.Value({value:1,alias:GetLanguage("distance")}),this.pivotA=new TONG.Value({value:new TONG.Vector3,alias:GetLanguage("pivotA")}),this.pivotB=new TONG.Value({value:new TONG.Vector3,alias:GetLanguage("pivotB")}),this.axisA=new TONG.Value({value:new TONG.Vector3(1,0,0),alias:GetLanguage("axisA")}),this.axisB=new TONG.Value({value:new TONG.Vector3(1,0,0),alias:GetLanguage("axisB")}),this.angle=new TONG.Value({value:0,alias:GetLanguage("angle")}),this.OnInspectorAwake=function(){switch(this.type.getValue()){case"LockConstraint":this.pivotA=null,this.pivotB=null,this.axisA=null,this.axisB=null,this.distance=null,this.angle=null;break;case"PointConstraint":this.axisA=null,this.axisB=null,this.pivotA=new TONG.Value({value:(new TONG.Vector3).copy(t.root.position),alias:GetLanguage("pivotA")}),this.pivotB=new TONG.Value({value:(new TONG.Vector3).copy(t.connectBody.root?t.connectBody.root.position:new TONG.Vector3),alias:GetLanguage("pivotB")}),this.distance=null,this.angle=null;break;case"DistanceConstraint":this.pivotA=null,this.pivotB=null,this.axisA=null,this.axisB=null,this.distance=new TONG.Value({value:1,alias:GetLanguage("distance")}),this.angle=null;break;case"HingeConstraint":this.distance=null,this.pivotA=new TONG.Value({value:(new TONG.Vector3).copy(t.root.position),alias:GetLanguage("pivotA")}),this.pivotB=new TONG.Value({value:(new TONG.Vector3).copy(t.connectBody.root?t.connectBody.root.position:new TONG.Vector3),alias:GetLanguage("pivotB")}),this.axisA=new TONG.Value({value:new TONG.Vector3(1,0,0),alias:GetLanguage("axisA")}),this.axisB=new TONG.Value({value:new TONG.Vector3(1,0,0),alias:GetLanguage("axisB")}),this.angle=null;break;case"ConeTwistConstraint":this.pivotA=new TONG.Value({value:(new TONG.Vector3).copy(t.root.position),alias:GetLanguage("pivotA")}),this.pivotB=new TONG.Value({value:(new TONG.Vector3).copy(t.connectBody.root?t.connectBody.root.position:new TONG.Vector3),alias:GetLanguage("pivotB")}),this.axisA=new TONG.Value({value:new TONG.Vector3(1,0,0),alias:GetLanguage("axisA")}),this.axisB=new TONG.Value({value:new TONG.Vector3(1,0,0),alias:GetLanguage("axisB")}),this.angle=new TONG.Value({value:0,alias:GetLanguage("angle")})}};var e=null;this.Start=function(){if(this.connectBody.getValue()&&this.connectBody.getValue().uuid&&""!=this.connectBody.getValue().uuid&&this.connectBody.getValue().uuid!=this.root.getComponents("Rigidbody").uuid){switch(this.type.getValue()){case"LockConstraint":e=new CANNON.LockConstraint(this.root.body,this.connectBody.value.root.body,{maxForce:this.maxForce.getValue()});break;case"PointConstraint":e=new CANNON.PointToPointConstraint(this.root.body,this.pivotA.getValue(),this.connectBody.value.root.body,this.pivotB.getValue(),this.maxForce.getValue());break;case"DistanceConstraint":e=new CANNON.DistanceConstraint(this.root.body,this.connectBody.value.root.body,this.distance.value,this.maxForce.value);break;case"HingeConstraint":e=new CANNON.HingeConstraint(this.root.body,this.connectBody.value.root.body,{maxForce:this.maxForce.getValue(),pivotA:this.pivotA.getValue(),pivotB:this.pivotB.getValue(),axisA:(new CANNON.Vec3).copy(this.axisA.value),axisB:(new CANNON.Vec3).copy(this.axisB.value)});break;case"ConeTwistConstraint":e=new CANNON.ConeTwistConstraint(this.root.body,this.connectBody.value.root.body,{maxForce:this.maxForce.getValue(),pivotA:this.pivotA.getValue(),pivotB:this.pivotB.getValue(),axisA:(new CANNON.Vec3).copy(this.axisA.value),axisB:(new CANNON.Vec3).copy(this.axisB.value),angle:this.angle.value})}e&&this.scene.world.addConstraint(e)}}};Constraint.prototype=Object.create(TONG.Component.prototype),Constraint.prototype.constructor=Constraint,TONG.Components.registerComponent(Constraint),TONG.CSS2DObject=function(e){TONG.Object3D.call(this),this.element=e,this.element.style.position="absolute",this.addEventListener("removed",function(e){null!==this.element.parentNode&&this.element.parentNode.removeChild(this.element)})},TONG.CSS2DObject.prototype=Object.create(TONG.Object3D.prototype),TONG.CSS2DObject.prototype.constructor=TONG.CSS2DObject,TONG.CSS2DRenderer=function(){var r,s,l=new TONG.Vector3,o=new TONG.Matrix4,c=new TONG.Matrix4,u=document.createElement("div");u.style.overflow="hidden",this.domElement=u,this.setSize=function(e,t){r=e/2,s=t/2,u.style.width=e+"px",u.style.height=t+"px"};var d=function(e,t){if(e instanceof TONG.CSS2DObject){l.setFromMatrixPosition(e.matrixWorld),l.applyMatrix4(c);var o=e.element,i="translate(-50%,-50%) translate("+(l.x*r+r)+"px,"+(-l.y*s+s)+"px)";o.style.WebkitTransform=i,o.style.MozTransform=i,o.style.oTransform=i,o.style.transform=i,o.parentNode!==u&&u.appendChild(o)}for(var a=0,n=e.children.length;a<n;a++)d(e.children[a],t)};this.render=function(e,t){e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),t.matrixWorldInverse.getInverse(t.matrixWorld),o.copy(t.matrixWorldInverse.getInverse(t.matrixWorld)),c.multiplyMatrices(t.projectionMatrix,o),d(e,t)}},TONG.CSS3DObject=function(e){TONG.Object3D.call(this),this.element=e,this.element.style.position="absolute",this.addEventListener("removed",function(){for(var e=0;e<this.children.length;e++)this.children[e]instanceof TONG.CSS3DObject&&null!==this.children[e].element.parentNode&&this.children[e].element.parentNode.removeChild(this.children[e].element);null!==this.element.parentNode&&this.element.parentNode.removeChild(this.element)})},TONG.CSS3DObject.prototype=Object.create(TONG.Object3D.prototype),TONG.CSS3DObject.prototype.constructor=TONG.CSS3DObject,TONG.CSS3DSprite=function(e){TONG.CSS3DObject.call(this,e)},TONG.CSS3DSprite.prototype=Object.create(TONG.CSS3DObject.prototype),TONG.CSS3DSprite.prototype.constructor=TONG.CSS3DSprite,TONG.CSS3DRenderer=function(){var o,u,d,h,p=new TONG.Matrix4,m={camera:{fov:0,style:""},objects:{}},g=document.createElement("div");g.style.overflow="hidden",this.domElement=g;var f=document.createElement("div");f.style.WebkitTransformStyle="preserve-3d",f.style.MozTransformStyle="preserve-3d",f.style.transformStyle="preserve-3d",g.appendChild(f);var v=/Trident/i.test(navigator.userAgent);function y(e){return Math.abs(e)<1e-10?0:e}function T(e,t){var o=e.elements,i="matrix3d("+y(o[0])+","+y(o[1])+","+y(o[2])+","+y(o[3])+","+y(-o[4])+","+y(-o[5])+","+y(-o[6])+","+y(-o[7])+","+y(o[8])+","+y(o[9])+","+y(o[10])+","+y(o[11])+","+y(o[12])+","+y(o[13])+","+y(o[14])+","+y(o[15])+")";return v?"translate(-50%,-50%)translate("+d+"px,"+h+"px)"+t+i:"translate(-50%,-50%)"+i}this.setClearColor=function(){},this.getSize=function(){return{width:o,height:u}},this.setSize=function(e,t){d=(o=e)/2,h=(u=t)/2,g.style.width=e+"px",g.style.height=t+"px",f.style.width=e+"px",f.style.height=t+"px"};var i,a,O=(i=new TONG.Vector3,a=new TONG.Vector3,function(e,t){return i.setFromMatrixPosition(e.matrixWorld),a.setFromMatrixPosition(t.matrixWorld),i.distanceToSquared(a)});this.render=function(e,t){var o=.5/Math.tan(TONG.Math.degToRad(.5*t.getEffectiveFOV()))*u;m.camera.fov!==o&&(g.style.WebkitPerspective=o+"px",g.style.MozPerspective=o+"px",g.style.perspective=o+"px",m.camera.fov=o),e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),t.matrixWorldInverse.getInverse(t.matrixWorld);var i,a,n,r,s,l="translateZ("+o+"px)"+(i=t.matrixWorldInverse,"matrix3d("+y((a=i.elements)[0])+","+y(-a[1])+","+y(a[2])+","+y(a[3])+","+y(a[4])+","+y(-a[5])+","+y(a[6])+","+y(a[7])+","+y(a[8])+","+y(-a[9])+","+y(a[10])+","+y(a[11])+","+y(a[12])+","+y(-a[13])+","+y(a[14])+","+y(a[15])+")"),c=l+"translate("+d+"px,"+h+"px)";m.camera.style===c||v||(f.style.WebkitTransform=c,f.style.MozTransform=c,f.style.transform=c,m.camera.style=c),function e(t,o,i){if(t instanceof TONG.CSS3DObject){var a;t instanceof TONG.CSS3DSprite?(p.copy(o.matrixWorldInverse),p.transpose(),p.copyPosition(t.matrixWorld),p.scale(t.scale),p.elements[3]=0,p.elements[7]=0,p.elements[11]=0,p.elements[15]=1,a=T(p,i)):a=T(t.matrixWorld,i);var n=t.element,r=m.objects[t.id]&&m.objects[t.id].style;void 0!==r&&r===a||(n.style.WebkitTransform=a,n.style.MozTransform=a,n.style.transform=a,m.objects[t.id]={style:a},v&&(m.objects[t.id].distanceToCameraSquared=O(o,t))),n.parentNode!==f&&f.appendChild(n)}for(var s=0,l=t.children.length;s<l;s++)e(t.children[s],o,i)}(e,t,l),v&&(n=e,r=Object.keys(m.objects).sort(function(e,t){return m.objects[e].distanceToCameraSquared-m.objects[t].distanceToCameraSquared}),s=r.length,n.traverse(function(e){var t=r.indexOf(e.id+"");-1!==t&&(e.element.style.zIndex=s-t)}))}},TONG.OrbitControls=function(e,t){var o,i,a,n,r;this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.target=new TONG.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.25,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={ORBIT:TONG.MOUSE.LEFT,ZOOM:TONG.MOUSE.MIDDLE,PAN:TONG.MOUSE.RIGHT},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=function(){return m.phi},this.getAzimuthalAngle=function(){return m.theta},this.saveState=function(){s.target0.copy(s.target),s.position0.copy(s.object.position),s.zoom0=s.object.zoom},this.reset=function(){s.target.copy(s.target0),s.object.position.copy(s.position0),s.object.zoom=s.zoom0,s.object.updateProjectionMatrix(),s.dispatchEvent(l),s.update(),h=d.NONE},this.update=(o=new TONG.Vector3,i=(new TONG.Quaternion).setFromUnitVectors(e.up,new TONG.Vector3(0,1,0)),a=i.clone().inverse(),n=new TONG.Vector3,r=new TONG.Quaternion,function(){var e=s.object.position;return o.copy(e).sub(s.target),o.applyQuaternion(i),m.setFromVector3(o),s.autoRotate&&h===d.NONE&&S(2*Math.PI/60/60*s.autoRotateSpeed),m.theta+=g.theta,m.phi+=g.phi,m.theta=Math.max(s.minAzimuthAngle,Math.min(s.maxAzimuthAngle,m.theta)),m.phi=Math.max(s.minPolarAngle,Math.min(s.maxPolarAngle,m.phi)),m.makeSafe(),m.radius*=f,m.radius=Math.max(s.minDistance,Math.min(s.maxDistance,m.radius)),s.target.add(v),o.setFromSpherical(m),o.applyQuaternion(a),e.copy(s.target).add(o),s.object.lookAt(s.target),!0===s.enableDamping?(g.theta*=1-s.dampingFactor,g.phi*=1-s.dampingFactor):g.set(0,0,0),f=1,v.set(0,0,0),!(!(y||n.distanceToSquared(s.object.position)>p||8*(1-r.dot(s.object.quaternion))>p)||(s.dispatchEvent(l),n.copy(s.object.position),r.copy(s.object.quaternion),y=!1))}),this.dispose=function(){s.domElement.removeEventListener("contextmenu",J,!1),s.domElement.removeEventListener("mousedown",j,!1),s.domElement.removeEventListener("wheel",z,!1),s.domElement.removeEventListener("touchstart",W,!1),s.domElement.removeEventListener("touchend",Y,!1),s.domElement.removeEventListener("touchmove",H,!1),document.removeEventListener("mousemove",D,!1),document.removeEventListener("mouseup",B,!1),window.removeEventListener("keydown",F,!1)};var s=this,l={type:"change"},c={type:"start"},u={type:"end"},d={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},h=d.NONE,p=1e-6,m=new TONG.Spherical,g=new TONG.Spherical,f=1,v=new TONG.Vector3,y=!1,T=new TONG.Vector2,O=new TONG.Vector2,N=new TONG.Vector2,G=new TONG.Vector2,b=new TONG.Vector2,w=new TONG.Vector2,x=new TONG.Vector2,C=new TONG.Vector2,_=new TONG.Vector2;function k(){return Math.pow(.95,s.zoomSpeed)}function S(e){g.theta-=e}function M(e){g.phi-=e}var I,E,V,R=(I=new TONG.Vector3,function(e,t){I.setFromMatrixColumn(t,0),I.multiplyScalar(-e),v.add(I)}),A=(E=new TONG.Vector3,function(e,t){E.setFromMatrixColumn(t,1),E.multiplyScalar(e),v.add(E)}),U=(V=new TONG.Vector3,function(e,t){var o=s.domElement===document?s.domElement.body:s.domElement;if(s.object instanceof TONG.PerspectiveCamera){var i=s.object.position;V.copy(i).sub(s.target);var a=V.length();a*=Math.tan(s.object.fov/2*Math.PI/180),R(2*e*a/o.clientHeight,s.object.matrix),A(2*t*a/o.clientHeight,s.object.matrix)}else s.object instanceof TONG.OrthographicCamera?(R(e*(s.object.right-s.object.left)/s.object.zoom/o.clientWidth,s.object.matrix),A(t*(s.object.top-s.object.bottom)/s.object.zoom/o.clientHeight,s.object.matrix)):s.enablePan=!1});function L(e){s.object instanceof TONG.PerspectiveCamera?f/=e:s.object instanceof TONG.OrthographicCamera?(s.object.zoom=Math.max(s.minZoom,Math.min(s.maxZoom,s.object.zoom*e)),s.object.updateProjectionMatrix(),y=!0):s.enableZoom=!1}function P(e){s.object instanceof TONG.PerspectiveCamera?f*=e:s.object instanceof TONG.OrthographicCamera?(s.object.zoom=Math.max(s.minZoom,Math.min(s.maxZoom,s.object.zoom/e)),s.object.updateProjectionMatrix(),y=!0):s.enableZoom=!1}function j(e){if(!1!==s.enabled){switch(e.preventDefault(),e.button){case s.mouseButtons.ORBIT:if(!1===s.enableRotate)return;i=e,T.set(i.clientX,i.clientY),h=d.ROTATE;break;case s.mouseButtons.ZOOM:if(!1===s.enableZoom)return;o=e,x.set(o.clientX,o.clientY),h=d.DOLLY;break;case s.mouseButtons.PAN:if(!1===s.enablePan)return;t=e,G.set(t.clientX,t.clientY),h=d.PAN}var t,o,i;h!==d.NONE&&(document.addEventListener("mousemove",D,!1),document.addEventListener("mouseup",B,!1),s.dispatchEvent(c))}}function D(e){var t,o;if(!1!==s.enabled)switch(e.preventDefault(),h){case d.ROTATE:if(!1===s.enableRotate)return;!function(e){O.set(e.clientX,e.clientY),N.subVectors(O,T);var t=s.domElement===document?s.domElement.body:s.domElement;S(2*Math.PI*N.x/t.clientWidth*s.rotateSpeed),M(2*Math.PI*N.y/t.clientHeight*s.rotateSpeed),T.copy(O),s.update()}(e);break;case d.DOLLY:if(!1===s.enableZoom)return;o=e,C.set(o.clientX,o.clientY),_.subVectors(C,x),0<_.y?L(k()):_.y<0&&P(k()),x.copy(C),s.update();break;case d.PAN:if(!1===s.enablePan)return;t=e,b.set(t.clientX,t.clientY),w.subVectors(b,G),U(w.x,w.y),G.copy(b),s.update()}}function B(e){!1!==s.enabled&&(document.removeEventListener("mousemove",D,!1),document.removeEventListener("mouseup",B,!1),s.dispatchEvent(u),h=d.NONE)}function z(e){var t;!1===s.enabled||!1===s.enableZoom||h!==d.NONE&&h!==d.ROTATE||(e.preventDefault(),e.stopPropagation(),(t=e).deltaY<0?P(k()):0<t.deltaY&&L(k()),s.update(),s.dispatchEvent(c),s.dispatchEvent(u))}function F(e){!1!==s.enabled&&!1!==s.enableKeys&&!1!==s.enablePan&&function(e){switch(e.keyCode){case s.keys.UP:U(0,s.keyPanSpeed),s.update();break;case s.keys.BOTTOM:U(0,-s.keyPanSpeed),s.update();break;case s.keys.LEFT:U(s.keyPanSpeed,0),s.update();break;case s.keys.RIGHT:U(-s.keyPanSpeed,0),s.update()}}(e)}function W(e){if(!1!==s.enabled){switch(e.touches.length){case 1:if(!1===s.enableRotate)return;r=e,T.set(r.touches[0].pageX,r.touches[0].pageY),h=d.TOUCH_ROTATE;break;case 2:if(!1===s.enableZoom)return;i=(o=e).touches[0].pageX-o.touches[1].pageX,a=o.touches[0].pageY-o.touches[1].pageY,n=Math.sqrt(i*i+a*a),x.set(0,n),h=d.TOUCH_DOLLY;break;case 3:if(!1===s.enablePan)return;t=e,G.set(t.touches[0].pageX,t.touches[0].pageY),h=d.TOUCH_PAN;break;default:h=d.NONE}var t,o,i,a,n,r;h!==d.NONE&&s.dispatchEvent(c)}}function H(e){var t,o,i,a,n;if(!1!==s.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:if(!1===s.enableRotate)return;if(h!==d.TOUCH_ROTATE)return;!function(e){O.set(e.touches[0].pageX,e.touches[0].pageY),N.subVectors(O,T);var t=s.domElement===document?s.domElement.body:s.domElement;S(2*Math.PI*N.x/t.clientWidth*s.rotateSpeed),M(2*Math.PI*N.y/t.clientHeight*s.rotateSpeed),T.copy(O),s.update()}(e);break;case 2:if(!1===s.enableZoom)return;if(h!==d.TOUCH_DOLLY)return;i=(o=e).touches[0].pageX-o.touches[1].pageX,a=o.touches[0].pageY-o.touches[1].pageY,n=Math.sqrt(i*i+a*a),C.set(0,n),_.subVectors(C,x),0<_.y?P(k()):_.y<0&&L(k()),x.copy(C),s.update();break;case 3:if(!1===s.enablePan)return;if(h!==d.TOUCH_PAN)return;t=e,b.set(t.touches[0].pageX,t.touches[0].pageY),w.subVectors(b,G),U(w.x,w.y),G.copy(b),s.update();break;default:h=d.NONE}}function Y(e){!1!==s.enabled&&(s.dispatchEvent(u),h=d.NONE)}function J(e){e.preventDefault()}s.domElement.addEventListener("contextmenu",J,!1),s.domElement.addEventListener("mousedown",j,!1),s.domElement.addEventListener("wheel",z,!1),s.domElement.addEventListener("touchstart",W,!1),s.domElement.addEventListener("touchend",Y,!1),s.domElement.addEventListener("touchmove",H,!1),window.addEventListener("keydown",F,!1),this.update()},TONG.OrbitControls.prototype=Object.create(TONG.EventDispatcher.prototype),TONG.OrbitControls.prototype.constructor=TONG.OrbitControls,Object.defineProperties(TONG.OrbitControls.prototype,{center:{get:function(){return this.target}},noZoom:{get:function(){return!this.enableZoom},set:function(e){this.enableZoom=!e}},noRotate:{get:function(){return!this.enableRotate},set:function(e){this.enableRotate=!e}},noPan:{get:function(){return!this.enablePan},set:function(e){this.enablePan=!e}},noKeys:{get:function(){return!this.enableKeys},set:function(e){this.enableKeys=!e}},staticMoving:{get:function(){return!this.enableDamping},set:function(e){this.enableDamping=!e}},dynamicDampingFactor:{get:function(){return this.dampingFactor},set:function(e){this.dampingFactor=e}}});var TONGUI={Icon:{Home:"&#xe68e;",Zan:"&#xe6c6;",StepOn:"&#xe6c5;",Man:"&#xe662;",Woman:"&#xe661;",Camera_hollow:"&#xe660;",Camera_solid:"&#xe65d;",Menu_horizontal:"&#xe65f;",Menu_vertical:"&#xe671;",Back:"&#xe65c;",Hot:"&#xe756;",Level:"&#xe735;",RMB:"&#xe65e;",Dollar:"&#xe659;",Position:"&#xe715;",Document:"&#xe705;",Check:"&#xe6b2;",Smile:"&#xe6af;",Smile2:"&#xe60c;",Smile3:"&#xe650;",Sad:"&#xe69c;",ShoppingCart:"&#xe698;",ShoppingCart_Small:"&#xe657;",TheStar:"&#xe658;",Star_hollow:"&#xe600;",PrePage:"&#xe65a;",NextPage:"&#xe65b;",Upload_hollow:"&#xe681;",Upload_solid:"&#xe67c;",Folders:"&#xe7a0;",Folders2:"&#xe622;",App:"&#xe857;",Play:"&#xe652;",Pause:"&#xe651;",Music:"&#xe6fc;",Video:"&#xe6ed;",Sound:"&#xe688;",Bugle:"&#xe645;",Chat:"&#xe611;",Settings:"&#xe614;",Settings_hollow:"&#xe620;",Sealth:"&#xe60f;",Search:"&#xe615;",Sharing:"&#xe641;",Refresh:"&#x1002;",Loading:"&#xe63d;",Loading_small:"&#xe63e;",Engine:"&#xe628;",Close_line:"&#x1006;",Close_solid:"&#x1007;",Statement:"&#xe629;",Dot:"&#xe617;",Customerservice:"&#xe606;",Release:"&#xe609;",List:"&#xe60a;",Chart:"&#xe62c;",Bingo:"&#x1005;",Bingo_Solid:"&#xe618;",Bingo2:"&#xe605;",Bingo3:"&#xe616;",Cloth:"&#xe61b;",OnLine:"&#xe610;",Arrow_Right:"&#xe602;",Arrow_Left:"&#xe603;",Arrow_Down:"&#xe61a;",Arrow_Up:"&#xe619;",Table:"&#xe62d;",Tree:"&#xe62e;",Add_Circle:"&#xe61f;",Add:"&#xe654;",Download:"&#xe601;",Download_file:"&#xe61e;",SelectTemplate:"&#xe630;",Tools:"&#xe631;",Edit:"&#xe642;",Edit_Text:"&#xe639;",Delete:"&#xe640;",File:"&#xe621;",File2:"&#xe61d;",Layout:"&#xe632;",404:"&#xe61c;",Mosaic:"&#xe634;",Help:"&#xe607;",Program:"&#xe635;",Water:"&#xe636;",About:"&#xe60b;",Date:"&#xe637;",Top:"&#xe604;",Friend_request:"&#xe612;",Window:"&#xe638;",Friends:"&#xe613;",Picture:"&#xe60d;",Picture2:"&#xe64a;",Link:"&#xe64c;",Record:"&#xe60e;",Unlink:"&#xe64d;",Triangle:"&#xe623;",Triangle_down:"&#xe625;",Radio_UnSelect:"&#xe63f;",Radio_Select:"&#xe643;",Align_Center:"&#xe647;",Align_Right:"&#xe648;",Align_Left:"&#xe649;",CheckBox_Uncheck:"&#xe626;",CheckBox_Check:"&#xe627;",Bold:"&#xe62b;",IM_Chat:"&#xe63a;",Mobile:"&#xe63b;",Html:"&#xe64b;",Forum:"&#xe63c;",Tab:"&#xe62a;",Js:"&#xe64e;",Underline:"&#xe646;",Italic:"&#xe644;"},LayColor:{Orange:"layui-bg-orange",Green:"layui-bg-green",Cyan:"layui-bg-cyan",Blue:"layui-bg-blue",Black:"layui-bg-black",Gray:"layui-bg-gray"},Element:function(e){this.dom=e}};TONGUI.Element.prototype={style:function(e){return this.dom.setAttribute("style",e+""),this},add:function(){for(var e=0;e<arguments.length;e++){var t=arguments[e];t instanceof TONGUI.Element&&this.dom.appendChild(t.dom)}return this},remove:function(){for(var e=0;e<arguments.length;e++){var t=arguments[e];t instanceof TONGUI.Element&&this.dom.removeChild(t.dom)}return this},clear:function(){for(;this.dom.children.length;)this.dom.removeChild(this.dom.lastChild)},setId:function(e){return this.dom.id=e,this},setClass:function(e){return this.dom.className=e,this},setStyle:function(e,t){for(var o=0;o<t.length;o++)this.dom.style[e]=t[o];return this},setDisabled:function(e){return this.dom.disabled=e,this},setTextContent:function(e){return this.dom.textContent=e,this},setAttribute:function(e,t){return this.dom.setAttribute(e+"",""+t),this},removeAttribute:function(e){return this.dom.removeAttribute(e),this},getElementsByClass:function(e){for(var t=[],o=0;o<this.dom.children.length;o++){var i=this.dom.children[o];-1!=i.className.indexOf(""+e)&&t.push(i)}return t},getElementsByTag:function(e){for(var t=[],o=0;o<this.dom.children.length;o++){var i=this.dom.children[o];i.tagName.toLowerCase()==(e=e.toLowerCase())&&t.push(i)}return t},setLastOrder:function(){}};var properties=["position","left","top","right","bottom","width","height","border","borderLeft","borderTop","borderRight","borderBottom","borderColor","display","overflow","margin","marginLeft","marginTop","marginRight","marginBottom","padding","paddingLeft","paddingTop","paddingRight","paddingBottom","color","background","backgroundColor","backgroundImage","backgroundPosition","backgroundRepeat","visibility","opacity","fontSize","fontWeight","textAlign","textDecoration","textTransform","cursor","zIndex"];properties.forEach(function(e){var t="set"+e.substr(0,1).toUpperCase()+e.substr(1,e.length);TONGUI.Element.prototype[t]=function(){return this.setStyle(e,arguments),this}});var events=["KeyUp","Blur","KeyDown","MouseOver","MouseDown","MouseOut","Click","DblClick","Input","PropertyChange","Change","Drop","DragStart","Drag","DragEnd","DragEnter","DragOver","DragLeave"];function FindForm(){if(0<document.getElementsByClassName("layui-form").length)return document.getElementsByClassName("layui-form")[0];var e=new TONGUI.Form;return document.body.appendChild(e.dom),e.dom}function TONG3DForm(){return new TONGUI.Form}function MeshLine(){this.positions=[],this.previous=[],this.next=[],this.side=[],this.width=[],this.indices_array=[],this.uvs=[],this.counters=[],this.geometry=new TONG.BufferGeometry,this.widthCallback=null}function memcpy(e,t,o,i,a){var n;if(e=e.subarray||e.slice?e:e.buffer,o=o.subarray||o.slice?o:o.buffer,e=t?e.subarray?e.subarray(t,a&&t+a):e.slice(t,a&&t+a):e,o.set)o.set(e,i);else for(n=0;n<e.length;n++)o[n+i]=e[n];return o}function MeshLineMaterial(e){function t(e,t){return void 0===e?t:e}TONG.Material.call(this),e=e||{},this.lineWidth=t(e.lineWidth,1),this.map=t(e.map,null),this.useMap=t(e.useMap,0),this.alphaMap=t(e.alphaMap,null),this.useAlphaMap=t(e.useAlphaMap,0),this.color=t(e.color,new TONG.Color(16777215)),this.opacity=t(e.opacity,1),this.resolution=t(e.resolution,new TONG.Vector2(1,1)),this.sizeAttenuation=t(e.sizeAttenuation,1),this.near=t(e.near,1),this.far=t(e.far,1),this.dashArray=t(e.dashArray,[]),this.useDash=this.dashArray!==[]?1:0,this.visibility=t(e.visibility,1),this.alphaTest=t(e.alphaTest,0),this.repeat=t(e.repeat,new TONG.Vector2(1,1));var o=new TONG.RawShaderMaterial({uniforms:{lineWidth:{type:"f",value:this.lineWidth},map:{type:"t",value:this.map},useMap:{type:"f",value:this.useMap},alphaMap:{type:"t",value:this.alphaMap},useAlphaMap:{type:"f",value:this.useAlphaMap},color:{type:"c",value:this.color},opacity:{type:"f",value:this.opacity},resolution:{type:"v2",value:this.resolution},sizeAttenuation:{type:"f",value:this.sizeAttenuation},near:{type:"f",value:this.near},far:{type:"f",value:this.far},dashArray:{type:"v2",value:new TONG.Vector2(this.dashArray[0],this.dashArray[1])},useDash:{type:"f",value:this.useDash},visibility:{type:"f",value:this.visibility},alphaTest:{type:"f",value:this.alphaTest},repeat:{type:"v2",value:this.repeat}},vertexShader:["precision highp float;","","attribute vec3 position;","attribute vec3 previous;","attribute vec3 next;","attribute float side;","attribute float width;","attribute vec2 uv;","attribute float counters;","","uniform mat4 projectionMatrix;","uniform mat4 modelViewMatrix;","uniform vec2 resolution;","uniform float lineWidth;","uniform vec3 color;","uniform float opacity;","uniform float near;","uniform float far;","uniform float sizeAttenuation;","","varying vec2 vUV;","varying vec4 vColor;","varying float vCounters;","","vec2 fix( vec4 i, float aspect ) {","","    vec2 res = i.xy / i.w;","    res.x *= aspect;","\t vCounters = counters;","    return res;","","}","","void main() {","","    float aspect = resolution.x / resolution.y;","\t float pixelWidthRatio = 1. / (resolution.x * projectionMatrix[0][0]);","","    vColor = vec4( color, opacity );","    vUV = uv;","","    mat4 m = projectionMatrix * modelViewMatrix;","    vec4 finalPosition = m * vec4( position, 1.0 );","    vec4 prevPos = m * vec4( previous, 1.0 );","    vec4 nextPos = m * vec4( next, 1.0 );","","    vec2 currentP = fix( finalPosition, aspect );","    vec2 prevP = fix( prevPos, aspect );","    vec2 nextP = fix( nextPos, aspect );","","\t float pixelWidth = finalPosition.w * pixelWidthRatio;","    float w = 1.8 * pixelWidth * lineWidth * width;","","    if( sizeAttenuation == 1. ) {","        w = 1.8 * lineWidth * width;","    }","","    vec2 dir;","    if( nextP == currentP ) dir = normalize( currentP - prevP );","    else if( prevP == currentP ) dir = normalize( nextP - currentP );","    else {","        vec2 dir1 = normalize( currentP - prevP );","        vec2 dir2 = normalize( nextP - currentP );","        dir = normalize( dir1 + dir2 );","","        vec2 perp = vec2( -dir1.y, dir1.x );","        vec2 miter = vec2( -dir.y, dir.x );","        //w = clamp( w / dot( miter, perp ), 0., 4. * lineWidth * width );","","    }","","    //vec2 normal = ( cross( vec3( dir, 0. ), vec3( 0., 0., 1. ) ) ).xy;","    vec2 normal = vec2( -dir.y, dir.x );","    normal.x /= aspect;","    normal *= .5 * w;","","    vec4 offset = vec4( normal * side, 0.0, 1.0 );","    finalPosition.xy += offset.xy;","","    gl_Position = finalPosition;","","}"].join("\r\n"),fragmentShader:["#extension GL_OES_standard_derivatives : enable","precision mediump float;","","uniform sampler2D map;","uniform sampler2D alphaMap;","uniform float useMap;","uniform float useAlphaMap;","uniform float useDash;","uniform vec2 dashArray;","uniform float visibility;","uniform float alphaTest;","uniform vec2 repeat;","","varying vec2 vUV;","varying vec4 vColor;","varying float vCounters;","","void main() {","","    vec4 c = vColor;","    if( useMap == 1. ) c *= texture2D( map, vUV * repeat );","    if( useAlphaMap == 1. ) c.a *= texture2D( alphaMap, vUV * repeat ).a;","\t if( c.a < alphaTest ) discard;","\t if( useDash == 1. ){","\t \t ","\t }","    gl_FragColor = c;","\t gl_FragColor.a *= step(vCounters,visibility);","}"].join("\r\n")});return delete e.lineWidth,delete e.map,delete e.useMap,delete e.alphaMap,delete e.useAlphaMap,delete e.color,delete e.opacity,delete e.resolution,delete e.sizeAttenuation,delete e.near,delete e.far,delete e.dashArray,delete e.visibility,delete e.alphaTest,delete e.repeat,o.type="MeshLineMaterial",o.setValues(e),o}events.forEach(function(t){var e="on"+t;TONGUI.Element.prototype[e]=function(e){return this.dom.addEventListener(t.toLowerCase(),e.bind(this),!1),this}}),TONGUI.Span=function(){return TONGUI.Element.call(this),this.dom=document.createElement("span"),this},TONGUI.Span.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Span.prototype.constructor=TONGUI.Span,TONGUI.Span.prototype.setValue=function(e){return this.dom.innerHTML=e,this},TONGUI.Div=function(){TONGUI.Element.call(this),this.dom=document.createElement("div");for(var e=0;e<arguments.length;e++)this.dom.innerHTML+=arguments[e];return this},TONGUI.Div.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Div.prototype.constructor=TONGUI.Div,TONGUI.Ul=function(e){TONGUI.Element.call(this);var t=document.createElement("ul");return t.className="Ul",this.dom=t,null!=e&&(this.dom.textContent=e),this},TONGUI.Ul.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Ul.prototype.constructor=TONGUI.Ul,TONGUI.Li=function(e){TONGUI.Element.call(this);var t=document.createElement("li");return t.className="Li",this.dom=t,null!=e&&(this.dom.textContent=e),this},TONGUI.Li.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Li.prototype.constructor=TONGUI.Li,TONGUI.Menu=function(e){TONGUI.Element.call(this);var t=document.createElement("li"),o=document.createElement("a");o.href="#";var i=document.createElement("span");return o.appendChild(i),o.textContent=e,t.appendChild(o),this.dom=t,this},TONGUI.Menu.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Menu.prototype.constructor=TONGUI.Menu,TONGUI.Row=function(){TONGUI.Element.call(this);var e=document.createElement("div");return e.className="Row",this.dom=e,this},TONGUI.Row.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Row.prototype.constructor=TONGUI.Row,TONGUI.Panel=function(){TONGUI.Element.call(this);var e=document.createElement("div");return e.className="Panel",this.dom=e,this},TONGUI.Panel.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Panel.prototype.constructor=TONGUI.Panel,TONGUI.Form=function(e){TONGUI.Element.call(this);var t=document.createElement("form");return t.className="Form",t.method="get"==e||"post"==e?e:"post",this.dom=t,this},TONGUI.Form.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Form.prototype.constructor=TONGUI.Form,TONGUI.Text=function(e){TONGUI.Element.call(this);var t=document.createElement("span");return t.className="Text",t.style.cursor="default",t.style.display="inline-block",t.style.verticalAlign="middle",this.dom=t,this.setValue(e),this},TONGUI.Text.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Text.prototype.constructor=TONGUI.Text,TONGUI.Text.prototype.getValue=function(){return this.dom.textContent},TONGUI.Text.prototype.setValue=function(e){return void 0!==e&&(this.dom.textContent=e),this},TONGUI.Progress=function(e,t,o){TONGUI.Element.call(this);var i=new TONGUI.Div;i.setClass("layui-progress"),i.setAttribute("lay-filter","tongEngine"),t&&(i.dom.className+=" layui-progress-big");var a=new TONGUI.Div;return a.setClass("layui-progress-bar"),a.dom.className+=" "+o,e=e||50,a.setAttribute("lay-percent",e+"%"),i.add(a),this.dom=i.dom,this.renderEle=null,this.use(),this},TONGUI.Progress.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Progress.prototype.constructor=TONGUI.Progress,TONGUI.Progress.prototype.setShowLabel=function(e){return e?this.setAttribute("lay-showPercent","yes"):this.removeAttribute("lay-showPercent"),this},TONGUI.Progress.prototype.setIsBig=function(e){if(e)this.dom.className+=" layui-progress-big";else{var t=this.dom.className;this.dom.className=t.replace("layui-progress-big","")}return this},TONGUI.Progress.prototype.setPercent=function(e){return this.renderEle.progress("tongEngine",e+"%"),this},TONGUI.Progress.prototype.setLayColor=function(e){return this.dom.firstChild.dom.className+=" "+e,this},TONGUI.Progress.prototype.use=function(){var o=this;layui.use("element",function(e){var t=layui.element;o.renderEle=t})},TONGUI.Input=function(e){TONGUI.Element.call(this);var t=document.createElement("input");return t.className="Input",t.addEventListener("keydown",function(e){e.stopPropagation()},!1),this.dom=t,this.setValue(e),this},TONGUI.Input.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Input.prototype.constructor=TONGUI.Input,TONGUI.Input.prototype.getValue=function(){return this.dom.value},TONGUI.Input.prototype.setValue=function(e){return this.dom.value=e,this},TONGUI.TextArea=function(){TONGUI.Element.call(this);var o=document.createElement("textarea");return o.className="layui-textarea",o.style.padding="2px",o.spellcheck=!1,o.placeHolder="请输入",o.addEventListener("keydown",function(e){if(e.stopPropagation(),9===e.keyCode){e.preventDefault();var t=o.selectionStart;o.value=o.value.substring(0,t)+"\t"+o.value.substring(t),o.selectionStart=t+1,o.selectionEnd=o.selectionStart}},!1),this.dom=o,this},TONGUI.TextArea.prototype=Object.create(TONGUI.Element.prototype),TONGUI.TextArea.prototype.constructor=TONGUI.TextArea,TONGUI.TextArea.prototype.getValue=function(){return this.dom.value},TONGUI.TextArea.prototype.setValue=function(e){return this.dom.value=e,this},TONGUI.Select=function(){TONGUI.Element.call(this);var e=document.createElement("select");return e.className="Select",this.dom=e,this},TONGUI.Select.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Select.prototype.constructor=TONGUI.Select,TONGUI.Select.prototype.setMultiple=function(e){return this.dom.multiple=e,this},TONGUI.Select.prototype.setOptions=function(e){for(var t=this.dom.value;0<this.dom.children.length;)this.dom.removeChild(this.dom.firstChild);for(var o=0;o<e.length;o++){var i=e[o];if(0<i.childContentArray.length){var a=document.createElement("optgroup");a.setAttribute("label",i.value);for(var n=0;n<i.childContentArray.length;n++){var r=i.childContentArray[n],s=document.createElement("option");s.value=r.value,s.innerHTML=r.value,r.isDisable&&s.setAttribute("disabled",""),r.isSelect&&s.setAttribute("selected",""),a.appendChild(s)}this.dom.appendChild(a)}else{var l=document.createElement("option");l.value=i.value,l.innerHTML=i.value,i.isDisable&&l.setAttribute("disabled",""),i.isSelect&&l.setAttribute("selected",""),this.dom.appendChild(l)}}return this.dom.value=t,this},TONGUI.Select.Content=function(e,t,o,i){this.value=e||"",this.isSelect=o||!1,this.isDisable=t||!1,this.childContentArray=i||[]},TONGUI.Select.prototype.getValue=function(){return this.dom.value},TONGUI.Select.prototype.setValue=function(e){return e=String(e),this.dom.value!==e&&(this.dom.value=e),this},TONGUI.Checkbox=function(e){TONGUI.Element.call(this);var t=document.createElement("input");return t.className="Checkbox",t.type="checkbox",this.dom=t,this.setValue(e),this},TONGUI.Checkbox.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Checkbox.prototype.constructor=TONGUI.Checkbox,TONGUI.Checkbox.prototype.getValue=function(){return this.dom.checked},TONGUI.Checkbox.prototype.setValue=function(e){return void 0!==e&&(this.dom.checked=e),this},TONGUI.Color=function(){TONGUI.Element.call(this);var e=document.createElement("input");e.className="Color",e.style.width="64px",e.style.height="17px",e.style.border="0px",e.style.padding="2px",e.style.backgroundColor="transparent";try{e.type="color",e.value="#ffffff"}catch(e){}return this.dom=e,this},TONGUI.Color.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Color.prototype.constructor=TONGUI.Color,TONGUI.Color.prototype.getValue=function(){return this.dom.value},TONGUI.Color.prototype.getHexValue=function(){return parseInt(this.dom.value.substr(1),16)},TONGUI.Color.prototype.setValue=function(e){return this.dom.value=e,this},TONGUI.Color.prototype.setHexValue=function(e){return this.dom.value="#"+("000000"+e.toString(16)).slice(-6),this},TONGUI.Number=function(e){TONGUI.Element.call(this);var i=this,a=document.createElement("input");a.className="Number",a.value="0.00",a.addEventListener("keydown",function(e){e.stopPropagation(),13===e.keyCode&&a.blur()},!1),this.value=0,this.min=-1/0,this.max=1/0,this.precision=2,this.step=1,this.unit="",this.dom=a,this.setValue(e);var n=document.createEvent("HTMLEvents");n.initEvent("change",!0,!0);var r=0,s=0,l=[0,0],c=[0,0];function t(e){var t=i.value;l=[e.clientX,e.clientY],r+=l[0]-c[0]-(l[1]-c[1]);var o=s+r/(e.shiftKey?5:50)*i.step;t!==(o=Math.min(i.max,Math.max(i.min,o)))&&(i.setValue(o),a.dispatchEvent(n)),c=[e.clientX,e.clientY]}function o(e){document.removeEventListener("mousemove",t,!1),document.removeEventListener("mouseup",o,!1),Math.abs(r)<2&&(a.focus(),a.select())}function u(e){}return a.addEventListener("mousedown",function(e){e.preventDefault(),r=0,s=i.value,c=[e.clientX,e.clientY],document.addEventListener("mousemove",t,!1),document.addEventListener("mouseup",o,!1)},!1),a.addEventListener("change",function(e){i.setValue(a.value)},!1),a.addEventListener("focus",function(e){},!1),a.addEventListener("blur",u,!1),this},TONGUI.Number.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Number.prototype.constructor=TONGUI.Number,TONGUI.Number.prototype.getValue=function(){return this.value},TONGUI.Number.prototype.setValue=function(e){return void 0!==e&&((e=parseFloat(e))<this.min&&(e=this.min),e>this.max&&(e=this.max),this.value=e,this.dom.value=e.toFixed(this.precision),""!==this.unit&&(this.dom.value+=" "+this.unit)),this},TONGUI.Number.prototype.setPrecision=function(e){return this.precision=e,this},TONGUI.Number.prototype.setStep=function(e){return this.step=e,this},TONGUI.Number.prototype.setRange=function(e,t){return this.min=e,this.max=t,this},TONGUI.Number.prototype.setUnit=function(e){return this.unit=e,this},TONGUI.Integer=function(e){TONGUI.Element.call(this);var i=this,a=document.createElement("input");a.className="Number",a.value="0",a.addEventListener("keydown",function(e){e.stopPropagation()},!1),this.value=0,this.min=-1/0,this.max=1/0,this.step=1,this.dom=a,this.setValue(e);var n=document.createEvent("HTMLEvents");n.initEvent("change",!0,!0);var r=0,s=0,l=[0,0],c=[0,0];function t(e){var t=i.value;l=[e.clientX,e.clientY],r+=l[0]-c[0]-(l[1]-c[1]);var o=s+r/(e.shiftKey?5:50)*i.step;t!==(o=0|Math.min(i.max,Math.max(i.min,o)))&&(i.setValue(o),a.dispatchEvent(n)),c=[e.clientX,e.clientY]}function o(e){document.removeEventListener("mousemove",t,!1),document.removeEventListener("mouseup",o,!1),Math.abs(r)<2&&(a.focus(),a.select())}function u(e){a.style.backgroundColor="transparent",a.style.cursor="col-resize"}return u(),a.addEventListener("mousedown",function(e){e.preventDefault(),r=0,s=i.value,c=[e.clientX,e.clientY],document.addEventListener("mousemove",t,!1),document.addEventListener("mouseup",o,!1)},!1),a.addEventListener("change",function(e){i.setValue(a.value)},!1),a.addEventListener("focus",function(e){a.style.backgroundColor="",a.style.cursor=""},!1),a.addEventListener("blur",u,!1),this},TONGUI.Integer.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Integer.prototype.constructor=TONGUI.Integer,TONGUI.Integer.prototype.getValue=function(){return this.value},TONGUI.Integer.prototype.setValue=function(e){return void 0!==e&&(e=parseInt(e),this.value=e,this.dom.value=e),this},TONGUI.Integer.prototype.setStep=function(e){return this.step=parseInt(e),this},TONGUI.Integer.prototype.setRange=function(e,t){return this.min=e,this.max=t,this},TONGUI.Break=function(){TONGUI.Element.call(this);var e=document.createElement("br");return e.className="Break",this.dom=e,this},TONGUI.Break.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Break.prototype.constructor=TONGUI.Break,TONGUI.HorizontalRule=function(){TONGUI.Element.call(this);var e=document.createElement("hr");return e.className="HorizontalRule",this.dom=e,this},TONGUI.HorizontalRule.prototype=Object.create(TONGUI.Element.prototype),TONGUI.HorizontalRule.prototype.constructor=TONGUI.HorizontalRule,TONGUI.P=function(e){TONGUI.Element.call(this);var t=document.createElement("p");return this.dom=t,this.dom.innerHTML=e,this},TONGUI.P.prototype=Object.create(TONGUI.Element.prototype),TONGUI.P.prototype.constructor=TONGUI.P,TONGUI.P.prototype.setValue=function(e){return this.dom.innerHTML=e,this},TONGUI.H=function(e,t){t=t&&t<=6?t:1,TONGUI.Element.call(this);var o=document.createElement("h"+t);return this.dom=o,this.dom.innerHTML=e,this},TONGUI.H.prototype=Object.create(TONGUI.Element.prototype),TONGUI.H.prototype.constructor=TONGUI.H,TONGUI.H.prototype.setValue=function(e){return this.dom.innerHTML=e,this},TONGUI.A=function(e){TONGUI.Element.call(this);var t=document.createElement("a");return t.className="a",e=e||"",t.innerHTML=e,this.dom=t,this},TONGUI.A.prototype=Object.create(TONGUI.Element.prototype),TONGUI.A.prototype.constructor=TONGUI.A,TONGUI.A.prototype.setValue=function(e){return this.dom.innerHTML=e,this},TONGUI.A.prototype.addValue=function(e){return this.dom.innerHTML+=e,this},TONGUI.Radio=function(e){TONGUI.Element.call(this),e.type="radio",e.tip="",this.name=e.name;var t=new TONGUI.InputField(e);return this.dom=t.dom,this},TONGUI.Radio.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Radio.prototype.constructor=TONGUI.Radio,TONGUI.Radio.prototype.addRadio=function(e){var t=this.getElementsByClass("layui-input-block"),o=this.getElementsByClass("layui-input-inline"),i=null;0<t.length?i=t[0]:0<o.length&&(i=o[0]),e.type="radio",e.name=this.name;var a=new TONGUI.Input;return a.setValue(e.value+""),a.setAttribute("type",e.type),a.setAttribute("title",e.title),a.setAttribute("name",e.name),e.isChecked&&a.setAttribute("checked",""),e.isDisabled&&a.setAttribute("disabled",""),i.appendChild(a.dom),this},TONGUI.TCheckBox=function(e){TONGUI.Element.call(this),e.type="checkbox",e.tip="",e.value="";var t=new TONGUI.InputField(e);return this.dom=t.dom,this},TONGUI.TCheckBox.prototype=Object.create(TONGUI.Element.prototype),TONGUI.TCheckBox.prototype.constructor=TONGUI.TCheckBox,TONGUI.DropDown=function(e){TONGUI.Element.call(this);var t=new TONGUI.Select;return t.setOptions(e),this.dom=t.dom,this},TONGUI.DropDown.prototype=Object.create(TONGUI.Element.prototype),TONGUI.DropDown.prototype.constructor=TONGUI.DropDown,TONGUI.Img=function(e){TONGUI.Element.call(this);var t=document.createElement("img");return this.dom=t,e=e||"",this.setAttribute("src",e),this.setClass("layui-nav-img"),this},TONGUI.Img.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Img.prototype.constructor=TONGUI.Img,TONGUI.Label=function(e){TONGUI.Element.call();var t=document.createElement("label");return t.className="layui-form-label",t.innerHTML=e,this.dom=t,this},TONGUI.Label.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Label.prototype.constructor=TONGUI.Label,TONGUI.Label.prototype.setValue=function(e){return this.dom.innerHTML=e,this},TONGUI.Item=function(){TONGUI.Element.call(this);var e=new TONGUI.Div;return e.setClass("layui-form layui-form-item"),this.dom=e.dom,this},TONGUI.Item.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Item.prototype.constructor=TONGUI.Item,TONGUI.Item.prototype.addItem=function(e){return this.add(e),document.body.appendChild(this.dom),this.use(),document.body.removeChild(this.dom),this},TONGUI.Item.prototype.setPaneStyle=function(){return this.dom.className+=" layui-form-pane",this},TONGUI.Item.prototype.ignorePaneStyle=function(){var e=this.dom.className;return this.dom.className=e.replace("layui-form-pane",""),this},TONGUI.Item.prototype.addLineItem=function(e){var t=new TONGUI.Div;return t.setClass("layui-inline"),this.add(t),t.add(e),document.body.appendChild(this.dom),this.use(),document.body.removeChild(this.dom),this},TONGUI.Item.prototype.use=function(){layui.use("form",function(){layui.form.render()})},TONGUI.InputField=function(e){TONGUI.Element.call(this);var t=new TONGUI.Div,o=new TONGUI.Label;o.setClass("layui-form-label"),o.setValue(e.label),t.add(o);var i=new TONGUI.Div;e.isInnerLine||i.setClass("layui-input-block"),(e.isInnerLine||""!=e.tip)&&i.setClass("layui-input-inline"),t.add(i);var a=new TONGUI.Input;a.setClass("layui-input"),a.setAttribute("type",e.type),a.setValue(e.value),""!=e.title&&a.setAttribute("title",""+e.title),e.isRequired&&a.setAttribute("required",""),e.placeHolder&&""!=e.placeHolder&&a.setAttribute("placeholder",e.placeHolder),"on"==e.isAutoComplete&&a.setAttribute("autocomplete",e.isAutoComplete),e.isDisable&&a.setAttribute("disable",""+e.isDisable),"checkbox"!=e.type&&"radio"!=e.type||(e.isChecked&&a.setAttribute("checked",""),e.isPrimary&&a.setAttribute("lay-skin","primary"),e.isSwitch&&"radio"!=e.type&&(a.setAttribute("lay-skin","switch"),a.setAttribute("lay-text",e.switchOpenLabel+"|"+e.switchCloseLabel))),""!=e.name&&a.setAttribute("name",e.name+""),i.add(a);var n=new TONGUI.Div;return n.setClass("layui-form-mid layui-word-aux"),n.dom.innerHTML=e.tip,t.add(n),this.Content=e,this.dom=t.dom,this},TONGUI.InputField.Content=function(e,t,o,i,a,n,r,s,l,c,u,d,h,p,m,g){this.value=e||"",this.label=t?e:"",this.type=a||"text",this.isInnerLine=i||!1,this.tip=o||"",this.title=l||"",this.isDisable=c||!1,this.isChecked=u||!1,this.isPrimary=d||!1,this.isSwitch=h||!1,this.switchOpenLabel=p||"On",this.switchCloseLabel=m||"Off",this.name=g||"",this.isRequired=n||!1,this.placeHolder=r||"",this.isAutoComplete=s?"on":"off"},TONGUI.InputField.Type={text:"text",tel:"tel",email:"email",password:"password",checkbox:"checkbox",radio:"radio"},TONGUI.InputField.prototype=Object.create(TONGUI.Element.prototype),TONGUI.InputField.prototype.constructor=TONGUI.InputField,TONGUI.InputField.prototype.setInnerLine=function(){var e=this.getElementsByClass("layui-input-block");return 0<e.length&&(e[0].className="layui-input-inline"),this},TONGUI.InputField.prototype.setDisInnerLine=function(){var e=this.getElementsByClass("layui-input-inline");return 0<e.length&&(e[0].className="layui-input-block"),this},TONGUI.Tab=function(){TONGUI.Element.call(this);var e=new TONGUI.Div;e.setClass("layui-tab"),e.setAttribute("lay-filter","tongEngine");var t=new TONGUI.Ul;t.setClass("layui-tab-title"),e.add(t);var o=new TONGUI.Div;o.setClass("layui-tab-content"),e.add(o),this.dom=e.dom,this.callBacks=[];for(var i=0;i<arguments.length;i++)"layui-tab-brief"!=arguments[i]&&"layui-tab-card"!=arguments[i]?"boolean"!=typeof arguments[i]?"function"!=typeof arguments[i]?this.addItem(arguments[i].title,arguments[i].content):this.callBacks.push(arguments[i]):this.setAllowClose(arguments[i]):e.dom.className+=" "+arguments[i];return this.use(),this},TONGUI.TabStyle={Simaple:"layui-tab-brief",Card:"layui-tab-card"},TONGUI.Tab.Content=function(e,t){return this.title=e||"",this.content=t||"",this},TONGUI.Tab.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Tab.prototype.constructor=TONGUI.Tab,TONGUI.Tab.prototype.addItem=function(e,t,o){var i=new TONGUI.Li;e=e||"",i.dom.innerHTML=e;var a=new TONGUI.Div;a.setClass("layui-tab-item"),t=t||"",a.dom.innerHTML=t,o&&(i.setClass("layui-this"),a.setClass("layui-show"));var n=this.getElementsByClass("layui-tab-title"),r=this.getElementsByClass("layui-tab-content");return n[0].appendChild(i.dom),r[0].appendChild(a.dom),this},TONGUI.Tab.prototype.setTabStyle=function(e){return this.dom.className+=" "+e,this},TONGUI.Tab.prototype.setAllowClose=function(e){return e?this.setAttribute("lay-allowClose",""+e):this.removeAttribute("lay-allowClose"),this},TONGUI.Tab.prototype.addCallBack=function(e){return this.callBacks.push(e),this},TONGUI.Tab.prototype.setDisplay=function(e){var t=this.getElementsByClass("layui-tab-title")[0],o=this.getElementsByClass("layui-tab-content")[0];for(var a in e=e||0,t.children)a.className="",e==i&&(a.className="layui-this"),i++;var n=0;for(var r in o.children)r.className="layui-tab-item",n==e&&(r.className="layui-tab-item layui-show"),n++},TONGUI.Tab.prototype.use=function(){var o=this;layui.use("element",function(){layui.element.on("tab(tongEngine)",function(e){for(var t=0;t<o.callBacks.length;t++)o.callBacks[t](e)})})},TONGUI.Cite=function(e){TONGUI.Element.call(this);var t=document.createElement("cite");return t.innerHTML=e,this.dom=t,this},TONGUI.Cite.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Cite.prototype.constructor=TONGUI.Cite,TONGUI.Cite.prototype.setValue=function(e){return this.dom.innerHTML=e,this},TONGUI.Breadcrumb=function(){TONGUI.Element.call(this);var e=new TONGUI.Span;e.setClass("layui-breadcrumb");for(var t=0;t<arguments.length;t++)if(arguments[t].isCite){(i=new TONGUI.A("")).dom.href=arguments[t].href;var o=new TONGUI.Cite(arguments[t].value);i.add(o),e.add(i)}else{var i;(i=new TONGUI.A(arguments[t].value)).dom.href=arguments[t].href,e.add(i)}return this.dom=e.dom,this},TONGUI.Breadcrumb.Content=function(e,t,o){return this.value=e||"TongEngine",this.isCite=o||!1,this.href=t&&""!=t?t:"javascript:;",this},TONGUI.Breadcrumb.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Breadcrumb.prototype.constructor=TONGUI.Breadcrumb,TONGUI.Breadcrumb.prototype.addValue=function(e,t,o){var i=new TONGUI.A("");if(t=t&&""!=t?t:"javascript:;",i.setAttribute("href",t),o){var a=new TONGUI.Cite(e);i.add(a)}else i.setValue(e);return this.add(i),this},TONGUI.Breadcrumb.prototype.setSeparator=function(e){return this.setAttribute("lay-separator",""+e),this},TONGUI.Navigation=function(){TONGUI.Element.call(this);var e=new TONGUI.Ul;e.setClass("layui-nav"),e.setAttribute("lay-filter","tongEngine"),this.nodeContents=[],this.callBacks=[];for(var t=0;t<arguments.length;t++)"function"!=typeof arguments[t]?(this.nodeContents.push(arguments[t]),e.add(arguments[t])):this.callBacks.push(arguments[t]);return this.dom=e.dom,this.use(),this},TONGUI.Navigation.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Navigation.prototype.constructor=TONGUI.Navigation,TONGUI.Navigation.prototype.addItem=function(e){return this.add(e),this},TONGUI.Navigation.prototype.setLayColor=function(e){return this.dom.className+=" "+e,this},TONGUI.Navigation.prototype.setVertical=function(){return this.dom.className+=" layui-nav-tree",this},TONGUI.Navigation.prototype.setHorizontal=function(e){var t=this.dom.className;return this.dom.className=t.replace("layui-nav-tree",""),this},TONGUI.Navigation.prototype.addCallBack=function(e){return this.callBacks.push(e),this},TONGUI.Navigation.prototype.use=function(){var o=this;layui.use("element",function(){layui.element.on("nav(tongEngine)",function(e){for(var t=0;t<o.callBacks.length;t++)o.callBacks[t](e)})})},TONGUI.NavigationItem=function(e,t,o){TONGUI.Element.call(this);var i=new TONGUI.Li;i.setClass("layui-nav-item"),o&&(i.dom.className+=" layui-nav-itemed"),e=e||"大瞳引擎",t=t||"javascript:;";var a=new TONGUI.A(e);return a.setAttribute("href",t),this.nodeContent=a,i.add(a),this.dom=i.dom,this},TONGUI.NavigationItem.prototype=Object.create(TONGUI.Element.prototype),TONGUI.NavigationItem.prototype.constructor=TONGUI.NavigationItem,TONGUI.NavigationItem.prototype.addItem=function(e){return this.add(e),this},TONGUI.NavigationItem.prototype.addValue=function(e){if(e instanceof TONGUI.Element)return this.nodeContent.add(e),this;var t=e;return this.nodeContent.dom.innerHTML+=t,this},TONGUI.NavigationChild=function(){TONGUI.Element.call(this);var e=document.createElement("dl");e.className="layui-nav-child",this.nodeContents=[];for(var t=0;t<arguments.length;t++){var o=document.createElement("dd"),i=arguments[t].value?arguments[t].value:"TongEngine",a=new TONGUI.A(i),n=arguments[t].href?arguments[t].href:"javascript:;";a.setAttribute("href",n),this.nodeContents.push(a),o.appendChild(a.dom),e.appendChild(o)}return this.dom=e,this},TONGUI.NavigationChild.Content=function(e,t){return this.value=e,this.href=t,this},TONGUI.NavigationChild.prototype=Object.create(TONGUI.Element.prototype),TONGUI.NavigationChild.prototype.constructor=TONGUI.NavigationChild,TONGUI.NavigationChild.prototype.addValueForNode=function(e,t){return this.nodeContents[e].dom+=t,this},TONGUI.Styleline=function(e){TONGUI.Element.call(this);var t=new TONGUI.HorizontalRule;return t.style("height:1px;margin:10px 0;border:0;background-color:#e2e2e2;clear:both"),t.setClass(e),this.dom=t.dom,this},TONGUI.Styleline.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Styleline.prototype.constructor=TONGUI.Styleline,TONGUI.Styleline.prototype.setLayColor=function(e){return this.setClass(e),this},TONGUI.Fieldset=function(e,t,o){TONGUI.Element.call(this);var i=document.createElement("fieldset");i.className="layui-elem-field";var a=document.createElement("legend");a.innerHTML=e||"Tong Engine",i.appendChild(a);var n=new TONGUI.Div;return n.setClass("layui-field-box"),i.appendChild(n.dom),o||(i.className+=" layui-field-title"),n.dom.innerHTML=t||"www.tong3d.com",this.dom=i,this},TONGUI.Fieldset.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Fieldset.prototype.constructor=TONGUI.Fieldset,TONGUI.Fieldset.prototype.setTitle=function(e){var t=this.getElementsByTag("legend")[0];return t.innerHTML=e,t},TONGUI.Fieldset.prototype.setContent=function(e){var t=this.getElementsByClass("layui-field-box")[0];return t.innerHTML=e,t},TONGUI.Fieldset.prototype.setBox=function(){var e=this.dom.className;return this.dom.className=e.replace("layui-field-title",""),this},TONGUI.Fieldset.prototype.setLine=function(){return-1!=(this.dom.className+"").indexOf("layui-field-title")||(this.dom.className+=" layui-field-title"),this},TONGUI.Blockquote=function(e,t){TONGUI.Element.call(this);var o=document.createElement("blockquote");return o.className="layui-elem-quote",t&&(o.className+=" layui-quote-nm"),o.innerHTML=e||"Use Tong Engine To www.tong3d.com",this.dom=o,this},TONGUI.Blockquote.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Blockquote.prototype.constructor=TONGUI.Blockquote,TONGUI.Blockquote.prototype.setGrayStyle=function(e){return e?this.dom.className+=" layui-quote-nm":this.dom.className=this.dom.className.replace("layui-quote-nm",""),this},TONGUI.Blockquote.prototype.setValue=function(e){return this.dom.innerHTML=e,this},TONGUI.Blockquote.prototype.addValue=function(e){return this.dom.innerHTML+=e,this},TONGUI.Collapse=function(){TONGUI.Element.call(this);var e=new TONGUI.Div;e.setClass("layui-collapse"),e.dom.setAttribute("lay-accordion",""),e.dom.setAttribute("lay-filter","tongEngine");for(var t=0;t<arguments.length;t++)if("function"!=typeof arguments[t]){var o=new TONGUI.Div;o.setClass("layui-colla-item"),e.add(o);var i=new TONGUI.H(arguments[t].title,2);i.setClass("layui-colla-title"),o.add(i);var a=new TONGUI.Div;a.setClass("layui-colla-content layui-show"),a.dom.innerHTML=arguments[t].content,o.add(a)}else this.callback=arguments[t];return this.dom=e.dom,this.currentData={show:{},title:{},content:{}},this.use(),this},TONGUI.Collapse.Content=function(e,t){this.title=e||"Tong Engine",this.content=t||"www.tong3d.com"},TONGUI.Collapse.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Collapse.prototype.constructor=TONGUI.Collapse,TONGUI.Collapse.prototype.setCallback=function(e){this.callback=e},TONGUI.Collapse.prototype.use=function(){layui.use("element",function(e){layui.element.on("collapse(tongEngine)",function(e){this.currentData.show=e.show,this.currentData.title=e.title,this.currentData.content=e.content,this.callback&&this.callback(this.currentData.show,this.currentData.title,this.currentData.content)}.bind(this))}.bind(this))},TONGUI.Collapse.prototype.IsShowOne=function(e){e?this.setAttribute("lay-accordion",""):this.removeAttribute("lay-accordion")},TONGUI.Collapse.prototype.getShowElement=function(){return this.currentData.show},TONGUI.Collapse.prototype.getTitleElement=function(){return this.currentData.title},TONGUI.Collapse.prototype.getContentElement=function(){return this.currentData.content},TONGUI.Collapse.prototype.getData=function(){return this.currentData},TONGUI.Badge=function(e,t,o){TONGUI.Element.call(this);var i=new TONGUI.Span;return i.dom.className=t||TONGUI.Badge.Shape.Ellipse,o=o||TONGUI.LayColor.Orange,i.dom.className+=" "+o,e=e||"",t!=TONGUI.Badge.Shape.Dot&&(i.dom.innerHTML=e),this.dom=i.dom,this},TONGUI.Badge.Shape={Dot:"layui-badge-dot",Ellipse:"layui-badge",Rim:"layui-badge-rim"},TONGUI.Badge.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Badge.prototype.constructor=TONGUI.Badge,TONGUI.Badge.prototype.setValue=function(e){return this.dom.innerHTML=e,this},TONGUI.Badge.prototype.addValue=function(e){return this.dom.innerHTML+=e,this},TONGUI.Badge.prototype.setShape=function(e){return this.dom.className+=" "+e,this},TONGUI.Badge.prototype.setColor=function(e){return this.dom.className+=" "+e,this},TONGUI.TimeLine=function(){TONGUI.Element.call(this);var e=new TONGUI.Ul;e.setClass("layui-timeline");for(var t=0;t<arguments.length;t++){var o=new TONGUI.Li;o.setClass("layui-timeline-item"),e.add(o);var i=new TONGUI.I;i.setClass("layui-icon layui-timeline-axis"),i.setValue(arguments[t].icon),o.add(i);var a=new TONGUI.Div;a.setClass("layui-timeline-content layui-text"),o.add(a);var n=new TONGUI.H(arguments[t].title,3);n.setClass("layui-timeline-title"),a.add(n);var r=new TONGUI.P(arguments[t].content);a.add(r)}return this.dom=e.dom,this},TONGUI.TimeLine.Content=function(e,t,o){this.icon=e||TONGUI.Icon.Radio_UnSelect,this.title=t||"Tong Engine",this.content=o||"www.tong3d.com"},TONGUI.TimeLine.prototype=Object.create(TONGUI.Element.prototype),TONGUI.TimeLine.prototype.constructor=TONGUI.TimeLine,TONGUI.Script=function(e,t,o,i,a,n,r){TONGUI.Element.call(this);var s=document.createElement("pre");return s.innerHTML=e,s.style.width=o+"px",this.dom=s,this.options={elem:this.dom,title:t||"大瞳引擎",height:i||"100px",encode:a||!1,skin:n||"notepad",about:r||!1},this},TONGUI.Script.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Script.prototype.constructor=TONGUI.Script,TONGUI.Script.prototype.use=function(){var e=this.options;layui.use("code",function(){layui.code(e)})},TONGUI.Carousel=function(e,t,o,i,a,n,r,s,l){TONGUI.Element.call(this);var c=new TONGUI.Div;c.setClass("layui-carousel");var u=new TONGUI.Div;return u.setAttribute("carousel-item",""),c.add(u),this.dom=c.dom,this.options={},this.options.elem=c.dom,this.options.index=r||0,this.options.full=o||!1,this.options.arrow=s||"always",this.options.autoplay=a||!1,this.options.indicator=l||"inside",this.options.width=e?e+"px":"500px",this.options.height=t?t+"px":"300px",this.options.anim=i||"default",this.options.interval=n||3e3,this.renderer=[],this},TONGUI.Carousel.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Carousel.prototype.constructor=TONGUI.Carousel,TONGUI.Carousel.prototype.addItem=function(e){return this.dom.firstChild.appendChild(e.dom),this},TONGUI.Carousel.prototype.reload=function(){0<this.renderer.length&&this.renderer[0].reload(this.options)},TONGUI.Carousel.prototype.use=function(){if(!(0<this.renderer.length)){var t=this.options,o=this.renderer;layui.use("carousel",function(){var e=layui.carousel.render(t);o[0]=e})}},TONGUI.ButtonGroup=function(){TONGUI.Element.call(this);var e=new TONGUI.Div;e.setClass("layui-btn-group");for(var t=0;t<arguments.length;t++){var o=arguments[t];o instanceof TONGUI.Button&&e.dom.appendChild(o.dom)}return this.dom=e.dom,this},TONGUI.ButtonGroup.prototype=Object.create(TONGUI.Element.prototype),TONGUI.ButtonGroup.prototype.constructor=TONGUI.ButtonGroup,TONGUI.Button=function(e){TONGUI.Element.call(this);var t=document.createElement("button");return t.className="layui-btn",t.type="button",this.dom=t,this.dom.textContent=e,this},TONGUI.ButtonStyle={Warm:" layui-btn-warm",Warning:" layui-btn-danger",Disable:" layui-btn-disabled",Laptop:" layui-btn-normal",Radius:" layui-btn-radius",Primary:" layui-btn-primary",Small:" layui-btn-small",Big:" layui-btn-big",Mini:" layui-btn-mini"},TONGUI.Button.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Button.prototype.constructor=TONGUI.Button,TONGUI.Button.prototype.setValue=function(e){return this.dom.innerHTML=e,this},TONGUI.Button.prototype.addValue=function(e){return this.dom.innerHTML+=e,this},TONGUI.Button.prototype.setButtonStyle=function(e){switch(e){case TONGUI.ButtonStyle.Warm:this.dom.className+=" layui-btn-warm";break;case TONGUI.ButtonStyle.Warning:this.dom.className+=" layui-btn-danger";break;case TONGUI.ButtonStyle.Disable:this.dom.className+=" layui-btn-disabled";break;case TONGUI.ButtonStyle.Laptop:this.dom.className+=" layui-btn-normal";break;case TONGUI.ButtonStyle.Radius:this.dom.className+=" layui-btn-radius";break;case TONGUI.ButtonStyle.Primary:this.dom.className+=" layui-btn-primary";break;case TONGUI.ButtonStyle.Small:this.dom.className+=" layui-btn-small";break;case TONGUI.ButtonStyle.Big:this.dom.className+=" layui-btn-big";break;case TONGUI.ButtonStyle.Mini:this.dom.className+=" layui-btn-mini"}return this},TONGUI.Button.prototype.setIcon=function(e){var t=new TONGUI.I(e);return this.clear(),this.add(t),this},TONGUI.I=function(e){TONGUI.Element.call(this);var t=document.createElement("i");return t.className="layui-icon",t.innerHTML=e,this.dom=t,this},TONGUI.I.prototype=Object.create(TONGUI.Element.prototype),TONGUI.I.prototype.constructor=TONGUI.I,TONGUI.I.prototype.setValue=function(e){return this.dom.innerHTML=e,this},TONGUI.Slider=function(e,t,o,i){TONGUI.Element.call(this);var a=document.createElement("input");return a.className="Slider",a.type="range",this.dom=a,this.dom.min=e||"0",this.dom.max=t||"100",this.dom.value=o||"50",this.dom.step=i||"1",this},TONGUI.Slider.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Slider.prototype.constructor=TONGUI.Slider,TONGUI.Slider.prototype.setValue=function(e){return this.dom.value=e,this},TONGUI.ButtonIcon=function(e,t,o,i){TONGUI.Element.call(this);var a=document.createElement("button");return a.className="Button",a.type="button",this.dom=a,this.dom.textContent=i,this.dom.style.background="url("+e+") "+t+" "+o+" no-repeat",this.dom.style.textAlign="right",this},TONGUI.ButtonIcon.prototype=Object.create(TONGUI.Element.prototype),TONGUI.ButtonIcon.prototype.constructor=TONGUI.ButtonIcon,TONGUI.ButtonIcon.prototype.setValue=function(e){return this.dom.textContent=e,this},TONGUI.ButtonIcon.prototype.getValue=function(){return this.dom.value},TONGUI.ButtonIcon.prototype.setValue=function(e){return this.dom.value=e,this},TONGUI.Modal=function(e){var t=this,o=document.createElement("div");return o.style.position="absolute",o.style.width="100%",o.style.height="100%",o.style.backgroundColor="rgba(0,0,0,0.5)",o.style.display="none",o.style.alignItems="center",o.style.justifyContent="center",o.addEventListener("click",function(e){t.hide()}),this.dom=o,this.container=new TONGUI.Panel,this.container.dom.style.width="200px",this.container.dom.style.padding="20px",this.container.dom.style.backgroundColor="#ffffff",this.container.dom.style.boxShadow="0px 5px 10px rgba(0,0,0,0.5)",this.add(this.container),this},TONGUI.Modal.prototype=Object.create(TONGUI.Element.prototype),TONGUI.Modal.prototype.constructor=TONGUI.Modal,TONGUI.Modal.prototype.show=function(e){return this.container.clear(),this.container.add(e),this.dom.style.display="flex",this},TONGUI.Modal.prototype.hide=function(){return this.dom.style.display="none",this},MeshLine.prototype.setGeometry=function(e,t){if(this.widthCallback=t,this.positions=[],this.counters=[],e instanceof TONG.Geometry)for(var o=0;o<e.vertices.length;o++){var i=e.vertices[o];t=o/e.vertices.length;this.positions.push(i.x,i.y,i.z),this.positions.push(i.x,i.y,i.z),this.counters.push(t),this.counters.push(t)}if(TONG.BufferGeometry,e instanceof Float32Array||e instanceof Array)for(o=0;o<e.length;o+=3){t=o/e.length;this.positions.push(e[o],e[o+1],e[o+2]),this.positions.push(e[o],e[o+1],e[o+2]),this.counters.push(t),this.counters.push(t)}this.process()},MeshLine.prototype.compareV3=function(e,t){var o=6*e,i=6*t;return this.positions[o]===this.positions[i]&&this.positions[o+1]===this.positions[i+1]&&this.positions[o+2]===this.positions[i+2]},MeshLine.prototype.copyV3=function(e){var t=6*e;return[this.positions[t],this.positions[t+1],this.positions[t+2]]},MeshLine.prototype.process=function(){var e,t,o=this.positions.length/6;this.previous=[],this.next=[],this.side=[],this.width=[],this.indices_array=[],this.uvs=[];for(var i=0;i<o;i++)this.side.push(1),this.side.push(-1);for(i=0;i<o;i++)e=this.widthCallback?this.widthCallback(i/(o-1)):1,this.width.push(e),this.width.push(e);for(i=0;i<o;i++)this.uvs.push(i/(o-1),0),this.uvs.push(i/(o-1),1);t=this.compareV3(0,o-1)?this.copyV3(o-2):this.copyV3(0),this.previous.push(t[0],t[1],t[2]),this.previous.push(t[0],t[1],t[2]);for(i=0;i<o-1;i++)t=this.copyV3(i),this.previous.push(t[0],t[1],t[2]),this.previous.push(t[0],t[1],t[2]);for(i=1;i<o;i++)t=this.copyV3(i),this.next.push(t[0],t[1],t[2]),this.next.push(t[0],t[1],t[2]);t=this.compareV3(o-1,0)?this.copyV3(1):this.copyV3(o-1),this.next.push(t[0],t[1],t[2]),this.next.push(t[0],t[1],t[2]);for(i=0;i<o-1;i++){var a=2*i;this.indices_array.push(a,a+1,a+2),this.indices_array.push(a+2,a+1,a+3)}this.attributes?(this.attributes.position.copyArray(new Float32Array(this.positions)),this.attributes.position.needsUpdate=!0,this.attributes.previous.copyArray(new Float32Array(this.previous)),this.attributes.previous.needsUpdate=!0,this.attributes.next.copyArray(new Float32Array(this.next)),this.attributes.next.needsUpdate=!0,this.attributes.side.copyArray(new Float32Array(this.side)),this.attributes.side.needsUpdate=!0,this.attributes.width.copyArray(new Float32Array(this.width)),this.attributes.width.needsUpdate=!0,this.attributes.uv.copyArray(new Float32Array(this.uvs)),this.attributes.uv.needsUpdate=!0,this.attributes.index.copyArray(new Uint16Array(this.indices_array)),this.attributes.index.needsUpdate=!0):this.attributes={position:new TONG.BufferAttribute(new Float32Array(this.positions),3),previous:new TONG.BufferAttribute(new Float32Array(this.previous),3),next:new TONG.BufferAttribute(new Float32Array(this.next),3),side:new TONG.BufferAttribute(new Float32Array(this.side),1),width:new TONG.BufferAttribute(new Float32Array(this.width),1),uv:new TONG.BufferAttribute(new Float32Array(this.uvs),2),index:new TONG.BufferAttribute(new Uint16Array(this.indices_array),1),counters:new TONG.BufferAttribute(new Float32Array(this.counters),1)},this.geometry.addAttribute("position",this.attributes.position),this.geometry.addAttribute("previous",this.attributes.previous),this.geometry.addAttribute("next",this.attributes.next),this.geometry.addAttribute("side",this.attributes.side),this.geometry.addAttribute("width",this.attributes.width),this.geometry.addAttribute("uv",this.attributes.uv),this.geometry.addAttribute("counters",this.attributes.counters),this.geometry.setIndex(this.attributes.index)},MeshLine.prototype.advance=function(e){var t=this.attributes.position.array,o=this.attributes.previous.array,i=this.attributes.next.array,a=t.length;memcpy(t,0,o,0,a),memcpy(t,6,t,0,a-6),t[a-6]=e.x,t[a-5]=e.y,t[a-4]=e.z,t[a-3]=e.x,t[a-2]=e.y,t[a-1]=e.z,memcpy(t,6,i,0,a-6),i[a-6]=e.x,i[a-5]=e.y,i[a-4]=e.z,i[a-3]=e.x,i[a-2]=e.y,i[a-1]=e.z,this.attributes.position.needsUpdate=!0,this.attributes.previous.needsUpdate=!0,this.attributes.next.needsUpdate=!0},MeshLineMaterial.prototype=Object.create(TONG.Material.prototype),MeshLineMaterial.prototype.constructor=MeshLineMaterial,MeshLineMaterial.prototype.copy=function(e){return TONG.Material.prototype.copy.call(this,e),this.lineWidth=e.lineWidth,this.map=e.map,this.useMap=e.useMap,this.alphaMap=e.alphaMap,this.useAlphaMap=e.useAlphaMap,this.color.copy(e.color),this.opacity=e.opacity,this.resolution.copy(e.resolution),this.sizeAttenuation=e.sizeAttenuation,this.near=e.near,this.far=e.far,this.dashArray.copy(e.dashArray),this.useDash=e.useDash,this.visibility=e.visibility,this.alphaTest=e.alphaTest,this.repeat.copy(e.repeat),this},TONG.MeshLine=MeshLine,TONG.MeshLineMaterial=MeshLineMaterial,Object.defineProperty(TONG.Skeleton.prototype,"uuid",{set:function(e){e&&e!=this._uuid&&(this._uuid=e)},get:function(){return this._uuid=this._uuid?this._uuid:TONG.Math.generateUUID(),this._uuid},enumerable:!1}),TONG.Skeleton.prototype.toJSON=function(){for(var e={},t=[],o=[],i=0,a=this.bones.length;i<a;i++)t.push(this.bones[i].uuid);for(i=0,a=this.boneInverses.length;i<a;i++)o.push(this.boneInverses[i].toArray());return e.uuid=this.uuid,e.bones=t,e.boneInverses=o,e};