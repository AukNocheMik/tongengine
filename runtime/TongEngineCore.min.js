/*!@license 深圳市大瞳世界科技有限公司版权所有*/
var ParticleSystem={distributions:{BOX:1,SPHERE:2,DISC:3},valueOverLifetimeLength:4};function extendClass(e,t){if(!(t instanceof Function)||e instanceof Function){for(var i in t)e.hasOwnProperty(i)||(e[i]=t[i]);if(t.prototype)for(var i in t.prototype)t.prototype.hasOwnProperty(i)&&(e.prototype.hasOwnProperty(i)||(t.prototype.__lookupGetter__(i)?e.prototype.__defineGetter__(i,t.prototype.__lookupGetter__(i)):e.prototype[i]=t.prototype[i],t.prototype.__lookupSetter__(i)&&e.prototype.__defineSetter__(i,t.prototype.__lookupSetter__(i))))}else{var r=new t;for(var i in r)e[i]=r[i]}}"function"==typeof define&&define.amd?define("ParticleSystem",ParticleSystem):"undefined"!=typeof exports&&"undefined"!=typeof module&&(module.exports=ParticleSystem),ParticleSystem.TypedArrayHelper=function(e,t,i,r){"use strict";this.componentSize=i||1,this.size=t||1,this.TypedArrayConstructor=e||Float32Array,this.array=new e(t*this.componentSize),this.indexOffset=r||0},ParticleSystem.TypedArrayHelper.constructor=ParticleSystem.TypedArrayHelper,ParticleSystem.TypedArrayHelper.prototype.setSize=function(e,t){"use strict";var i=this.array.length;return t||(e*=this.componentSize),e<i?this.shrink(e):i<e?this.grow(e):void console.info("TypedArray is already of size:",e+".","Will not resize.")},ParticleSystem.TypedArrayHelper.prototype.shrink=function(e){"use strict";return this.array=this.array.subarray(0,e),this.size=e,this},ParticleSystem.TypedArrayHelper.prototype.grow=function(e){"use strict";var t=this.array,i=new this.TypedArrayConstructor(e);return i.set(t),this.array=i,this.size=e,this},ParticleSystem.TypedArrayHelper.prototype.splice=function(e,t){"use strict";e*=this.componentSize,t*=this.componentSize;for(var i=[],r=this.array,o=r.length,n=0;n<o;++n)(n<e||t<=n)&&i.push(r[n]);return this.setFromArray(0,i),this},ParticleSystem.TypedArrayHelper.prototype.setFromArray=function(e,t){"use strict";var i=e+t.length;return i>this.array.length?this.grow(i):i<this.array.length&&this.shrink(i),this.array.set(t,this.indexOffset+e),this},ParticleSystem.TypedArrayHelper.prototype.setVec2=function(e,t){"use strict";return this.setVec2Components(e,t.x,t.y)},ParticleSystem.TypedArrayHelper.prototype.setVec2Components=function(e,t,i){"use strict";var r=this.array,o=this.indexOffset+e*this.componentSize;return r[o]=t,r[o+1]=i,this},ParticleSystem.TypedArrayHelper.prototype.setVec3=function(e,t){"use strict";return this.setVec3Components(e,t.x,t.y,t.z)},ParticleSystem.TypedArrayHelper.prototype.setVec3Components=function(e,t,i,r){"use strict";var o=this.array,n=this.indexOffset+e*this.componentSize;return o[n]=t,o[n+1]=i,o[n+2]=r,this},ParticleSystem.TypedArrayHelper.prototype.setVec4=function(e,t){"use strict";return this.setVec4Components(e,t.x,t.y,t.z,t.w)},ParticleSystem.TypedArrayHelper.prototype.setVec4Components=function(e,t,i,r,o){"use strict";var n=this.array,a=this.indexOffset+e*this.componentSize;return n[a]=t,n[a+1]=i,n[a+2]=r,n[a+3]=o,this},ParticleSystem.TypedArrayHelper.prototype.setMat3=function(e,t){"use strict";return this.setFromArray(this.indexOffset+e*this.componentSize,t.elements)},ParticleSystem.TypedArrayHelper.prototype.setMat4=function(e,t){"use strict";return this.setFromArray(this.indexOffset+e*this.componentSize,t.elements)},ParticleSystem.TypedArrayHelper.prototype.setColor=function(e,t){"use strict";return this.setVec3Components(e,t.r,t.g,t.b)},ParticleSystem.TypedArrayHelper.prototype.setNumber=function(e,t){"use strict";return this.array[this.indexOffset+e*this.componentSize]=t,this},ParticleSystem.TypedArrayHelper.prototype.getValueAtIndex=function(e){"use strict";return this.array[this.indexOffset+e]},ParticleSystem.TypedArrayHelper.prototype.getComponentValueAtIndex=function(e){"use strict";return this.array.subarray(this.indexOffset+e*this.componentSize)},ParticleSystem.ShaderAttribute=function(e,t,i){"use strict";var r=ParticleSystem.ShaderAttribute.typeSizeMap;this.type="string"==typeof e&&r.hasOwnProperty(e)?e:"f",this.componentSize=r[this.type],this.arrayType=i||Float32Array,this.typedArray=null,this.bufferAttribute=null,this.dynamicBuffer=!!t,this.updateMin=0,this.updateMax=0},ParticleSystem.ShaderAttribute.constructor=ParticleSystem.ShaderAttribute,ParticleSystem.ShaderAttribute.typeSizeMap={f:1,v2:2,v3:3,v4:4,c:3,m3:9,m4:16},ParticleSystem.ShaderAttribute.prototype.setUpdateRange=function(e,t){"use strict";this.updateMin=Math.min(e*this.componentSize,this.updateMin*this.componentSize),this.updateMax=Math.max(t*this.componentSize,this.updateMax*this.componentSize)},ParticleSystem.ShaderAttribute.prototype.flagUpdate=function(){"use strict";var e=this.bufferAttribute,t=e.updateRange;t.offset=this.updateMin,t.count=Math.min(this.updateMax-this.updateMin+this.componentSize,this.typedArray.array.length),e.needsUpdate=!0},ParticleSystem.ShaderAttribute.prototype.resetUpdateRange=function(){"use strict";this.updateMin=0,this.updateMax=0},ParticleSystem.ShaderAttribute.prototype.resetDynamic=function(){"use strict";this.bufferAttribute.dynamic=this.dynamicBuffer},ParticleSystem.ShaderAttribute.prototype.splice=function(e,t){"use strict";this.typedArray.splice(e,t),this.forceUpdateAll()},ParticleSystem.ShaderAttribute.prototype.forceUpdateAll=function(){"use strict";this.bufferAttribute.array=this.typedArray.array,this.bufferAttribute.updateRange.offset=0,this.bufferAttribute.updateRange.count=-1,this.bufferAttribute.dynamic=!1,this.bufferAttribute.needsUpdate=!0},ParticleSystem.ShaderAttribute.prototype._ensureTypedArray=function(e){"use strict";null!==this.typedArray&&this.typedArray.size===e*this.componentSize||(null!==this.typedArray&&this.typedArray.size!==e?this.typedArray.setSize(e):null===this.typedArray&&(this.typedArray=new ParticleSystem.TypedArrayHelper(this.arrayType,e,this.componentSize)))},ParticleSystem.ShaderAttribute.prototype._createBufferAttribute=function(e){"use strict";return this._ensureTypedArray(e),null!==this.bufferAttribute?(this.bufferAttribute.array=this.typedArray.array,81<=parseFloat(TONG.REVISION)&&(this.bufferAttribute.count=this.bufferAttribute.array.length/this.bufferAttribute.itemSize),void(this.bufferAttribute.needsUpdate=!0)):(this.bufferAttribute=new TONG.BufferAttribute(this.typedArray.array,this.componentSize),void(this.bufferAttribute.dynamic=this.dynamicBuffer))},ParticleSystem.ShaderAttribute.prototype.getLength=function(){"use strict";return null===this.typedArray?0:this.typedArray.array.length},ParticleSystem.shaderChunks={defines:["#define PACKED_COLOR_SIZE 256.0","#define PACKED_COLOR_DIVISOR 255.0"].join("\n"),uniforms:["uniform float deltaTime;","uniform float runTime;","uniform sampler2D texture;","uniform vec4 textureAnimation;","uniform float scale;"].join("\n"),attributes:["attribute vec4 acceleration;","attribute vec3 velocity;","attribute vec4 rotation;","attribute vec3 rotationCenter;","attribute vec4 params;","attribute vec4 size;","attribute vec4 angle;","attribute vec4 color;","attribute vec4 opacity;"].join("\n"),varyings:["varying vec4 vColor;","#ifdef SHOULD_ROTATE_TEXTURE","    varying float vAngle;","#endif","#ifdef SHOULD_CALCULATE_SPRITE","    varying vec4 vSpriteSheet;","#endif"].join("\n"),branchAvoidanceFunctions:["float when_gt(float x, float y) {","    return max(sign(x - y), 0.0);","}","float when_lt(float x, float y) {","    return min( max(1.0 - sign(x - y), 0.0), 1.0 );","}","float when_eq( float x, float y ) {","    return 1.0 - abs( sign( x - y ) );","}","float when_ge(float x, float y) {","  return 1.0 - when_lt(x, y);","}","float when_le(float x, float y) {","  return 1.0 - when_gt(x, y);","}","float and(float a, float b) {","    return a * b;","}","float or(float a, float b) {","    return min(a + b, 1.0);","}"].join("\n"),unpackColor:["vec3 unpackColor( in float hex ) {","   vec3 c = vec3( 0.0 );","   float r = mod( (hex / PACKED_COLOR_SIZE / PACKED_COLOR_SIZE), PACKED_COLOR_SIZE );","   float g = mod( (hex / PACKED_COLOR_SIZE), PACKED_COLOR_SIZE );","   float b = mod( hex, PACKED_COLOR_SIZE );","   c.r = r / PACKED_COLOR_DIVISOR;","   c.g = g / PACKED_COLOR_DIVISOR;","   c.b = b / PACKED_COLOR_DIVISOR;","   return c;","}"].join("\n"),unpackRotationAxis:["vec3 unpackRotationAxis( in float hex ) {","   vec3 c = vec3( 0.0 );","   float r = mod( (hex / PACKED_COLOR_SIZE / PACKED_COLOR_SIZE), PACKED_COLOR_SIZE );","   float g = mod( (hex / PACKED_COLOR_SIZE), PACKED_COLOR_SIZE );","   float b = mod( hex, PACKED_COLOR_SIZE );","   c.r = r / PACKED_COLOR_DIVISOR;","   c.g = g / PACKED_COLOR_DIVISOR;","   c.b = b / PACKED_COLOR_DIVISOR;","   c *= vec3( 2.0 );","   c -= vec3( 1.0 );","   return c;","}"].join("\n"),floatOverLifetime:["float getFloatOverLifetime( in float positionInTime, in vec4 attr ) {","    highp float value = 0.0;","    float deltaAge = positionInTime * float( VALUE_OVER_LIFETIME_LENGTH - 1 );","    float fIndex = 0.0;","    float shouldApplyValue = 0.0;","    value += attr[ 0 ] * when_eq( deltaAge, 0.0 );","","    for( int i = 0; i < VALUE_OVER_LIFETIME_LENGTH - 1; ++i ) {","       fIndex = float( i );","       shouldApplyValue = and( when_gt( deltaAge, fIndex ), when_le( deltaAge, fIndex + 1.0 ) );","       value += shouldApplyValue * mix( attr[ i ], attr[ i + 1 ], deltaAge - fIndex );","    }","","    return value;","}"].join("\n"),colorOverLifetime:["vec3 getColorOverLifetime( in float positionInTime, in vec3 color1, in vec3 color2, in vec3 color3, in vec3 color4 ) {","    vec3 value = vec3( 0.0 );","    value.x = getFloatOverLifetime( positionInTime, vec4( color1.x, color2.x, color3.x, color4.x ) );","    value.y = getFloatOverLifetime( positionInTime, vec4( color1.y, color2.y, color3.y, color4.y ) );","    value.z = getFloatOverLifetime( positionInTime, vec4( color1.z, color2.z, color3.z, color4.z ) );","    return value;","}"].join("\n"),paramFetchingFunctions:["float getAlive() {","   return params.x;","}","float getAge() {","   return params.y;","}","float getMaxAge() {","   return params.z;","}","float getWiggle() {","   return params.w;","}"].join("\n"),forceFetchingFunctions:["vec4 getPosition( in float age ) {","   return modelViewMatrix * vec4( position, 1.0 );","}","vec3 getVelocity( in float age ) {","   return velocity * age;","}","vec3 getAcceleration( in float age ) {","   return acceleration.xyz * age;","}"].join("\n"),rotationFunctions:["#ifdef SHOULD_ROTATE_PARTICLES","   mat4 getRotationMatrix( in vec3 axis, in float angle) {","       axis = normalize(axis);","       float s = sin(angle);","       float c = cos(angle);","       float oc = 1.0 - c;","","       return mat4(oc * axis.x * axis.x + c,           oc * axis.x * axis.y - axis.z * s,  oc * axis.z * axis.x + axis.y * s,  0.0,","                   oc * axis.x * axis.y + axis.z * s,  oc * axis.y * axis.y + c,           oc * axis.y * axis.z - axis.x * s,  0.0,","                   oc * axis.z * axis.x - axis.y * s,  oc * axis.y * axis.z + axis.x * s,  oc * axis.z * axis.z + c,           0.0,","                   0.0,                                0.0,                                0.0,                                1.0);","   }","","   vec3 getRotation( in vec3 pos, in float positionInTime ) {","      if( rotation.y == 0.0 ) {","           return pos;","      }","","      vec3 axis = unpackRotationAxis( rotation.x );","      vec3 center = rotationCenter;","      vec3 translated;","      mat4 rotationMatrix;","      float angle = 0.0;","      angle += when_eq( rotation.z, 0.0 ) * rotation.y;","      angle += when_gt( rotation.z, 0.0 ) * mix( 0.0, rotation.y, positionInTime );","      translated = rotationCenter - pos;","      rotationMatrix = getRotationMatrix( axis, angle );","      return center - vec3( rotationMatrix * vec4( translated, 0.0 ) );","   }","#endif"].join("\n"),rotateTexture:["    vec2 vUv = vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y );","","    #ifdef SHOULD_ROTATE_TEXTURE","       float x = gl_PointCoord.x - 0.5;","       float y = 1.0 - gl_PointCoord.y - 0.5;","       float c = cos( -vAngle );","       float s = sin( -vAngle );","       vUv = vec2( c * x + s * y + 0.5, c * y - s * x + 0.5 );","    #endif","","    #ifdef SHOULD_CALCULATE_SPRITE","        float framesX = vSpriteSheet.x;","        float framesY = vSpriteSheet.y;","        float columnNorm = vSpriteSheet.z;","        float rowNorm = vSpriteSheet.w;","        vUv.x = gl_PointCoord.x * framesX + columnNorm;","        vUv.y = 1.0 - (gl_PointCoord.y * framesY + rowNorm);","    #endif","","    vec4 rotatedTexture = texture2D( texture, vUv );"].join("\n")},ParticleSystem.shaders={vertex:[ParticleSystem.shaderChunks.defines,ParticleSystem.shaderChunks.uniforms,ParticleSystem.shaderChunks.attributes,ParticleSystem.shaderChunks.varyings,TONG.ShaderChunk.common,TONG.ShaderChunk.logdepthbuf_pars_vertex,TONG.ShaderChunk.fog_pars_vertex,ParticleSystem.shaderChunks.branchAvoidanceFunctions,ParticleSystem.shaderChunks.unpackColor,ParticleSystem.shaderChunks.unpackRotationAxis,ParticleSystem.shaderChunks.floatOverLifetime,ParticleSystem.shaderChunks.colorOverLifetime,ParticleSystem.shaderChunks.paramFetchingFunctions,ParticleSystem.shaderChunks.forceFetchingFunctions,ParticleSystem.shaderChunks.rotationFunctions,"void main() {","    highp float age = getAge();","    highp float alive = getAlive();","    highp float maxAge = getMaxAge();","    highp float positionInTime = (age / maxAge);","    highp float isAlive = when_gt( alive, 0.0 );","    #ifdef SHOULD_WIGGLE_PARTICLES","        float wiggleAmount = positionInTime * getWiggle();","        float wiggleSin = isAlive * sin( wiggleAmount );","        float wiggleCos = isAlive * cos( wiggleAmount );","    #endif","    vec3 vel = getVelocity( age );","    vec3 accel = getAcceleration( age );","    vec3 force = vec3( 0.0 );","    vec3 pos = vec3( position );","    float drag = 1.0 - (positionInTime * 0.5) * acceleration.w;","    force += vel;","    force *= drag;","    force += accel * age;","    pos += force;","    #ifdef SHOULD_WIGGLE_PARTICLES","        pos.x += wiggleSin;","        pos.y += wiggleCos;","        pos.z += wiggleSin;","    #endif","    #ifdef SHOULD_ROTATE_PARTICLES","        pos = getRotation( pos, positionInTime );","    #endif","    vec4 mvPosition = modelViewMatrix * vec4( pos, 1.0 );","    highp float pointSize = getFloatOverLifetime( positionInTime, size ) * isAlive;","    #ifdef HAS_PERParticleSystemCTIVE","        float perParticleSystemctive = scale / length( mvPosition.xyz );","    #else","        float perParticleSystemctive = 1.0;","    #endif","    float pointSizePerParticleSystemctive = pointSize * perParticleSystemctive;","    #ifdef COLORIZE","       vec3 c = isAlive * getColorOverLifetime(","           positionInTime,","           unpackColor( color.x ),","           unpackColor( color.y ),","           unpackColor( color.z ),","           unpackColor( color.w )","       );","    #else","       vec3 c = vec3(1.0);","    #endif","    float o = isAlive * getFloatOverLifetime( positionInTime, opacity );","    vColor = vec4( c, o );","    #ifdef SHOULD_ROTATE_TEXTURE","        vAngle = isAlive * getFloatOverLifetime( positionInTime, angle );","    #endif","    #ifdef SHOULD_CALCULATE_SPRITE","        float framesX = textureAnimation.x;","        float framesY = textureAnimation.y;","        float loopCount = textureAnimation.w;","        float totalFrames = textureAnimation.z;","        float frameNumber = mod( (positionInTime * loopCount) * totalFrames, totalFrames );","        float column = floor(mod( frameNumber, framesX ));","        float row = floor( (frameNumber - column) / framesX );","        float columnNorm = column / framesX;","        float rowNorm = row / framesY;","        vSpriteSheet.x = 1.0 / framesX;","        vSpriteSheet.y = 1.0 / framesY;","        vSpriteSheet.z = columnNorm;","        vSpriteSheet.w = rowNorm;","    #endif","    gl_PointSize = pointSizePerParticleSystemctive;","    gl_Position = projectionMatrix * mvPosition;",TONG.ShaderChunk.logdepthbuf_vertex,TONG.ShaderChunk.fog_vertex,"}"].join("\n"),fragment:[ParticleSystem.shaderChunks.uniforms,TONG.ShaderChunk.common,TONG.ShaderChunk.fog_pars_fragment,TONG.ShaderChunk.logdepthbuf_pars_fragment,ParticleSystem.shaderChunks.varyings,ParticleSystem.shaderChunks.branchAvoidanceFunctions,"void main() {","    vec3 outgoingLight = vColor.xyz;","    ","    #ifdef ALPHATEST","       if ( vColor.w < float(ALPHATEST) ) discard;","    #endif",ParticleSystem.shaderChunks.rotateTexture,TONG.ShaderChunk.logdepthbuf_fragment,"    outgoingLight = vColor.xyz * rotatedTexture.xyz;","    gl_FragColor = vec4( outgoingLight.xyz, rotatedTexture.w * vColor.w );",TONG.ShaderChunk.fog_fragment,"}"].join("\n")},ParticleSystem.utils={types:{BOOLEAN:"boolean",STRING:"string",NUMBER:"number",OBJECT:"object"},ensureTypedArg:function(e,t,i){"use strict";return typeof e===t?e:i},ensureArrayTypedArg:function(e,t,i){"use strict";if(Array.isArray(e)){for(var r=e.length-1;0<=r;--r)if(typeof e[r]!==t)return i;return e}return this.ensureTypedArg(e,t,i)},ensureInstanceOf:function(e,t,i){"use strict";return void 0!==t&&e instanceof t?e:i},ensureArrayInstanceOf:function(e,t,i){"use strict";if(Array.isArray(e)){for(var r=e.length-1;0<=r;--r)if(void 0!==t&&e[r]instanceof t==0)return i;return e}return this.ensureInstanceOf(e,t,i)},ensureValueOverLifetimeCompliance:function(e,t,i){"use strict";t=t||3,i=i||3,!1===Array.isArray(e._value)&&(e._value=[e._value]),!1===Array.isArray(e._spread)&&(e._spread=[e._spread]);var r=this.clamp(e._value.length,t,i),o=this.clamp(e._spread.length,t,i),n=Math.max(r,o);e._value.length!==n&&(e._value=this.interpolateArray(e._value,n)),e._spread.length!==n&&(e._spread=this.interpolateArray(e._spread,n))},interpolateArray:function(e,t){"use strict";for(var i=e.length,r=["function"==typeof e[0].clone?e[0].clone():e[0]],o=(i-1)/(t-1),n=1;n<t-1;++n){var a=n*o,s=Math.floor(a),l=Math.ceil(a),c=a-s;r[n]=this.lerpTypeAgnostic(e[s],e[l],c)}return r.push("function"==typeof e[i-1].clone?e[i-1].clone():e[i-1]),r},clamp:function(e,t,i){"use strict";return Math.max(t,Math.min(e,i))},zeroToEpsilon:function(e,t){"use strict";var i=e;return i=t?1e-5*Math.random()*10:1e-5,e<0&&-1e-5<e&&(i=-i),i},lerpTypeAgnostic:function(e,t,i){"use strict";var r,o=this.types;return typeof e===o.NUMBER&&typeof t===o.NUMBER?e+(t-e)*i:e instanceof TONG.Vector2&&t instanceof TONG.Vector2?((r=e.clone()).x=this.lerp(e.x,t.x,i),r.y=this.lerp(e.y,t.y,i),r):e instanceof TONG.Vector3&&t instanceof TONG.Vector3?((r=e.clone()).x=this.lerp(e.x,t.x,i),r.y=this.lerp(e.y,t.y,i),r.z=this.lerp(e.z,t.z,i),r):e instanceof TONG.Vector4&&t instanceof TONG.Vector4?((r=e.clone()).x=this.lerp(e.x,t.x,i),r.y=this.lerp(e.y,t.y,i),r.z=this.lerp(e.z,t.z,i),r.w=this.lerp(e.w,t.w,i),r):e instanceof TONG.Color&&t instanceof TONG.Color?((r=e.clone()).r=this.lerp(e.r,t.r,i),r.g=this.lerp(e.g,t.g,i),r.b=this.lerp(e.b,t.b,i),r):void console.warn("Invalid argument types, or argument types do not match:",e,t)},lerp:function(e,t,i){"use strict";return e+(t-e)*i},roundToNearestMultiple:function(e,t){"use strict";var i=0;return 0===t?e:0===(i=Math.abs(e)%t)?e:e<0?-(Math.abs(e)-i):e+t-i},arrayValuesAreEqual:function(e){"use strict";for(var t=0;t<e.length-1;++t)if(e[t]!==e[t+1])return!1;return!0},randomFloat:function(e,t){"use strict";return e+t*(Math.random()-.5)},randomVector3:function(e,t,i,r,o){"use strict";var n=i.x+(Math.random()*r.x-.5*r.x),a=i.y+(Math.random()*r.y-.5*r.y),s=i.z+(Math.random()*r.z-.5*r.z);o&&(n=.5*-o.x+this.roundToNearestMultiple(n,o.x),a=.5*-o.y+this.roundToNearestMultiple(a,o.y),s=.5*-o.z+this.roundToNearestMultiple(s,o.z)),e.typedArray.setVec3Components(t,n,a,s)},randomColor:function(e,t,i,r){"use strict";var o=i.r+Math.random()*r.x,n=i.g+Math.random()*r.y,a=i.b+Math.random()*r.z;o=this.clamp(o,0,1),n=this.clamp(n,0,1),a=this.clamp(a,0,1),e.typedArray.setVec3Components(t,o,n,a)},randomColorAsHex:function(){"use strict";var l=new TONG.Color;return function(e,t,i,r){for(var o=i.length,n=[],a=0;a<o;++a){var s=r[a];l.copy(i[a]),l.r+=Math.random()*s.x-.5*s.x,l.g+=Math.random()*s.y-.5*s.y,l.b+=Math.random()*s.z-.5*s.z,l.r=this.clamp(l.r,0,1),l.g=this.clamp(l.g,0,1),l.b=this.clamp(l.b,0,1),n.push(l.getHex())}e.typedArray.setVec4Components(t,n[0],n[1],n[2],n[3])}}(),randomVector3OnSphere:function(e,t,i,r,o,n,a,s){"use strict";var l=2*Math.random()-1,c=6.2832*Math.random(),h=Math.sqrt(1-l*l),u=this.randomFloat(r,o),d=0,p=0,m=0;a&&(u=Math.round(u/a)*a),d=h*Math.cos(c)*u,p=h*Math.sin(c)*u,m=l*u,d*=n.x,p*=n.y,m*=n.z,d+=i.x,p+=i.y,m+=i.z,e.typedArray.setVec3Components(t,d,p,m)},seededRandom:function(e){var t=1e4*Math.sin(e);return t-(0|t)},randomVector3OnDisc:function(e,t,i,r,o,n,a){"use strict";var s=6.2832*Math.random(),l=Math.abs(this.randomFloat(r,o)),c=0,h=0,u=0;a&&(l=Math.round(l/a)*a),c=Math.cos(s)*l,h=Math.sin(s)*l,c*=n.x,h*=n.y,c+=i.x,h+=i.y,u+=i.z,e.typedArray.setVec3Components(t,c,h,u)},randomDirectionVector3OnSphere:function(){"use strict";var l=new TONG.Vector3;return function(e,t,i,r,o,n,a,s){l.copy(n),l.x-=i,l.y-=r,l.z-=o,l.normalize().multiplyScalar(-this.randomFloat(a,s)),e.typedArray.setVec3Components(t,l.x,l.y,l.z)}}(),randomDirectionVector3OnDisc:function(){"use strict";var l=new TONG.Vector3;return function(e,t,i,r,o,n,a,s){l.copy(n),l.x-=i,l.y-=r,l.z-=o,l.normalize().multiplyScalar(-this.randomFloat(a,s)),e.typedArray.setVec3Components(t,l.x,l.y,0)}}(),getPackedRotationAxis:function(){"use strict";var i=new TONG.Vector3,r=new TONG.Vector3,o=new TONG.Color,n=new TONG.Vector3(1,1,1);return function(e,t){return i.copy(e).normalize(),r.copy(t).normalize(),i.x+=.5*-t.x+Math.random()*t.x,i.y+=.5*-t.y+Math.random()*t.y,i.z+=.5*-t.z+Math.random()*t.z,i.normalize().add(n).multiplyScalar(.5),o.setRGB(i.x,i.y,i.z),o.getHex()}}()},ParticleSystem.Group=function(e){"use strict";var t=ParticleSystem.utils,i=t.types;(e=t.ensureTypedArg(e,i.OBJECT,{})).texture=t.ensureTypedArg(e.texture,i.OBJECT,{}),this.uuid=TONG.Math.generateUUID(),this.fixedTimeStep=t.ensureTypedArg(e.fixedTimeStep,i.NUMBER,.016),this.texture=t.ensureInstanceOf(e.texture.value,TONG.Texture,null),this.textureFrames=t.ensureInstanceOf(e.texture.frames,TONG.Vector2,new TONG.Vector2(1,1)),this.textureFrameCount=t.ensureTypedArg(e.texture.frameCount,i.NUMBER,this.textureFrames.x*this.textureFrames.y),this.textureLoop=t.ensureTypedArg(e.texture.loop,i.NUMBER,1),this.textureFrames.max(new TONG.Vector2(1,1)),this.haParticleSystemrParticleSystemctive=t.ensureTypedArg(e.haParticleSystemrParticleSystemctive,i.BOOLEAN,!0),this.colorize=t.ensureTypedArg(e.colorize,i.BOOLEAN,!0),this.maxParticleCount=t.ensureTypedArg(e.maxParticleCount,i.NUMBER,null),this.blending=t.ensureTypedArg(e.blending,i.NUMBER,TONG.AdditiveBlending),this.transparent=t.ensureTypedArg(e.transparent,i.BOOLEAN,!0),this.alphaTest=parseFloat(t.ensureTypedArg(e.alphaTest,i.NUMBER,0)),this.depthWrite=t.ensureTypedArg(e.depthWrite,i.BOOLEAN,!1),this.depthTest=t.ensureTypedArg(e.depthTest,i.BOOLEAN,!0),this.fog=t.ensureTypedArg(e.fog,i.BOOLEAN,!0),this.scale=t.ensureTypedArg(e.scale,i.NUMBER,300),this.emitters=[],this.emitterIDs=[],this._pool=[],this._poolCreationSettings=null,this._createNewWhenPoolEmpty=0,this._attributesNeedRefresh=!1,this._attributesNeedDynamicReset=!1,this.particleCount=0,this.uniforms={texture:{type:"t",value:this.texture},textureAnimation:{type:"v4",value:new TONG.Vector4(this.textureFrames.x,this.textureFrames.y,this.textureFrameCount,Math.max(Math.abs(this.textureLoop),1))},fogColor:{type:"c",value:null},fogNear:{type:"f",value:10},fogFar:{type:"f",value:200},fogDensity:{type:"f",value:.5},deltaTime:{type:"f",value:0},runTime:{type:"f",value:0},scale:{type:"f",value:this.scale}},this.defines={HAS_PERParticleSystemCTIVE:this.haParticleSystemrParticleSystemctive,COLORIZE:this.colorize,VALUE_OVER_LIFETIME_LENGTH:ParticleSystem.valueOverLifetimeLength,SHOULD_ROTATE_TEXTURE:!1,SHOULD_ROTATE_PARTICLES:!1,SHOULD_WIGGLE_PARTICLES:!1,SHOULD_CALCULATE_SPRITE:1<this.textureFrames.x||1<this.textureFrames.y},this.attributes={position:new ParticleSystem.ShaderAttribute("v3",!0),acceleration:new ParticleSystem.ShaderAttribute("v4",!0),velocity:new ParticleSystem.ShaderAttribute("v3",!0),rotation:new ParticleSystem.ShaderAttribute("v4",!0),rotationCenter:new ParticleSystem.ShaderAttribute("v3",!0),params:new ParticleSystem.ShaderAttribute("v4",!0),size:new ParticleSystem.ShaderAttribute("v4",!0),angle:new ParticleSystem.ShaderAttribute("v4",!0),color:new ParticleSystem.ShaderAttribute("v4",!0),opacity:new ParticleSystem.ShaderAttribute("v4",!0)},this.attributeKeys=Object.keys(this.attributes),this.attributeCount=this.attributeKeys.length,this.material=new TONG.ShaderMaterial({uniforms:this.uniforms,vertexShader:ParticleSystem.shaders.vertex,fragmentShader:ParticleSystem.shaders.fragment,blending:this.blending,transparent:this.transparent,alphaTest:this.alphaTest,depthWrite:this.depthWrite,depthTest:this.depthTest,defines:this.defines,fog:this.fog}),this.geometry=new TONG.BufferGeometry,this.mesh=new TONG.Points(this.geometry,this.material),null===this.maxParticleCount&&console.warn("ParticleSystem.Group: No maxParticleCount ParticleSystemcified. Adding emitters after rendering will probably cause errors.")},ParticleSystem.Group.constructor=ParticleSystem.Group,ParticleSystem.Group.prototype._updateDefines=function(){"use strict";for(var e,t=this.emitters,i=t.length-1,r=this.defines;0<=i;--i)e=t[i],r.SHOULD_CALCULATE_SPRITE||(r.SHOULD_ROTATE_TEXTURE=r.SHOULD_ROTATE_TEXTURE||!!Math.max(Math.max.apply(null,e.angle.value),Math.max.apply(null,e.angle.spread))),r.SHOULD_ROTATE_PARTICLES=r.SHOULD_ROTATE_PARTICLES||!!Math.max(e.rotation.angle,e.rotation.angleSpread),r.SHOULD_WIGGLE_PARTICLES=r.SHOULD_WIGGLE_PARTICLES||!!Math.max(e.wiggle.value,e.wiggle.spread);this.material.needsUpdate=!0},ParticleSystem.Group.prototype._applyAttributesToGeometry=function(){"use strict";var e,t,i=this.attributes,r=this.geometry,o=r.attributes;for(var n in i)i.hasOwnProperty(n)&&(e=i[n],(t=o[n])?t.array=e.typedArray.array:r.addAttribute(n,e.bufferAttribute),e.bufferAttribute.needsUpdate=!0);this.geometry.setDrawRange(0,this.particleCount)},ParticleSystem.Group.prototype.addEmitter=function(e){"use strict";if(e instanceof ParticleSystem.Emitter!=0)if(-1<this.emitterIDs.indexOf(e.uuid))console.error("Emitter already exists in this group. Will not add again.");else{if(null===e.group){var t=this.attributes,i=this.particleCount,r=i+e.particleCount;for(var o in this.particleCount=r,null!==this.maxParticleCount&&this.particleCount>this.maxParticleCount&&console.warn("ParticleSystem.Group: maxParticleCount exceeded. Requesting",this.particleCount,"particles, can support only",this.maxParticleCount),e._calculatePPSValue(e.maxAge._value+e.maxAge._spread),e._setBufferUpdateRanges(this.attributeKeys),e._setAttributeOffset(i),e.group=this,e.attributes=this.attributes,t)t.hasOwnProperty(o)&&t[o]._createBufferAttribute(null!==this.maxParticleCount?this.maxParticleCount:this.particleCount);for(var n=i;n<r;++n)e._assignPositionValue(n),e._assignForceValue(n,"velocity"),e._assignForceValue(n,"acceleration"),e._assignAbsLifetimeValue(n,"opacity"),e._assignAbsLifetimeValue(n,"size"),e._assignAngleValue(n),e._assignRotationValue(n),e._assignParamsValue(n),e._assignColorValue(n);return this._applyAttributesToGeometry(),this.emitters.push(e),this.emitterIDs.push(e.uuid),this._updateDefines(e),this.material.needsUpdate=!0,this.geometry.needsUpdate=!0,this._attributesNeedRefresh=!0,this}console.error("Emitter already belongs to another group. Will not add to requested group.")}else console.error("`emitter` argument must be instance of ParticleSystem.Emitter. Was provided with:",e)},ParticleSystem.Group.prototype.removeEmitter=function(e){"use strict";var t=this.emitterIDs.indexOf(e.uuid);if(e instanceof ParticleSystem.Emitter!=0)if(-1!==t){for(var i=e.attributeOffset,r=i+e.particleCount,o=this.attributes.params.typedArray,n=i;n<r;++n)o.array[4*n]=0,o.array[4*n+1]=0;for(var a in this.emitters.splice(t,1),this.emitterIDs.splice(t,1),this.attributes)this.attributes.hasOwnProperty(a)&&this.attributes[a].splice(i,r);this.particleCount-=e.particleCount,e._onRemove(),this._attributesNeedRefresh=!0}else console.error("Emitter does not exist in this group. Will not remove.");else console.error("`emitter` argument must be instance of ParticleSystem.Emitter. Was provided with:",e)},ParticleSystem.Group.prototype.getFromPool=function(){"use strict";var e=this._pool,t=this._createNewWhenPoolEmpty;if(e.length)return e.pop();if(t){var i=new ParticleSystem.Emitter(this._poolCreationSettings);return this.addEmitter(i),i}return null},ParticleSystem.Group.prototype.releaseIntoPool=function(e){"use strict";return e instanceof ParticleSystem.Emitter==0?void console.error("Argument is not instanceof ParticleSystem.Emitter:",e):(e.reset(),this._pool.unshift(e),this)},ParticleSystem.Group.prototype.getPool=function(){"use strict";return this._pool},ParticleSystem.Group.prototype.addPool=function(e,t,i){"use strict";var r;this._poolCreationSettings=t,this._createNewWhenPoolEmpty=!!i;for(var o=0;o<e;++o)r=Array.isArray(t)?new ParticleSystem.Emitter(t[o]):new ParticleSystem.Emitter(t),this.addEmitter(r),this.releaseIntoPool(r);return this},ParticleSystem.Group.prototype._triggerSingleEmitter=function(e){"use strict";var t=this.getFromPool(),i=this;return null===t?void console.log("ParticleSystem.Group pool ran out."):(e instanceof TONG.Vector3&&(t.position.value.copy(e),t.position.value=t.position.value),t.enable(),setTimeout(function(){t.disable(),i.releaseIntoPool(t)},1e3*Math.max(t.duration,t.maxAge.value+t.maxAge.spread)),this)},ParticleSystem.Group.prototype.triggerPoolEmitter=function(e,t){"use strict";if("number"==typeof e&&1<e)for(var i=0;i<e;++i)this._triggerSingleEmitter(t);else this._triggerSingleEmitter(t);return this},ParticleSystem.Group.prototype._updateUniforms=function(e){"use strict";this.uniforms.runTime.value+=e,this.uniforms.deltaTime.value=e},ParticleSystem.Group.prototype._resetBufferRanges=function(){"use strict";for(var e=this.attributeKeys,t=this.attributeCount-1,i=this.attributes;0<=t;--t)i[e[t]].resetUpdateRange()},ParticleSystem.Group.prototype._updateBuffers=function(e){"use strict";for(var t,i,r,o=this.attributeKeys,n=this.attributeCount-1,a=this.attributes,s=e.bufferUpdateRanges;0<=n;--n)i=s[t=o[n]],(r=a[t]).setUpdateRange(i.min,i.max),r.flagUpdate()},ParticleSystem.Group.prototype.tick=function(e){"use strict";var t=this.emitters,i=t.length,r=e||this.fixedTimeStep,o=this.attributeKeys,n=this.attributes;if(this._updateUniforms(r),this._resetBufferRanges(),0!==i||!1!==this._attributesNeedRefresh||!1!==this._attributesNeedDynamicReset){for(var a,s=0;s<i;++s)(a=t[s]).tick(r),this._updateBuffers(a);if(!0===this._attributesNeedDynamicReset){for(s=this.attributeCount-1;0<=s;--s)n[o[s]].resetDynamic();this._attributesNeedDynamicReset=!1}if(!0===this._attributesNeedRefresh){for(s=this.attributeCount-1;0<=s;--s)n[o[s]].forceUpdateAll();this._attributesNeedRefresh=!1,this._attributesNeedDynamicReset=!0}}},ParticleSystem.Group.prototype.dispose=function(){"use strict";return this.geometry.dispose(),this.material.dispose(),this},ParticleSystem.Emitter=function(e){"use strict";var t=ParticleSystem.utils,i=t.types,r=ParticleSystem.valueOverLifetimeLength;for(var o in(e=t.ensureTypedArg(e,i.OBJECT,{})).position=t.ensureTypedArg(e.position,i.OBJECT,{}),e.velocity=t.ensureTypedArg(e.velocity,i.OBJECT,{}),e.acceleration=t.ensureTypedArg(e.acceleration,i.OBJECT,{}),e.radius=t.ensureTypedArg(e.radius,i.OBJECT,{}),e.drag=t.ensureTypedArg(e.drag,i.OBJECT,{}),e.rotation=t.ensureTypedArg(e.rotation,i.OBJECT,{}),e.color=t.ensureTypedArg(e.color,i.OBJECT,{}),e.opacity=t.ensureTypedArg(e.opacity,i.OBJECT,{}),e.size=t.ensureTypedArg(e.size,i.OBJECT,{}),e.angle=t.ensureTypedArg(e.angle,i.OBJECT,{}),e.wiggle=t.ensureTypedArg(e.wiggle,i.OBJECT,{}),e.maxAge=t.ensureTypedArg(e.maxAge,i.OBJECT,{}),e.onParticleSpawn&&console.warn("onParticleSpawn has been removed. Please set properties directly to alter values at runtime."),this.uuid=TONG.Math.generateUUID(),this.type=t.ensureTypedArg(e.type,i.NUMBER,ParticleSystem.distributions.BOX),this.position={_value:t.ensureInstanceOf(e.position.value,TONG.Vector3,new TONG.Vector3),_spread:t.ensureInstanceOf(e.position.spread,TONG.Vector3,new TONG.Vector3),_spreadClamp:t.ensureInstanceOf(e.position.spreadClamp,TONG.Vector3,new TONG.Vector3),_distribution:t.ensureTypedArg(e.position.distribution,i.NUMBER,this.type),_randomise:t.ensureTypedArg(e.position.randomise,i.BOOLEAN,!1),_radius:t.ensureTypedArg(e.position.radius,i.NUMBER,10),_radiusScale:t.ensureInstanceOf(e.position.radiusScale,TONG.Vector3,new TONG.Vector3(1,1,1)),_distributionClamp:t.ensureTypedArg(e.position.distributionClamp,i.NUMBER,0)},this.velocity={_value:t.ensureInstanceOf(e.velocity.value,TONG.Vector3,new TONG.Vector3),_spread:t.ensureInstanceOf(e.velocity.spread,TONG.Vector3,new TONG.Vector3),_distribution:t.ensureTypedArg(e.velocity.distribution,i.NUMBER,this.type),_randomise:t.ensureTypedArg(e.position.randomise,i.BOOLEAN,!1)},this.acceleration={_value:t.ensureInstanceOf(e.acceleration.value,TONG.Vector3,new TONG.Vector3),_spread:t.ensureInstanceOf(e.acceleration.spread,TONG.Vector3,new TONG.Vector3),_distribution:t.ensureTypedArg(e.acceleration.distribution,i.NUMBER,this.type),_randomise:t.ensureTypedArg(e.position.randomise,i.BOOLEAN,!1)},this.drag={_value:t.ensureTypedArg(e.drag.value,i.NUMBER,0),_spread:t.ensureTypedArg(e.drag.spread,i.NUMBER,0),_randomise:t.ensureTypedArg(e.position.randomise,i.BOOLEAN,!1)},this.wiggle={_value:t.ensureTypedArg(e.wiggle.value,i.NUMBER,0),_spread:t.ensureTypedArg(e.wiggle.spread,i.NUMBER,0)},this.rotation={_axis:t.ensureInstanceOf(e.rotation.axis,TONG.Vector3,new TONG.Vector3(0,1,0)),_axisSpread:t.ensureInstanceOf(e.rotation.axisSpread,TONG.Vector3,new TONG.Vector3),_angle:t.ensureTypedArg(e.rotation.angle,i.NUMBER,0),_angleSpread:t.ensureTypedArg(e.rotation.angleSpread,i.NUMBER,0),_static:t.ensureTypedArg(e.rotation.static,i.BOOLEAN,!1),_center:t.ensureInstanceOf(e.rotation.center,TONG.Vector3,this.position._value.clone()),_randomise:t.ensureTypedArg(e.position.randomise,i.BOOLEAN,!1)},this.maxAge={_value:t.ensureTypedArg(e.maxAge.value,i.NUMBER,2),_spread:t.ensureTypedArg(e.maxAge.spread,i.NUMBER,0)},this.color={_value:t.ensureArrayInstanceOf(e.color.value,TONG.Color,new TONG.Color),_spread:t.ensureArrayInstanceOf(e.color.spread,TONG.Vector3,new TONG.Vector3),_randomise:t.ensureTypedArg(e.position.randomise,i.BOOLEAN,!1)},this.opacity={_value:t.ensureArrayTypedArg(e.opacity.value,i.NUMBER,1),_spread:t.ensureArrayTypedArg(e.opacity.spread,i.NUMBER,0),_randomise:t.ensureTypedArg(e.position.randomise,i.BOOLEAN,!1)},this.size={_value:t.ensureArrayTypedArg(e.size.value,i.NUMBER,1),_spread:t.ensureArrayTypedArg(e.size.spread,i.NUMBER,0),_randomise:t.ensureTypedArg(e.position.randomise,i.BOOLEAN,!1)},this.angle={_value:t.ensureArrayTypedArg(e.angle.value,i.NUMBER,0),_spread:t.ensureArrayTypedArg(e.angle.spread,i.NUMBER,0),_randomise:t.ensureTypedArg(e.position.randomise,i.BOOLEAN,!1)},this.particleCount=t.ensureTypedArg(e.particleCount,i.NUMBER,100),this.duration=t.ensureTypedArg(e.duration,i.NUMBER,null),this.isStatic=t.ensureTypedArg(e.isStatic,i.BOOLEAN,!1),this.activeMultiplier=t.ensureTypedArg(e.activeMultiplier,i.NUMBER,1),this.direction=t.ensureTypedArg(e.direction,i.NUMBER,1),this.alive=t.ensureTypedArg(e.alive,i.BOOLEAN,!0),this.particleParticleSystemrSecond=0,this.activationIndex=0,this.attributeOffset=0,this.attributeEnd=0,this.age=0,this.activeParticleCount=0,this.group=null,this.attributes=null,this.paramsArray=null,this.resetFlags={position:t.ensureTypedArg(e.position.randomise,i.BOOLEAN,!1)||t.ensureTypedArg(e.radius.randomise,i.BOOLEAN,!1),velocity:t.ensureTypedArg(e.velocity.randomise,i.BOOLEAN,!1),acceleration:t.ensureTypedArg(e.acceleration.randomise,i.BOOLEAN,!1)||t.ensureTypedArg(e.drag.randomise,i.BOOLEAN,!1),rotation:t.ensureTypedArg(e.rotation.randomise,i.BOOLEAN,!1),rotationCenter:t.ensureTypedArg(e.rotation.randomise,i.BOOLEAN,!1),size:t.ensureTypedArg(e.size.randomise,i.BOOLEAN,!1),color:t.ensureTypedArg(e.color.randomise,i.BOOLEAN,!1),opacity:t.ensureTypedArg(e.opacity.randomise,i.BOOLEAN,!1),angle:t.ensureTypedArg(e.angle.randomise,i.BOOLEAN,!1)},this.updateFlags={},this.updateCounts={},this.updateMap={maxAge:"params",position:"position",velocity:"velocity",acceleration:"acceleration",drag:"acceleration",wiggle:"params",rotation:"rotation",size:"size",color:"color",opacity:"opacity",angle:"angle"},this.updateMap)this.updateMap.hasOwnProperty(o)&&(this.updateCounts[this.updateMap[o]]=0,this.updateFlags[this.updateMap[o]]=!1,this._createGetterSetters(this[o],o));this.bufferUpdateRanges={},this.attributeKeys=null,this.attributeCount=0,t.ensureValueOverLifetimeCompliance(this.color,r,r),t.ensureValueOverLifetimeCompliance(this.opacity,r,r),t.ensureValueOverLifetimeCompliance(this.size,r,r),t.ensureValueOverLifetimeCompliance(this.angle,r,r)},ParticleSystem.Emitter.constructor=ParticleSystem.Emitter,ParticleSystem.Emitter.prototype._createGetterSetters=function(e,n){"use strict";var a=this;for(var t in e)if(e.hasOwnProperty(t)){var i=t.replace("_","");Object.defineProperty(e,i,{get:function(e){return function(){return this[e]}}(t),set:function(o){return function(e){var t=a.updateMap[n],i=this[o],r=ParticleSystem.valueOverLifetimeLength;"_rotationCenter"===o?(a.updateFlags.rotationCenter=!0,a.updateCounts.rotationCenter=0):"_randomise"===o?a.resetFlags[t]=e:(a.updateFlags[t]=!0,a.updateCounts[t]=0),a.group._updateDefines(),this[o]=e,Array.isArray(i)&&ParticleSystem.utils.ensureValueOverLifetimeCompliance(a[n],r,r)}}(t)})}},ParticleSystem.Emitter.prototype._setBufferUpdateRanges=function(e){"use strict";this.attributeKeys=e,this.attributeCount=e.length;for(var t=this.attributeCount-1;0<=t;--t)this.bufferUpdateRanges[e[t]]={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY}},ParticleSystem.Emitter.prototype._calculatePPSValue=function(e){"use strict";var t=this.particleCount;this.duration?this.particleParticleSystemrSecond=t/(e<this.duration?e:this.duration):this.particleParticleSystemrSecond=t/e},ParticleSystem.Emitter.prototype._setAttributeOffset=function(e){this.attributeOffset=e,this.activationIndex=e,this.activationEnd=e+this.particleCount},ParticleSystem.Emitter.prototype._assignValue=function(e,t){"use strict";switch(e){case"position":this._assignPositionValue(t);break;case"velocity":case"acceleration":this._assignForceValue(t,e);break;case"size":case"opacity":this._assignAbsLifetimeValue(t,e);break;case"angle":this._assignAngleValue(t);break;case"params":this._assignParamsValue(t);break;case"rotation":this._assignRotationValue(t);break;case"color":this._assignColorValue(t)}},ParticleSystem.Emitter.prototype._assignPositionValue=function(e){"use strict";var t=ParticleSystem.distributions,i=ParticleSystem.utils,r=this.position,o=this.attributes.position,n=r._value,a=r._spread;switch(r._distribution){case t.BOX:i.randomVector3(o,e,n,a,r._spreadClamp);break;case t.SPHERE:i.randomVector3OnSphere(o,e,n,r._radius,r._spread.x,r._radiusScale,r._spreadClamp.x,r._distributionClamp||this.particleCount);break;case t.DISC:i.randomVector3OnDisc(o,e,n,r._radius,r._spread.x,r._radiusScale,r._spreadClamp.x)}},ParticleSystem.Emitter.prototype._assignForceValue=function(e,t){"use strict";var i,r,o,n,a,s=ParticleSystem.distributions,l=ParticleSystem.utils,c=this[t],h=c._value,u=c._spread;switch(c._distribution){case s.BOX:l.randomVector3(this.attributes[t],e,h,u);break;case s.SPHERE:r=(i=this.attributes.position.typedArray.array)[a=3*e],o=i[a+1],n=i[a+2],l.randomDirectionVector3OnSphere(this.attributes[t],e,r,o,n,this.position._value,c._value.x,c._spread.x);break;case s.DISC:r=(i=this.attributes.position.typedArray.array)[a=3*e],o=i[a+1],n=i[a+2],l.randomDirectionVector3OnDisc(this.attributes[t],e,r,o,n,this.position._value,c._value.x,c._spread.x)}if("acceleration"===t){var d=l.clamp(l.randomFloat(this.drag._value,this.drag._spread),0,1);this.attributes.acceleration.typedArray.array[4*e+3]=d}},ParticleSystem.Emitter.prototype._assignAbsLifetimeValue=function(e,t){"use strict";var i,r=this.attributes[t].typedArray,o=this[t],n=ParticleSystem.utils;n.arrayValuesAreEqual(o._value)&&n.arrayValuesAreEqual(o._spread)?(i=Math.abs(n.randomFloat(o._value[0],o._spread[0])),r.setVec4Components(e,i,i,i,i)):r.setVec4Components(e,Math.abs(n.randomFloat(o._value[0],o._spread[0])),Math.abs(n.randomFloat(o._value[1],o._spread[1])),Math.abs(n.randomFloat(o._value[2],o._spread[2])),Math.abs(n.randomFloat(o._value[3],o._spread[3])))},ParticleSystem.Emitter.prototype._assignAngleValue=function(e){"use strict";var t,i=this.attributes.angle.typedArray,r=this.angle,o=ParticleSystem.utils;o.arrayValuesAreEqual(r._value)&&o.arrayValuesAreEqual(r._spread)?(t=o.randomFloat(r._value[0],r._spread[0]),i.setVec4Components(e,t,t,t,t)):i.setVec4Components(e,o.randomFloat(r._value[0],r._spread[0]),o.randomFloat(r._value[1],r._spread[1]),o.randomFloat(r._value[2],r._spread[2]),o.randomFloat(r._value[3],r._spread[3]))},ParticleSystem.Emitter.prototype._assignParamsValue=function(e){"use strict";this.attributes.params.typedArray.setVec4Components(e,this.isStatic?1:0,0,Math.abs(ParticleSystem.utils.randomFloat(this.maxAge._value,this.maxAge._spread)),ParticleSystem.utils.randomFloat(this.wiggle._value,this.wiggle._spread))},ParticleSystem.Emitter.prototype._assignRotationValue=function(e){"use strict";this.attributes.rotation.typedArray.setVec3Components(e,ParticleSystem.utils.getPackedRotationAxis(this.rotation._axis,this.rotation._axisSpread),ParticleSystem.utils.randomFloat(this.rotation._angle,this.rotation._angleSpread),this.rotation._static?0:1),this.attributes.rotationCenter.typedArray.setVec3(e,this.rotation._center)},ParticleSystem.Emitter.prototype._assignColorValue=function(e){"use strict";ParticleSystem.utils.randomColorAsHex(this.attributes.color,e,this.color._value,this.color._spread)},ParticleSystem.Emitter.prototype._resetParticle=function(e){"use strict";for(var t,i,r=this.resetFlags,o=this.updateFlags,n=this.updateCounts,a=this.attributeKeys,s=this.attributeCount-1;0<=s;--s)i=o[t=a[s]],!0!==r[t]&&!0!==i||(this._assignValue(t,e),this._updateAttributeUpdateRange(t,e),!0===i&&n[t]===this.particleCount?(o[t]=!1,n[t]=0):1==i&&++n[t])},ParticleSystem.Emitter.prototype._updateAttributeUpdateRange=function(e,t){"use strict";var i=this.bufferUpdateRanges[e];i.min=Math.min(t,i.min),i.max=Math.max(t,i.max)},ParticleSystem.Emitter.prototype._resetBufferRanges=function(){"use strict";for(var e,t=this.bufferUpdateRanges,i=this.bufferUpdateKeys,r=this.bufferUpdateCount-1;0<=r;--r)t[e=i[r]].min=Number.POSITIVE_INFINITY,t[e].max=Number.NEGATIVE_INFINITY},ParticleSystem.Emitter.prototype._onRemove=function(){"use strict";this.particleParticleSystemrSecond=0,this.attributeOffset=0,this.activationIndex=0,this.activeParticleCount=0,this.group=null,this.attributes=null,this.paramsArray=null,this.age=0},ParticleSystem.Emitter.prototype._decrementParticleCount=function(){"use strict";--this.activeParticleCount},ParticleSystem.Emitter.prototype._incrementParticleCount=function(){"use strict";++this.activeParticleCount},ParticleSystem.Emitter.prototype._checkParticleAges=function(e,t,i,r){"use strict";for(var o,n,a,s,l=t-1;e<=l;--l)0!==(s=i[o=4*l])&&(a=i[o+1],n=i[o+2],1===this.direction?n<=(a+=r)&&(s=a=0,this._decrementParticleCount()):(a-=r)<=0&&(a=n,s=0,this._decrementParticleCount()),i[o]=s,i[o+1]=a,this._updateAttributeUpdateRange("params",l))},ParticleSystem.Emitter.prototype._activateParticles=function(e,t,i,r){"use strict";for(var o,n,a=this.direction,s=e;s<t;++s)0!=i[o=4*s]&&1!==this.particleCount||(this._incrementParticleCount(),i[o]=1,this._resetParticle(s),n=r*(s-e),i[o+1]=-1===a?i[o+2]-n:n,this._updateAttributeUpdateRange("params",s))},ParticleSystem.Emitter.prototype.tick=function(e){"use strict";if(!this.isStatic){null===this.paramsArray&&(this.paramsArray=this.attributes.params.typedArray.array);var t=this.attributeOffset,i=t+this.particleCount,r=this.paramsArray,o=this.particleParticleSystemrSecond*this.activeMultiplier*e,n=this.activationIndex;if(this._resetBufferRanges(),this._checkParticleAges(t,i,r,e),!1===this.alive)return void(this.age=0);if(null!==this.duration&&this.age>this.duration)return this.alive=!1,void(this.age=0);var a=1===this.particleCount?n:0|n,s=Math.min(a+o,this.activationEnd),l=s-this.activationIndex|0,c=0<l?e/l:0;this._activateParticles(a,s,r,c),this.activationIndex+=o,this.activationIndex>i&&(this.activationIndex=t),this.age+=e}},ParticleSystem.Emitter.prototype.reset=function(e){"use strict";if(this.age=0,!(this.alive=!1)===e){for(var t,i=this.attributeOffset,r=i+this.particleCount,o=this.paramsArray,n=this.attributes.params.bufferAttribute,a=r-1;i<=a;--a)o[t=4*a]=0,o[t+1]=0;n.updateRange.offset=0,n.updateRange.count=-1,n.needsUpdate=!0}return this},ParticleSystem.Emitter.prototype.enable=function(){"use strict";return this.alive=!0,this},ParticleSystem.Emitter.prototype.disable=function(){"use strict";return this.alive=!1,this},ParticleSystem.Emitter.prototype.remove=function(){"use strict";return null!==this.group?this.group.removeEmitter(this):console.error("Emitter does not belong to a group, cannot remove."),this};var ExtendClass=extendClass,English={Scenes:"Scenes","New Project":"New Project","Data From Server":"Data From Server","Add New Scene":"Add New Scene","Upload Project To Server":"Upload Project To Server","Build Current Project":"Build Current Project","New Tong Scene":"New Tong Scene",HIERARCHY:"HIERARCHY",Add:"Add",Duplicate:"Duplicate",Delete:"Delete",Menu:"Menu",Translate:"Translate",Rotation:"Rotation",Scale:"Scale",Local:"Local",World:"World",world:"world",Snap:"Snap",Focus:"Focus",Undo:"Undo",Redo:"Redo","Full Screen":"Full Screen",Play:"Play","Help you":"Help you",Settings:"Settings",Forum:"Forum",Control:"Control",User:"User",Inspector:"Inspector",Resources:"Resources",Assets:"Assets","Assets Store":"Assets Store",Profiling:"Profiling",Import:"Import",Default:"Default",Script:"Script","New Shader":"New Shader",ShaderCode:"ShaderCode","Create Pack":"Create Pack",Texture:"Texture",Mesh:"Mesh",Scene:"Scene",Material:"Material","New Material":"New Material",Animation:"Animation",Text:"Text",text:"text",Json:"Json",Pack:"Pack",Component:"Component",name:"name",isLoop:"isLoop",visible:"visible",position:"position",rotation:"rotation",scale:"scale",Entity:"Entity",Model:"Model",MaterialEditor:"MaterialEditor",GeometryEditor:"GeometryEditor",castShadow:"castShadow",receiveShadow:"receiveShadow",materials:"materials",Materials:"Materials",length:"length",type:"type","3DTextEditor":"3DTextEditor",RadiusTop:"RadiusTop",RadiusBottom:"RadiusBottom",Height:"Height",height:"height",RadialSegments:"RadialSegments",OpenEnded:"OpenEnded",Width:"Width",width:"width",Depth:"Depth",WidthSegments:"WidthSegments",HeightSegments:"HeightSegments",DepthSegments:"DepthSegments",PhiStart:"PhiStart",PhiLength:"PhiLength",ThetaStart:"ThetaStart",ThetaLength:"ThetaLength",TubularSegments:"TubularSegments",Tube:"Tube",Arc:"Arc",P:"P",Q:"Q",Segments:"Segments",Detail:"Detail",Radius:"Radius",radius:"radius",weight:"weight",friction:"friction",restitution:"restitution",isCollion:"isCollion",mass:"mass",useGravity:"useGravity",Gravity:"Gravity",intensity:"intensity",color:"color",Group:"Group",Plane:"Plane",Box:"Box",Circle:"Circle",Cylinder:"Cylinder",Sphere:"Sphere",Icosahedron:"Icosahedron",Torus:"Torus",TorusKnot:"TorusKnot",Lathe:"Lathe",Partical:"Partical",PointLight:"PointLight",SpotLight:"SpotLight",DirectionalLight:"DirectionalLight",HemisphereLight:"HemisphereLight",AmbientLight:"AmbientLight",PerspectiveCamera:"PerspectiveCamera",Camera:"Camera",viewport:"viewport",File:"File",New:"New","Export Geometry":"Export Geometry","Export Object":"Export Object","Export Scene":"Export Scene","Export OBJ":"Export OBJ","Export STL":"Export STL","Build Project":"Build Project","Clear History":"Clear History",clear:"clear",Clone:"Clone","Minify Shaders":"Minify Shaders",Help:"Help",Tutorial:"Tutorial",About:"About","Profile info":"Profile info",Parameter:"Parameter",Value:"Value","Frame CPU Time":"Frame CPU Time",Frames:"Frames","Draw Calls":"Draw Calls",Geometries:"Geometries",Faces:"Faces",Textures:"Textures",Points:"Points",objects:"objects",Objects:"Objects",vertices:"vertices",Vertices:"Vertices",triangles:"triangles","Splash Image":"Splash Image(Click on the change)","create new project":"create new project","rename project":"rename project","delete project":"delete project","":"",Flare:"Flare","Build Current Scene":"Build Current Scene",Open:"Open",Edit:"Edit",Stop:"Stop",Grid:"Grid","Create Folder":"Create Folder","Delete Folder":"Delete Folder",Rename:"Rename","Import Project":"Import Project",Properties:"Properties",Load:"Load",Refresh:"Refresh",Create:"Create",Folder:"Folder","New Tong Project":"New Tong Project","Select a file":"Select a file","Import from Harddrive":"Import from Harddrive","Import from URL":"Import from URL",Destination:"Destination","Save to folder":"Save to folder",Save:"Save","You can also drag files here directly":"You can also drag files here directly","File Information":"File Information",Filename:"Filename",Bytes:"Bytes",Type:"Type","ZIP FILE":"ZIP FILE","Optimize data":"Optimize data","Unknown resource":"Unknown resource",Channel:"Channel","Use node names to reference nodes":"Use node names to reference nodes","Import to Memory":"Import to Memory",Cancel:"Cancel","Import File":"Import File",wrapS:"wrapS",wrapT:"wrapT",minFilter:"minFilter",magFilter:"magFilter",Filter:"Filter",repeat:"repeat",offset:"offset",Transform:"Transform",far:"far",near:"near",fov:"fov",layers:"layers",filmOffset:"filmOffset",filmGauge:"filmGauge",zoom:"zoom",sunColor:"sunColor",moonColor:"moonColor",bottom:"bottom",left:"left",right:"right",top:"top",groundColor:"groundColor",distance:"distance",penumbra:"penumbra",angle:"angle",decay:"decay",shadow:"shadow",Shadow:"Shadow",Background:"Background",Fog:"Fog",FogNear:"FogNear",FogFar:"FogFar",FogDensity:"FogDensity",FogColor:"FogColor",AutoSave:"AutoSave",Antialia:"Antialia",GammaInput:"GammaInput",GammaOutput:"GammaOutput",VR:"VR",Renderer:"Renderer",Light:"Light",shader:"shader",Shader:"Shader",roughness:"roughness",metalness:"metalness",emissive:"emissive",specular:"specular",shininess:"shininess",clearCoat:"clearCoat",clearCoatRoughness:"clearCoatRoughness",vertexColors:"vertexColors",bumpScale:"bumpScale",normalScale:"normalScale",displacementScale:"displacementScale",displacementBias:"displacementBias",envMapIntensity:"envMapIntensity",lightMapIntensity:"lightMapIntensity",aoMapIntensity:"aoMapIntensity",side:"side",flatShading:"flatShading",blending:"blending",opacity:"opacity",transparent:"transparent",alphatest:"alphatest",wireframe:"wireframe",wireframeLinewidth:"wireframeLinewidth",linewidth:"linewidth",map:"map",alphaMap:"alphaMap",normalMap:"normalMap",bumpMap:"bumpMap",displacementMap:"displacementMap",roughnessMap:"roughnessMap",metalnessMap:"metalnessMap",specularMap:"specularMap",envMap:"envMap",lightMap:"lightMap",aoMap:"aoMap",emissiveMap:"emissiveMap",AudioPlayer:"AudioPlayer",Collider:"Collider",Joint:"Joint","Timeline Animation Editor":"Timeline Animation Editor",MoviePlayer:"MoviePlayer",Rigidbody:"Rigidbody","3D Text":"3D Text","New Script":"New Script",Template:"Template","New File":"New File","New Animation":"New Animation","Add Resource":"Add Resource","Shader Template":"Shader Template","Material Class":"Material Class",Action:"Action",MeshInfo:"MeshInfo",size:"size",Timeline:"Timeline",videoAsset:"videoAsset","Create keyframe for ":"Create keyframe for ","Add component":"Add component","Select Timeline Or Create":"Select Timeline Or Create","To add animation frames, select the timeline animation editor or create the animation file immediately?":"To add animation frames, select the timeline animation editor or create the animation file immediately?",OK:"OK",Keyframe:"Keyframe",interpolation:"interpolation",time:"time",sunDistance:"sunDistance",animationAsset:"animationAsset",thickness:"thickness",bevel:"bevel",bevelSize:"bevelSize",curve:"curve",input:"input",Console:"Console",particle:"particle",center:"center",isAutoPlay:"isAutoPlay",reversePlay:"reversePlay",mieDirectionalG:"mieDirectionalG",mieCoefficient:"mieCoefficient",luminance:"luminance",inclination:"inclination",azimuth:"azimuth",turbidity:"turbidity",rayleigh:"rayleigh",AudioInfo:"AudioInfo",volume:"volume",playbackRate:"playbackRate",startTime:"startTime",audioAsset:"audioAsset",urlPlay:"urlPlay",url:"url",alert:"alert",VideoInfo:"VideoInfo","The file is greater than 100M,Upload to server is recommended":"The file is greater than 100M,Upload to server is recommended",Close:"Close",Webcam:"Webcam",autoConnect:"autoConnect",facingMode:"facingMode",Components:"Components",Environment:"Environment",isKinematic:"isKinematic",SkinnedModel:"SkinnedModel",Constraint:"Constraint",linearDamping:"linearDamping",angularDamping:"angularDamping",connectBody:"connectBody",maxForce:"maxForce",pivotA:"pivotA",pivotB:"pivotB",axisA:"axisA",axisB:"axisB",OrthographicCamera:"OrthographicCamera",RenderTexture:"RenderTexture","New RenderTexture":"New RenderTexture",renderTexture:"renderTexture",FontInfo:"FontInfo",font:"font",fontAsset:"fontAsset",dashSize:"dashSize",gapSize:"gapSize",SkeletalAnimation:"SkeletalAnimation",SkeletalEditor:"SkeletalEditor",currentAnimation:"currentAnimation",FirstPersonControls:"FirstPersonControls",sensitivity:"sensitivity",needsButtonPressed:"needsButtonPressed",movementEnabled:"movementEnabled",moveSpeed:"moveSpeed",moveOnPlane:"moveOnPlane",OrbitControls:"OrbitControls",zoomEnabled:"zoomEnabled",maxDistance:"maxDistance",minDistance:"minDistance",zoomSensitivity:"zoomSensitivity",limitUp:"limitUp",limitDown:"limitDown",targetObject:"targetObject"},Chinese={targetObject:"目标物体",limitDown:"下限",limitUp:"上限",zoomSensitivity:"缩放灵敏度",minDistance:"最小距离",maxDistance:"最大距离",zoomEnabled:"缩放开启",OrbitControls:"轨道环绕控制器",moveOnPlane:"横向移动",moveSpeed:"移动速度",movementEnabled:"可移动",needsButtonPressed:"按下触发",sensitivity:"灵敏度",FirstPersonControls:"第一人称控制器",SkinnedModel:"蒙皮模型",reversePlay:"反向播放",currentAnimation:"当前动画",SkeletalAnimation:"骨骼动画",SkeletalEditor:"骨骼编辑",linewidth:"线框宽度",renderTexture:"渲染纹理","New RenderTexture":"新建渲染纹理",RenderTexture:"渲染纹理",viewport:"视口",Camera:"相机",OrthographicCamera:"2D相机",axisB:"旋转轴B",axisA:"旋转轴A",pivotB:"锚点B",pivotA:"锚点A",maxForce:"最大力",connectBody:"关联刚体",angularDamping:"角速度阻尼",linearDamping:"线性阻尼",Constraint:"约束",isKinematic:"运动遵循",Components:"组件列表",facingMode:"镜头",autoConnect:"自动连接",Webcam:"设备摄像头",url:"路径",gapSize:"间隙大小",urlPlay:"路径播放",audioAsset:"音频资源",startTime:"开始时间",playbackRate:"速率",volume:"音量",rayleigh:"散射强度",turbidity:"浑浊度",azimuth:"方位",isLoop:"循环",isAutoPlay:"自动播放","3DTextEditor":"3D文本编辑",curve:"曲线",animationAsset:"动画资源",sunDistance:"太阳高度",time:"时间",sunColor:"阳光颜色",moonColor:"月光颜色",interpolation:"插值",Keyframe:"关键帧",OK:"确定","Select Timeline Or Create":"选择动画编辑器","To add animation frames, select the timeline animation editor or create the animation file immediately?":"要添加动画帧,请选择相应的动画编辑器或是否立即创建动画文件?","Add component":"添加组件","New Animation":"新建动画",size:"尺寸",repeat:"重复",offset:"偏移",Environment:"环境",minFilter:"最小滤波",magFilter:"最大滤波",Filter:"过滤","Create keyframe for ":"创建动画帧",wrapT:"垂直包裹",wrapS:"水平包裹","Import File":"导入文件",Cancel:"取消",AudioInfo:"音频信息","Import to Memory":"导入","Use node names to reference nodes":"使用节点名来引用节点",Channel:"通道","Unknown resource":"未知资源","Optimize data":"数据优化","ZIP FILE":"Zip文件",Type:"类型",Bytes:"字节","Shader Template":"着色器模版",Filename:"文件名","Material Class":"材质类","File Information":"文件信息","You can also drag files here directly":"也可以直接拖动文件至该面板","Save to folder":"保存至",Save:"保存",Destination:"上传","Import from URL":"从路径引入","Import from Harddrive":"从本地选择","New Tong Project":"新项目",Folder:"文件夹",Create:"创建","New Material":"新建材质",Refresh:"刷新",Load:"加载",dashSize:"虚线大小",Properties:"属性","Delete Folder":"删除文件夹",Scenes:"场景","New Shader":"新建着色器","New Project":"新建工程","Data From Server":"服务器数据","Add New Scene":"新建场景","Upload Project To Server":"上传当前工程","Build Current Project":"发布当前项目","New Tong Scene":"新场景",HIERARCHY:"层级面板",Add:"新增",Duplicate:"复制",Delete:"删除",Menu:"菜单",Translate:"位移",Rotation:"旋转",Scale:"缩放",Local:"本地坐标",World:"世界坐标",world:"世界坐标",Snap:"吸附",Focus:"聚焦",Undo:"撤消",Redo:"重返","Full Screen":"全屏",Play:"测试","Help you":"帮助",Settings:"设置",Forum:"论坛",Control:"控制",User:"用户",Action:"执行","Add Resource":"新增资源",Inspector:"属性面板",Resources:"资源面板",Assets:"资源","Assets Store":"资源商店",Profiling:"分析面板",Import:"导入",Default:"默认",Script:"脚本",ShaderCode:"着色器",Texture:"图片",Mesh:"模型",MeshInfo:"网格信息",Scene:"场景",Material:"材质",Animation:"动画",Text:"文本",text:"文本",Json:"Json",Pack:"资源包",Component:"组件",name:"名称",visible:"显示",position:"位置",rotation:"旋转",scale:"缩放",Entity:"实体",Model:"模型",MaterialEditor:"材质编辑",GeometryEditor:"模型编辑",castShadow:"投影",mieDirectionalG:"光晕位置系数",mieCoefficient:"光晕强度",luminance:"亮度",receiveShadow:"接受投影",materials:"材质列表",Materials:"材质列表",length:"长度",type:"类型",RadiusTop:"顶部半径",RadiusBottom:"底部半径",Height:"高度",height:"高度",RadialSegments:"半径段数",OpenEnded:"可闭合",Width:"宽度",width:"宽度",Depth:"深度",WidthSegments:"宽度段数",HeightSegments:"高度段数",DepthSegments:"深度段数",PhiStart:"水平起始角",PhiLength:"水平有效角",ThetaStart:"垂直起始角",ThetaLength:"垂直有效角",TubularSegments:"管结构段数",Tube:"管状",thickness:"粗细",bevel:"倒角",bevelSize:"倒角尺寸",Arc:"弧度",P:"P",Q:"Q",Segments:"段数",Detail:"细节",Radius:"半径",radius:"半径",weight:"重量",friction:"摩擦力",restitution:"弹力系数",isCollion:"检测",mass:"质量",useGravity:"开启重力",Gravity:"重力",intensity:"光源强度",color:"颜色",Group:"组",Plane:"平面",Box:"立方体",Circle:"圆状",Cylinder:"圆柱",Sphere:"球体",Icosahedron:"二十面体",Torus:"圆环",TorusKnot:"环形节",Lathe:"二次模型",Partical:"粒子",PointLight:"点光源",SpotLight:"聚光灯",DirectionalLight:"太阳光",HemisphereLight:"半球光",AmbientLight:"环境光",PerspectiveCamera:"3D相机",File:"文件",New:"新建",FontInfo:"字体信息",font:"字体",fontAsset:"字体资源","Export Geometry":"导出几何数据","Export Object":"导出引擎对象","Export Scene":"导出场景","Export OBJ":"导出OBJ模型","Export STL":"导出STL模型","Build Project":"发布工程","Clear History":"清空历史",clear:"清空",Clone:"复制","Minify Shaders":"压缩shader代码",Help:"帮助",Tutorial:"教程",About:"关于","Profile info":"结果信息",Parameter:"参数",Value:"值","Timeline Animation Editor":"时间轴动画编辑器","Frame CPU Time":"CPU时间帧",Frames:"帧数","Draw Calls":"Draw Calls",Geometries:"几何数",Faces:"面数",Textures:"纹理数",Timeline:"时间轴动画",Points:"点数",objects:"对象数",Objects:"对象数",vertices:"顶点数",Vertices:"顶点数",triangles:"三角面数","Splash Image":"项目起始图像(点击更换)","create new project":"新建工程","rename project":"工程重命名","delete project":"删除工程","New File":"新建文件",Flare:"耀斑","Build Current Scene":"发布当前场景",Open:"打开",Edit:"编辑",Stop:"停止",Grid:"网格","Create Folder":"新建文件夹",Rename:"重命名","Import Project":"导入项目","Select a file":"选择文件",Transform:"变换",far:"远平面",near:"近平面",fov:"视场角",layers:"层级",filmOffset:"水平偏心距",filmGauge:"容量",zoom:"缩放",bottom:"底部",left:"左边",right:"右边",top:"上部",groundColor:"基色",distance:"距离",angle:"角度",penumbra:"灰度",decay:"衰减",shadow:"光影度",Shadow:"投影",Background:"背景色",Fog:"雾化",FogNear:"雾化起点",FogFar:"雾化终点",FogColor:"雾化颜色",FogDensity:"雾化浓度",AutoSave:"自动保存",Antialia:"抗锯齿",GammaInput:"灰度系数输入",GammaOutput:"灰度系数输出",VR:"VR",Renderer:"渲染类型",Light:"光源",shader:"着色器",Shader:"着色器",roughness:"细腻度",metalness:"金属质感",emissive:"散射",specular:"镜面反射",shininess:"亮度",clearCoat:"透明涂层",clearCoatRoughness:"涂层细腻度",vertexColors:"顶点颜色",bumpScale:"凹凸缩放",normalScale:"法线缩放",displacementScale:"置换缩放",displacementBias:"置换偏离",envMapIntensity:"环境贴图强度",lightMapIntensity:"光照贴图强度",aoMapIntensity:"遮蔽贴图强度",side:"显示面",flatShading:"平面着色",blending:"混合",opacity:"不透明度",transparent:"透明开启",alphatest:"透明度测试",wireframe:"线框开启",wireframeLinewidth:"线框粗细",map:"贴图",alphaMap:"透明贴图",normalMap:"法线贴图",bumpMap:"凹凸贴图",displacementMap:"置换贴图",roughnessMap:"粗糙贴图",metalnessMap:"金属贴图",specularMap:"镜面贴图",envMap:"环境贴图",lightMap:"光照贴图",aoMap:"AO贴图",emissiveMap:"散射贴图",AudioPlayer:"音频播放",Collider:"碰撞",Joint:"联结",MoviePlayer:"视频播放",Rigidbody:"刚体","3D Text":"3D文本","New Script":"新建脚本",Template:"模版","":"","Create Pack":"新建资源包",input:"输入",Console:"控制台",particle:"粒子",center:"中心",inclination:"上升位置",alert:"提示",Close:"关闭",VideoInfo:"视频信息","The file is greater than 100M,Upload to server is recommended":"该文件大小超过100M,建议上传至服务器",videoAsset:"视频资源"},Language={1:English,0:Chinese,current:0};function GetLanguage(e){var t=e.split("/");if(1==t.length)return Language[Language.current][e];for(var i="",r=0;r<t.length;r++)i+=GetLanguage(t[r]),r<t.length-1&&(i+="/");return i}Language.current=isChinese?0:1,TONG.ObjectLoader.prototype.parseImages=function(e,t){var i=this,r={};function o(e){return i.manager.itemStart(e),a.load(e,function(){i.manager.itemEnd(e)},void 0,function(){i.manager.itemEnd(e),i.manager.itemError(e)})}if(void 0!==e&&0<e.length){var n=new TONG.LoadingManager(t),a=new TONG.ImageLoader(n);a.setCrossOrigin(this.crossOrigin);for(var s=0,l=e.length;s<l;s++){var c=e[s],h=o(/^(\/\/)|([a-z]+:(\/\/)?)/i.test(c.url)?c.url:i.texturePath+c.url);h.uuid=c.uuid,r[c.uuid]=h}}return r},TONG.ObjectLoader.prototype.parseMaterials=function(e,t){var i={};if(void 0!==e){var r=new TONG.MaterialLoader;r.setTextures(t);for(var o=0,n=e.length;o<n;o++){var a=e[o];if("MultiMaterial"===a.type){for(var s=[],l=0;l<a.materials.length;l++){(c=TONG.RM.materials[a.materials[l].uuid])?s.push(c):s.push(r.parse(a.materials[l]))}i[a.uuid]=s}else{console.log(TONG.RM.materials),console.log(a.uuid),console.log(TONG.RM.materials[a.uuid]);var c=TONG.RM.materials[a.uuid];i[a.uuid]=c||r.parse(a)}}}return i},TONG.MaterialLoader.prototype.parse=function(json){if("NoneMaterial"==json.type){var noneMat=new TONG.NoneMaterial;return void 0!==json.uuid&&(noneMat.uuid=json.uuid),noneMat}var textures=this.textures;function getTexture(e){return void 0===textures[e]&&console.warn("TONG.MaterialLoader: Undefined texture",e),textures[e]}var material=eval("new TONG."+json.type);if(void 0!==json.uuid&&(material.uuid=json.uuid),void 0!==json.name&&(material.name=json.name),void 0!==json.color&&material.color.setHex(json.color),void 0!==json.roughness&&(material.roughness=json.roughness),void 0!==json.metalness&&(material.metalness=json.metalness),void 0!==json.emissive&&material.emissive.setHex(json.emissive),void 0!==json.specular&&material.specular.setHex(json.specular),void 0!==json.shininess&&(material.shininess=json.shininess),void 0!==json.clearCoat&&(material.clearCoat=json.clearCoat),void 0!==json.clearCoatRoughness&&(material.clearCoatRoughness=json.clearCoatRoughness),void 0!==json.uniforms&&(material.uniforms=json.uniforms),void 0!==json.vertexShader&&(material.vertexShader=json.vertexShader),void 0!==json.fragmentShader&&(material.fragmentShader=json.fragmentShader),void 0!==json.vertexColors&&(material.vertexColors=json.vertexColors),void 0!==json.fog&&(material.fog=json.fog),void 0!==json.flatShading&&(material.flatShading=json.flatShading),void 0!==json.blending&&(material.blending=json.blending),void 0!==json.side&&(material.side=json.side),void 0!==json.opacity&&(material.opacity=json.opacity),void 0!==json.transparent&&(material.transparent=json.transparent),void 0!==json.alphaTest&&(material.alphaTest=json.alphaTest),void 0!==json.depthTest&&(material.depthTest=json.depthTest),void 0!==json.depthWrite&&(material.depthWrite=json.depthWrite),void 0!==json.colorWrite&&(material.colorWrite=json.colorWrite),void 0!==json.wireframe&&(material.wireframe=json.wireframe),void 0!==json.wireframeLinewidth&&(material.wireframeLinewidth=json.wireframeLinewidth),void 0!==json.wireframeLinecap&&(material.wireframeLinecap=json.wireframeLinecap),void 0!==json.wireframeLinejoin&&(material.wireframeLinejoin=json.wireframeLinejoin),void 0!==json.rotation&&(material.rotation=json.rotation),1!==json.linewidth&&(material.linewidth=json.linewidth),void 0!==json.dashSize&&(material.dashSize=json.dashSize),void 0!==json.gapSize&&(material.gapSize=json.gapSize),void 0!==json.scale&&(material.scale=json.scale),void 0!==json.skinning&&(material.skinning=json.skinning),void 0!==json.morphTargets&&(material.morphTargets=json.morphTargets),void 0!==json.dithering&&(material.dithering=json.dithering),void 0!==json.visible&&(material.visible=json.visible),void 0!==json.userData&&(material.userData=json.userData),void 0!==json.shading&&(material.flatShading=1===json.shading),void 0!==json.size&&(material.size=json.size),void 0!==json.sizeAttenuation&&(material.sizeAttenuation=json.sizeAttenuation),void 0!==json.map&&(material.map=getTexture(json.map)),void 0!==json.alphaMap&&(material.alphaMap=getTexture(json.alphaMap),material.transparent=!0),void 0!==json.bumpMap&&(material.bumpMap=getTexture(json.bumpMap)),void 0!==json.bumpScale&&(material.bumpScale=json.bumpScale),void 0!==json.normalMap&&(material.normalMap=getTexture(json.normalMap)),void 0!==json.normalScale){var normalScale=json.normalScale;!1===Array.isArray(normalScale)&&(normalScale=[normalScale,normalScale]),material.normalScale=(new Vector2).fromArray(normalScale)}return void 0!==json.displacementMap&&(material.displacementMap=getTexture(json.displacementMap)),void 0!==json.displacementScale&&(material.displacementScale=json.displacementScale),void 0!==json.displacementBias&&(material.displacementBias=json.displacementBias),void 0!==json.roughnessMap&&(material.roughnessMap=getTexture(json.roughnessMap)),void 0!==json.metalnessMap&&(material.metalnessMap=getTexture(json.metalnessMap)),void 0!==json.emissiveMap&&(material.emissiveMap=getTexture(json.emissiveMap)),void 0!==json.emissiveIntensity&&(material.emissiveIntensity=json.emissiveIntensity),void 0!==json.specularMap&&(material.specularMap=getTexture(json.specularMap)),void 0!==json.envMap&&(material.envMap=getTexture(json.envMap)),void 0!==json.reflectivity&&(material.reflectivity=json.reflectivity),void 0!==json.lightMap&&(material.lightMap=getTexture(json.lightMap)),void 0!==json.lightMapIntensity&&(material.lightMapIntensity=json.lightMapIntensity),void 0!==json.aoMap&&(material.aoMap=getTexture(json.aoMap)),void 0!==json.aoMapIntensity&&(material.aoMapIntensity=json.aoMapIntensity),void 0!==json.gradientMap&&(material.gradientMap=getTexture(json.gradientMap)),material};"use strict";function ObjectIconHelper(e,t){var i=document.createElement("img"),r=new TONG.Texture(i);i.onload=function(){r.needsUpdate=!0},i.src=t,TONG.Sprite.call(this,new TONG.SpriteMaterial({map:r,transparent:!0,opacity:1,depthTest:!0,depthWrite:!0,color:16777215})),this.object=e,this.tempA=new TONG.Vector3,this.tempB=new TONG.Vector3,this.update()}function CameraHelper(e){var t=new TONG.BufferGeometry,i=new TONG.LineBasicMaterial({color:16777215,vertexColors:TONG.FaceColors}),r=[],o=[],n={},a=new TONG.Color(14540253),s=new TONG.Color(14540253);new TONG.Color(14540253);function l(e,t,i){c(e,i),c(t,i)}function c(e,t){r.push(0,0,0),o.push(t.r,t.g,t.b),void 0===n[e]&&(n[e]=[]),n[e].push(r.length/3-1)}l("n1","n2",a),l("n2","n4",a),l("n4","n3",a),l("n3","n1",a),l("f1","f2",a),l("f2","f4",a),l("f4","f3",a),l("f3","f1",a),l("n1","f1",a),l("n2","f2",a),l("n3","f3",a),l("n4","f4",a),l("p","n1",s),l("p","n2",s),l("p","n3",s),l("p","n4",s),t.addAttribute("position",new TONG.Float32BufferAttribute(r,3)),t.addAttribute("color",new TONG.Float32BufferAttribute(o,3)),TONG.LineSegments.call(this,t,i),this.camera=e,this.camera.updateProjectionMatrix&&this.camera.updateProjectionMatrix(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.pointMap=n,this.update()}function SkeletonHelper(e){for(var t=SkeletonHelper.getBoneList(e),i=new TONG.BufferGeometry,r=[],o=[],n=new TONG.Color(0,0,1),a=new TONG.Color(0,1,0),s=0;s<t.length;s++){var l=t[s];l.parent&&l.parent.isBone&&(r.push(0,0,0),r.push(0,0,0),o.push(n.r,n.g,n.b),o.push(a.r,a.g,a.b))}i.addAttribute("position",new TONG.Float32BufferAttribute(r,3)),i.addAttribute("color",new TONG.Float32BufferAttribute(o,3)),TONG.LineSegments.call(this,i,new TONG.LineBasicMaterial({vertexColors:TONG.VertexColors,depthTest:!1,depthWrite:!1,transparent:!1})),this.root=e,this.bones=t,this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.update()}function SkinnedMesh(e,t,i){TONG._SkinnedMesh.call(this,e,t,i),this.name="skinned",this.currentAnimation="",this.isLoop=!0,this.isAutoPlay=!0,this.reversePlay=!1,this.source=null,this.receiveShadow=!0,this.castShadow=!0}function LensFlare(){TONG.Mesh.call(this,TONG.Lensflare.Geometry,new TONG.MeshBasicMaterial({opacity:0,transparent:!0})),this.name="lensflare",this.type="LensFlare",this.renderOrder=1/0,this.frustumCulled=!1,this.receiveShadow=!1,this.castShadow=!1,this.elements=[];var p=new TONG.Vector3,m=new TONG.DataTexture(new Uint8Array(768),16,16,TONG.RGBFormat);m.minFilter=TONG.NearestFilter,m.magFilter=TONG.NearestFilter,m.wrapS=TONG.ClampToEdgeWrapping,m.wrapT=TONG.ClampToEdgeWrapping,m.needsUpdate=!0;var f=new TONG.DataTexture(new Uint8Array(768),16,16,TONG.RGBFormat);f.minFilter=TONG.NearestFilter,f.magFilter=TONG.NearestFilter,f.wrapS=TONG.ClampToEdgeWrapping,f.wrapT=TONG.ClampToEdgeWrapping,f.needsUpdate=!0;var v=TONG.Lensflare.Geometry,e=TONG.Lensflare.Shader,y=new TONG.RawShaderMaterial({uniforms:{scale:{value:null},screenPosition:{value:null}},vertexShader:["precision highp float;","uniform vec3 screenPosition;","uniform vec2 scale;","attribute vec3 position;","void main() {","\tgl_Position = vec4(position.xy * scale + screenPosition.xy, screenPosition.z, 1.0);","}"].join("\n"),fragmentShader:["precision highp float;","void main() {","\tgl_FragColor = vec4(1.0, 0.0, 1.0, 1.0);","}"].join("\n"),depthTest:!0,depthWrite:!1,transparent:!1}),g=new TONG.RawShaderMaterial({uniforms:{map:{value:m},scale:{value:null},screenPosition:{value:null}},vertexShader:["precision highp float;","uniform vec3 screenPosition;","uniform vec2 scale;","attribute vec3 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","\tvUV = uv;","\tgl_Position = vec4(position.xy * scale + screenPosition.xy, screenPosition.z, 1.0);","}"].join("\n"),fragmentShader:["precision highp float;","uniform sampler2D map;","varying vec2 vUV;","void main() {","\tgl_FragColor = texture2D(map, vUV);","}"].join("\n"),depthTest:!1,depthWrite:!1,transparent:!1}),x=new TONG.Mesh(v,y),w=(e=TONG.LensflareElement.Shader,new TONG.RawShaderMaterial({uniforms:{map:{value:null},occlusionMap:{value:f},color:{value:new TONG.Color(16777215)},scale:{value:new TONG.Vector2},screenPosition:{value:new TONG.Vector3}},vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,blending:TONG.AdditiveBlending,transparent:!0,depthWrite:!1})),b=new TONG.Mesh(v,w),T=new TONG.Vector2,S=new TONG.Vector2,C=new TONG.Box2,O=new TONG.Vector4;this.onBeforeRender=function(e,t,i){O.copy(e.getCurrentViewport());var r=O.w/O.z,o=O.z/2,n=O.w/2,a=16/O.w;if(T.set(a*r,a),C.min.set(O.x,O.y),C.max.set(O.x+(O.z-16),O.y+(O.w-16)),p.setFromMatrixPosition(this.matrixWorld),p.applyMatrix4(i.matrixWorldInverse),p.applyMatrix4(i.projectionMatrix),S.x=O.x+p.x*o+o-8,S.y=O.y+p.y*n+n-8,C.containsPoint(S)){e.copyFramebufferToTexture(S,m),(u=y.uniforms).scale.value=T,u.screenPosition.value=p,e.renderBufferDirect(i,null,v,y,x,null),e.copyFramebufferToTexture(S,f),(u=g.uniforms).scale.value=T,u.screenPosition.value=p,e.renderBufferDirect(i,null,v,g,x,null);for(var s=2*-p.x,l=2*-p.y,c=0,h=this.elements.length;c<h;c++){var u,d=this.elements[c];(u=w.uniforms).color.value.copy(d.color),u.map.value=d.texture,u.screenPosition.value.x=p.x+s*d.distance,u.screenPosition.value.y=p.y+l*d.distance;a=d.size/O.w,r=O.w/O.z;u.scale.value.set(a*r,a),w.uniformsNeedUpdate=!0,e.renderBufferDirect(i,null,v,w,b,null)}}},this.dispose=function(){y.dispose(),g.dispose(),w.dispose(),m.dispose(),f.dispose();for(var e=0,t=elements.length;e<t;e++)elements[e].texture.dispose()}}function AudioLoader(e){this.manager=void 0!==e?e:TONG.DefaultLoadingManager}function FontLoader(e){this.manager=void 0!==e?e:TONG.DefaultLoadingManager}function VideoLoader(e){this.manager=void 0!==e?e:TONG.DefaultLoadingManager}function MaterialLoader(e){this.manager=void 0!==e?e:TONG.DefaultLoadingManager,this.textures={}}function ObjectLoader(e){this.textures=null,this.fontAssets=null,this.animationClips=null,this.scene=null,TONG.ObjectLoader.call(this,e)}function ParticleEmitter(e,t){this.group=new ParticleSystem.Group(void 0!==e?e:ParticleEmitter.defaultGroup),this.emitter=new ParticleSystem.Emitter(void 0!==t?t:ParticleEmitter.defaultEmitter),this.group.addEmitter(this.emitter),TONG.Points.call(this,this.group.geometry,this.group.material),this.uuid=TONG.Math.generateUUID(),this.type="ParticleEmiter",this.name="particle",this.frustumCulled=!1,this.dynamicEmitter=!1;var i=this;Object.defineProperties(this,{texture:{get:function(){return i.group.texture},set:function(e){i.group.texture=e}}}),this.clock=new TONG.Clock}ObjectIconHelper.prototype=Object.create(TONG.Sprite.prototype),ObjectIconHelper.prototype.onBeforeRender=function(e,t,i,r,o,n){this.getWorldPosition(this.tempA),i.getWorldPosition(this.tempB);var a=this.tempA.distanceTo(this.tempB);this.material.opacity=a<=3?a/3:1},ObjectIconHelper.prototype.update=function(){this.object.getWorldPosition(this.position)},CameraHelper.prototype=Object.create(TONG.LineSegments.prototype),CameraHelper.prototype.constructor=CameraHelper,CameraHelper.prototype.update=function(){var l,c,h=new TONG.Vector3,u=new TONG.Camera;function e(e,t,i,r){h.set(t,i,r).unproject(u);var o=c[e];if(void 0!==o)for(var n=l.getAttribute("position"),a=0,s=o.length;a<s;a++)n.setXYZ(o[a],h.x,h.y,h.z)}return function(){l=this.geometry,c=this.pointMap;u.projectionMatrix.copy(this.camera.projectionMatrix),e("n1",-1,-1,-1),e("n2",1,-1,-1),e("n3",-1,1,-1),e("n4",1,1,-1),e("f1",-1,-1,1),e("f2",1,-1,1),e("f3",-1,1,1),e("f4",1,1,1),l.getAttribute("position").needsUpdate=!0}}(),SkeletonHelper.prototype=Object.create(TONG.LineSegments.prototype),SkeletonHelper.getBoneList=function(e){var t=[];e&&e.isBone&&t.push(e);for(var i=0;i<e.children.length;i++)t.push.apply(t,SkeletonHelper.getBoneList(e.children[i]));return t},SkeletonHelper.prototype.update=function(){var a=new TONG.Vector3,s=new TONG.Matrix4,l=new TONG.Matrix4;return function(){var e=this.bones,t=this.geometry,i=t.getAttribute("position");l.getInverse(this.root.matrixWorld);for(var r=0,o=0;r<e.length;r++){var n=e[r];n.parent&&n.parent.isBone&&(s.multiplyMatrices(l,n.matrixWorld),a.setFromMatrixPosition(s),i.setXYZ(o,a.x,a.y,a.z),s.multiplyMatrices(l,n.parent.matrixWorld),a.setFromMatrixPosition(s),i.setXYZ(o+1,a.x,a.y,a.z),o+=2)}t.getAttribute("position").needsUpdate=!0}}(),TONG.Lensflare=function(){TONG.Mesh.call(this,TONG.Lensflare.Geometry,new TONG.MeshBasicMaterial({opacity:0,transparent:!0})),this.type="Lensflare",this.frustumCulled=!1,this.renderOrder=1/0;var p=new TONG.Vector3,m=new TONG.DataTexture(new Uint8Array(768),16,16,TONG.RGBFormat);m.minFilter=TONG.NearestFilter,m.magFilter=TONG.NearestFilter,m.wrapS=TONG.ClampToEdgeWrapping,m.wrapT=TONG.ClampToEdgeWrapping,m.needsUpdate=!0;var f=new TONG.DataTexture(new Uint8Array(768),16,16,TONG.RGBFormat);f.minFilter=TONG.NearestFilter,f.magFilter=TONG.NearestFilter,f.wrapS=TONG.ClampToEdgeWrapping,f.wrapT=TONG.ClampToEdgeWrapping,f.needsUpdate=!0;var v=TONG.Lensflare.Geometry,y=new TONG.RawShaderMaterial({uniforms:{scale:{value:null},screenPosition:{value:null}},vertexShader:["precision highp float;","uniform vec3 screenPosition;","uniform vec2 scale;","attribute vec3 position;","void main() {","\tgl_Position = vec4( position.xy * scale + screenPosition.xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["precision highp float;","void main() {","\tgl_FragColor = vec4( 1.0, 0.0, 1.0, 1.0 );","}"].join("\n"),depthTest:!0,depthWrite:!1,transparent:!1}),g=new TONG.RawShaderMaterial({uniforms:{map:{value:m},scale:{value:null},screenPosition:{value:null}},vertexShader:["precision highp float;","uniform vec3 screenPosition;","uniform vec2 scale;","attribute vec3 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","\tvUV = uv;","\tgl_Position = vec4( position.xy * scale + screenPosition.xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["precision highp float;","uniform sampler2D map;","varying vec2 vUV;","void main() {","\tgl_FragColor = texture2D( map, vUV );","}"].join("\n"),depthTest:!1,depthWrite:!1,transparent:!1}),x=new TONG.Mesh(v,y),w=[],e=TONG.LensflareElement.Shader,b=new TONG.RawShaderMaterial({uniforms:{map:{value:null},occlusionMap:{value:f},color:{value:new TONG.Color(16777215)},scale:{value:new TONG.Vector2},screenPosition:{value:new TONG.Vector3}},vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,blending:TONG.AdditiveBlending,transparent:!0,depthWrite:!1}),T=new TONG.Mesh(v,b);this.addElement=function(e){w.push(e)};var S=new TONG.Vector2,C=new TONG.Vector2,O=new TONG.Box2,N=new TONG.Vector4;this.onBeforeRender=function(e,t,i){N.copy(e.getCurrentViewport());var r=N.w/N.z,o=N.z/2,n=N.w/2,a=16/N.w;if(S.set(a*r,a),O.min.set(N.x,N.y),O.max.set(N.x+(N.z-16),N.y+(N.w-16)),p.setFromMatrixPosition(this.matrixWorld),p.applyMatrix4(i.matrixWorldInverse),p.applyMatrix4(i.projectionMatrix),C.x=N.x+p.x*o+o-8,C.y=N.y+p.y*n+n-8,O.containsPoint(C)){e.copyFramebufferToTexture(C,m),(u=y.uniforms).scale.value=S,u.screenPosition.value=p,e.renderBufferDirect(i,null,v,y,x,null),e.copyFramebufferToTexture(C,f),(u=g.uniforms).scale.value=S,u.screenPosition.value=p,e.renderBufferDirect(i,null,v,g,x,null);for(var s=2*-p.x,l=2*-p.y,c=0,h=w.length;c<h;c++){var u,d=w[c];(u=b.uniforms).color.value.copy(d.color),u.map.value=d.texture,u.screenPosition.value.x=p.x+s*d.distance,u.screenPosition.value.y=p.y+l*d.distance;a=d.size/N.w,r=N.w/N.z;u.scale.value.set(a*r,a),b.uniformsNeedUpdate=!0,e.renderBufferDirect(i,null,v,b,T,null)}}},this.dispose=function(){y.dispose(),g.dispose(),b.dispose(),m.dispose(),f.dispose();for(var e=0,t=w.length;e<t;e++)w[e].texture.dispose()}},TONG.Lensflare.prototype=Object.create(TONG.Mesh.prototype),TONG.Lensflare.prototype.constructor=TONG.Lensflare,TONG.Lensflare.prototype.isLensflare=!0,TONG.LensflareElement=function(e,t,i,r){this.texture=e,this.size=t||1,this.distance=i||0,this.color=r||new TONG.Color(16777215)},TONG.LensflareElement.Shader={uniforms:{map:{value:null},occlusionMap:{value:null},color:{value:null},scale:{value:null},screenPosition:{value:null}},vertexShader:["precision highp float;","uniform vec3 screenPosition;","uniform vec2 scale;","uniform sampler2D occlusionMap;","attribute vec3 position;","attribute vec2 uv;","varying vec2 vUV;","varying float vVisibility;","void main() {","\tvUV = uv;","\tvec2 pos = position.xy;","\tvec4 visibility = texture2D( occlusionMap, vec2( 0.1, 0.1 ) );","\tvisibility += texture2D( occlusionMap, vec2( 0.5, 0.1 ) );","\tvisibility += texture2D( occlusionMap, vec2( 0.9, 0.1 ) );","\tvisibility += texture2D( occlusionMap, vec2( 0.9, 0.5 ) );","\tvisibility += texture2D( occlusionMap, vec2( 0.9, 0.9 ) );","\tvisibility += texture2D( occlusionMap, vec2( 0.5, 0.9 ) );","\tvisibility += texture2D( occlusionMap, vec2( 0.1, 0.9 ) );","\tvisibility += texture2D( occlusionMap, vec2( 0.1, 0.5 ) );","\tvisibility += texture2D( occlusionMap, vec2( 0.5, 0.5 ) );","\tvVisibility =        visibility.r / 9.0;","\tvVisibility *= 1.0 - visibility.g / 9.0;","\tvVisibility *=       visibility.b / 9.0;","\tgl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["precision highp float;","uniform sampler2D map;","uniform vec3 color;","varying vec2 vUV;","varying float vVisibility;","void main() {","\tvec4 texture = texture2D( map, vUV );","\ttexture.a *= vVisibility;","\tgl_FragColor = texture;","\tgl_FragColor.rgb *= color;","}"].join("\n")},TONG.Lensflare.Geometry=function(){var e=new TONG.BufferGeometry,t=new Float32Array([-1,-1,0,0,0,1,-1,0,1,0,1,1,0,1,1,-1,1,0,0,1]),i=new TONG.InterleavedBuffer(t,5);return e.setIndex([0,1,2,0,2,3]),e.addAttribute("position",new TONG.InterleavedBufferAttribute(i,3,0,!1)),e.addAttribute("uv",new TONG.InterleavedBufferAttribute(i,2,3,!1)),e}(),TONG.Object3D.prototype.clone=function(e){var t=(new this.constructor).copy(this,e);return this.animations&&(t.animations=this.animations),t},TONG.Object3D.prototype.toJSON=function(i){var e=void 0===i||"string"==typeof i,t={};e&&(i={geometries:{},materials:{},textures:{},images:{},shapes:{},files:{},scripts:{},packs:{},shaders:{},meshes:{},animations:{},audios:{},videos:{},rpics:{},fonts:{},skeletons:{},components:{}},t.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});var r={};function o(e,t){return void 0===e[t.uuid]&&(e[t.uuid]=t.toJSON?t.toJSON(i):t.serialize?t.serialize():t),t.uuid}if(r.uuid=this.uuid,r.type=this.type,""!==this.name&&(r.name=this.name),!0===this.castShadow&&(r.castShadow=!0),!0===this.receiveShadow&&(r.receiveShadow=!0),!1===this.visible&&(r.visible=!1),!1===this.frustumCulled&&(r.frustumCulled=!1),0!==this.renderOrder&&(r.renderOrder=this.renderOrder),"{}"!==JSON.stringify(this.userData)&&(r.userData=this.userData),r.layers=this.layers.mask,r.matrix=this.matrix.toArray(),!1===this.matrixAutoUpdate&&(r.matrixAutoUpdate=!1),(this.isMesh||this.isLine||this.isPoints)&&this.geometry){r.geometry=o(i.geometries,this.geometry);var n=this.geometry.parameters;if(void 0!==n&&void 0!==n.shapes){var a=n.shapes;if(Array.isArray(a))for(var s=0,l=a.length;s<l;s++){var c=a[s];o(i.shapes,c)}else o(i.shapes,a)}}if(void 0!==this.material)if(Array.isArray(this.material)){var h=[];for(s=0,l=this.material.length;s<l;s++)h.push(o(i.materials,this.material[s]));r.material=h}else r.material=o(i.materials,this.material);if(void 0!==this.animations&&0<this.animations.length){r.animations=[];for(s=0;s<this.animations.length;s++){var u=TONG.AnimationClip.toJSON(this.animations[s]);r.animations.push(o(i.animations,u))}}if(this.components&&0<this.components.length){var d=[];for(s=0;s<this.components.length;s++){var p=this.components[s];this.isRegisterComponent(p)||d.push(o(i.components,p))}r.components=d}if(0<this.children.length){r.children=[];for(s=0;s<this.children.length;s++)r.children.push(this.children[s].toJSON(i).object)}return e&&TONG.RM.serializeAllResource(i,t),t.object=r,t},TONG._SkinnedMesh=TONG.SkinnedMesh,TONG.SkinnedMesh=SkinnedMesh,SkinnedMesh.prototype=Object.create(TONG._SkinnedMesh.prototype),SkinnedMesh.prototype.dispose=function(){null!==this.material&&void 0!==this.material.dispose&&this.material.dispose(),null!==this.geometry&&this.geometry.dispose(),TONG.Object3D.prototype.dispose.call(this)},SkinnedMesh.prototype.clone=function(){var e=new TONG.SkinnedMesh(this.geometry,this.material);return e.copy(this),e.source=this.source,e.animations=this.animations,e},SkinnedMesh.prototype.toJSON=function(e){var t=this,i=TONG.Object3D.prototype.toJSON.call(this,e);return void 0!==t.skeleton&&(void 0===e.skeletons[t.skeleton.uuid]&&(e.skeletons[t.skeleton.uuid]=t.skeleton.toJSON()),i.object.skeleton=t.skeleton.uuid),void 0!==this.bindMode&&(i.object.bindMode=this.bindMode),void 0!==this.bindMatrix&&(i.object.bindMatrix=this.bindMatrix.toArray()),i.object.currentAnimation=this.currentAnimation,i.object.isLoop=this.isLoop,i.object.isAutoPlay=this.isAutoPlay,i.object.reversePlay=this.reversePlay,i.object.source=this.source?this.source.uuid:0,i},LensFlare.prototype=Object.create(TONG.Mesh.prototype),LensFlare.prototype.addFlare=function(e,t,i,r){void 0===t&&(t=-1),void 0===i&&(i=0),void 0===r&&(r=new TONG.Color(16777215)),i=Math.min(i,Math.max(0,i)),this.addElement(new TONG.LensflareElement(e,t,i,r))},LensFlare.prototype.addElement=function(e){this.elements.push(e)},LensFlare.prototype.toJSON=function(e){for(var t=this,i=[],r=TONG.Object3D.prototype.toJSON.call(this,e),o=0;o<t.elements.length;o++){var n={};n.texture=t.elements[o].texture.toJSON(e).uuid,n.size=t.elements[o].size,n.distance=t.elements[o].distance,n.color=t.elements[o].color.getHex(),i.push(n)}return r.object.elements=i,r},TONG.TTFLoader=function(e){this.manager=void 0!==e?e:TONG.DefaultLoadingManager,this.reversed=!1},TONG.TTFLoader.prototype.load=function(e,t,i,r){var o=this,n=new TONG.FileLoader(this.manager);n.setResponseType("arraybuffer"),n.load(e,function(e){void 0!==t&&t(o.parse(e))},i,r)},TONG.TTFLoader.prototype.parse=function(e){if("undefined"==typeof opentype)return console.warn("TTFLoader requires opentype.js Make sure it's included before using the loader"),null;function l(e){var t,i=[];e.forEach(function(e){"m"===e.type.toLowerCase()?(t=[e],i.push(t)):"z"!==e.type.toLowerCase()&&t.push(e)});var o=[];return i.forEach(function(e){var t={type:"m",x:e[e.length-1].x,y:e[e.length-1].y};o.push(t);for(var i=e.length-1;0<i;i--){var r=e[i];t={type:r.type};void 0!==r.x2&&void 0!==r.y2?(t.x1=r.x2,t.y1=r.y2,t.x2=r.x1,t.y2=r.y1):void 0!==r.x1&&void 0!==r.y1&&(t.x1=r.x1,t.y1=r.y1),t.x=e[i-1].x,t.y=e[i-1].y,o.push(t)}}),o}return function(e,t){for(var i=Math.round,r={},o=1e5/(72*(e.unitsPerEm||2048)),n=0;n<e.glyphs.length;n++){var a=e.glyphs.glyphs[n];if(void 0!==a.unicode){var s={ha:i(a.advanceWidth*o),x_min:i(a.xMin*o),x_max:i(a.xMax*o),o:""};t&&(a.path.commands=l(a.path.commands)),a.path.commands.forEach(function(e,t){"c"===e.type.toLowerCase()&&(e.type="b"),s.o+=e.type.toLowerCase()+" ",void 0!==e.x&&void 0!==e.y&&(s.o+=i(e.x*o)+" "+i(e.y*o)+" "),void 0!==e.x1&&void 0!==e.y1&&(s.o+=i(e.x1*o)+" "+i(e.y1*o)+" "),void 0!==e.x2&&void 0!==e.y2&&(s.o+=i(e.x2*o)+" "+i(e.y2*o)+" ")}),r[String.fromCharCode(a.unicode)]=s}}return{glyphs:r,familyName:e.familyName,ascender:i(e.ascender*o),descender:i(e.descender*o),underlinePosition:e.tables.post.underlinePosition,underlineThickness:e.tables.post.underlineThickness,boundingBox:{xMin:e.tables.head.xMin,xMax:e.tables.head.xMax,yMin:e.tables.head.yMin,yMax:e.tables.head.yMax},resolution:1e3,original_font_information:e.tables.name}}(opentype.parse(e),this.reversed)},AudioLoader.prototype.load=function(e,t,i,r){new TONG.FileLoader(this.manager).load(e,function(e){t(self.parse(JSON.parse(e)))},i,r)},AudioLoader.prototype.parse=function(e){var t=new Audio;return t.name=e.name,t.uuid=e.uuid,t.encoding=e.encoding,"base64"===e.format?(t.format="arraybuffer",t.data=ArraybufferUtils.fromBase64(e.data)):"arraybuffer"===e.format?(t.format=e.format,t.data=void 0!==e.data.toArrayBuffer?e.data.toArrayBuffer():e.data):(t.format=e.format,t.data=e.data),t},FontLoader.prototype.load=function(e,t,i,r){new TONG.FileLoader(this.manager).load(e,function(e){t(new Font(JSON.parse(e)))},i,r)},FontLoader.prototype.parse=function(e){if(void 0!==e.data){var t=new Font;return t.name=e.name,t.uuid=e.uuid,t.encoding=e.encoding,void 0!==e.reversed&&(t.reversed=e.reversed),"arraybuffer"===e.format?(t.format=e.format,t.data=void 0!==e.data.toArrayBuffer?e.data.toArrayBuffer():e.data,t.loadTTF()):"base64"===e.format?(t.format="arraybuffer",t.data=ArraybufferUtils.fromBase64(e.data),t.loadTTF()):(t.format=e.format,t.data=e.data,t.font=e.data),t}return new Font(e)},VideoLoader.prototype.load=function(e,t,i,r){var o=this;new TONG.FileLoader(this.manager).load(e,function(e){t(o.parse(JSON.parse(e)))},i,r)},VideoLoader.prototype.parse=function(e){var t=new Video(void 0!==e.data.toArrayBuffer?e.data.toArrayBuffer():e.data,e.encoding);return t.name=e.name,t.uuid=e.uuid,t},MaterialLoader.prototype.load=function(e,t,i,r){var o=this;new FileLoader(o.manager).load(e,function(e){t(o.parse(JSON.parse(e)))},i,r)},MaterialLoader.prototype.setTextures=function(e){this.textures=e},MaterialLoader.prototype.parse=function(json){var textures=this.textures;function getTexture(e){return void 0===textures[e]&&console.warn("TONG.MaterialLoader: Undefined texture",e),textures[e]}var material=eval("new TONG."+json.type);function applyTexture(e){var t=!1,i="";"string"==typeof e?i=e:(i=e.uuid,t=e.isTexture);var r=getTexture(i);return t&&(r.isApplyTexture=!0),r}if(void 0!==json.uuid&&(material.uuid=json.uuid),void 0!==json.name&&(material.name=json.name),void 0!==json.color&&(void 0===material.color&&(material.color=new TONG.Color),material.color.setHex(json.color)),void 0!==json.roughness&&(material.roughness=json.roughness),void 0!==json.metalness&&(material.metalness=json.metalness),void 0!==json.specular&&(void 0===material.specular&&(material.specular=new TONG.Color),material.specular.setHex(json.specular)),void 0!==json.shininess&&(material.shininess=json.shininess),void 0!==json.clearCoat&&(material.clearCoat=json.clearCoat),void 0!==json.clearCoatRoughness&&(material.clearCoatRoughness=json.clearCoatRoughness),void 0!==json.uniforms&&(material.uniforms=json.uniforms),void 0!==json.vertexShader&&(material.vertexShader=json.vertexShader),void 0!==json.fragmentShader&&(material.fragmentShader=json.fragmentShader),void 0!==json.vertexColors&&(material.vertexColors=json.vertexColors),void 0!==json.fog&&(material.fog=json.fog),void 0!==json.blending&&(material.blending=json.blending),void 0!==json.side&&(material.side=json.side),void 0!==json.shading&&(material.flatShading=1===json.shading),void 0!==json.flatShading&&(material.flatShading=json.flatShading),void 0!==json.rotation&&(material.rotation=json.rotation),void 0!==json.linewidth&&(material.linewidth=json.linewidth),void 0!==json.dashSize&&(material.dashSize=json.dashSize),void 0!==json.gapSize&&(material.gapSize=json.gapSize),void 0!==json.scale&&(material.scale=json.scale),void 0!==json.opacity&&(material.opacity=json.opacity),void 0!==json.transparent&&(material.transparent=json.transparent),void 0!==json.alphaTest&&(material.alphaTest=json.alphaTest),void 0!==json.depthTest&&(material.depthTest=json.depthTest),void 0!==json.depthWrite&&(material.depthWrite=json.depthWrite),void 0!==json.colorWrite&&(material.colorWrite=json.colorWrite),void 0!==json.wireframe&&(material.wireframe=json.wireframe),void 0!==json.wireframeLinewidth&&(material.wireframeLinewidth=json.wireframeLinewidth),void 0!==json.wireframeLinecap&&(material.wireframeLinecap=json.wireframeLinecap),void 0!==json.wireframeLinejoin&&(material.wireframeLinejoin=json.wireframeLinejoin),void 0!==json.morphTargets&&(material.morphTargets=json.morphTargets),void 0!==json.morphNormals&&(material.morphNormals=json.morphNormals),void 0!==json.dithering&&(material.dithering=json.dithering),void 0!==json.visible&&(material.visible=json.visible),void 0!==json.userData&&(material.userData=json.userData),void 0!==json.skinning&&(material.skinning=json.skinning),void 0!==json.size&&(material.size=json.size),void 0!==json.sizeAttenuation&&(material.sizeAttenuation=json.sizeAttenuation),void 0!==json.map&&(material.map=applyTexture(json.map)),void 0!==json.alphaMap&&(material.alphaMap=applyTexture(json.alphaMap),material.transparent=!0),void 0!==json.bumpMap&&(material.bumpMap=applyTexture(json.bumpMap)),void 0!==json.bumpScale&&(material.bumpScale=json.bumpScale),void 0!==json.normalMap&&(material.normalMap=applyTexture(json.normalMap)),void 0!==json.normalScale){var normalScale=json.normalScale;!1===Array.isArray(normalScale)&&(normalScale=[normalScale,normalScale]),material.normalScale=(new TONG.Vector2).fromArray(normalScale)}if(void 0!==json.displacementMap&&(material.displacementMap=applyTexture(json.displacementMap)),void 0!==json.displacementScale&&(material.displacementScale=json.displacementScale),void 0!==json.displacementBias&&(material.displacementBias=json.displacementBias),void 0!==json.roughnessMap&&(material.roughnessMap=applyTexture(json.roughnessMap)),void 0!==json.metalnessMap&&(material.metalnessMap=applyTexture(json.metalnessMap)),void 0!==json.emissiveMap&&(material.emissiveMap=applyTexture(json.emissiveMap)),void 0!==json.emissive&&(void 0===material.emissive&&(material.emissive=new TONG.Color),material.emissive.setHex(json.emissive)),void 0!==json.emissiveIntensity&&(material.emissiveIntensity=json.emissiveIntensity),void 0!==json.specularMap&&(material.specularMap=applyTexture(json.specularMap)),void 0!==json.envMap&&(material.envMap=applyTexture(json.envMap)),void 0!==json.reflectivity&&(material.reflectivity=json.reflectivity),void 0!==json.envMapIntensity&&(material.envMapIntensity=json.envMapIntensity),void 0!==json.combine&&(material.combine=json.combine),void 0!==json.refractionRatio&&(material.refractionRatio=json.refractionRatio),void 0!==json.lightMap&&(material.lightMap=applyTexture(json.lightMap)),void 0!==json.lightMapIntensity&&(material.lightMapIntensity=json.lightMapIntensity),void 0!==json.aoMap&&(material.aoMap=applyTexture(json.aoMap)),void 0!==json.aoMapIntensity&&(material.aoMapIntensity=json.aoMapIntensity),void 0!==json.gradientMap&&(material.gradientMap=applyTexture(json.gradientMap)),void 0!==json.materials)for(var i=0,l=json.materials.length;i<l;i++)material.materials.push(this.parse(json.materials[i]));return material},ObjectLoader.prototype=Object.create(TONG.ObjectLoader.prototype),ObjectLoader.prototype.constructor=ObjectLoader,ObjectLoader.prototype.parseSkeletons=function(e,t){var i={};if(void 0===e)return i;for(var r=0;r<e.length;r++){for(var o=e[r],n=o.uuid,a=o.bones,s=o.boneInverses,l=[],c=[],h=0,u=a.length;h<u;h++){var d=t.getObjectByProperty("uuid",a[h]);void 0===d&&(console.warn("TONG.ObjectLoader: Not found Bone whose uuid is "+a[h]),d=new TONG.Bone),l.push(d),c.push((new TONG.Matrix4).fromArray(s[h]))}i[n]=new Skeleton(l,c)}return i},ObjectLoader.prototype.bindSkeletons=function(e,i){0!==Object.keys(i).length&&e.traverse(function(e){if(!0===e.isSkinnedMesh&&void 0!==e.skeletonUUID){var t=i[e.skeletonUUID];void 0===t?console.warn("TONG.ObjectLoader: Not found Skeleton whose uuid is "+e.skeletonUUID):e.bind(t,e.bindMatrix),delete e.skeletonUUID}})},ObjectLoader.prototype.parseObject=function(e,t,n,i,r,o){var a,s,l,c=this;function h(e){return void 0===c.textures[e]&&console.warn("ObjectLoader: Undefined texture",e),c.textures[e]}function u(e){return void 0===t[e]&&console.warn("TONG.ObjectLoader: Undefined geometry",e),t[e]}function d(e){if(void 0!==e){if(Array.isArray(e)){for(var t=[],i=0,r=e.length;i<r;i++){var o=e[i];void 0===n[o]&&console.warn("TONG.ObjectLoader: Undefined material",o),t.push(n[o])}return t}return void 0===n[e]&&console.warn("TONG.ObjectLoader: Undefined material",e),n[e]}}switch(i&&(c.textures=i),r&&(c.fontAssets=r),o&&(c.animationClips=o),e.type){case"Scene":a=new Scene,c.scene=a,void 0!==e.background&&Number.isInteger(e.background)&&(a.background=new TONG.Color(e.background)),void 0!==e.fog&&("Fog"===e.fog.type?a.fog=new TONG.Fog(e.fog.color,e.fog.near,e.fog.far):"FogExp2"===e.fog.type&&(a.fog=new TONG.FogExp2(e.fog.color,e.fog.density))),void 0!==e.cameras&&(a.cameras=e.cameras),void 0!==e.usePhysics&&(a.usePhysics=e.usePhysics),void 0!==e.world&&(a.world.gravity.set(e.world.gravity.x,e.world.gravity.y,e.world.gravity.z),a.world.quatNormalizeSkip=e.world.quatNormalizeSkip,a.world.quatNormalizeFast=e.world.quatNormalizeFast,a.world.solver.tolerance=e.world.solver.tolerance,a.world.solver.iterations=e.world.solver.iterations);break;case"Physics":(a=new PhysicsObject).body.type=e.body.type,a.body.mass=e.body.mass,a.body.linearDamping=e.body.linearDamping,a.body.angularDamping=e.body.angularDamping,a.body.allowSleep=e.body.allowSleep,a.body.sleepSpeedLimit=e.body.sleepSpeedLimit,a.body.sleepTimeLimit=e.body.sleepTimeLimit,a.body.collisionFilterGroup=e.body.collisionFilterGroup,a.body.collisionFilterMask=e.body.collisionFilterMask,a.body.fixedRotation=e.body.fixedRotation;for(var p=e.body.shapes,m=0;m<p.length;m++){var f=p[m];f.type===CANNON.Shape.types.SPHERE?a.body.addShape(new CANNON.Sphere(f.radius)):f.type===CANNON.Shape.types.BOX?a.body.addShape(new CANNON.Box(new CANNON.Vec3(f.halfExtents.x,f.halfExtents.y,f.halfExtents.z))):f.type===CANNON.Shape.types.PARTICLE?a.body.addShape(new CANNON.Particle):f.type===CANNON.Shape.types.PLANE?a.body.addShape(new CANNON.Plane):f.type===CANNON.Shape.types.CONVEXPOLYHEDRON&&a.body.addShape(new CANNON.ConvexPolyhedron(f.vertices,f.faces))}break;case"PerspectiveCamera":a=new PerspectiveCamera(e.fov,e.aspect,e.near,e.far),void 0!==e.focus&&(a.focus=e.focus),void 0!==e.zoom&&(a.zoom=e.zoom),void 0!==e.filmGauge&&(a.filmGauge=e.filmGauge),void 0!==e.filmOffset&&(a.filmOffset=e.filmOffset),void 0!==e.view&&(a.view=Object.assign({},e.view)),void 0!==e.viewport&&a.viewport.fromArray(e.viewport),void 0!==e.offset&&a.offset.fromArray(e.offset),void 0!==e.clearColor&&(a.clearColor=e.clearColor),void 0!==e.clearDepth&&(a.clearDepth=e.clearDepth),void 0!==e.clearStencil&&(a.clearStencil=e.clearStencil),void 0!==e.order&&(a.order=e.order),void 0!==e.composer&&(a.composer=EffectComposer.fromJSON(e.composer)),e.renderTexture&&(a.renderTexture=h(e.renderTexture)),c.scene&&c.scene.addCamera(a);break;case"OrthographicCamera":a=new OrthographicCamera(e.size,e.aspect,e.mode,e.near,e.far),void 0!==e.viewport&&a.viewport.fromArray(e.viewport),void 0!==e.offset&&a.offset.fromArray(e.offset),void 0!==e.clearColor&&(a.clearColor=e.clearColor),void 0!==e.clearDepth&&(a.clearDepth=e.clearDepth),void 0!==e.clearStencil&&(a.clearStencil=e.clearStencil),void 0!==e.order&&(a.order=e.order),void 0!==e.composer&&(a.composer=EffectComposer.fromJSON(e.composer)),void 0!==e.zoom&&(a.zoom=e.zoom),void 0!==e.view&&(a.view=Object.assign({},e.view)),c.scene&&c.scene.addCamera(a);break;case"AmbientLight":a=new TONG.AmbientLight(e.color,e.intensity);break;case"DirectionalLight":a=new TONG.DirectionalLight(e.color,e.intensity);break;case"PointLight":a=new TONG.PointLight(e.color,e.intensity,e.distance,e.decay);break;case"RectAreaLight":a=new TONG.RectAreaLight(e.color,e.intensity,e.width,e.height);break;case"SpotLight":a=new TONG.SpotLight(e.color,e.intensity,e.distance,e.angle,e.penumbra,e.decay);break;case"HemisphereLight":a=new TONG.HemisphereLight(e.color,e.groundColor,e.intensity);break;case"SkinnedMesh":var v,y=u(e.geometry),g=d(e.material);void 0!==e.skeleton&&void 0!==y.bones&&(v=y.bones,y.bones=void 0),a=new SkinnedMesh(y,g),void 0!==e.skeleton&&(a.skeletonUUID=e.skeleton),void 0!==e.bindMode&&(a.bindMode=e.bindMode),void 0!==e.bindMatrix&&a.bindMatrix.fromArray(e.bindMatrix),a.currentAnimation=e.currentAnimation,a.isAutoPlay=e.isAutoPlay,a.isLoop=e.isLoop,a.reversePlay=e.reversePlay,a.updateMatrixWorld(!0),void 0!==v&&(y.bones=v);break;case"Sky":(a=new TONG.Sky).distance=e.distance,a.inclination=e.inclination,a.azimuth=e.azimuth,a.turbidity=e.turbidity,a.rayleigh=e.rayleigh,a.luminance=e.luminance,a.mieCoefficient=e.mieCoefficient,a.mieDirectionalG=e.mieDirectionalG,a.sun.castShadow=e.castShadow,a.sun.intensity=e.intensity,a.updateSky();break;case"LensFlare":a=new LensFlare,void 0!==e.lensFlares&&(e.elements=e.lensFlares);for(m=0;m<e.elements.length;m++)a.addFlare(h(e.elements[m].texture),e.elements[m].size,e.elements[m].distance,new TONG.Color(e.elements[m].color));break;case"Text3D":window.DefaultFont||(window.DefaultFont=new TONG.Font("default.json"));var x=window.DefaultFont;a=new Text3D(e.text,d(e.material),0==e.font?x:(s=e.font,void 0===c.fontAssets[s]&&console.warn("ObjectLoader: Undefined fontAssets",s),c.fontAssets[s]),e.height,e.bevel,e.bevelThickness,e.bevelSize,e.size,e.curveSegments);break;case"Mesh":y=u(e.geometry),g=d(e.material);a=y.bones&&0<y.bones.length?new TONG.SkinnedMesh(y,g):new TONG.Mesh(y,g);break;case"LOD":a=new TONG.LOD;break;case"Line":a=new TONG.Line(u(e.geometry),d(e.material),e.mode);break;case"LineLoop":a=new TONG.LineLoop(u(e.geometry),d(e.material));break;case"LineSegments":a=new TONG.LineSegments(u(e.geometry),d(e.material));break;case"PointCloud":case"Points":a=new TONG.Points(u(e.geometry),d(e.material));break;case"Sprite":a=new TONG.Sprite(d(e.material));break;case"Group":a=new TONG.Group;break;default:a=new TONG.Object3D}if(a.uuid=e.uuid,void 0!==e.name&&(a.name=e.name),void 0!==e.animations){a.animations=[];for(m=0;m<e.animations.length;m++){var w=(l=e.animations[m],null==c.animationClips[l]&&console.warn("ObjectLoader: Undefined animationClip",l),c.animationClips[l]);w&&a.animations.push(w)}}if(void 0!==e.matrix?(a.matrix.fromArray(e.matrix),void 0!==e.matrixAutoUpdate&&(a.matrixAutoUpdate=e.matrixAutoUpdate),a.matrixAutoUpdate&&a.matrix.decompose(a.position,a.quaternion,a.scale)):(void 0!==e.position&&a.position.fromArray(e.position),void 0!==e.rotation&&a.rotation.fromArray(e.rotation),void 0!==e.quaternion&&a.quaternion.fromArray(e.quaternion),void 0!==e.scale&&a.scale.fromArray(e.scale)),void 0!==e.castShadow&&(a.castShadow=e.castShadow),void 0!==e.receiveShadow&&(a.receiveShadow=e.receiveShadow),e.shadow&&(void 0!==e.shadow.bias&&(a.shadow.bias=e.shadow.bias),void 0!==e.shadow.radius&&(a.shadow.radius=e.shadow.radius),void 0!==e.shadow.mapSize&&a.shadow.mapSize.fromArray(e.shadow.mapSize),void 0!==e.shadow.camera&&(a.shadow.camera=this.parseObject(e.shadow.camera))),void 0!==e.visible&&(a.visible=e.visible),void 0!==e.frustumCulled&&(a.frustumCulled=e.frustumCulled),void 0!==e.renderOrder&&(a.renderOrder=e.renderOrder),void 0!==e.userData&&(a.userData=e.userData),void 0!==e.layers&&(a.layers.mask=e.layers),void 0!==e.children){var b=e.children;for(m=0;m<b.length;m++){var T=this.parseObject(b[m],t,n);a.add(T)}}if("Scene"===e.type);else if("LOD"===e.type)for(var S=e.levels,C=0;C<S.length;C++){var O=S[C],N=a.getObjectByProperty("uuid",O.object);void 0!==N&&a.addLevel(N,O.distance)}return a},ObjectLoader.prototype.parseBackupObject=function(i,t,n,e){var r,o,a=this;function s(e){return void 0===t[e]&&console.warn("TONG.ObjectLoader: Undefined geometry",e),t[e]}function l(e){if(void 0!==e){if(Array.isArray(e)){for(var t=[],i=0,r=e.length;i<r;i++){var o=e[i];void 0===n[o]&&console.warn("TONG.ObjectLoader: Undefined material",o),t.push(n[o])}return t}return void 0===n[e]&&console.warn("TONG.ObjectLoader: Undefined material",e),n[e]}}switch(e&&(a.textures=e),i.type){case"Scene":r=new TONG.Scene,void 0!==i.background&&Number.isInteger(i.background)&&(r.background=new TONG.Color(i.background)),void 0!==i.fog&&("Fog"===i.fog.type?r.fog=new TONG.Fog(i.fog.color,i.fog.near,i.fog.far):"FogExp2"===i.fog.type&&(r.fog=new TONG.FogExp2(i.fog.color,i.fog.density)));break;case"PerspectiveCamera":r=new TONG.PerspectiveCamera(i.fov,i.aspect,i.near,i.far),void 0!==i.focus&&(r.focus=i.focus),void 0!==i.zoom&&(r.zoom=i.zoom),void 0!==i.filmGauge&&(r.filmGauge=i.filmGauge),void 0!==i.filmOffset&&(r.filmOffset=i.filmOffset),void 0!==i.view&&(r.view=Object.assign({},i.view));break;case"OrthographicCamera":r=new TONG.OrthographicCamera(i.left,i.right,i.top,i.bottom,i.near,i.far),void 0!==i.zoom&&(r.zoom=i.zoom),void 0!==i.view&&(r.view=Object.assign({},i.view));break;case"AmbientLight":r=new TONG.AmbientLight(i.color,i.intensity);break;case"DirectionalLight":r=new TONG.DirectionalLight(i.color,i.intensity);break;case"PointLight":r=new TONG.PointLight(i.color,i.intensity,i.distance,i.decay);break;case"RectAreaLight":r=new TONG.RectAreaLight(i.color,i.intensity,i.width,i.height);break;case"SpotLight":r=new TONG.SpotLight(i.color,i.intensity,i.distance,i.angle,i.penumbra,i.decay);break;case"HemisphereLight":r=new TONG.HemisphereLight(i.color,i.groundColor,i.intensity);break;case"SkinnedMesh":var c,h=s(i.geometry),u=l(i.material);void 0!==i.skeleton&&void 0!==h.bones&&(c=h.bones,h.bones=void 0),r=new SkinnedMesh(h,u),void 0!==i.skeleton&&(r.skeletonUUID=i.skeleton),void 0!==i.bindMode&&(r.bindMode=i.bindMode),void 0!==i.bindMatrix&&r.bindMatrix.fromArray(i.bindMatrix),r.updateMatrixWorld(!0),void 0!==c&&(h.bones=c);break;case"Sky":if(r=new Sky(i.autoUpdate,i.dayTime,i.sunDistance,i.time,!0),void 0!==i.colorTop){r.colorTop=[];for(var d=0;d<i.colorTop.length;d++)r.colorTop.push(new TONG.Color(i.colorTop[d]))}if(void 0!==i.colorBottom){r.colorBottom=[];for(d=0;d<i.colorBottom.length;d++)r.colorBottom.push(new TONG.Color(i.colorBottom[d]))}void 0!==i.sunColor&&(r.sunColor=i.sunColor),void 0!==i.moonColor&&(r.moonColor=i.moonColor),void 0!==i.intensity&&(r.intensity=i.intensity);break;case"LensFlare":r=new LensFlare,void 0!==i.lensFlares&&(i.elements=i.lensFlares);for(d=0;d<i.elements.length;d++)r.addFlare((o=i.elements[d].texture,console.log(a.textures),void 0===a.textures[o]&&console.warn("ObjectLoader: Undefined texture",o),a.textures[o]),i.elements[d].size,i.elements[d].distance,new TONG.Color(i.elements[d].color));break;case"Mesh":h=s(i.geometry),u=l(i.material);r=h.bones&&0<h.bones.length?new TONG.SkinnedMesh(h,u):new TONG.Mesh(h,u);break;case"LOD":r=new TONG.LOD;break;case"Line":r=new TONG.Line(s(i.geometry),l(i.material),i.mode);break;case"LineLoop":r=new TONG.LineLoop(s(i.geometry),l(i.material));break;case"LineSegments":r=new TONG.LineSegments(s(i.geometry),l(i.material));break;case"PointCloud":case"Points":r=new TONG.Points(s(i.geometry),l(i.material));break;case"Sprite":r=new TONG.Sprite(l(i.material));break;case"Group":r=new TONG.Group;break;default:r=new TONG.Object3D}function p(e){if(e instanceof TONG.HemisphereLight)r.hemisphere=e,r.hemisphere.locked=!0,r.hemisphere.matrixAutoUpdate=!1;else if(e instanceof TONG.DirectionalLight)r.sun=e,r.sun.castShadow=!0,r.sun.locked=!0;else if(e instanceof TONG.Mesh){r.sky=e;var t=r.sky.material.uniforms;t.topColor.value=new TONG.Color(t.topColor.value.r,t.topColor.value.g,t.topColor.value.b),t.bottomColor.value=new TONG.Color(t.bottomColor.value.r,t.bottomColor.value.g,t.bottomColor.value.b),r.sky.locked=!0,r.sky.matrixAutoUpdate=!1}3==r.children.length&&(void 0!==i.sun.castShadow&&(r.sun.castShadow=i.sun.castShadow),r.initialize())}if(r.uuid=i.uuid,void 0!==i.name&&(r.name=i.name),void 0!==i.matrix?(r.matrix.fromArray(i.matrix),void 0!==i.matrixAutoUpdate&&(r.matrixAutoUpdate=i.matrixAutoUpdate),r.matrixAutoUpdate&&r.matrix.decompose(r.position,r.quaternion,r.scale)):(void 0!==i.position&&r.position.fromArray(i.position),void 0!==i.rotation&&r.rotation.fromArray(i.rotation),void 0!==i.quaternion&&r.quaternion.fromArray(i.quaternion),void 0!==i.scale&&r.scale.fromArray(i.scale)),void 0!==i.castShadow&&(r.castShadow=i.castShadow),void 0!==i.receiveShadow&&(r.receiveShadow=i.receiveShadow),i.shadow&&(void 0!==i.shadow.bias&&(r.shadow.bias=i.shadow.bias),void 0!==i.shadow.radius&&(r.shadow.radius=i.shadow.radius),void 0!==i.shadow.mapSize&&r.shadow.mapSize.fromArray(i.shadow.mapSize),void 0!==i.shadow.camera&&(r.shadow.camera=this.parseBackupObject(i.shadow.camera))),void 0!==i.visible&&(r.visible=i.visible),void 0!==i.frustumCulled&&(r.frustumCulled=i.frustumCulled),void 0!==i.renderOrder&&(r.renderOrder=i.renderOrder),void 0!==i.userData&&(r.userData=i.userData),void 0!==i.layers&&(r.layers.mask=i.layers),void 0!==i.children){var m=i.children;for(d=0;d<m.length;d++){var f=this.parseBackupObject(m[d],t,n);"Sky"==r.type&&p(f),r.add(f)}}if("LOD"===i.type)for(var v=i.levels,y=0;y<v.length;y++){var g=v[y],x=r.getObjectByProperty("uuid",g.object);void 0!==x&&r.addLevel(x,g.distance)}return r},ObjectLoader.prototype.parseAnimations=function(e){for(var t={},i=0;i<e.length;i++){var r=e[i],o=TONG.AnimationClip.parse(r);if(void 0!==r.uuid&&(o.uuid=r.uuid),"AnimationAsset"==r.resource_type){var n=new TONG.AnimationAsset;n.uuid=o.uuid,n.filename=r.filename,n.fullpath=r.fullpath,n.setData(o),n.register()}t[o.uuid]=o,console.log(t)}return t},ObjectLoader.prototype.parse=function(e,t){var i=this.parseShape(e.shapes),r=this.parseGeometries(e.geometries,i),o=this.parseImages(e.images,function(){void 0!==t&&t(a)});this.textures=this.parseTextures(e.textures,o);var n=this.parseMaterials(e.materials,this.textures),a=this.parseObject(e.object,r,n,this.textures);return e.animations&&(a.animations=this.parseAnimations(e.animations)),void 0!==e.images&&0!==e.images.length||void 0!==t&&t(a),a},function n(a,s,l){function c(t,e){if(!s[t]){if(!a[t]){var i="function"==typeof require&&require;if(!e&&i)return i(t,!0);if(h)return h(t,!0);var r=new Error("Cannot find module '"+t+"'");throw r.code="MODULE_NOT_FOUND",r}var o=s[t]={exports:{}};a[t][0].call(o.exports,function(e){return c(a[t][1][e]||e)},o,o.exports,n,a,s,l)}return s[t].exports}for(var h="function"==typeof require&&require,e=0;e<l.length;e++)c(l[e]);return c}({1:[function(e,t,i){"object"==typeof t&&(t.exports=function(t){var i=[];this.do=function(e){i.push(e)},this.undo=function(e){i.splice(i.indexOf(e),1)},this.fire=function(){for(var e=0;e<i.length;e++)i[e].apply(t,arguments)}})},{}],2:[function(e,t,i){t.exports={name:"timeliner_gui",version:"",description:GetLanguage("Timeline Animation Editor"),main:"timeliner.js",scripts:{build:"browserify src/*.js --full-path=false -o timeliner_gui.js",mini:"browserify src/*.js -g uglifyify --full-path=false -o timeliner_gui.min.js",watch:"watchify src/*.js -o timeliner_gui.js -v",start:"npm run watch",test:'echo "Error: no tests :(" && exit 1'},repository:{type:"git",url:"https://github.com/tschw/timeliner_gui.git"},keywords:["timeline","animation","keyframe","controls","gui"],author:"tschw (the fork)",contributors:["Joshua 'zz85' Koo (original author)"],license:"MIT",bugs:{url:"https://github.com/tschw/timeliner_gui/issues"},homepage:"https://github.com/tschw/timeliner_gui",devDependencies:{"do.js":"^1.0.0",uglifyify:"^2.6.0"}}},{}],3:[function(e,t,i){t.exports=function(){var n={};this.on=function(e,t){e in n||(n[e]=[]),n[e].push(t)},this.fire=function(e){var t=Array.prototype.slice.call(arguments);t.shift();var i=n[e];if(i)for(var r=0;r<i.length;r++){var o=i[r];o.apply(o,t)}}}},{}],4:[function(e,t,i){t.exports=function(t){var i=[];this.do=function(e){i.push(e)},this.undo=function(e){i.splice(i.indexOf(e),1)},this.fire=function(){for(var e=0;e<i.length;e++)i[e].apply(t,arguments)}}},{}],5:[function(e,t,i){var b=e("./layout_constants"),T=e("./layer_view"),S=e("./widget/icon_button"),C=e("./utils").style,O=(e("./theme"),e("./utils").STORAGE_PREFIX,e("./widget/number"));t.exports=function(o){var e=document.createElement("div"),t=document.createElement("div");t.style.cssText="margin: 0px; top: 0; left: 0; height: "+b.MARKER_TRACK_HEIGHT+"px";var n=document.createElement("div");C(n,{position:"absolute",top:b.MARKER_TRACK_HEIGHT+"px",left:0,right:0,bottom:0,overflow:"hidden"}),e.appendChild(n);var i={width:"22px",height:"22px",padding:"2px"},r={width:"32px",padding:"3px 4px 3px 4px"},a=o.dispatcher,s=(o.controller,new S(16,"play","Play",a));C(s.dom,i,{marginTop:"2px"}),s.onClick(function(e){e.preventDefault(),a.fire("controls.toggle_play")});var l=new S(16,"stop","Stop",a);C(l.dom,i,{marginTop:"2px"}),l.onClick(function(e){a.fire("controls.stop")});var c=document.createElement("input");c.type="range",c.value=0,c.min=-1,c.max=1,c.step=.125,C(c,{width:"80px",margin:"0px",marginLeft:"2px",marginRight:"2px"});var h=0;c.addEventListener("mousedown",function(){h=1}),c.addEventListener("mouseup",function(){h=0,y()}),c.addEventListener("mousemove",function(){h&&y()}),e.appendChild(t);var u={min:0,step:.125},d=new O(u),p=new O(u);d.onChange.do(function(e,t){a.fire("time.update",e),d.paint()}),p.onChange.do(function(e,t){a.fire("totalTime.update",e),p.paint()}),t.appendChild(d.dom),t.appendChild(document.createTextNode("/")),t.appendChild(p.dom),t.appendChild(s.dom),t.appendChild(l.dom),t.appendChild(c);var m=document.createElement("div");C(m,{marginTop:"4px"}),t.appendChild(m);var f=new S(16,"download_alt","Download animation",a);C(f.dom,r),m.appendChild(f.dom),f.onClick(function(){a.fire("export")});var v=new S(16,"upload_alt","Upload animation",a);function y(){a.fire("update.scale",6*Math.pow(100,c.value))}C(v.dom,r),m.appendChild(v.dom),v.onClick(function(){a.fire("openfile")});var g=[],x=[];function w(){var e=o.controller.getChannelNames(),t=o.currentTime;d.setValue(t),p.setValue(o.totalTime),d.paint(),p.paint();for(var i=g.length;0<i--;)i>=e.length?(g[i].dom.style.display="none",x.push(g.pop())):(g[i].setState(e[i]),g[i].repaint(t))}this.layers=g,this.setControlStatus=function(e){e?(s.setIcon("pause"),s.setTip("Pause")):(s.setIcon("play"),s.setTip("Play"))},this.updateState=function(){var e,t,i=o.controller.getChannelNames();for(e=0;e<i.length;e++){var r;t=i[e],g[e]||(x.length?(r=x.pop()).dom.style.display="block":(r=new T(o,t),n.appendChild(r.dom)),g.push(r)),g[e].setState(t)}},this.repaint=w,this.updateState(),this.scrollTo=function(e){n.scrollTop=e*(n.scrollHeight-n.clientHeight)},this.dom=e,w()}},{"./layer_view":6,"./layout_constants":7,"./theme":8,"./utils":12,"./widget/icon_button":14,"./widget/number":15}],6:[function(e,t,i){var s=e("./theme"),l=e("./layout_constants"),c=e("./utils");t.exports=function(i,o){var e=document.createElement("div"),n=document.createElement("span");n.style.cssText="font-size: 12px; padding: 4px;";var t=l.LINE_HEIGHT-1,r=document.createElement("button");r.innerHTML="&#9672;",r.style.cssText="background: none; font-size: 12px; padding: 0px; font-family: monospace; float: right; width: 20px; height: "+t+"px; border-style:none; outline: none;",r.addEventListener("click",function(e){i.dispatcher.fire("keyframe",o)}),e.appendChild(n),e.appendChild(r),e.style.cssText="margin: 0px; border-bottom:1px solid "+s.b+"; top: 0; left: 0; height: "+t+"px; line-height: "+t+"px; color: "+s.c,this.dom=e;var a=function(e){if(r.style.color=s.b,null!=e&&!i.draggingKeyframe&&null!=o){var t=i.controller.getChannelKeyTimes(o);0<=c.binarySearch(t,e)&&(r.style.color=s.c)}};this.repaint=a,this.setState=function(e){for(var t=(o=e).split("."),i="",r=1;r<t.length;r++)r==t.length-1?i+=GetLanguage(t[r]):i+=t[r]+".";n.textContent=i,a()}}},{"./layout_constants":7,"./theme":8,"./utils":12}],7:[function(e,t,i){t.exports={LINE_HEIGHT:26,DIAMOND_SIZE:10,MARKER_TRACK_HEIGHT:60,WIDTH:600,HEIGHT:200,LEFT_PANE_WIDTH:250,TIME_SCALE:60}},{}],8:[function(e,t,i){t.exports={a:"#343434",b:"#535353",c:"#b8b8b8",d:"#d6d6d6",h:"#282828",s:"rgb(246, 112, 0)"}},{}],9:[function(e,t,i){var j,_,z,r=e("./layout_constants"),k=e("./theme"),V=e("./utils"),I=V.proxy_ctx,U=r.LINE_HEIGHT,D=r.DIAMOND_SIZE,W=r.MARKER_TRACK_HEIGHT,q=(r.LEFT_PANE_WIDTH,r.TIME_SCALE),H=0;function K(){_=2*(j=q/60),z=8*j}K(),t.exports=function(c){var n,r=c.dispatcher,h=0,u=0,d=window.devicePixelRatio,p=document.createElement("canvas");this.updateState=function(){n=c.controller.getChannelNames(),C()},this.updateState(),this.scrollTo=function(e){h=e*Math.max(n.length*U-c.scrollHeight,0),C()},this.resize=function(){d=window.devicePixelRatio,p.width=c.width*d,p.height=c.height*d,p.style.width=c.width+"px",p.style.height=c.height+"px",c.scrollHeight=c.height-W},this.dom=p,this.resize();var m,f,v,a,s,l,y=p.getContext("2d"),g=I(y),x=20,w=!1,b=[],T=0;function S(e,t,i){var r=this,o=!1;this.time=e,this.path=function(e){e.beginPath().moveTo(t,i).lineTo(t+D/2,i+D/2).lineTo(t,i+D).lineTo(t-D/2,i+D/2).closePath()},this.paint=function(e){r.path(e),o?e.fillStyle("yellow"):e.fillStyle(k.c),e.fill().stroke()},this.mouseover=function(){o=!0,p.style.cursor="move",r.paint(g)},this.mouseclick=function(e,t,i){c.controller.onClickTrack(e,i,t)},this.mouseout=function(){o=!1,p.style.cursor="default",r.paint(g)},this.mousedrag=function(e,t){if(void 0!==l){var i=G(e.offsetx),r=Math.max(i-T,-T),o=t.shiftKey;r&&(c.draggingKeyframe=!0,c.controller.moveKeyframe(l,T,r,o),T+=r,C())}}}function C(){w=!0}function O(){for(b.length=0,f=0,s=n.length;f<=s;f++)y.strokeStyle=k.b,y.beginPath(),a=~~(a=f*U)-.5,g.moveTo(0,a).lineTo(width,a).stroke();for(f=0;f<s;f++){var e=n[f],t=c.controller.getChannelKeyTimes(e);a=f*U;for(var i=0;i<t.length;i++){var r=t[i];b.push(new S(r,(o=void 0,o=r-H,o*=q,o+=x),a+.5*U-D/2))}}var o;for(f=0,s=b.length;f<s;f++)b[f].paint(g)}var N=20,A={left:0,grip_length:0,k:1};function M(e){q!==e&&(q=e,K())}this.setTimeScale=M;var P,i=null,E=null;function e(){var e,t=i;for(i=null,f=b.length;0<f--;)if((e=b[f]).path(g),y.isPointInPath(B.x*d,B.y*d)){i=e;break}t&&t!=i&&(e=t).mouseout&&e.mouseout(),i&&((e=i).mouseover&&e.mouseover(),F&&(E=e))}function L(){B&&g.save().scale(d,d).translate(0,W).beginPath().rect(0,0,c.width,c.scrollHeight).translate(-u,-h).clip().run(e).restore()}function o(e){return e-W<0?-1:(e-W+h)/U|0}function G(e){return H+((e-x)/(q/z)|0)/z}this.repaint=C,this._paint=function(){if(w){M(c.timeScale),m=c.currentTime,H=c.scrollTime,y.fillStyle=k.a,y.clearRect(0,0,p.width,p.height),y.save(),y.scale(d,d),y.lineWidth=1,width=c.width,height=c.height;var e=q/j,t=H*q%e,i=(width-x+t)/e;for(f=0;f<i;f++){v=f*e+x-t,y.strokeStyle=k.b,y.beginPath(),y.moveTo(v,0),y.lineTo(v,height),y.stroke(),y.fillStyle=k.d,y.textAlign="center";var r=(f*e-t)/q+H;r=V.format_friendly_seconds(r),y.fillText(r,v,38)}for(e=q/_,i=(width-x+t)/e,f=0;f<i;f++)y.strokeStyle=k.c,y.beginPath(),v=f*e+x-t,y.moveTo(v,W-0),y.lineTo(v,W-16),y.stroke();var o=z/_;for(e=q/z,i=(width-x+t)/e,f=0;f<i;f++)f%o!=0&&(y.strokeStyle=k.c,y.beginPath(),v=f*e+x-t,y.moveTo(v,W-0),y.lineTo(v,W-10),y.stroke());g.save().translate(0,W).beginPath().rect(0,0,c.width,c.scrollHeight).translate(-u,-h).clip().run(O).restore(),function(){var e=width,t=c.totalTime,i=e/q,r=e/t;A.k=r,A.grip_length=i*r;var o=N;A.left=c.scrollTime*r,A.left=Math.min(Math.max(0,A.left),e-A.grip_length),y.beginPath(),y.fillStyle=k.b,y.rect(0,5,e,o),y.fill(),y.fillStyle=k.s,y.beginPath(),y.rect(A.left,5,A.grip_length,o),y.fill();var n=m*r;y.fillStyle="red",y.fillRect(0,5,n,2)}(),y.strokeStyle="red",v=(m-H)*q+x;var n=V.format_friendly_seconds(m),a=y.measureText(n).width,s=W-5,l=a/2+4;y.beginPath(),y.moveTo(v,s),y.lineTo(v,height),y.stroke(),y.fillStyle="red",y.textAlign="center",y.beginPath(),y.moveTo(v,s+5),y.lineTo(v+5,s),y.lineTo(v+l,s),y.lineTo(v+l,s-14),y.lineTo(v-l,s-14),y.lineTo(v-l,s),y.lineTo(v-5,s),y.closePath(),y.fill(),y.fillStyle="white",y.fillText(n,v,s-4),y.restore(),w=!1}else L()},C(),document.addEventListener("mousemove",function(e){P=p.getBoundingClientRect();var t,i,r=e.clientX-P.left,o=e.clientY-P.top;t=r,i=o,E||(B={x:t,y:i})}),p.addEventListener("dblclick",function(e){P=p.getBoundingClientRect();var t=e.clientX-P.left,i=o(e.clientY-P.top);G(t),r.fire("keyframe",n[i],m)});var B=null;p.addEventListener("mouseout",function(){B=null});var t,F=!1,R=!1;V.handleDrag(p,function(e){F=!0,B={x:e.offsetx,y:e.offsety},L(),E instanceof S&&(T=E.time,l=n[o(e.offsety)],E.mouseclick&&E.mouseclick(e,T,l),l||(E=null)),r.fire("time.update",G(e.offsetx))},function(e,t){F=!1,E?(R=!0,E.mousedrag&&E.mousedrag(e,t)):r.fire("time.update",G(e.offsetx))},function(){R&&r.fire("keyframe.move"),E=null,R=F=!1,c.draggingKeyframe=!1,C()}),V.handleDrag(p,function(e){t=A.left},function(e){c.scrollTime=Math.max(0,(t+e.dx)/A.k),C()},function(){},function(e){var t=e.offsetx>=A.left&&e.offsetx<=A.left+A.grip_length;return e.offsety<=N&&t})}},{"./layout_constants":7,"./theme":8,"./utils":12}],10:[function(e,t,i){var r=e("./undo"),E=e("./dispatcher"),L=e("./theme"),G=r.UndoManager,B=(r.UndoState,e("./layout_constants")),F=e("./utils"),R=e("./layer_cabinet"),j=e("./timeline_panel"),_=e("../package.json"),z=(e("./widget/icon_button"),F.style),k=F.saveToFile,V=F.openAs,I=F.STORAGE_PREFIX,U=e("./widget/scrollbar");function o(r){var o=new E;r.timeliner=this,r.init(this);var e=this,S={width:B.WIDTH,height:B.HEIGHT,scrollHeight:0,totalTime:20,timeScale:6,currentTime:0,scrollTime:0,dispatcher:o,controller:r},n=new j(S),a=new R(S),C=(new G(o),new U(0,10)),s=document.createElement("div");r.setDuration(S.totalTime),o.on("keyframe",function(e){var t=S.currentTime;if(null!=t&&null!=e){var i=r.getChannelKeyTimes(e,t);F.binarySearch(i,t)<0?r.addKeyframe(e,t):r.delKeyframe(e,t),f()}}),o.on("keyframe.move",function(e,t){}),this.setTitle=function(e){_.description=e,g.innerHTML=e};var l=null,c=function(e){var t=Math.min(Math.max(e,0),S.totalTime);S.currentTime=t,r.setDisplayTime(t),l&&(l=performance.now()-1e3*e),f()};function t(){l=performance.now()-1e3*S.currentTime,a.setControlStatus(!0)}function i(){l=null,a.setControlStatus(!1)}o.on("controls.toggle_play",function(){l?i():t()}),o.on("controls.restart_play",function(){l||t(),c(0)}),o.on("controls.play",t),o.on("controls.pause",i),o.on("controls.stop",function(){null!==l&&i(),c(0)}),o.on("time.update",c),o.on("totalTime.update",function(e){S.totalTime=e,r.setDuration(e),n.repaint()}),o.on("update.scale",function(e){S.timeScale=e,n.setTimeScale(e),n.repaint()}),o.on("controls.undo",function(){}),o.on("controls.redo",function(){});var O=!0;function h(e){}function u(e){e||(e=S.name),(e=prompt("Pick a name to save to (localStorage)",e))&&(S.name=e)}function d(e){e instanceof TONG.AnimationClip?r.dataFromClip(e):r.deserialize(e),m()}function p(e){d(JSON.parse(e))}function m(){a.updateState(),n.updateState(),f()}function f(){var e=S.controller.getChannelNames().length*B.LINE_HEIGHT;C.setLength(S.scrollHeight/e),a.repaint(),n.repaint()}function v(e){e&&p(localStorage[I+e])}!function e(){if(requestAnimationFrame(e),l){var t=(performance.now()-l)/1e3;c(t),t>S.totalTime&&(l=performance.now())}var i,r;O&&(s.style.width=S.width+"px",s.style.height=S.height+"px",i=a.dom,r=n.dom,i.style.cssText="position: absolute; left: 0px; top: 0px; height: "+S.height+"px;",z(i,{overflow:"hidden"}),i.style.width=B.LEFT_PANE_WIDTH+"px",r.style.position="absolute",r.style.top="0px",r.style.left=B.LEFT_PANE_WIDTH+"px",n.resize(),f(),O=!1,o.fire("resize")),n._paint()}(),e.updateState=m,this.openLocalSave=v,o.on("import",function(){var e;(e=prompt("Paste JSON in here to Load"))&&p(e)}.bind(this)),o.on("new",function(){data.blank(),m()}),o.on("openfile",function(){V(function(e){p(e)},s)}),o.on("open",v),o.on("export",function(){var e=r.serialize();k(JSON.stringify(e,null,"\t"),"animation.json")}),o.on("save",function(){var e=S.name;e||u(e)}),o.on("save_as",u),this.save=h,this.load=d,z(s,{textAlign:"left",lineHeight:"1em",position:"absolute",top:"22px"});var N=document.createElement("div");e.pane=N,z(N,{position:"absolute",top:"20px",left:"20px",margin:0,border:"1px solid "+L.h,padding:0,overflow:"hidden",backgroundColor:L.a,color:L.d,zIndex:999,fontFamily:"monospace",fontSize:"12px"});var y={position:"absolute",top:"0px",width:"100%",height:"22px",lineHeight:"22px",overflow:"hidden"},A=document.createElement("div");z(A,y,{borderBottom:"1px solid "+L.b,textAlign:"center"});var g=document.createElement("span");A.appendChild(g),g.innerHTML=_.description+" "+_.version,A.appendChild(g);var x=document.createElement("div");z(x,y,{textAlign:"right"}),A.appendChild(x);var w=document.createElement("div"),b={position:"absolute",width:"100%",height:"22px",lineHeight:"22px",bottom:"0",fontSize:"11px"};z(w,b,{borderTop:"1px solid "+L.b,background:L.a}),N.appendChild(s),N.appendChild(w),N.appendChild(A);var T=document.createElement("span");T.textContent="Hello!",T.style.marginLeft="10px",o.on("status",function(e){T.textContent=e}),o.on("state:save",function(e){o.fire("status",e)});var M=document.createElement("div");z(M,b,{textAlign:"right"}),w.appendChild(T),w.appendChild(M);var P=document.createElement("div");e.ghostpane=P,z(P,{background:"#999",opacity:.2,position:"position",margin:0,padding:0,zIndex:998,transitionProperty:"top, left, width, height, opacity",transitionDuration:"0.25s",transitionTimingFunction:"ease-in-out"}),document.body.appendChild(N),document.body.appendChild(P),this.appendToElement=function(e){e.appendChild(N),e.appendChild(P)},s.appendChild(a.dom),s.appendChild(n.dom),s.appendChild(C.dom),C.onScroll.do(function(e,t){switch(e){case"scrollto":a.scrollTo(t),n.scrollTo(t)}}),document.addEventListener("keydown",function(e){var t=32==e.keyCode,i=13==e.keyCode,r=(e.metaKey&&91==e.keyCode&&e.shiftKey,document.activeElement);r.nodeName.match(/(INPUT|BUTTON|SELECT)/)&&r.blur(),t?o.fire("controls.toggle_play"):i?o.fire("controls.restart_play"):27==e.keyCode&&o.fire("controls.pause")}),this.dispose=function(){var e=N.parentElement;e.removeChild(N),e.removeChild(P)},function(){var r,o,n,a,s,l,t=2,i=12,c=2,h=null,u=(B.WIDTH,B.HEIGHT,"snap-bottom-edge"),d=N.getBoundingClientRect(),p=!1,m=!1;A.addEventListener("mouseover",function(){m=!0}),A.addEventListener("mouseout",function(){m=!1});var f=function(e,t,i,r,o){var n,a;e.style.left=t+"px",e.style.top=i+"px",e.style.width=r+"px",e.style.height=o+"px",e===N&&(n=r,a=o,S.width=n-B.LEFT_PANE_WIDTH-4,S.height=a-44,S.scrollHeight=S.height-B.MARKER_TRACK_HEIGHT,C.setHeight(S.scrollHeight-2),z(C.dom,{top:B.MARKER_TRACK_HEIGHT+"px",left:n-16-4+"px"}),O=!0)};(e.setBounds=f)(N,0,0,S.width,S.height),f(P,0,0,S.width,S.height),N.addEventListener("mousedown",function(e){g(e)}),N.addEventListener("mouseover",function(e){y=!0}),N.addEventListener("mouseout",function(e){y=!1}),document.addEventListener("mousemove",w),document.addEventListener("mouseup",T),N.addEventListener("touchstart",function(e){g(e.touches[0]),e.preventDefault()}),document.addEventListener("touchmove",function(e){w(e.touches[0])}),document.addEventListener("touchend",function(e){0==e.touches.length&&T(e.changedTouches[0])});var v,y=!1;function g(e){x(e);var t=r||o||a||n,i=!t&&m;h={x:s,y:l,cx:e.clientX,cy:e.clientY,w:d.width,h:d.height,isResizing:t,isMoving:i,onTopEdge:a,onLeftEdge:n,onRightEdge:r,onBottomEdge:o},(t||i)&&e.preventDefault(),e.stopPropagation()}function x(e){d=N.getBoundingClientRect(),s=e.clientX-d.left,l=e.clientY-d.top,a=l<c,n=s<c,r=s>=d.width-c,o=l>=d.height-c}function w(e){x(v=e),p=!0,y&&v.stopPropagation()}function b(){var e,t,i,r;switch(u){case"full-screen":t=e=0,i=window.innerWidth,r=window.innerHeight;break;case"snap-top-edge":t=e=0,i=window.innerWidth,r=.25*window.innerHeight;break;case"snap-left-edge":t=e=0,i=.35*window.innerWidth,r=window.innerHeight;break;case"snap-right-edge":e=.65*window.innerWidth,t=0,i=.35*window.innerWidth,r=window.innerHeight;break;case"snap-bottom-edge":e=0,t=.75*window.innerHeight,i=window.innerWidth,r=.25*window.innerHeight;break;default:return}f(N,e,t,i,r),f(P,e,t,i,r)}function T(e){x(e),h&&h.isMoving&&((u=v.clientY<t?"full-screen":v.clientY<i?"snap-top-edge":v.clientX<i?"snap-left-edge":window.innerWidth-v.clientX<i?"snap-right-edge":window.innerHeight-v.clientY<i?"snap-bottom-edge":void 0)?({width:d.width,height:d.height},b()):null,f(P,d.left,d.top,d.width,d.height),P.style.opacity=0),h=null,y&&e.stopPropagation()}!function e(){requestAnimationFrame(e),p&&(p=!1)}(),b()}()}o.binarySearch=F.binarySearch,window.Timeliner=o},{"../package.json":2,"./dispatcher":3,"./layer_cabinet":5,"./layout_constants":7,"./theme":8,"./timeline_panel":9,"./undo":11,"./utils":12,"./widget/icon_button":14,"./widget/scrollbar":16}],11:[function(e,t,i){function r(e,t){this.dispatcher=e,this.MAX_ITEMS=t||100,this.clear()}r.prototype.save=function(e,t){var i=this.states,r=this.index+1,o=i.length-r;i.splice(r,o,e),i.length>this.MAX_ITEMS&&i.shift(),this.index=i.length-1,t||this.dispatcher.fire("state:save",e.description)},r.prototype.clear=function(){this.states=[],this.index=-1},r.prototype.canUndo=function(){return 0<this.index},r.prototype.canRedo=function(){return this.index<this.states.length-1},r.prototype.undo=function(){return this.canUndo()?(this.dispatcher.fire("status","Undo: "+this.get().description),this.index--):this.dispatcher.fire("status","Nothing to undo"),this.get()},r.prototype.redo=function(){return this.canRedo()?(this.index++,this.dispatcher.fire("status","Redo: "+this.get().description)):this.dispatcher.fire("status","Nothing to redo"),this.get()},r.prototype.get=function(){return this.states[this.index]},t.exports={UndoState:function(e,t){this.state=e.getJSONString(),this.description=t},UndoManager:r}},{}],12:[function(e,t,i){var r,o;function n(e){var t=e.target.files[0];if(t){var i=new FileReader;i.onload=function(e){var t=e.target.result;o(t)},i.readAsText(t),r.value=""}}function a(e){var t=document.createEvent("MouseEvents");t.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),e.dispatchEvent(t)}t.exports={STORAGE_PREFIX:"timeliner-",Z_INDEX:999,style:function(e,t){for(var i=1;i<arguments.length;++i){var r=arguments[i];for(var o in r)e.style[o]=r[o]}},saveToFile:function(e,t){var i=document.createElement("a");document.body.appendChild(i),i.style="display: none";var r=new Blob([e],{type:"octet/stream"}),o=window.URL.createObjectURL(r);i.href=o,i.download=t,a(i),setTimeout(function(){window.URL.revokeObjectURL(o),document.body.removeChild(i)},500)},openAs:function(e,t){o=e,r||((r=document.createElement("input")).style.display="none",r.type="file",r.addEventListener("change",n),(t=t||document.body).appendChild(r));a(r)},format_friendly_seconds:function(e,t){var i=0|e,r=i%60,o=i/60|0,n=o%60,a=(r/100).toFixed(2).substring(2),s=n+":"+a;if(0<e%1){var l=e%1*60;"frames"===t?s=r+"+"+l.toFixed(0)+"f":s+=(e%1).toFixed(2).substring(1)}return s},proxy_ctx:function(i){var r={};function e(e){return function(){return i[e].apply(i,arguments),r}}function t(t){return function(e){return i[t]=e,r}}for(var o in r.run=function(e){return e(r),r},i){var n=typeof i[o];switch(n){case"object":break;case"function":r[o]=e(o);break;default:r[o]=t(o)}}return r},handleDrag:function(n,i,t,r,o){var a=null,s=n.getBoundingClientRect();function e(e){c(e),!o||o(a,e)?(document.addEventListener("mousemove",l),document.addEventListener("mouseup",u),i(a,e),e.preventDefault()):a=null}function l(e){h(e),a.moved=!0,t(a,e)}function c(e){s=n.getBoundingClientRect();var t=e.clientX,i=e.clientY;a={startx:t,starty:i,x:t,y:i,dx:0,dy:0,offsetx:t-s.left,offsety:i-s.top,moved:!1}}function h(e){s=n.getBoundingClientRect();var t=e.clientX,i=e.clientY,r=t-s.left,o=i-s.top;a.x=t,a.y=i,a.dx=e.clientX-a.startx,a.dy=e.clientY-a.starty,a.offsetx=r,a.offsety=o}function u(e){h(e),r(a,e),a=null,document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",u)}function d(e){if(1==e.touches.length){var t=e.touches[0];if(o&&!o(t))return;e.preventDefault(),c(t),i(a,t)}n.addEventListener("touchmove",p),n.addEventListener("touchend",m)}function p(e){var t=e.touches[0];l(t)}function m(e){u(e),n.removeEventListener("touchmove",p),n.removeEventListener("touchend",m)}n.addEventListener("mousedown",e),n.addEventListener("touchstart",d),this.release=function(){n.removeEventListener("mousedown",e),n.removeEventListener("touchstart",d)}},binarySearch:function(e,t){var i=0,r=e.length,o=!1;for(;i<r;){var n=i+r>>1;e[n]<t?i=n+1:o=e[r=n]===t}return o?i:~i}}},{}],13:[function(e,t,i){t.exports={unitsPerEm:1792,ascender:1536,descender:-256,fonts:{plus:{advanceWidth:1408,commands:"M,1408,800 C,1408,853,1365,896,1312,896 L,896,896 L,896,1312 C,896,1365,853,1408,800,1408 L,608,1408 C,555,1408,512,1365,512,1312 L,512,896 L,96,896 C,43,896,0,853,0,800 L,0,608 C,0,555,43,512,96,512 L,512,512 L,512,96 C,512,43,555,0,608,0 L,800,0 C,853,0,896,43,896,96 L,896,512 L,1312,512 C,1365,512,1408,555,1408,608 Z"},minus:{advanceWidth:1408,commands:"M,1408,800 C,1408,853,1365,896,1312,896 L,96,896 C,43,896,0,853,0,800 L,0,608 C,0,555,43,512,96,512 L,1312,512 C,1365,512,1408,555,1408,608 Z"},ok:{advanceWidth:1792,commands:"M,1671,970 C,1671,995,1661,1020,1643,1038 L,1507,1174 C,1489,1192,1464,1202,1439,1202 C,1414,1202,1389,1192,1371,1174 L,715,517 L,421,812 C,403,830,378,840,353,840 C,328,840,303,830,285,812 L,149,676 C,131,658,121,633,121,608 C,121,583,131,558,149,540 L,511,178 L,647,42 C,665,24,690,14,715,14 C,740,14,765,24,783,42 L,919,178 L,1643,902 C,1661,920,1671,945,1671,970 Z"},remove:{advanceWidth:1408,commands:"M,1298,214 C,1298,239,1288,264,1270,282 L,976,576 L,1270,870 C,1288,888,1298,913,1298,938 C,1298,963,1288,988,1270,1006 L,1134,1142 C,1116,1160,1091,1170,1066,1170 C,1041,1170,1016,1160,998,1142 L,704,848 L,410,1142 C,392,1160,367,1170,342,1170 C,317,1170,292,1160,274,1142 L,138,1006 C,120,988,110,963,110,938 C,110,913,120,888,138,870 L,432,576 L,138,282 C,120,264,110,239,110,214 C,110,189,120,164,138,146 L,274,10 C,292,-8,317,-18,342,-18 C,367,-18,392,-8,410,10 L,704,304 L,998,10 C,1016,-8,1041,-18,1066,-18 C,1091,-18,1116,-8,1134,10 L,1270,146 C,1288,164,1298,189,1298,214 Z"},zoom_in:{advanceWidth:1664,commands:"M,1024,736 C,1024,753,1009,768,992,768 L,768,768 L,768,992 C,768,1009,753,1024,736,1024 L,672,1024 C,655,1024,640,1009,640,992 L,640,768 L,416,768 C,399,768,384,753,384,736 L,384,672 C,384,655,399,640,416,640 L,640,640 L,640,416 C,640,399,655,384,672,384 L,736,384 C,753,384,768,399,768,416 L,768,640 L,992,640 C,1009,640,1024,655,1024,672 M,1152,704 C,1152,457,951,256,704,256 C,457,256,256,457,256,704 C,256,951,457,1152,704,1152 C,951,1152,1152,951,1152,704 M,1664,-128 C,1664,-94,1650,-61,1627,-38 L,1284,305 C,1365,422,1408,562,1408,704 C,1408,1093,1093,1408,704,1408 C,315,1408,0,1093,0,704 C,0,315,315,0,704,0 C,846,0,986,43,1103,124 L,1446,-218 C,1469,-242,1502,-256,1536,-256 C,1607,-256,1664,-199,1664,-128 Z"},zoom_out:{advanceWidth:1664,commands:"M,1024,736 C,1024,753,1009,768,992,768 L,416,768 C,399,768,384,753,384,736 L,384,672 C,384,655,399,640,416,640 L,992,640 C,1009,640,1024,655,1024,672 M,1152,704 C,1152,457,951,256,704,256 C,457,256,256,457,256,704 C,256,951,457,1152,704,1152 C,951,1152,1152,951,1152,704 M,1664,-128 C,1664,-94,1650,-61,1627,-38 L,1284,305 C,1365,422,1408,562,1408,704 C,1408,1093,1093,1408,704,1408 C,315,1408,0,1093,0,704 C,0,315,315,0,704,0 C,846,0,986,43,1103,124 L,1446,-218 C,1469,-242,1502,-256,1536,-256 C,1607,-256,1664,-199,1664,-128 Z"},cog:{advanceWidth:1536,commands:"M,1024,640 C,1024,499,909,384,768,384 C,627,384,512,499,512,640 C,512,781,627,896,768,896 C,909,896,1024,781,1024,640 M,1536,749 C,1536,766,1524,782,1507,785 L,1324,813 C,1314,846,1300,879,1283,911 C,1317,958,1354,1002,1388,1048 C,1393,1055,1396,1062,1396,1071 C,1396,1079,1394,1087,1389,1093 C,1347,1152,1277,1214,1224,1263 C,1217,1269,1208,1273,1199,1273 C,1190,1273,1181,1270,1175,1264 L,1033,1157 C,1004,1172,974,1184,943,1194 L,915,1378 C,913,1395,897,1408,879,1408 L,657,1408 C,639,1408,625,1396,621,1380 C,605,1320,599,1255,592,1194 C,561,1184,530,1171,501,1156 L,363,1263 C,355,1269,346,1273,337,1273 C,303,1273,168,1127,144,1094 C,139,1087,135,1080,135,1071 C,135,1062,139,1054,145,1047 C,182,1002,218,957,252,909 C,236,879,223,849,213,817 L,27,789 C,12,786,0,768,0,753 L,0,531 C,0,514,12,498,29,495 L,212,468 C,222,434,236,401,253,369 C,219,322,182,278,148,232 C,143,225,140,218,140,209 C,140,201,142,193,147,186 C,189,128,259,66,312,18 C,319,11,328,7,337,7 C,346,7,355,10,362,16 L,503,123 C,532,108,562,96,593,86 L,621,-98 C,623,-115,639,-128,657,-128 L,879,-128 C,897,-128,911,-116,915,-100 C,931,-40,937,25,944,86 C,975,96,1006,109,1035,124 L,1173,16 C,1181,11,1190,7,1199,7 C,1233,7,1368,154,1392,186 C,1398,193,1401,200,1401,209 C,1401,218,1397,227,1391,234 C,1354,279,1318,323,1284,372 C,1300,401,1312,431,1323,463 L,1508,491 C,1524,494,1536,512,1536,527 Z"},trash:{advanceWidth:1408,commands:"M,512,800 C,512,818,498,832,480,832 L,416,832 C,398,832,384,818,384,800 L,384,224 C,384,206,398,192,416,192 L,480,192 C,498,192,512,206,512,224 M,768,800 C,768,818,754,832,736,832 L,672,832 C,654,832,640,818,640,800 L,640,224 C,640,206,654,192,672,192 L,736,192 C,754,192,768,206,768,224 M,1024,800 C,1024,818,1010,832,992,832 L,928,832 C,910,832,896,818,896,800 L,896,224 C,896,206,910,192,928,192 L,992,192 C,1010,192,1024,206,1024,224 M,1152,76 C,1152,28,1125,0,1120,0 L,288,0 C,283,0,256,28,256,76 L,256,1024 L,1152,1024 L,1152,76 M,480,1152 L,529,1269 C,532,1273,540,1279,546,1280 L,863,1280 C,868,1279,877,1273,880,1269 L,928,1152 M,1408,1120 C,1408,1138,1394,1152,1376,1152 L,1067,1152 L,997,1319 C,977,1368,917,1408,864,1408 L,544,1408 C,491,1408,431,1368,411,1319 L,341,1152 L,32,1152 C,14,1152,0,1138,0,1120 L,0,1056 C,0,1038,14,1024,32,1024 L,128,1024 L,128,72 C,128,-38,200,-128,288,-128 L,1120,-128 C,1208,-128,1280,-34,1280,76 L,1280,1024 L,1376,1024 C,1394,1024,1408,1038,1408,1056 Z"},file_alt:{advanceWidth:1536,commands:"M,1468,1156 L,1156,1468 C,1119,1505,1045,1536,992,1536 L,96,1536 C,43,1536,0,1493,0,1440 L,0,-160 C,0,-213,43,-256,96,-256 L,1440,-256 C,1493,-256,1536,-213,1536,-160 L,1536,992 C,1536,1045,1505,1119,1468,1156 M,1024,1400 C,1041,1394,1058,1385,1065,1378 L,1378,1065 C,1385,1058,1394,1041,1400,1024 L,1024,1024 M,1408,-128 L,128,-128 L,128,1408 L,896,1408 L,896,992 C,896,939,939,896,992,896 L,1408,896 Z"},download_alt:{advanceWidth:1664,commands:"M,1280,192 C,1280,157,1251,128,1216,128 C,1181,128,1152,157,1152,192 C,1152,227,1181,256,1216,256 C,1251,256,1280,227,1280,192 M,1536,192 C,1536,157,1507,128,1472,128 C,1437,128,1408,157,1408,192 C,1408,227,1437,256,1472,256 C,1507,256,1536,227,1536,192 M,1664,416 C,1664,469,1621,512,1568,512 L,1104,512 L,968,376 C,931,340,883,320,832,320 C,781,320,733,340,696,376 L,561,512 L,96,512 C,43,512,0,469,0,416 L,0,96 C,0,43,43,0,96,0 L,1568,0 C,1621,0,1664,43,1664,96 M,1339,985 C,1329,1008,1306,1024,1280,1024 L,1024,1024 L,1024,1472 C,1024,1507,995,1536,960,1536 L,704,1536 C,669,1536,640,1507,640,1472 L,640,1024 L,384,1024 C,358,1024,335,1008,325,985 C,315,961,320,933,339,915 L,787,467 C,799,454,816,448,832,448 C,848,448,865,454,877,467 L,1325,915 C,1344,933,1349,961,1339,985 Z"},repeat:{advanceWidth:1536,commands:"M,1536,1280 C,1536,1306,1520,1329,1497,1339 C,1473,1349,1445,1344,1427,1325 L,1297,1196 C,1156,1329,965,1408,768,1408 C,345,1408,0,1063,0,640 C,0,217,345,-128,768,-128 C,997,-128,1213,-27,1359,149 C,1369,162,1369,181,1357,192 L,1220,330 C,1213,336,1204,339,1195,339 C,1186,338,1177,334,1172,327 C,1074,200,927,128,768,128 C,486,128,256,358,256,640 C,256,922,486,1152,768,1152 C,899,1152,1023,1102,1117,1015 L,979,877 C,960,859,955,831,965,808 C,975,784,998,768,1024,768 L,1472,768 C,1507,768,1536,797,1536,832 Z"},pencil:{advanceWidth:1536,commands:"M,363,0 L,256,0 L,256,128 L,128,128 L,128,235 L,219,326 L,454,91 M,886,928 C,886,922,884,916,879,911 L,337,369 C,332,364,326,362,320,362 C,307,362,298,371,298,384 C,298,390,300,396,305,401 L,847,943 C,852,948,858,950,864,950 C,877,950,886,941,886,928 M,832,1120 L,0,288 L,0,-128 L,416,-128 L,1248,704 M,1515,1024 C,1515,1058,1501,1091,1478,1115 L,1243,1349 C,1219,1373,1186,1387,1152,1387 C,1118,1387,1085,1373,1062,1349 L,896,1184 L,1312,768 L,1478,934 C,1501,957,1515,990,1515,1024 Z"},edit:{advanceWidth:1792,commands:"M,888,352 L,832,352 L,832,448 L,736,448 L,736,504 L,852,620 L,1004,468 M,1328,1072 C,1337,1063,1336,1048,1327,1039 L,977,689 C,968,680,953,679,944,688 C,935,697,936,712,945,721 L,1295,1071 C,1304,1080,1319,1081,1328,1072 M,1408,478 C,1408,491,1400,502,1388,507 C,1376,512,1363,510,1353,500 L,1289,436 C,1283,430,1280,422,1280,414 L,1280,288 C,1280,200,1208,128,1120,128 L,288,128 C,200,128,128,200,128,288 L,128,1120 C,128,1208,200,1280,288,1280 L,1120,1280 C,1135,1280,1150,1278,1165,1274 C,1176,1270,1188,1273,1197,1282 L,1246,1331 C,1254,1339,1257,1349,1255,1360 C,1253,1370,1246,1379,1237,1383 C,1200,1400,1160,1408,1120,1408 L,288,1408 C,129,1408,0,1279,0,1120 L,0,288 C,0,129,129,0,288,0 L,1120,0 C,1279,0,1408,129,1408,288 M,1312,1216 L,640,544 L,640,256 L,928,256 L,1600,928 M,1756,1084 C,1793,1121,1793,1183,1756,1220 L,1604,1372 C,1567,1409,1505,1409,1468,1372 L,1376,1280 L,1664,992 L,1756,1084 Z"},play:{advanceWidth:1408,commands:"M,1384,609 C,1415,626,1415,654,1384,671 L,56,1409 C,25,1426,0,1411,0,1376 L,0,-96 C,0,-131,25,-146,56,-129 Z"},pause:{advanceWidth:1536,commands:"M,1536,1344 C,1536,1379,1507,1408,1472,1408 L,960,1408 C,925,1408,896,1379,896,1344 L,896,-64 C,896,-99,925,-128,960,-128 L,1472,-128 C,1507,-128,1536,-99,1536,-64 M,640,1344 C,640,1379,611,1408,576,1408 L,64,1408 C,29,1408,0,1379,0,1344 L,0,-64 C,0,-99,29,-128,64,-128 L,576,-128 C,611,-128,640,-99,640,-64 Z"},stop:{advanceWidth:1536,commands:"M,1536,1344 C,1536,1379,1507,1408,1472,1408 L,64,1408 C,29,1408,0,1379,0,1344 L,0,-64 C,0,-99,29,-128,64,-128 L,1472,-128 C,1507,-128,1536,-99,1536,-64 Z"},resize_full:{advanceWidth:1536,commands:"M,755,480 C,755,488,751,497,745,503 L,631,617 C,625,623,616,627,608,627 C,600,627,591,623,585,617 L,253,285 L,109,429 C,97,441,81,448,64,448 C,29,448,0,419,0,384 L,0,-64 C,0,-99,29,-128,64,-128 L,512,-128 C,547,-128,576,-99,576,-64 C,576,-47,569,-31,557,-19 L,413,125 L,745,457 C,751,463,755,472,755,480 M,1536,1344 C,1536,1379,1507,1408,1472,1408 L,1024,1408 C,989,1408,960,1379,960,1344 C,960,1327,967,1311,979,1299 L,1123,1155 L,791,823 C,785,817,781,808,781,800 C,781,792,785,783,791,777 L,905,663 C,911,657,920,653,928,653 C,936,653,945,657,951,663 L,1283,995 L,1427,851 C,1439,839,1455,832,1472,832 C,1507,832,1536,861,1536,896 Z"},resize_small:{advanceWidth:1536,commands:"M,768,576 C,768,611,739,640,704,640 L,256,640 C,221,640,192,611,192,576 C,192,559,199,543,211,531 L,355,387 L,23,55 C,17,49,13,40,13,32 C,13,24,17,15,23,9 L,137,-105 C,143,-111,152,-115,160,-115 C,168,-115,177,-111,183,-105 L,515,227 L,659,83 C,671,71,687,64,704,64 C,739,64,768,93,768,128 M,1523,1248 C,1523,1256,1519,1265,1513,1271 L,1399,1385 C,1393,1391,1384,1395,1376,1395 C,1368,1395,1359,1391,1353,1385 L,1021,1053 L,877,1197 C,865,1209,849,1216,832,1216 C,797,1216,768,1187,768,1152 L,768,704 C,768,669,797,640,832,640 L,1280,640 C,1315,640,1344,669,1344,704 C,1344,721,1337,737,1325,749 L,1181,893 L,1513,1225 C,1519,1231,1523,1240,1523,1248 Z"},eye_open:{advanceWidth:1792,commands:"M,1664,576 C,1493,312,1217,128,896,128 C,575,128,299,312,128,576 C,223,723,353,849,509,929 C,469,861,448,783,448,704 C,448,457,649,256,896,256 C,1143,256,1344,457,1344,704 C,1344,783,1323,861,1283,929 C,1439,849,1569,723,1664,576 M,944,960 C,944,934,922,912,896,912 C,782,912,688,818,688,704 C,688,678,666,656,640,656 C,614,656,592,678,592,704 C,592,871,729,1008,896,1008 C,922,1008,944,986,944,960 M,1792,576 C,1792,601,1784,624,1772,645 C,1588,947,1251,1152,896,1152 C,541,1152,204,947,20,645 C,8,624,0,601,0,576 C,0,551,8,528,20,507 C,204,205,541,0,896,0 C,1251,0,1588,204,1772,507 C,1784,528,1792,551,1792,576 Z"},eye_close:{advanceWidth:1792,commands:"M,555,201 C,379,280,232,415,128,576 C,223,723,353,849,509,929 C,469,861,448,783,448,704 C,448,561,517,426,633,342 M,944,960 C,944,934,922,912,896,912 C,782,912,688,819,688,704 C,688,678,666,656,640,656 C,614,656,592,678,592,704 C,592,871,729,1008,896,1008 C,922,1008,944,986,944,960 M,1307,1151 C,1307,1162,1301,1172,1291,1178 C,1270,1190,1176,1248,1158,1248 C,1146,1248,1136,1242,1130,1232 L,1076,1135 C,1017,1146,956,1152,896,1152 C,527,1152,218,949,20,645 C,7,625,0,600,0,576 C,0,551,7,527,20,507 C,135,327,298,177,492,89 C,482,72,448,18,448,2 C,448,-10,454,-20,464,-26 C,485,-38,580,-96,598,-96 C,609,-96,620,-90,626,-80 L,675,9 C,886,386,1095,765,1306,1142 C,1307,1144,1307,1149,1307,1151 M,1344,704 C,1344,732,1341,760,1336,788 L,1056,286 C,1229,352,1344,518,1344,704 M,1792,576 C,1792,602,1785,623,1772,645 C,1694,774,1569,899,1445,982 L,1382,870 C,1495,792,1590,691,1664,576 C,1508,334,1261,157,970,132 L,896,0 C,1197,0,1467,137,1663,362 C,1702,407,1741,456,1772,507 C,1785,529,1792,550,1792,576 Z"},folder_open:{advanceWidth:1920,commands:"M,1879,584 C,1879,629,1828,640,1792,640 L,704,640 C,616,640,498,586,440,518 L,104,122 C,88,104,73,80,73,56 C,73,11,124,0,160,0 L,1248,0 C,1336,0,1454,54,1512,122 L,1848,518 C,1864,536,1879,560,1879,584 M,1536,928 C,1536,1051,1435,1152,1312,1152 L,768,1152 L,768,1184 C,768,1307,667,1408,544,1408 L,224,1408 C,101,1408,0,1307,0,1184 L,0,224 C,0,216,1,207,1,199 L,6,205 L,343,601 C,424,697,579,768,704,768 L,1536,768 Z"},signin:{advanceWidth:1536,commands:"M,1184,640 C,1184,657,1177,673,1165,685 L,621,1229 C,609,1241,593,1248,576,1248 C,541,1248,512,1219,512,1184 L,512,896 L,64,896 C,29,896,0,867,0,832 L,0,448 C,0,413,29,384,64,384 L,512,384 L,512,96 C,512,61,541,32,576,32 C,593,32,609,39,621,51 L,1165,595 C,1177,607,1184,623,1184,640 M,1536,992 C,1536,1151,1407,1280,1248,1280 L,928,1280 C,883,1280,896,1212,896,1184 C,896,1147,935,1152,960,1152 L,1248,1152 C,1336,1152,1408,1080,1408,992 L,1408,288 C,1408,200,1336,128,1248,128 L,928,128 C,883,128,896,60,896,32 C,896,15,911,0,928,0 L,1248,0 C,1407,0,1536,129,1536,288 Z"},upload_alt:{advanceWidth:1664,commands:"M,1280,64 C,1280,29,1251,0,1216,0 C,1181,0,1152,29,1152,64 C,1152,99,1181,128,1216,128 C,1251,128,1280,99,1280,64 M,1536,64 C,1536,29,1507,0,1472,0 C,1437,0,1408,29,1408,64 C,1408,99,1437,128,1472,128 C,1507,128,1536,99,1536,64 M,1664,288 C,1664,341,1621,384,1568,384 L,1141,384 C,1114,310,1043,256,960,256 L,704,256 C,621,256,550,310,523,384 L,96,384 C,43,384,0,341,0,288 L,0,-32 C,0,-85,43,-128,96,-128 L,1568,-128 C,1621,-128,1664,-85,1664,-32 M,1339,936 C,1349,959,1344,987,1325,1005 L,877,1453 C,865,1466,848,1472,832,1472 C,816,1472,799,1466,787,1453 L,339,1005 C,320,987,315,959,325,936 C,335,912,358,896,384,896 L,640,896 L,640,448 C,640,413,669,384,704,384 L,960,384 C,995,384,1024,413,1024,448 L,1024,896 L,1280,896 C,1306,896,1329,912,1339,936 Z"},save:{advanceWidth:1536,commands:"M,384,0 L,384,384 L,1152,384 L,1152,0 M,1280,0 L,1280,416 C,1280,469,1237,512,1184,512 L,352,512 C,299,512,256,469,256,416 L,256,0 L,128,0 L,128,1280 L,256,1280 L,256,864 C,256,811,299,768,352,768 L,928,768 C,981,768,1024,811,1024,864 L,1024,1280 C,1044,1280,1083,1264,1097,1250 L,1378,969 C,1391,956,1408,915,1408,896 L,1408,0 M,896,928 C,896,911,881,896,864,896 L,672,896 C,655,896,640,911,640,928 L,640,1248 C,640,1265,655,1280,672,1280 L,864,1280 C,881,1280,896,1265,896,1248 L,896,928 M,1536,896 C,1536,949,1506,1022,1468,1060 L,1188,1340 C,1150,1378,1077,1408,1024,1408 L,96,1408 C,43,1408,0,1365,0,1312 L,0,-32 C,0,-85,43,-128,96,-128 L,1440,-128 C,1493,-128,1536,-85,1536,-32 Z"},undo:{advanceWidth:1536,commands:"M,1536,640 C,1536,1063,1191,1408,768,1408 C,571,1408,380,1329,239,1196 L,109,1325 C,91,1344,63,1349,40,1339 C,16,1329,0,1306,0,1280 L,0,832 C,0,797,29,768,64,768 L,512,768 C,538,768,561,784,571,808 C,581,831,576,859,557,877 L,420,1015 C,513,1102,637,1152,768,1152 C,1050,1152,1280,922,1280,640 C,1280,358,1050,128,768,128 C,609,128,462,200,364,327 C,359,334,350,338,341,339 C,332,339,323,336,316,330 L,179,192 C,168,181,167,162,177,149 C,323,-27,539,-128,768,-128 C,1191,-128,1536,217,1536,640 Z"},paste:{advanceWidth:1792,commands:"M,768,-128 L,768,1024 L,1152,1024 L,1152,608 C,1152,555,1195,512,1248,512 L,1664,512 L,1664,-128 M,1024,1312 C,1024,1295,1009,1280,992,1280 L,288,1280 C,271,1280,256,1295,256,1312 L,256,1376 C,256,1393,271,1408,288,1408 L,992,1408 C,1009,1408,1024,1393,1024,1376 L,1024,1312 M,1280,640 L,1280,939 L,1579,640 M,1792,512 C,1792,565,1762,638,1724,676 L,1316,1084 C,1305,1095,1293,1104,1280,1112 L,1280,1440 C,1280,1493,1237,1536,1184,1536 L,96,1536 C,43,1536,0,1493,0,1440 L,0,96 C,0,43,43,0,96,0 L,640,0 L,640,-160 C,640,-213,683,-256,736,-256 L,1696,-256 C,1749,-256,1792,-213,1792,-160 Z"},folder_open_alt:{advanceWidth:1920,commands:"M,1781,605 C,1781,590,1772,577,1763,566 L,1469,203 C,1435,161,1365,128,1312,128 L,224,128 C,202,128,171,135,171,163 C,171,178,180,191,189,203 L,483,566 C,517,607,587,640,640,640 L,1728,640 C,1750,640,1781,633,1781,605 M,640,768 C,549,768,442,717,384,646 L,128,331 L,128,1184 C,128,1237,171,1280,224,1280 L,544,1280 C,597,1280,640,1237,640,1184 L,640,1120 C,640,1067,683,1024,736,1024 L,1312,1024 C,1365,1024,1408,981,1408,928 L,1408,768 M,1909,605 C,1909,629,1904,652,1894,673 C,1864,737,1796,768,1728,768 L,1536,768 L,1536,928 C,1536,1051,1435,1152,1312,1152 L,768,1152 L,768,1184 C,768,1307,667,1408,544,1408 L,224,1408 C,101,1408,0,1307,0,1184 L,0,224 C,0,101,101,0,224,0 L,1312,0 C,1402,0,1511,52,1568,122 L,1863,485 C,1890,519,1909,561,1909,605 Z"}}}},{}],14:[function(e,t,i){var m=e("./font.json"),f=e("../theme"),v=e("../utils").style;function r(o,n,t,e){var r=document.createElement("button");v(r,{padding:"0.2em 0.4em",margin:"0em",background:"none",outline:"none",fontSize:"16px",border:"none",borderRadius:"0.2em"});var a=document.createElement("canvas"),s=a.getContext("2d");r.appendChild(a),this.ctx=s,this.dom=r,this.canvas=a;var l=this;this.size=o;var c=1;this.resize=function(){c=window.devicePixelRatio;var e=o,t=m.fonts[n];a.height=e*c,a.style.height=e+"px";var i=e/m.unitsPerEm,r=t.advanceWidth*i+.5|0;r+=2,e+=2,a.width=r*c,a.style.width=r+"px",s.fillStyle=f.c,l.draw()},e&&e.on("resize",this.resize),this.setSize=function(e){o=e,this.resize()},this.setIcon=function(e){l.icon=e,m.fonts[e]||console.error("Font icon not found!"),this.resize()},this.onClick=function(e){r.addEventListener("click",e)};var h;this.onLongHold=function(t){function e(e){e.preventDefault(),e.stopPropagation(),h=setTimeout(function(){h&&t()},500)}function i(){clearTimeout(h)}r.addEventListener("mousedown",e),r.addEventListener("touchstart",e),r.addEventListener("mouseup",i),r.addEventListener("mouseout",i),r.addEventListener("touchend",i)},this.setTip=function(e){t=e};var i={border:"1px solid "+f.b},u={border:"1px solid transparent"},d="none",p=(f.c,f.b);r.style.background=d,v(r,u),r.addEventListener("mouseover",function(){v(r,i),s.fillStyle=f.d,s.shadowColor=f.b,s.shadowBlur=.5*c,s.shadowOffsetX=1*c,s.shadowOffsetY=1*c,l.draw(),t&&e&&e.fire("status",t)}),r.addEventListener("mousedown",function(){r.style.background=p}),r.addEventListener("mouseup",function(){r.style.background=d,v(r,i)}),r.addEventListener("mouseout",function(){r.style.background=d,v(r,u),l.dropshadow=!1,s.fillStyle=f.c,s.shadowColor=null,s.shadowBlur=0,s.shadowOffsetX=0,s.shadowOffsetY=0,l.draw()}),n&&this.setIcon(n)}r.prototype.CMD_MAP={M:"moveTo",L:"lineTo",Q:"quadraticCurveTo",C:"bezierCurveTo",Z:"closePath"},r.prototype.draw=function(){if(this.icon){var e=this.ctx,t=m.fonts[this.icon],i=this.size,r=window.devicePixelRatio,o=i/m.unitsPerEm*r,n=t.commands.split(" ");if(e.save(),e.clearRect(0,0,this.canvas.width*r,this.canvas.height*r),this.dropshadow){e.save(),e.fillStyle=f.b,e.translate(1.5*r,1.5*r),e.scale(o,-o),e.translate(0,-m.ascender),e.beginPath();for(var a=0,s=n.length;a<s;a++){var l=(c=n[a].split(",")).slice(1);e[this.CMD_MAP[c[0]]].apply(e,l)}e.fill(),e.restore()}e.scale(o,-o),e.translate(0,-m.ascender),e.beginPath();for(a=0,s=n.length;a<s;a++){var c;l=(c=n[a].split(",")).slice(1);e[this.CMD_MAP[c[0]]].apply(e,l)}e.fill(),e.restore()}},t.exports=r},{"../theme":8,"../utils":12,"./font.json":13}],15:[function(e,t,i){var c=e("../theme"),h=e("do.js"),u=e("../utils").style,d=e("../utils").handleDrag;t.exports=function(e){var o=void 0===(e=e||{}).min?-1/0:e.min,n=e.step||.1,t=e.precision||3,i=document.createElement("input");u(i,{textAlign:"center",fontSize:"10px",padding:"1px",cursor:"ns-resize",width:"40px",margin:0,marginRight:"10px",appearance:"none",outline:"none",border:0,background:"none",borderBottom:"1px dotted "+c.c,color:c.c});var a,s=this,l=0;function r(){s.onChange.fire(l)}this.onChange=new h,i.addEventListener("change",function(e){l=parseFloat(i.value,10),r()}),d(i,function(e){a=l},function(e){var t=e.dx,i=e.dy,r=1*n;l=a+t*r+i*-r,l=Math.max(o,l),s.onChange.fire(l,!0)},function(e){e.moved?r():i.focus()}),this.dom=i,this.setValue=function(e){l=e},this.paint=function(){null!=l&&(i.value=l.toFixed(t))}}},{"../theme":8,"../utils":12,"do.js":1}],16:[function(e,t,i){var m=e("do.js"),f=e("../utils"),v={position:"absolute",background:"-webkit-gradient(linear, left top, right top, color-stop(0, rgb(29,29,29)), color-stop(0.6, rgb(50,50,50)) )",border:"1px solid rgb(29, 29, 29)",textAlign:"center",cursor:"pointer"},y={background:"-webkit-gradient(linear, left top, right top, color-stop(0.2, rgb(88,88,88)), color-stop(0.6, rgb(64,64,64)) )",border:"1px solid rgb(25,25,25)",position:"relative",borderRadius:"6px"};t.exports=function(t,e,i){var r=e||12,o=r+6,n=document.createElement("div");f.style(n,v);var a=t-2;n.style.height=a+"px",n.style.width=o+"px";var s=document.createElement("div");f.style(s,y),s.style.width=r+"px",s.style.height=t/2,s.style.top=0,s.style.left="3px",n.appendChild(s);var l,c,h,u=this;function d(e){e.preventDefault();var t=a-l,i=(e.clientY-h)/t;1<i&&(i=1),i<0&&(i=0),u.setPosition(i),u.onScroll.fire("scrollto",i)}function p(e){d(e),document.removeEventListener("mousemove",d,!1),document.removeEventListener("mouseup",p,!1)}this.setLength=function(e){e=Math.max(Math.min(1,e),0),e*=a,l=Math.max(e,25),s.style.height=l+"px"},this.setHeight=function(e){a=(t=e)-2,n.style.height=a+"px"},this.setPosition=function(e){e=Math.max(Math.min(1,e),0),c=e*(a-l),s.style.top=c},this.setLength(1),this.setPosition(0),this.onScroll=new m,n.addEventListener("mousedown",function(e){e.preventDefault(),e.target==s?(h=e.clientY,document.addEventListener("mousemove",d,!1),document.addEventListener("mouseup",p,!1)):e.clientY<c?u.onScroll.fire("pageup"):e.clientY>c+l&&u.onScroll.fire("pagedown")},!1),this.dom=n}},{"../utils":12,"do.js":1}]},{},[3,4,5,6,7,8,9,10,11,12]),ParticleEmitter.prototype=Object.create(TONG.Points.prototype),ParticleEmitter.defaultEmitter={particleCount:200,velocity:{value:new TONG.Vector3(0,0,0),spread:new TONG.Vector3(3,3,3)},acceleration:{value:new TONG.Vector3(0,0,0),spread:new TONG.Vector3(0,0,0)}},ParticleEmitter.defaultGroup={texture:{value:(new TONG.TextureLoader).load("./imgs/particle/particle.png")},maxParticleCount:200,blending:TONG.AdditiveBlending,fog:!1,depthWrite:!1,depthTest:!0,transparent:!0,hasPerspective:!0},ParticleEmitter.prototype.reload=function(){this.dispose();var e=this.children;this.children=[];var t=(new ObjectLoader).parse(this.toJSON());this.children=e,this.group=t.group,this.emitter=t.emitter,this.geometry=this.group.geometry,this.material=this.group.material},ParticleEmitter.prototype.updateMatrix=function(){this.dynamicEmitter?(this.matrix.makeRotationFromQuaternion(this.quaternion),this.matrix.scale(this.scale)):this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0},ParticleEmitter.prototype.onBeforeRender=function(e,t,i,r){this.group.uniforms.scale.value=e.getCurrentViewport().w,this.group.tick(this.clock.getDelta()),this.dynamicEmitter&&(this.emitter.position.value=this.position)},ParticleEmitter.prototype.dispose=function(){this.group.dispose()},ParticleEmitter.prototype.toJSON=function(e){var t=TONG.Object3D.prototype.toJSON.call(this,e),i=this.material,r=this.geometry;this.material=void 0,this.geometry=void 0;var o=this.group.texture;return o=o.toJSON(e),this.material=i,this.geometry=r,t.object.group=this.group.toJSON(e),t.object.emitter=this.emitter.toJSON(e),t},ParticleSystem.Group.prototype.toJSON=function(e){var t={texture:{}};return t.texture.value=this.texture.uuid,t.texture.frames=this.textureFrames.toArray(),t.texture.frameCount=this.textureFrameCount,t.texture.loop=this.textureLoop,t.fixedTimeStep=this.fixedTimeStep,t.hasPerspective=this.hasPerspective,t.colorize=this.colorize,t.maxParticleCount=this.maxParticleCount,t.transparent=this.transparent,t.blending=this.blending,t.alphaTest=this.alphaTest,t.depthWrite=this.depthWrite,t.depthTest=this.depthTest,t.fog=this.fog,t.scale=this.scale,t},ParticleSystem.Emitter.prototype.toJSON=function(e){var t={};t.uuid=this.uuid,t.type=this.type,t.direction=this.direction,t.particleCount=this.particleCount,t.duration=this.duration,t.isStatic=this.isStatic,t.maxAge={},t.maxAge.value=this.maxAge.value,t.maxAge.spread=this.maxAge.spread,t.position={},t.position.value=this.position.value.toArray(),t.position.spread=this.position.spread.toArray(),t.position.radius=this.position.radius,t.position.radiusScale=this.position.radiusScale.toArray(),t.velocity={},t.velocity.value=this.velocity.value.toArray(),t.velocity.spread=this.velocity.spread.toArray(),t.acceleration={},t.acceleration.value=this.acceleration.value.toArray(),t.acceleration.spread=this.acceleration.spread.toArray(),t.wiggle={},t.wiggle.value=this.wiggle.value,t.wiggle.spread=this.wiggle.spread,t.opacity={},t.opacity.value=this.opacity.value.slice(0),t.opacity.spread=this.opacity.spread,t.size={},t.size.value=this.size.value.slice(0),t.size.spread=this.size.spread,t.angle={},t.angle.value=this.angle.value.slice(0),t.angle.spread=this.angle.spread,t.color={},t.color.value=[];for(var i=0;i<this.color.value.length;i++)t.color.value.push(this.color.value[i].getHex());t.color.spread=[];for(i=0;i<this.color.spread.length;i++)t.color.spread.push(this.color.spread[i].toArray());return t};var AnimationModule={name:"Timeline",enabled:!0,render_helpers:!0,_trajectories:[],tabs:{},currentTab:null,init:function(){},getSelectWidget:function(){for(var e in this.tabs)if(this.tabs[e].widget.isSelect)return this.tabs[e].widget;return null},createTimeline:function(e){var t=!1;for(var i in this.tabs)e.filename==i&&(this.tabs[i].widget.isClose?(this.tab=InterfaceModule.lower_tabs_widget.addWidgetTab(TimelineWidget),this.timeline=this.tab.widget,this.tabs[e.filename]=this.tab,this.timeline.createWidgets(this.timeline.timeController,e)):(this.tabs[e.filename].click(),this.tab=this.tabs[e.filename],this.timeline=this.tab.widget),t=!0);t||(this.tab=InterfaceModule.lower_tabs_widget.addWidgetTab(TimelineWidget),this.timeline=this.tab.widget,this.tabs[e.filename]=this.tab,this.timeline.createWidgets(this.timeline.timeController,e)),this.currentTab=this.tab,this.timeline.onShow()},showTimeline:function(e){this.createTimeline(e),e&&this.timeline.setAnimation(e)},attachKeyframesBehaviour:function(e){for(var t=e.root.querySelectorAll(".keyframe_icon"),i=0;i<t.length;i++){var r=t[i];r.getAttribute("data-propertyuid").split(".")[0];r.getAttribute("is_event")||(r.draggable=!0,r.addEventListener("click",o),r.addEventListener("dragstart",n),r.addEventListener("drop",a),r.setAttribute("is_event",!0))}function o(e){return AnimationModule.insertKeyframe(e.target,e.shiftKey),e.preventDefault(),e.stopPropagation(),!0}function n(e){e.dataTransfer.setData("type","property"),e.dataTransfer.setData("uid",e.target.dataset.propertyuid);var t=e.target.dataset.propertyuid;e.shiftKey&&(t=LSQ.shortify(t)),e.dataTransfer.setData("locator",t)}function a(e){EditorModule.getSceneElementFromDropEvent(e)}},copyQueryToClipboard:function(e,t){t&&(e=LSQ.shortify(e)),LiteGUI.toClipboard(e)},showPropertyInfo:function(t){var e=LS.GlobalScene.getPropertyInfo(t);if(e){var i=new LiteGUI.Dialog("property_info",{title:"Property Info",width:400,draggable:!0,closable:!0}),r=new LiteGUI.Inspector;r.addString("Locator",t,function(e){});r.addString("Short Locator",LSQ.shortify(t),function(e){}),r.widgets_per_row=2,r.addString("Parent",e.node?e.node.name:"",{disabled:!0}),r.addString("Container",e.target?LS.getObjectClassName(e.target):"",{disabled:!0}),r.addString("Property",e.name,{disabled:!0}),r.addString("Type",e.type,{disabled:!0}),r.widgets_per_row=1,"number"==e.type?r.addNumber("Value",e.value,o):"boolean"==e.type?r.addCheckbox("Value",e.value,o):"vec2"==e.type?r.addVector2("Value",e.value,o):"vec3"==e.type?r.addVector3("Value",e.value,o):"texture"==e.type?r.addTexture("Value",e.value,o):"mesh"==e.type?r.addMesh("Value",e.value,o):r.addString("Value",e.value,o),r.addButtons(null,["Close"],function(e){i.close()}),i.add(r),i.adjustSize(),i.show()}function o(e){LS.GlobalScene.setPropertyValue(t,e),LS.GlobalScene.refresh()}},getKeyframeCode:function(e,t,i){if(!e)return"";var r=e,o=e.split("."),n=null==i||i&&i.visible||i&&void 0===i.visible?"visible":"hidden",a=EditorModule.target.objectByUuid(o[0]);return"undefined"==o[0]||a==EditorModule.target.scene?(n="hidden",""):r?"<span  style='visibility:"+n+"' title='"+GetLanguage("Create keyframe for ")+GetLanguage(t)+"' class='keyframe_icon' data-propertyname='"+t+"' data-propertyuid='"+r+"."+t+"' ></span>":""},insertKeyframe:function(e,t){var i=!1;for(var r in this.tabs){var o=this.tabs[r].widget;o&&o.isSelect&&(i=!0,o.onInsertKeyframeButton(e,t))}if(!i){var n=LiteGUI.alert(GetLanguage("To add animation frames, select the timeline animation editor or create the animation file immediately?"),{noclose:!0,draggable:!0,buttons:[{name:GetLanguage("OK"),callback:function(){n.close(),DriveModule.showAnimationDialog({filename:"animation.anim",folder:null},function(e){DriveModule.addResourceCommand(e),AnimationModule.showTimeline(e)})}},{name:GetLanguage("Cancel"),close:!0}],title:GetLanguage("Select Timeline Or Create")});document.body.appendChild(n.root)}},renderView:function(e,t){if(EditorView.render_helpers&&this.render_helpers&&!RenderModule.render_settings.in_player&&RenderModule.frame_updated&&this.timeline.show_paths){var i=this.timeline.root.getBoundingClientRect();i.width&&i.height&&this.renderTrajectories(t)}},renderPicking:function(e,t){if(EditorView.render_helpers&&this._trajectories.length){vec3.create();for(var i=this.onTrajectoryKeyframeClicked.bind(this),r=0;r<this._trajectories.length;++r){var o=this._trajectories[r],n=LS.GlobalScene.getPropertyInfoFromPath(o.track._property_path);if(n){var a=null;n.node&&n.node.parentNode&&n.node.parentNode.transform&&(a=n.node.parentNode.transform.getGlobalMatrixRef());for(var s=o.points,l=s.length,c=0;c<l;++c){var h=s[c];a&&(h=vec3.transformMat4(vec3.create(),h,a)),EditorView.addPickingPoint(h,10,{pos:h,value:s[c],type:"keyframe",traj:r,instance:this,take:this.timeline.current_take,track:o.index,num:c,callback:i})}}}}},renderTrajectories:function(e){if(LS.Renderer.resetGLState(),this.timeline.current_take){var t=this.timeline.current_take;if(0!=t.tracks.length){var i=SelectionModule.getSelection();i&&"keyframe"==i.type||(i=null);for(var r=[1,1,1,1],o=[.5,.6,.5,1],n=[1,1,.5,1],a=this._trajectories.length=0;a<t.tracks.length;++a){var s=t.tracks[a];if(("position"==s.type||"vec3"==s.type)&&s.enabled){var l=s.getNumberOfKeyframes(),c=[],h=null;i&&i.track==a&&(h=[]);var u=LS.GlobalScene.getPropertyInfoFromPath(s._property_path);if(u){var d=null;u.node&&u.node.parentNode&&u.node.parentNode.transform&&(d=u.node.parentNode,LS.Draw.push(),LS.Draw.setMatrix(d.transform.getGlobalMatrixRef()));for(var p=0;p<l;++p){if(v=s.getKeyframe(p)){0==p?v[0]:p==l-1&&v[0];var m=v[1];c.push(m),h&&h.push(p==i.index?n:o)}}if(LS.Draw.setColor(h?r:o),LS.Draw.setPointSize(4),LS.Draw.renderPoints(c,h),this._trajectories.push({index:a,points:c,track:s}),s.interpolation!=LS.Animation.NONE)if(s.interpolation!=LS.Animation.LINEAR){c=[];var f=null;for(p=0;p<l;++p){var v;if(v=s.getKeyframe(p)){if(f)for(var y=f[0],g=v[0],x=Math.max(2,10*(g-y)),w=(g-y)/x,b=0;b<=x;++b){var T=y+w*b,S=s.getSample(T,!0,vec3.create());S&&c.push(S)}f=v}}1<c.length&&(LS.Draw.setColor(o),LS.Draw.renderLines(c,null,!1)),d&&LS.Draw.pop()}else 1<c.length&&LS.Draw.renderLines(c,null,!0)}}}}}},onTrajectoryKeyframeClicked:function(e,t){this.timeline.selectKeyframe(e.track,e.num)},getTransformMatrix:function(e,t,i){if(!this._trajectories.length)return!1;var r=t||mat4.create();return mat4.setTranslation(r,i.pos),r},applyTransformMatrix:function(e,t,i,r){if(!this._trajectories.length)return!1;var o=this._trajectories[r.traj];if(!o)return null;var n=o.points[r.num];return vec3.transformMat4(n,n,e),r.pos!=r.value&&vec3.transformMat4(r.pos,r.pos,e),this.timeline.applyTracks(),!0},update:function(e){this.timeline&&this.timeline.update(e)}};function MathUtils(){}function Scene(){TONG._Scene.call(this),this.name="scene",this.matrixAutoUpdate=!1,this.usePhysics=!0,this.world=new CANNON.World,this.world.defaultContactMaterial.contactEquationStiffness=1e9,this.world.defaultContactMaterial.contactEquationRelaxation=4,this.world.quatNormalizeSkip=0,this.world.quatNormalizeFast=!1,this.world.gravity.set(0,-9.8,0),this.world.broadphase=new CANNON.NaiveBroadphase,this.world.solver=new CANNON.SplitSolver(new CANNON.GSSolver),this.world.solver.tolerance=.05,this.world.solver.iterations=7,this.background=new TONG.Color(0),this.cameras=[],this.directionalLights=[],this.raycaster=new TONG.Raycaster,this.clock=new TONG.Clock,this.delta=0,this.canvas=null,this.mouse=new Mouse,this.keyboard=new Keyboard,this.mouseNormalized=new TONG.Vector2(0,0),this.renderer=null}function PhysicsObject(){TONG.Group.call(this),this.name="physics",this.type="Physics",this.body=new CANNON.Body,this.body.type=CANNON.Body.DYNAMIC,this.body.mass=1,this.world=null}function PhysicsObjectHelper(e,t){TONG.Object3D.call(this),this.type="PhysicsHelper",this.obj=e,this.meshes=[],this.material=new TONG.LineBasicMaterial({color:void 0!==t?t:65280,linewidth:1,opacity:.5,transparent:!0}),this.tmpVec0=new CANNON.Vec3,this.tmpVec1=new CANNON.Vec3,this.tmpVec2=new CANNON.Vec3,this.tmpQuat0=new CANNON.Vec3,this.tmpScale=new CANNON.Vec3(1,1,1),this.tmpPosition=new CANNON.Vec3(0,0,0),this.update()}function PhysicsGenerator(){}CORE.registerModule(AnimationModule),MathUtils.pi2=2*Math.PI,MathUtils.pid3=Math.PI/3,MathUtils.pid2=Math.PI/2,MathUtils.randomColor=function(){for(var e="#",t=0;t<6;t++)e+="0123456789ABCDEF"[Math.floor(16*Math.random())];return e},TONG.Sky=function(){var e=TONG.Sky.SkyShader,t=new TONG.ShaderMaterial({fragmentShader:e.fragmentShader,vertexShader:e.vertexShader,uniforms:TONG.UniformsUtils.clone(e.uniforms),side:TONG.BackSide}),i=new TONG.SphereBufferGeometry(1,32,15);TONG.Mesh.call(this,i,t),this.name="sky",this.type="Sky",this.distance=1500,this.scale.setScalar(this.distance),this.sun=new TONG.DirectionalLight(16777181,.3),this.sun.castShadow=!0,this.sun.position.y=1e3,this.sun.lookAt(new TONG.Vector3),this.add(this.sun),this.ambient=new TONG.AmbientLight(15592941),this.add(this.ambient),this.inclination=.25,this.azimuth=.25,this.turbidity=1,this.rayleigh=.25,this.luminance=1,this.mieCoefficient=.005,this.mieDirectionalG=.8,this.updateSky()},TONG.Sky.prototype=Object.create(TONG.Mesh.prototype),TONG.Sky.prototype.constructor=TONG.Sky,TONG.Sky.prototype.updateSky=function(){this.scale.setScalar(this.distance);var e=Math.PI*(this.inclination-.5),t=2*Math.PI*(this.azimuth-.5);this.sun.position.x=this.distance*Math.cos(t),this.sun.position.y=this.distance*Math.sin(t)*Math.sin(e),this.sun.position.z=this.distance*Math.sin(t)*Math.cos(e),this.material.uniforms.sunPosition.value.copy(this.sun.position),this.material.uniforms.turbidity.value=this.turbidity,this.material.uniforms.rayleigh.value=this.rayleigh,this.material.uniforms.luminance.value=this.luminance,this.material.uniforms.mieCoefficient.value=this.mieCoefficient,this.material.uniforms.mieDirectionalG.value=this.mieDirectionalG,this.material.needsUpdate=!0},TONG.Sky.prototype.toJSON=function(e){var t=TONG.Mesh.prototype.toJSON.call(this,e);for(var i in delete t.object.geometry,delete t.object.material,delete t.object.children,t.object.distance=this.distance,t.object.inclination=this.inclination,t.object.azimuth=this.azimuth,t.object.turbidity=this.turbidity,t.object.rayleigh=this.rayleigh,t.object.luminance=this.luminance,t.object.mieCoefficient=this.mieCoefficient,t.object.mieDirectionalG=this.mieDirectionalG,t.object.castShadow=this.sun.castShadow,t.object.intensity=this.sun.intensity,e.geometries)i==this.geometry.uuid&&delete e.geometries[i];for(var i in e.materials)i==this.material.uuid&&delete e.materials[i];return t},TONG.Sky.SkyShader={uniforms:{luminance:{value:1},turbidity:{value:10},rayleigh:{value:2},mieCoefficient:{value:.005},mieDirectionalG:{value:.8},sunPosition:{value:new TONG.Vector3(0,7e5,0)}},vertexShader:["uniform vec3 sunPosition;","uniform float rayleigh;","uniform float turbidity;","uniform float mieCoefficient;","varying vec3 vWorldPosition;","varying vec3 vSunDirection;","varying float vSunfade;","varying vec3 vBetaR;","varying vec3 vBetaM;","varying float vSunE;","const vec3 up = vec3( 0.0, 1.0, 0.0 );","const float e = 2.71828182845904523536028747135266249775724709369995957;","const float pi = 3.141592653589793238462643383279502884197169;","const vec3 lambda = vec3( 680E-9, 550E-9, 450E-9 );","const vec3 totalRayleigh = vec3( 5.804542996261093E-6, 1.3562911419845635E-5, 3.0265902468824876E-5 );","const float v = 4.0;","const vec3 K = vec3( 0.686, 0.678, 0.666 );","const vec3 MieConst = vec3( 1.8399918514433978E14, 2.7798023919660528E14, 4.0790479543861094E14 );","const float cutoffAngle = 1.6110731556870734;","const float steepness = 1.5;","const float EE = 1000.0;","float sunIntensity( float zenithAngleCos ) {","\tzenithAngleCos = clamp( zenithAngleCos, -1.0, 1.0 );","\treturn EE * max( 0.0, 1.0 - pow( e, -( ( cutoffAngle - acos( zenithAngleCos ) ) / steepness ) ) );","}","vec3 totalMie( float T ) {","\tfloat c = ( 0.2 * T ) * 10E-18;","\treturn 0.434 * c * MieConst;","}","void main() {","\tvec4 worldPosition = modelMatrix * vec4( position, 1.0 );","\tvWorldPosition = worldPosition.xyz;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","\tvSunDirection = normalize( sunPosition );","\tvSunE = sunIntensity( dot( vSunDirection, up ) );","\tvSunfade = 1.0 - clamp( 1.0 - exp( ( sunPosition.y / 450000.0 ) ), 0.0, 1.0 );","\tfloat rayleighCoefficient = rayleigh - ( 1.0 * ( 1.0 - vSunfade ) );","\tvBetaR = totalRayleigh * rayleighCoefficient;","\tvBetaM = totalMie( turbidity ) * mieCoefficient;","}"].join("\n"),fragmentShader:["varying vec3 vWorldPosition;","varying vec3 vSunDirection;","varying float vSunfade;","varying vec3 vBetaR;","varying vec3 vBetaM;","varying float vSunE;","uniform float luminance;","uniform float mieDirectionalG;","const vec3 cameraPos = vec3( 0.0, 0.0, 0.0 );","const float pi = 3.141592653589793238462643383279502884197169;","const float n = 1.0003;","const float N = 2.545E25;","const float rayleighZenithLength = 8.4E3;","const float mieZenithLength = 1.25E3;","const vec3 up = vec3( 0.0, 1.0, 0.0 );","const float sunAngularDiameterCos = 0.999956676946448443553574619906976478926848692873900859324;","const float THREE_OVER_SIXTEENPI = 0.05968310365946075;","const float ONE_OVER_FOURPI = 0.07957747154594767;","float rayleighPhase( float cosTheta ) {","\treturn THREE_OVER_SIXTEENPI * ( 1.0 + pow( cosTheta, 2.0 ) );","}","float hgPhase( float cosTheta, float g ) {","\tfloat g2 = pow( g, 2.0 );","\tfloat inverse = 1.0 / pow( 1.0 - 2.0 * g * cosTheta + g2, 1.5 );","\treturn ONE_OVER_FOURPI * ( ( 1.0 - g2 ) * inverse );","}","const float A = 0.15;","const float B = 0.50;","const float C = 0.10;","const float D = 0.20;","const float E = 0.02;","const float F = 0.30;","const float whiteScale = 1.0748724675633854;","vec3 Uncharted2Tonemap( vec3 x ) {","\treturn ( ( x * ( A * x + C * B ) + D * E ) / ( x * ( A * x + B ) + D * F ) ) - E / F;","}","void main() {","\tfloat zenithAngle = acos( max( 0.0, dot( up, normalize( vWorldPosition - cameraPos ) ) ) );","\tfloat inverse = 1.0 / ( cos( zenithAngle ) + 0.15 * pow( 93.885 - ( ( zenithAngle * 180.0 ) / pi ), -1.253 ) );","\tfloat sR = rayleighZenithLength * inverse;","\tfloat sM = mieZenithLength * inverse;","\tvec3 Fex = exp( -( vBetaR * sR + vBetaM * sM ) );","\tfloat cosTheta = dot( normalize( vWorldPosition - cameraPos ), vSunDirection );","\tfloat rPhase = rayleighPhase( cosTheta * 0.5 + 0.5 );","\tvec3 betaRTheta = vBetaR * rPhase;","\tfloat mPhase = hgPhase( cosTheta, mieDirectionalG );","\tvec3 betaMTheta = vBetaM * mPhase;","\tvec3 Lin = pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * ( 1.0 - Fex ), vec3( 1.5 ) );","\tLin *= mix( vec3( 1.0 ), pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * Fex, vec3( 1.0 / 2.0 ) ), clamp( pow( 1.0 - dot( up, vSunDirection ), 5.0 ), 0.0, 1.0 ) );","\tvec3 direction = normalize( vWorldPosition - cameraPos );","\tfloat theta = acos( direction.y ); // elevation --\x3e y-axis, [-pi/2, pi/2]","\tfloat phi = atan( direction.z, direction.x ); // azimuth --\x3e x-axis [-pi/2, pi/2]","\tvec2 uv = vec2( phi, theta ) / vec2( 2.0 * pi, pi ) + vec2( 0.5, 0.0 );","\tvec3 L0 = vec3( 0.1 ) * Fex;","\tfloat sundisk = smoothstep( sunAngularDiameterCos, sunAngularDiameterCos + 0.00002, cosTheta );","\tL0 += ( vSunE * 19000.0 * Fex ) * sundisk;","\tvec3 texColor = ( Lin + L0 ) * 0.04 + vec3( 0.0, 0.0003, 0.00075 );","\tvec3 curr = Uncharted2Tonemap( ( log2( 2.0 / pow( luminance, 4.0 ) ) ) * texColor );","\tvec3 color = curr * whiteScale;","\tvec3 retColor = pow( color, vec3( 1.0 / ( 1.2 + ( 1.2 * vSunfade ) ) ) );","\tgl_FragColor = vec4( retColor, 1.0 );","}"].join("\n")},function(e){var t;"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():("undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self),t.CANNON=e())}(function(){return function o(n,a,s){function l(i,e){if(!a[i]){if(!n[i]){var t="function"==typeof require&&require;if(!e&&t)return t(i,!0);if(c)return c(i,!0);throw new Error("Cannot find module '"+i+"'")}var r=a[i]={exports:{}};n[i][0].call(r.exports,function(e){var t=n[i][1][e];return l(t||e)},r,r.exports,o,n,a,s)}return a[i].exports}for(var c="function"==typeof require&&require,e=0;e<s.length;e++)l(s[e]);return l}({1:[function(e,t){t.exports={name:"cannon",version:"0.6.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(e,t){t.exports={version:e("../package.json").version,AABB:e("./collision/AABB"),ArrayCollisionMatrix:e("./collision/ArrayCollisionMatrix"),Body:e("./objects/Body"),Box:e("./shapes/Box"),Broadphase:e("./collision/Broadphase"),Constraint:e("./constraints/Constraint"),ContactEquation:e("./equations/ContactEquation"),Narrowphase:e("./world/Narrowphase"),ConeTwistConstraint:e("./constraints/ConeTwistConstraint"),ContactMaterial:e("./material/ContactMaterial"),ConvexPolyhedron:e("./shapes/ConvexPolyhedron"),Cylinder:e("./shapes/Cylinder"),DistanceConstraint:e("./constraints/DistanceConstraint"),Equation:e("./equations/Equation"),EventTarget:e("./utils/EventTarget"),FrictionEquation:e("./equations/FrictionEquation"),GSSolver:e("./solver/GSSolver"),GridBroadphase:e("./collision/GridBroadphase"),Heightfield:e("./shapes/Heightfield"),HingeConstraint:e("./constraints/HingeConstraint"),LockConstraint:e("./constraints/LockConstraint"),Mat3:e("./math/Mat3"),Material:e("./material/Material"),NaiveBroadphase:e("./collision/NaiveBroadphase"),ObjectCollisionMatrix:e("./collision/ObjectCollisionMatrix"),Pool:e("./utils/Pool"),Particle:e("./shapes/Particle"),Plane:e("./shapes/Plane"),PointToPointConstraint:e("./constraints/PointToPointConstraint"),Quaternion:e("./math/Quaternion"),Ray:e("./collision/Ray"),RaycastVehicle:e("./objects/RaycastVehicle"),RaycastResult:e("./collision/RaycastResult"),RigidVehicle:e("./objects/RigidVehicle"),RotationalEquation:e("./equations/RotationalEquation"),RotationalMotorEquation:e("./equations/RotationalMotorEquation"),SAPBroadphase:e("./collision/SAPBroadphase"),SPHSystem:e("./objects/SPHSystem"),Shape:e("./shapes/Shape"),Solver:e("./solver/Solver"),Sphere:e("./shapes/Sphere"),SplitSolver:e("./solver/SplitSolver"),Spring:e("./objects/Spring"),Trimesh:e("./shapes/Trimesh"),Vec3:e("./math/Vec3"),Vec3Pool:e("./utils/Vec3Pool"),World:e("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":9,"./collision/RaycastResult":10,"./collision/SAPBroadphase":11,"./constraints/ConeTwistConstraint":12,"./constraints/Constraint":13,"./constraints/DistanceConstraint":14,"./constraints/HingeConstraint":15,"./constraints/LockConstraint":16,"./constraints/PointToPointConstraint":17,"./equations/ContactEquation":19,"./equations/Equation":20,"./equations/FrictionEquation":21,"./equations/RotationalEquation":22,"./equations/RotationalMotorEquation":23,"./material/ContactMaterial":24,"./material/Material":25,"./math/Mat3":27,"./math/Quaternion":28,"./math/Vec3":30,"./objects/Body":31,"./objects/RaycastVehicle":32,"./objects/RigidVehicle":33,"./objects/SPHSystem":34,"./objects/Spring":35,"./shapes/Box":37,"./shapes/ConvexPolyhedron":38,"./shapes/Cylinder":39,"./shapes/Heightfield":40,"./shapes/Particle":41,"./shapes/Plane":42,"./shapes/Shape":43,"./shapes/Sphere":44,"./shapes/Trimesh":45,"./solver/GSSolver":46,"./solver/Solver":47,"./solver/SplitSolver":48,"./utils/EventTarget":49,"./utils/Pool":51,"./utils/Vec3Pool":54,"./world/Narrowphase":55,"./world/World":56}],3:[function(e,t){function i(e){e=e||{},this.lowerBound=new r,e.lowerBound&&this.lowerBound.copy(e.lowerBound),this.upperBound=new r,e.upperBound&&this.upperBound.copy(e.upperBound)}var r=e("../math/Vec3");e("../utils/Utils"),t.exports=i;var c=new r;i.prototype.setFromPoints=function(e,t,i,r){var o=this.lowerBound,n=this.upperBound,a=i;o.copy(e[0]),a&&a.vmult(o,o),n.copy(o);for(var s=1;s<e.length;s++){var l=e[s];a&&(a.vmult(l,c),l=c),l.x>n.x&&(n.x=l.x),l.x<o.x&&(o.x=l.x),l.y>n.y&&(n.y=l.y),l.y<o.y&&(o.y=l.y),l.z>n.z&&(n.z=l.z),l.z<o.z&&(o.z=l.z)}return t&&(t.vadd(o,o),t.vadd(n,n)),r&&(o.x-=r,o.y-=r,o.z-=r,n.x+=r,n.y+=r,n.z+=r),this},i.prototype.copy=function(e){return this.lowerBound.copy(e.lowerBound),this.upperBound.copy(e.upperBound),this},i.prototype.clone=function(){return(new i).copy(this)},i.prototype.extend=function(e){var t=e.lowerBound.x;this.lowerBound.x>t&&(this.lowerBound.x=t);var i=e.upperBound.x;this.upperBound.x<i&&(this.upperBound.x=i);t=e.lowerBound.y;this.lowerBound.y>t&&(this.lowerBound.y=t);i=e.upperBound.y;this.upperBound.y<i&&(this.upperBound.y=i);t=e.lowerBound.z;this.lowerBound.z>t&&(this.lowerBound.z=t);i=e.upperBound.z;this.upperBound.z<i&&(this.upperBound.z=i)},i.prototype.overlaps=function(e){var t=this.lowerBound,i=this.upperBound,r=e.lowerBound,o=e.upperBound;return(r.x<=i.x&&i.x<=o.x||t.x<=o.x&&o.x<=i.x)&&(r.y<=i.y&&i.y<=o.y||t.y<=o.y&&o.y<=i.y)&&(r.z<=i.z&&i.z<=o.z||t.z<=o.z&&o.z<=i.z)},i.prototype.contains=function(e){var t=this.lowerBound,i=this.upperBound,r=e.lowerBound,o=e.upperBound;return t.x<=r.x&&i.x>=o.x&&t.y<=r.y&&i.y>=o.y&&t.z<=r.z&&i.z>=o.z},i.prototype.getCorners=function(e,t,i,r,o,n,a,s){var l=this.lowerBound,c=this.upperBound;e.copy(l),t.set(c.x,l.y,l.z),i.set(c.x,c.y,l.z),r.set(l.x,c.y,c.z),o.set(c.x,l.y,l.z),n.set(l.x,c.y,l.z),a.set(l.x,l.y,c.z),s.copy(c)};var p=[new r,new r,new r,new r,new r,new r,new r,new r];i.prototype.toLocalFrame=function(e,t){var i=p,r=i[0],o=i[1],n=i[2],a=i[3],s=i[4],l=i[5],c=i[6],h=i[7];this.getCorners(r,o,n,a,s,l,c,h);for(var u=0;8!==u;u++){var d=i[u];e.pointToLocal(d,d)}return t.setFromPoints(i)},i.prototype.toWorldFrame=function(e,t){var i=p,r=i[0],o=i[1],n=i[2],a=i[3],s=i[4],l=i[5],c=i[6],h=i[7];this.getCorners(r,o,n,a,s,l,c,h);for(var u=0;8!==u;u++){var d=i[u];e.pointToWorld(d,d)}return t.setFromPoints(i)}},{"../math/Vec3":30,"../utils/Utils":53}],4:[function(e,t){function i(){this.matrix=[]}(t.exports=i).prototype.get=function(e,t){if((e=e.index)<(t=t.index)){var i=t;t=e,e=i}return this.matrix[(e*(e+1)>>1)+t-1]},i.prototype.set=function(e,t,i){if((e=e.index)<(t=t.index)){var r=t;t=e,e=r}this.matrix[(e*(e+1)>>1)+t-1]=i?1:0},i.prototype.reset=function(){for(var e=0,t=this.matrix.length;e!==t;e++)this.matrix[e]=0},i.prototype.setNumObjects=function(e){this.matrix.length=e*(e-1)>>1}},{}],5:[function(e,t){function i(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}var r=e("../objects/Body"),o=e("../math/Vec3"),n=e("../math/Quaternion");e("../shapes/Shape"),e("../shapes/Plane"),(t.exports=i).prototype.collisionPairs=function(){throw new Error("collisionPairs not implemented for this BroadPhase class!")};var a=r.STATIC|r.KINEMATIC;i.prototype.needBroadphaseCollision=function(e,t){return 0!=(e.collisionFilterGroup&t.collisionFilterMask)&&0!=(t.collisionFilterGroup&e.collisionFilterMask)&&(0==(e.type&a)&&e.sleepState!==r.SLEEPING||0==(t.type&a)&&t.sleepState!==r.SLEEPING)},i.prototype.intersectionTest=function(e,t,i,r){this.useBoundingBoxes?this.doBoundingBoxBroadphase(e,t,i,r):this.doBoundingSphereBroadphase(e,t,i,r)};var s=new o;new o,new n,new o,i.prototype.doBoundingSphereBroadphase=function(e,t,i,r){var o=s;t.position.vsub(e.position,o);var n=Math.pow(e.boundingRadius+t.boundingRadius,2);o.norm2()<n&&(i.push(e),r.push(t))},i.prototype.doBoundingBoxBroadphase=function(e,t,i,r){e.aabbNeedsUpdate&&e.computeAABB(),t.aabbNeedsUpdate&&t.computeAABB(),e.aabb.overlaps(t.aabb)&&(i.push(e),r.push(t))};var u={keys:[]},d=[],p=[];i.prototype.makePairsUnique=function(e,t){for(var i=u,r=d,o=p,n=e.length,a=0;a!==n;a++)r[a]=e[a],o[a]=t[a];e.length=0;for(a=t.length=0;a!==n;a++){var s=r[a].id,l=o[a].id;i[c=s<l?s+","+l:l+","+s]=a,i.keys.push(c)}for(a=0;a!==i.keys.length;a++){var c=i.keys.pop(),h=i[c];e.push(r[h]),t.push(o[h]),delete i[c]}},i.prototype.setWorld=function(){};var l=new o;i.boundingSphereCheck=function(e,t){var i=l;return e.position.vsub(t.position,i),Math.pow(e.shape.boundingSphereRadius+t.shape.boundingSphereRadius,2)>i.norm2()},i.prototype.aabbQuery=function(){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Plane":42,"../shapes/Shape":43}],6:[function(e,t){function i(e,t,i,r,o){s.apply(this),this.nx=i||10,this.ny=r||10,this.nz=o||10,this.aabbMin=e||new l(100,100,100),this.aabbMax=t||new l(-100,-100,-100);var n=this.nx*this.ny*this.nz;if(n<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=n,this.binLengths.length=n;for(var a=0;a<n;a++)this.bins[a]=[],this.binLengths[a]=0}t.exports=i;var s=e("./Broadphase"),l=e("../math/Vec3"),ie=e("../shapes/Shape");(i.prototype=new s).constructor=i;var re=new l;new l,i.prototype.collisionPairs=function(e,t,i){function r(e,t,i,r,o,n,a){var s=(e-S)*N|0,l=(t-C)*A|0,c=(i-O)*M|0,h=F((r-S)*N),u=F((o-C)*A),d=F((n-O)*M);s<0?s=0:y<=s&&(s=y-1),l<0?l=0:g<=l&&(l=g-1),c<0?c=0:x<=c&&(c=x-1),h<0?h=0:y<=h&&(h=y-1),u<0?u=0:g<=u&&(u=g-1),d<0?d=0:x<=d&&(d=x-1),l*=b,c*=T,h*=w,u*=b,d*=T;for(var p=s*=w;p<=h;p+=w)for(var m=l;m<=u;m+=b)for(var f=c;f<=d;f+=T){var v=p+m+f;E[v][L[v]++]=a}}for(var o=e.numObjects(),n=e.bodies,a=this.aabbMax,s=this.aabbMin,y=this.nx,g=this.ny,x=this.nz,w=g*x,b=x,T=1,l=a.x,c=a.y,h=a.z,S=s.x,C=s.y,O=s.z,N=y/(l-S),A=g/(c-C),M=x/(h-O),u=(l-S)/y,d=(c-C)/g,p=(h-O)/x,m=.5*Math.sqrt(u*u+d*d+p*p),f=ie.types,v=f.SPHERE,P=f.PLANE,E=(f.BOX,f.COMPOUND,f.CONVEXPOLYHEDRON,this.bins),L=this.binLengths,G=this.bins.length,B=0;B!==G;B++)L[B]=0;var F=Math.ceil;for(s=Math.min,a=Math.max,B=0;B!==o;B++){var R=(ee=n[B]).shape;switch(R.type){case v:var j=ee.position.x,_=ee.position.y,z=ee.position.z,k=R.radius;r(j-k,_-k,z-k,j+k,_+k,z+k,ee);break;case P:R.worldNormalNeedsUpdate&&R.computeWorldNormal(ee.quaternion);var V=R.worldNormal,I=S+.5*u-ee.position.x,U=C+.5*d-ee.position.y,D=O+.5*p-ee.position.z,W=re;W.set(I,U,D);for(var q=0,H=0;q!==y;q++,H+=w,W.y=U,W.x+=u)for(var K=0,X=0;K!==g;K++,X+=b,W.z=D,W.y+=d)for(var Y=0,Z=0;Y!==x;Y++,Z+=T,W.z+=p)if(W.dot(V)<m){var J=H+X+Z;E[J][L[J]++]=ee}break;default:ee.aabbNeedsUpdate&&ee.computeAABB(),r(ee.aabb.lowerBound.x,ee.aabb.lowerBound.y,ee.aabb.lowerBound.z,ee.aabb.upperBound.x,ee.aabb.upperBound.y,ee.aabb.upperBound.z,ee)}}for(B=0;B!==G;B++){var Q=L[B];if(1<Q){var $=E[B];for(q=0;q!==Q;q++){var ee=$[q];for(K=0;K!==q;K++){var te=$[K];this.needBroadphaseCollision(ee,te)&&this.intersectionTest(ee,te,t,i)}}}}this.makePairsUnique(t,i)}},{"../math/Vec3":30,"../shapes/Shape":43,"./Broadphase":5}],7:[function(e,t){function i(){r.apply(this)}t.exports=i;var r=e("./Broadphase"),o=e("./AABB");((i.prototype=new r).constructor=i).prototype.collisionPairs=function(e,t,i){var r,o,n,a,s=e.bodies,l=s.length;for(r=0;r!==l;r++)for(o=0;o!==r;o++)n=s[r],a=s[o],this.needBroadphaseCollision(n,a)&&this.intersectionTest(n,a,t,i)},new o,i.prototype.aabbQuery=function(e,t,i){i=i||[];for(var r=0;r<e.bodies.length;r++){var o=e.bodies[r];o.aabbNeedsUpdate&&o.computeAABB(),o.aabb.overlaps(t)&&i.push(o)}return i}},{"./AABB":3,"./Broadphase":5}],8:[function(e,t){function i(){this.matrix={}}(t.exports=i).prototype.get=function(e,t){if((e=e.id)<(t=t.id)){var i=t;t=e,e=i}return e+"-"+t in this.matrix},i.prototype.set=function(e,t,i){if((e=e.id)<(t=t.id)){var r=t;t=e,e=r}i?this.matrix[e+"-"+t]=!0:delete this.matrix[e+"-"+t]},i.prototype.reset=function(){this.matrix={}},i.prototype.setNumObjects=function(){}},{}],9:[function(e,t){function f(e,t){this.from=e?e.clone():new v,this.to=t?t.clone():new v,this._direction=new v,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=f.ANY,this.result=new r,this.hasHit=!1,this.callback=function(){}}function A(e,t,i,r){r.vsub(t,p),i.vsub(t,u),e.vsub(t,d);var o,n,a=p.dot(p),s=p.dot(u),l=p.dot(d),c=u.dot(u),h=u.dot(d);return 0<=(o=c*l-s*h)&&0<=(n=a*h-s*l)&&o+n<a*c-s*s}t.exports=f;var v=e("../math/Vec3"),i=e("../math/Quaternion"),O=e("../math/Transform"),r=(e("../shapes/ConvexPolyhedron"),e("../shapes/Box"),e("../collision/RaycastResult")),o=e("../shapes/Shape"),n=e("../collision/AABB");(f.prototype.constructor=f).CLOSEST=1,f.ANY=2,f.ALL=4;var a=new n,s=[];f.prototype.intersectWorld=function(e,t){return this.mode=t.mode||f.ANY,this.result=t.result||new r,this.skipBackfaces=!!t.skipBackfaces,this.collisionFilterMask=void 0!==t.collisionFilterMask?t.collisionFilterMask:-1,this.collisionFilterGroup=void 0!==t.collisionFilterGroup?t.collisionFilterGroup:-1,t.from&&this.from.copy(t.from),t.to&&this.to.copy(t.to),this.callback=t.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(a),s.length=0,e.broadphase.aabbQuery(e,a,s),this.intersectBodies(s),this.hasHit};var u=new v,d=new v;f.pointInTriangle=A;var l=new v,c=new i;f.prototype.intersectBody=function(e,t){t&&(this.result=t,this._updateDirection());var i=this.checkCollisionResponse;if((!i||e.collisionResponse)&&0!=(this.collisionFilterGroup&e.collisionFilterMask)&&0!=(e.collisionFilterGroup&this.collisionFilterMask))for(var r=l,o=c,n=0,a=e.shapes.length;n<a;n++){var s=e.shapes[n];if((!i||s.collisionResponse)&&(e.quaternion.mult(e.shapeOrientations[n],o),e.quaternion.vmult(e.shapeOffsets[n],r),r.vadd(e.position,r),this.intersectShape(s,o,r,e),this.result._shouldStop))break}},f.prototype.intersectBodies=function(e,t){t&&(this.result=t,this._updateDirection());for(var i=0,r=e.length;!this.result._shouldStop&&i<r;i++)this.intersectBody(e[i])},f.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},f.prototype.intersectShape=function(e,t,i,r){if(!(function(e,t,i){i.vsub(e,p);var r=p.dot(t);return t.mult(r,h),h.vadd(e,h),i.distanceTo(h)}(this.from,this._direction,i)>e.boundingSphereRadius)){var o=this[e.type];o&&o.call(this,e,t,i,r)}};var M=(new v,new v,new v),P=new v,E=new v,L=new v;new v,new r,f.prototype.intersectBox=function(e,t,i,r){return this.intersectConvex(e.convexPolyhedronRepresentation,t,i,r)},f.prototype[o.types.BOX]=f.prototype.intersectBox,f.prototype.intersectPlane=function(e,t,i,r){var o=this.from,n=this.to,a=this._direction,s=new v(0,0,1);t.vmult(s,s);var l=new v;o.vsub(i,l);var c=l.dot(s);if(n.vsub(i,l),!(0<c*l.dot(s)||o.distanceTo(n)<c)){var h=s.dot(a);if(!(Math.abs(h)<this.precision)){var u=new v,d=new v,p=new v;o.vsub(i,u);var m=-s.dot(u)/h;a.scale(m,d),o.vadd(d,p),this.reportIntersection(s,p,e,r,-1)}}},f.prototype[o.types.PLANE]=f.prototype.intersectPlane,f.prototype.getAABB=function(e){var t=this.to,i=this.from;e.lowerBound.x=Math.min(t.x,i.x),e.lowerBound.y=Math.min(t.y,i.y),e.lowerBound.z=Math.min(t.z,i.z),e.upperBound.x=Math.max(t.x,i.x),e.upperBound.y=Math.max(t.y,i.y),e.upperBound.z=Math.max(t.z,i.z)};var y={faceList:[0]};f.prototype.intersectHeightfield=function(e,t,i,r){var o=(e.data,e.elementSize,new v),n=new f(this.from,this.to);O.pointToLocalFrame(i,t,n.from,n.from),O.pointToLocalFrame(i,t,n.to,n.to);var a=[],s=null,l=null,c=null,h=null,u=e.getIndexOfPosition(n.from.x,n.from.y,a,!1);if(u&&(c=s=a[0],h=l=a[1]),(u=e.getIndexOfPosition(n.to.x,n.to.y,a,!1))&&((null===s||a[0]<s)&&(s=a[0]),(null===c||c<a[0])&&(c=a[0]),(null===l||a[1]<l)&&(l=a[1]),(null===h||h<a[1])&&(h=a[1])),null!==s){var d=[];e.getRectMinMax(s,l,c,h,d);for(var p=s;p<=c;p++)for(var m=l;m<=h;m++){if(this.result._shouldStop)return;if(e.getConvexTrianglePillar(p,m,!1),O.pointToWorldFrame(i,t,e.pillarOffset,o),this.intersectConvex(e.pillarConvex,t,o,r,y),this.result._shouldStop)return;e.getConvexTrianglePillar(p,m,!0),O.pointToWorldFrame(i,t,e.pillarOffset,o),this.intersectConvex(e.pillarConvex,t,o,r,y)}}},f.prototype[o.types.HEIGHTFIELD]=f.prototype.intersectHeightfield;var g=new v,x=new v;f.prototype.intersectSphere=function(e,t,i,r){var o=this.from,n=this.to,a=e.radius,s=Math.pow(n.x-o.x,2)+Math.pow(n.y-o.y,2)+Math.pow(n.z-o.z,2),l=2*((n.x-o.x)*(o.x-i.x)+(n.y-o.y)*(o.y-i.y)+(n.z-o.z)*(o.z-i.z)),c=Math.pow(o.x-i.x,2)+Math.pow(o.y-i.y,2)+Math.pow(o.z-i.z,2)-Math.pow(a,2),h=Math.pow(l,2)-4*s*c,u=g,d=x;if(!(h<0))if(0===h)o.lerp(n,h,u),u.vsub(i,d),d.normalize(),this.reportIntersection(d,u,e,r,-1);else{var p=(-l-Math.sqrt(h))/(2*s),m=(-l+Math.sqrt(h))/(2*s);if(0<=p&&p<=1&&(o.lerp(n,p,u),u.vsub(i,d),d.normalize(),this.reportIntersection(d,u,e,r,-1)),this.result._shouldStop)return;0<=m&&m<=1&&(o.lerp(n,m,u),u.vsub(i,d),d.normalize(),this.reportIntersection(d,u,e,r,-1))}},f.prototype[o.types.SPHERE]=f.prototype.intersectSphere;var G=new v,B=(new v,new v,new v);f.prototype.intersectConvex=function(e,t,i,r,o){for(var n=G,a=B,s=o&&o.faceList||null,l=e.faces,c=e.vertices,h=e.faceNormals,u=this._direction,d=this.from,p=this.to,m=d.distanceTo(p),f=s?s.length:l.length,v=this.result,y=0;!v._shouldStop&&y<f;y++){var g=s?s[y]:y,x=l[g],w=h[g],b=t,T=i;a.copy(c[x[0]]),b.vmult(a,a),a.vadd(T,a),a.vsub(d,a),b.vmult(w,n);var S=u.dot(n);if(!(Math.abs(S)<this.precision)){var C=n.dot(a)/S;if(!(C<0)){u.mult(C,M),M.vadd(d,M),P.copy(c[x[0]]),b.vmult(P,P),T.vadd(P,P);for(var O=1;!v._shouldStop&&O<x.length-1;O++){E.copy(c[x[O]]),L.copy(c[x[O+1]]),b.vmult(E,E),b.vmult(L,L),T.vadd(E,E),T.vadd(L,L);var N=M.distanceTo(d);!A(M,P,E,L)&&!A(M,E,P,L)||m<N||this.reportIntersection(n,M,e,r,g)}}}}},f.prototype[o.types.CONVEXPOLYHEDRON]=f.prototype.intersectConvex;var N=new v,F=new v,R=new v,j=new v,_=new v,z=new v,k=(new n,[]),V=new O;f.prototype.intersectTrimesh=function(e,t,i,r,o){var n=N,a=k,s=V,l=B,c=F,h=R,u=j,d=z,p=_,m=(o&&o.faceList,e.indices),f=(e.vertices,e.faceNormals,this.from),v=this.to,y=this._direction;s.position.copy(i),s.quaternion.copy(t),O.vectorToLocalFrame(i,t,y,c),O.pointToLocalFrame(i,t,f,h),O.pointToLocalFrame(i,t,v,u);var g=h.distanceSquared(u);e.tree.rayQuery(this,s,a);for(var x=0,w=a.length;!this.result._shouldStop&&x!==w;x++){var b=a[x];e.getNormal(b,n),e.getVertex(m[3*b],P),P.vsub(h,l);var T=c.dot(n),S=n.dot(l)/T;if(!(S<0)){c.scale(S,M),M.vadd(h,M),e.getVertex(m[3*b+1],E),e.getVertex(m[3*b+2],L);var C=M.distanceSquared(h);!A(M,E,P,L)&&!A(M,P,E,L)||g<C||(O.vectorToWorldFrame(t,n,p),O.pointToWorldFrame(i,t,M,d),this.reportIntersection(p,d,e,r,b))}}a.length=0},f.prototype[o.types.TRIMESH]=f.prototype.intersectTrimesh,f.prototype.reportIntersection=function(e,t,i,r,o){var n=this.from,a=this.to,s=n.distanceTo(t),l=this.result;if(!(this.skipBackfaces&&0<e.dot(this._direction)))switch(l.hitFaceIndex=void 0!==o?o:-1,this.mode){case f.ALL:this.hasHit=!0,l.set(n,a,e,t,i,r,s),l.hasHit=!0,this.callback(l);break;case f.CLOSEST:(s<l.distance||!l.hasHit)&&(this.hasHit=!0,l.hasHit=!0,l.set(n,a,e,t,i,r,s));break;case f.ANY:this.hasHit=!0,l.hasHit=!0,l.set(n,a,e,t,i,r,s),l._shouldStop=!0}};var p=new v,h=new v},{"../collision/AABB":3,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/Box":37,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43}],10:[function(e,t){function i(){this.rayFromWorld=new r,this.rayToWorld=new r,this.hitNormalWorld=new r,this.hitPointWorld=new r,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}var r=e("../math/Vec3");(t.exports=i).prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},i.prototype.abort=function(){this._shouldStop=!0},i.prototype.set=function(e,t,i,r,o,n,a){this.rayFromWorld.copy(e),this.rayToWorld.copy(t),this.hitNormalWorld.copy(i),this.hitPointWorld.copy(r),this.shape=o,this.body=n,this.distance=a}},{"../math/Vec3":30}],11:[function(e,t){function h(e){r.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var i=this.axisList;this._addBodyHandler=function(e){i.push(e.body)},this._removeBodyHandler=function(e){var t=i.indexOf(e.body);-1!==t&&i.splice(t,1)},e&&this.setWorld(e)}var r=(e("../shapes/Shape"),e("../collision/Broadphase"));((t.exports=h).prototype=new r).setWorld=function(e){for(var t=this.axisList.length=0;t<e.bodies.length;t++)this.axisList.push(e.bodies[t]);e.removeEventListener("addBody",this._addBodyHandler),e.removeEventListener("removeBody",this._removeBodyHandler),e.addEventListener("addBody",this._addBodyHandler),e.addEventListener("removeBody",this._removeBodyHandler),this.world=e,this.dirty=!0},h.insertionSortX=function(e){for(var t=1,i=e.length;t<i;t++){for(var r=e[t],o=t-1;0<=o&&!(e[o].aabb.lowerBound.x<=r.aabb.lowerBound.x);o--)e[o+1]=e[o];e[o+1]=r}return e},h.insertionSortY=function(e){for(var t=1,i=e.length;t<i;t++){for(var r=e[t],o=t-1;0<=o&&!(e[o].aabb.lowerBound.y<=r.aabb.lowerBound.y);o--)e[o+1]=e[o];e[o+1]=r}return e},h.insertionSortZ=function(e){for(var t=1,i=e.length;t<i;t++){for(var r=e[t],o=t-1;0<=o&&!(e[o].aabb.lowerBound.z<=r.aabb.lowerBound.z);o--)e[o+1]=e[o];e[o+1]=r}return e},h.prototype.collisionPairs=function(e,t,i){var r,o,n=this.axisList,a=n.length,s=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),r=0;r!==a;r++){var l=n[r];for(o=r+1;o<a;o++){var c=n[o];if(this.needBroadphaseCollision(l,c)){if(!h.checkBounds(l,c,s))break;this.intersectionTest(l,c,t,i)}}}},h.prototype.sortList=function(){for(var e=this.axisList,t=this.axisIndex,i=e.length,r=0;r!==i;r++){var o=e[r];o.aabbNeedsUpdate&&o.computeAABB()}0===t?h.insertionSortX(e):1===t?h.insertionSortY(e):2===t&&h.insertionSortZ(e)},h.checkBounds=function(e,t,i){var r,o;0===i?(r=e.position.x,o=t.position.x):1===i?(r=e.position.y,o=t.position.y):2===i&&(r=e.position.z,o=t.position.z);var n=e.boundingRadius;return o-t.boundingRadius<r+n},h.prototype.autoDetectAxis=function(){for(var e=0,t=0,i=0,r=0,o=0,n=0,a=this.axisList,s=a.length,l=1/s,c=0;c!==s;c++){var h=a[c],u=h.position.x;e+=u,t+=u*u;var d=h.position.y;i+=d,r+=d*d;var p=h.position.z;o+=p,n+=p*p}var m=t-e*e*l,f=r-i*i*l,v=n-o*o*l;this.axisIndex=f<m?v<m?0:2:v<f?1:2},h.prototype.aabbQuery=function(e,t,i){i=i||[],this.dirty&&(this.sortList(),this.dirty=!1);var r=this.axisIndex,o="x";1===r&&(o="y"),2===r&&(o="z");for(var n=this.axisList,a=(t.lowerBound[o],t.upperBound[o],0);a<n.length;a++){var s=n[a];s.aabbNeedsUpdate&&s.computeAABB(),s.aabb.overlaps(t)&&i.push(s)}return i}},{"../collision/Broadphase":5,"../shapes/Shape":43}],12:[function(e,t){function i(e,t,i){var r=void 0!==(i=i||{}).maxForce?i.maxForce:1e6,o=i.pivotA?i.pivotA.clone():new u,n=i.pivotB?i.pivotB.clone():new u;this.axisA=i.axisA?i.axisA.clone():new u,this.axisB=i.axisB?i.axisB.clone():new u,l.call(this,e,o,t,n,r),this.collideConnected=!!i.collideConnected,this.angle=void 0!==i.angle?i.angle:0;var a=this.coneEquation=new c(e,t,i),s=this.twistEquation=new h(e,t,i);this.twistAngle=void 0!==i.twistAngle?i.twistAngle:0,a.maxForce=0,a.minForce=-r,s.maxForce=0,s.minForce=-r,this.equations.push(a,s)}t.exports=i;var l=(e("./Constraint"),e("./PointToPointConstraint")),c=e("../equations/ConeEquation"),h=e("../equations/RotationalEquation"),u=(e("../equations/ContactEquation"),e("../math/Vec3"));i.prototype=new l,i.constructor=i,new u,new u,i.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=this.coneEquation,r=this.twistEquation;l.prototype.update.call(this),e.vectorToWorldFrame(this.axisA,i.axisA),t.vectorToWorldFrame(this.axisB,i.axisB),this.axisA.tangents(r.axisA,r.axisA),e.vectorToWorldFrame(r.axisA,r.axisA),this.axisB.tangents(r.axisB,r.axisB),t.vectorToWorldFrame(r.axisB,r.axisB),i.angle=this.angle,r.maxAngle=this.twistAngle}},{"../equations/ConeEquation":18,"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],13:[function(e,t){function r(e,t,i){i=o.defaults(i,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=e,this.bodyB=t,this.id=r.idCounter++,this.collideConnected=i.collideConnected,i.wakeUpBodies&&(e&&e.wakeUp(),t&&t.wakeUp())}t.exports=r;var o=e("../utils/Utils");r.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},r.prototype.enable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!0},r.prototype.disable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!1},r.idCounter=0},{"../utils/Utils":53}],14:[function(e,t){function i(e,t,i,r){n.call(this,e,t),void 0===i&&(i=e.position.distanceTo(t.position)),void 0===r&&(r=1e6),this.distance=i;var o=this.distanceEquation=new a(e,t);this.equations.push(o),o.minForce=-r,o.maxForce=r}t.exports=i;var n=e("./Constraint"),a=e("../equations/ContactEquation");(i.prototype=new n).update=function(){var e=this.bodyA,t=this.bodyB,i=this.distanceEquation,r=.5*this.distance,o=i.ni;t.position.vsub(e.position,o),o.normalize(),o.mult(r,i.ri),o.mult(-r,i.rj)}},{"../equations/ContactEquation":19,"./Constraint":13}],15:[function(e,t){function i(e,t,i){var r=void 0!==(i=i||{}).maxForce?i.maxForce:1e6,o=i.pivotA?i.pivotA.clone():new d,n=i.pivotB?i.pivotB.clone():new d;c.call(this,e,o,t,n,r),(this.axisA=i.axisA?i.axisA.clone():new d(1,0,0)).normalize(),(this.axisB=i.axisB?i.axisB.clone():new d(1,0,0)).normalize();var a=this.rotationalEquation1=new h(e,t,i),s=this.rotationalEquation2=new h(e,t,i),l=this.motorEquation=new u(e,t,r);l.enabled=!1,this.equations.push(a,s,l)}t.exports=i;var c=(e("./Constraint"),e("./PointToPointConstraint")),h=e("../equations/RotationalEquation"),u=e("../equations/RotationalMotorEquation"),d=(e("../equations/ContactEquation"),e("../math/Vec3"));i.prototype=new c,(i.constructor=i).prototype.enableMotor=function(){this.motorEquation.enabled=!0},i.prototype.disableMotor=function(){this.motorEquation.enabled=!1},i.prototype.setMotorSpeed=function(e){this.motorEquation.targetVelocity=e},i.prototype.setMotorMaxForce=function(e){this.motorEquation.maxForce=e,this.motorEquation.minForce=-e};var p=new d,m=new d;i.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=this.motorEquation,r=this.rotationalEquation1,o=this.rotationalEquation2,n=p,a=m,s=this.axisA,l=this.axisB;c.prototype.update.call(this),e.quaternion.vmult(s,n),t.quaternion.vmult(l,a),n.tangents(r.axisA,o.axisA),r.axisB.copy(a),o.axisB.copy(a),this.motorEquation.enabled&&(e.quaternion.vmult(this.axisA,i.axisA),t.quaternion.vmult(this.axisB,i.axisB))}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],16:[function(e,t){function i(e,t,i){var r=void 0!==(i=i||{}).maxForce?i.maxForce:1e6,o=new d,n=new d,a=new d;e.position.vadd(t.position,a),a.scale(.5,a),t.pointToLocalFrame(a,n),e.pointToLocalFrame(a,o),h.call(this,e,o,t,n,r);var s=this.rotationalEquation1=new u(e,t,i),l=this.rotationalEquation2=new u(e,t,i),c=this.rotationalEquation3=new u(e,t,i);this.equations.push(s,l,c)}t.exports=i;var h=(e("./Constraint"),e("./PointToPointConstraint")),u=e("../equations/RotationalEquation"),d=(e("../equations/RotationalMotorEquation"),e("../equations/ContactEquation"),e("../math/Vec3"));i.prototype=new h,i.constructor=i,new d,new d,i.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=(this.motorEquation,this.rotationalEquation1),r=this.rotationalEquation2,o=this.rotationalEquation3;h.prototype.update.call(this),e.vectorToWorldFrame(d.UNIT_X,i.axisA),t.vectorToWorldFrame(d.UNIT_Y,i.axisB),e.vectorToWorldFrame(d.UNIT_Y,r.axisA),t.vectorToWorldFrame(d.UNIT_Z,r.axisB),e.vectorToWorldFrame(d.UNIT_Z,o.axisA),t.vectorToWorldFrame(d.UNIT_X,o.axisB)}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],17:[function(e,t){function i(e,t,i,r,o){l.call(this,e,i),o=void 0!==o?o:1e6,this.pivotA=t?t.clone():new h,this.pivotB=r?r.clone():new h;var n=this.equationX=new c(e,i),a=this.equationY=new c(e,i),s=this.equationZ=new c(e,i);this.equations.push(n,a,s),n.minForce=a.minForce=s.minForce=-o,n.maxForce=a.maxForce=s.maxForce=o,n.ni.set(1,0,0),a.ni.set(0,1,0),s.ni.set(0,0,1)}t.exports=i;var l=e("./Constraint"),c=e("../equations/ContactEquation"),h=e("../math/Vec3");(i.prototype=new l).update=function(){var e=this.bodyA,t=this.bodyB,i=this.equationX,r=this.equationY,o=this.equationZ;e.quaternion.vmult(this.pivotA,i.ri),t.quaternion.vmult(this.pivotB,i.rj),r.ri.copy(i.ri),r.rj.copy(i.rj),o.ri.copy(i.ri),o.rj.copy(i.rj)}},{"../equations/ContactEquation":19,"../math/Vec3":30,"./Constraint":13}],18:[function(e,t){function i(e,t,i){var r=void 0!==(i=i||{}).maxForce?i.maxForce:1e6;n.call(this,e,t,-r,r),this.axisA=i.axisA?i.axisA.clone():new o(1,0,0),this.axisB=i.axisB?i.axisB.clone():new o(0,1,0),this.angle=void 0!==i.angle?i.angle:0}t.exports=i;var o=e("../math/Vec3"),n=(e("../math/Mat3"),e("./Equation"));(i.prototype=new n).constructor=i;var c=new o,h=new o;i.prototype.computeB=function(e){var t=this.a,i=this.b,r=this.axisA,o=this.axisB,n=c,a=h,s=this.jacobianElementA,l=this.jacobianElementB;return r.cross(o,n),o.cross(r,a),s.rotational.copy(a),l.rotational.copy(n),-(Math.cos(this.angle)-r.dot(o))*t-this.computeGW()*i-e*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],19:[function(e,t){function i(e,t,i){i=void 0!==i?i:1e6,r.call(this,e,t,0,i),this.restitution=0,this.ri=new o,this.rj=new o,this.ni=new o}t.exports=i;var r=e("./Equation"),o=e("../math/Vec3");e("../math/Mat3"),(i.prototype=new r).constructor=i;var x=new o,w=new o,b=new o;i.prototype.computeB=function(e){var t=this.a,i=this.b,r=this.bi,o=this.bj,n=this.ri,a=this.rj,s=x,l=w,c=r.velocity,h=r.angularVelocity,u=(r.force,r.torque,o.velocity),d=o.angularVelocity,p=(o.force,o.torque,b),m=this.jacobianElementA,f=this.jacobianElementB,v=this.ni;n.cross(v,s),a.cross(v,l),v.negate(m.spatial),s.negate(m.rotational),f.spatial.copy(v),f.rotational.copy(l),p.copy(o.position),p.vadd(a,p),p.vsub(r.position,p),p.vsub(n,p);var y=v.dot(p),g=this.restitution+1;return-y*t-(g*u.dot(v)-g*c.dot(v)+d.dot(l)-h.dot(s))*i-e*this.computeGiMf()};var n=new o,a=new o,s=new o,l=new o,c=new o;i.prototype.getImpactVelocityAlongNormal=function(){var e=n,t=a,i=s,r=l,o=c;return this.bi.position.vadd(this.ri,i),this.bj.position.vadd(this.rj,r),this.bi.getVelocityAtWorldPoint(i,e),this.bj.getVelocityAtWorldPoint(r,t),e.vsub(t,o),this.ni.dot(o)}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],20:[function(e,t){function o(e,t,i,r){this.id=o.id++,this.minForce=void 0===i?-1e6:i,this.maxForce=void 0===r?1e6:r,this.bi=e,this.bj=t,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new n,this.jacobianElementB=new n,this.enabled=!0,this.setSpookParams(1e7,4,1/60)}t.exports=o;var n=e("../math/JacobianElement"),i=e("../math/Vec3");(o.prototype.constructor=o).id=0,o.prototype.setSpookParams=function(e,t,i){var r=t,o=e,n=i;this.a=4/(n*(1+4*r)),this.b=4*r/(1+4*r),this.eps=4/(n*n*o*(1+4*r))},o.prototype.computeB=function(e,t,i){var r=this.computeGW();return-this.computeGq()*e-r*t-this.computeGiMf()*i},o.prototype.computeGq=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,r=this.bj,o=i.position,n=r.position;return e.spatial.dot(o)+t.spatial.dot(n)};var l=new i;o.prototype.computeGW=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,r=this.bj,o=i.velocity,n=r.velocity,a=i.angularVelocity||l,s=r.angularVelocity||l;return e.multiplyVectors(o,a)+t.multiplyVectors(n,s)},o.prototype.computeGWlambda=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,r=this.bj,o=i.vlambda,n=r.vlambda,a=i.wlambda||l,s=r.wlambda||l;return e.multiplyVectors(o,a)+t.multiplyVectors(n,s)};var h=new i,u=new i,d=new i,p=new i;o.prototype.computeGiMf=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,r=this.bj,o=i.force,n=i.torque,a=r.force,s=r.torque,l=i.invMassSolve,c=r.invMassSolve;return i.invInertiaWorldSolve?i.invInertiaWorldSolve.vmult(n,d):d.set(0,0,0),r.invInertiaWorldSolve?r.invInertiaWorldSolve.vmult(s,p):p.set(0,0,0),o.mult(l,h),a.mult(c,u),e.multiplyVectors(h,d)+t.multiplyVectors(u,p)};var c=new i;o.prototype.computeGiMGt=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,r=this.bj,o=i.invMassSolve,n=r.invMassSolve,a=i.invInertiaWorldSolve,s=r.invInertiaWorldSolve,l=o+n;return a&&(a.vmult(e.rotational,c),l+=c.dot(e.rotational)),s&&(s.vmult(t.rotational,c),l+=c.dot(t.rotational)),l};var a=new i;new i,new i,new i,new i,new i,o.prototype.addToWlambda=function(e){var t=this.jacobianElementA,i=this.jacobianElementB,r=this.bi,o=this.bj,n=a;t.spatial.mult(r.invMassSolve*e,n),r.vlambda.vadd(n,r.vlambda),i.spatial.mult(o.invMassSolve*e,n),o.vlambda.vadd(n,o.vlambda),r.invInertiaWorldSolve&&(r.invInertiaWorldSolve.vmult(t.rotational,n),n.mult(e,n),r.wlambda.vadd(n,r.wlambda)),o.invInertiaWorldSolve&&(o.invInertiaWorldSolve.vmult(i.rotational,n),n.mult(e,n),o.wlambda.vadd(n,o.wlambda))},o.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":26,"../math/Vec3":30}],21:[function(e,t){function i(e,t,i){r.call(this,e,t,-i,i),this.ri=new o,this.rj=new o,this.t=new o}t.exports=i;var r=e("./Equation"),o=e("../math/Vec3");e("../math/Mat3"),(i.prototype=new r).constructor=i;var c=new o,h=new o;i.prototype.computeB=function(e){var t=(this.a,this.b),i=(this.bi,this.bj,this.ri),r=this.rj,o=c,n=h,a=this.t;i.cross(a,o),r.cross(a,n);var s=this.jacobianElementA,l=this.jacobianElementB;return a.negate(s.spatial),o.negate(s.rotational),l.spatial.copy(a),l.rotational.copy(n),-this.computeGW()*t-e*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],22:[function(e,t){function i(e,t,i){var r=void 0!==(i=i||{}).maxForce?i.maxForce:1e6;n.call(this,e,t,-r,r),this.axisA=i.axisA?i.axisA.clone():new o(1,0,0),this.axisB=i.axisB?i.axisB.clone():new o(0,1,0),this.maxAngle=Math.PI/2}t.exports=i;var o=e("../math/Vec3"),n=(e("../math/Mat3"),e("./Equation"));(i.prototype=new n).constructor=i;var c=new o,h=new o;i.prototype.computeB=function(e){var t=this.a,i=this.b,r=this.axisA,o=this.axisB,n=c,a=h,s=this.jacobianElementA,l=this.jacobianElementB;return r.cross(o,n),o.cross(r,a),s.rotational.copy(a),l.rotational.copy(n),-(Math.cos(this.maxAngle)-r.dot(o))*t-this.computeGW()*i-e*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],23:[function(e,t){function i(e,t,i){i=void 0!==i?i:1e6,o.call(this,e,t,-i,i),this.axisA=new r,this.axisB=new r,this.targetVelocity=0}t.exports=i;var r=e("../math/Vec3"),o=(e("../math/Mat3"),e("./Equation"));((i.prototype=new o).constructor=i).prototype.computeB=function(e){var t=(this.a,this.b),i=(this.bi,this.bj,this.axisA),r=this.axisB,o=this.jacobianElementA,n=this.jacobianElementB;return o.rotational.copy(i),r.negate(n.rotational),-(this.computeGW()-this.targetVelocity)*t-e*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],24:[function(e,t){function r(e,t,i){i=o.defaults(i,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=r.idCounter++,this.materials=[e,t],this.friction=i.friction,this.restitution=i.restitution,this.contactEquationStiffness=i.contactEquationStiffness,this.contactEquationRelaxation=i.contactEquationRelaxation,this.frictionEquationStiffness=i.frictionEquationStiffness,this.frictionEquationRelaxation=i.frictionEquationRelaxation}var o=e("../utils/Utils");(t.exports=r).idCounter=0},{"../utils/Utils":53}],25:[function(e,t){function i(e){var t="";"string"==typeof(e=e||{})?(t=e,e={}):"object"==typeof e&&(t=""),this.name=t,this.id=i.idCounter++,this.friction=void 0!==e.friction?e.friction:-1,this.restitution=void 0!==e.restitution?e.restitution:-1}(t.exports=i).idCounter=0},{}],26:[function(e,t){function i(){this.spatial=new r,this.rotational=new r}t.exports=i;var r=e("./Vec3");i.prototype.multiplyElement=function(e){return e.spatial.dot(this.spatial)+e.rotational.dot(this.rotational)},i.prototype.multiplyVectors=function(e,t){return e.dot(this.spatial)+t.dot(this.rotational)}},{"./Vec3":30}],27:[function(e,t){function c(e){this.elements=e||[0,0,0,0,0,0,0,0,0]}t.exports=c;var h=e("./Vec3");c.prototype.identity=function(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1},c.prototype.setZero=function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e[8]=0},c.prototype.setTrace=function(e){var t=this.elements;t[0]=e.x,t[4]=e.y,t[8]=e.z},c.prototype.getTrace=function(e){e=e||new h;var t=this.elements;e.x=t[0],e.y=t[4],e.z=t[8]},c.prototype.vmult=function(e,t){t=t||new h;var i=this.elements,r=e.x,o=e.y,n=e.z;return t.x=i[0]*r+i[1]*o+i[2]*n,t.y=i[3]*r+i[4]*o+i[5]*n,t.z=i[6]*r+i[7]*o+i[8]*n,t},c.prototype.smult=function(e){for(var t=0;t<this.elements.length;t++)this.elements[t]*=e},c.prototype.mmult=function(e,t){for(var i=t||new c,r=0;r<3;r++)for(var o=0;o<3;o++){for(var n=0,a=0;a<3;a++)n+=e.elements[r+3*a]*this.elements[a+3*o];i.elements[r+3*o]=n}return i},c.prototype.scale=function(e,t){t=t||new c;for(var i=this.elements,r=t.elements,o=0;3!==o;o++)r[3*o+0]=e.x*i[3*o+0],r[3*o+1]=e.y*i[3*o+1],r[3*o+2]=e.z*i[3*o+2];return t},c.prototype.solve=function(e,t){t=t||new h;for(var i=[],r=0;r<12;r++)i.push(0);var o;for(r=0;r<3;r++)for(o=0;o<3;o++)i[r+4*o]=this.elements[r+3*o];i[3]=e.x,i[7]=e.y,i[11]=e.z;var n,a,s=3,l=s;do{if(0===i[(r=l-s)+4*r])for(o=r+1;o<l;o++)if(0!==i[r+4*o]){for(n=4;i[(a=4-n)+4*r]+=i[a+4*o],--n;);break}if(0!==i[r+4*r])for(o=r+1;o<l;o++){var c=i[r+4*o]/i[r+4*r];for(n=4;i[(a=4-n)+4*o]=a<=r?0:i[a+4*o]-i[a+4*r]*c,--n;);}}while(--s);if(t.z=i[11]/i[10],t.y=(i[7]-i[6]*t.z)/i[5],t.x=(i[3]-i[2]*t.z-i[1]*t.y)/i[0],isNaN(t.x)||isNaN(t.y)||isNaN(t.z)||1/0===t.x||1/0===t.y||1/0===t.z)throw"Could not solve equation! Got x=["+t.toString()+"], b=["+e.toString()+"], A=["+this.toString()+"]";return t},c.prototype.e=function(e,t,i){return void 0===i?this.elements[t+3*e]:void(this.elements[t+3*e]=i)},c.prototype.copy=function(e){for(var t=0;t<e.elements.length;t++)this.elements[t]=e.elements[t];return this},c.prototype.toString=function(){for(var e="",t=0;t<9;t++)e+=this.elements[t]+",";return e},c.prototype.reverse=function(e){e=e||new c;for(var t=[],i=0;i<18;i++)t.push(0);var r;for(i=0;i<3;i++)for(r=0;r<3;r++)t[i+6*r]=this.elements[i+3*r];t[3]=1,t[9]=0,t[15]=0,t[4]=0,t[10]=1,t[16]=0,t[5]=0,t[11]=0,t[17]=1;var o,n,a=3,s=a;do{if(0===t[(i=s-a)+6*i])for(r=i+1;r<s;r++)if(0!==t[i+6*r]){for(o=6;t[(n=6-o)+6*i]+=t[n+6*r],--o;);break}if(0!==t[i+6*i])for(r=i+1;r<s;r++){var l=t[i+6*r]/t[i+6*i];for(o=6;t[(n=6-o)+6*r]=n<=i?0:t[n+6*r]-t[n+6*i]*l,--o;);}}while(--a);i=2;do{r=i-1;do{l=t[i+6*r]/t[i+6*i];for(o=6;t[(n=6-o)+6*r]=t[n+6*r]-t[n+6*i]*l,--o;);}while(r--)}while(--i);i=2;do{l=1/t[i+6*i];for(o=6;t[(n=6-o)+6*i]=t[n+6*i]*l,--o;);}while(i--);i=2;do{r=2;do{if(n=t[3+r+6*i],isNaN(n)||1/0===n)throw"Could not reverse! A=["+this.toString()+"]";e.e(i,r,n)}while(r--)}while(i--);return e},c.prototype.setRotationFromQuaternion=function(e){var t=e.x,i=e.y,r=e.z,o=e.w,n=t+t,a=i+i,s=r+r,l=t*n,c=t*a,h=t*s,u=i*a,d=i*s,p=r*s,m=o*n,f=o*a,v=o*s,y=this.elements;return y[0]=1-(u+p),y[1]=c-v,y[2]=h+f,y[3]=c+v,y[4]=1-(l+p),y[5]=d-m,y[6]=h-f,y[7]=d+m,y[8]=1-(l+u),this},c.prototype.transpose=function(e){for(var t=(e=e||new c).elements,i=this.elements,r=0;3!==r;r++)for(var o=0;3!==o;o++)t[3*r+o]=i[3*o+r];return e}},{"./Vec3":30}],28:[function(e,t){function a(e,t,i,r){this.x=void 0!==e?e:0,this.y=void 0!==t?t:0,this.z=void 0!==i?i:0,this.w=void 0!==r?r:1}t.exports=a;var p=e("./Vec3");a.prototype.set=function(e,t,i,r){this.x=e,this.y=t,this.z=i,this.w=r},a.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},a.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},a.prototype.setFromAxisAngle=function(e,t){var i=Math.sin(.5*t);this.x=e.x*i,this.y=e.y*i,this.z=e.z*i,this.w=Math.cos(.5*t)},a.prototype.toAxisAngle=function(e){e=e||new p,this.normalize();var t=2*Math.acos(this.w),i=Math.sqrt(1-this.w*this.w);return i<.001?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/i,e.y=this.y/i,e.z=this.z/i),[e,t]};var n=new p,s=new p;a.prototype.setFromVectors=function(e,t){if(e.isAntiparallelTo(t)){var i=n,r=s;e.tangents(i,r),this.setFromAxisAngle(i,Math.PI)}else{var o=e.cross(t);this.x=o.x,this.y=o.y,this.z=o.z,this.w=Math.sqrt(Math.pow(e.norm(),2)*Math.pow(t.norm(),2))+e.dot(t),this.normalize()}};var l=new p,c=new p,h=new p;a.prototype.mult=function(e,t){t=t||new a;var i=this.w,r=l,o=c,n=h;return r.set(this.x,this.y,this.z),o.set(e.x,e.y,e.z),t.w=i*e.w-r.dot(o),r.cross(o,n),t.x=i*o.x+e.w*r.x+n.x,t.y=i*o.y+e.w*r.y+n.y,t.z=i*o.z+e.w*r.z+n.z,t},a.prototype.inverse=function(e){var t=this.x,i=this.y,r=this.z,o=this.w;e=e||new a,this.conjugate(e);var n=1/(t*t+i*i+r*r+o*o);return e.x*=n,e.y*=n,e.z*=n,e.w*=n,e},a.prototype.conjugate=function(e){return(e=e||new a).x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e},a.prototype.normalize=function(){var e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e)},a.prototype.normalizeFast=function(){var e=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=e,this.y*=e,this.z*=e,this.w*=e)},a.prototype.vmult=function(e,t){t=t||new p;var i=e.x,r=e.y,o=e.z,n=this.x,a=this.y,s=this.z,l=this.w,c=l*i+a*o-s*r,h=l*r+s*i-n*o,u=l*o+n*r-a*i,d=-n*i-a*r-s*o;return t.x=c*l+d*-n+h*-s-u*-a,t.y=h*l+d*-a+u*-n-c*-s,t.z=u*l+d*-s+c*-a-h*-n,t},a.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},a.prototype.toEuler=function(e,t){t=t||"YZX";var i,r,o,n=this.x,a=this.y,s=this.z,l=this.w;switch(t){case"YZX":var c=n*a+s*l;if(.499<c&&(i=2*Math.atan2(n,l),r=Math.PI/2,o=0),c<-.499&&(i=-2*Math.atan2(n,l),r=-Math.PI/2,o=0),isNaN(i)){var h=n*n,u=a*a,d=s*s;i=Math.atan2(2*a*l-2*n*s,1-2*u-2*d),r=Math.asin(2*c),o=Math.atan2(2*n*l-2*a*s,1-2*h-2*d)}break;default:throw new Error("Euler order "+t+" not supported yet.")}e.y=i,e.z=r,e.x=o},a.prototype.setFromEuler=function(e,t,i,r){r=r||"XYZ";var o=Math.cos(e/2),n=Math.cos(t/2),a=Math.cos(i/2),s=Math.sin(e/2),l=Math.sin(t/2),c=Math.sin(i/2);return"XYZ"===r?(this.x=s*n*a+o*l*c,this.y=o*l*a-s*n*c,this.z=o*n*c+s*l*a,this.w=o*n*a-s*l*c):"YXZ"===r?(this.x=s*n*a+o*l*c,this.y=o*l*a-s*n*c,this.z=o*n*c-s*l*a,this.w=o*n*a+s*l*c):"ZXY"===r?(this.x=s*n*a-o*l*c,this.y=o*l*a+s*n*c,this.z=o*n*c+s*l*a,this.w=o*n*a-s*l*c):"ZYX"===r?(this.x=s*n*a-o*l*c,this.y=o*l*a+s*n*c,this.z=o*n*c-s*l*a,this.w=o*n*a+s*l*c):"YZX"===r?(this.x=s*n*a+o*l*c,this.y=o*l*a+s*n*c,this.z=o*n*c-s*l*a,this.w=o*n*a-s*l*c):"XZY"===r&&(this.x=s*n*a-o*l*c,this.y=o*l*a-s*n*c,this.z=o*n*c+s*l*a,this.w=o*n*a+s*l*c),this},a.prototype.clone=function(){return new a(this.x,this.y,this.z,this.w)}},{"./Vec3":30}],29:[function(e,t){function i(e){e=e||{},this.position=new o,e.position&&this.position.copy(e.position),this.quaternion=new r,e.quaternion&&this.quaternion.copy(e.quaternion)}var o=e("./Vec3"),r=e("./Quaternion");t.exports=i;var n=new r;i.pointToLocalFrame=function(e,t,i,r){r=r||new o;return i.vsub(e,r),t.conjugate(n),n.vmult(r,r),r},i.prototype.pointToLocal=function(e,t){return i.pointToLocalFrame(this.position,this.quaternion,e,t)},i.pointToWorldFrame=function(e,t,i,r){r=r||new o;return t.vmult(i,r),r.vadd(e,r),r},i.prototype.pointToWorld=function(e,t){return i.pointToWorldFrame(this.position,this.quaternion,e,t)},i.prototype.vectorToWorldFrame=function(e,t){t=t||new o;return this.quaternion.vmult(e,t),t},i.vectorToWorldFrame=function(e,t,i){return e.vmult(t,i),i},i.vectorToLocalFrame=function(e,t,i,r){r=r||new o;return t.w*=-1,t.vmult(i,r),t.w*=-1,r}},{"./Quaternion":28,"./Vec3":30}],30:[function(e,t){function l(e,t,i){this.x=e||0,this.y=t||0,this.z=i||0}t.exports=l;var i=e("./Mat3");l.ZERO=new l(0,0,0),l.UNIT_X=new l(1,0,0),l.UNIT_Y=new l(0,1,0),l.UNIT_Z=new l(0,0,1),l.prototype.cross=function(e,t){var i=e.x,r=e.y,o=e.z,n=this.x,a=this.y,s=this.z;return(t=t||new l).x=a*o-s*r,t.y=s*i-n*o,t.z=n*r-a*i,t},l.prototype.set=function(e,t,i){return this.x=e,this.y=t,this.z=i,this},l.prototype.setZero=function(){this.x=this.y=this.z=0},l.prototype.vadd=function(e,t){return t?(t.x=e.x+this.x,t.y=e.y+this.y,void(t.z=e.z+this.z)):new l(this.x+e.x,this.y+e.y,this.z+e.z)},l.prototype.vsub=function(e,t){return t?(t.x=this.x-e.x,t.y=this.y-e.y,void(t.z=this.z-e.z)):new l(this.x-e.x,this.y-e.y,this.z-e.z)},l.prototype.crossmat=function(){return new i([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},l.prototype.normalize=function(){var e=this.x,t=this.y,i=this.z,r=Math.sqrt(e*e+t*t+i*i);if(0<r){var o=1/r;this.x*=o,this.y*=o,this.z*=o}else this.x=0,this.y=0,this.z=0;return r},l.prototype.unit=function(e){e=e||new l;var t=this.x,i=this.y,r=this.z,o=Math.sqrt(t*t+i*i+r*r);return 0<o?(o=1/o,e.x=t*o,e.y=i*o,e.z=r*o):(e.x=1,e.y=0,e.z=0),e},l.prototype.length=l.prototype.norm=function(){var e=this.x,t=this.y,i=this.z;return Math.sqrt(e*e+t*t+i*i)},l.prototype.lengthSquared=l.prototype.norm2=function(){return this.dot(this)},l.prototype.distanceTo=function(e){var t=this.x,i=this.y,r=this.z,o=e.x,n=e.y,a=e.z;return Math.sqrt((o-t)*(o-t)+(n-i)*(n-i)+(a-r)*(a-r))},l.prototype.distanceSquared=function(e){var t=this.x,i=this.y,r=this.z,o=e.x,n=e.y,a=e.z;return(o-t)*(o-t)+(n-i)*(n-i)+(a-r)*(a-r)},l.prototype.scale=l.prototype.mult=function(e,t){t=t||new l;var i=this.x,r=this.y,o=this.z;return t.x=e*i,t.y=e*r,t.z=e*o,t},l.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},l.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},l.prototype.negate=function(e){return(e=e||new l).x=-this.x,e.y=-this.y,e.z=-this.z,e};var a=new l,s=new l;l.prototype.tangents=function(e,t){var i=this.norm();if(0<i){var r=a,o=1/i;r.set(this.x*o,this.y*o,this.z*o);var n=s;Math.abs(r.x)<.9?n.set(1,0,0):n.set(0,1,0),r.cross(n,e),r.cross(e,t)}else e.set(1,0,0),t.set(0,1,0)},l.prototype.toString=function(){return this.x+","+this.y+","+this.z},l.prototype.toArray=function(){return[this.x,this.y,this.z]},l.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},l.prototype.lerp=function(e,t,i){var r=this.x,o=this.y,n=this.z;i.x=r+(e.x-r)*t,i.y=o+(e.y-o)*t,i.z=n+(e.z-n)*t},l.prototype.almostEquals=function(e,t){return void 0===t&&(t=1e-6),!(Math.abs(this.x-e.x)>t||Math.abs(this.y-e.y)>t||Math.abs(this.z-e.z)>t)},l.prototype.almostZero=function(e){return void 0===e&&(e=1e-6),!(Math.abs(this.x)>e||Math.abs(this.y)>e||Math.abs(this.z)>e)};var r=new l;l.prototype.isAntiparallelTo=function(e,t){return this.negate(r),r.almostEquals(e,t)},l.prototype.clone=function(){return new l(this.x,this.y,this.z)}},{"./Mat3":27}],31:[function(e,t){function n(e){e=e||{},i.apply(this),this.id=n.idCounter++,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new a,this.collisionFilterGroup="number"==typeof e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask="number"==typeof e.collisionFilterMask?e.collisionFilterMask:1,this.collisionResponse=!0,this.position=new a,e.position&&this.position.copy(e.position),this.previousPosition=new a,this.initPosition=new a,this.velocity=new a,e.velocity&&this.velocity.copy(e.velocity),this.initVelocity=new a,this.force=new a;var t="number"==typeof e.mass?e.mass:0;this.mass=t,this.invMass=0<t?1/t:0,this.material=e.material||null,this.linearDamping="number"==typeof e.linearDamping?e.linearDamping:.01,this.type=t<=0?n.STATIC:n.DYNAMIC,typeof e.type==typeof n.STATIC&&(this.type=e.type),this.allowSleep=void 0===e.allowSleep||e.allowSleep,this.sleepState=0,this.sleepSpeedLimit=void 0!==e.sleepSpeedLimit?e.sleepSpeedLimit:.1,this.sleepTimeLimit=void 0!==e.sleepTimeLimit?e.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new a,this.quaternion=new s,e.quaternion&&this.quaternion.copy(e.quaternion),this.initQuaternion=new s,this.angularVelocity=new a,e.angularVelocity&&this.angularVelocity.copy(e.angularVelocity),this.initAngularVelocity=new a,this.interpolatedPosition=new a,this.interpolatedQuaternion=new s,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new a,this.invInertia=new a,this.invInertiaWorld=new r,this.invMassSolve=0,this.invInertiaSolve=new a,this.invInertiaWorldSolve=new r,this.fixedRotation=void 0!==e.fixedRotation&&e.fixedRotation,this.angularDamping=void 0!==e.angularDamping?e.angularDamping:.01,this.aabb=new o,this.aabbNeedsUpdate=!0,this.wlambda=new a,e.shape&&this.addShape(e.shape),this.updateMassProperties()}t.exports=n;var i=e("../utils/EventTarget"),a=(e("../shapes/Shape"),e("../math/Vec3")),r=e("../math/Mat3"),s=e("../math/Quaternion"),o=(e("../material/Material"),e("../collision/AABB")),l=e("../shapes/Box");((n.prototype=new i).constructor=n).DYNAMIC=1,n.STATIC=2,n.KINEMATIC=4,n.AWAKE=0,n.SLEEPY=1,n.SLEEPING=2,n.idCounter=0,n.prototype.wakeUp=function(){var e=this.sleepState;this.sleepState=0,e===n.SLEEPING&&this.dispatchEvent({type:"wakeup"})},n.prototype.sleep=function(){this.sleepState=n.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0)},n.sleepyEvent={type:"sleepy"},n.sleepEvent={type:"sleep"},n.prototype.sleepTick=function(e){if(this.allowSleep){var t=this.sleepState,i=this.velocity.norm2()+this.angularVelocity.norm2(),r=Math.pow(this.sleepSpeedLimit,2);t===n.AWAKE&&i<r?(this.sleepState=n.SLEEPY,this.timeLastSleepy=e,this.dispatchEvent(n.sleepyEvent)):t===n.SLEEPY&&r<i?this.wakeUp():t===n.SLEEPY&&e-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(n.sleepEvent))}},n.prototype.updateSolveMassProperties=function(){this.sleepState===n.SLEEPING||this.type===n.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},n.prototype.pointToLocalFrame=function(e,t){t=t||new a;return e.vsub(this.position,t),this.quaternion.conjugate().vmult(t,t),t},n.prototype.vectorToLocalFrame=function(e,t){t=t||new a;return this.quaternion.conjugate().vmult(e,t),t},n.prototype.pointToWorldFrame=function(e,t){t=t||new a;return this.quaternion.vmult(e,t),t.vadd(this.position,t),t},n.prototype.vectorToWorldFrame=function(e,t){t=t||new a;return this.quaternion.vmult(e,t),t};var u=new a,d=new s;n.prototype.addShape=function(e,t,i){var r=new a,o=new s;return t&&r.copy(t),i&&o.copy(i),this.shapes.push(e),this.shapeOffsets.push(r),this.shapeOrientations.push(o),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,this},n.prototype.updateBoundingRadius=function(){for(var e=this.shapes,t=this.shapeOffsets,i=e.length,r=0,o=0;o!==i;o++){var n=e[o];n.updateBoundingSphereRadius();var a=t[o].norm(),s=n.boundingSphereRadius;r<a+s&&(r=a+s)}this.boundingRadius=r};var p=new o;n.prototype.computeAABB=function(){for(var e=this.shapes,t=this.shapeOffsets,i=this.shapeOrientations,r=e.length,o=u,n=d,a=this.quaternion,s=this.aabb,l=p,c=0;c!==r;c++){var h=e[c];i[c].mult(a,n),n.vmult(t[c],o),o.vadd(this.position,o),h.calculateWorldAABB(o,n,l.lowerBound,l.upperBound),0===c?s.copy(l):s.extend(l)}this.aabbNeedsUpdate=!1};var c=new r,h=new r;new r,n.prototype.updateInertiaWorld=function(e){var t=this.invInertia;if(t.x!==t.y||t.y!==t.z||e){var i=c,r=h;i.setRotationFromQuaternion(this.quaternion),i.transpose(r),i.scale(t,i),i.mmult(r,this.invInertiaWorld)}};var m=new a,f=new a;n.prototype.applyForce=function(e,t){if(this.type===n.DYNAMIC){var i=m;t.vsub(this.position,i);var r=f;i.cross(e,r),this.force.vadd(e,this.force),this.torque.vadd(r,this.torque)}};var v=new a,y=new a;n.prototype.applyLocalForce=function(e,t){if(this.type===n.DYNAMIC){var i=v,r=y;this.vectorToWorldFrame(e,i),this.pointToWorldFrame(t,r),this.applyForce(i,r)}};var g=new a,x=new a,w=new a;n.prototype.applyImpulse=function(e,t){if(this.type===n.DYNAMIC){var i=g;t.vsub(this.position,i);var r=x;r.copy(e),r.mult(this.invMass,r),this.velocity.vadd(r,this.velocity);var o=w;i.cross(e,o),this.invInertiaWorld.vmult(o,o),this.angularVelocity.vadd(o,this.angularVelocity)}};var b=new a,T=new a;n.prototype.applyLocalImpulse=function(e,t){if(this.type===n.DYNAMIC){var i=b,r=T;this.vectorToWorldFrame(e,i),this.pointToWorldFrame(t,r),this.applyImpulse(i,r)}};var S=new a;n.prototype.updateMassProperties=function(){var e=S;this.invMass=0<this.mass?1/this.mass:0;var t=this.inertia,i=this.fixedRotation;this.computeAABB(),e.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),l.calculateInertia(e,this.mass,t),this.invInertia.set(0<t.x&&!i?1/t.x:0,0<t.y&&!i?1/t.y:0,0<t.z&&!i?1/t.z:0),this.updateInertiaWorld(!0)},n.prototype.getVelocityAtWorldPoint=function(e,t){var i=new a;return e.vsub(this.position,i),this.angularVelocity.cross(i,t),this.velocity.vadd(t,t),t}},{"../collision/AABB":3,"../material/Material":25,"../math/Mat3":27,"../math/Quaternion":28,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Shape":43,"../utils/EventTarget":49}],32:[function(e,t){function i(e){this.chassisBody=e.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==e.indexRightAxis?e.indexRightAxis:1,this.indexForwardAxis=void 0!==e.indexForwardAxis?e.indexForwardAxis:0,this.indexUpAxis=void 0!==e.indexUpAxis?e.indexUpAxis:2}function O(e,t,i,r,o){var n=0,a=i,s=f,l=v,c=x;e.getVelocityAtWorldPoint(a,s),t.getVelocityAtWorldPoint(a,l),s.vsub(l,c);return o<(n=-r.dot(c)*(1/(h(e,i,r)+h(t,i,r))))&&(n=o),n<-o&&(n=-o),n}function h(e,t,i){var r=s,o=l,n=c,a=w;return t.vsub(e.position,r),r.cross(i,o),e.invInertiaWorld.vmult(o,a),a.cross(r,n),e.invMass+i.dot(n)}function N(e,t,i,r,o,n){if(1.1<o.norm2())return 0;var a=b,s=T,l=S;e.getVelocityAtWorldPoint(t,a),i.getVelocityAtWorldPoint(r,s),a.vsub(s,l);return-.2*o.dot(l)*(1/(e.invMass+i.invMass))}var A=(e("./Body"),e("../math/Vec3")),u=e("../math/Quaternion"),r=(e("../collision/RaycastResult"),e("../collision/Ray")),o=e("../objects/WheelInfo");t.exports=i;var d=(new A,new A,new A,new A),p=new A,m=new A;new r,i.prototype.addWheel=function(e){var t=new o(e=e||{}),i=this.wheelInfos.length;return this.wheelInfos.push(t),i},i.prototype.setSteeringValue=function(e,t){this.wheelInfos[t].steering=e},new A,i.prototype.applyEngineForce=function(e,t){this.wheelInfos[t].engineForce=e},i.prototype.setBrake=function(e,t){this.wheelInfos[t].brake=e},i.prototype.addToWorld=function(e){this.constraints,e.add(this.chassisBody);var t=this;this.preStepCallback=function(){t.updateVehicle(e.dt)},e.addEventListener("preStep",this.preStepCallback),this.world=e},i.prototype.getVehicleAxisWorld=function(e,t){t.set(0===e?1:0,1===e?1:0,2===e?1:0),this.chassisBody.vectorToWorldFrame(t,t)},i.prototype.updateVehicle=function(e){for(var t=this.wheelInfos,i=t.length,r=this.chassisBody,o=0;o<i;o++)this.updateWheelTransform(o);this.currentVehicleSpeedKmHour=3.6*r.velocity.norm();var n=new A;this.getVehicleAxisWorld(this.indexForwardAxis,n),n.dot(r.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1);for(o=0;o<i;o++)this.castRay(t[o]);this.updateSuspension(e);var a=new A,s=new A;for(o=0;o<i;o++){var l=(d=t[o]).suspensionForce;l>d.maxSuspensionForce&&(l=d.maxSuspensionForce),d.raycastResult.hitNormalWorld.scale(l*e,a),d.raycastResult.hitPointWorld.vsub(r.position,s),r.applyImpulse(a,d.raycastResult.hitPointWorld)}this.updateFriction(e);var c=new A,h=new A,u=new A;for(o=0;o<i;o++){var d=t[o];r.getVelocityAtWorldPoint(d.chassisConnectionPointWorld,u);var p=1;switch(this.indexUpAxis){case 1:p=-1}if(d.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,h);var m=h.dot(d.raycastResult.hitNormalWorld);d.raycastResult.hitNormalWorld.scale(m,c),h.vsub(c,h);var f=h.dot(u);d.deltaRotation=p*f*e/d.radius}!d.sliding&&d.isInContact||0===d.engineForce||!d.useCustomSlidingRotationalSpeed||(d.deltaRotation=(0<d.engineForce?1:-1)*d.customSlidingRotationalSpeed*e),Math.abs(d.brake)>Math.abs(d.engineForce)&&(d.deltaRotation=0),d.rotation+=d.deltaRotation,d.deltaRotation*=.99}},i.prototype.updateSuspension=function(){for(var e=this.chassisBody.mass,t=this.wheelInfos,i=t.length,r=0;r<i;r++){var o=t[r];if(o.isInContact){var n,a=o.suspensionRestLength-o.suspensionLength;n=o.suspensionStiffness*a*o.clippedInvContactDotSuspension;var s=o.suspensionRelativeVelocity;n-=(s<0?o.dampingCompression:o.dampingRelaxation)*s,o.suspensionForce=n*e,o.suspensionForce<0&&(o.suspensionForce=0)}else o.suspensionForce=0}},i.prototype.removeFromWorld=function(e){this.constraints,e.remove(this.chassisBody),e.removeEventListener("preStep",this.preStepCallback),this.world=null};var y=new A,g=new A;i.prototype.castRay=function(e){var t=y,i=g;this.updateWheelTransformWorld(e);var r=this.chassisBody,o=-1,n=e.suspensionRestLength+e.radius;e.directionWorld.scale(n,t);var a=e.chassisConnectionPointWorld;a.vadd(t,i);var s=e.raycastResult;s.reset();var l=r.collisionResponse;r.collisionResponse=!1,this.world.rayTest(a,i,s),r.collisionResponse=l;var c=s.body;if(e.raycastResult.groundObject=0,c){o=s.distance,e.raycastResult.hitNormalWorld=s.hitNormalWorld,e.isInContact=!0;var h=s.distance;e.suspensionLength=h-e.radius;var u=e.suspensionRestLength-e.maxSuspensionTravel,d=e.suspensionRestLength+e.maxSuspensionTravel;e.suspensionLength<u&&(e.suspensionLength=u),e.suspensionLength>d&&(e.suspensionLength=d,e.raycastResult.reset());var p=e.raycastResult.hitNormalWorld.dot(e.directionWorld),m=new A;r.getVelocityAtWorldPoint(e.raycastResult.hitPointWorld,m);var f=e.raycastResult.hitNormalWorld.dot(m);if(-.1<=p)e.suspensionRelativeVelocity=0,e.clippedInvContactDotSuspension=10;else{var v=-1/p;e.suspensionRelativeVelocity=f*v,e.clippedInvContactDotSuspension=v}}else e.suspensionLength=e.suspensionRestLength+0*e.maxSuspensionTravel,e.suspensionRelativeVelocity=0,e.directionWorld.scale(-1,e.raycastResult.hitNormalWorld),e.clippedInvContactDotSuspension=1;return o},i.prototype.updateWheelTransformWorld=function(e){e.isInContact=!1;var t=this.chassisBody;t.pointToWorldFrame(e.chassisConnectionPointLocal,e.chassisConnectionPointWorld),t.vectorToWorldFrame(e.directionLocal,e.directionWorld),t.vectorToWorldFrame(e.axleLocal,e.axleWorld)},i.prototype.updateWheelTransform=function(e){var t=d,i=p,r=m,o=this.wheelInfos[e];this.updateWheelTransformWorld(o),o.directionLocal.scale(-1,t),i.copy(o.axleLocal),t.cross(i,r),r.normalize(),i.normalize();var n=o.steering,a=new u;a.setFromAxisAngle(t,n);var s=new u;s.setFromAxisAngle(i,o.rotation);var l=o.worldTransform.quaternion;this.chassisBody.quaternion.mult(a,l),l.mult(s,l),l.normalize();var c=o.worldTransform.position;c.copy(o.directionWorld),c.scale(o.suspensionLength,c),c.vadd(o.chassisConnectionPointWorld,c)};var M=[new A(1,0,0),new A(0,1,0),new A(0,0,1)];i.prototype.getWheelTransformWorld=function(e){return this.wheelInfos[e].worldTransform};var P=new A,E=[],L=[];i.prototype.updateFriction=function(e){for(var t=P,i=this.wheelInfos,r=i.length,o=this.chassisBody,n=L,a=E,s=0;s<r;s++){(u=(w=i[s]).raycastResult.body)&&0,w.sideImpulse=0,w.forwardImpulse=0,n[s]||(n[s]=new A),a[s]||(a[s]=new A)}for(s=0;s<r;s++){if(u=(w=i[s]).raycastResult.body){var l=a[s];this.getWheelTransformWorld(s).vectorToWorldFrame(M[this.indexRightAxis],l);var c=w.raycastResult.hitNormalWorld,h=l.dot(c);c.scale(h,t),l.vsub(t,l),l.normalize(),c.cross(l,n[s]),n[s].normalize(),w.sideImpulse=N(o,w.raycastResult.hitPointWorld,u,w.raycastResult.hitPointWorld,l),w.sideImpulse*=1}}this.sliding=!1;for(s=0;s<r;s++){var u=(w=i[s]).raycastResult.body,d=0;if(w.slipInfo=1,u){var p=w.brake?w.brake:0;d=O(o,u,w.raycastResult.hitPointWorld,n[s],p);var m=p/(d+=w.engineForce*e);w.slipInfo*=m}if(w.forwardImpulse=0,w.skidInfo=1,u){w.skidInfo=1;var f=w.suspensionForce*e*w.frictionSlip,v=f*f;w.forwardImpulse=d;var y=.5*w.forwardImpulse,g=1*w.sideImpulse,x=y*y+g*g;if(w.sliding=!1,v<x){this.sliding=!0,w.sliding=!0;m=f/Math.sqrt(x);w.skidInfo*=m}}}if(this.sliding)for(s=0;s<r;s++){0!==(w=i[s]).sideImpulse&&w.skidInfo<1&&(w.forwardImpulse*=w.skidInfo,w.sideImpulse*=w.skidInfo)}for(s=0;s<r;s++){var w=i[s],b=new A;if(b.copy(w.raycastResult.hitPointWorld),0!==w.forwardImpulse){var T=new A;n[s].scale(w.forwardImpulse,T),o.applyImpulse(T,b)}if(0!==w.sideImpulse){u=w.raycastResult.body;var S=new A;S.copy(w.raycastResult.hitPointWorld);var C=new A;a[s].scale(w.sideImpulse,C),o.pointToLocalFrame(b,b),b["xyz"[this.indexUpAxis]]*=w.rollInfluence,o.pointToWorldFrame(b,b),o.applyImpulse(C,b),C.scale(-1,C),u.applyImpulse(C,S)}}};var f=new A,v=new A,x=new A,s=new A,l=new A,c=new A,w=new A,b=new A,T=new A,S=new A},{"../collision/Ray":9,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Vec3":30,"../objects/WheelInfo":36,"./Body":31}],33:[function(e,t){function i(e){if(this.wheelBodies=[],this.coordinateSystem=void 0===e.coordinateSystem?new l(1,2,3):e.coordinateSystem.clone(),this.chassisBody=e.chassisBody,!this.chassisBody){var t=new r(new l(5,2,.5));this.chassisBody=new a(1,t)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}var a=e("./Body"),s=e("../shapes/Sphere"),r=e("../shapes/Box"),l=e("../math/Vec3"),c=e("../constraints/HingeConstraint");(t.exports=i).prototype.addWheel=function(e){var t=(e=e||{}).body;t||(t=new a(1,new s(1.2))),this.wheelBodies.push(t),this.wheelForces.push(0);var i=(new l,void 0!==e.position?e.position.clone():new l),r=new l;this.chassisBody.pointToWorldFrame(i,r),t.position.set(r.x,r.y,r.z);var o=void 0!==e.axis?e.axis.clone():new l(0,1,0);this.wheelAxes.push(o);var n=new c(this.chassisBody,t,{pivotA:i,axisA:o,pivotB:l.ZERO,axisB:o,collideConnected:!1});return this.constraints.push(n),this.wheelBodies.length-1},i.prototype.setSteeringValue=function(e,t){var i=this.wheelAxes[t],r=Math.cos(e),o=Math.sin(e),n=i.x,a=i.y;this.constraints[t].axisA.set(r*n-o*a,o*n+r*a,0)},i.prototype.setMotorSpeed=function(e,t){var i=this.constraints[t];i.enableMotor(),i.motorTargetVelocity=e},i.prototype.disableMotor=function(e){this.constraints[e].disableMotor()};var n=new l;i.prototype.setWheelForce=function(e,t){this.wheelForces[t]=e},i.prototype.applyWheelForce=function(e,t){var i=this.wheelAxes[t],r=this.wheelBodies[t],o=r.torque;i.scale(e,n),r.vectorToWorldFrame(n,n),o.vadd(n,o)},i.prototype.addToWorld=function(e){for(var t=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),r=0;r<i.length;r++)e.add(i[r]);for(r=0;r<t.length;r++)e.addConstraint(t[r]);e.addEventListener("preStep",this._update.bind(this))},i.prototype._update=function(){for(var e=this.wheelForces,t=0;t<e.length;t++)this.applyWheelForce(e[t],t)},i.prototype.removeFromWorld=function(e){for(var t=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),r=0;r<i.length;r++)e.remove(i[r]);for(r=0;r<t.length;r++)e.removeConstraint(t[r])};var o=new l;i.prototype.getWheelSpeed=function(e){var t=this.wheelAxes[e],i=this.wheelBodies[e].angularVelocity;return this.chassisBody.vectorToWorldFrame(t,o),i.dot(o)}},{"../constraints/HingeConstraint":15,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Sphere":44,"./Body":31}],34:[function(e,t){function i(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}t.exports=i;var r=(e("../shapes/Shape"),e("../math/Vec3"));e("../math/Quaternion"),e("../shapes/Particle"),e("../objects/Body"),e("../material/Material"),i.prototype.add=function(e){this.particles.push(e),this.neighbors.length<this.particles.length&&this.neighbors.push([])},i.prototype.remove=function(e){var t=this.particles.indexOf(e);-1!==t&&(this.particles.splice(t,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var l=new r;i.prototype.getNeighbors=function(e,t){for(var i=this.particles.length,r=e.id,o=this.smoothingRadius*this.smoothingRadius,n=l,a=0;a!==i;a++){var s=this.particles[a];s.position.vsub(e.position,n),r!==s.id&&n.norm2()<o&&t.push(s)}};var T=new r,S=new r,C=new r,O=new r,N=new r,A=new r;i.prototype.update=function(){for(var e=this.particles.length,t=T,i=this.speedOfSound,r=this.eps,o=0;o!==e;o++){var n=this.particles[o];(x=this.neighbors[o]).length=0,this.getNeighbors(n,x),x.push(this.particles[o]);for(var a=x.length,s=0,l=0;l!==a;l++){n.position.vsub(x[l].position,t);var c=t.norm(),h=this.w(c);s+=x[l].mass*h}this.densities[o]=s,this.pressures[o]=i*i*(this.densities[o]-this.density)}var u=S,d=C,p=O,m=N,f=A;for(o=0;o!==e;o++){var v=this.particles[o];u.set(0,0,0),d.set(0,0,0);var y,g,x;for(a=(x=this.neighbors[o]).length,l=0;l!==a;l++){var w=x[l];v.position.vsub(w.position,m);var b=m.norm();y=-w.mass*(this.pressures[o]/(this.densities[o]*this.densities[o]+r)+this.pressures[l]/(this.densities[l]*this.densities[l]+r)),this.gradw(m,p),p.mult(y,p),u.vadd(p,u),w.velocity.vsub(v.velocity,f),f.mult(1/(1e-4+this.densities[o]*this.densities[l])*this.viscosity*w.mass,f),g=this.nablaw(b),f.mult(g,f),d.vadd(f,d)}d.mult(v.mass,d),u.mult(v.mass,u),v.force.vadd(d,v.force),v.force.vadd(u,v.force)}},i.prototype.w=function(e){var t=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(t,9))*Math.pow(t*t-e*e,3)},i.prototype.gradw=function(e,t){var i=e.norm(),r=this.smoothingRadius;e.mult(945/(32*Math.PI*Math.pow(r,9))*Math.pow(r*r-i*i,2),t)},i.prototype.nablaw=function(e){var t=this.smoothingRadius;return 945/(32*Math.PI*Math.pow(t,9))*(t*t-e*e)*(7*e*e-3*t*t)}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Particle":41,"../shapes/Shape":43}],35:[function(e,t){function i(e,t,i){i=i||{},this.restLength="number"==typeof i.restLength?i.restLength:1,this.stiffness=i.stiffness||100,this.damping=i.damping||1,this.bodyA=e,this.bodyB=t,this.localAnchorA=new r,this.localAnchorB=new r,i.localAnchorA&&this.localAnchorA.copy(i.localAnchorA),i.localAnchorB&&this.localAnchorB.copy(i.localAnchorB),i.worldAnchorA&&this.setWorldAnchorA(i.worldAnchorA),i.worldAnchorB&&this.setWorldAnchorB(i.worldAnchorB)}var r=e("../math/Vec3");(t.exports=i).prototype.setWorldAnchorA=function(e){this.bodyA.pointToLocalFrame(e,this.localAnchorA)},i.prototype.setWorldAnchorB=function(e){this.bodyB.pointToLocalFrame(e,this.localAnchorB)},i.prototype.getWorldAnchorA=function(e){this.bodyA.pointToWorldFrame(this.localAnchorA,e)},i.prototype.getWorldAnchorB=function(e){this.bodyB.pointToWorldFrame(this.localAnchorB,e)};var y=new r,g=new r,x=new r,w=new r,b=new r,T=new r,S=new r,C=new r,O=new r,N=new r,A=new r;i.prototype.applyForce=function(){var e=this.stiffness,t=this.damping,i=this.restLength,r=this.bodyA,o=this.bodyB,n=y,a=g,s=x,l=w,c=A,h=b,u=T,d=S,p=C,m=O,f=N;this.getWorldAnchorA(h),this.getWorldAnchorB(u),h.vsub(r.position,d),u.vsub(o.position,p),u.vsub(h,n);var v=n.norm();a.copy(n),a.normalize(),o.velocity.vsub(r.velocity,s),o.angularVelocity.cross(p,c),s.vadd(c,s),r.angularVelocity.cross(d,c),s.vsub(c,s),a.mult(-e*(v-i)-t*s.dot(a),l),r.force.vsub(l,r.force),o.force.vadd(l,o.force),d.cross(l,m),p.cross(l,f),r.torque.vsub(m,r.torque),o.torque.vadd(f,o.torque)}},{"../math/Vec3":30}],36:[function(e,t){function i(e){e=a.defaults(e,{chassisConnectionPointLocal:new r,chassisConnectionPointWorld:new r,directionLocal:new r,directionWorld:new r,axleLocal:new r,axleWorld:new r,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=e.maxSuspensionTravel,this.customSlidingRotationalSpeed=e.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=e.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=e.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=e.chassisConnectionPointWorld.clone(),this.directionLocal=e.directionLocal.clone(),this.directionWorld=e.directionWorld.clone(),this.axleLocal=e.axleLocal.clone(),this.axleWorld=e.axleWorld.clone(),this.suspensionRestLength=e.suspensionRestLength,this.suspensionMaxLength=e.suspensionMaxLength,this.radius=e.radius,this.suspensionStiffness=e.suspensionStiffness,this.dampingCompression=e.dampingCompression,this.dampingRelaxation=e.dampingRelaxation,this.frictionSlip=e.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=e.rollInfluence,this.maxSuspensionForce=e.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=e.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new n,this.worldTransform=new o,this.isInContact=!1}var r=e("../math/Vec3"),o=e("../math/Transform"),n=e("../collision/RaycastResult"),a=e("../utils/Utils");t.exports=i;var s=new r,l=new r;s=new r;i.prototype.updateWheel=function(e){var t=this.raycastResult;if(this.isInContact){var i=t.hitNormalWorld.dot(t.directionWorld);t.hitPointWorld.vsub(e.position,l),e.getVelocityAtWorldPoint(l,s);var r=t.hitNormalWorld.dot(s);if(-.1<=i)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{var o=-1/i;this.suspensionRelativeVelocity=r*o,this.clippedInvContactDotSuspension=o}}else t.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,t.directionWorld.scale(-1,t.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":10,"../math/Transform":29,"../math/Vec3":30,"../utils/Utils":53}],37:[function(e,t){function i(e){r.call(this),this.type=r.types.BOX,this.halfExtents=e,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}t.exports=i;var r=e("./Shape"),a=e("../math/Vec3"),s=e("./ConvexPolyhedron");((i.prototype=new r).constructor=i).prototype.updateConvexPolyhedronRepresentation=function(){var e=this.halfExtents.x,t=this.halfExtents.y,i=this.halfExtents.z,r=a,o=[new r(-e,-t,-i),new r(e,-t,-i),new r(e,t,-i),new r(-e,t,-i),new r(-e,-t,i),new r(e,-t,i),new r(e,t,i),new r(-e,t,i)],n=(new r(0,0,1),new r(0,1,0),new r(1,0,0),new s(o,[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]]));(this.convexPolyhedronRepresentation=n).material=this.material},i.prototype.calculateLocalInertia=function(e,t){return t=t||new a,i.calculateInertia(this.halfExtents,e,t),t},i.calculateInertia=function(e,t,i){var r=e;i.x=1/12*t*(2*r.y*2*r.y+2*r.z*2*r.z),i.y=1/12*t*(2*r.x*2*r.x+2*r.z*2*r.z),i.z=1/12*t*(2*r.y*2*r.y+2*r.x*2*r.x)},i.prototype.getSideNormals=function(e,t){var i=e,r=this.halfExtents;if(i[0].set(r.x,0,0),i[1].set(0,r.y,0),i[2].set(0,0,r.z),i[3].set(-r.x,0,0),i[4].set(0,-r.y,0),i[5].set(0,0,-r.z),void 0!==t)for(var o=0;o!==i.length;o++)t.vmult(i[o],i[o]);return i},i.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},i.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var l=new a;new a,i.prototype.forEachWorldCorner=function(e,t,i){for(var r=this.halfExtents,o=[[r.x,r.y,r.z],[-r.x,r.y,r.z],[-r.x,-r.y,r.z],[-r.x,-r.y,-r.z],[r.x,-r.y,-r.z],[r.x,r.y,-r.z],[-r.x,r.y,-r.z],[r.x,-r.y,r.z]],n=0;n<o.length;n++)l.set(o[n][0],o[n][1],o[n][2]),t.vmult(l,l),e.vadd(l,l),i(l.x,l.y,l.z)};var h=[new a,new a,new a,new a,new a,new a,new a,new a];i.prototype.calculateWorldAABB=function(e,t,i,r){var o=this.halfExtents;h[0].set(o.x,o.y,o.z),h[1].set(-o.x,o.y,o.z),h[2].set(-o.x,-o.y,o.z),h[3].set(-o.x,-o.y,-o.z),h[4].set(o.x,-o.y,-o.z),h[5].set(o.x,o.y,-o.z),h[6].set(-o.x,o.y,-o.z),h[7].set(o.x,-o.y,o.z);var n=h[0];t.vmult(n,n),e.vadd(n,n),r.copy(n),i.copy(n);for(var a=1;a<8;a++){n=h[a];t.vmult(n,n),e.vadd(n,n);var s=n.x,l=n.y,c=n.z;s>r.x&&(r.x=s),l>r.y&&(r.y=l),c>r.z&&(r.z=c),s<i.x&&(i.x=s),l<i.y&&(i.y=l),c<i.z&&(i.z=c)}}},{"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],38:[function(e,t){function d(e,t,i){r.call(this),this.type=r.types.CONVEXPOLYHEDRON,this.vertices=e||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=t||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=i?i.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}t.exports=d;var r=e("./Shape"),w=e("../math/Vec3"),f=(e("../math/Quaternion"),e("../math/Transform"));(d.prototype=new r).constructor=d;var u=new w;d.prototype.computeEdges=function(){var e=this.faces,t=this.vertices,i=(t.length,this.uniqueEdges);i.length=0;for(var r=u,o=0;o!==e.length;o++)for(var n=e[o],a=n.length,s=0;s!==a;s++){var l=(s+1)%a;t[n[s]].vsub(t[n[l]],r),r.normalize();for(var c=!1,h=0;h!==i.length;h++)if(i[h].almostEquals(r)||i[h].almostEquals(r)){c=!0;break}c||i.push(r.clone())}},d.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var e=0;e<this.faces.length;e++){for(var t=0;t<this.faces[e].length;t++)if(!this.vertices[this.faces[e][t]])throw new Error("Vertex "+this.faces[e][t]+" not found!");var i=this.faceNormals[e]||new w;this.getFaceNormal(e,i),i.negate(i),this.faceNormals[e]=i;var r=this.vertices[this.faces[e][0]];if(i.dot(r)<0){console.error(".faceNormals["+e+"] = Vec3("+i.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(t=0;t<this.faces[e].length;t++)console.warn(".vertices["+this.faces[e][t]+"] = Vec3("+this.vertices[this.faces[e][t]].toString()+")")}}};var o=new w,n=new w;d.computeNormal=function(e,t,i,r){t.vsub(e,n),i.vsub(t,o),o.cross(n,r),r.isZero()||r.normalize()},d.prototype.getFaceNormal=function(e,t){var i=this.faces[e],r=this.vertices[i[0]],o=this.vertices[i[1]],n=this.vertices[i[2]];return d.computeNormal(r,o,n,t)};var b=new w;d.prototype.clipAgainstHull=function(e,t,i,r,o,n,a,s,l){for(var c=b,h=-1,u=-Number.MAX_VALUE,d=0;d<i.faces.length;d++){c.copy(i.faceNormals[d]),o.vmult(c,c);var p=c.dot(n);u<p&&(u=p,h=d)}for(var m=[],f=i.faces[h],v=f.length,y=0;y<v;y++){var g=i.vertices[f[y]],x=new w;x.copy(g),o.vmult(x,x),r.vadd(x,x),m.push(x)}0<=h&&this.clipFaceAgainstHull(n,e,t,m,a,s,l)};var C=new w,O=new w,N=new w,A=new w,M=new w,P=new w;d.prototype.findSeparatingAxis=function(e,t,i,r,o,n,a,s){var l=C,c=O,h=N,u=A,d=M,p=P,m=Number.MAX_VALUE,f=this;if(f.uniqueAxes)for(var v=0;v!==f.uniqueAxes.length;v++){if(i.vmult(f.uniqueAxes[v],l),!1===(w=f.testSepAxis(l,e,t,i,r,o)))return!1;w<m&&(m=w,n.copy(l))}else{var y=a?a.length:f.faces.length;for(v=0;v<y;v++){var g=a?a[v]:v;if(l.copy(f.faceNormals[g]),i.vmult(l,l),!1===(w=f.testSepAxis(l,e,t,i,r,o)))return!1;w<m&&(m=w,n.copy(l))}}if(e.uniqueAxes)for(v=0;v!==e.uniqueAxes.length;v++){if(o.vmult(e.uniqueAxes[v],c),0,!1===(w=f.testSepAxis(c,e,t,i,r,o)))return!1;w<m&&(m=w,n.copy(c))}else{var x=s?s.length:e.faces.length;for(v=0;v<x;v++){var w;g=s?s[v]:v;if(c.copy(e.faceNormals[g]),o.vmult(c,c),0,!1===(w=f.testSepAxis(c,e,t,i,r,o)))return!1;w<m&&(m=w,n.copy(c))}}for(var b=0;b!==f.uniqueEdges.length;b++){i.vmult(f.uniqueEdges[b],u);for(var T=0;T!==e.uniqueEdges.length;T++)if(o.vmult(e.uniqueEdges[T],d),u.cross(d,p),!p.almostZero()){p.normalize();var S=f.testSepAxis(p,e,t,i,r,o);if(!1===S)return!1;S<m&&(m=S,n.copy(p))}}return r.vsub(t,h),0<h.dot(n)&&n.negate(n),!0};var p=[],m=[];d.prototype.testSepAxis=function(e,t,i,r,o,n){d.project(this,e,i,r,p),d.project(t,e,o,n,m);var a=p[0],s=p[1],l=m[0],c=m[1];if(a<c||l<s)return!1;var h=a-c,u=l-s;return h<u?h:u};var a=new w,s=new w;d.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(a,s);var i=s.x-a.x,r=s.y-a.y,o=s.z-a.z;t.x=1/12*e*(2*r*2*r+2*o*2*o),t.y=1/12*e*(2*i*2*i+2*o*2*o),t.z=1/12*e*(2*r*2*r+2*i*2*i)},d.prototype.getPlaneConstantOfFace=function(e){var t=this.faces[e],i=this.faceNormals[e],r=this.vertices[t[0]];return-i.dot(r)};var R=new w,j=new w,_=new w,z=new w,k=new w,V=new w,I=new w,U=new w;d.prototype.clipFaceAgainstHull=function(e,t,i,r,o,n,a){for(var s=R,l=j,c=_,h=z,u=k,d=V,p=I,m=U,f=this,v=r,y=[],g=-1,x=Number.MAX_VALUE,w=0;w<f.faces.length;w++){s.copy(f.faceNormals[w]),i.vmult(s,s);var b=s.dot(e);b<x&&(x=b,g=w)}if(!(g<0)){var T=f.faces[g];T.connectedFaces=[];for(var S=0;S<f.faces.length;S++)for(var C=0;C<f.faces[S].length;C++)-1!==T.indexOf(f.faces[S][C])&&S!==g&&-1===T.connectedFaces.indexOf(S)&&T.connectedFaces.push(S);for(var O=(v.length,T.length),N=0;N<O;N++){var A=f.vertices[T[N]],M=f.vertices[T[(N+1)%O]];A.vsub(M,l),c.copy(l),i.vmult(c,c),t.vadd(c,c),h.copy(this.faceNormals[g]),i.vmult(h,h),t.vadd(h,h),c.cross(h,u),u.negate(u),d.copy(A),i.vmult(d,d),t.vadd(d,d);var P=(d.dot(u),T.connectedFaces[N]);p.copy(this.faceNormals[P]);var E=this.getPlaneConstantOfFace(P);m.copy(p),i.vmult(m,m);var L=E-m.dot(t);for(this.clipFaceAgainstPlane(v,y,m,L);v.length;)v.shift();for(;y.length;)v.push(y.shift())}p.copy(this.faceNormals[g]);E=this.getPlaneConstantOfFace(g);m.copy(p),i.vmult(m,m);for(L=E-m.dot(t),S=0;S<v.length;S++){var G=m.dot(v[S])+L;if(G<=o&&(console.log("clamped: depth="+G+" to minDist="+o),G=o),G<=n){var B=v[S];if(G<=0){var F={point:B,normal:m,depth:G};a.push(F)}}}}},d.prototype.clipFaceAgainstPlane=function(e,t,i,r){var o,n,a=e.length;if(a<2)return t;var s=e[e.length-1],l=e[0];o=i.dot(s)+r;for(var c=0;c<a;c++){if(l=e[c],n=i.dot(l)+r,o<0)if(n<0){(h=new w).copy(l),t.push(h)}else{var h=new w;s.lerp(l,o/(o-n),h),t.push(h)}else if(n<0){h=new w;s.lerp(l,o/(o-n),h),t.push(h),t.push(l)}s=l,o=n}return t},d.prototype.computeWorldVertices=function(e,t){for(var i=this.vertices.length;this.worldVertices.length<i;)this.worldVertices.push(new w);for(var r=this.vertices,o=this.worldVertices,n=0;n!==i;n++)t.vmult(r[n],o[n]),e.vadd(o[n],o[n]);this.worldVerticesNeedsUpdate=!1},new w,d.prototype.computeLocalAABB=function(e,t){var i=this.vertices.length,r=this.vertices;e.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),t.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var o=0;o<i;o++){var n=r[o];n.x<e.x?e.x=n.x:n.x>t.x&&(t.x=n.x),n.y<e.y?e.y=n.y:n.y>t.y&&(t.y=n.y),n.z<e.z?e.z=n.z:n.z>t.z&&(t.z=n.z)}},d.prototype.computeWorldFaceNormals=function(e){for(var t=this.faceNormals.length;this.worldFaceNormals.length<t;)this.worldFaceNormals.push(new w);for(var i=this.faceNormals,r=this.worldFaceNormals,o=0;o!==t;o++)e.vmult(i[o],r[o]);this.worldFaceNormalsNeedsUpdate=!1},d.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,i=0,r=t.length;i!==r;i++){var o=t[i].norm2();e<o&&(e=o)}this.boundingSphereRadius=Math.sqrt(e)};var v=new w;d.prototype.calculateWorldAABB=function(e,t,i,r){for(var o,n,a,s,l,c,h=this.vertices.length,u=this.vertices,d=0;d<h;d++){v.copy(u[d]),t.vmult(v,v),e.vadd(v,v);var p=v;p.x<o||void 0===o?o=p.x:(p.x>s||void 0===s)&&(s=p.x),p.y<n||void 0===n?n=p.y:(p.y>l||void 0===l)&&(l=p.y),p.z<a||void 0===a?a=p.z:(p.z>c||void 0===c)&&(c=p.z)}i.set(o,n,a),r.set(s,l,c)},d.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},d.prototype.getAveragePointLocal=function(e){e=e||new w;for(var t=this.vertices.length,i=this.vertices,r=0;r<t;r++)e.vadd(i[r],e);return e.mult(1/t,e),e},d.prototype.transformAllPoints=function(e,t){var i=this.vertices.length,r=this.vertices;if(t){for(var o=0;o<i;o++){var n=r[o];t.vmult(n,n)}for(o=0;o<this.faceNormals.length;o++){n=this.faceNormals[o];t.vmult(n,n)}}if(e)for(o=0;o<i;o++){(n=r[o]).vadd(e,n)}};var y=new w,g=new w,x=new w;d.prototype.pointIsInside=function(e){var t=this.vertices.length,i=this.vertices,r=this.faces,o=this.faceNormals,n=this.faces.length,a=y;this.getAveragePointLocal(a);for(var s=0;s<n;s++){t=(this.faces[s].length,o[s]);var l=i[r[s][0]],c=g;e.vsub(l,c);var h=t.dot(c),u=x;a.vsub(l,u);var d=t.dot(u);if(h<0&&0<d||0<h&&d<0)return!1}return-1};var T=(new w,new w),S=new w;d.project=function(e,t,i,r,o){var n=e.vertices.length,a=T,s=0,l=0,c=S,h=e.vertices;c.setZero(),f.vectorToLocalFrame(i,r,t,a),f.pointToLocalFrame(i,r,c,c);var u=c.dot(a);l=s=h[0].dot(a);for(var d=1;d<n;d++){var p=h[d].dot(a);s<p&&(s=p),p<l&&(l=p)}if((s-=u)<(l-=u)){var m=l;l=s,s=m}o[0]=s,o[1]=l}},{"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"./Shape":43}],39:[function(e,t){function i(e,t,i,r){var o=r,n=[],a=[],s=[],l=[],c=[],h=Math.cos,u=Math.sin;n.push(new y(t*h(0),t*u(0),.5*-i)),l.push(0),n.push(new y(e*h(0),e*u(0),.5*i)),c.push(1);for(var d=0;d<o;d++){var p=2*Math.PI/o*(d+1),m=2*Math.PI/o*(d+.5);d<o-1?(n.push(new y(t*h(p),t*u(p),.5*-i)),l.push(2*d+2),n.push(new y(e*h(p),e*u(p),.5*i)),c.push(2*d+3),s.push([2*d+2,2*d+3,2*d+1,2*d])):s.push([0,1,2*d+1,2*d]),(o%2==1||d<o/2)&&a.push(new y(h(m),u(m),0))}s.push(c),a.push(new y(0,0,1));var f=[];for(d=0;d<l.length;d++)f.push(l[l.length-d-1]);s.push(f),this.type=v.types.CONVEXPOLYHEDRON,g.call(this,n,s,a)}t.exports=i;var v=e("./Shape"),y=e("../math/Vec3"),g=(e("../math/Quaternion"),e("./ConvexPolyhedron"));i.prototype=new g},{"../math/Quaternion":28,"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],40:[function(e,t){function i(e,t){t=o.defaults(t,{maxValue:null,minValue:null,elementSize:1}),this.data=e,this.maxValue=t.maxValue,this.minValue=t.minValue,this.elementSize=t.elementSize,null===t.minValue&&this.updateMinValue(),null===t.maxValue&&this.updateMaxValue(),this.cacheEnabled=!0,r.call(this),this.pillarConvex=new u,this.pillarOffset=new d,this.type=r.types.HEIGHTFIELD,this.updateBoundingSphereRadius(),this._cachedPillars={}}var r=e("./Shape"),u=e("./ConvexPolyhedron"),d=e("../math/Vec3"),o=e("../utils/Utils");((t.exports=i).prototype=new r).update=function(){this._cachedPillars={}},i.prototype.updateMinValue=function(){for(var e=this.data,t=e[0][0],i=0;i!==e.length;i++)for(var r=0;r!==e[i].length;r++){var o=e[i][r];o<t&&(t=o)}this.minValue=t},i.prototype.updateMaxValue=function(){for(var e=this.data,t=e[0][0],i=0;i!==e.length;i++)for(var r=0;r!==e[i].length;r++){var o=e[i][r];t<o&&(t=o)}this.maxValue=t},i.prototype.setHeightValueAtIndex=function(e,t,i){this.data[e][t]=i,this.clearCachedConvexTrianglePillar(e,t,!1),0<e&&(this.clearCachedConvexTrianglePillar(e-1,t,!0),this.clearCachedConvexTrianglePillar(e-1,t,!1)),0<t&&(this.clearCachedConvexTrianglePillar(e,t-1,!0),this.clearCachedConvexTrianglePillar(e,t-1,!1)),0<t&&0<e&&this.clearCachedConvexTrianglePillar(e-1,t-1,!0)},i.prototype.getRectMinMax=function(e,t,i,r,o){o=o||[];for(var n=this.data,a=this.minValue,s=e;s<=i;s++)for(var l=t;l<=r;l++){var c=n[s][l];a<c&&(a=c)}o[0]=this.minValue,o[1]=a},i.prototype.getIndexOfPosition=function(e,t,i,r){var o=this.elementSize,n=this.data,a=Math.floor(e/o),s=Math.floor(t/o);return i[0]=a,i[1]=s,r&&(a<0&&(a=0),s<0&&(s=0),a>=n.length-1&&(a=n.length-1),s>=n[0].length-1&&(s=n[0].length-1)),!(a<0||s<0||a>=n.length-1||s>=n[0].length-1)},i.prototype.getHeightAt=function(e,t,i){var r=[];this.getIndexOfPosition(e,t,r,i);var o=[];return this.getRectMinMax(r[0],r[1]+1,r[0],r[1]+1,o),(o[0]+o[1])/2},i.prototype.getCacheConvexTrianglePillarKey=function(e,t,i){return e+"_"+t+"_"+(i?1:0)},i.prototype.getCachedConvexTrianglePillar=function(e,t,i){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]},i.prototype.setCachedConvexTrianglePillar=function(e,t,i,r,o){this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]={convex:r,offset:o}},i.prototype.clearCachedConvexTrianglePillar=function(e,t,i){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]},i.prototype.getConvexTrianglePillar=function(e,t,i){var r=this.pillarConvex,o=this.pillarOffset;if(this.cacheEnabled){if(n=this.getCachedConvexTrianglePillar(e,t,i))return this.pillarConvex=n.convex,void(this.pillarOffset=n.offset);r=new u,o=new d,this.pillarConvex=r,this.pillarOffset=o}var n=this.data,a=this.elementSize,s=r.faces;r.vertices.length=6;for(var l=0;l<6;l++)r.vertices[l]||(r.vertices[l]=new d);s.length=5;for(l=0;l<5;l++)s[l]||(s[l]=[]);var c=r.vertices,h=(Math.min(n[e][t],n[e+1][t],n[e][t+1],n[e+1][t+1])-this.minValue)/2+this.minValue;i?(o.set((e+.75)*a,(t+.75)*a,h),c[0].set(.25*a,.25*a,n[e+1][t+1]-h),c[1].set(-.75*a,.25*a,n[e][t+1]-h),c[2].set(.25*a,-.75*a,n[e+1][t]-h),c[3].set(.25*a,.25*a,-h-1),c[4].set(-.75*a,.25*a,-h-1),c[5].set(.25*a,-.75*a,-h-1),s[0][0]=0,s[0][1]=1,s[0][2]=2,s[1][0]=5,s[1][1]=4,s[1][2]=3,s[2][0]=2,s[2][1]=5,s[2][2]=3,s[2][3]=0,s[3][0]=3,s[3][1]=4,s[3][2]=1,s[3][3]=0,s[4][0]=1,s[4][1]=4,s[4][2]=5,s[4][3]=2):(o.set((e+.25)*a,(t+.25)*a,h),c[0].set(-.25*a,-.25*a,n[e][t]-h),c[1].set(.75*a,-.25*a,n[e+1][t]-h),c[2].set(-.25*a,.75*a,n[e][t+1]-h),c[3].set(-.25*a,-.25*a,-h-1),c[4].set(.75*a,-.25*a,-h-1),c[5].set(-.25*a,.75*a,-h-1),s[0][0]=0,s[0][1]=1,s[0][2]=2,s[1][0]=5,s[1][1]=4,s[1][2]=3,s[2][0]=0,s[2][1]=2,s[2][2]=5,s[2][3]=3,s[3][0]=1,s[3][1]=0,s[3][2]=3,s[3][3]=4,s[4][0]=4,s[4][1]=5,s[4][2]=2,s[4][3]=1),r.computeNormals(),r.computeEdges(),r.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(e,t,i,r,o)},i.prototype.calculateLocalInertia=function(e,t){return(t=t||new d).set(0,0,0),t},i.prototype.volume=function(){return Number.MAX_VALUE},i.prototype.calculateWorldAABB=function(e,t,i,r){i.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),r.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},i.prototype.updateBoundingSphereRadius=function(){var e=this.data,t=this.elementSize;this.boundingSphereRadius=new d(e.length*t,e[0].length*t,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()}},{"../math/Vec3":30,"../utils/Utils":53,"./ConvexPolyhedron":38,"./Shape":43}],41:[function(e,t){function i(){r.call(this),this.type=r.types.PARTICLE}t.exports=i;var r=e("./Shape"),o=e("../math/Vec3");((i.prototype=new r).constructor=i).prototype.calculateLocalInertia=function(e,t){return(t=t||new o).set(0,0,0),t},i.prototype.volume=function(){return 0},i.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},i.prototype.calculateWorldAABB=function(e,t,i,r){i.copy(e),r.copy(e)}},{"../math/Vec3":30,"./Shape":43}],42:[function(e,t){function i(){r.call(this),this.type=r.types.PLANE,this.worldNormal=new o,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}t.exports=i;var r=e("./Shape"),o=e("../math/Vec3");((i.prototype=new r).constructor=i).prototype.computeWorldNormal=function(e){var t=this.worldNormal;t.set(0,0,1),e.vmult(t,t),this.worldNormalNeedsUpdate=!1},i.prototype.calculateLocalInertia=function(e,t){return t||new o},i.prototype.volume=function(){return Number.MAX_VALUE};var n=new o;i.prototype.calculateWorldAABB=function(e,t,i,r){n.set(0,0,1),t.vmult(n,n);var o=Number.MAX_VALUE;i.set(-o,-o,-o),r.set(o,o,o),1===n.x&&(r.x=e.x),1===n.y&&(r.y=e.y),1===n.z&&(r.z=e.z),-1===n.x&&(i.x=e.x),-1===n.y&&(i.y=e.y),-1===n.z&&(i.z=e.z)},i.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":30,"./Shape":43}],43:[function(e,t){function i(){this.id=i.idCounter++,this.type=0,this.boundingSphereRadius=0,this.collisionResponse=!0,this.material=null}t.exports=i;var i=e("./Shape");e("../math/Vec3"),e("../math/Quaternion"),e("../material/Material"),(i.prototype.constructor=i).prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},i.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},i.prototype.calculateLocalInertia=function(){throw"calculateLocalInertia() not implemented for shape type "+this.type},i.idCounter=0,i.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"./Shape":43}],44:[function(e,t){function i(e){if(r.call(this),this.radius=void 0!==e?Number(e):1,this.type=r.types.SPHERE,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}t.exports=i;var r=e("./Shape"),o=e("../math/Vec3");((i.prototype=new r).constructor=i).prototype.calculateLocalInertia=function(e,t){t=t||new o;var i=2*e*this.radius*this.radius/5;return t.x=i,t.y=i,t.z=i,t},i.prototype.volume=function(){return 4*Math.PI*this.radius/3},i.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},i.prototype.calculateWorldAABB=function(e,t,i,r){for(var o=this.radius,n=["x","y","z"],a=0;a<n.length;a++){var s=n[a];i[s]=e[s]-o,r[s]=e[s]+o}}},{"../math/Vec3":30,"./Shape":43}],45:[function(e,t){function g(e,t){i.call(this),this.type=i.types.TRIMESH,this.vertices=new Float32Array(e),this.indices=new Int16Array(t),this.normals=new Float32Array(t.length),this.aabb=new h,this.edges=null,this.scale=new c(1,1,1),this.tree=new r,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}t.exports=g;var i=e("./Shape"),c=e("../math/Vec3"),o=(e("../math/Quaternion"),e("../math/Transform")),h=e("../collision/AABB"),r=e("../utils/Octree");(g.prototype=new i).constructor=g;var s=new c;g.prototype.updateTree=function(){var e=this.tree;e.reset(),e.aabb.copy(this.aabb);var t=this.scale;e.aabb.lowerBound.x*=1/t.x,e.aabb.lowerBound.y*=1/t.y,e.aabb.lowerBound.z*=1/t.z,e.aabb.upperBound.x*=1/t.x,e.aabb.upperBound.y*=1/t.y,e.aabb.upperBound.z*=1/t.z;for(var i=new h,r=new c,o=new c,n=new c,a=[r,o,n],s=0;s<this.indices.length/3;s++){var l=3*s;this._getUnscaledVertex(this.indices[l],r),this._getUnscaledVertex(this.indices[l+1],o),this._getUnscaledVertex(this.indices[l+2],n),i.setFromPoints(a),e.insert(i,s)}e.removeEmptyNodes()};var l=new h;g.prototype.getTrianglesInAABB=function(e,t){l.copy(e);var i=this.scale,r=i.x,o=i.y,n=i.z,a=l.lowerBound,s=l.upperBound;return a.x/=r,a.y/=o,a.z/=n,s.x/=r,s.y/=o,s.z/=n,this.tree.aabbQuery(l,t)},g.prototype.setScale=function(e){var t=this.scale.x===this.scale.y===this.scale.z,i=e.x===e.y===e.z;t&&i||this.updateNormals(),this.scale.copy(e),this.updateAABB(),this.updateBoundingSphereRadius()},g.prototype.updateNormals=function(){for(var e=s,t=this.normals,i=0;i<this.indices.length/3;i++){var r=3*i,o=this.indices[r],n=this.indices[r+1],a=this.indices[r+2];this.getVertex(o,p),this.getVertex(n,m),this.getVertex(a,f),g.computeNormal(m,p,f,e),t[r]=e.x,t[r+1]=e.y,t[r+2]=e.z}},g.prototype.updateEdges=function(){for(var e={},t=function(){e[o<n?o+"_"+n:n+"_"+o]=!0},i=0;i<this.indices.length/3;i++){var r=3*i,o=this.indices[r],n=this.indices[r+1];this.indices[r+2];t(),t(),t()}var a=Object.keys(e);this.edges=new Int16Array(2*a.length);for(i=0;i<a.length;i++){var s=a[i].split("_");this.edges[2*i]=parseInt(s[0],10),this.edges[2*i+1]=parseInt(s[1],10)}},g.prototype.getEdgeVertex=function(e,t,i){var r=this.edges[2*e+(t?1:0)];this.getVertex(r,i)};var n=new c,a=new c;g.prototype.getEdgeVector=function(e,t){var i=n,r=a;this.getEdgeVertex(e,0,i),this.getEdgeVertex(e,1,r),r.vsub(i,t)};var u=new c,d=new c;g.computeNormal=function(e,t,i,r){t.vsub(e,d),i.vsub(t,u),u.cross(d,r),r.isZero()||r.normalize()};var p=new c,m=new c,f=new c;g.prototype.getVertex=function(e,t){var i=this.scale;return this._getUnscaledVertex(e,t),t.x*=i.x,t.y*=i.y,t.z*=i.z,t},g.prototype._getUnscaledVertex=function(e,t){var i=3*e,r=this.vertices;return t.set(r[i],r[i+1],r[i+2])},g.prototype.getWorldVertex=function(e,t,i,r){return this.getVertex(e,r),o.pointToWorldFrame(t,i,r,r),r},g.prototype.getTriangleVertices=function(e,t,i,r){var o=3*e;this.getVertex(this.indices[o],t),this.getVertex(this.indices[o+1],i),this.getVertex(this.indices[o+2],r)},g.prototype.getNormal=function(e,t){var i=3*e;return t.set(this.normals[i],this.normals[i+1],this.normals[i+2])};var v=new h;g.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(v);var i=v.upperBound.x-v.lowerBound.x,r=v.upperBound.y-v.lowerBound.y,o=v.upperBound.z-v.lowerBound.z;return t.set(1/12*e*(2*r*2*r+2*o*2*o),1/12*e*(2*i*2*i+2*o*2*o),1/12*e*(2*r*2*r+2*i*2*i))};var y=new c;g.prototype.computeLocalAABB=function(e){var t=e.lowerBound,i=e.upperBound,r=this.vertices.length,o=(this.vertices,y);this.getVertex(0,o),t.copy(o),i.copy(o);for(var n=0;n!==r;n++)this.getVertex(n,o),o.x<t.x?t.x=o.x:o.x>i.x&&(i.x=o.x),o.y<t.y?t.y=o.y:o.y>i.y&&(i.y=o.y),o.z<t.z?t.z=o.z:o.z>i.z&&(i.z=o.z)},g.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},g.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,i=new c,r=0,o=t.length/3;r!==o;r++){this.getVertex(r,i);var n=i.norm2();e<n&&(e=n)}this.boundingSphereRadius=Math.sqrt(e)};var x=(new c,new o),w=new h;g.prototype.calculateWorldAABB=function(e,t,i,r){var o=x,n=w;o.position=e,o.quaternion=t,this.aabb.toWorldFrame(o,n),i.copy(n.lowerBound),r.copy(n.upperBound)},g.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},g.createTorus=function(e,t,i,r,o){e=e||1,t=t||.5,i=i||8,r=r||6,o=o||2*Math.PI;for(var n=[],a=[],s=0;s<=i;s++)for(var l=0;l<=r;l++){var c=l/r*o,h=s/i*Math.PI*2,u=(e+t*Math.cos(h))*Math.cos(c),d=(e+t*Math.cos(h))*Math.sin(c),p=t*Math.sin(h);n.push(u,d,p)}for(s=1;s<=i;s++)for(l=1;l<=r;l++){var m=(r+1)*s+l-1,f=(r+1)*(s-1)+l-1,v=(r+1)*(s-1)+l,y=(r+1)*s+l;a.push(m,f,y),a.push(f,v,y)}return new g(n,a)}},{"../collision/AABB":3,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../utils/Octree":50,"./Shape":43}],46:[function(e,t){function i(){r.call(this),this.iterations=10,this.tolerance=1e-7}t.exports=i;var r=(e("../math/Vec3"),e("../math/Quaternion"),e("./Solver"));i.prototype=new r;var N=[],A=[],M=[];i.prototype.solve=function(e,t){var i,r,o,n,a,s=0,l=this.iterations,c=this.tolerance*this.tolerance,h=this.equations,u=h.length,d=t.bodies,p=d.length,m=e;if(0!==u)for(var f=0;f!==p;f++)d[f].updateSolveMassProperties();var v=A,y=M,g=N;v.length=u,y.length=u,g.length=u;for(f=0;f!==u;f++){var x=h[f];g[f]=0,y[f]=x.computeB(m),v[f]=1/x.computeC()}if(0!==u){for(f=0;f!==p;f++){var w=(S=d[f]).vlambda,b=S.wlambda;w.set(0,0,0),b&&b.set(0,0,0)}for(s=0;s!==l;s++){for(var T=n=0;T!==u;T++){x=h[T];i=y[T],r=v[T],(a=g[T])+(o=r*(i-x.computeGWlambda()-x.eps*a))<x.minForce?o=x.minForce-a:a+o>x.maxForce&&(o=x.maxForce-a),g[T]+=o,n+=0<o?o:-o,x.addToWlambda(o)}if(n*n<c)break}for(f=0;f!==p;f++){var S,C=(S=d[f]).velocity,O=S.angularVelocity;C.vadd(S.vlambda,C),O&&O.vadd(S.wlambda,O)}}return s}},{"../math/Quaternion":28,"../math/Vec3":30,"./Solver":47}],47:[function(e,t){function i(){this.equations=[]}(t.exports=i).prototype.solve=function(){return 0},i.prototype.addEquation=function(e){e.enabled&&this.equations.push(e)},i.prototype.removeEquation=function(e){var t=this.equations,i=t.indexOf(e);-1!==i&&t.splice(i,1)},i.prototype.removeAllEquations=function(){this.equations.length=0}},{}],48:[function(e,t){function i(e){for(r.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=e,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}function b(e){for(var t=e.length,i=0;i!==t;i++){var r=e[i];if(!(r.visited||r.body.type&n))return r}return!1}function T(e,t,i,r){for(a.push(e),e.visited=!0,t(e,i,r);a.length;)for(var o,n=a.pop();o=b(n.children);)o.visited=!0,t(o,i,r),a.push(o)}function S(e,t,i){t.push(e.body);for(var r=e.eqs.length,o=0;o!==r;o++){var n=e.eqs[o];-1===i.indexOf(n)&&i.push(n)}}function C(e,t){return t.id-e.id}t.exports=i;var r=(e("../math/Vec3"),e("../math/Quaternion"),e("./Solver")),o=e("../objects/Body");i.prototype=new r;var O=[],N=[],A={bodies:[]},n=o.STATIC,a=[];i.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},i.prototype.solve=function(e,t){for(var i=O,r=this.nodePool,o=t.bodies,n=this.equations,a=n.length,s=o.length,l=this.subsolver;r.length<s;)r.push(this.createNode());i.length=s;for(var c=0;c<s;c++)i[c]=r[c];for(c=0;c!==s;c++){var h=i[c];h.body=o[c],h.children.length=0,h.eqs.length=0,h.visited=!1}for(var u=0;u!==a;u++){var d=n[u],p=(c=o.indexOf(d.bi),o.indexOf(d.bj)),m=i[c],f=i[p];m.children.push(f),m.eqs.push(d),f.children.push(m),f.eqs.push(d)}var v,y=0,g=N;l.tolerance=this.tolerance,l.iterations=this.iterations;for(var x=A;v=b(i);){g.length=0,x.bodies.length=0,T(v,S,x.bodies,g);var w=g.length;g=g.sort(C);for(c=0;c!==w;c++)l.addEquation(g[c]);l.solve(e,x),l.removeAllEquations(),y++}return y}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"./Solver":47}],49:[function(e,t){var i=function(){};(t.exports=i).prototype={constructor:i,addEventListener:function(e,t){void 0===this._listeners&&(this._listeners={});var i=this._listeners;return void 0===i[e]&&(i[e]=[]),-1===i[e].indexOf(t)&&i[e].push(t),this},hasEventListener:function(e,t){if(void 0===this._listeners)return!1;var i=this._listeners;return void 0!==i[e]&&-1!==i[e].indexOf(t)},removeEventListener:function(e,t){if(void 0===this._listeners)return this;var i=this._listeners;if(void 0===i[e])return this;var r=i[e].indexOf(t);return-1!==r&&i[e].splice(r,1),this},dispatchEvent:function(e){if(void 0===this._listeners)return this;var t=this._listeners[e.type];if(void 0!==t){e.target=this;for(var i=0,r=t.length;i<r;i++)t[i].call(this,e)}return this}}},{}],50:[function(e,t){function l(e){e=e||{},this.root=e.root||null,this.aabb=e.aabb?e.aabb.clone():new c,this.data=[],this.children=[]}function i(e,t){(t=t||{}).root=null,t.aabb=e,l.call(this,t),this.maxDepth=void 0!==t.maxDepth?t.maxDepth:8}var c=e("../collision/AABB"),h=e("../math/Vec3");(t.exports=i).prototype=new l,l.prototype.reset=function(){this.children.length=this.data.length=0},l.prototype.insert=function(e,t,i){var r=this.data;if(i=i||0,!this.aabb.contains(e))return!1;var o=this.children;if(i<(this.maxDepth||this.root.maxDepth)){var n=!1;o.length||(this.subdivide(),n=!0);for(var a=0;8!==a;a++)if(o[a].insert(e,t,i+1))return!0;n&&(o.length=0)}return r.push(t),!0};var u=new h;l.prototype.subdivide=function(){var e=this.aabb,t=e.lowerBound,i=e.upperBound,r=this.children;r.push(new l({aabb:new c({lowerBound:new h(0,0,0)})}),new l({aabb:new c({lowerBound:new h(1,0,0)})}),new l({aabb:new c({lowerBound:new h(1,1,0)})}),new l({aabb:new c({lowerBound:new h(1,1,1)})}),new l({aabb:new c({lowerBound:new h(0,1,1)})}),new l({aabb:new c({lowerBound:new h(0,0,1)})}),new l({aabb:new c({lowerBound:new h(1,0,1)})}),new l({aabb:new c({lowerBound:new h(0,1,0)})})),i.vsub(t,u),u.scale(.5,u);for(var o=this.root||this,n=0;8!==n;n++){var a=r[n];a.root=o;var s=a.aabb.lowerBound;s.x*=u.x,s.y*=u.y,s.z*=u.z,s.vadd(t,s),s.vadd(u,a.aabb.upperBound)}},l.prototype.aabbQuery=function(e,t){for(var i=(this.data,this.children,[this]);i.length;){var r=i.pop();r.aabb.overlaps(e)&&Array.prototype.push.apply(t,r.data),Array.prototype.push.apply(i,r.children)}return t};var r=new c;l.prototype.rayQuery=function(e,t,i){return e.getAABB(r),r.toLocalFrame(t,r),this.aabbQuery(r,i),i},l.prototype.removeEmptyNodes=function(){for(var e=[this];e.length;){for(var t=e.pop(),i=t.children.length-1;0<=i;i--)t.children[i].data.length||t.children.splice(i,1);Array.prototype.push.apply(e,t.children)}}},{"../collision/AABB":3,"../math/Vec3":30}],51:[function(e,t){function i(){this.objects=[],this.type=Object}(t.exports=i).prototype.release=function(){for(var e=arguments.length,t=0;t!==e;t++)this.objects.push(arguments[t])},i.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},i.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}},{}],52:[function(e,t){function i(){this.data={keys:[]}}(t.exports=i).prototype.get=function(e,t){if(t<e){var i=t;t=e,e=i}return this.data[e+"-"+t]},i.prototype.set=function(e,t,i){if(t<e){var r=t;t=e,e=r}var o=e+"-"+t;this.get(e,t)||this.data.keys.push(o),this.data[o]=i},i.prototype.reset=function(){for(var e=this.data,t=e.keys;0<t.length;){delete e[t.pop()]}}},{}],53:[function(e,t){function i(){}(t.exports=i).defaults=function(e,t){for(var i in e=e||{},t)i in e||(e[i]=t[i]);return e}},{}],54:[function(e,t){function i(){o.call(this),this.type=r}t.exports=i;var r=e("../math/Vec3"),o=e("./Pool");(i.prototype=new o).constructObject=function(){return new r}},{"../math/Vec3":30,"./Pool":51}],55:[function(e,t){function i(e){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new a,this.world=e,this.currentContactMaterial=null,this.enableFrictionReduction=!1}function D(e,t,i){for(var r=null,o=e.length,n=0;n!==o;n++){var a=e[n],s=p;e[(n+1)%o].vsub(a,s);var l=m;s.cross(t,l);var c=w;i.vsub(a,c);var h=l.dot(c);if(!(null===r||0<h&&!0===r||h<=0&&!1===r))return!1;null===r&&(r=0<h)}return!0}t.exports=i;var r=e("../collision/AABB"),o=e("../shapes/Shape"),G=e("../collision/Ray"),f=e("../math/Vec3"),B=e("../math/Transform"),n=(e("../shapes/ConvexPolyhedron"),e("../math/Quaternion")),a=(e("../solver/Solver"),e("../utils/Vec3Pool")),h=e("../equations/ContactEquation"),v=e("../equations/FrictionEquation");i.prototype.createContactEquation=function(e,t,i,r,o,n){var a;this.contactPointPool.length?((a=this.contactPointPool.pop()).bi=e,a.bj=t):a=new h(e,t),a.enabled=e.collisionResponse&&t.collisionResponse&&i.collisionResponse&&r.collisionResponse;var s=this.currentContactMaterial;a.restitution=s.restitution,a.setSpookParams(s.contactEquationStiffness,s.contactEquationRelaxation,this.world.dt);var l=i.material||e.material,c=r.material||t.material;return l&&c&&0<=l.restitution&&0<=c.restitution&&(a.restitution=l.restitution*c.restitution),a.si=o||i,a.sj=n||r,a},i.prototype.createFrictionEquationsFromContact=function(e,t){var i=e.bi,r=e.bj,o=e.si,n=e.sj,a=this.world,s=this.currentContactMaterial,l=s.friction,c=o.material||i.material,h=n.material||r.material;if(c&&h&&0<=c.friction&&0<=h.friction&&(l=c.friction*h.friction),0<l){var u=l*a.gravity.length(),d=i.invMass+r.invMass;0<d&&(d=1/d);var p=this.frictionEquationPool,m=p.length?p.pop():new v(i,r,u*d),f=p.length?p.pop():new v(i,r,u*d);return m.bi=f.bi=i,m.bj=f.bj=r,m.minForce=f.minForce=-u*d,m.maxForce=f.maxForce=u*d,m.ri.copy(e.ri),m.rj.copy(e.rj),f.ri.copy(e.ri),f.rj.copy(e.rj),e.ni.tangents(m.t,f.t),m.setSpookParams(s.frictionEquationStiffness,s.frictionEquationRelaxation,a.dt),f.setSpookParams(s.frictionEquationStiffness,s.frictionEquationRelaxation,a.dt),m.enabled=f.enabled=e.enabled,t.push(m,f),!0}return!1};var s=new f,l=new f,c=new f;i.prototype.createFrictionFromAverage=function(e){var t=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(t,this.frictionResult)&&1!==e){var i=this.frictionResult[this.frictionResult.length-2],r=this.frictionResult[this.frictionResult.length-1];s.setZero(),l.setZero(),c.setZero();for(var o=t.bi,n=(t.bj,0);n!==e;n++)(t=this.result[this.result.length-1-n]).bodyA!==o?(s.vadd(t.ni,s),l.vadd(t.ri,l),c.vadd(t.rj,c)):(s.vsub(t.ni,s),l.vadd(t.rj,l),c.vadd(t.ri,c));var a=1/e;l.scale(a,i.ri),c.scale(a,i.rj),r.ri.copy(i.ri),r.rj.copy(i.rj),s.normalize(),s.tangents(i.t,r.t)}};var T=new f,S=new f,C=new n,O=new n;i.prototype.getContacts=function(e,t,i,r,o,n,a){this.contactPointPool=o,this.frictionEquationPool=a,this.result=r,this.frictionResult=n;for(var s=C,l=O,c=T,h=S,u=0,d=e.length;u!==d;u++){var p=e[u],m=t[u],f=null;p.material&&m.material&&(f=i.getContactMaterial(p.material,m.material)||null);for(var v=0;v<p.shapes.length;v++){p.quaternion.mult(p.shapeOrientations[v],s),p.quaternion.vmult(p.shapeOffsets[v],c),c.vadd(p.position,c);for(var y=p.shapes[v],g=0;g<m.shapes.length;g++){m.quaternion.mult(m.shapeOrientations[g],l),m.quaternion.vmult(m.shapeOffsets[g],h),h.vadd(m.position,h);var x=m.shapes[g];if(!(c.distanceTo(h)>y.boundingSphereRadius+x.boundingSphereRadius)){var w=null;y.material&&x.material&&(w=i.getContactMaterial(y.material,x.material)||null),this.currentContactMaterial=w||f||i.defaultContactMaterial;var b=this[y.type|x.type];b&&(y.type<x.type?b.call(this,y,x,c,h,s,l,p,m,y,x):b.call(this,x,y,h,c,l,s,m,p,y,x))}}}}},i.prototype[o.types.BOX|o.types.BOX]=i.prototype.boxBox=function(e,t,i,r,o,n,a,s){e.convexPolyhedronRepresentation.material=e.material,t.convexPolyhedronRepresentation.material=t.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t.convexPolyhedronRepresentation,i,r,o,n,a,s,e,t)},i.prototype[o.types.BOX|o.types.CONVEXPOLYHEDRON]=i.prototype.boxConvex=function(e,t,i,r,o,n,a,s){e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t,i,r,o,n,a,s,e,t)},i.prototype[o.types.BOX|o.types.PARTICLE]=i.prototype.boxParticle=function(e,t,i,r,o,n,a,s){e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexParticle(e.convexPolyhedronRepresentation,t,i,r,o,n,a,s,e,t)},i.prototype[o.types.SPHERE]=i.prototype.sphereSphere=function(e,t,i,r,o,n,a,s){var l=this.createContactEquation(a,s,e,t);r.vsub(i,l.ni),l.ni.normalize(),l.ri.copy(l.ni),l.rj.copy(l.ni),l.ri.mult(e.radius,l.ri),l.rj.mult(-t.radius,l.rj),l.ri.vadd(i,l.ri),l.ri.vsub(a.position,l.ri),l.rj.vadd(r,l.rj),l.rj.vsub(s.position,l.rj),this.result.push(l),this.createFrictionEquationsFromContact(l,this.frictionResult)};var y=new f,g=new f,x=new f;i.prototype[o.types.PLANE|o.types.TRIMESH]=i.prototype.planeTrimesh=function(e,t,i,r,o,n,a,s){var l=new f,c=y;c.set(0,0,1),o.vmult(c,c);for(var h=0;h<t.vertices.length/3;h++){t.getVertex(h,l);var u=new f;u.copy(l),B.pointToWorldFrame(r,n,u,l);var d=g;if(l.vsub(i,d),c.dot(d)<=0){var p=this.createContactEquation(a,s,e,t);p.ni.copy(c);var m=x;c.scale(d.dot(c),m),l.vsub(m,m),p.ri.copy(m),p.ri.vsub(a.position,p.ri),p.rj.copy(l),p.rj.vsub(s.position,p.rj),this.result.push(p),this.createFrictionEquationsFromContact(p,this.frictionResult)}}};var F=new f,R=new f,j=(new f,new f),_=new f,z=new f,k=new f,V=new f,I=new f,U=new f,W=new f,q=new f,H=new f,K=new f,X=new r,Y=[];i.prototype[o.types.SPHERE|o.types.TRIMESH]=i.prototype.sphereTrimesh=function(e,t,i,r,o,n,a,s){var l=z,c=k,h=V,u=I,d=U,p=W,m=X,f=_,v=R,y=Y;B.pointToLocalFrame(r,n,i,d);var g=e.radius;m.lowerBound.set(d.x-g,d.y-g,d.z-g),m.upperBound.set(d.x+g,d.y+g,d.z+g),t.getTrianglesInAABB(m,y);for(var x=j,w=e.radius*e.radius,b=0;b<y.length;b++)for(var T=0;T<3;T++)if(t.getVertex(t.indices[3*y[b]+T],x),x.vsub(d,v),v.norm2()<=w){f.copy(x),B.pointToWorldFrame(r,n,f,x),x.vsub(i,v),(O=this.createContactEquation(a,s,e,t)).ni.copy(v),O.ni.normalize(),O.ri.copy(O.ni),O.ri.scale(e.radius,O.ri),O.ri.vadd(i,O.ri),O.ri.vsub(a.position,O.ri),O.rj.copy(x),O.rj.vsub(s.position,O.rj),this.result.push(O),this.createFrictionEquationsFromContact(O,this.frictionResult)}for(b=0;b<y.length;b++)for(T=0;T<3;T++){t.getVertex(t.indices[3*y[b]+T],l),t.getVertex(t.indices[3*y[b]+(T+1)%3],c),c.vsub(l,h),d.vsub(c,p);var S=p.dot(h);d.vsub(l,p);var C=p.dot(h);if(0<C&&S<0)if(d.vsub(l,p),u.copy(h),u.normalize(),C=p.dot(u),u.scale(C,p),p.vadd(l,p),(L=p.distanceTo(d))<e.radius){var O=this.createContactEquation(a,s,e,t);p.vsub(d,O.ni),O.ni.normalize(),O.ni.scale(e.radius,O.ri),B.pointToWorldFrame(r,n,p,p),p.vsub(s.position,O.rj),B.vectorToWorldFrame(n,O.ni,O.ni),B.vectorToWorldFrame(n,O.ri,O.ri),this.result.push(O),this.createFrictionEquationsFromContact(O,this.frictionResult)}}for(var N=q,A=H,M=K,P=F,E=(b=0,y.length);b!==E;b++){t.getTriangleVertices(y[b],N,A,M),t.getNormal(y[b],P),d.vsub(N,p);var L=p.dot(P);if(P.scale(L,p),d.vsub(p,p),L=p.distanceTo(d),G.pointInTriangle(p,N,A,M)&&L<e.radius){O=this.createContactEquation(a,s,e,t);p.vsub(d,O.ni),O.ni.normalize(),O.ni.scale(e.radius,O.ri),B.pointToWorldFrame(r,n,p,p),p.vsub(s.position,O.rj),B.vectorToWorldFrame(n,O.ni,O.ni),B.vectorToWorldFrame(n,O.ri,O.ri),this.result.push(O),this.createFrictionEquationsFromContact(O,this.frictionResult)}}y.length=0};var u=new f,d=new f;i.prototype[o.types.SPHERE|o.types.PLANE]=i.prototype.spherePlane=function(e,t,i,r,o,n,a,s){var l=this.createContactEquation(a,s,e,t);if(l.ni.set(0,0,1),n.vmult(l.ni,l.ni),l.ni.negate(l.ni),l.ni.normalize(),l.ni.mult(e.radius,l.ri),i.vsub(r,u),l.ni.mult(l.ni.dot(u),d),u.vsub(d,l.rj),-u.dot(l.ni)<=e.radius){var c=l.ri,h=l.rj;c.vadd(i,c),c.vsub(a.position,c),h.vadd(r,h),h.vsub(s.position,h),this.result.push(l),this.createFrictionEquationsFromContact(l,this.frictionResult)}};var p=new f,m=new f,w=new f,Z=new f,J=new f,Q=new f,$=new f,ee=[new f,new f,new f,new f,new f,new f],te=new f,ie=new f,re=new f,oe=new f;i.prototype[o.types.SPHERE|o.types.BOX]=i.prototype.sphereBox=function(e,t,i,r,o,n,a,s){var l=this.v3pool,c=ee;i.vsub(r,Z),t.getSideNormals(c,n);for(var h=e.radius,u=!1,d=ie,p=re,m=oe,f=null,v=0,y=0,g=0,x=null,w=0,b=c.length;w!==b&&!1===u;w++){var T=J;T.copy(c[w]);var S=T.norm();T.normalize();var C=Z.dot(T);if(C<S+h&&0<C){var O=Q,N=$;O.copy(c[(w+1)%3]),N.copy(c[(w+2)%3]);var A=O.norm(),M=N.norm();O.normalize(),N.normalize();var P=Z.dot(O),E=Z.dot(N);if(P<A&&-A<P&&E<M&&-M<E){var L=Math.abs(C-S-h);(null===x||L<x)&&(x=L,y=P,g=E,f=S,d.copy(T),p.copy(O),m.copy(N),v++)}}}if(v){u=!0;var G=this.createContactEquation(a,s,e,t);d.mult(-h,G.ri),G.ni.copy(d),G.ni.negate(G.ni),d.mult(f,d),p.mult(y,p),d.vadd(p,d),m.mult(g,m),d.vadd(m,G.rj),G.ri.vadd(i,G.ri),G.ri.vsub(a.position,G.ri),G.rj.vadd(r,G.rj),G.rj.vsub(s.position,G.rj),this.result.push(G),this.createFrictionEquationsFromContact(G,this.frictionResult)}for(var B=l.get(),F=te,R=0;2!==R&&!u;R++)for(var j=0;2!==j&&!u;j++)for(var _=0;2!==_&&!u;_++)if(B.set(0,0,0),R?B.vadd(c[0],B):B.vsub(c[0],B),j?B.vadd(c[1],B):B.vsub(c[1],B),_?B.vadd(c[2],B):B.vsub(c[2],B),r.vadd(B,F),F.vsub(i,F),F.norm2()<h*h){u=!0,(G=this.createContactEquation(a,s,e,t)).ri.copy(F),G.ri.normalize(),G.ni.copy(G.ri),G.ri.mult(h,G.ri),G.rj.copy(B),G.ri.vadd(i,G.ri),G.ri.vsub(a.position,G.ri),G.rj.vadd(r,G.rj),G.rj.vsub(s.position,G.rj),this.result.push(G),this.createFrictionEquationsFromContact(G,this.frictionResult)}l.release(B),B=null;var z=l.get(),k=l.get(),V=(G=l.get(),l.get()),I=(L=l.get(),c.length);for(R=0;R!==I&&!u;R++)for(j=0;j!==I&&!u;j++)if(R%3!=j%3){c[j].cross(c[R],z),z.normalize(),c[R].vadd(c[j],k),G.copy(i),G.vsub(k,G),G.vsub(r,G);var U=G.dot(z);z.mult(U,V);for(_=0;_===R%3||_===j%3;)_++;L.copy(i),L.vsub(V,L),L.vsub(k,L),L.vsub(r,L);var D=Math.abs(U),W=L.norm();if(D<c[_].norm()&&W<h){u=!0;var q=this.createContactEquation(a,s,e,t);k.vadd(V,q.rj),q.rj.copy(q.rj),L.negate(q.ni),q.ni.normalize(),q.ri.copy(q.rj),q.ri.vadd(r,q.ri),q.ri.vsub(i,q.ri),q.ri.normalize(),q.ri.mult(h,q.ri),q.ri.vadd(i,q.ri),q.ri.vsub(a.position,q.ri),q.rj.vadd(r,q.rj),q.rj.vsub(s.position,q.rj),this.result.push(q),this.createFrictionEquationsFromContact(q,this.frictionResult)}}l.release(z,k,G,V,L)};var ne=new f,ae=new f,se=new f,le=new f,ce=new f,he=new f,ue=new f,de=new f,pe=new f,me=new f;i.prototype[o.types.SPHERE|o.types.CONVEXPOLYHEDRON]=i.prototype.sphereConvex=function(e,t,i,r,o,n,a,s){var l=this.v3pool;i.vsub(r,ne);for(var c=t.faceNormals,h=t.faces,u=t.vertices,d=e.radius,p=0;p!==u.length;p++){var m=u[p],f=ce;n.vmult(m,f),r.vadd(f,f);var v=le;if(f.vsub(i,v),v.norm2()<d*d)return y=!0,(L=this.createContactEquation(a,s,e,t)).ri.copy(v),L.ri.normalize(),L.ni.copy(L.ri),L.ri.mult(d,L.ri),f.vsub(r,L.rj),L.ri.vadd(i,L.ri),L.ri.vsub(a.position,L.ri),L.rj.vadd(r,L.rj),L.rj.vsub(s.position,L.rj),this.result.push(L),void this.createFrictionEquationsFromContact(L,this.frictionResult)}for(var y=!1,g=(p=0,h.length);p!==g&&!1===y;p++){var x=c[p],w=h[p],b=he;n.vmult(x,b);var T=ue;n.vmult(u[w[0]],T),T.vadd(r,T);var S=de;b.mult(-d,S),i.vadd(S,S);var C=pe;S.vsub(T,C);var O=C.dot(b),N=me;if(i.vsub(T,N),O<0&&0<N.dot(b)){for(var A=[],M=0,P=w.length;M!==P;M++){var E=l.get();n.vmult(u[w[M]],E),r.vadd(E,E),A.push(E)}if(D(A,b,i)){y=!0;var L=this.createContactEquation(a,s,e,t);b.mult(-d,L.ri),b.negate(L.ni);var G=l.get();b.mult(-O,G);var B=l.get();b.mult(-d,B),i.vsub(r,L.rj),L.rj.vadd(B,L.rj),L.rj.vadd(G,L.rj),L.rj.vadd(r,L.rj),L.rj.vsub(s.position,L.rj),L.ri.vadd(i,L.ri),L.ri.vsub(a.position,L.ri),l.release(G),l.release(B),this.result.push(L),this.createFrictionEquationsFromContact(L,this.frictionResult);M=0;for(var F=A.length;M!==F;M++)l.release(A[M]);return}for(M=0;M!==w.length;M++){var R=l.get(),j=l.get();n.vmult(u[w[(M+1)%w.length]],R),n.vmult(u[w[(M+2)%w.length]],j),r.vadd(R,R),r.vadd(j,j);var _=ae;j.vsub(R,_);var z=se;_.unit(z);var k=l.get(),V=l.get();i.vsub(R,V);var I=V.dot(z);z.mult(I,k),k.vadd(R,k);var U=l.get();if(k.vsub(i,U),0<I&&I*I<_.norm2()&&U.norm2()<d*d){L=this.createContactEquation(a,s,e,t);k.vsub(r,L.rj),k.vsub(i,L.ni),L.ni.normalize(),L.ni.mult(d,L.ri),L.rj.vadd(r,L.rj),L.rj.vsub(s.position,L.rj),L.ri.vadd(i,L.ri),L.ri.vsub(a.position,L.ri),this.result.push(L),this.createFrictionEquationsFromContact(L,this.frictionResult);for(M=0,F=A.length;M!==F;M++)l.release(A[M]);return l.release(R),l.release(j),l.release(k),l.release(U),void l.release(V)}l.release(R),l.release(j),l.release(k),l.release(U),l.release(V)}for(M=0,F=A.length;M!==F;M++)l.release(A[M])}}},new f,new f,i.prototype[o.types.PLANE|o.types.BOX]=i.prototype.planeBox=function(e,t,i,r,o,n,a,s){t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.planeConvex(e,t.convexPolyhedronRepresentation,i,r,o,n,a,s)};var b=new f,N=new f,A=new f,M=new f;i.prototype[o.types.PLANE|o.types.CONVEXPOLYHEDRON]=i.prototype.planeConvex=function(e,t,i,r,o,n,a,s){var l=b,c=N;c.set(0,0,1),o.vmult(c,c);for(var h=0,u=A,d=0;d!==t.vertices.length;d++){if(l.copy(t.vertices[d]),n.vmult(l,l),r.vadd(l,l),l.vsub(i,u),c.dot(u)<=0){var p=this.createContactEquation(a,s,e,t),m=M;c.mult(c.dot(u),m),l.vsub(m,m),m.vsub(i,p.ri),p.ni.copy(c),l.vsub(r,p.rj),p.ri.vadd(i,p.ri),p.ri.vsub(a.position,p.ri),p.rj.vadd(r,p.rj),p.rj.vsub(s.position,p.rj),this.result.push(p),h++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(p,this.frictionResult)}}this.enableFrictionReduction&&h&&this.createFrictionFromAverage(h)};var P=new f,E=new f;i.prototype[o.types.CONVEXPOLYHEDRON]=i.prototype.convexConvex=function(e,t,i,r,o,n,a,s,l,c,h,u){var d=P;if(!(i.distanceTo(r)>e.boundingSphereRadius+t.boundingSphereRadius)&&e.findSeparatingAxis(t,i,o,r,n,d,h,u)){var p=[],m=E;e.clipAgainstHull(i,o,t,r,n,d,-100,100,p);for(var f=0,v=0;v!==p.length;v++){var y=this.createContactEquation(a,s,e,t,l,c),g=y.ri,x=y.rj;d.negate(y.ni),p[v].normal.negate(m),m.mult(p[v].depth,m),p[v].point.vadd(m,g),x.copy(p[v].point),g.vsub(i,g),x.vsub(r,x),g.vadd(i,g),g.vsub(a.position,g),x.vadd(r,x),x.vsub(s.position,x),this.result.push(y),f++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(y,this.frictionResult)}this.enableFrictionReduction&&f&&this.createFrictionFromAverage(f)}};var L=new f,fe=new f,ve=new f;i.prototype[o.types.PLANE|o.types.PARTICLE]=i.prototype.planeParticle=function(e,t,i,r,o,n,a,s){var l=L;l.set(0,0,1),a.quaternion.vmult(l,l);var c=fe;if(r.vsub(a.position,c),l.dot(c)<=0){var h=this.createContactEquation(s,a,t,e);h.ni.copy(l),h.ni.negate(h.ni),h.ri.set(0,0,0);var u=ve;l.mult(l.dot(r),u),r.vsub(u,u),h.rj.copy(u),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)}};var ye=new f;i.prototype[o.types.PARTICLE|o.types.SPHERE]=i.prototype.sphereParticle=function(e,t,i,r,o,n,a,s){var l=ye;if(l.set(0,0,1),r.vsub(i,l),l.norm2()<=e.radius*e.radius){var c=this.createContactEquation(s,a,t,e);l.normalize(),c.rj.copy(l),c.rj.mult(e.radius,c.rj),c.ni.copy(l),c.ni.negate(c.ni),c.ri.set(0,0,0),this.result.push(c),this.createFrictionEquationsFromContact(c,this.frictionResult)}};var ge=new n,xe=new f,we=(new f,new f),be=new f,Te=new f;i.prototype[o.types.PARTICLE|o.types.CONVEXPOLYHEDRON]=i.prototype.convexParticle=function(e,t,i,r,o,n,a,s){var l=-1,c=we,h=Te,u=null,d=xe;if(d.copy(r),d.vsub(i,d),o.conjugate(ge),ge.vmult(d,d),e.pointIsInside(d)){e.worldVerticesNeedsUpdate&&e.computeWorldVertices(i,o),e.worldFaceNormalsNeedsUpdate&&e.computeWorldFaceNormals(o);for(var p=0,m=e.faces.length;p!==m;p++){var f=[e.worldVertices[e.faces[p][0]]],v=e.worldFaceNormals[p];r.vsub(f[0],be);var y=-v.dot(be);(null===u||Math.abs(y)<Math.abs(u))&&(u=y,l=p,c.copy(v),0)}if(-1!==l){var g=this.createContactEquation(s,a,t,e);c.mult(u,h),h.vadd(r,h),h.vsub(i,h),g.rj.copy(h),c.negate(g.ni),g.ri.set(0,0,0);var x=g.ri,w=g.rj;x.vadd(r,x),x.vsub(s.position,x),w.vadd(i,w),w.vsub(a.position,w),this.result.push(g),this.createFrictionEquationsFromContact(g,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},i.prototype[o.types.BOX|o.types.HEIGHTFIELD]=i.prototype.boxHeightfield=function(e,t,i,r,o,n,a,s){e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexHeightfield(e.convexPolyhedronRepresentation,t,i,r,o,n,a,s)};var Se=new f,Ce=new f,Oe=[0];i.prototype[o.types.CONVEXPOLYHEDRON|o.types.HEIGHTFIELD]=i.prototype.convexHeightfield=function(e,t,i,r,o,n,a,s){var l=t.data,c=t.elementSize,h=e.boundingSphereRadius,u=Ce,d=Oe,p=Se;B.pointToLocalFrame(r,n,i,p);var m=Math.floor((p.x-h)/c)-1,f=Math.ceil((p.x+h)/c)+1,v=Math.floor((p.y-h)/c)-1,y=Math.ceil((p.y+h)/c)+1;if(!(f<0||y<0||m>l.length||v>l[0].length)){m<0&&(m=0),f<0&&(f=0),v<0&&(v=0),y<0&&(y=0),m>=l.length&&(m=l.length-1),f>=l.length&&(f=l.length-1),y>=l[0].length&&(y=l[0].length-1),v>=l[0].length&&(v=l[0].length-1);var g=[];t.getRectMinMax(m,v,f,y,g);var x=g[0],w=g[1];if(!(p.z-h>w||p.z+h<x))for(var b=m;b<f;b++)for(var T=v;T<y;T++)t.getConvexTrianglePillar(b,T,!1),B.pointToWorldFrame(r,n,t.pillarOffset,u),i.distanceTo(u)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&this.convexConvex(e,t.pillarConvex,i,u,o,n,a,s,null,null,d,null),t.getConvexTrianglePillar(b,T,!0),B.pointToWorldFrame(r,n,t.pillarOffset,u),i.distanceTo(u)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&this.convexConvex(e,t.pillarConvex,i,u,o,n,a,s,null,null,d,null)}};var Ne=new f,Ae=new f;i.prototype[o.types.SPHERE|o.types.HEIGHTFIELD]=i.prototype.sphereHeightfield=function(e,t,i,r,o,n,a,s){var l=t.data,c=e.radius,h=t.elementSize,u=Ae,d=Ne;B.pointToLocalFrame(r,n,i,d);var p=Math.floor((d.x-c)/h)-1,m=Math.ceil((d.x+c)/h)+1,f=Math.floor((d.y-c)/h)-1,v=Math.ceil((d.y+c)/h)+1;if(!(m<0||v<0||p>l.length||v>l[0].length)){p<0&&(p=0),m<0&&(m=0),f<0&&(f=0),v<0&&(v=0),p>=l.length&&(p=l.length-1),m>=l.length&&(m=l.length-1),v>=l[0].length&&(v=l[0].length-1),f>=l[0].length&&(f=l[0].length-1);var y=[];t.getRectMinMax(p,f,m,v,y);var g=y[0],x=y[1];if(!(d.z-c>x||d.z+c<g))for(var w=this.result,b=p;b<m;b++)for(var T=f;T<v;T++){var S=w.length;if(t.getConvexTrianglePillar(b,T,!1),B.pointToWorldFrame(r,n,t.pillarOffset,u),i.distanceTo(u)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&this.sphereConvex(e,t.pillarConvex,i,u,o,n,a,s),t.getConvexTrianglePillar(b,T,!0),B.pointToWorldFrame(r,n,t.pillarOffset,u),i.distanceTo(u)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&this.sphereConvex(e,t.pillarConvex,i,u,o,n,a,s),2<w.length-S)return}}}},{"../collision/AABB":3,"../collision/Ray":9,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43,"../solver/Solver":47,"../utils/Vec3Pool":54}],56:[function(e,t){function i(){s.apply(this),this.dt=-1,this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new r,this.broadphase=new f,this.bodies=[],this.solver=new n,this.constraints=[],this.narrowphase=new a(this),this.collisionMatrix=new l,this.collisionMatrixPrevious=new l,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new u,this.defaultMaterial=new c("default"),this.defaultContactMaterial=new h(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null}}t.exports=i;var re=e("../shapes/Shape"),r=e("../math/Vec3"),o=e("../math/Quaternion"),n=e("../solver/GSSolver"),a=(e("../utils/Vec3Pool"),e("../equations/ContactEquation"),e("../equations/FrictionEquation"),e("./Narrowphase")),s=e("../utils/EventTarget"),l=e("../collision/ArrayCollisionMatrix"),c=e("../material/Material"),h=e("../material/ContactMaterial"),oe=e("../objects/Body"),u=e("../utils/TupleDictionary"),d=e("../collision/RaycastResult"),p=e("../collision/AABB"),m=e("../collision/Ray"),f=e("../collision/NaiveBroadphase");i.prototype=new s;var v=(new p,new m);if(i.prototype.getContactMaterial=function(e,t){return this.contactMaterialTable.get(e.id,t.id)},i.prototype.numObjects=function(){return this.bodies.length},i.prototype.collisionMatrixTick=function(){var e=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=e,this.collisionMatrix.reset()},i.prototype.add=i.prototype.addBody=function(e){-1===this.bodies.indexOf(e)&&(e.index=this.bodies.length,this.bodies.push(e),e.world=this,e.initPosition.copy(e.position),e.initVelocity.copy(e.velocity),e.timeLastSleepy=this.time,e instanceof oe&&(e.initAngularVelocity.copy(e.angularVelocity),e.initQuaternion.copy(e.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=e,this.dispatchEvent(this.addBodyEvent))},i.prototype.addConstraint=function(e){this.constraints.push(e)},i.prototype.removeConstraint=function(e){var t=this.constraints.indexOf(e);-1!==t&&this.constraints.splice(t,1)},i.prototype.rayTest=function(e,t,i){i instanceof d?this.raycastClosest(e,t,{skipBackfaces:!0},i):this.raycastAll(e,t,{skipBackfaces:!0},i)},i.prototype.raycastAll=function(e,t,i,r){return i.mode=m.ALL,i.from=e,i.to=t,i.callback=r,v.intersectWorld(this,i)},i.prototype.raycastAny=function(e,t,i,r){return i.mode=m.ANY,i.from=e,i.to=t,i.result=r,v.intersectWorld(this,i)},i.prototype.raycastClosest=function(e,t,i,r){return i.mode=m.CLOSEST,i.from=e,i.to=t,i.result=r,v.intersectWorld(this,i)},i.prototype.removeBody=i.prototype.remove=function(e){e.world=null;var t=this.bodies.length-1,i=this.bodies,r=i.indexOf(e);if(-1!==r){i.splice(r,1);for(var o=0;o!==i.length;o++)i[o].index=o;this.collisionMatrix.setNumObjects(t),this.removeBodyEvent.body=e,this.dispatchEvent(this.removeBodyEvent)}},i.prototype.addMaterial=function(e){this.materials.push(e)},i.prototype.addContactMaterial=function(e){this.contactmaterials.push(e),this.contactMaterialTable.set(e.materials[0].id,e.materials[1].id,e)},"undefined"==typeof performance&&(performance={}),!performance.now){var y=Date.now();performance.timing&&performance.timing.navigationStart&&(y=performance.timing.navigationStart),performance.now=function(){return Date.now()-y}}var g=new r;i.prototype.step=function(e,t,i){if(i=i||10,0===(t=t||0))this.internalStep(e),this.time+=e;else{var r=Math.floor((this.time+t)/e)-Math.floor(this.time/e);r=Math.min(r,i);for(var o=performance.now(),n=0;n!==r&&(this.internalStep(e),!(performance.now()-o>1e3*e));n++);this.time+=t;for(var a=this.time%e/e,s=g,l=this.bodies,c=0;c!==l.length;c++){var h=l[c];h.type!==oe.STATIC&&h.sleepState!==oe.SLEEPING?(h.position.vsub(h.previousPosition,s),s.scale(a,s),h.position.vadd(s,h.interpolatedPosition)):(h.interpolatedPosition.copy(h.position),h.interpolatedQuaternion.copy(h.quaternion))}}};var ne={type:"postStep"},ae={type:"preStep"},se={type:"collide",body:null,contact:null},le=[],ce=[],he=[],ue=[],de=(new r,new r,new r,new r,new r,new r,new r,new r,new r,new o,new o),pe=new o,me=new r;i.prototype.internalStep=function(e){this.dt=e;var t,i=this.contacts,r=he,o=ue,n=this.numObjects(),a=this.bodies,s=this.solver,l=this.gravity,c=this.doProfiling,h=this.profile,u=oe.DYNAMIC,d=this.constraints,p=ce,m=(l.norm(),l.x),f=l.y,v=l.z,y=0;for(c&&(t=performance.now()),y=0;y!==n;y++){if((M=a[y]).type&u){var g=M.force,x=M.mass;g.x+=x*m,g.y+=x*f,g.z+=x*v}}y=0;for(var w=this.subsystems.length;y!==w;y++)this.subsystems[y].update();c&&(t=performance.now()),r.length=0,o.length=0,this.broadphase.collisionPairs(this,r,o),c&&(h.broadphase=performance.now()-t);var b=d.length;for(y=0;y!==b;y++){if(!(G=d[y]).collideConnected)for(var T=r.length-1;0<=T;T-=1)(G.bodyA===r[T]&&G.bodyB===o[T]||G.bodyB===r[T]&&G.bodyA===o[T])&&(r.splice(T,1),o.splice(T,1))}this.collisionMatrixTick(),c&&(t=performance.now());var S=le,C=i.length;for(y=0;y!==C;y++)S.push(i[y]);i.length=0;var O=this.frictionEquations.length;for(y=0;y!==O;y++)p.push(this.frictionEquations[y]);this.frictionEquations.length=0,this.narrowphase.getContacts(r,o,this,i,S,this.frictionEquations,p),c&&(h.narrowphase=performance.now()-t),c&&(t=performance.now());for(y=0;y<this.frictionEquations.length;y++)s.addEquation(this.frictionEquations[y]);for(var N=i.length,A=0;A!==N;A++){var M=(G=i[A]).bi,P=G.bj;G.si,G.sj;(M.material&&P.material&&this.getContactMaterial(M.material,P.material)||this.defaultContactMaterial).friction;if(M.material&&P.material&&(0<=M.material.friction&&0<=P.material.friction&&M.material.friction*P.material.friction,0<=M.material.restitution&&0<=P.material.restitution&&(G.restitution=M.material.restitution*P.material.restitution)),s.addEquation(G),M.allowSleep&&M.type===oe.DYNAMIC&&M.sleepState===oe.SLEEPING&&P.sleepState===oe.AWAKE&&P.type!==oe.STATIC){var E=P.velocity.norm2()+P.angularVelocity.norm2();2*Math.pow(P.sleepSpeedLimit,2)<=E&&(M._wakeUpAfterNarrowphase=!0)}if(P.allowSleep&&P.type===oe.DYNAMIC&&P.sleepState===oe.SLEEPING&&M.sleepState===oe.AWAKE&&M.type!==oe.STATIC){var L=M.velocity.norm2()+M.angularVelocity.norm2();2*Math.pow(M.sleepSpeedLimit,2)<=L&&(P._wakeUpAfterNarrowphase=!0)}this.collisionMatrix.set(M,P,!0),this.collisionMatrixPrevious.get(M,P)||(se.body=P,se.contact=G,M.dispatchEvent(se),se.body=M,P.dispatchEvent(se))}for(c&&(h.makeContactConstraints=performance.now()-t,t=performance.now()),y=0;y!==n;y++){(M=a[y])._wakeUpAfterNarrowphase&&(M.wakeUp(),M._wakeUpAfterNarrowphase=!1)}b=d.length;for(y=0;y!==b;y++){var G;(G=d[y]).update();T=0;for(var B=G.equations.length;T!==B;T++){var F=G.equations[T];s.addEquation(F)}}s.solve(e,this),c&&(h.solve=performance.now()-t),s.removeAllEquations();var R=Math.pow;for(y=0;y!==n;y++){if((M=a[y]).type&u){var j=R(1-M.linearDamping,e),_=M.velocity;_.mult(j,_);var z=M.angularVelocity;if(z){var k=R(1-M.angularDamping,e);z.mult(k,z)}}}for(this.dispatchEvent(ae),y=0;y!==n;y++){(M=a[y]).preStep&&M.preStep.call(M)}c&&(t=performance.now());var V=de,I=pe,U=this.stepnumber,D=oe.DYNAMIC|oe.KINEMATIC,W=U%(this.quatNormalizeSkip+1)==0,q=this.quatNormalizeFast,H=.5*e;for(re.types.PLANE,re.types.CONVEXPOLYHEDRON,y=0;y!==n;y++){var K=a[y],X=K.force,Y=K.torque;if(K.type&D&&K.sleepState!==oe.SLEEPING){var Z=K.velocity,J=K.angularVelocity,Q=K.position,$=K.quaternion,ee=K.invMass,te=K.invInertiaWorld;Z.x+=X.x*ee*e,Z.y+=X.y*ee*e,Z.z+=X.z*ee*e,K.angularVelocity&&(te.vmult(Y,me),me.mult(e,me),me.vadd(J,J)),Q.x+=Z.x*e,Q.y+=Z.y*e,Q.z+=Z.z*e,K.angularVelocity&&(V.set(J.x,J.y,J.z,0),V.mult($,I),$.x+=H*I.x,$.y+=H*I.y,$.z+=H*I.z,$.w+=H*I.w,W&&(q?$.normalizeFast():$.normalize())),K.aabb&&(K.aabbNeedsUpdate=!0),K.updateInertiaWorld&&K.updateInertiaWorld()}}for(this.clearForces(),this.broadphase.dirty=!0,c&&(h.integrate=performance.now()-t),this.time+=e,this.stepnumber+=1,this.dispatchEvent(ne),y=0;y!==n;y++){var ie=(M=a[y]).postStep;ie&&ie.call(M)}if(this.allowSleep)for(y=0;y!==n;y++)a[y].sleepTick(this.time)},i.prototype.clearForces=function(){for(var e=this.bodies,t=e.length,i=0;i!==t;i++){var r=e[i];r.force,r.torque,r.force.set(0,0,0),r.torque.set(0,0,0)}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/Ray":9,"../collision/RaycastResult":10,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../material/ContactMaterial":24,"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Shape":43,"../solver/GSSolver":46,"../utils/EventTarget":49,"../utils/TupleDictionary":52,"../utils/Vec3Pool":54,"./Narrowphase":55}]},{},[2])(2)}),TONG._Scene=TONG.Scene,Scene.prototype=Object.create(TONG._Scene.prototype),Scene.prototype.constructor=Scene,Scene.prototype.initialize=function(e){this.canvas=e.domElement,this.renderer=e,this.mouse.canvas=this.canvas,this.clock.start()},Scene.prototype.update=function(){this.mouse.update(),this.keyboard.update(),this.mouseNormalized.set(this.mouse.position.x/this.canvas.width*2-1,-2*this.mouse.position.y/this.canvas.height+1),0<this.cameras.length&&this.raycaster.setFromCamera(this.mouseNormalized,this.cameras[0]),this.delta=this.clock.getDelta(),this.usePhysics&&this.world.step(this.delta<.05?this.delta:.05)},Scene.prototype.render=function(e){var t=e.domElement.width,i=e.domElement.height;e.setScissorTest(!0),e.clear();for(var r=0;r<this.cameras.length;r++){var o=this.cameras[r];e.setViewport(t*o.offset.x/window.devicePixelRatio,i*o.offset.y/window.devicePixelRatio,t*o.viewport.x/window.devicePixelRatio,i*o.viewport.y/window.devicePixelRatio),e.setScissor(t*o.offset.x/window.devicePixelRatio,i*o.offset.y/window.devicePixelRatio,t*o.viewport.x/window.devicePixelRatio,i*o.viewport.y/window.devicePixelRatio),e.autoClearColor=o.clearColor,e.autoClearDepth=o.clearDepth,e.autoClearStencil=o.clearStencil,o.render(e,this)}e.setScissorTest(!1)},Scene.prototype.getCamera=function(e,t){if(void 0===t&&(t=this),e===t.uuid)return t;for(var i=t.children,r=0;r<i.length;r++){var o=this.getCamera(e,i[r]);if(null!==o)return o}return null},Scene.prototype.setSize=function(e,t){for(var i=0;i<this.cameras.length;i++){var r=this.cameras[i];r.aspect=e/t,r.resize(e,t),r.updateProjectionMatrix(),r.render(this.renderer,this)}this.render(this.renderer),this.renderer.setSize(e,t)},Scene.prototype.addCamera=function(e){-1===this.cameras.indexOf(e)&&(this.cameras.push(e),this.updateCameraOrder())},Scene.prototype.addDirectionalLight=function(e){-1===this.directionalLights.indexOf(e)&&this.directionalLights.push(e)},Scene.prototype.updateCameraOrder=function(){this.cameras.sort(function(e,t){return e.order>t.order})},Scene.prototype.removeCamera=function(e){var t=this.cameras.indexOf(e);-1<t&&this.cameras.splice(t,1)},Scene.prototype.isCameraActive=function(e){return-1<this.cameras.indexOf(e)},Scene.prototype.setFogMode=function(e){var t=null!==this.fog?this.fog.color.getHex():"#FFFFFF";e===TONG.Fog.LINEAR?this.fog=new TONG.Fog(t,5,20):e===TONG.Fog.EXPONENTIAL?this.fog=new TONG.FogExp2(t,.01):e===TONG.Fog.NONE&&(this.fog=null)},Scene.prototype.toJSON=function(e){var i=this.background,t=TONG.Object3D.prototype.toJSON.call(this,e,function(e,t){i instanceof TONG.Color?i=i.toJSON(e):i instanceof TONG.Texture&&(i=i.toJSON(e).uuid)});null!==i&&(t.object.background=i),null!==this.fog&&(t.object.fog=this.fog.toJSON()),t.object.usePhysics=this.usePhysics,t.object.cameras=[];for(var r=0;r<this.cameras.length;r++)t.object.cameras.push(this.cameras[r].uuid);return t.object.world={},t.object.world.gravity=this.world.gravity,t.object.world.quatNormalizeSkip=this.world.quatNormalizeSkip,t.object.world.quatNormalizeFast=this.world.quatNormalizeFast,t.object.world.solver={},t.object.world.solver.tolerance=this.world.solver.tolerance,t.object.world.solver.iterations=this.world.solver.iterations,t},TONG.Object3D.prototype._body=null,Object.defineProperty(TONG.Object3D.prototype,"body",{set:function(e){e instanceof CANNON.Body&&(this._body=e)},get:function(){if(null==this._body){var e=new CANNON.Material;e.friction=0,e.restitution=0,this._body=new CANNON.Body({mass:1,material:e}),this._body.type=CANNON.Body.STATIC}return this._body},enumerable:!1}),Object.defineProperty(TONG.Object3D.prototype,"worldPosition",{get:function(){var i=new TONG.Vector3;return i.copy(this.position),function e(t){t.parent&&(i.add(t.position),e(t.parent))}(this.parent),i},enumerable:!1}),Object.defineProperty(TONG.Object3D.prototype,"worldQuaternion",{get:function(){var e=new TONG.Quaternion;return e.setFromEuler(this.worldRotation),e},enumerable:!1}),Object.defineProperty(TONG.Object3D.prototype,"worldRotation",{get:function(){var e=this.rotation.order,i=new TONG.Vector3;i.copy(this.rotation.toVector3()),function e(t){t.parent&&(i.add(t.rotation.toVector3()),e(t.parent))}(this.parent);var t=new TONG.Euler;return t.setFromVector3(i,e),t},enumerable:!1}),Object.defineProperty(TONG.Object3D.prototype,"worldScale",{get:function(){var i=new TONG.Vector3;return i.copy(this.scale),function e(t){t.parent&&(i.multiply(t.scale),e(t.parent))}(this.parent),i},enumerable:!1}),TONG.Object3D.prototype.addShape=function(e){e instanceof CANNON.Shape&&this.body.addShape(e)},TONG.Object3D.prototype.setPosition=function(e){this.updateMatrixWorld(!0);var t=new TONG.Vector3;t.copy(e),this.worldToLocal(t),this.position.add(t)},TONG.Object3D.prototype.setRotation=function(e,t){this.parent&&!0===t?this.setWorldRotation(e):this.rotation.copy(e)},TONG.Object3D.prototype.setScale=function(e,t){this.parent&&!0===t?this.setWorldScale(e):this.scale.copy(e)},TONG.Object3D.prototype.setWorldScale=function(e){if(this.parent){var t=new TONG.Vector3;this.parent.updateMatrixWorld(!0),this.parent.getWorldScale(t),e.divide(t),this.scale.copy(e)}else this.scale.set(e)},TONG.Object3D.prototype.setWorldRotation=function(e){if(this.parent){var t=new TONG.Euler;this.parent.updateMatrixWorld(!0),this.parent.getWorldRotation(t),this.rotation.set(e.x-t.x,e.y-t.y,e.z-t.z)}else this.rotation.set(e)},TONG.Object3D.prototype.lookObject=function(){var t=new TONG.Matrix4,i=new TONG.Vector3,r=new TONG.Quaternion,o=new TONG.Vector3,n=new TONG.Vector3,a=new TONG.Quaternion,s=new TONG.Vector3,l=this;return function(e){l.matrixWorld.decompose(i,r,o),l.matrixWorld.decompose(n,a,s),l.isCamera?t.lookAt(i,n,l.up):t.lookAt(n,i,l.up),r.setFromRotationMatrix(t),l.matrixWorld.compose(i,r,o)}},TONG.SubdivisionModifier=function(e){this.subdivisions=void 0===e?1:e},TONG.SubdivisionModifier.prototype.modify=function(e){for(var t=this.subdivisions;0<t--;)this.smooth(e);e.computeFaceNormals(),e.computeVertexNormals()},function(){var D=["a","b","c"];function W(e,t,i){return i[Math.min(e,t)+"_"+Math.max(e,t)]}function q(e,t,i,r,o,n){var a,s=Math.min(e,t),l=Math.max(e,t),c=s+"_"+l;c in r?a=r[c]:(a={a:i[s],b:i[l],newEdge:null,faces:[]},r[c]=a);a.faces.push(o),n[e].edges.push(a),n[t].edges.push(a)}function H(e,t,i,r){e.push(new TONG.Face3(t,i,r))}function K(e,t){return Math.abs(t-e)/2+Math.min(e,t)}function X(e,t,i,r){e.push([t.clone(),i.clone(),r.clone()])}TONG.SubdivisionModifier.prototype.smooth=function(e){var t,i,r,o,n,a,s,l,c,h,u,d,p,m,f=new TONG.Vector3,v=[];t=e.vertices,i=e.faces;var y,g,x,w,b,T,S,C,O,N,A,M,P,E,L=void 0!==(r=e.faceVertexUvs[0])&&0<r.length;for(s in function(e,t,i,r){var o,n,a;for(o=0,n=e.length;o<n;o++)i[o]={edges:[]};for(o=0,n=t.length;o<n;o++)q((a=t[o]).a,a.b,e,r,a,i),q(a.b,a.c,e,r,a,i),q(a.c,a.a,e,r,a,i)}(t,i,u=new Array(t.length),d={}),p=[],d){for(g=d[s],x=new TONG.Vector3,b=3/8,T=1/8,2!=(S=g.faces.length)&&(b=.5,T=0),x.addVectors(g.a,g.b).multiplyScalar(b),f.set(0,0,0),c=0;c<S;c++){for(w=g.faces[c],h=0;h<3&&((y=t[w[D[h]]])===g.a||y===g.b);h++);f.add(y)}f.multiplyScalar(T),x.add(f),g.newEdge=p.length,p.push(x)}for(m=[],s=0,l=t.length;s<l;s++){for(P=t[s],3==(a=(M=u[s].edges).length)?C=3/16:3<a&&(C=3/(8*a)),O=1-a*C,N=C,a<=2&&2==a&&(O=.75,N=1/8),E=P.clone().multiplyScalar(O),f.set(0,0,0),c=0;c<a;c++)y=(A=M[c]).a!==P?A.a:A.b,f.add(y);f.multiplyScalar(N),E.add(f),m.push(E)}o=m.concat(p);var G,B,F,R,j,_,z,k=m.length;n=[];var V=new TONG.Vector2,I=new TONG.Vector2,U=new TONG.Vector2;for(s=0,l=i.length;s<l;s++)H(n,G=W((w=i[s]).a,w.b,d).newEdge+k,B=W(w.b,w.c,d).newEdge+k,F=W(w.c,w.a,d).newEdge+k),H(n,w.a,G,F),H(n,w.b,B,G),H(n,w.c,F,B),L&&(j=(R=r[s])[0],_=R[1],z=R[2],V.set(K(j.x,_.x),K(j.y,_.y)),I.set(K(_.x,z.x),K(_.y,z.y)),U.set(K(j.x,z.x),K(j.y,z.y)),X(v,V,I,U),X(v,j,V,U),X(v,_,I,V),X(v,z,U,I));e.vertices=o,e.faces=n,L&&(e.faceVertexUvs[0]=v)}}(),PhysicsObject.prototype=Object.create(TONG.Group.prototype),PhysicsObject.prototype.initialize=function(){this.body.position.copy(this.position),this.body.quaternion.copy(this.quaternion);for(var e=this;null!==e.parent;)(e=e.parent)instanceof Scene&&(this.world=e.world,this.world.addBody(this.body));TONG.Object3D.prototype.initialize.call(this)},PhysicsObject.prototype.update=function(e){this.position.copy(this.body.position),this.body.fixedRotation||this.quaternion.copy(this.body.quaternion),TONG.Object3D.prototype.update.call(this,e)},PhysicsObject.prototype.addShape=function(e){e instanceof CANNON.Shape&&this.body.addShape(e)},PhysicsObject.prototype.toJSON=function(e){var t=TONG.Object3D.prototype.toJSON.call(this,e);t.object.body={},t.object.body.type=this.body.type,t.object.body.mass=this.body.mass,t.object.body.linearDamping=this.body.linearDamping,t.object.body.angularDamping=this.body.angularDamping,t.object.body.allowSleep=this.body.allowSleep,t.object.body.sleepSpeedLimit=this.body.sleepSpeedLimit,t.object.body.sleepTimeLimit=this.body.sleepTimeLimit,t.object.body.collisionFilterGroup=this.body.collisionFilterGroup,t.object.body.collisionFilterMask=this.body.collisionFilterMask,t.object.body.fixedRotation=this.body.fixedRotation,t.object.body.shapes=[];for(var i=this.body.shapes,r=0;r<i.length;r++){var o=i[r],n={};n.type=o.type,o.type===CANNON.Shape.types.SPHERE?n.radius=o.radius:o.type===CANNON.Shape.types.BOX?(n.halfExtents={},n.halfExtents.x=o.halfExtents.x,n.halfExtents.y=o.halfExtents.y,n.halfExtents.z=o.halfExtents.z):o.type===CANNON.Shape.types.CONVEXPOLYHEDRON?(n.vertices=o.vertices,n.faces=o.faces):o.type===CANNON.Shape.types.TRIMESH&&(n.vertices=o.vertices,n.normals=o.normals,n.edges=o.edges,n.indices=o.indices),t.object.body.shapes[r]=n}return t},PhysicsObjectHelper.sphere=new TONG.SphereBufferGeometry(1,24,24),PhysicsObjectHelper.box=new TONG.BoxBufferGeometry(1,1,1),PhysicsObjectHelper.plane=new TONG.PlaneBufferGeometry(100,100),PhysicsObjectHelper.cylinder=new TONG.CylinderBufferGeometry(1,1,10,32),PhysicsObjectHelper.prototype=Object.create(TONG.Object3D.prototype),PhysicsObjectHelper.prototype.update=function(){var e=this.meshes,t=this.tmpVec0,i=this.tmpQuat0,r=this.tmpScale,o=this.tmpPosition,n=0,a=this.obj.body,s=new TONG.Vector3;s.setFromMatrixPosition(this.obj.matrixWorld);var l=new TONG.Vector3;this.obj.getWorldScale(l),a.position.copy(s);var c=new TONG.Quaternion;this.obj.getWorldQuaternion(c),a.quaternion.copy(c);for(var h=0;h<a.shapes.length;h++){var u=a.shapes[h];if(this.updateMesh(n,a,u),y=e[n]){var d=r.x*l.x,p=r.y*l.y,m=r.z*l.z;if(u.type==CANNON.Shape.types.SPHERE){var f=Math.max(Math.abs(d),Math.abs(p),Math.abs(m));u.radius=f}else u.halfExtents.set(d,p,m);this.scaleMesh(y,u),a.quaternion.vmult(a.shapeOffsets[h],t),a.position.vadd(t,t),a.position.vadd(o,t),a.quaternion.mult(a.shapeOrientations[h],i),y.position.copy(t),y.quaternion.copy(i)}n++}for(var v=n;v<e.length;v++){var y;(y=e[v])&&this.remove(y)}e.length=n},PhysicsObjectHelper.prototype.updateMesh=function(e,t,i){var r=this.meshes[e];this.typeMatch(r,i)||(r&&this.remove(r),r=this.meshes[e]=this.createMesh(i)),this.scaleMesh(r,i)},PhysicsObjectHelper.prototype.typeMatch=function(e,t){if(!e)return!1;var i=e.geometry;return i instanceof TONG.SphereGeometry&&t instanceof CANNON.Sphere||i instanceof TONG.BoxGeometry&&t instanceof CANNON.Box||i instanceof TONG.PlaneGeometry&&t instanceof CANNON.Plane||i.id===t.geometryId&&(t instanceof CANNON.ConvexPolyhedron||t instanceof CANNON.Trimesh)||t instanceof CANNON.Heightfield},PhysicsObjectHelper.prototype.createMesh=function(e){var t=new TONG.LineSegments;t.material=this.material;var i=t,r=null;this.material;switch(e.type){case CANNON.Shape.types.SPHERE:case CANNON.Shape.types.PARTICLE:r=i.geometry=new TONG.EdgesGeometry(PhysicsObjectHelper.sphere);break;case CANNON.Shape.types.BOX:r=i.geometry=new TONG.EdgesGeometry(PhysicsObjectHelper.box);break;case CANNON.Shape.types.PLANE:r=i.geometry=new TONG.EdgesGeometry(PhysicsObjectHelper.plane),i.scale.set(1e3,1e3,1);break;case CANNON.Shape.types.CONVEXPOLYHEDRON:for(var o=new TONG.Geometry,n=0;n<e.vertices.length;n++){var a=e.vertices[n];o.vertices.push(new TONG.Vector3(a.x,a.y,a.z))}for(n=0;n<e.faces.length;n++)for(var s=e.faces[n],l=s[0],c=1;c<s.length-1;c++){var h=s[c],u=s[c+1];o.faces.push(new TONG.Face3(l,h,u))}o.computeBoundingSphere(),o.computeFaceNormals(),r=i.geometry=new TONG.EdgesGeometry(o),e.geometryId=o.id;break;case CANNON.Shape.types.TRIMESH:var d=new TONG.Geometry,p=this.tmpVec0,m=this.tmpVec1,f=this.tmpVec2;for(n=0;n<e.indices.length/3;n++){e.getTriangleVertices(n,p,m,f),d.vertices.push(new TONG.Vector3(p.x,p.y,p.z),new TONG.Vector3(m.x,m.y,m.z),new TONG.Vector3(f.x,f.y,f.z));c=d.vertices.length-3;d.faces.push(new TONG.Face3(c,c+1,c+2))}d.computeBoundingSphere(),d.computeFaceNormals(),r=i.geometry=new TONG.EdgesGeometry(d),e.geometryId=d.id;break;case CANNON.Shape.types.HEIGHTFIELD:d=new TONG.Geometry,p=this.tmpVec0,m=this.tmpVec1,f=this.tmpVec2;for(var v=0;v<e.data.length-1;v++)for(var y=0;y<e.data[v].length-1;y++)for(var g=0;g<2;g++){e.getConvexTrianglePillar(v,y,0===g),p.copy(e.pillarConvex.vertices[0]),m.copy(e.pillarConvex.vertices[1]),f.copy(e.pillarConvex.vertices[2]),p.vadd(e.pillarOffset,p),m.vadd(e.pillarOffset,m),f.vadd(e.pillarOffset,f),d.vertices.push(new TONG.Vector3(p.x,p.y,p.z),new TONG.Vector3(m.x,m.y,m.z),new TONG.Vector3(f.x,f.y,f.z));n=d.vertices.length-3;d.faces.push(new TONG.Face3(n,n+1,n+2))}d.computeBoundingSphere(),d.computeFaceNormals(),r=i.geometry=new TONG.EdgesGeometry(d),e.geometryId=d.id}return r?(this.add(i),i):null},PhysicsObjectHelper.prototype.scaleShape=function(e,t){var i=e.type;if(i===CANNON.Shape.types.SPHERE){var r=Math.max(Math.abs(t.scale.x),Math.abs(t.scale.y),Math.abs(t.scale.z));e.radius=r/2}else i===CANNON.Shape.types.PARTICLE||(i===CANNON.Shape.types.BOX?(e.halfExtents.x=t.scale.x/2,e.halfExtents.y=t.scale.y/2,e.halfExtents.z=t.scale.z/2):i===CANNON.Shape.types.CONVEXPOLYHEDRON||i===CANNON.Shape.types.TRIMESH||CANNON.Shape.types.HEIGHTFIELD)},PhysicsObjectHelper.prototype.scaleMesh=function(e,t){var i=t.type;if(i===CANNON.Shape.types.SPHERE){var r=t.radius;e.scale.set(r,r,r)}else i===CANNON.Shape.types.PARTICLE?e.scale.copy(t.halfExtents):i===CANNON.Shape.types.BOX?e.scale.copy(t.halfExtents):i===CANNON.Shape.types.CYLINDER?e.scale.copy(t.halfExtents):i===CANNON.Shape.types.CONVEXPOLYHEDRON?e.scale.copy(t.halfExtents):i===CANNON.Shape.types.TRIMESH?e.scale.copy(t.halfExtents):i===CANNON.Shape.types.HEIGHTFIELD&&e.scale.copy(t.halfExtents)},PhysicsGenerator.Type={BOX:"Box",CYLINDER:"Cylinder",SPHERE:"Sphere",HULL:"ConvexPolyhedron"},PhysicsGenerator.createSingleShape=function(e,t){if(void 0!==t)return t===PhysicsGenerator.Type.BOX?PhysicsGenerator.createBoundingBoxShape(e):t===PhysicsGenerator.Type.CYLINDER?PhysicsGenerator.createBoundingCylinderShape(e):t===PhysicsGenerator.Type.SPHERE?PhysicsGenerator.createBoundingSphereShape(e):t===PhysicsGenerator.Type.HULL?PhysicsGenerator.createConvexPolyhedron(e):null;if(!e.geometry)return new CANNON.Box(new CANNON.Vec3(1,1,1));switch(e.geometry.type){case"BoxGeometry":case"BoxBufferGeometry":return PhysicsGenerator.createBoxShape(e.geometry);case"CylinderGeometry":case"CylinderBufferGeometry":return PhysicsGenerator.createCylinderShape(e.geometry);case"SphereGeometry":case"SphereBufferGeometry":return PhysicsGenerator.createSphereShape(e.geometry);case"PlaneGeometry":case"PlaneBufferGeometry":case"TubeGeometry":case"Geometry":case"BufferGeometry":default:return PhysicsGenerator.createConvexPolyhedron(e)}},PhysicsGenerator.createShape=function(e,t){if(void 0!==t)return t===PhysicsGenerator.Type.BOX?PhysicsGenerator.createBoundingBoxShape(e):t===PhysicsGenerator.Type.CYLINDER?PhysicsGenerator.createBoundingCylinderShape(e):t===PhysicsGenerator.Type.SPHERE?PhysicsGenerator.createBoundingSphereShape(e):t===PhysicsGenerator.Type.HULL?PhysicsGenerator.createConvexPolyhedron(e):null;var i=PhysicsGenerator.getGeometry(e);if(!i)return new CANNON.Box(new CANNON.Vec3(1,1,1));switch(i.type){case"BoxGeometry":case"BoxBufferGeometry":return PhysicsGenerator.createBoxShape(i);case"CylinderGeometry":case"CylinderBufferGeometry":return PhysicsGenerator.createCylinderShape(i);case"PlaneGeometry":case"PlaneBufferGeometry":return PhysicsGenerator.createPlaneShape(i);case"SphereGeometry":case"SphereBufferGeometry":return PhysicsGenerator.createSphereShape(i);case"TubeGeometry":return PhysicsGenerator.createTubeShape(i);case"Geometry":case"BufferGeometry":return PhysicsGenerator.createConvexPolyhedron(e);default:return PhysicsGenerator.createConvexPolyhedron(i)}},PhysicsGenerator.createBoxShape=function(e){if(!PhysicsGenerator.getVertices(e).length)return null;e.computeBoundingBox();var t=e.boundingBox;return new CANNON.Box(new CANNON.Vec3((t.max.x-t.min.x)/2,(t.max.y-t.min.y)/2,(t.max.z-t.min.z)/2))},PhysicsGenerator.createBoundingBoxShape=function(e){var t=new TONG.Box3;if(t.setFromObject(e),!isFinite(t.min.lengthSq()))return null;var i=new CANNON.Box(new CANNON.Vec3((t.max.x-t.min.x)/2,(t.max.y-t.min.y)/2,(t.max.z-t.min.z)/2));return e.updateMatrixWorld(),(new TONG.Vector3).setFromMatrixPosition(e.matrixWorld),i},PhysicsGenerator.createConvexPolyhedron=function(e){var t,i,r,o=PhysicsGenerator.getGeometry(e);if(o instanceof TONG.BufferGeometry&&(o=(new TONG.Geometry).fromBufferGeometry(o)),!o||!o.vertices.length)return null;var n=(new quickhull)(o);for(i=new Array(n.vertices.length),t=0;t<n.vertices.length;t++)i[t]=new CANNON.Vec3(n.vertices[t].x,n.vertices[t].y,n.vertices[t].z);for(r=new Array(n.faces.length),t=0;t<n.faces.length;t++)r[t]=[n.faces[t].a,n.faces[t].b,n.faces[t].c];return new CANNON.ConvexPolyhedron(i,r)},PhysicsGenerator.createCylinderShape=function(e){var t=e.parameters,i=new CANNON.Cylinder(t.radiusTop,t.radiusBottom,t.height,t.radialSegments);return i.orientation=new CANNON.Quaternion,i.orientation.setFromEuler(0,0,0,"XYZ").normalize(),i},PhysicsGenerator.createBoundingCylinderShape=function(e){var t=["x","y","z"],i=t.splice(t.indexOf("y"),1)&&t,r=PhysicsGenerator.getGeometry(e);r.computeBoundingBox(),r.computeBoundingSphere();var o=r.boundingBox.max.y-r.boundingBox.min.y,n=.5*Math.max(r.boundingBox.max[i[0]]-r.boundingBox.min[i[0]],r.boundingBox.max[i[1]]-r.boundingBox.min[i[1]]),a=new CANNON.Cylinder(n,n,o,12);return a.orientation=new CANNON.Quaternion,a.orientation.setFromEuler(Math.PI/2,0,0,"XYZ").normalize(),a},PhysicsGenerator.createPlaneShape=function(e){e.computeBoundingBox();var t=e.boundingBox;return new CANNON.Box(new CANNON.Vec3((t.max.x-t.min.x)/2,(t.max.y-t.min.y)/2,(t.max.z-t.min.z)/2))},PhysicsGenerator.createSphereShape=function(e){return new CANNON.Sphere(e.parameters.radius)},PhysicsGenerator.createBoundingSphereShape=function(e){var t=PhysicsGenerator.getGeometry(e);return t.computeBoundingSphere(),new CANNON.Sphere(t.boundingSphere.radius)},PhysicsGenerator.createTubeShape=function(e){var t=new TONG.BufferGeometry;return t.fromGeometry(e),PhysicsGenerator.createTrimeshShape(t)},PhysicsGenerator.createTrimeshShape=function(e){var t,i=PhysicsGenerator.getVertices(e);return i.length?(t=Object.keys(i).map(Number),new CANNON.Trimesh(i,t)):null},PhysicsGenerator.getGeometry=function(e){var t=PhysicsGenerator.getMeshes(e);if(0===t.length)return null;var i=new TONG.Geometry;if(1===t.length){var r=new TONG.Vector3,o=new TONG.Quaternion,n=new TONG.Vector3(1,1,1);return i=t[0].geometry.clone(),t[0].updateMatrixWorld(),t[0].matrixWorld.decompose(r,o,n),i.scale(n.x,n.y,n.z)}for(var a,s=new TONG.Geometry;a=t.pop();)a.updateMatrixWorld(),a.geometry instanceof TONG.BufferGeometry?(i.fromBufferGeometry(a.geometry),s.merge(i,a.matrixWorld)):s.merge(a.geometry,a.matrixWorld);var l=new TONG.Matrix4;return l.scale(e.scale),s.applyMatrix(l),s},PhysicsGenerator.getVertices=function(e){return e.attributes||(e=(new TONG.BufferGeometry).fromGeometry(e)),e.attributes.position.array},PhysicsGenerator.getMeshes=function(e){var t=[];return e.traverse(function(e){e instanceof TONG.Mesh&&t.push(e)}),t};var quickhull=function(){var m,f,v,y,g,x,w,b,T,S,C,O,N,A,M,P,E,L,G=[],B=[];var r,o,n,F=(r=new TONG.Vector3,o=new TONG.Vector3,n=new TONG.Vector3,function(e,t,i){return r.subVectors(i,e),o.subVectors(t,e),n.crossVectors(r,o),n.normalize()});function R(e,t){if(void 0!==e.normal)return e.normal;var i=t[e[0]],r=t[e[1]],o=t[e[2]];return S.subVectors(r,i),C.subVectors(o,i),A.crossVectors(C,S),A.normalize(),e.normal=A.clone()}function j(e,t,i){var r=i[e[0]],o=[],n=R(e,i);t.sort(function(e,t){return o[e.x/3]=void 0!==o[e.x/3]?o[e.x/3]:n.dot(O.subVectors(e,r)),o[t.x/3]=void 0!==o[t.x/3]?o[t.x/3]:n.dot(N.subVectors(t,r)),o[e.x/3]-o[t.x/3]});var a=t.length;for(1===a&&(o[t[0].x/3]=n.dot(O.subVectors(t[0],r)));0<a--&&0<o[t[a].x/3];);a+1<t.length&&0<o[t[a+1].x/3]&&(e.visiblePoints=t.splice(a+1))}function _(e,t){for(var i,r=G.length,o=[e],n=t.indexOf(e.visiblePoints.pop());0<r--;)(i=G[r])!==e&&0<R(i,t).dot(M.subVectors(t[n],t[i[0]]))&&o.push(i);var a,s,l,c,h=r=o.length,u=1===r,d=[],p=0,m=[];o[0][0],o[0][1],o[0][1],o[0][2],o[0][2],o[0][0];if(1===o.length)d=[(i=o[0])[0],i[1],i[1],i[2],i[2],i[0]],-1<B.indexOf(i)&&B.splice(B.indexOf(i),1),i.visiblePoints&&(m=m.concat(i.visiblePoints)),G.splice(G.indexOf(i),1);else for(;0<r--;){var f;for(i=o[r],-1<B.indexOf(i)&&B.splice(B.indexOf(i),1),i.visiblePoints&&(m=m.concat(i.visiblePoints)),G.splice(G.indexOf(i),1),cEdgeIndex=0;cEdgeIndex<3;){for(f=!1,h=o.length,l=i[cEdgeIndex],c=i[(cEdgeIndex+1)%3];0<h--&&!f;)if(p=0,(a=o[h])!==i)for(;p<3&&!f;)s=p+1,f=a[p]===l&&a[s%3]===c||a[p]===c&&a[s%3]===l,p++;f&&!u||(d.push(l),d.push(c)),cEdgeIndex++}}r=0;for(var v,y=d.length/2;r<y;)j(v=[d[2*r+1],n,d[2*r]],m,t),G.push(v),void 0!==v.visiblePoints&&B.push(v),r++}var a,s,l,z=(a=new TONG.Vector3,s=new TONG.Vector3,l=new TONG.Vector3,function(e,t,i){a.subVectors(t,e),s.subVectors(i,e),l.subVectors(i,t);var r=s.dot(a);if(r<0)return s.dot(s);var o=a.dot(a);return o<=r?l.dot(l):s.dot(s)-r*r/o});return function(e){S=new TONG.Vector3,C=new TONG.Vector3,new TONG.Vector3,O=new TONG.Vector3,N=new TONG.Vector3,A=new TONG.Vector3,M=new TONG.Vector3,P=new TONG.Vector3,E=new TONG.Vector3,L=new TONG.Vector3;for(var t=e.vertices,i=[],r=[],o=f=t.length,n=t.slice(0,6),a=0;0<o--;)t[o].x<n[0].x&&(n[0]=t[o]),t[o].x>n[1].x&&(n[1]=t[o]),t[o].y<n[2].y&&(n[2]=t[o]),t[o].y<n[3].y&&(n[3]=t[o]),t[o].z<n[4].z&&(n[4]=t[o]),t[o].z<n[5].z&&(n[5]=t[o]);for(v=o=6;0<o--;)for(v=o-1;0<v--;)a<(m=n[o].distanceToSquared(n[v]))&&(a=m,y=n[o],g=n[v]);for(o=6,a=0;0<o--;)a<(m=z(y,g,n[o]))&&(a=m,x=n[o]);for(b=F(y,g,x),T=b.dot(y),a=0,o=f;0<o--;)a<(m=Math.abs(t[o].dot(b)-T))&&(a=m,w=t[o]);var s=t.indexOf(y),l=t.indexOf(g),c=t.indexOf(x),h=t.indexOf(w),u=[[c,l,s],[l,h,s],[c,h,l],[s,h,c]];P.subVectors(g,y).normalize(),E.subVectors(x,y).normalize(),L.subVectors(w,y).normalize(),L.dot((new TONG.Vector3).crossVectors(E,P))<0&&(u[0].reverse(),u[1].reverse(),u[2].reverse(),u[3].reverse());var d=t.slice();d.splice(d.indexOf(y),1),d.splice(d.indexOf(g),1),d.splice(d.indexOf(x),1),d.splice(d.indexOf(w),1);for(o=u.length;0<o--;)j(u[o],d,t),void 0!==u[o].visiblePoints&&r.push(u[o]),i.push(u[o]);!function(e){for(;0<B.length;)_(B.shift(),e)}(t);for(var p=i.length;0<p--;)e.faces[p]=new TONG.Face3(i[p][2],i[p][1],i[p][0],i[p].normal);return e.normalsNeedUpdate=!0,e}};function ObjectUtils(){}function Pass(){this.uuid=TONG.Math.generateUUID(),this.type="Pass",this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1}function ShaderPass(e,t){Pass.call(this),this.type="Shader",this.textureID=void 0!==t?t:"tDiffuse",e instanceof TONG.ShaderMaterial?(this.uniforms=e.uniforms,this.material=e):e&&(this.uniforms=TONG.UniformsUtils.clone(e.uniforms),this.material=new TONG.ShaderMaterial({defines:e.defines||{},uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.camera=new TONG.OrthographicCamera(-1,1,1,-1,0,1),this.scene=new TONG.Scene,this.quad=new TONG.Mesh(new TONG.PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad)}function RenderPass(){Pass.call(this),this.type="Render",this.needsSwap=!1,this.clear=!1,this.isRender=!0}function EffectComposer(){void 0===TONG.CopyShader&&console.error("EffectComposer relies on THREE.CopyShader"),this.uuid=TONG.Math.generateUUID(),this.passes=[],this.width=1,this.height=1,this.renderTarget1=new TONG.WebGLRenderTarget(this.width,this.height,{minFilter:TONG.LinearFilter,magFilter:TONG.LinearFilter,format:TONG.RGBAFormat,stencilBuffer:!1}),this.renderTarget2=this.renderTarget1.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.copyPass=new ShaderPass(TONG.CopyShader)}function EventManager(){this.events=[]}function Gamepad(){this.vendor=-1,this.product=-1,this.connected=!1,this.gamepad=null,this.buttons=[];for(var e=navigator.getGamepads(),t=0;t<e.length;t++)if(null!==e[t]){this.setGamepad(e[t]);break}null===this.gamepad&&console.warn("nunuStudio: No gamepad found")}function Gyroscope(){this.alpha=0,this.beta=0,this.gamma=0,this.orientation=0,this.events=new EventManager;var t=this;this.events.add(window,"orientationchange",function(e){t.orientation=TONG.Math.degToRad(window.orientation)}),this.events.add(window,"deviceorientation",function(e){t.alpha=TONG.Math.degToRad(e.alpha),t.beta=TONG.Math.degToRad(e.beta),t.gamma=TONG.Math.degToRad(e.gamma)}),this.events.create()}function Key(){this.pressed=!1,this.justPressed=!1,this.justReleased=!1}function Keyboard(){this.keys=new Array(256),this.actions=[];for(var e=0;e<256;e++)this.keys[e]=new Key;this.events=new EventManager;var t=this.actions,i=this;this.events.add(window,"keydown",function(e){t.push(e.keyCode),t.push(Key.DOWN)}),this.events.add(window,"keyup",function(e){t.push(e.keyCode),t.push(Key.UP)}),this.events.add(window,"focus",function(e){i.reset()}),this.events.create()}function Mouse(){this._keys=new Array(3),this._position=new TONG.Vector2(0,0),this._positionUpdated=!1,this._delta=new TONG.Vector2(0,0),this._wheel=0,this._wheelUpdated=!1,this._doubleClicked=!1,this.keys=new Array(3),this.position=new TONG.Vector2(0,0),this.delta=new TONG.Vector2(0,0),this.wheel=0,this.doubleClicked=!1,this.canvas=null,this.events=new EventManager;for(var e=0;e<3;e++)this._keys[e]=new Key,this.keys[e]=new Key;var i=this;if(void 0!==window.onmousewheel?this.events.add(window,"mousewheel",function(e){i._wheel=e.deltaY,i._wheelUpdated=!0}):void 0!==window.addEventListener?this.events.add(window,"DOMMouseScroll",function(e){i._wheel=30*e.detail,i._wheelUpdated=!0}):this.events.add(window,"wheel",function(e){i._wheel=e.deltaY,i._wheelUpdated=!0}),"ontouchstart"in window||0<navigator.msMaxTouchPoints){var r=new TONG.Vector2(0,0);this.events.add(window,"touchstart",function(e){var t=e.touches[0];i.updatePosition(t.clientX,t.clientY,0,0),i.updateKey(Mouse.LEFT,Key.DOWN),r.set(t.clientX,t.clientY)}),this.events.add(window,"touchend",function(e){i.updateKey(Mouse.LEFT,Key.UP)}),this.events.add(window,"touchcancel",function(e){i.updateKey(Mouse.LEFT,Key.UP)}),this.events.add(document.body,"touchmove",function(e){var t=e.touches[0];i.updatePosition(t.clientX,t.clientY,t.clientX-r.x,t.clientY-r.y),r.set(t.clientX,t.clientY)})}this.events.add(window,"mousemove",function(e){i.updatePosition(e.clientX,e.clientY,e.movementX,e.movementY)}),this.events.add(window,"mousedown",function(e){i.updateKey(e.which-1,Key.DOWN)}),this.events.add(window,"mouseup",function(e){i.updateKey(e.which-1,Key.UP)}),this.events.add(window,"dragstart",function(e){i.updateKey(e.which-1,Key.UP)}),this.events.add(window,"dblclick",function(e){i._doubleClicked=!0}),this.events.create()}function ArraybufferUtils(){}function Base64Utils(){}function BufferUtils(){}function ByteArrayUtils(){}function FileSystem(){}ObjectUtils.getRoot=function(e){for(var t=e;null!==t.parent;)t=t.parent;return t},ObjectUtils.setMatrixAutoUpdate=function(e,t){e.matrixAutoUpdate=t,e.traverse(function(e){e.matrixAutoUpdate=t})},ObjectUtils.setShadowReceiving=function(e,t){e.receiveShadow=t,e.traverse(function(e){e.receiveShadow=t})},ObjectUtils.setShadowCasting=function(e,t){e.castShadow=t,e.traverse(function(e){e.castShadow=t})},ObjectUtils.isChildOf=function(e,t){for(var i=0;i<e.children.length;i++)if(e.children[i]===t||ObjectUtils.isChildOf(e.children[i],t))return!0;return!1},ObjectUtils.calculateBoundingBox=function(e){var i=null;return e.traverse(function(e){if(void 0!==e.geometry){e.geometry.computeBoundingBox();var t=e.geometry.boundingBox;null===i?i=t.clone():(t.min.x<i.min.x&&(i.min.x=t.min.x),t.max.x>i.max.x&&(i.max.x=t.max.x),t.min.y<i.min.y&&(i.min.y=t.min.y),t.max.y>i.max.y&&(i.max.y=t.max.y),t.min.z<i.min.z&&(i.min.z=t.min.z),t.max.z>i.max.z&&(i.max.z=t.max.z))}}),i},ObjectUtils.recalculateGeometryOrigin=function(e){e.traverse(function(e){if(void 0!==e.geometry){e.geometry.computeBoundingBox();var t=e.geometry.boundingBox.clone().getCenter(new THREE.Vector3);e.position.add(t);var i=new THREE.Matrix4;i.makeTranslation(-t.x,-t.y,-t.z),e.geometry.applyMatrix(i)}})},TONG.CopyShader={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","gl_FragColor = opacity * texel;","}"].join("\n")},Pass.prototype.setSize=function(e,t){},Pass.prototype.render=function(e,t,i,r,o,n,a){},Pass.prototype.dispose=function(){},Pass.prototype.toJSON=function(e){var t={};return t.uuid=this.uuid,t.type=this.type,t.enabled=this.enabled,t.needsSwap=this.needsSwap,t.renderToScreen=this.renderToScreen,t.clear=this.clear,t},ShaderPass.prototype=Object.create(Pass.prototype),ShaderPass.prototype.render=function(e,t,i,r,o,n,a){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=i.texture),this.quad.material=this.material,this.renderToScreen?e.render(this.scene,this.camera,void 0,this.clear):e.render(this.scene,this.camera,t,this.clear)},RenderPass.prototype=Object.create(Pass.prototype),RenderPass.prototype.render=function(e,t,i,r,o,n,a){this.renderToScreen?e.render(n,a,null,this.clear):e.render(n,a,i,this.clear)},EffectComposer.prototype.swapBuffers=function(){var e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e},EffectComposer.prototype.addPass=function(e){this.passes.push(e)},EffectComposer.prototype.moveBack=function(e){var t=this.passes.indexOf(e);if(0<t){for(var i=t;i!==t-1;i-=1)this.passes[i]=this.passes[i-1];return this.passes[t-1]=e,!0}return!1},EffectComposer.prototype.moveForward=function(e){var t=this.passes.indexOf(e);if(-1!==t&&t<this.passes.length-1){for(var i=t;i!==t+1;i+=1)this.passes[i]=this.passes[i+1];return this.passes[t+1]=e,!0}return!1},EffectComposer.prototype.removePass=function(e){var t=this.passes.indexOf(e);-1!==t&&this.passes.splice(t,1)},EffectComposer.prototype.insertPass=function(e,t){this.passes.splice(t,0,e)},EffectComposer.prototype.render=function(e,t,i,r){for(var o=!1,n=this.passes.length,a=0;a<n;a++){var s=this.passes[a];!0===s.enabled&&(s.render(e,this.writeBuffer,this.readBuffer,r,o,t,i),s.needsSwap&&(o&&(e.context.stencilFunc(e.context.NOTEQUAL,1,4294967295),this.copyPass.render(e,this.writeBuffer,this.readBuffer,r),e.context.stencilFunc(e.context.EQUAL,1,4294967295)),this.swapBuffers()),void 0!==TONG.MaskPass&&(s instanceof TONG.MaskPass?o=!0:s instanceof TONG.ClearMaskPass&&(o=!1)))}},EffectComposer.prototype.setSize=function(e,t){this.width=e,this.height=t,this.renderTarget1.setSize(e,t),this.renderTarget2.setSize(e,t);for(var i=0;i<this.passes.length;i++)this.passes[i].setSize(e,t)},EffectComposer.prototype.reset=function(){this.renderTarget1.clone();this.dispose(),this.renderTarget1,new TONG.WebGLRenderTarget(this.width,this.height,{minFilter:TONG.LinearFilter,magFilter:TONG.LinearFilter,format:TONG.RGBAFormat,stencilBuffer:!1}),this.renderTarget2=this.renderTarget1.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2},EffectComposer.prototype.dispose=function(){this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=null,this.renderTarget2=null,this.writeBuffer=null,this.readBuffer=null},EffectComposer.prototype.toJSON=function(){var e={};e.uuid=this.uuid,e.passes=[];for(var t=0;t<this.passes.length;t++)e.passes.push(this.passes[t].toJSON());return e},EffectComposer.fromJSON=function(e){var t=new EffectComposer;t.uuid=e.uuid;for(var i=0;i<e.passes.length;i++){var r=e.passes[i],o=null;if("Render"===r.type)o=new RenderPass;else if("UnrealBloom"===r.type){(o=new UnrealBloomPass).strength=r.strength,o.radius=r.radius,o.threshold=r.threshold,o.bloomFactors=r.bloomFactors;for(i=0;i<o.bloomTintColors.length;i++)o.bloomTintColors[i].fromArray(r.bloomTintColors[i])}else"Bloom"===r.type?o=new BloomPass(r.strength,r.kernelSize,r.sigma,r.resolution):"SSAO"===r.type?((o=new SSAOPass).onlyAO=r.onlyAO,o.radius=r.radius,o.aoClamp=r.aoClamp,o.lumInfluence=r.lumInfluence):"Bokeh"===r.type?o=new BokehPass(r.focus,r.aperture,r.maxblur):"FXAA"===r.type?o=new FXAAPass:"Copy"===r.type?o=new CopyPass:"Film"===r.type?((o=new FilmPass).grayscale=r.grayscale,o.noiseIntensity=r.noiseIntensity,o.scanlinesIntensity=r.scanlinesIntensity,o.scanlinesCount=r.scanlinesCount):"DotScreen"===r.type?((o=new DotScreenPass).center.fromArray(r.center),o.angle=r.angle,o.scale=r.scale):"Colorify"===r.type?(o=new ColorifyPass).color.setHex(r.color):"Sobel"===r.type?o=new SobelPass:"Technicolor"===r.type?o=new TechnicolorPass:"HueSaturation"===r.type?((o=new HueSaturationPass).hue=r.hue,o.saturation=r.saturation):o=new RenderPass;o.uuid=r.uuid,o.enabled=r.enabled,o.needsSwap=r.needsSwap,o.renderToScreen=r.renderToScreen,o.clear=r.clear,t.addPass(o)}return t},TONG.EffectComposer=function(e,t){if(this.renderer=e,void 0===t){var i={minFilter:TONG.LinearFilter,magFilter:TONG.LinearFilter,format:TONG.RGBAFormat,stencilBuffer:!1},r=e.getSize();(t=new TONG.WebGLRenderTarget(r.width,r.height,i)).texture.name="EffectComposer.rt1"}this.renderTarget1=t,this.renderTarget2=t.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.passes=[],void 0===TONG.CopyShader&&console.error("THREE.EffectComposer relies on THREE.CopyShader"),this.copyPass=new TONG.ShaderPass(TONG.CopyShader)},Object.assign(TONG.EffectComposer.prototype,{swapBuffers:function(){var e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e},addPass:function(e){this.passes.push(e);var t=this.renderer.getSize();e.setSize(t.width,t.height)},insertPass:function(e,t){this.passes.splice(t,0,e)},render:function(e){var t,i,r=!1,o=this.passes.length;for(i=0;i<o;i++)if(!1!==(t=this.passes[i]).enabled){if(t.render(this.renderer,this.writeBuffer,this.readBuffer,e,r),t.needsSwap){if(r){var n=this.renderer.context;n.stencilFunc(n.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),n.stencilFunc(n.EQUAL,1,4294967295)}this.swapBuffers()}void 0!==TONG.MaskPass&&(t instanceof TONG.MaskPass?r=!0:t instanceof TONG.ClearMaskPass&&(r=!1))}},reset:function(e){if(void 0===e){var t=this.renderer.getSize();(e=this.renderTarget1.clone()).setSize(t.width,t.height)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2},setSize:function(e,t){this.renderTarget1.setSize(e,t),this.renderTarget2.setSize(e,t);for(var i=0;i<this.passes.length;i++)this.passes[i].setSize(e,t)}}),TONG.Pass=function(){this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1},Object.assign(TONG.Pass.prototype,{setSize:function(e,t){},render:function(e,t,i,r,o){console.error("THREE.Pass: .render() must be implemented in derived pass.")}}),TONG.RenderPass=function(e,t,i,r,o){TONG.Pass.call(this),this.scene=e,this.camera=t,this.overrideMaterial=i,this.clearColor=r,this.clearAlpha=void 0!==o?o:0,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1},TONG.RenderPass.prototype=Object.assign(Object.create(TONG.Pass.prototype),{constructor:TONG.RenderPass,render:function(e,t,i,r,o){var n,a,s=e.autoClear;e.autoClear=!1,this.scene.overrideMaterial=this.overrideMaterial,this.clearColor&&(n=e.getClearColor().getHex(),a=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),this.clearDepth&&e.clearDepth(),e.render(this.scene,this.camera,this.renderToScreen?null:i,this.clear),this.clearColor&&e.setClearColor(n,a),this.scene.overrideMaterial=null,e.autoClear=s}}),TONG.ShaderPass=function(e,t){TONG.Pass.call(this),this.textureID=void 0!==t?t:"tDiffuse",e instanceof TONG.ShaderMaterial?(this.uniforms=e.uniforms,this.material=e):e&&(this.uniforms=TONG.UniformsUtils.clone(e.uniforms),this.material=new TONG.ShaderMaterial({defines:e.defines||{},uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.camera=new TONG.OrthographicCamera(-1,1,1,-1,0,1),this.scene=new TONG.Scene,this.quad=new TONG.Mesh(new TONG.PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad)},TONG.ShaderPass.prototype=Object.assign(Object.create(TONG.Pass.prototype),{constructor:TONG.ShaderPass,render:function(e,t,i,r,o){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=i.texture),this.quad.material=this.material,this.renderToScreen?e.render(this.scene,this.camera):e.render(this.scene,this.camera,t,this.clear)}}),TONG.OutlinePass=function(e,t,i,r){this.renderScene=t,this.renderCamera=i,this.selectedObjects=void 0!==r?r:[],this.visibleEdgeColor=new TONG.Color(1,1,1),this.hiddenEdgeColor=new TONG.Color(.1,.04,.02),this.edgeGlow=0,this.usePatternTexture=!1,this.edgeThickness=1,this.edgeStrength=3,this.downSampleRatio=2,this.pulsePeriod=0,TONG.Pass.call(this),this.resolution=void 0!==e?new TONG.Vector2(e.x,e.y):new TONG.Vector2(256,256);var o={minFilter:TONG.LinearFilter,magFilter:TONG.LinearFilter,format:TONG.RGBAFormat},n=Math.round(this.resolution.x/this.downSampleRatio),a=Math.round(this.resolution.y/this.downSampleRatio);this.maskBufferMaterial=new TONG.MeshBasicMaterial({color:16777215}),this.maskBufferMaterial.side=TONG.DoubleSide,this.renderTargetMaskBuffer=new TONG.WebGLRenderTarget(this.resolution.x,this.resolution.y,o),this.renderTargetMaskBuffer.texture.name="OutlinePass.mask",this.renderTargetMaskBuffer.texture.generateMipmaps=!1,this.depthMaterial=new TONG.MeshDepthMaterial,this.depthMaterial.side=TONG.DoubleSide,this.depthMaterial.depthPacking=TONG.RGBADepthPacking,this.depthMaterial.blending=TONG.NoBlending,this.prepareMaskMaterial=this.getPrepareMaskMaterial(),this.prepareMaskMaterial.side=TONG.DoubleSide,this.renderTargetDepthBuffer=new TONG.WebGLRenderTarget(this.resolution.x,this.resolution.y,o),this.renderTargetDepthBuffer.texture.name="OutlinePass.depth",this.renderTargetDepthBuffer.texture.generateMipmaps=!1,this.renderTargetMaskDownSampleBuffer=new TONG.WebGLRenderTarget(n,a,o),this.renderTargetMaskDownSampleBuffer.texture.name="OutlinePass.depthDownSample",this.renderTargetMaskDownSampleBuffer.texture.generateMipmaps=!1,this.renderTargetBlurBuffer1=new TONG.WebGLRenderTarget(n,a,o),this.renderTargetBlurBuffer1.texture.name="OutlinePass.blur1",this.renderTargetBlurBuffer1.texture.generateMipmaps=!1,this.renderTargetBlurBuffer2=new TONG.WebGLRenderTarget(Math.round(n/2),Math.round(a/2),o),this.renderTargetBlurBuffer2.texture.name="OutlinePass.blur2",this.renderTargetBlurBuffer2.texture.generateMipmaps=!1,this.edgeDetectionMaterial=this.getEdgeDetectionMaterial(),this.renderTargetEdgeBuffer1=new TONG.WebGLRenderTarget(n,a,o),this.renderTargetEdgeBuffer1.texture.name="OutlinePass.edge1",this.renderTargetEdgeBuffer1.texture.generateMipmaps=!1,this.renderTargetEdgeBuffer2=new TONG.WebGLRenderTarget(Math.round(n/2),Math.round(a/2),o),this.renderTargetEdgeBuffer2.texture.name="OutlinePass.edge2",this.renderTargetEdgeBuffer2.texture.generateMipmaps=!1;this.separableBlurMaterial1=this.getSeperableBlurMaterial(4),this.separableBlurMaterial1.uniforms.texSize.value=new TONG.Vector2(n,a),this.separableBlurMaterial1.uniforms.kernelRadius.value=1,this.separableBlurMaterial2=this.getSeperableBlurMaterial(4),this.separableBlurMaterial2.uniforms.texSize.value=new TONG.Vector2(Math.round(n/2),Math.round(a/2)),this.separableBlurMaterial2.uniforms.kernelRadius.value=4,this.overlayMaterial=this.getOverlayMaterial(),void 0===TONG.CopyShader&&console.error("THREE.OutlinePass relies on THREE.CopyShader");var s=TONG.CopyShader;this.copyUniforms=TONG.UniformsUtils.clone(s.uniforms),this.copyUniforms.opacity.value=1,this.materialCopy=new TONG.ShaderMaterial({uniforms:this.copyUniforms,vertexShader:s.vertexShader,fragmentShader:s.fragmentShader,blending:TONG.NoBlending,depthTest:!1,depthWrite:!1,transparent:!0}),this.enabled=!0,this.needsSwap=!1,this.oldClearColor=new TONG.Color,this.oldClearAlpha=1,this.camera=new TONG.OrthographicCamera(-1,1,1,-1,0,1),this.scene=new TONG.Scene,this.quad=new TONG.Mesh(new TONG.PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad),this.tempPulseColor1=new TONG.Color,this.tempPulseColor2=new TONG.Color,this.textureMatrix=new TONG.Matrix4},TONG.OutlinePass.prototype=Object.assign(Object.create(TONG.Pass.prototype),{constructor:TONG.OutlinePass,dispose:function(){this.renderTargetMaskBuffer.dispose(),this.renderTargetDepthBuffer.dispose(),this.renderTargetMaskDownSampleBuffer.dispose(),this.renderTargetBlurBuffer1.dispose(),this.renderTargetBlurBuffer2.dispose(),this.renderTargetEdgeBuffer1.dispose(),this.renderTargetEdgeBuffer2.dispose()},setSize:function(e,t){this.renderTargetMaskBuffer.setSize(e,t);var i=Math.round(e/this.downSampleRatio),r=Math.round(t/this.downSampleRatio);this.renderTargetMaskDownSampleBuffer.setSize(i,r),this.renderTargetBlurBuffer1.setSize(i,r),this.renderTargetEdgeBuffer1.setSize(i,r),this.separableBlurMaterial1.uniforms.texSize.value=new TONG.Vector2(i,r),i=Math.round(i/2),r=Math.round(r/2),this.renderTargetBlurBuffer2.setSize(i,r),this.renderTargetEdgeBuffer2.setSize(i,r),this.separableBlurMaterial2.uniforms.texSize.value=new TONG.Vector2(i,r)},changeVisibilityOfSelectedObjects:function(t){function e(e){e instanceof TONG.Mesh&&(e.visible=t)}for(var i=0;i<this.selectedObjects.length;i++){this.selectedObjects[i].traverse(e)}},changeVisibilityOfNonSelectedObjects:function(o){var n=[];function e(e){e instanceof TONG.Mesh&&n.push(e)}for(var t=0;t<this.selectedObjects.length;t++){this.selectedObjects[t].traverse(e)}this.renderScene.traverse(function(e){if(e instanceof TONG.Mesh){for(var t=!1,i=0;i<n.length;i++)if(n[i].id===e.id){t=!0;break}if(!t){var r=e.visible;o&&!e.bVisible||(e.visible=o),e.bVisible=r}}})},updateTextureMatrix:function(){this.textureMatrix.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),this.textureMatrix.multiply(this.renderCamera.projectionMatrix),this.textureMatrix.multiply(this.renderCamera.matrixWorldInverse)},render:function(e,t,i,r,o){if(0!==this.selectedObjects.length){this.oldClearColor.copy(e.getClearColor()),this.oldClearAlpha=e.getClearAlpha();var n=e.autoClear;if(e.autoClear=!1,o&&e.context.disable(e.context.STENCIL_TEST),e.setClearColor(16777215,1),this.changeVisibilityOfSelectedObjects(!1),this.renderScene.overrideMaterial=this.depthMaterial,e.render(this.renderScene,this.renderCamera,this.renderTargetDepthBuffer,!0),this.changeVisibilityOfSelectedObjects(!0),this.updateTextureMatrix(),this.changeVisibilityOfNonSelectedObjects(!1),this.renderScene.overrideMaterial=this.prepareMaskMaterial,this.prepareMaskMaterial.uniforms.cameraNearFar.value=new TONG.Vector2(this.renderCamera.near,this.renderCamera.far),this.prepareMaskMaterial.uniforms.depthTexture.value=this.renderTargetDepthBuffer.texture,this.prepareMaskMaterial.uniforms.textureMatrix.value=this.textureMatrix,e.render(this.renderScene,this.renderCamera,this.renderTargetMaskBuffer,!0),this.renderScene.overrideMaterial=null,this.changeVisibilityOfNonSelectedObjects(!0),this.quad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=this.renderTargetMaskBuffer.texture,e.render(this.scene,this.camera,this.renderTargetMaskDownSampleBuffer,!0),this.tempPulseColor1.copy(this.visibleEdgeColor),this.tempPulseColor2.copy(this.hiddenEdgeColor),0<this.pulsePeriod){var a=.625+.75*Math.cos(.01*performance.now()/this.pulsePeriod)/2;this.tempPulseColor1.multiplyScalar(a),this.tempPulseColor2.multiplyScalar(a)}this.quad.material=this.edgeDetectionMaterial,this.edgeDetectionMaterial.uniforms.maskTexture.value=this.renderTargetMaskDownSampleBuffer.texture,this.edgeDetectionMaterial.uniforms.texSize.value=new TONG.Vector2(this.renderTargetMaskDownSampleBuffer.width,this.renderTargetMaskDownSampleBuffer.height),this.edgeDetectionMaterial.uniforms.visibleEdgeColor.value=this.tempPulseColor1,this.edgeDetectionMaterial.uniforms.hiddenEdgeColor.value=this.tempPulseColor2,e.render(this.scene,this.camera,this.renderTargetEdgeBuffer1,!0),this.quad.material=this.separableBlurMaterial1,this.separableBlurMaterial1.uniforms.colorTexture.value=this.renderTargetEdgeBuffer1.texture,this.separableBlurMaterial1.uniforms.direction.value=TONG.OutlinePass.BlurDirectionX,this.separableBlurMaterial1.uniforms.kernelRadius.value=this.edgeThickness,e.render(this.scene,this.camera,this.renderTargetBlurBuffer1,!0),this.separableBlurMaterial1.uniforms.colorTexture.value=this.renderTargetBlurBuffer1.texture,this.separableBlurMaterial1.uniforms.direction.value=TONG.OutlinePass.BlurDirectionY,e.render(this.scene,this.camera,this.renderTargetEdgeBuffer1,!0),this.quad.material=this.separableBlurMaterial2,this.separableBlurMaterial2.uniforms.colorTexture.value=this.renderTargetEdgeBuffer1.texture,this.separableBlurMaterial2.uniforms.direction.value=TONG.OutlinePass.BlurDirectionX,e.render(this.scene,this.camera,this.renderTargetBlurBuffer2,!0),this.separableBlurMaterial2.uniforms.colorTexture.value=this.renderTargetBlurBuffer2.texture,this.separableBlurMaterial2.uniforms.direction.value=TONG.OutlinePass.BlurDirectionY,e.render(this.scene,this.camera,this.renderTargetEdgeBuffer2,!0),this.quad.material=this.overlayMaterial,this.overlayMaterial.uniforms.maskTexture.value=this.renderTargetMaskBuffer.texture,this.overlayMaterial.uniforms.edgeTexture1.value=this.renderTargetEdgeBuffer1.texture,this.overlayMaterial.uniforms.edgeTexture2.value=this.renderTargetEdgeBuffer2.texture,this.overlayMaterial.uniforms.patternTexture.value=this.patternTexture,this.overlayMaterial.uniforms.edgeStrength.value=this.edgeStrength,this.overlayMaterial.uniforms.edgeGlow.value=this.edgeGlow,this.overlayMaterial.uniforms.usePatternTexture.value=this.usePatternTexture,o&&e.context.enable(e.context.STENCIL_TEST),e.render(this.scene,this.camera,i,!1),e.setClearColor(this.oldClearColor,this.oldClearAlpha),e.autoClear=n}},getPrepareMaskMaterial:function(){return new TONG.ShaderMaterial({uniforms:{depthTexture:{value:null},cameraNearFar:{value:new TONG.Vector2(.5,.5)},textureMatrix:{value:new TONG.Matrix4}},vertexShader:"varying vec2 vUv;\t\t\t\tvarying vec4 projTexCoord;\t\t\t\tvarying vec4 vPosition;\t\t\t\tuniform mat4 textureMatrix;\t\t\t\tvoid main() {\t\t\t\t\tvUv = uv;\t\t\t\t\tvPosition = modelViewMatrix * vec4( position, 1.0 );\t\t\t\t\tvec4 worldPosition = modelMatrix * vec4( position, 1.0 );\t\t\t\t\tprojTexCoord = textureMatrix * worldPosition;\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"#include <packing>\t\t\t\tvarying vec2 vUv;\t\t\t\tvarying vec4 vPosition;\t\t\t\tvarying vec4 projTexCoord;\t\t\t\tuniform sampler2D depthTexture;\t\t\t\tuniform vec2 cameraNearFar;\t\t\t\t\t\t\t\tvoid main() {\t\t\t\t\tfloat depth = unpackRGBAToDepth(texture2DProj( depthTexture, projTexCoord ));\t\t\t\t\tfloat viewZ = -perspectiveDepthToViewZ( depth, cameraNearFar.x, cameraNearFar.y );\t\t\t\t\tfloat depthTest = (-vPosition.z > viewZ) ? 1.0 : 0.0;\t\t\t\t\tgl_FragColor = vec4(0.0, depthTest, 1.0, 1.0);\t\t\t\t}"})},getEdgeDetectionMaterial:function(){return new TONG.ShaderMaterial({uniforms:{maskTexture:{value:null},texSize:{value:new TONG.Vector2(.5,.5)},visibleEdgeColor:{value:new TONG.Vector3(1,1,1)},hiddenEdgeColor:{value:new TONG.Vector3(1,1,1)}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"varying vec2 vUv;\t\t\t\tuniform sampler2D maskTexture;\t\t\t\tuniform vec2 texSize;\t\t\t\tuniform vec3 visibleEdgeColor;\t\t\t\tuniform vec3 hiddenEdgeColor;\t\t\t\t\t\t\t\tvoid main() {\n\t\t\t\t\tvec2 invSize = 1.0 / texSize;\t\t\t\t\tvec4 uvOffset = vec4(1.0, 0.0, 0.0, 1.0) * vec4(invSize, invSize);\t\t\t\t\tvec4 c1 = texture2D( maskTexture, vUv + uvOffset.xy);\t\t\t\t\tvec4 c2 = texture2D( maskTexture, vUv - uvOffset.xy);\t\t\t\t\tvec4 c3 = texture2D( maskTexture, vUv + uvOffset.yw);\t\t\t\t\tvec4 c4 = texture2D( maskTexture, vUv - uvOffset.yw);\t\t\t\t\tfloat diff1 = (c1.r - c2.r)*0.5;\t\t\t\t\tfloat diff2 = (c3.r - c4.r)*0.5;\t\t\t\t\tfloat d = length( vec2(diff1, diff2) );\t\t\t\t\tfloat a1 = min(c1.g, c2.g);\t\t\t\t\tfloat a2 = min(c3.g, c4.g);\t\t\t\t\tfloat visibilityFactor = min(a1, a2);\t\t\t\t\tvec3 edgeColor = 1.0 - visibilityFactor > 0.001 ? visibleEdgeColor : hiddenEdgeColor;\t\t\t\t\tgl_FragColor = vec4(edgeColor, 1.0) * vec4(d);\t\t\t\t}"})},getSeperableBlurMaterial:function(e){return new TONG.ShaderMaterial({defines:{MAX_RADIUS:e},uniforms:{colorTexture:{value:null},texSize:{value:new TONG.Vector2(.5,.5)},direction:{value:new TONG.Vector2(.5,.5)},kernelRadius:{value:1}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"#include <common>\t\t\t\tvarying vec2 vUv;\t\t\t\tuniform sampler2D colorTexture;\t\t\t\tuniform vec2 texSize;\t\t\t\tuniform vec2 direction;\t\t\t\tuniform float kernelRadius;\t\t\t\t\t\t\t\tfloat gaussianPdf(in float x, in float sigma) {\t\t\t\t\treturn 0.39894 * exp( -0.5 * x * x/( sigma * sigma))/sigma;\t\t\t\t}\t\t\t\tvoid main() {\t\t\t\t\tvec2 invSize = 1.0 / texSize;\t\t\t\t\tfloat weightSum = gaussianPdf(0.0, kernelRadius);\t\t\t\t\tvec3 diffuseSum = texture2D( colorTexture, vUv).rgb * weightSum;\t\t\t\t\tvec2 delta = direction * invSize * kernelRadius/float(MAX_RADIUS);\t\t\t\t\tvec2 uvOffset = delta;\t\t\t\t\tfor( int i = 1; i <= MAX_RADIUS; i ++ ) {\t\t\t\t\t\tfloat w = gaussianPdf(uvOffset.x, kernelRadius);\t\t\t\t\t\tvec3 sample1 = texture2D( colorTexture, vUv + uvOffset).rgb;\t\t\t\t\t\tvec3 sample2 = texture2D( colorTexture, vUv - uvOffset).rgb;\t\t\t\t\t\tdiffuseSum += ((sample1 + sample2) * w);\t\t\t\t\t\tweightSum += (2.0 * w);\t\t\t\t\t\tuvOffset += delta;\t\t\t\t\t}\t\t\t\t\tgl_FragColor = vec4(diffuseSum/weightSum, 1.0);\t\t\t\t}"})},getOverlayMaterial:function(){return new TONG.ShaderMaterial({uniforms:{maskTexture:{value:null},edgeTexture1:{value:null},edgeTexture2:{value:null},patternTexture:{value:null},edgeStrength:{value:1},edgeGlow:{value:1},usePatternTexture:{value:0}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"varying vec2 vUv;\t\t\t\tuniform sampler2D maskTexture;\t\t\t\tuniform sampler2D edgeTexture1;\t\t\t\tuniform sampler2D edgeTexture2;\t\t\t\tuniform sampler2D patternTexture;\t\t\t\tuniform float edgeStrength;\t\t\t\tuniform float edgeGlow;\t\t\t\tuniform bool usePatternTexture;\t\t\t\t\t\t\t\tvoid main() {\t\t\t\t\tvec4 edgeValue1 = texture2D(edgeTexture1, vUv);\t\t\t\t\tvec4 edgeValue2 = texture2D(edgeTexture2, vUv);\t\t\t\t\tvec4 maskColor = texture2D(maskTexture, vUv);\t\t\t\t\tvec4 patternColor = texture2D(patternTexture, 6.0 * vUv);\t\t\t\t\tfloat visibilityFactor = 1.0 - maskColor.g > 0.0 ? 1.0 : 0.5;\t\t\t\t\tvec4 edgeValue = edgeValue1 + edgeValue2 * edgeGlow;\t\t\t\t\tvec4 finalColor = edgeStrength * maskColor.r * edgeValue;\t\t\t\t\tif(usePatternTexture)\t\t\t\t\t\tfinalColor += + visibilityFactor * (1.0 - maskColor.r) * (1.0 - patternColor.r);\t\t\t\t\tgl_FragColor = finalColor;\t\t\t\t}",blending:TONG.AdditiveBlending,depthTest:!1,depthWrite:!1,transparent:!0})}}),TONG.OutlinePass.BlurDirectionX=new TONG.Vector2(1,0),TONG.OutlinePass.BlurDirectionY=new TONG.Vector2(0,1),TONG.CopyShader={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","gl_FragColor = opacity * texel;","}"].join("\n")},TONG.FXAAShader={uniforms:{tDiffuse:{value:null},resolution:{value:new TONG.Vector2(1/1024,1/512)}},vertexShader:["void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec2 resolution;","#define FXAA_REDUCE_MIN   (1.0/128.0)","#define FXAA_REDUCE_MUL   (1.0/8.0)","#define FXAA_SPAN_MAX     8.0","void main() {","vec3 rgbNW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbNE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( 1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbSW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0, 1.0 ) ) * resolution ).xyz;","vec3 rgbSE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( 1.0, 1.0 ) ) * resolution ).xyz;","vec4 rgbaM  = texture2D( tDiffuse,  gl_FragCoord.xy  * resolution );","vec3 rgbM  = rgbaM.xyz;","vec3 luma = vec3( 0.299, 0.587, 0.114 );","float lumaNW = dot( rgbNW, luma );","float lumaNE = dot( rgbNE, luma );","float lumaSW = dot( rgbSW, luma );","float lumaSE = dot( rgbSE, luma );","float lumaM  = dot( rgbM,  luma );","float lumaMin = min( lumaM, min( min( lumaNW, lumaNE ), min( lumaSW, lumaSE ) ) );","float lumaMax = max( lumaM, max( max( lumaNW, lumaNE) , max( lumaSW, lumaSE ) ) );","vec2 dir;","dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));","dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));","float dirReduce = max( ( lumaNW + lumaNE + lumaSW + lumaSE ) * ( 0.25 * FXAA_REDUCE_MUL ), FXAA_REDUCE_MIN );","float rcpDirMin = 1.0 / ( min( abs( dir.x ), abs( dir.y ) ) + dirReduce );","dir = min( vec2( FXAA_SPAN_MAX,  FXAA_SPAN_MAX),","max( vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),","dir * rcpDirMin)) * resolution;","vec4 rgbA = (1.0/2.0) * (","texture2D(tDiffuse,  gl_FragCoord.xy  * resolution + dir * (1.0/3.0 - 0.5)) +","texture2D(tDiffuse,  gl_FragCoord.xy  * resolution + dir * (2.0/3.0 - 0.5)));","vec4 rgbB = rgbA * (1.0/2.0) + (1.0/4.0) * (","texture2D(tDiffuse,  gl_FragCoord.xy  * resolution + dir * (0.0/3.0 - 0.5)) +","texture2D(tDiffuse,  gl_FragCoord.xy  * resolution + dir * (3.0/3.0 - 0.5)));","float lumaB = dot(rgbB, vec4(luma, 0.0));","if ( ( lumaB < lumaMin ) || ( lumaB > lumaMax ) ) {","gl_FragColor = rgbA;","} else {","gl_FragColor = rgbB;","}","}"].join("\n")},EventManager.prototype.add=function(e,t,i){this.events.push([e,t,i,!1])},EventManager.prototype.clear=function(){this.destroy(),this.events=[]},EventManager.prototype.create=function(){for(var e=0;e<this.events.length;e++){var t=this.events[e];t[0].addEventListener(t[1],t[2]),t[3]=!0}},EventManager.prototype.destroy=function(){for(var e=0;e<this.events.length;e++){var t=this.events[e];t[0].removeEventListener(t[1],t[2]),t[3]=!1}},Gamepad.prototype.setGamepad=function(e){if(null!=e){this.index=e.index,this.gamepad=e,this.buttons=[];for(var t=0;t<e.buttons.length;t++)this.buttons.push(new Key);this.setProductVendor(e),this.connected=!0}else console.warn("nunuStudio: No gamepad found"),this.disconnect()},Gamepad.prototype.disconnect=function(){this.vendor=-1,this.product=-1,this.connected=!1,this.gamepad=null,this.buttons=[]},Gamepad.prototype.setProductVendor=function(e){try{var t=e.id.split(":");return this.vendor=t[1].split(" ")[1],void(this.product=t[2].replace(" ","").replace(")",""))}catch(e){}try{t=e.id.split("-");return this.vendor=t[0],void(this.product=t[1])}catch(e){}},Gamepad.prototype.update=function(e){if(this.gamepad=navigator.getGamepads()[this.index],void 0!==this.gamepad)for(var t=0;t<this.buttons.length;t++)this.buttons[t].update(this.gamepad.buttons[t].pressed?Key.DOWN:Key.UP)},Gamepad.prototype.getAnalogueButton=function(e){return e>this.buttons.length||e<0?0:this.gamepad.buttons[e].value},Gamepad.prototype.getAxis=function(e){return e>this.gamepad.axes.length||e<0?0:this.gamepad.axes[e]},Gamepad.prototype.buttonExists=function(e){return 0<=e&&e<this.buttons.length},Gamepad.prototype.buttonPressed=function(e){return!!this.buttons[e]&&this.buttons[e].pressed},Gamepad.prototype.buttonJustPressed=function(e){return!!this.buttons[e]&&this.buttons[e].justPressed},Gamepad.prototype.buttonJustReleased=function(e){return!!this.buttons[e]&&this.buttons[e].justReleased},Gamepad.LEFT=14,Gamepad.RIGHT=15,Gamepad.DOWN=13,Gamepad.UP=12,Gamepad.SELECT=8,Gamepad.START=9,Gamepad.HOME=16,Gamepad.LEFT_TRIGGER_A=4,Gamepad.LEFT_TRIGGER_B=6,Gamepad.RIGHT_TRIGGER_A=5,Gamepad.RIGHT_TRIGGER_B=7,Gamepad.L1=4,Gamepad.L2=6,Gamepad.L3=6,Gamepad.R1=5,Gamepad.R2=7,Gamepad.R3=11,Gamepad.A=0,Gamepad.B=1,Gamepad.C=2,Gamepad.D=3,Gamepad.X=2,Gamepad.Y=3,Gamepad.LEFT_ANALOGUE_BUT=10,Gamepad.LEFT_ANALOGUE_HOR=0,Gamepad.LEFT_ANALOGUE_VERT=1,Gamepad.RIGHT_ANALOGUE_BUT=11,Gamepad.RIGHT_ANALOGUE_HOR=2,Gamepad.RIGHT_ANALOGUE_VERT=3,Gyroscope.prototype.setObjectQuaternion=function(){var t=new TONG.Euler,i=new TONG.Quaternion,r=new TONG.Vector3(0,0,1),o=new TONG.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5));return function(e){t.set(this.beta,this.alpha,-this.gamma,"YXZ"),e.quaternion.setFromEuler(t),e.quaternion.multiply(o),e.quaternion.multiply(i.setFromAxisAngle(r,-this.orientation))}}(),Gyroscope.prototype.dispose=function(){this.events.destroy()},Key.DOWN=-1,Key.UP=1,Key.RESET=0,Key.prototype.constructor=Key,Key.prototype.update=function(e){this.justPressed=!1,this.justReleased=!1,e===Key.DOWN?(!1===this.pressed&&(this.justPressed=!0),this.pressed=!0):e===Key.UP?(this.pressed&&(this.justReleased=!0),this.pressed=!1):e===Key.RESET&&(this.justReleased=!1,this.justPressed=!1)},Key.prototype.set=function(e,t,i){this.justPressed=e,this.pressed=t,this.justReleased=i},Key.prototype.reset=function(){this.justPressed=!1,this.pressed=!1,this.justReleased=!1},Keyboard.prototype=Keyboard,Keyboard.prototype.constructor=Keyboard,Keyboard.update=function(){for(var e=0;this.actions.length>e;){var t=this.actions.shift(),i=this.actions.shift();this.keys[t].update(i),(this.keys[t].justReleased||this.keys[t].justPressed)&&(this.actions.push(t),this.actions.push(Key.RESET),e+=2)}},Keyboard.reset=function(){for(var e=0;e<this.keys.length;e++)this.keys[e].reset()},Keyboard.keyPressed=function(e){return this.keys[e].pressed},Keyboard.keyJustPressed=function(e){return this.keys[e].justPressed},Keyboard.keyJustReleased=function(e){return this.keys[e].justReleased},Keyboard.dispose=function(){this.events.destroy()},Keyboard.TAB=9,Keyboard.ENTER=13,Keyboard.SHIFT=16,Keyboard.CTRL=17,Keyboard.ALT=18,Keyboard.CAPS_LOCK=20,Keyboard.ESC=27,Keyboard.SPACEBAR=32,Keyboard.PAGE_UP=33,Keyboard.PAGE_DOWN=34,Keyboard.END=35,Keyboard.HOME=36,Keyboard.INSERT=45,Keyboard.DEL=46,Keyboard.LEFT=37,Keyboard.RIGHT=39,Keyboard.UP=38,Keyboard.DOWN=40,Keyboard.NUM0=48,Keyboard.NUM1=49,Keyboard.NUM2=50,Keyboard.NUM3=51,Keyboard.NUM4=52,Keyboard.NUM5=53,Keyboard.NUM6=54,Keyboard.NUM7=55,Keyboard.NUM8=56,Keyboard.NUM9=57,Keyboard.A=65,Keyboard.B=66,Keyboard.C=67,Keyboard.D=68,Keyboard.E=69,Keyboard.F=70,Keyboard.G=71,Keyboard.H=72,Keyboard.I=73,Keyboard.J=74,Keyboard.K=75,Keyboard.L=76,Keyboard.M=77,Keyboard.N=78,Keyboard.O=79,Keyboard.P=80,Keyboard.Q=81,Keyboard.R=82,Keyboard.S=83,Keyboard.T=84,Keyboard.U=85,Keyboard.V=86,Keyboard.W=87,Keyboard.X=88,Keyboard.Y=89,Keyboard.Z=90,Keyboard.F1=112,Keyboard.F2=113,Keyboard.F3=114,Keyboard.F4=115,Keyboard.F5=116,Keyboard.F6=117,Keyboard.F7=118,Keyboard.F8=119,Keyboard.F9=120,Keyboard.F10=121,Keyboard.F11=122,Keyboard.F12=123,Mouse.prototype=Mouse,Mouse.prototype.constructor=Mouse,Mouse.LEFT=0,Mouse.MIDDLE=1,Mouse.RIGHT=2,Mouse.setCanvas=function(e){(this.canvas=e).mouseInside=!1,e.addEventListener("mouseenter",function(){this.mouseInside=!0}),e.addEventListener("mouseleave",function(){this.mouseInside=!1})},Mouse.insideCanvas=function(){return null!==this.canvas&&this.canvas.mouseInside},Mouse.setLock=function(e){null!==this.canvas&&(e?this.canvas.requestPointerLock?this.canvas.requestPointerLock():this.canvas.mozRequestPointerLock?this.canvas.mozRequestPointerLock():this.canvas.webkitRequestPointerLock&&this.canvas.webkitRequestPointerLock():document.exitPointerLock?document.exitPointerLock():document.mozExitPointerLock?document.mozExitPointerLock():document.webkitExitPointerLock&&document.webkitExitPointerLock())},Mouse.buttonPressed=function(e){return this.keys[e].pressed},Mouse.buttonDoubleClicked=function(){return this.doubleClicked},Mouse.buttonJustPressed=function(e){return this.keys[e].justPressed},Mouse.buttonJustReleased=function(e){return this.keys[e].justReleased},Mouse.updatePosition=function(e,t,i,r){if(null!==this.canvas){var o=this.canvas.getBoundingClientRect();e-=o.left,t-=o.top}this._position.set(e,t),this._delta.x+=i,this._delta.y+=r,this._positionUpdated=!0},Mouse.updateKey=function(e,t){-1<e&&this._keys[e].update(t)},Mouse.update=function(){for(var e=0;e<this._keys.length;e++)this._keys[e].justPressed&&this.keys[e].justPressed&&(this._keys[e].justPressed=!1),this._keys[e].justReleased&&this.keys[e].justReleased&&(this._keys[e].justReleased=!1),this.keys[e].set(this._keys[e].justPressed,this._keys[e].pressed,this._keys[e].justReleased);this._wheelUpdated?(this.wheel=this._wheel,this._wheelUpdated=!1):this.wheel=0,this._doubleClicked?(this.doubleClicked=!0,this._doubleClicked=!1):this.doubleClicked=!1,this._positionUpdated?(this.delta.copy(this._delta),this.position.copy(this._position),this._delta.set(0,0),this._positionUpdated=!1):(this.delta.x=0,this.delta.y=0)},Mouse.dispose=function(){this.events.destroy()},ArraybufferUtils.fromBinaryString=function(e){for(var t=e.length,i=new ArrayBuffer(t),r=new Uint8Array(i),o=0;o<t;o++)r[o]=e.charCodeAt(o);return i},ArraybufferUtils.fromBase64=function(e){for(var t,i,r,o,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=e.length/4*3,s=new ArrayBuffer(a),l=new Uint8Array(s),c=0,h=0;c<a;c+=3)t=n.indexOf(e.charAt(h++)),i=n.indexOf(e.charAt(h++)),r=n.indexOf(e.charAt(h++)),o=n.indexOf(e.charAt(h++)),l[c]=t<<2|i>>4,64!==r&&(l[c+1]=(15&i)<<4|r>>2),64!==o&&(l[c+2]=(3&r)<<6|o);return s},ArraybufferUtils.fromBuffer=function(e){for(var t=new ArrayBuffer(e.length),i=new Uint8Array(t),r=0;r<e.length;r++)i[r]=e[r];return t},Base64Utils.encoding="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Base64Utils.isBase64=function(e){if("string"!=typeof e)return!1;if(e.startsWith("data:"))return!0;for(var t=0;t<e.length;t++)if(!Base64Utils.encoding.includes(e.charAt(t)))return!1;return!0},Base64Utils.removeHeader=function(e){return e.slice(e.search(";base64,")+8)},Base64Utils.getFileFormat=function(e){var t=e.indexOf("/")+1,i=e.indexOf(";");return e.substr(t,i-t)},Base64Utils.fromArraybuffer=function(e){for(var t,i,r,o,n,a="",s=new Uint8Array(e),l=s.byteLength%3,c=s.byteLength-l,h=0;h<c;h+=3)t=(16515072&(n=s[h]<<16|s[h+1]<<8|s[h+2]))>>18,i=(258048&n)>>12,r=(4032&n)>>6,o=63&n,a+=Base64Utils.encoding[t]+Base64Utils.encoding[i]+Base64Utils.encoding[r]+Base64Utils.encoding[o];return 1===l?(t=(252&(n=s[c]))>>2,i=(3&n)<<4,a+=Base64Utils.encoding[t]+Base64Utils.encoding[i]+"=="):2===l&&(t=(64512&(n=s[c]<<8|s[c+1]))>>10,i=(1008&n)>>4,r=(15&n)<<2,a+=Base64Utils.encoding[t]+Base64Utils.encoding[i]+Base64Utils.encoding[r]+"="),a},Base64Utils.fromBinaryString=function(e){for(var t,i,r,o="",n=e.length%3,a=e.length-n,s=0;s<a;s+=3)t=255&e.charCodeAt(s),i=e.charCodeAt(s+1),r=e.charCodeAt(s+2),o+=Base64Utils.encoding.charAt(t>>2),o+=Base64Utils.encoding.charAt((3&t)<<4|(240&i)>>4),o+=Base64Utils.encoding.charAt((15&i)<<2|(192&r)>>6),o+=Base64Utils.encoding.charAt(63&r);return 1===n?(t=255&e.charCodeAt(s),o+=Base64Utils.encoding.charAt(t>>2),o+=Base64Utils.encoding.charAt((3&t)<<4),o+="=="):2===n&&(t=255&e.charCodeAt(s),i=e.charCodeAt(s+1),o+=Base64Utils.encoding.charAt(t>>2),o+=Base64Utils.encoding.charAt((3&t)<<4|(240&i)>>4),o+=Base64Utils.encoding.charAt((15&i)<<2),o+="="),o},BufferUtils.fromArrayBuffer=function(e){for(var t=new Buffer(e.byteLength),i=new Uint8Array(e),r=0;r<t.length;r++)t[r]=i[r];return t},ByteArrayUtils.fromBase64=function(e){for(var t,i,r,o,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=e.length/4*3,s=[],l=0,c=0;l<a;l+=3)t=n.indexOf(e.charAt(c++)),i=n.indexOf(e.charAt(c++)),r=n.indexOf(e.charAt(c++)),o=n.indexOf(e.charAt(c++)),s[l]=t<<2|i>>4,64!==r&&(s[l+1]=(15&i)<<4|r>>2),64!==o&&(s[l+2]=(3&r)<<6|o);return s};try{FileSystem.fs=require("fs")}catch(e){}function ResourceSys(e,t){this.name=e,this.uuid=TONG.Math.generateUUID(),this.type=t,this.format="",this.encoding="",this.data=null}function GridHelper(e,t,i){this.size=void 0!==e?e:100,this.spacing=void 0!==t?t:1,TONG.LineSegments.call(this,new TONG.BufferGeometry,new TONG.LineBasicMaterial({color:void 0!==i?i:8947848,depthWrite:!1,transparent:!0,opacity:.5})),this.update()}function OrientationCube(){this.size=new TONG.Vector2(75,75),this.camera=new TONG.PerspectiveCamera(60,1,.1,10),this.camera.position.z=2,this.raycaster=new TONG.Raycaster,this.normalized=new TONG.Vector2(0,0),this.scene=new TONG.Scene,this.scene.matrixAutoUpdate=!1,this.selected=null;var e,t=new TONG.PlaneBufferGeometry(1,1);(e=(new TONG.TextureLoader).load("./imgs/camera/xPos.png")).format=TONG.RGBFormat,this.xPos=new TONG.Mesh(t,new TONG.MeshBasicMaterial({map:e})),this.xPos.code=OrientationCube.X_POS,this.xPos.position.set(.5,0,0),this.xPos.rotation.set(0,Math.PI/2,0),this.xPos.matrixAutoUpdate=!1,this.xPos.updateMatrix(),this.scene.add(this.xPos),(e=(new TONG.TextureLoader).load("./imgs/camera/xNeg.png")).format=TONG.RGBFormat,this.xNeg=new TONG.Mesh(t,new TONG.MeshBasicMaterial({map:e})),this.xNeg.code=OrientationCube.X_NEG,this.xNeg.position.set(-.5,0,0),this.xNeg.rotation.set(0,-Math.PI/2,0),this.xNeg.matrixAutoUpdate=!1,this.xNeg.updateMatrix(),this.scene.add(this.xNeg),(e=(new TONG.TextureLoader).load("./imgs/camera/yPos.png")).format=TONG.RGBFormat,this.yPos=new TONG.Mesh(t,new TONG.MeshBasicMaterial({map:e})),this.yPos.code=OrientationCube.Y_POS,this.yPos.position.set(0,.5,0),this.yPos.rotation.set(-Math.PI/2,0,0),this.yPos.matrixAutoUpdate=!1,this.yPos.updateMatrix(),this.scene.add(this.yPos),(e=(new TONG.TextureLoader).load("./imgs/camera/yNeg.png")).format=TONG.RGBFormat,this.yNeg=new TONG.Mesh(t,new TONG.MeshBasicMaterial({map:e})),this.yNeg.code=OrientationCube.Y_NEG,this.yNeg.position.set(0,-.5,0),this.yNeg.rotation.set(Math.PI/2,0,0),this.yNeg.matrixAutoUpdate=!1,this.yNeg.updateMatrix(),this.scene.add(this.yNeg),(e=(new TONG.TextureLoader).load("./imgs/camera/zPos.png")).format=TONG.RGBFormat,this.zPos=new TONG.Mesh(t,new TONG.MeshBasicMaterial({map:e})),this.zPos.code=OrientationCube.Z_POS,this.zPos.position.set(0,0,.5),this.zPos.matrixAutoUpdate=!1,this.zPos.updateMatrix(),this.scene.add(this.zPos),(e=(new TONG.TextureLoader).load("./imgs/camera/zNeg.png")).format=TONG.RGBFormat,this.zNeg=new TONG.Mesh(t,new TONG.MeshBasicMaterial({map:e})),this.zNeg.code=OrientationCube.Z_NEG,this.zNeg.position.set(0,0,-.5),this.zNeg.rotation.set(0,Math.PI,0),this.zNeg.matrixAutoUpdate=!1,this.zNeg.updateMatrix(),this.scene.add(this.zNeg)}function Video(e,t){ResourceSys.call(this,"video","Video"),void 0!==e&&(e instanceof window.ArrayBuffer?this.loadArrayBufferData(e,t):Base64Utils.isBase64(e)?(this.encoding=Base64Utils.getFileFormat(e),this.format="base64",this.data=e):this.loadArrayBufferData(FileSystem.readFileArrayBuffer(e),FileSystem.getFileExtension(e)))}function Audio(e,t){ResourceSys.call(this,"audio","Audio"),this.isReady=!0,void 0!==e&&(e instanceof window.ArrayBuffer?(this.data=e,this.encoding=void 0!==t?t:""):Base64Utils.isBase64(e)?(this.encoding=void 0!==t?t:"",this.data=ArraybufferUtils.fromBase64(e)):(this.isReady=!1,this.data=FileSystem.readFileArrayBuffer(e,!0,this.onLoadAudio),this.encoding=FileSystem.getFileExtension(e)),this.format="arraybuffer"),this.onEndCallback=null,this.onLoadCallback=null,this.filters=[],this.listener=new TONG.AudioListener,this.context=this.listener.context,this.gain=this.context.createGain(),this.gain.connect(this.listener.getInput()),this.startTime=0,this.playbackRate=1,this.loop=!0,this.volume=1,this.autoplay=!0}function VideoTexture(t,e,i,r,o,n){"string"==typeof t?this.video=new Video(t):t instanceof Video&&(this.video=t),TONG.Texture.call(this,document.createElement("video"),e,i,r,TONG.LinearFilter,TONG.LinearFilter,TONG.RGBFormat,o,n),this.disposed=!1,this.generateMipmaps=!1,this.name="video",this.category="Video",this.autoplay=!0,this.loop=!0,this.playbackRate=1,this.volume=1,this.image.src=this.video.data,this.image.autoplay=this.autoplay,this.image.playbackRate=this.playbackRate,this.image.loop=this.loop,this.image.volume=this.volume;var a=this;t=this.image;!function e(){a.disposed||(t.readyState>=t.HAVE_CURRENT_DATA&&(a.needsUpdate=!0),requestAnimationFrame(e))}(),this.autoplay&&this.image.play()}function WebcamTexture(e,t,i,r,o){var n=document.createElement("video");n.autoplay=!0,n.loop=!0,TONG.VideoTexture.call(this,n,e,t,i,TONG.LinearFilter,TONG.LinearFilter,TONG.RGBFormat,r,o),this.generateMipmaps=!1,this.disposed=!1,this.name="webcam",this.category="Webcam",this.mode=WebcamTexture.USER,this.stream=null,this.connect();var a=this;requestAnimationFrame(function e(){n.readyState>=n.HAVE_CURRENT_DATA&&(a.needsUpdate=!0),a.disposed||requestAnimationFrame(e)})}function Font(e){ResourceSys.call(this,"font","Font"),this.reversed=!1,this.font=null,void 0!==e&&(e instanceof window.ArrayBuffer?(this.data=e,this.format="arraybuffer",this.loadTTF()):"object"==typeof e?(this.data=e,this.font=e,this.format="json",this.encoding="json"):(this.encoding=FileSystem.getFileExtension(e),this.name=FileSystem.getFileName(e),"json"===this.encoding?(this.data=JSON.parse(FileSystem.readFile(e)),this.format="json",this.font=this.data):"ttf"!==this.encoding&&"otf"!==this.encoding&&"ttc"!==this.encoding&&"otc"!==this.encoding||(this.data=FileSystem.readFileArrayBuffer(e),this.format="arraybuffer",this.loadTTF())))}FileSystem.readFile=function(e,t,i,r){if(void 0===t&&(t=!0),void 0!==FileSystem.fs&&FileSystem.fs.existsSync(n)){if(t){var o=FileSystem.fs.readFileSync(e,"utf8");return void 0!==i&&i(o),o}return FileSystem.fs.readFile(e,"utf8",function(e,t){void 0!==i&&i(t)}),null}var n=new XMLHttpRequest;return n.overrideMimeType("text/plain"),n.open("GET",e,!t),n.onload=function(){200!==n.status&&0!==n.status||void 0===i||i(n.response)},void 0!==r&&(n.onprogress=function(e){r(e)}),n.send(null),n.response},FileSystem.readFileArrayBuffer=function(e,t,a,i){if(void 0===t&&(t=!0),void 0!==FileSystem.fs){if(t){for(var r=FileSystem.fs.readFileSync(e),o=r.length,n=new ArrayBuffer(o),s=new Uint8Array(n),l=0;l<o;l++)s[l]=r[l];return n}return FileSystem.fs.readFile(e,function(e,t){if(void 0!==a){for(var i=t.length,r=new ArrayBuffer(i),o=new Uint8Array(r),n=0;n<i;n++)o[n]=t[n];a(r)}}),null}var c=new XMLHttpRequest;return c.open("GET",e,!t),c.overrideMimeType("text/plain; charset=x-user-defined"),c.onload=function(){200!==c.status&&0!==c.status||void 0===a||a(ArraybufferUtils.fromBinaryString(c.response))},void 0!==i&&(c.onprogress=function(e){i(e)}),c.send(null),ArraybufferUtils.fromBinaryString(c.response)},FileSystem.readFileBase64=function(e,t,i,r){if(void 0===t&&(t=!0),void 0!==FileSystem.fs){if(t){var o=FileSystem.fs.readFileSync(e);return new Buffer(o).toString("base64")}return FileSystem.fs.readFile(e,function(e,t){void 0!==i&&i(new Buffer(t).toString("base64"))}),null}var n=new XMLHttpRequest;return n.open("GET",e,!t),n.overrideMimeType("text/plain; charset=x-user-defined"),n.onload=function(){200!==n.status&&0!==n.status||void 0===i||i(Base64Utils.fromBinaryString(n.response))},void 0!==r&&(n.onprogress=function(e){r(e)}),n.send(null),Base64Utils.fromBinaryString(n.response)},FileSystem.writeFile=function(e,t){if(void 0!==FileSystem.fs){var i=FileSystem.fs.createWriteStream(e,"utf8");i.write(t),i.end()}else{var r=new Blob([t],{type:"octet/stream"}),o=document.createElement("a");o.download=e,o.href=window.URL.createObjectURL(r),o.style.display="none",o.onclick=function(){document.body.removeChild(this)},document.body.appendChild(o),o.click()}},FileSystem.writeFileBase64=function(e,t){if(void 0!==FileSystem.fs){var i=Buffer.from(Base64Utils.removeHeader(t),"base64"),r=FileSystem.fs.createWriteStream(e);r.write(i),r.end()}else{var o=ArraybufferUtils.fromBase64(Base64Utils.removeHeader(t)),n=new Blob([o]),a=document.createElement("a");a.download=e,a.href=window.URL.createObjectURL(n),a.onclick=function(){document.body.removeChild(this)},a.style.display="none",document.body.appendChild(a),a.click()}},FileSystem.writeFileArrayBuffer=function(e,t){if(void 0!==FileSystem.fs){var i=BufferUtils.fromArrayBuffer(t),r=FileSystem.fs.createWriteStream(e);r.write(i),r.end()}else{var o=new Blob([t]),n=document.createElement("a");n.download=e,n.href=window.URL.createObjectURL(o),n.onclick=function(){document.body.removeChild(this)},n.style.display="none",document.body.appendChild(n),n.click()}},FileSystem.chooseFile=function(t,e,i){var r=document.createElement("input");r.type="file",r.style.display="none",document.body.appendChild(r),void 0!==e&&(r.accept=e),r.onchange=function(e){void 0!==t&&t(r.files),document.body.removeChild(r)},void 0!==i&&(r.nwsaveas=!0!==i?i:"file"),r.click()},FileSystem.chooseFileName=function(e,t,i){var r=prompt("Save As",void 0!==i?i:"file");null!==r&&(void 0===t||r.endsWith(t)||(r+=t),void 0!==e&&e(r))},FileSystem.copyFile=function(e,t){void 0!==FileSystem.fs&&(e.replace(new RegExp("/","g"),"\\"),t.replace(new RegExp("/","g"),"\\"),FileSystem.fs.createReadStream(e).pipe(FileSystem.fs.createWriteStream(t)))},FileSystem.makeDirectory=function(e){void 0!==FileSystem.fs&&(e.replace(new RegExp("/","g"),"\\"),FileSystem.fs.mkdirSync(e))},FileSystem.getFilesDirectory=function(e){if(void 0!==FileSystem.fs)try{return e.replace(new RegExp("/","g"),"\\"),FileSystem.fs.readdirSync(e)}catch(e){return[]}return[]},FileSystem.deleteFolder=function(r){void 0!==FileSystem.fs&&FileSystem.fs.existsSync(r)&&(FileSystem.fs.readdirSync(r).forEach(function(e,t){var i=r+"/"+e;FileSystem.fs.lstatSync(i).isDirectory()?FileSystem.deleteFolder(i):FileSystem.fs.unlinkSync(i)}),FileSystem.fs.rmdirSync(r))},FileSystem.copyFolder=function(e,t){if(void 0!==FileSystem.fs){e.replace(new RegExp("/","g"),"\\"),t.replace(new RegExp("/","g"),"\\"),FileSystem.makeDirectory(t);for(var i=FileSystem.fs.readdirSync(e),r=0;r<i.length;r++){var o=e+"\\"+i[r],n=t+"\\"+i[r],a=FileSystem.fs.statSync(o);a.isDirectory()?FileSystem.copyFolder(o,n):a.isSymbolicLink()?FileSystem.fs.symlinkSync(FileSystem.fs.readlinkSync(o),n):FileSystem.copyFile(o,n)}}},FileSystem.fileExists=function(e){return void 0!==FileSystem.fs&&(e.replace(new RegExp("/","g"),"\\"),FileSystem.fs.existsSync(e))},FileSystem.getFileName=function(e){if(void 0!==e){var t=e.lastIndexOf("\\"),i=e.lastIndexOf("/");return e.substring(i<t?t+1:i+1,e.lastIndexOf("."))}return""},FileSystem.getFileNameWithExtension=function(e){if(void 0!==e){var t=e.lastIndexOf("\\"),i=e.lastIndexOf("/");return e.substring(i<t?t+1:i+1,e.length)}return""},FileSystem.getNameWithoutExtension=function(e){return void 0!==e?e.substring(0,e.lastIndexOf(".")):""},FileSystem.getFilePath=function(e){if(void 0!==e){var t=e.lastIndexOf("\\"),i=e.lastIndexOf("/");return e.substring(0,i<t?t+1:i+1)}return""},FileSystem.getFileExtension=function(e){return void 0!==e?e.substring(e.lastIndexOf(".")+1,e.length).toLowerCase():""},ResourceSys.prototype.export=function(e){"base64"===this.format?FileSystem.writeFileBase64(e,this.data):"arraybuffer"===this.format?FileSystem.writeFileArrayBuffer(e,void 0!==this.arraybuffer?this.arraybuffer:this.data):"string"===this.format?FileSystem.writeFile(e,this.data):"json"===this.format?FileSystem.writeFile(e,JSON.stringify(this.data)):"url"===this.format&&FileSystem.writeFileArrayBuffer(e,FileSystem.readFileArrayBuffer(this.data))},ResourceSys.prototype.toJSON=function(e){var t={};return t.name=this.name,t.uuid=this.uuid,t.type=this.type,t},GridHelper.prototype=Object.create(TONG.LineSegments.prototype),GridHelper.prototype.setSize=function(e){this.size=e},GridHelper.prototype.setSpacing=function(e){this.spacing=e},GridHelper.prototype.update=function(){var e=this.geometry;e.removeAttribute("position");for(var t=2*Math.round(this.size/this.spacing),i=2*this.size/t,r=[],o=0,n=-this.size;o<=t;o++,n+=i)r.push(-this.size,0,n,this.size,0,n),r.push(n,0,-this.size,n,0,this.size);e.addAttribute("position",new TONG.Float32BufferAttribute(r,3))},OrientationCube.X_POS=0,OrientationCube.X_NEG=1,OrientationCube.Y_POS=2,OrientationCube.Y_NEG=3,OrientationCube.Z_POS=4,OrientationCube.Z_NEG=5,OrientationCube.prototype.raycast=function(e,t){var i=t.width-this.size.x;if(e.position.x>i&&0<e.position.y&&e.position.x<t.width&&e.position.y<this.size.y){this.normalized.set((e.position.x-i)/this.size.x*2-1,-(e.position.y/this.size.y*2-1)),this.raycaster.setFromCamera(this.normalized,this.camera);var r=this.raycaster.intersectObjects(this.scene.children,!0);if(0<r.length)return this.selected=r[0].object,this.selected.material.color.set(16776960),r[0].object.code}return null},OrientationCube.prototype.updateRotation=function(e){this.scene.quaternion.copy(e.quaternion),this.scene.updateMatrix(),this.scene.matrix.getInverse(this.scene.matrix,!1)},OrientationCube.prototype.render=function(e,t){var i=t.width-this.size.x;e.setScissorTest(!0),e.setViewport(i,0,this.size.x,this.size.y),e.setScissor(i,0,this.size.x,this.size.y),e.render(this.scene,this.camera),null!==this.selected&&(this.selected.material.color.set(16777215),this.selected=null),e.setScissorTest(!1),e.setViewport(0,0,t.width,t.height),e.setScissor(0,0,t.width,t.height)},Video.prototype=Object.create(ResourceSys.prototype),Video.fileIsVideo=function(e){return!(void 0===e||!e.type.startsWith("video"))},Video.prototype.setBuffer=function(){var e=new Uint8Array(data);new Blob([e],{type:"video/"+encoding})},Video.prototype.loadArrayBufferData=function(e,t){var i=new Uint8Array(e),r=new Blob([i],{type:"video/"+t});this.data=URL.createObjectURL(r),this.arraybuffer=e,this.encoding=t,this.format="arraybuffer"},Video.prototype.toJSON=function(e){if(void 0!==e.videos[this.uuid])return e.videos[this.uuid];var t=ResourceSys.prototype.toJSON.call(this,e);return t.encoding=this.encoding,"arraybuffer"===this.format?(t.format=this.format,t.data=this.arraybuffer):"base64"===this.format?(t.format="arraybuffer",t.data=ArraybufferUtils.fromBase64(Base64Utils.removeHeader(this.data))):(t.format=this.format,t.data=this.data),e.videos[this.uuid]=t},Audio.prototype=Object.create(ResourceSys.prototype),ExtendClass(Audio,TONG.Audio),Audio.prototype.onLoadAudio=function(e){this.isReady=!0,this.onLoadCallback&&this.onLoadCallback(e),this.data=e,this.autoplay&&this.play()},Audio.prototype.setAutoPlay=function(e){this.autoplay=e},Audio.prototype.setStartTime=function(e){this.startTime=e},Audio.prototype.play=function(){if(this.isReady&&!this.isPlaying){this.disposed=!1;var t=this;this.getAudioBuffer(this.context,function(e){t.setBuffer(e)})}},Audio.prototype.setBuffer=function(e){if(this.buffer=e,this.sourceType="buffer",!this.disposed){if(null===this.buffer)return void console.warn("TONG ENGINE: Audio buffer not ready, audio will not play.");this.isPlaying&&console.warn("TONG ENGINE: Audio is already playing, its only possible to control the last playing instance.");var t=this.context.createBufferSource();return t.buffer=this.buffer,t.loop=this.loop,t.onended=this.onEndCallback?this.onEndCallback.bind(this):null,t.playbackRate.setValueAtTime(this.playbackRate,this.startTime),t.start(0,this.startTime),this.isPlaying=!0,this.source=t,this.connect()}return null},Audio.prototype.pause=function(){if(this.source&&this.isPlaying)return this.source.stop(),this.startTime=this.context.currentTime,this.isPlaying=!1,this},Audio.prototype.getCurrentTime=function(){return this.context.currentTime},Audio.prototype.resume=function(){if(this.source&&!this.isPlaying)return this.source.start(this.startTime),this.isPlaying=!0,this},Audio.prototype.stop=function(){if(this.source&&this.isPlaying)return this.source.stop(),this.startTime=0,this.isPlaying=!1,this},Audio.prototype.dispose=function(){this.isPlaying&&(this.stop(),this.disconnect(),this.source=null,this.startTime=0,this.isPlaying=!1),this.disposed=!0},Audio.prototype.getVolume=function(){return this.gain.gain.value},Audio.prototype.setVolume=function(e){return this.volume=e,this.gain.gain.value=e,this},Audio.prototype.setLoop=function(e){return this.loop=e,this.source&&this.isPlaying&&(this.source.loop=this.loop),this},Audio.prototype.getLoop=function(){return this.loop},Audio.prototype.setPlaybackRate=function(e){return this.playbackRate=e,this.source&&this.isPlaying&&this.source.playbackRate.setValueAtTime(this.playbackRate,this.context.currentTime),this},Audio.prototype.getPlaybackRate=function(){return this.playbackRate},Audio.prototype.getFilters=function(){return this.filters},Audio.prototype.setFilters=function(e){return e||(e=[]),this.isPlaying?(this.disconnect(),this.filters=e,this.connect()):this.filters=e,this},Audio.prototype.getFilter=function(e){return this.getFilters()[void 0!==e?e:0]},Audio.prototype.setFilter=function(e){return this.setFilters(e?[e]:[])},Audio.prototype.setNodeSource=function(e){return this.hasPlaybackControl=!1,this.sourceType="audioNode",this.source=e,this.connect(),this},Audio.prototype.getOutput=function(){return this.gain},Audio.fileIsAudio=function(e){return!(void 0===e||!e.type.startsWith("audio"))},Audio.prototype.getAudioBuffer=function(e,t){e.decodeAudioData(this.data.slice(0),t,function(e){console.error("TONG ENGINE: Cannot decode audio buffer ("+e+")")})},Audio.prototype.toJSON=function(e){if(void 0!==e.audio[this.uuid])return e.audio[this.uuid];var t=ResourceSys.prototype.toJSON.call(this,e);return t.encoding=this.encoding,t.data=this.data,t.format=this.format,e.audio[this.uuid]=t},VideoTexture.prototype=Object.create(TONG.Texture.prototype),VideoTexture.prototype.setTime=function(e){this.image.currentTime=e},VideoTexture.prototype.setLoop=function(e){this.loop=e,this.image.loop=e},VideoTexture.prototype.setVolume=function(e){this.volume=0<=e&&e<=1?e:0<=e?1:0,this.image.volume=this.volume},VideoTexture.prototype.setAutoPlay=function(e){this.autoplay=e,this.image.autoplay=this.autoplay},VideoTexture.prototype.setPlaybackRate=function(e){this.playbackRate=e,this.image.playbackRate=e},VideoTexture.prototype.pause=function(){this.image.paused||this.image.pause()},VideoTexture.prototype.play=function(){this.image.paused&&this.image.play()},VideoTexture.prototype.dispose=function(){TONG.Texture.prototype.dispose.call(this),this.disposed=!0,this.image.pause(),this.image.src="",this.image.load()},VideoTexture.prototype.toJSON=function(e){var t=TONG.Texture.prototype.toJSON.call(this,e),i=this.video.toJSON(e);return t.video=i.uuid,t.loop=this.loop,t.autoplay=this.autoplay,t.playbackRate=this.playbackRate,t.volume=this.volume,t},WebcamTexture.USER=21,WebcamTexture.ENVIRONMENT=22,WebcamTexture.prototype=Object.create(TONG.VideoTexture.prototype),WebcamTexture.prototype.connect=function(){var e=this.mode===WebcamTexture.USER?{facingMode:"user"}:{facingMode:{exact:"environment"}},t=this;void 0!==navigator.webkitGetUserMedia&&(navigator.getUserMedia=navigator.webkitGetUserMedia),navigator.getUserMedia?navigator.getUserMedia({video:!0},function(e){t.stream=e,t.image.src=URL.createObjectURL(e)},function(e){console.warn("nunuStudio: No webcam available")}):navigator.mediaDevices.getUserMedia&&navigator.mediaDevices.getUserMedia({video:e}).then(function(e){t.stream=e,t.image.src=URL.createObjectURL(e)}).catch(function(e){console.warn("nunuStudio: No webcam available")})},WebcamTexture.prototype.disconnect=function(){if(null!==this.stream)for(var e=this.stream.getTracks(),t=0;t<e.length;t++)e[t].stop()},WebcamTexture.prototype.dispose=function(){TONG.VideoTexture.prototype.dispose.call(this),this.disconnect(),this.disposed=!0,this.image.paused||this.image.pause()},WebcamTexture.prototype.toJSON=function(e){var t=TONG.VideoTexture.prototype.toJSON.call(this,e);return t.mode=this.mode,t},Font.prototype=Object.create(ResourceSys.prototype),Font.fileIsFont=function(e){return void 0!==e&&((e=e.name.toLocaleLowerCase()).endsWith("ttf")||e.endsWith("otf")||e.endsWith("ttc")||e.endsWith("otc")||e.endsWith("font")||e.endsWith("fnt"))},Font.prototype.isFont=!0,Font.prototype.reverseGlyphs=function(){this.reversed=!this.reversed,this.loadTTF()},Font.prototype.loadTTF=function(){var e=new TONG.TTFLoader;e.reversed=this.reversed,this.font=e.parse(this.data)},Font.prototype.clone=function(){var e=new Font;return e.encoding=this.encoding,e.reversed=this.reversed,e.data=this.data,e.format=this.format,e},Font.prototype.toJSON=function(e){if(e.fonts||(e.fonts={}),void 0!==e.fonts[this.uuid])return e.fonts[this.uuid];var t=ResourceSys.prototype.toJSON.call(this,e);return t.encoding=this.encoding,t.reversed=this.reversed,"arraybuffer"===this.format?(t.data=this.data,t.format=this.format):"base64"===this.format?(t.data=ArraybufferUtils.fromBase64(this.data),t.format="arraybuffer"):(t.data=this.data,t.format=this.format),e.fonts[this.uuid]=t},Font.prototype.generateShapes=function(e,h,N){void 0===h&&(h=100),void 0===N&&(N=10);for(var A=this.font,t=function(e){for(var t=String(e).split(""),i=h/A.resolution,r=(A.boundingBox.yMax-A.boundingBox.yMin)*i,o=0,n=0,a=[],s=0;s<t.length;s++){var l=t[s];if("\n"===l)n-=r,o=0;else{var c=u(l,i,o,n);o+=c.width,a.push(c.path)}}return a}(e),i=[],r=0;r<t.length;r++)Array.prototype.push.apply(i,t[r].toShapes());return i;function u(e,t,i,r){var o=A.glyphs[e]||A.glyphs["?"];if(o){var n,a,s,l,c,h,u,d,p,m,f,v=new TONG.ShapePath,y=[],g=TONG.ShapeUtils.b2,x=TONG.ShapeUtils.b3;if(o.o)for(var w=o._cachedOutline||(o._cachedOutline=o.o.split(" ")),b=0,T=w.length;b<T;){var S=w[b++];if("m"===S&&(n=w[b++]*t+i,a=w[b++]*t+r,v.moveTo(n,a)),"l"===S)n=w[b++]*t+i,a=w[b++]*t+r,v.lineTo(n,a);else if("q"===S){if(s=w[b++]*t+i,l=w[b++]*t+r,u=w[b++]*t+i,d=w[b++]*t+r,v.quadraticCurveTo(u,d,s,l),f=y[y.length-1]){c=f.x,h=f.y;for(var C=1;C<=N;C++){g(O=C/N,c,u,s),g(O,h,d,l)}}}else if("b"===S&&(s=w[b++]*t+i,l=w[b++]*t+r,u=w[b++]*t+i,d=w[b++]*t+r,p=w[b++]*t+i,m=w[b++]*t+r,v.bezierCurveTo(u,d,p,m,s,l),f=y[y.length-1])){c=f.x,h=f.y;for(C=1;C<=N;C++){var O;x(O=C/N,c,u,p,s),x(O,h,d,m,l)}}}return{width:o.ha*t,path:v}}}},TONG.Font=Font;var FontAsset=function(){};function Text3D(e,t,i,r,o,n,a,s,l){TONG.Mesh.call(this,void 0,t),this.uuid=TONG.Math.generateUUID(),this.name="text",this.type="Text3D",this.font=void 0!==i?i:null,this.size=void 0!==s?s:1,this.height=void 0!==r?r:.5,this.curveSegments=void 0!==l?l:15,this.bevel=void 0!==o&&o,this.bevelThickness=void 0!==n?n:.1,this.bevelSize=void 0!==a?a:.05,this.setText(void 0!==e?e:"text")}TONG.FontAsset=FontAsset,Text3D.prototype=Object.create(TONG.Mesh.prototype),Text3D.prototype.setFont=function(e){this.font!==e&&(this.font=e,this.updateGeometry())},Text3D.prototype.setText=function(e){this.text!==e&&(this.text=e,this.updateGeometry())},Text3D.prototype.updateGeometry=function(){null!==this.font&&(void 0!==this.geometry&&this.geometry.dispose(),this.geometry=new TONG.TextBufferGeometry(this.text,{size:this.size,curveSegments:this.curveSegments,font:this.font,height:this.height,bevelEnabled:this.bevel,bevelSize:this.bevelSize,bevelThickness:this.bevelThickness}),this.geometry.computeVertexNormals())},Text3D.prototype.clone=function(){return new Text3D(this.text,this.material,this.font,this.height,this.bevel,this.bevelThickness,this.bevelSize,this.size,this.curveSegments)},Text3D.prototype.toJSON=function(e){var t=this.geometry;this.geometry=void 0;var i=this.font,r=TONG.Object3D.prototype.toJSON.call(this,e);return i=i.toJSON(e),r.object.text=this.text,r.object.font=i.uuid,r.object.size=this.size,r.object.curveSegments=this.curveSegments,r.object.height=this.height,r.object.bevel=this.bevel,r.object.bevelThickness=this.bevelThickness,r.object.bevelSize=this.bevelSize,this.geometry=t,r},TONG.Text3D=Text3D,function(){function n(){this.id=0,this.data=null}function s(){}s.prototype={set:function(e,t){this[e]=t},get:function(e,t){return this.hasOwnProperty(e)?this[e]:t}},TONG.AWDLoader=function(e){this.manager=void 0!==e?e:TONG.DefaultLoadingManager,this.trunk=new TONG.Object3D,this.materialFactory=void 0,this._url="",this._baseDir="",this._data=void 0,this._ptr=0,this._version=[],this._streaming=!1,this._optimized_for_accuracy=!1,this._compression=0,this._bodylen=4294967295,this._blocks=[new n],this._accuracyMatrix=!1,this._accuracyGeo=!1,this._accuracyProps=!1},TONG.AWDLoader.prototype={constructor:TONG.AWDLoader,load:function(e,t,i,r){var o=this;this._url=e,this._baseDir=e.substr(0,e.lastIndexOf("/")+1);var n=new TONG.FileLoader(this.manager);n.setResponseType("arraybuffer"),n.load(e,function(e){t(o.parse(e))},i,r)},parse:function(e){var t=e.byteLength;for(this._ptr=0,this._data=new DataView(e),this._parseHeader(),0!=this._compression&&console.error("compressed AWD not supported"),this._streaming||this._bodylen==e.byteLength-this._ptr||console.error("AWDLoader: body len does not match file length",this._bodylen,t-this._ptr);this._ptr<t;)this.parseNextBlock();return this.trunk},parseNextBlock:function(){var e,t,i=this.readU32(),r=(this.readU8(),this.readU8()),o=(this.readU8(),this.readU32());switch(r){case 1:e=this.parseMeshData(o);break;case 22:e=this.parseContainer(o);break;case 23:e=this.parseMeshInstance(o);break;case 81:e=this.parseMaterial(o);break;case 82:e=this.parseTexture(o);break;case 101:e=this.parseSkeleton(o);break;case 112:e=this.parseMeshPoseAnimation(o,!1);break;case 113:e=this.parseVertexAnimationSet(o);break;case 102:e=this.parseSkeletonPose(o);break;case 103:e=this.parseSkeletonAnimation(o);break;case 122:e=this.parseAnimatorSet(o);break;default:this._ptr+=o}this._blocks[i]=t=new n,t.data=e,t.id=i},_parseHeader:function(){var e=this._version;if(4282180!=(this.readU8()<<16|this.readU8()<<8|this.readU8()))throw new Error("AWDLoader - bad magic");e[0]=this.readU8(),e[1]=this.readU8();var t=this.readU16();this._streaming=1==(1&t),2===e[0]&&1===e[1]&&(this._accuracyMatrix=2==(2&t),this._accuracyGeo=4==(4&t),this._accuracyProps=8==(8&t)),this._geoNrType=this._accuracyGeo?8:7,this._matrixNrType=this._accuracyMatrix?8:7,this._propsNrType=this._accuracyProps?8:7,this._optimized_for_accuracy=2==(2&t),this._compression=this.readU8(),this._bodylen=this.readU32()},parseContainer:function(e){var t=new TONG.Object3D,i=this.readU32(),r=this.parseMatrix4();return t.name=this.readUTF(),t.applyMatrix(r),(this._blocks[i].data||this.trunk).add(t),this.parseProperties({1:this._matrixNrType,2:this._matrixNrType,3:this._matrixNrType,4:4}),t.extra=this.parseUserAttributes(),t},parseMeshInstance:function(e){var t,i,r,o,n,a,s,l,c,h,u,d,p;for(a=this.readU32(),l=this.parseMatrix4(),t=this.readUTF(),s=this.readU32(),d=this.readU16(),r=this.getBlock(s),c=[],p=0;p<d;p++)u=this.readU32(),h=this.getBlock(u),c.push(h);if(n=[],1<(o=r.length))for(i=new TONG.Object3D,p=0;p<o;p++){var m=new TONG.Mesh(r[p]);n.push(m),i.add(m)}else i=new TONG.Mesh(r[0]),n.push(i);i.applyMatrix(l),i.name=t,(this.getBlock(a)||this.trunk).add(i);var f=c.length,v=Math.max(o,f);for(p=0;p<v;p++)n[p%o].material=c[p%f];return this.parseProperties(null),i.extra=this.parseUserAttributes(),i},parseMaterial:function(e){var t,i,r,o,n,a;for(t=this.readUTF(),i=this.readU8(),a=this.readU8(),r=this.parseProperties({1:3,2:23,11:21,12:7,13:21}),0;0<a;){this.readU16();this.parseProperties(null),this.parseUserAttributes()}if(n=this.parseUserAttributes(),void 0!==this.materialFactory&&(o=this.materialFactory(t)))return o;if(o=new TONG.MeshPhongMaterial,1===i)o.color.setHex(r.get(1,13421772));else if(2===i){var s=r.get(2,0);o.map=this.getBlock(s)}return o.extra=n,o.alphaThreshold=r.get(12,0),o.repeat=r.get(13,!1),o},parseTexture:function(e){var t,i;this.readUTF();if(0===this.readU8()){i=this.readU32();var r=this.readUTFBytes(i);console.log(r),t=this.loadTexture(r)}return this.parseProperties(null),this.parseUserAttributes(),t},loadTexture:function(e){var t=new TONG.Texture;return new TONG.ImageLoader(this.manager).load(this._baseDir+e,function(e){t.image=e,t.needsUpdate=!0}),t},parseSkeleton:function(e){this.readUTF();var t=this.readU16(),i=[],r=0;for(this.parseProperties(null);r<t;){var o,n;this.readU16(),(o=new TONG.Bone).parent=this.readU16()-1,o.name=this.readUTF(),n=this.parseMatrix4(),o.skinMatrix=n,this.parseProperties(null),this.parseUserAttributes(),i.push(o),r++}return this.parseUserAttributes(),i},parseSkeletonPose:function(e){this.readUTF();var t=this.readU16();this.parseProperties(null);for(var i=[],r=0;r<t;){var o;o=1===this.readU8()?this.parseMatrix4():new TONG.Matrix4,i[r]=o,r++}return this.parseUserAttributes(),i},parseSkeletonAnimation:function(e){this.readUTF();var t,i,r,o=[],n=this.readU16();this.parseProperties(null);for(var a=0;a<n;)i=this.readU32(),t=this.readU16(),r=this._blocks[i].data,o.push({pose:r,duration:t}),a++;if(0!==o.length)return this.parseUserAttributes(),o},parseVertexAnimationSet:function(e){this.readUTF();for(var t,i=this.readU16(),r=(this.parseProperties({1:5}),0),o=[];r<i;)t=this.readU32(),o.push(this._blocks[t].data),r++;return this.parseUserAttributes(),o},parseAnimatorSet:function(e){this.readUTF();var t,i,r=this.readU16(),o=this.parseProperties({1:23});t=this.readU32();for(var n=this.readU16(),a=[],s=0;s<n;s++)a.push(this.readU32());this.readU16(),Boolean(this.readU8());this.parseUserAttributes(),this.parseUserAttributes();var l,c=[];for(s=0;s<a.length;s++)c.push(this._blocks[a[s]].data);for(i=this._blocks[t].data,1==r&&(l={animationSet:i,skeleton:this._blocks[o.get(1,0)].data}),s=0;s<c.length;s++)c[s].animator=l;return l},parseMeshData:function(e){var t,i,r=this.readUTF(),o=this.readU16(),n=0,a=[];for(this.parseProperties({1:this._geoNrType,2:this._geoNrType});n<o;){var s,l,c;for((t=new TONG.BufferGeometry).name=r,a.push(t),s=this.readU32(),l=this._ptr+s,this.parseProperties({1:this._geoNrType,2:this._geoNrType});this._ptr<l;){var h=0,u=this.readU8(),d=(this.readU8(),this.readU32()),p=d+this._ptr;if(1===u)for(i=new Float32Array(d/12*3),c=new TONG.BufferAttribute(i,3),t.addAttribute("position",c),h=0;this._ptr<p;)i[h]=-this.readF32(),i[h+1]=this.readF32(),i[h+2]=this.readF32(),h+=3;else if(2===u)for(i=new Uint16Array(d/2),c=new TONG.BufferAttribute(i,1),t.setIndex(c),h=0;this._ptr<p;)i[h+1]=this.readU16(),i[h]=this.readU16(),i[h+2]=this.readU16(),h+=3;else if(3===u)for(i=new Float32Array(d/8*2),c=new TONG.BufferAttribute(i,2),t.addAttribute("uv",c),h=0;this._ptr<p;)i[h]=this.readF32(),i[h+1]=1-this.readF32(),h+=2;else if(4===u)for(i=new Float32Array(d/12*3),c=new TONG.BufferAttribute(i,3),t.addAttribute("normal",c),h=0;this._ptr<p;)i[h]=-this.readF32(),i[h+1]=this.readF32(),i[h+2]=this.readF32(),h+=3;else this._ptr=p}this.parseUserAttributes(),t.computeBoundingSphere(),n++}return this.parseUserAttributes(),a},parseMeshPoseAnimation:function(e,t){var i,r,o,n,a,s,l,c,h,u=1,d=0,p={},m=[],f=(this.readUTF(),this.readU32()),v=this.getBlock(f);if(null!==v){for((s=v.geometry).morphTargets=[],t||(u=this.readU16()),i=this.readU16(),l=this.readU16(),c=0;c<l;)m.push(this.readU16()),c++;for(h=this.parseProperties({1:21,2:21}),p.looping=h.get(1,!0),p.stitchFinalFrame=h.get(2,!1),r=0;r<u;){for(this.readU16(),o=0;o<i;)for(c=0,n=this.readU32(),a=this._ptr+n;c<l;){if(1===m[c]){var y=new Float32Array(n/4);for(s.morphTargets.push({array:y}),d=0;this._ptr<a;)y[d]=this.readF32(),y[d+1]=this.readF32(),y[d+2]=this.readF32(),d+=3;o++}else this._ptr=a;c++}r++}return this.parseUserAttributes(),null}console.log("parseMeshPoseAnimation target mesh not found at:",f)},getBlock:function(e){return this._blocks[e].data},parseMatrix4:function(){var e=new TONG.Matrix4,t=e.elements;return t[0]=this.readF32(),t[1]=this.readF32(),t[2]=this.readF32(),t[3]=0,t[4]=this.readF32(),t[5]=this.readF32(),t[6]=this.readF32(),t[7]=0,t[8]=this.readF32(),t[9]=this.readF32(),t[10]=this.readF32(),t[11]=0,t[12]=-this.readF32(),t[13]=this.readF32(),t[14]=this.readF32(),t[15]=1,e},parseProperties:function(e){var t=this.readU32(),i=this._ptr+t,r=new s;if(e)for(;this._ptr<i;){var o,n=this.readU16(),a=this.readU32();e.hasOwnProperty(n)?(o=e[n],r.set(n,this.parseAttrValue(o,a))):this._ptr+=a}return r},parseUserAttributes:function(){return this._ptr=this.readU32()+this._ptr,null},parseAttrValue:function(e,t){var i,r;switch(e){case 1:i=1,r=this.readI8;break;case 2:i=2,r=this.readI16;break;case 3:i=4,r=this.readI32;break;case 21:case 4:i=1,r=this.readU8;break;case 5:i=2,r=this.readU16;break;case 6:case 23:i=4,r=this.readU32;break;case 7:i=4,r=this.readF32;break;case 8:i=8,r=this.readF64;break;case 41:case 42:case 43:case 44:case 45:case 46:case 47:i=8,r=this.readF64}if(i<t){var o,n,a;for(o=[],n=0,a=t/i;n<a;)o.push(r.call(this)),n++;return o}return r.call(this)},readU8:function(){return this._data.getUint8(this._ptr++)},readI8:function(){return this._data.getInt8(this._ptr++)},readU16:function(){var e=this._data.getUint16(this._ptr,!0);return this._ptr+=2,e},readI16:function(){var e=this._data.getInt16(this._ptr,!0);return this._ptr+=2,e},readU32:function(){var e=this._data.getUint32(this._ptr,!0);return this._ptr+=4,e},readI32:function(){var e=this._data.getInt32(this._ptr,!0);return this._ptr+=4,e},readF32:function(){var e=this._data.getFloat32(this._ptr,!0);return this._ptr+=4,e},readF64:function(){var e=this._data.getFloat64(this._ptr,!0);return this._ptr+=8,e},readUTF:function(){var e=this.readU16();return this.readUTFBytes(e)},readUTFBytes:function(e){for(var t=[],i=0;t.length<e;){var r=this._data.getUint8(this._ptr++,!0);if(r<128)t[i++]=String.fromCharCode(r);else if(191<r&&r<224){var o=this._data.getUint8(this._ptr++,!0);t[i++]=String.fromCharCode((31&r)<<6|63&o)}else{o=this._data.getUint8(this._ptr++,!0);var n=this._data.getUint8(this._ptr++,!0);t[i++]=String.fromCharCode((15&r)<<12|(63&o)<<6|63&n)}}return t.join("")}}}();