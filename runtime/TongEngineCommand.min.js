var Command=function(e){this.id=-1,this.inMemory=!1,this.updatable=!1,this.type="",this.name="",void 0!==e&&(Command.editor=e),this.editor=Command.editor};Command.prototype.toJSON=function(){var e={};return e.type=this.type,e.id=this.id,e.name=this.name,e},Command.prototype.fromJSON=function(e){this.inMemory=!0,this.type=e.type,this.id=e.id,this.name=e.name};var DropModelCommand=function(e,t){Command.call(this),this.type="DropModelCommand",this.object=e,this.parent=t||EditorModule.target.scene,void 0!==e&&(this.name="Drop Model: "+e.name)};DropModelCommand.prototype={execute:function(){this.editor.addObject(this.object,this.parent),this.editor.select(this.object)},undo:function(){this.editor.removeObject(this.object),this.editor.deselect()},toJSON:function(){var e=Command.prototype.toJSON.call(this);return e.object=this.object.toJSON(),e},fromJSON:function(e){if(Command.prototype.fromJSON.call(this,e),this.object=this.editor.objectByUuid(e.object.object.uuid),void 0===this.object){var t=new TONG.ObjectLoader;this.object=t.parse(e.object)}}};var AddComponentCommand=function(e,t){Command.call(this),this.type="AddComponentCommand",this.name="Add Component",this.component=t,this.object=e};AddComponentCommand.prototype={execute:function(){this.object.addComponent(this.component),this.editor.signals.componentAdded.dispatch(this.component)},undo:function(){this.object.removeComponent(this.component),EditorModule.refreshInspector(),this.editor.signals.componentRemoved.dispatch(this.component)},toJSON:function(){var e=Command.prototype.toJSON.call(this);return e.objectUuid=this.object.uuid,e.component=this.component.serialize(),e},fromJSON:function(e){Command.prototype.fromJSON.call(this,e),this.component=e.component,this.object=this.editor.objectByUuid(e.objectUuid)}};var RemoveComponentCommand=function(e,t){Command.call(this),this.type="RemoveComponentCommand",this.name="Remove Component",this.component=t,this.object=e};RemoveComponentCommand.prototype={execute:function(){this.editor.signals.componentRemoved.dispatch(this.component)},undo:function(){this.editor.signals.componentAdded.dispatch(this.component)},toJSON:function(){var e=Command.prototype.toJSON.call(this);return e.objectUuid=this.object.uuid,e.component=this.component.serialize(),e},fromJSON:function(e){Command.prototype.fromJSON.call(this,e),this.component=e.component,this.object=this.editor.objectByUuid(e.objectUuid)}};var AddObjectCommand=function(e){Command.call(this),this.type="AddObjectCommand",void 0!==(this.object=e)&&(this.name="Add Object: "+e.name)};AddObjectCommand.prototype={execute:function(){this.editor.addObject(this.object),this.editor.select(this.object)},undo:function(){this.editor.removeObject(this.object),this.editor.deselect()},toJSON:function(){var e=Command.prototype.toJSON.call(this);return e.object=this.object.toJSON(),e},fromJSON:function(e){if(Command.prototype.fromJSON.call(this,e),this.object=this.editor.objectByUuid(e.object.object.uuid),void 0===this.object){var t=new TONG.ObjectLoader;this.object=t.parse(e.object)}}};var AddResourceCommand=function(e){Command.call(this),this.type="AddResourceCommand",this.name="Add Resource",this.resource=e};AddResourceCommand.prototype={execute:function(){this.resource instanceof TONG.Material&&this.typeKey,TONG.RM.registerResource(this.resource.filename,this.resource),this.resource instanceof TONG.Script?TONG.Components.registerScriptComponent(this.resource):this.resource instanceof TONG.Material&&TONG.MaterialClasses.registerMaterialClass(this.resource),this.editor.signals.resourceAdded.dispatch(this.resource)},undo:function(){TONG.RM.unregisterResource(this.resource.filename),this.resource instanceof TONG.Material?TONG.MaterialClasses.unRegisterMaterialClass(this.resource):this.resource instanceof TONG.Script&&TONG.Components.unregisterComponent(this.resource),DriveModule.refreshContent(),this.editor.signals.resourceRemoved.dispatch(this.resource)},toJSON:function(){var e=Command.prototype.toJSON.call(this);return e.resource=this.resource.serialize(),e},fromJSON:function(e){Command.prototype.fromJSON.call(this,e),this.resource=e.resource}};var RemoveResourceCommand=function(e){Command.call(this),this.type="RemoveResourceCommand",this.name="Remove Resource",this.resource=e};RemoveResourceCommand.prototype={execute:function(){TONG.RM.unregisterResource(this.resource.filename),this.resource instanceof TONG.Material?TONG.MaterialClasses.unRegisterMaterialClass(this.resource):this.resource instanceof TONG.Script&&TONG.Components.unregisterComponent(this.resource.title),this.editor.signals.resourceRemoved.dispatch(this.resource)},undo:function(){TONG.RM.registerResource(this.resource.filename,this.resource),this.resource instanceof TONG.Script?TONG.Components.registerScriptComponent(this.resource):this.resource instanceof TONG.Material&&TONG.MaterialClasses.registerMaterialClass(this.resource),DriveModule.refreshContent(),this.editor.signals.resourceAdded.dispatch(this.resource)},toJSON:function(){var e=Command.prototype.toJSON.call(this);return e.resource=this.resource.serialize(),e.index=this.index,e},fromJSON:function(e){Command.prototype.fromJSON.call(this,e),this.resource=e.resource,this.index=e.index}};var RemoveObjectCommand=function(e){Command.call(this),this.type="RemoveObjectCommand",this.name="Remove Object",this.object=e,this.parent=void 0!==e?e.parent:void 0,void 0!==this.parent&&(this.index=this.parent.children.indexOf(this.object))};RemoveObjectCommand.prototype={execute:function(){var t=this.editor;this.object.traverse(function(e){t.removeHelper(e,!0)}),this.parent.remove(this.object),TONG.Event.trigger(t.scene,"nodeRemoved",this.object),this.editor.select(this.parent),this.editor.signals.objectRemoved.dispatch(this.object),this.editor.signals.sceneGraphChanged.dispatch()},undo:function(){var t=this.editor;this.object.traverse(function(e){void 0!==e.geometry&&t.addGeometry(e.geometry),void 0!==e.material&&t.addMaterial(e.material)}),this.parent.children.splice(this.index,0,this.object),this.object.parent=this.parent,TONG.Event.trigger(t.scene,"nodeAdded",this.object),this.editor.select(this.object),this.editor.signals.objectAdded.dispatch(this.object),this.editor.signals.sceneGraphChanged.dispatch()},toJSON:function(){var e=Command.prototype.toJSON.call(this);return e.object=this.object.toJSON(),e.index=this.index,e.parentUuid=this.parent.uuid,e},fromJSON:function(e){if(Command.prototype.fromJSON.call(this,e),this.parent=this.editor.objectByUuid(e.parentUuid),void 0===this.parent&&(this.parent=this.editor.scene),this.index=e.index,this.object=this.editor.objectByUuid(e.object.object.uuid),void 0===this.object){var t=new TONG.ObjectLoader;this.object=t.parse(e.object)}}};var SetShaderMaterialCommand=function(e,t,o,n,r,i,a){Command.call(this),this.type="SetShaderMaterialCommand",this.name="Change Shader",this.object=e,this.attributes=t,this.extensions=o,this.defines=n,this.uniforms=r,this.vertexShader=i,this.fragmentShader=a,this.oldAttributes=e.defaultAttributeValues,this.oldExtensions=e.extensions,this.oldDefines=e.defines,this.oldUniforms=e.uniforms,this.oldVertexShader=e.vertexShader,this.oldFragmentShader=e.fragmentShader};SetShaderMaterialCommand.prototype={execute:function(){this.object.needsUpdate=!0,this.object.defaultAttributeValues=this.attributes,this.object.extensions=this.extensions,this.object.defines=this.defines,this.object.uniforms=this.uniforms,this.object.vertexShader=this.vertexShader,this.object.fragmentShader=this.fragmentShader,this.editor.signals.materialChanged.dispatch(this.object)},undo:function(){this.object.needsUpdate=!0,this.object.defaultAttributeValues=this.oldAttributes,this.object.extensions=this.oldExtensions,this.object.defines=this.oldDefines,this.object.uniforms=this.oldUniforms,this.object.vertexShader=this.oldVertexShader,this.object.fragmentShader=this.oldFragmentShader,this.editor.signals.materialChanged.dispatch(this.object)},update:function(e){this.attributes=e.attributes,this.extensions=e.extensions,this.defines=e.defines,this.uniforms=e.uniforms,this.vertexShader=e.vertexShader,this.fragmentShader=e.fragmentShader},toJSON:function(){var e=Command.prototype.toJSON.call(this);return e.objectUuid=this.object.uuid,e.attributes=this.attributes,e.extensions=this.extensions,e.defines=this.defines,e.uniforms=this.uniforms,e.vertexShader=this.vertexShader,e.fragmentShader=this.fragmentShader,e},fromJSON:function(e){Command.prototype.fromJSON.call(this,e),this.attributes=e.attributes,this.extensions=e.extensions,this.defines=e.defines,this.uniforms=e.uniforms,this.vertexShader=e.vertexShader,this.fragmentShader=e.fragmentShader}};var MoveObjectCommand=function(e,t,o){Command.call(this),this.type="MoveObjectCommand",this.name="Move Object",this.object=e,this.oldParent=void 0!==e?e.parent:void 0,this.oldIndex=void 0!==this.oldParent?this.oldParent.children.indexOf(this.object):void 0,this.newParent=t,this.newIndex=void 0!==o?void 0!==t?t.children.indexOf(o):void 0:void 0!==t?t.children.length:void 0,this.oldParent===this.newParent&&this.newIndex>this.oldIndex&&this.newIndex--,this.newBefore=o};MoveObjectCommand.prototype={execute:function(){var m=this;!function e(t,o){var n=new TONG.Vector3(m.object.getWorldPosition().x,m.object.getWorldPosition().y,m.object.getWorldPosition().z),r=m.object.getWorldQuaternion(new TONG.Quaternion),i=(new TONG.Vector3).applyQuaternion(r),a=new TONG.Vector3(m.object.getWorldScale().x,m.object.getWorldScale().y,m.object.getWorldScale().z);o.remove(m.object),t.children.splice(m.newIndex,0,m.object),m.object.parent=t;var s=new TONG.Matrix4;s.getInverse(t.matrixWorld),m.object.applyMatrix(s);var l=new TONG.Vector3(m.object.getWorldPosition().x,m.object.getWorldPosition().y,m.object.getWorldPosition().z),c=new TONG.Vector3(n.x-l.x,n.y-l.y,n.z-l.z),d=m.object.getWorldQuaternion(new TONG.Quaternion),u=(new TONG.Vector3).applyQuaternion(d),h=new TONG.Vector3(i.x-u.x,i.y-u.y,i.z-u.z),f=new TONG.Vector3(m.object.getWorldScale().x,m.object.getWorldScale().y,m.object.getWorldScale().z),p=new TONG.Vector3(a.x/f.x,a.y/f.y,a.z/f.z);m.object.position.set(m.object.position.x+c.x,m.object.position.y+c.y,m.object.position.z+c.z),m.object.rotation.set(m.object.rotation.x+h.x,m.object.rotation.y+h.y,m.object.rotation.z+h.z),m.object.scale.set(m.object.scale.x*p.x,m.object.scale.y*p.y,m.object.scale.z*p.z),t!=m.newParent&&(e(m.newParent,m.editor.scene),m.editor.signals.sceneGraphChanged.dispatch())}(this.editor.scene,this.oldParent)},undo:function(){var f=this;!function e(t,o){var n=new TONG.Vector3(f.object.getWorldPosition().x,f.object.getWorldPosition().y,f.object.getWorldPosition().z),r=new TONG.Vector3(f.object.getWorldRotation().x,f.object.getWorldRotation().y,f.object.getWorldRotation().z),i=new TONG.Vector3(f.object.getWorldScale().x,f.object.getWorldScale().y,f.object.getWorldScale().z);o.remove(f.object),t.children.splice(f.oldIndex,0,f.object),f.object.parent=t;var a=new TONG.Matrix4;a.getInverse(t.matrixWorld),f.object.applyMatrix(a);var s=new TONG.Vector3(f.object.getWorldPosition().x,f.object.getWorldPosition().y,f.object.getWorldPosition().z),l=new TONG.Vector3(n.x-s.x,n.y-s.y,n.z-s.z),c=new TONG.Vector3(f.object.getWorldRotation().x,f.object.getWorldRotation().y,f.object.getWorldRotation().z),d=new TONG.Vector3(r.x-c.x,r.y-c.y,r.z-c.z),u=new TONG.Vector3(f.object.getWorldScale().x,f.object.getWorldScale().y,f.object.getWorldScale().z),h=new TONG.Vector3(i.x/u.x,i.y/u.y,i.z/u.z);f.object.position.set(f.object.position.x+l.x,f.object.position.y+l.y,f.object.position.z+l.z),f.object.rotation.set(f.object.rotation.x+d.x,f.object.rotation.y+d.y,f.object.rotation.z+d.z),f.object.scale.set(f.object.scale.x*h.x,f.object.scale.y*h.y,f.object.scale.z*h.z),t!=f.oldParent&&(e(f.oldParent,f.editor.scene),f.editor.signals.sceneGraphChanged.dispatch())}(this.editor.scene,this.newParent)},toJSON:function(){var e=Command.prototype.toJSON.call(this);return e.objectUuid=this.object.uuid,e.newParentUuid=this.newParent.uuid,e.oldParentUuid=this.oldParent.uuid,e.newIndex=this.newIndex,e.oldIndex=this.oldIndex,e},fromJSON:function(e){Command.prototype.fromJSON.call(this,e),this.object=this.editor.objectByUuid(e.objectUuid),this.oldParent=this.editor.objectByUuid(e.oldParentUuid),void 0===this.oldParent&&(this.oldParent=this.editor.scene),this.newParent=this.editor.objectByUuid(e.newParentUuid),void 0===this.newParent&&(this.newParent=this.editor.scene),this.newIndex=e.newIndex,this.oldIndex=e.oldIndex}};var SetPositionCommand=function(e,t,o){Command.call(this),this.type="SetPositionCommand",this.name="Set Position",this.updatable=!0,void 0!==(this.object=e)&&void 0!==t&&(this.oldPosition=e.position.clone(),this.newPosition=t.clone()),void 0!==o&&(this.oldPosition=o.clone())};SetPositionCommand.prototype={execute:function(){this.object.position.copy(this.newPosition),this.object.updateMatrixWorld(!0),this.editor.signals.objectChanged.dispatch(this.object,"translate")},undo:function(){this.object.position.copy(this.oldPosition),this.object.updateMatrixWorld(!0),this.editor.signals.objectChanged.dispatch(this.object,"translate")},update:function(e){this.newPosition.copy(e.newPosition)},toJSON:function(){var e=Command.prototype.toJSON.call(this);return e.objectUuid=this.object.uuid,e.oldPosition=this.oldPosition.toArray(),e.newPosition=this.newPosition.toArray(),e},fromJSON:function(e){Command.prototype.fromJSON.call(this,e),this.object=this.editor.objectByUuid(e.objectUuid),this.oldPosition=(new TONG.Vector3).fromArray(e.oldPosition),this.newPosition=(new TONG.Vector3).fromArray(e.newPosition)}};var SetRotationCommand=function(e,t,o){Command.call(this),this.type="SetRotationCommand",this.name="Set Rotation",this.updatable=!0,void 0!==(this.object=e)&&void 0!==t&&(this.oldRotation=e.rotation.clone(),this.newRotation=t.clone()),void 0!==o&&(this.oldRotation=o.clone())};SetRotationCommand.prototype={execute:function(){this.object.rotation.copy(this.newRotation),this.object.updateMatrixWorld(!0),this.editor.signals.objectChanged.dispatch(this.object,"rotation")},undo:function(){this.object.rotation.copy(this.oldRotation),this.object.updateMatrixWorld(!0),this.editor.signals.objectChanged.dispatch(this.object,"rotation")},update:function(e){this.newRotation.copy(e.newRotation)},toJSON:function(){var e=Command.prototype.toJSON.call(this);return e.objectUuid=this.object.uuid,e.oldRotation=this.oldRotation.toArray(),e.newRotation=this.newRotation.toArray(),e},fromJSON:function(e){Command.prototype.fromJSON.call(this,e),this.object=this.editor.objectByUuid(e.objectUuid),this.oldRotation=(new TONG.Euler).fromArray(e.oldRotation),this.newRotation=(new TONG.Euler).fromArray(e.newRotation)}};var SetScaleCommand=function(e,t,o){Command.call(this),this.type="SetScaleCommand",this.name="Set Scale",this.updatable=!0,void 0!==(this.object=e)&&void 0!==t&&(this.oldScale=e.scale.clone(),this.newScale=t.clone()),void 0!==o&&(this.oldScale=o.clone())};SetScaleCommand.prototype={execute:function(){this.object.scale.copy(this.newScale),this.object.updateMatrixWorld(!0),this.editor.signals.objectChanged.dispatch(this.object,"scale")},undo:function(){this.object.scale.copy(this.oldScale),this.object.updateMatrixWorld(!0),this.editor.signals.objectChanged.dispatch(this.object,"scale")},update:function(e){this.newScale.copy(e.newScale)},toJSON:function(){var e=Command.prototype.toJSON.call(this);return e.objectUuid=this.object.uuid,e.oldScale=this.oldScale.toArray(),e.newScale=this.newScale.toArray(),e},fromJSON:function(e){Command.prototype.fromJSON.call(this,e),this.object=this.editor.objectByUuid(e.objectUuid),this.oldScale=(new TONG.Vector3).fromArray(e.oldScale),this.newScale=(new TONG.Vector3).fromArray(e.newScale)}};var SetValueCommand=function(e,t,o,n){Command.call(this),this.type="SetValueCommand",this.name="Set "+t,this.updatable=!0,this.object=e,this.attributeName=t,this.oldValue=n,this.newValue=o};SetValueCommand.prototype={execute:function(){this.object[this.attributeName]instanceof TONG.Behavior||this.object[this.attributeName]instanceof TONG.Enum||this.object[this.attributeName]instanceof TONG.Value?this.object[this.attributeName].setValue(this.newValue):this.object[this.attributeName]=this.newValue,this.editor.signals.objectChanged.dispatch(this.object)},undo:function(){this.object[this.attributeName]instanceof TONG.Behavior||this.object[this.attributeName]instanceof TONG.Enum||this.object[this.attributeName]instanceof TONG.Value?this.object[this.attributeName].setValue(this.oldValue):this.object[this.attributeName]=this.oldValue,this.editor.signals.objectChanged.dispatch(this.object)},update:function(e){this.newValue=e.newValue},toJSON:function(){var e=Command.prototype.toJSON.call(this);return e.objectUuid=this.object.uuid,e.attributeName=this.attributeName,e.oldValue=this.oldValue,e.newValue=this.newValue,e},fromJSON:function(e){Command.prototype.fromJSON.call(this,e),this.attributeName=e.attributeName,this.oldValue=e.oldValue,this.newValue=e.newValue,this.object=this.editor.objectByUuid(e.objectUuid)}};var SetUuidCommand=function(e,t){Command.call(this),this.type="SetUuidCommand",this.name="Update UUID",this.object=e,this.oldUuid=void 0!==e?e.uuid:void 0,this.newUuid=t};SetUuidCommand.prototype={execute:function(){this.object.uuid=this.newUuid,this.editor.signals.objectChanged.dispatch(this.object),this.editor.signals.sceneGraphChanged.dispatch()},undo:function(){this.object.uuid=this.oldUuid,this.editor.signals.objectChanged.dispatch(this.object),this.editor.signals.sceneGraphChanged.dispatch()},toJSON:function(){var e=Command.prototype.toJSON.call(this);return e.oldUuid=this.oldUuid,e.newUuid=this.newUuid,e},fromJSON:function(e){Command.prototype.fromJSON.call(this,e),this.oldUuid=e.oldUuid,this.newUuid=e.newUuid,this.object=this.editor.objectByUuid(e.oldUuid),void 0===this.object&&(this.object=this.editor.objectByUuid(e.newUuid))}};var SetColorCommand=function(e,t,o){Command.call(this),this.type="SetColorCommand",this.name="Set "+t,this.updatable=!0,this.object=e,this.attributeName=t,this.oldValue=void 0!==e?this.object[this.attributeName].getHex():void 0,this.newValue=o};SetColorCommand.prototype={execute:function(){this.object[this.attributeName].setHex(this.newValue),this.editor.signals.objectChanged.dispatch(this.object)},undo:function(){this.object[this.attributeName].setHex(this.oldValue),this.editor.signals.objectChanged.dispatch(this.object)},update:function(e){this.newValue=e.newValue},toJSON:function(){var e=Command.prototype.toJSON.call(this);return e.objectUuid=this.object.uuid,e.attributeName=this.attributeName,e.oldValue=this.oldValue,e.newValue=this.newValue,e},fromJSON:function(e){Command.prototype.fromJSON.call(this,e),this.object=this.editor.objectByUuid(e.objectUuid),this.attributeName=e.attributeName,this.oldValue=e.oldValue,this.newValue=e.newValue}};var SetGeometryCommand=function(e,t){Command.call(this),this.type="SetGeometryCommand",this.name="Set Geometry",this.updatable=!0,this.object=e,this.oldGeometry=void 0!==e?e.geometry:void 0,this.newGeometry=t};SetGeometryCommand.prototype={execute:function(){this.object.geometry=this.newGeometry,this.object.geometry.computeBoundingSphere(),this.editor.signals.geometryChanged.dispatch(this.object),this.editor.signals.sceneGraphChanged.dispatch()},undo:function(){this.object.geometry=this.oldGeometry,this.object.geometry.computeBoundingSphere(),this.editor.signals.geometryChanged.dispatch(this.object),this.editor.signals.sceneGraphChanged.dispatch()},update:function(e){this.newGeometry=e.newGeometry},toJSON:function(){var e=Command.prototype.toJSON.call(this);return e.objectUuid=this.object.uuid,e.oldGeometry=this.object.geometry.toJSON(),e.newGeometry=this.newGeometry.toJSON(),e},fromJSON:function(e){function t(e){return(new TONG.ObjectLoader).parseGeometries([e])[e.uuid]}Command.prototype.fromJSON.call(this,e),this.object=this.editor.objectByUuid(e.objectUuid),this.oldGeometry=t(e.oldGeometry),this.newGeometry=t(e.newGeometry)}};var SetGeometryValueCommand=function(e,t,o){Command.call(this),this.type="SetGeometryValueCommand",this.name="Set Geometry."+t,this.object=e,this.attributeName=t,this.oldValue=void 0!==e?e.geometry[t]:void 0,this.newValue=o};SetGeometryValueCommand.prototype={execute:function(){this.object.geometry[this.attributeName]=this.newValue,this.editor.signals.objectChanged.dispatch(this.object),this.editor.signals.geometryChanged.dispatch(),this.editor.signals.sceneGraphChanged.dispatch()},undo:function(){this.object.geometry[this.attributeName]=this.oldValue,this.editor.signals.objectChanged.dispatch(this.object),this.editor.signals.geometryChanged.dispatch(),this.editor.signals.sceneGraphChanged.dispatch()},toJSON:function(){var e=Command.prototype.toJSON.call(this);return e.objectUuid=this.object.uuid,e.attributeName=this.attributeName,e.oldValue=this.oldValue,e.newValue=this.newValue,e},fromJSON:function(e){Command.prototype.fromJSON.call(this,e),this.object=this.editor.objectByUuid(e.objectUuid),this.attributeName=e.attributeName,this.oldValue=e.oldValue,this.newValue=e.newValue}};var MultiCmdsCommand=function(e){Command.call(this),this.type="MultiCmdsCommand",this.name="Multiple Changes",this.cmdArray=void 0!==e?e:[]};MultiCmdsCommand.prototype={execute:function(){this.editor.signals.sceneGraphChanged.active=!1;for(var e=0;e<this.cmdArray.length;e++)this.cmdArray[e].execute();this.editor.signals.sceneGraphChanged.active=!0,this.editor.signals.sceneGraphChanged.dispatch()},undo:function(){this.editor.signals.sceneGraphChanged.active=!1;for(var e=this.cmdArray.length-1;0<=e;e--)this.cmdArray[e].undo();this.editor.signals.sceneGraphChanged.active=!0,this.editor.signals.sceneGraphChanged.dispatch()},toJSON:function(){for(var e=Command.prototype.toJSON.call(this),t=[],o=0;o<this.cmdArray.length;o++)t.push(this.cmdArray[o].toJSON());return e.cmds=t,e},fromJSON:function(e){Command.prototype.fromJSON.call(this,e);for(var t=e.cmds,o=0;o<t.length;o++){var n=new window[t[o].type];n.fromJSON(t[o]),this.cmdArray.push(n)}}};var AddScriptCommand=function(e,t){Command.call(this),this.type="AddScriptCommand",this.name="Add Script",this.object=e,this.script=t};AddScriptCommand.prototype={execute:function(){void 0===this.editor.scripts[this.object.uuid]&&(this.editor.scripts[this.object.uuid]=[]),this.editor.scripts[this.object.uuid].push(this.script),this.editor.signals.scriptAdded.dispatch(this.script)},undo:function(){if(void 0!==this.editor.scripts[this.object.uuid]){var e=this.editor.scripts[this.object.uuid].indexOf(this.script);-1!==e&&this.editor.scripts[this.object.uuid].splice(e,1),this.editor.signals.scriptRemoved.dispatch(this.script)}},toJSON:function(){var e=Command.prototype.toJSON.call(this);return e.objectUuid=this.object.uuid,e.script=this.script,e},fromJSON:function(e){Command.prototype.fromJSON.call(this,e),this.script=e.script,this.object=this.editor.objectByUuid(e.objectUuid)}};var RemoveScriptCommand=function(e,t){Command.call(this),this.type="RemoveScriptCommand",this.name="Remove Script",this.object=e,this.script=t,this.object&&this.script&&(this.index=this.editor.scripts[this.object.uuid].indexOf(this.script))};RemoveScriptCommand.prototype={execute:function(){void 0!==this.editor.scripts[this.object.uuid]&&(-1!==this.index&&this.editor.scripts[this.object.uuid].splice(this.index,1),this.editor.signals.scriptRemoved.dispatch(this.script))},undo:function(){void 0===this.editor.scripts[this.object.uuid]&&(this.editor.scripts[this.object.uuid]=[]),this.editor.scripts[this.object.uuid].splice(this.index,0,this.script),this.editor.signals.scriptAdded.dispatch(this.script)},toJSON:function(){var e=Command.prototype.toJSON.call(this);return e.objectUuid=this.object.uuid,e.script=this.script,e.index=this.index,e},fromJSON:function(e){Command.prototype.fromJSON.call(this,e),this.script=e.script,this.index=e.index,this.object=this.editor.objectByUuid(e.objectUuid)}};var SetScriptValueCommand=function(e,t,o,n){Command.call(this),this.type="SetScriptValueCommand",this.name="Set Script."+o,this.updatable=!0,this.object=e,this.script=t,this.attributeName=o,this.oldValue=void 0!==t?t[this.attributeName]:void 0,this.newValue=n};SetScriptValueCommand.prototype={execute:function(){this.script[this.attributeName]=this.newValue,this.editor.signals.scriptChanged.dispatch()},undo:function(){this.script[this.attributeName]=this.oldValue,this.editor.signals.scriptChanged.dispatch()},update:function(e){this.newValue=e.newValue},toJSON:function(){var e=Command.prototype.toJSON.call(this);return e.objectUuid=this.object.uuid,e.index=this.editor.scripts[this.object.uuid].indexOf(this.script),e.attributeName=this.attributeName,e.oldValue=this.oldValue,e.newValue=this.newValue,e},fromJSON:function(e){Command.prototype.fromJSON.call(this,e),this.oldValue=e.oldValue,this.newValue=e.newValue,this.attributeName=e.attributeName,this.object=this.editor.objectByUuid(e.objectUuid),this.script=this.editor.scripts[e.objectUuid][e.index]}};var SetMaterialCommand=function(e,t,o,n,r){Command.call(this),this.type="SetMaterialCommand",this.name="New Material",this.object=e,this.materialSlot=o,this.isPlus=n,this.splitLength=r,this.oldMaterial=this.editor.getObjectMaterial(e,o),this.newMaterial=t};SetMaterialCommand.prototype={execute:function(){this.editor.setObjectMaterial(this.object,this.materialSlot,this.newMaterial,this.isPlus,this.splitLength),this.editor.signals.materialChanged.dispatch(this.newMaterial)},undo:function(){var e=!1;e=null==this.isPlus?void 0:!this.isPlus,this.editor.setObjectMaterial(this.object,this.materialSlot,this.oldMaterial,e,this.splitLength),this.editor.signals.materialChanged.dispatch(this.oldMaterial)},toJSON:function(){var e=Command.prototype.toJSON.call(this);return e.objectUuid=this.object.uuid,e.oldMaterial=this.oldMaterial.toJSON(),e.newMaterial=this.newMaterial.toJSON(),e},fromJSON:function(e){function t(e){var t=new TONG.ObjectLoader,o=t.parseImages(e.images),n=t.parseTextures(e.textures,o);return t.parseMaterials([e],n)[e.uuid]}Command.prototype.fromJSON.call(this,e),this.object=this.editor.objectByUuid(e.objectUuid),this.oldMaterial=t(e.oldMaterial),this.newMaterial=t(e.newMaterial)}};var SetMaterialValueCommand=function(e,t,o,n){Command.call(this),this.type="SetMaterialValueCommand",this.name="Set Material."+t,this.updatable=!0,this.object=e,this.material=this.editor.getObjectMaterial(e,n),this.oldValue=void 0!==this.material?this.material[t]:void 0,this.newValue=o,this.attributeName=t};SetMaterialValueCommand.prototype={execute:function(){this.material[this.attributeName]=this.newValue,this.material.needsUpdate=!0,this.editor.signals.objectChanged.dispatch(this.object),this.editor.signals.materialChanged.dispatch(this.material)},undo:function(){this.material[this.attributeName]=this.oldValue,this.material.needsUpdate=!0,this.editor.signals.objectChanged.dispatch(this.object),this.editor.signals.materialChanged.dispatch(this.material)},update:function(e){this.newValue=e.newValue},toJSON:function(){var e=Command.prototype.toJSON.call(this);return e.objectUuid=this.object.uuid,e.attributeName=this.attributeName,e.oldValue=this.oldValue,e.newValue=this.newValue,e},fromJSON:function(e){Command.prototype.fromJSON.call(this,e),this.attributeName=e.attributeName,this.oldValue=e.oldValue,this.newValue=e.newValue,this.object=this.editor.objectByUuid(e.objectUuid)}};var SetMaterialColorCommand=function(e,t,o,n){Command.call(this),this.type="SetMaterialColorCommand",this.name="Set Material."+t,this.updatable=!0,this.object=e,this.material=this.editor.getObjectMaterial(e,n),this.oldValue=void 0!==this.material?this.material[t].getHex():void 0,this.newValue=o,this.attributeName=t};SetMaterialColorCommand.prototype={execute:function(){this.material[this.attributeName].setHex(this.newValue),this.editor.signals.materialChanged.dispatch(this.material)},undo:function(){this.material[this.attributeName].setHex(this.oldValue),this.editor.signals.materialChanged.dispatch(this.material)},update:function(e){this.newValue=e.newValue},toJSON:function(){var e=Command.prototype.toJSON.call(this);return e.objectUuid=this.object.uuid,e.attributeName=this.attributeName,e.oldValue=this.oldValue,e.newValue=this.newValue,e},fromJSON:function(e){Command.prototype.fromJSON.call(this,e),this.object=this.editor.objectByUuid(e.objectUuid),this.attributeName=e.attributeName,this.oldValue=e.oldValue,this.newValue=e.newValue}};var SetMaterialMapCommand=function(e,t,o){Command.call(this),this.type="SetMaterialMapCommand",this.name="Set Material."+t,this.object=e,this.mapName=t,this.oldMap=void 0!==e?e[t]:void 0,this.newMap=o};SetMaterialMapCommand.prototype={execute:function(){this.object[this.mapName]?null==this.newMap.image?this.object[this.mapName]=null:(this.object[this.mapName].image=this.newMap.image,this.object[this.mapName].needsUpdate=!0):this.object[this.mapName]=this.newMap,this.object.needsUpdate=!0,this.editor.signals.materialChanged.dispatch(this.object)},undo:function(){this.object[this.mapName]?null==this.oldMap.image?this.object[this.mapName]=null:(this.object[this.mapName].image=this.oldMap.image,this.object[this.mapName].needsUpdate=!0):this.object[this.mapName]=this.oldMap,this.object.needsUpdate=!0,this.editor.signals.materialChanged.dispatch(this.object)},toJSON:function(){var e=Command.prototype.toJSON.call(this);return e.objectUuid=this.object.uuid,e.mapName=this.mapName,e.newMap=t(this.newMap),e.oldMap=t(this.oldMap),e;function t(e){if(null==e)return null;var t={geometries:{},materials:{},textures:{},images:{}},o=e.toJSON(t),n=function(e){var t=[];for(var o in e){var n=e[o];delete n.metadata,t.push(n)}return t}(t.images);return 0<n.length&&(o.images=n),o.sourceFile=e.sourceFile,o}},fromJSON:function(e){function t(e){var t=null;if(null!==e){var o=new TONG.ObjectLoader,n=o.parseImages(e.images);(t=o.parseTextures([e],n)[e.uuid]).sourceFile=e.sourceFile}return t}Command.prototype.fromJSON.call(this,e),this.object=this.editor.objectByUuid(e.objectUuid),this.mapName=e.mapName,this.oldMap=t(e.oldMap),this.newMap=t(e.newMap)}};var SetSceneCommand=function(e){if(Command.call(this),this.type="SetSceneCommand",this.name="Set Scene",this.cmdArray=[],void 0!==e)for(this.cmdArray.push(new SetUuidCommand(this.editor.scene,e.uuid)),this.cmdArray.push(new SetValueCommand(this.editor.scene,"name",e.name)),this.cmdArray.push(new SetValueCommand(this.editor.scene,"userData",JSON.parse(JSON.stringify(e.userData))));0<e.children.length;){var t=e.children.pop();this.cmdArray.push(new AddObjectCommand(t))}};function html2canvas(e){var u=document.createRange();function h(e,t,o,n){""!==n&&(m.font=e.fontSize+" "+e.fontFamily,m.textBaseline="top",m.fillStyle=e.color,m.fillText(n,t,o))}function f(e,t,o,n,r,i){var a=e[t+"Width"],s=e[t+"Style"],l=e[t+"Color"];"0px"!==a&&"none"!==s&&"transparent"!==l&&"rgba(0, 0, 0, 0)"!==l&&(m.strokeStyle=l,m.beginPath(),m.moveTo(o,n),m.lineTo(o+r,n+i),m.stroke())}var p=e.getBoundingClientRect(),t=document.createElement("canvas");t.width=p.width,t.height=p.height;var m=t.getContext("2d"),g=new function(a){var s=[],l=!1;function t(){if(l&&(l=!1,a.restore()),0!==s.length){for(var e=-1/0,t=-1/0,o=1/0,n=1/0,r=0;r<s.length;r++){var i=s[r];e=Math.max(e,i.x),t=Math.max(t,i.y),o=Math.min(o,i.x+i.width),n=Math.min(n,i.y+i.height)}a.save(),a.beginPath(),a.rect(e,t,o-e,n-t),a.clip(),l=!0}}return{add:function(e){s.push(e),t()},remove:function(){s.pop(),t()}}}(m);return console.time("drawElement"),function e(t,o){var n=0,r=0,i=0,a=0;if(3===t.nodeType)u.selectNode(t),n=(s=u.getBoundingClientRect()).left-p.left-.5,r=s.top-p.top-.5,i=s.width,a=s.height,h(o,n,r,t.nodeValue.trim());else{if("none"===t.style.display)return;var s;n=(s=t.getBoundingClientRect()).left-p.left-.5,r=s.top-p.top-.5,i=s.width,a=s.height;var l=(o=window.getComputedStyle(t)).backgroundColor;"transparent"!==l&&"rgba(0, 0, 0, 0)"!==l&&(m.fillStyle=l,m.fillRect(n,r,i,a)),f(o,"borderTop",n,r,i,0),f(o,"borderLeft",n,r,0,a),f(o,"borderBottom",n,r+a,i,0),f(o,"borderRight",n+i,r,0,a),"color"!==t.type&&"text"!==t.type||(g.add({x:n,y:r,width:i,height:a}),h(o,n+parseInt(o.paddingLeft),r+parseInt(o.paddingTop),t.value),g.remove())}var c="auto"===o.overflow||"hidden"===o.overflow;c&&g.add({x:n,y:r,width:i,height:a});for(var d=0;d<t.childNodes.length;d++)e(t.childNodes[d],o);c&&g.remove()}(e),console.timeEnd("drawElement"),t}SetSceneCommand.prototype={execute:function(){this.editor.signals.sceneGraphChanged.active=!1;for(var e=0;e<this.cmdArray.length;e++)this.cmdArray[e].execute();this.editor.signals.sceneGraphChanged.active=!0,this.editor.signals.sceneGraphChanged.dispatch()},undo:function(){this.editor.signals.sceneGraphChanged.active=!1;for(var e=this.cmdArray.length-1;0<=e;e--)this.cmdArray[e].undo();this.editor.signals.sceneGraphChanged.active=!0,this.editor.signals.sceneGraphChanged.dispatch()},toJSON:function(){for(var e=Command.prototype.toJSON.call(this),t=[],o=0;o<this.cmdArray.length;o++)t.push(this.cmdArray[o].toJSON());return e.cmds=t,e},fromJSON:function(e){Command.prototype.fromJSON.call(this,e);for(var t=e.cmds,o=0;o<t.length;o++){var n=new window[t[o].type];n.fromJSON(t[o]),this.cmdArray.push(n)}}},TONG.HTMLGroup=function(e){TONG.Group.call(this),this.type="HTMLGroup"},TONG.HTMLGroup.prototype=Object.assign(Object.create(TONG.Group.prototype),{constructor:TONG.HTMLGroup}),TONG.HTMLMesh=function(e){var t=new TONG.HTMLTexture(e),o=new TONG.PlaneGeometry(.05*t.image.width,.05*t.image.height),n=new TONG.MeshBasicMaterial({map:t});TONG.Mesh.call(this,o,n),this.type="HTMLMesh"},TONG.HTMLMesh.prototype=Object.assign(Object.create(TONG.Mesh.prototype),{constructor:TONG.HTMLMesh}),TONG.HTMLTexture=function(e){TONG.CanvasTexture.call(this,html2canvas(e)),this.dom=e,this.anisotropy=16},TONG.HTMLTexture.prototype=Object.assign(Object.create(TONG.CanvasTexture.prototype),{constructor:TONG.HTMLTexture,update:function(){console.log("yo!",this,this.dom),this.image=html2canvas(this.dom),this.needsUpdate=!0}}),function(e){function w(){}for(var t in w.classes={},w.HEADER_SIZE=64,w.FOUR_CC="WBIN",w.VERSION=.3,w.CLASSNAME_SIZE=32,w.LUMPHEADER_SIZE=10+(w.LUMPNAME_SIZE=54),w.CODES={ArrayBuffer:"AB",Int8Array:"I1",Uint8Array:"i1",Int16Array:"I2",Uint16Array:"i2",Int32Array:"I4",Uint32Array:"i4",Float32Array:"F4",Float64Array:"F8",Object:"OB",WideObject:"WO",String:"ST",WideString:"WS",Number:"NU",null:"00"},w.REVERSE_CODES={},w.CODES)w.REVERSE_CODES[w.CODES[t]]=t;w.FULL_BINARY=1,w.isWBin=function(e){for(var t=e.subarray(0,4),o=0;o<t.length;o++)if(0!=t[o]&&t[o]!=w.FOUR_CC.charCodeAt(o))return!1;return!0},w.create=function(e,t){if(!e)throw"WBin null origin passed";var o=new Uint8Array([0,0]),n=new Uint8Array(new Float32Array([w.VERSION]).buffer);if(t=t||"",e.toBinary){var r=e.toBinary();if(!r)return null;if(r.constructor==ArrayBuffer){o[0]|=w.FULL_BINARY;var i=w.getObjectClassName(e);return(d=new Uint8Array(w.HEADER_SIZE+r.length)).set(w.stringToUint8Array(w.FOUR_CC)),d.set(n,4),d.set(o,8),d.set(w.stringToUint8Array(i,w.CLASSNAME_SIZE),14),d.set(r,w.HEADER_SIZE),d}e=r}var a=w.HEADER_SIZE,s=[],l=0;for(var c in e){var d;if(null!=(d=e[c])){if(d.constructor===Blob||d.constructor===File)throw"Wbin does not allow Blobs or Files as data to store, conver to ArrayBuffer";i=w.getObjectClassName(d);var u=w.CODES[i];u||(u="OB"),"NU"==u?d=new Float64Array([d]):"OB"==u&&(d=JSON.stringify(d));var h=0;if(d&&d.constructor==String&&(d=w.stringToTypedArray(d)).constructor===Uint16Array&&(u="OB"==u?"WO":"WS"),d.buffer&&d.buffer.constructor==ArrayBuffer)h=(d=new Uint8Array(new Uint8Array(d.buffer,d.byteOffset,d.byteLength))).byteLength;else{if(d.constructor!=ArrayBuffer)throw"WBin: cannot be anything different to ArrayBuffer";h=d.byteLength}var f=c.substring(0,w.LUMPNAME_SIZE);f.length<c.length&&console.error("Lump name is too long (max is "+w.LUMPNAME_SIZE+"), it has been cut down, this could lead to an error in the future"),s.push({code:u,name:f,data:d,start:l,size:h}),l+=h,a+=w.LUMPHEADER_SIZE+h}}(d=new Uint8Array(a)).set(w.stringToUint8Array(w.FOUR_CC)),d.set(n,4),d.set(o,8),d.set(new Uint8Array(new Uint16Array([s.length]).buffer),10),t&&d.set(w.stringToUint8Array(t,w.CLASSNAME_SIZE),12);var p=w.HEADER_SIZE+s.length*w.LUMPHEADER_SIZE,m=w.HEADER_SIZE;for(var g in s){var v=s[g],b=(v.data,new Uint8Array(w.LUMPHEADER_SIZE));b.set(new Uint8Array(new Uint32Array([v.start]).buffer),0),b.set(new Uint8Array(new Uint32Array([v.size]).buffer),4),b.set(w.stringToUint8Array(v.code,2),8),b.set(w.stringToUint8Array(v.name,w.LUMPNAME_SIZE),10),d.set(b,m),m+=w.LUMPHEADER_SIZE;var y=new Uint8Array(v.data);d.set(y,p+v.start)}return d},w.load=function(e,t,o){if(!e||e.constructor!==Uint8Array&&e.constructor!==ArrayBuffer)throw"WBin data must be ArrayBuffer or Uint8Array";e=new Uint8Array(e);var n=w.getHeaderInfo(e);if(!n)return console.error("Wrong WBin Header"),null;n.version>new Float32Array([w.VERSION])[0]&&console.log("ALERT: WBin version is higher that code version");var r=null;for(var i in n.lumps){r||(r={});var a=n.lumps[i],s=n.lump_data.subarray(a.start,a.start+a.size);if(a.size!=s.length)throw"WBin: incorrect wbin lump size";var l=null,c=w.REVERSE_CODES[a.code];if(!c)throw"WBin: Incorrect data code";switch(c){case"null":break;case"WideString":s=new Uint16Array(new Uint8Array(s).buffer);case"String":l=w.TypedArrayToString(s);break;case"Number":l=n.version<.3?parseFloat(w.TypedArrayToString(s)):new Float64Array(s.buffer)[0];break;case"WideObject":s=new Uint16Array(new Uint8Array(s).buffer);case"Object":l=JSON.parse(w.TypedArrayToString(s));break;case"ArrayBuffer":l=new Uint8Array(s).buffer;break;default:if(s=new Uint8Array(s),!(d=w.classes[c]||window[c]))throw"WBin referenced class not found: "+c;if(s.length/d.BYTES_PER_ELEMENT%1!=0)throw"WBin: size do not match type";l=new d(s.buffer)}r[a.name]=l}if(!t&&n.classname){var d;if((d=w.classes[n.classname]||window[n.classname])&&d.fromBinary)return d.fromBinary(r,o);if(d&&d.prototype.fromBinary){var u=new d;return u.fromBinary(r,o),u}r["@classname"]=n.classname}return r},w.getHeaderInfo=function(e){for(var t=e.subarray(0,4),o=0;o<t.length;o++)if(0!=t[o]&&t[o]!=w.FOUR_CC.charCodeAt(o))return null;var n=w.readFloat32(e,4),r=new Uint8Array(e.subarray(8,10)),i=w.readUint16(e,10),a=w.TypedArrayToString(e.subarray(12,12+w.CLASSNAME_SIZE)),s=[];for(o=0;o<i;++o){var l=w.HEADER_SIZE+o*w.LUMPHEADER_SIZE,c=e.subarray(l,l+w.LUMPHEADER_SIZE),d={};d.start=w.readUint32(c,0),d.size=w.readUint32(c,4),d.code=w.TypedArrayToString(c.subarray(8,10)),d.name=w.TypedArrayToString(c.subarray(10)),s.push(d)}return{version:n,flags:r,classname:a,numlumps:i,lumps:s,lump_data:e.subarray(w.HEADER_SIZE+i*w.LUMPHEADER_SIZE)}},w.getObjectClassName=function(e){if(e&&e.constructor&&e.constructor.toString){var t=e.constructor.toString().match(/function\s*(\w+)/);if(t&&2==t.length)return t[1]}},w.stringToUint8Array=function(e,t){for(var o=new Uint8Array(t||e.length),n=!1,r=0;r<e.length;r++){var i=e.charCodeAt(r);255<i&&(n=!0),o[r]=i}return n&&console.warn("WBin: there are characters in the string that cannot be encoded in 1 byte."),o},w.TypedArrayToString=function(e,t){for(var o="",n=0;n<e.length&&(0!=e[n]||t);n++)o+=String.fromCharCode(e[n]);return o},w.stringToTypedArray=function(e,t){for(var o=new Uint8Array(t||e.length),n=!1,r=0;r<e.length;r++){255<(i=e.charCodeAt(r))&&(n=!0),o[r]=i}if(!n)return o;for(o=new Uint16Array(t||e.length),r=0;r<e.length;r++){var i=e.charCodeAt(r);o[r]=i}return o},w.readUint16=function(e,t){return new DataView(e.buffer,e.byteOffset).getUint16(t,!0)},w.readUint32=function(e,t){return new DataView(e.buffer,e.byteOffset).getUint32(t,!0)},w.readFloat32=function(e,t){return new DataView(e.buffer,e.byteOffset).getFloat32(t,!0)},e.WBin=w}("undefined"!=typeof global?global:this);var Utils={},scriptObject=null,NUMBER_PRECISION=6;Utils.parseNumber=function(e,t){return"number"==typeof t?parseFloat(t.toFixed(NUMBER_PRECISION)):t};var link=document.createElement("a");function save(e,t){link.href=URL.createObjectURL(e),link.download=t||"tong3d.json",link.click()}link.style.display="none",document.body.appendChild(link),jQuery.fn.isChildOf=function(e){return 0<this.parents(e).length},jQuery.fn.isChildAndSelfOf=function(e){return 0<this.closest(e).length},Utils.Building=function(e,t,o){var n=new JSZip,r=e.toJSON(),i=null,a=!1;if(t){var s=r[e.currentProjectName+""];for(var l in s){null!=(i=s[l+""].data)&&d(i)}var c={};c[e.currentProjectName+""]=s,c.metadata=r.metadata,i=c}else d(i=r[e.currentProjectName+""][e.currentSceneName+""].data);function d(e){e.metadata.type="TONG ENGINE APP",delete e.history;var t=e.project.vr;t&&!a&&(a=t),e=(e=JSON.stringify(e,Utils.parseNumber,"\t")).replace(/[\n\t]+([\d\.e\-\[\]]+)/g,"$1")}var u,h="tong3d.json";o?(h="tong3d.tog",u=(new dcodeIO.TONGData.StaticPair).toArrayBuffer(i)):u=JSON.stringify(i),n.file(h,u);var f=new TONG.LoadingManager(function(){save(n.generate({type:"blob"}),"TongEngine.zip")}),p=new TONG.FileLoader(f);p.load("js/libs/export/index.html",function(e){var t=[];a&&(t.push('<script src="js/VRControls.js"><\/script>'),t.push('<script src="js/VREffect.js"><\/script>'),t.push('<script src="js/WebVR.js"><\/script>')),e=e.replace("\x3c!-- includes --\x3e",t.join("\n\t\t")),n.file("index.html",e)}),a&&(p.load("tongEngine/js/controls/VRControls.js",function(e){n.file("js/VRControls.js",e)}),p.load("tongEngine/js/effects/VREffect.js",function(e){n.file("js/VREffect.js",e)}),p.load("tongEngine/js/vr/WebVR.js",function(e){n.file("js/WebVR.js",e)}))},Utils.Inspector={},Utils.Inspector.addTitle=function(e,t,o,n){var r="<span class='icon' style='width: 20px'><img src='"+o+"' class='icon'/></span>",i=t,a=e.addSection(r+" "+i+"<span class='buttons'><img class='options_section_help' src='css/pic/inspector/help.png' class='icon'/><img class='options_section' src='css/pic/inspector/settings.png'></span>");return a.querySelector(".options_section").addEventListener("click",function(e){e.preventDefault(),e.stopPropagation();var t=new LiteGUI.ContextMenu(["one","two"]);e.target.appendChild(t.root)}),a.querySelector(".options_section_help").addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),n&&""!=n&&window.open(""+n)}),a};var SystemMenu=null,SettingComponent=null;Utils.DocumentInit=function(){document.oncontextmenu=function(){return!1},window.URL=window.URL||window.webkitURL,window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,Number.prototype.format=function(){return this.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1,")};var n=new Editor;EditorModule.target=n,SystemMenu=new MenuBar;var r=new Viewport(n);document.body.appendChild(r.container.dom),EditorModule.viewport=r;var e=new Player(n);document.body.appendChild(e.dom);var t=new InspectorPanel(n);document.body.appendChild(t.container.dom),SettingComponent=new Setting;var o=new Sidebar.Hierarchy(n);document.body.appendChild(o.dom);var i=new ToolManager(n);document.body.appendChild(i.dom);var a=new UI.Modal;document.body.appendChild(a.dom);var s=new Bottom(n);document.body.appendChild(s.dom);var l=new AddAssetsMenubar(n);document.body.appendChild(l.dom);var c=new TransparentBackPanel(n);document.body.appendChild(c.dom);var d=new ScenesManagerPanel(n);document.body.appendChild(d.dom);var u=new ProgressPanel(n);u.setDisplay("none"),document.body.appendChild(u.dom);var h=new AddComponentMenubar(n);function f(e){n.signals.windowResize.dispatch()}document.body.appendChild(h.dom),TONG.Script.setScript("","javascript",""),Utils.Resize(n),n.setTheme(n.config.getKey("theme")),n.storage.init(function(){var t;function e(e){!1!==n.config.getKey("autosave")&&(clearTimeout(t),t=setTimeout(function(){n.signals.savingStarted.dispatch(),t=setTimeout(function(){n.storage.set(n.toJSON()),n.signals.savingFinished.dispatch()},100)},1e3))}n.storage.get(function(e){m||void 0!==e&&ScenesManagerPanel.ApplyStorageData(n,e)});var o=n.signals;o.geometryChanged.add(e),o.objectAdded.add(e),o.objectChanged.add(e),o.objectRemoved.add(e),o.materialChanged.add(e),o.sceneBackgroundChanged.add(e),o.sceneFogChanged.add(e),o.sceneGraphChanged.add(e),o.scriptChanged.add(e),o.componentAdded.add(e),o.componentRemoved.add(e),o.componentChanged.add(e),o.resourceAdded.add(e),o.resourceRemoved.add(e),o.resourceChange.add(e),o.historyChanged.add(e),o.assetsSave.add(e),o.editFile.add(e),o.showModal.add(function(e){a.show(e)})}),document.addEventListener("dragover",function(e){e.preventDefault(),e.dataTransfer.dropEffect="copy"},!1),document.addEventListener("drop",function(e){e.preventDefault(),e.stopPropagation(),0<e.dataTransfer.files.length&&n.loader.loadFile(e.dataTransfer.files[0])},!1),document.addEventListener("keydown",function(e){if(1==e.ctrlKey&&83==e.keyCode)return e.preventDefault(),!1;switch(1==e.ctrlKey&&87==e.keyCode?n.signals.transformModeChanged.dispatch("translate"):1==e.ctrlKey&&69==e.keyCode?n.signals.transformModeChanged.dispatch("rotate"):1==e.ctrlKey&&82==e.keyCode&&n.signals.transformModeChanged.dispatch("scale"),e.keyCode){case 46:var t=n.selected;null!==t.parent&&n.execute(new RemoveObjectCommand(t));break;case 90:e.ctrlKey&&e.shiftKey?n.redo():e.ctrlKey&&n.undo()}},!1),window.addEventListener("resize",f,!1);var p,m=!1,g=window.location.hash;if("file="===g.substr(1,5)){var v=g.substr(6);if(confirm("Any unsaved data will be lost. Are you sure?")){var b=new TONG.FileLoader;b.crossOrigin="",b.load(v,function(e){n.clear(),n.fromJSON(JSON.parse(e))}),m=!0}}n.signals.enterVR.add(function(){if(void 0===p){p=new TONG.HTMLGroup(r.dom),n.sceneHelpers.add(p);var e=new TONG.HTMLMesh(sidebar.dom);e.position.set(15,0,15),e.rotation.y=-.5,p.add(e);var t=n.signals;function o(){e.material.map.update()}t.objectSelected.add(o),t.objectAdded.add(o),t.objectChanged.add(o),t.objectRemoved.add(o),t.sceneGraphChanged.add(o),t.historyChanged.add(o)}p.visible=!0}),n.signals.exitedVR.add(function(){void 0!==p&&(p.visible=!1)}),f(),document.body.ondrop=function(e){e.preventDefault(),e.stopPropagation()}},Utils.Quaternion={},Utils.Quaternion.Division=function(e,t){var o=(e.w*t.w+e.x*t.x+e.y*t.y+e.z*t.z)/(t.w*t.w+t.x*t.x+t.y*t.y+t.z*t.z),n=(e.x*t.w-t.x*e.w-t.y*e.z+t.z*e.y)/(t.w*t.w+t.x*t.x+t.y*t.y+t.z*t.z),r=(e.y*t.w+t.y*e.z-t.y*e.w-t.z*e.x)/(t.w*t.w+t.x*t.x+t.y*t.y+t.z*t.z),i=(t.w*e.z-t.x*e.y+t.y*e.x-t.z*e.w)/(t.w*t.w+t.x*t.x+t.y*t.y+t.z*t.z);return new TONG.Quaternion(n,r,i,o)},Utils.SetGeometryPosition=function(e,t){var o=new TONG.Matrix4;o.makeTranslation(t.x,t.y,t.z),e.applyMatrix(o)},Utils.SetGeometryScale=function(e,t){var o=new TONG.Matrix4;o.makeScale(t.x,t.y,t.z),e.applyMatrix(o)},Utils.GetScaleOffset=function(e,t){};var transformControlObj=null;Utils.SetTransformControl=function(e){transformControlObj=e},Utils.GetTransformControl=function(){return transformControlObj},Utils.SetEntityElement=function(e,t,o){$("#Entity .posX").attr("disabled",!e),e?$("#Entity .posX").css("color","#08f"):$("#Entity .posX").css("color","#3d3d3d"),$("#Entity .posY").attr("disabled",!e),e?$("#Entity .posY").css("color","#08f"):$("#Entity .posY").css("color","#3d3d3d"),$("#Entity .posZ").attr("disabled",!e),e?$("#Entity .posZ").css("color","#08f"):$("#Entity .posZ").css("color","#3d3d3d"),$("#Entity .rotX").attr("disabled",!t),t?$("#Entity .rotX").css("color","#08f"):$("#Entity .rotX").css("color","#3d3d3d"),$("#Entity .rotY").attr("disabled",!t),t?$("#Entity .rotY").css("color","#08f"):$("#Entity .rotY").css("color","#3d3d3d"),$("#Entity .rotZ").attr("disabled",!t),t?$("#Entity .rotZ").css("color","#08f"):$("#Entity .rotZ").css("color","#3d3d3d"),$("#Entity .scaleX").attr("disabled",!o),o?$("#Entity .scaleX").css("color","#08f"):$("#Entity .scaleX").css("color","#3d3d3d"),$("#Entity .scaleY").attr("disabled",!o),o?$("#Entity .scaleY").css("color","#08f"):$("#Entity .scaleY").css("color","#3d3d3d"),$("#Entity .scaleZ").attr("disabled",!o),o?$("#Entity .scaleZ").css("color","#08f"):$("#Entity .scaleZ").css("color","#3d3d3d")},Utils.GetObjectCenter=function(e){var t=new TONG.Vector3,o=e.geometry;return o.computeBoundingBox(),t.x=(o.boundingBox.max.x+o.boundingBox.min.x)/2,t.y=(o.boundingBox.max.y+o.boundingBox.min.y)/2,t.z=(o.boundingBox.max.z+o.boundingBox.min.z)/2,t},Utils.CovertJsonToObject=function(e){return(new TONG.ObjectLoader).parse(e,function(e){return e})},Utils.GetMeshSize=function(e){var t=new OBB;return t.setFromObject(e),t.size()},Utils.getGeometryScale=function(e,t){e.computeBoundingBox();var o=e.boundingBox;console.log(o),t.computeBoundingBox();var n=t.boundingBox;console.log(n)},Utils.SetPosistionOffsetInTarget=function(e,t){var o=new TONG.Vector3(e.getWorldPosition().x,e.getWorldPosition().y,e.getWorldPosition().z);t.worldToLocal(o)},Utils.SetTransformToTarget=function(e,t){Utils.SetPositionToTarget(e,t),Utils.SetRotationToTarget(e,t),Utils.SetScaleToTarget(e,t)},Utils.SetPositionToTarget=function(e,t){var o=t.getWorldPosition(),n=e.getWorldPosition(),r=new TONG.Vector3(o.x-n.x,o.y-n.y,o.z-n.z);e.position.set(e.position.x+r.x,e.position.y+r.y,e.position.z+r.z)},Utils.GetArrayMax=function(e){for(var t=e[0],o=1;o<e.length;o++)e[o]>t&&(t=e[o]);return t},Utils.SetRotationToTarget=function(e,t){var o=t.getWorldRotation(),n=e.getWorldRotation(),r=new TONG.Vector3(o.x-n.x,o.y-n.y,o.z-n.z);e.rotation.set(e.rotation.x+r.x,e.rotation.y+r.y,e.rotation.z+r.z)},Utils.SetScaleToTarget=function(e,t){var o=t.getWorldScale(),n=e.getWorldScale(),r=new TONG.Vector3(o.x/n.x,o.y/n.y,o.z/n.z);e.scale.x=e.scale.x*r.x,e.scale.y=e.scale.y*r.y,e.scale.z=e.scale.z*r.z},Utils.Trim=function(e){return e.replace(/(^\s*)|(\s*$)/g,"")},Utils.ChangeRenameId=function(e,t){return e&&(null==e.renameId?e.renameId=1:t?e.renameId++:0<e.renameId&&e.renameId--),0==e.renameId?"":e.renameId},Utils.GUID=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},Utils.RenameFunc=function(e,t,o,n){var r="",i=null;if(null!=t&&""!=Utils.Trim(t)){if(i=e instanceof Utils.Dictionary?e.get(t+""):e[t+""],null!=o&&""!=Utils.Trim(o)){var a=null;if(r=(a=e instanceof Utils.Dictionary?e.get(o+""):e[o+""])?o+"("+Utils.ChangeRenameId(a,!0)+")":o,null!=i){i.renameId=0;var s=i.renameRef;if(null!=s&&null!=s&&""!=s){var l=null;(l=e instanceof Utils.Dictionary?e.get(s+""):e[s+""])&&Utils.ChangeRenameId(l,!1)}i.renameRef=o+"";var c=JSON.stringify(i);delete(e instanceof Utils.Dictionary?e.data:e)[t+""],e instanceof Utils.Dictionary?e.put(r,JSON.parse(c)):e[r+""]=JSON.parse(c)}}}else null!=o&&""!=Utils.Trim(o)&&((i=e instanceof Utils.Dictionary?e.get(o+""):e[o+""])?(r=o+"("+Utils.ChangeRenameId(i,!0)+")",r=Utils.RenameFunc(e,"",r,!0)):r=o,n||(e instanceof Utils.Dictionary?(e.putDic(r,(new Utils.Dictionary).put("renameRef",o)),e.get(r).GUID=Utils.GUID()+""):(e[r+""]=(new Utils.Dictionary).put("renameRef",o).data,e[r+""].GUID=Utils.GUID()+"")));return r},Utils.Dictionary=function(e){this.data={},null!=e&&null!=e&&(this.data="string"==typeof e?JSON.parse(e):e),this.put=function(e,t){return this.data[e]=t,this},this.putDic=function(e,t){return this.data[e]=t.data,this},this.get=function(e){return this.data[e]},this.remove=function(e){return this.data[e]=null,this},this.isEmpty=function(){return 0==this.data.length},this.size=function(){return this.data.length},this.toJson=function(){return JSON.stringify(this.data)}},Utils.SetUIVerticalInterval=function(e,t,o){for(var n=e.dom.getElementsByClassName("Row"),r=0,i=1,a=1;a<n.length;)"none"!=n[a].style.display?(n[a].style.position="absolute",1==a?n[a].style.top=t+"px":(r=t+o*(i-1),n[a].style.top=r+"px"),a++,i++):a++;return r},Utils.IsEmptyObject=function(e){var t;for(t in e)return!1;return!0},Utils.DrawRect=function(e,t){var o=e?e/2:.5,n=t?t/2:.5,r=new TONG.LineBasicMaterial({color:16777215}),i=new TONG.Geometry;return i.vertices.push(new TONG.Vector3(-o,-n,0),new TONG.Vector3(o,-n,0),new TONG.Vector3(o,n,0),new TONG.Vector3(-o,n,0),new TONG.Vector3(-o,-n,0)),new TONG.Line(i,r)};var clickList={};Utils.OnClick=function(e,t,o,n,r,i){null!=o&&null!=o||(o=!1);var a=!1;null!=n&&(a=n);var s={state:a,isSetSelectState:o,callBack:t},l=e.dom.tagName.toLowerCase()+"#"+e.dom.id;clickList[l]=s,e.onClick(function(e){var t=e.target.tagName.toLowerCase()+"#"+e.target.id,o=clickList[t].state;if(clickList[t].state=!0,clickList[t].isSetSelectState&&(clickList[t].state=!o),clickList[t].state){if(clickList[t].isSetSelectState){var n="#1b75da";null!=i&&(n=i),$(e.target).css("background-color",n)}clickList[t].callBack(e,clickList[t].state)}else{if(clickList[t].isSetSelectState){n="#303030";null!=r&&(n=r),$(e.target).css("background-color",n)}clickList[t].callBack(e,clickList[t].state)}})},Utils.ObjectToArray=function(e){var t=[];for(var o in e)t.push(e[o]);return t};var startFuncList=[],isReady=!1;function ready(){isReady||(isReady=!isReady,$(document).ready(function(){for(var e=0;e<startFuncList.length;e++)startFuncList[e]()}))}Utils.OnStart={add:function(e){-1==startFuncList.indexOf(e)&&startFuncList.push(e),ready()},remove:function(e){-1!=startFuncList.indexOf(callBack)&&startFuncList.remove(callBack),ready()},clear:function(){startFuncList.clear(),ready()}},Utils.CopyArray=function(e){return e.concat()},Utils.CopyObject=function(e){if("object"!=typeof e)return e;var t={};for(var o in e)t[o]=Utils.CopyObject(e[o]);return t},Utils.IsContainsStr=function(e,t,o){return o&&(e=e.toLowerCase(),t=t.toLowerCase()),-1!=e.indexOf(t)};var mouseOverList={};Utils.OnMouseOver=function(e,t){var o={state:!1,callBack:t},n=e.dom.tagName.toLowerCase()+"#"+e.dom.id;mouseOverList[n]=o,e.onClick(function(e){var t=e.target.tagName.toLowerCase()+"#"+e.target.id,o=mouseOverList[t].state;mouseOverList[t].state=!o,mouseOverList[t].state,mouseOverList[t].callBack(e,mouseOverList[t].state)})},Utils.GetElementOffset=function(e){for(var t=e.offsetTop,o=e.offsetLeft,n=e.offsetWidth,r=e.offsetHeight-1;e=e.offsetParent;)t+=e.offsetTop,o+=e.offsetLeft;return{top:t,left:o,width:n,height:r}},Utils.SetUIInfo=function(e,t,o,n,r){e.setPosition("absolute"),e.setAttribute("data-row",t+""),e.setAttribute("data-col",o+""),e.setAttribute("data-sizex",n+""),e.setAttribute("data-sizey",r+"")},Utils.Loadimg=function(n,r,i,s){var l=0,c=0,e="[object Object]"===Object.prototype.toString.call(n);n=e?n.get():n;for(a in n){t(e?$(n[a]).attr("data-src"):n[a],n[a])}function t(e,t){var o=new Image;o.onload=function(){l++,r&&r(l,n.length,e,t),i&&l==n.length&&i(c)},o.onerror=function(){l++,c++,s&&s(l,n.length,e,t)},o.src=e}},Utils.JstreeEleRename=function(e,t,o,n){var r=Utils.JstreeGetNode(e,t,o,!0);return console.log(r),r.text=n,r},Utils.JstreeDeleteEleId=function(e,o,n){var r=null,i=null;Utils.JstreeRollDataArr(e,function(e){var t=e.id;return t==o?null==i&&(i=e):t==n&&(r=e),null!=r&&null!=i});for(var t=0;t<i.children.length;t++)if(i.children[t]==r){i.children.splice(t,1);break}return i},Utils.JstreeDeleteEleNode=function(e,t,o){var n=o,r=null;Utils.JstreeRollDataArr(e,function(e){return e.id==t&&null==r&&(r=e),null!=n&&null!=r});for(var i=0;i<r.children.length;i++)if(r.children[i]==n){r.children.splice(i,1);break}return r},Utils.JstreeDataSwap=function(e,o,n,r){var i=null,a=null,s=null;Utils.JstreeRollDataArr(e,function(e){var t=e.id;return t==n?null==a&&(a=e):t==o?i=e:t==r&&null==s&&(s=e),null!=i&&null!=a&&null!=s});for(var t=i,l=0;l<a.children.length;l++)if(a.children[l]==i){a.children.splice(l,1);break}t.parent_id=s.id;var c=Utils.CopyArray(s.route);return t.type==AssetsType.folder?c.push(t.text):c.push(t.text+"."+t.type),t.route=c,s.children.push(t),e},Utils.JstreeIsApplySubEle=function(e,o,n){return Utils.JstreeRollDataArr(e,function(e){if(e.id==o){var t=e.children;return Utils.JstreeRollDataArr(t,function(e){if(e.id==n)return e})}})},Utils.GetSameNameFileNode=function(e,o,n){return Utils.JstreeRollDataArr(e,function(e){if(e.text==o&&e.type==n.type){var t=e.rename;return t++,e.rename=t,e}})},Utils.JstreeGetNode=function(e,n,r,i){return null==i&&(i=!1),Utils.JstreeRollDataArr(e,function(e){if(n==e.id){var t=e.children;if(!i)return Utils.JstreeRollDataArr(t,function(e){if(e.text==r)return e});for(var o=0;o<t.length;o++)if(t[o].text==r)return t[o]}})},Utils.JstreeGetNodeFromId=function(e,t){return Utils.JstreeRollDataArr(e,function(e){if(e.id==t)return e})},Utils.JstreeRollDataArr=function(e,t){return function e(t,o){for(var n=0;n<t.length;n++){var r=t[n].children,i=o(t[n]);if(i)return i;if(0!=r.length){var a=e(r,o);if(a)return a}}}(e,t)};var fileBrowserEnv={},treeCurrentSelectArr=[],SetContentInfo=function(e,t,o,n,r,i,a,s){e.content_info.id=t,e.content_info.type=o,e.content_info.content=n,e.content_info.name=r,e.content_info.text=i,e.content_info.icon=a,e.content_info.route=s};Utils.GetCurrentFullTime=function(){var e=new Date,t=e.getFullYear(),o=e.getMonth()+1,n=e.getDate();e.getDay();return t+"-"+o+"-"+n+"   "+e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()},Utils.Panel={Row:function(e,t,o){var n=new UI.Row;return null!=t&&(n.dom.className=t),null!=o&&n.setId(o),null!=e?n.style(e):n.style("position:relative;padding-top:10px;padding-left:10px"),n},AddRowElement:function(e,t,o,n,r){return null!=n&&(t.dom.className=n),null==r&&t.setId(r),t.style(o+""),e.add(t),e},AddRowEleAbsolute:function(e,t,o,n,r,i,a,s,l){null!=o&&(t.dom.className=o),null==n&&t.setId(n);var c="10px";null!=r&&(c=r);var d="10px";null!=i&&(d=i);var u="";null!=s&&(u="color:"+s);var h="";null!=l&&(h="background-color:"+l);var f="font-size:12px";null!=a&&(f="font-size:"+a),t.position="absolute",t.style("left:"+c+";top:"+d+";"+u+";"+f+";"+h+";"),e.add(t)},AddRowEleRelative:function(e,t,o,n,r,i,a,s,l){null!=o&&(t.dom.className=o),null==n&&t.setId(n);var c="10px";null!=r&&(c=r);var d="10px";null!=i&&(d=i);var u="";null!=s&&(u="color:"+s);var h="";null!=l&&(h="background-color:"+l);var f="font-size:12px";null!=a&&(f="font-size:"+a),t.position="relative",t.style("padding-left:"+c+";padding-top:"+d+";"+u+";"+f+";"+h+";"),e.add(t)},AddHeader:function(e,t,o,n,r){var i="0px";null!=n&&(i=n);var a="#262626";null!=r&&(a="url("+r+") center no-repeat");var s=Utils.Panel.Row("position:relative;top:"+i+";left:0;right:0;height:33px;background-color:#262626;",e);return Utils.Panel.AddRowElement(s,new UI.Button(""),"position:absolute;left:10px;width:12px;height:33px;background:"+a+";"),Utils.Panel.AddRowElement(s,new UI.Button(""+t),"position:absolute;left:25px;height:33px;background-color:#262626",o),s}};var assetsAddCallBack=null,assetsDeleteCallBack=null,assetsFolderUpCallBack=null,searchAssetsCallBack=null,assetsListBtnCallBack=null,classificationTypeCallBack=null;Utils.AddAssets=function(e){assetsAddCallBack=e},Utils.AddAssets.Execute=function(e){null!=assetsAddCallBack&&assetsAddCallBack(e)},Utils.DeleteAssets=function(e){assetsDeleteCallBack=e},Utils.DeleteAssets.Execute=function(e){null!=assetsDeleteCallBack&&assetsDeleteCallBack(e)},Utils.FolderUpAssets=function(e){assetsFolderUpCallBack=e},Utils.FolderUpAssets.Execute=function(e){null!=assetsFolderUpCallBack&&assetsFolderUpCallBack(e)},Utils.SearchAssets=function(e){searchAssetsCallBack=e},Utils.SearchAssets.Execute=function(e){null!=searchAssetsCallBack&&searchAssetsCallBack(e)},Utils.ListBtnCallBack=function(e){assetsListBtnCallBack=e},Utils.ListBtnCallBack.Execute=function(e){null!=assetsListBtnCallBack&&assetsListBtnCallBack(e)},Utils.ClassificationCallBack=function(e){classificationTypeCallBack=e},Utils.ClassificationCallBack.Execute=function(e){null!=classificationTypeCallBack&&classificationTypeCallBack(e)};var hierarchyScrollLeftResult=null;Utils.GetHierarchyScrollLeftResult=function(){return hierarchyScrollLeftResult=null==hierarchyScrollLeftResult?$("#hierarchy").width():$("#hierarchy").width()+$("#outliner").scrollLeft()};var hierarchyScrollLeft=null;Utils.GetHierarchyScrollLeft=function(){return hierarchyScrollLeft=null==hierarchyScrollLeft?0:$("#outliner").scrollLeft()};var setScrollBarStyle=function(){$("#outliner").niceScroll({cursorborder:"",cursorcolor:"#202020"}),$("#outliner").scroll(function(e){$(".Outliner").children(".option").width(Utils.GetHierarchyScrollLeftResult())}),$("#Inspector .Content").niceScroll({cursorborder:"",horizrailenabled:!1,cursorcolor:"#202020"}),$("#Inspector .MatContent").niceScroll({cursorborder:"",horizrailenabled:!1,cursorcolor:"#202020"}),$("#Inspector .SettingContent").niceScroll({cursorborder:"",horizrailenabled:!1,cursorcolor:"#202020"}),$("#Inspector .Content").removeAttr("tabindex"),$("#Inspector .MatContent").removeAttr("tabindex"),$("#Inspector .SettingContent").removeAttr("tabindex")},tempHeight=0,tempWidth=0,editorRes=null,isEditorFullScreen=!1,firstFullScreen=!(Utils.Resize=function(e){editorRes=e,$(function(){function e(){if($(window).height()!=tempHeight||$(window).width()!=tempWidth)if(isEditorFullScreen)AppPlayer.setSize($("#viewport")[0].offsetWidth,$("#viewport")[0].offsetHeight);else{var e=$("#viewport").width(),t=$("#viewport").position().left;$("#project").css("bottom","0px"),$("#project")[0].style.height=null,$("#viewport").css("bottom",$("#project").height()+"px"),$("#player").css("bottom",$("#project").height()+"px");$("#hierarchy").width(),$("#toolManager").width();$("#Inspector").css("left",t+e+"px");var o=$("#project").height()-22;$("#script").css("bottom",o+22+"px"),tempHeight=$(window).height(),tempWidth=$(window).width(),AppPlayer.setSize($("#viewport")[0].offsetWidth,$("#viewport")[0].offsetHeight),InterfaceModule.lower_tabs_widget.onResize(),editorRes.signals.windowResize.dispatch()}}e(),$("#hierarchy").resizable({maxWidth:500,minWidth:300,handles:"e"}),$("#project").resizable({maxHeight:500,minHeight:180,handles:"n"}),$("#Inspector").resizable({maxWidth:500,minWidth:300,handles:"w"}),$(window).resize(e),$("#hierarchy").resize(function(){var e=$("#hierarchy").width()-2;$("#project").css("left",e+"px"),$("#viewport").css("left",e+"px"),$("#player").css("left",e+"px"),AppPlayer.setSize($("#player").width(),$("#player").height()),InterfaceModule.lower_tabs_widget.onResize(),$("#script").css("left",e+"px"),$("#toolManager").css("left",e+3+"px"),$("#outliner").width()<e?($("#outliner").width(e+"px"),$(".Outliner").children(".option").width(e+"px")):$(".Outliner").children(".option").width($("#outliner").width()+"px"),editorRes.signals.windowResize.dispatch(null,$("#viewport").height())}),$("#project").resize(function(){$("#project").height();$("#viewport").css("bottom",$("#project").height()+"px"),$("#player").css("bottom",$("#project").height()+"px"),AppPlayer.setSize($("#player").width(),$("#player").height()),$("#script").css("bottom",$("#project").height()+"px"),firstFullScreen=!0,InterfaceModule.lower_tabs_widget.onResize(),editorRes.signals.windowResize.dispatch(null,$("#viewport").height())}),$("#Inspector").resize(function(){var e=$("#Inspector").width()-2;$("#viewport").css("right",e+2+"px"),$("#player").css("right",e+2+"px"),AppPlayer.setSize($("#player").width(),$("#player").height()),$("#project").css("right",e+"px"),$("#script").css("right",e+"px"),$("#toolManager").css("right",e+"px"),$("#InspectorTypeSelectPanel").width(e+"px"),InterfaceModule.lower_tabs_widget.onResize(),editorRes.signals.windowResize.dispatch(null,$("#viewport").height())}),setScrollBarStyle()})}),EditorModule={name:"editor",icons_path:"imgs/components/",Debug:!(Utils.FullScreen=function(e,t){e?(isEditorFullScreen=firstFullScreen=!0,$("#Inspector").css("display","none"),$("#project").css("display","none"),$("#hierarchy").css("display","none"),$("#viewport").css("top","40px"),$("#viewport").css("left","0px"),$("#viewport").css("right","0px"),$("#viewport").css("bottom","20px"),$("#player").css("top","40px"),$("#player").css("left","0px"),$("#player").css("right","0px"),$("#player").css("bottom","20px"),AppPlayer.setSize($("#player").width(),$("#player").height()),$("#script").css("left","0px"),$("#script").css("right","0px"),$("#script").css("bottom","20px"),$("#toolManager").css("left","0px"),$("#toolManager").css("right","0px"),$("#searchHelpPanel").css("left","40%")):(isEditorFullScreen=!1,$("#Inspector").css("display",""),$("#project").css("display",""),$("#hierarchy").css("display",""),$("#project")[0].style.height=null,$("#Inspector").css("left",$("#project").width()+$("#hierarchy").width()+"px"),$("#viewport").css("left",$("#hierarchy").width()+"px"),$("#viewport").css("right",$("#Inspector").width()+"px"),$("#viewport").css("bottom",$("#project").height()+"px"),$("#toolManager").css("left",$("#hierarchy").width()+"px"),$("#toolManager").css("right",$("#Inspector").width()+"px"),$("#searchHelpPanel").css("left","510px"),$("#player").css("left",$("#hierarchy").width()+"px"),$("#player").css("right",$("#Inspector").width()+"px"),$("#player").css("bottom",$("#project").height()+"px"),AppPlayer.setSize($("#player").width(),$("#player").height()),EditorModule.viewport.setSize($("#viewport").width(),$("#viewport").height(),!0),$("#script").css("left",$("#hierarchy").width()+"px"),$("#script").css("right",$("#Inspector").width()+"px"),$("#script").css("bottom",$("#project").height()+"px"),InterfaceModule.lower_tabs_widget.onResize()),t.signals.windowResize.dispatch(null,$("#viewport").height())}),node_editors:[],material_editors:{},selected_data:null,mainmenu:new LiteGUI.Menubar("mainmenubar"),preferences_panel:[{name:"editor",title:"Editor",icon:null}],preferences:{autoselect:!1,autofocus:!0,save_on_exit:!1,reload_on_start:!0},globalTrigger:{},commands:{},canvas_widgets:{},target:null,viewport:null,registerCommands:function(){this.commands.set=this.setPropertyValueToSelectedNode.bind(this),this.commands.create=function(e,t){var o=EditorModule;switch(t[1]){case"node":o.createNullNode();break;case"light":o.createLightNode();break;case"plane":o.createPrimitive({geometry:LS.Components.GeometricPrimitive.PLANE,size:10,subdivisions:2},"plane");break;case"quad":o.createPrimitive({geometry:LS.Components.GeometricPrimitive.QUAD,size:10,subdivisions:2},"quad");break;case"cube":o.createPrimitive({geometry:LS.Components.GeometricPrimitive.CUBE,size:10,subdivisions:10},"cube");break;case"sphere":o.createPrimitive({geometry:LS.Components.GeometricPrimitive.SPHERE,size:10,subdivisions:32},"sphere");break;case"cylinder":o.createPrimitive({geometry:LS.Components.GeometricPrimitive.CYLINDER,size:10,subdivisions:32},"cylinder")}},this.commands.addComponent=function(e,t){EditorModule.addComponentToNode(SelectionModule.getSelectedNode(),t[1]),EditorModule.inspect(LS.GlobalScene.selected_node)},this.commands.selectNode=function(e,t){var o=LS.GlobalScene.getNode(t[1]);SelectionModule.setSelection(o)},this.commands.lights=function(e,t){var o=LS.GlobalScene._lights;o&&EditorModule.inspectObjects(o)},this.commands.cameras=function(e,t){var o=RenderModule.cameras;o&&EditorModule.inspectObjects(o)},this.commands.components=function(e,t){var o=LS.GlobalScene.findNodeComponents(t[1]);o&&o.length&&EditorModule.inspectObjects(o)},this.commands.focus=function(){EditorModule.focusCameraInSelection()},this.commands.frame=function(){EditorModule.focusCameraInAll()}},registerCanvasWidget:function(e){this.canvas_widgets[LS.getClassName(e)]=e},createMenuEntries:function(){var e=LiteGUI.menubar;function t(e){RenderModule.setRenderMode(e.value)}function o(e){return RenderModule.render_mode==e.value}e.add("Scene/Settings",{callback:function(){EditorModule.inspect(LS.GlobalScene)}}),e.separator("Edit"),e.add("Edit/Copy Node",{callback:function(){EditorModule.copyNodeToClipboard(SelectionModule.getSelectedNode())}}),e.add("Edit/Paste Node",{callback:function(){EditorModule.pasteNodeFromClipboard()}}),e.add("Edit/Clone Node",{callback:function(){EditorModule.cloneNode(SelectionModule.getSelectedNode())}}),e.add("Edit/Delete Node",{callback:function(){EditorModule.removeSelectedNodes()}}),e.add("Edit/Focus on node",{callback:function(){cameraTool.setFocusPointOnNode(SelectionModule.getSelectedNode(),!0)}}),e.add("Edit/Paste component",{callback:function(){EditorModule.pasteComponentInNode(SelectionModule.getSelectedNode())}}),e.add("Node/Create node",{callback:function(){EditorModule.createNullNode()}}),e.add("Node/Create camera",{callback:function(){EditorModule.createCameraNode()}}),e.add("Node/Create light",{callback:function(){EditorModule.createLightNode()}}),e.add("Node/Primitive/Plane",{callback:function(){EditorModule.createPrimitive({geometry:LS.Components.GeometricPrimitive.PLANE,size:10,subdivisions:10})}}),e.add("Node/Primitive/Quad",{callback:function(){EditorModule.createPrimitive({geometry:LS.Components.GeometricPrimitive.QUAD,size:10,subdivisions:10})}}),e.add("Node/Primitive/Cube",{callback:function(){EditorModule.createPrimitive({geometry:LS.Components.GeometricPrimitive.CUBE,size:10,subdivisions:10})}}),e.add("Node/Primitive/Sphere",{callback:function(){EditorModule.createPrimitive({geometry:LS.Components.GeometricPrimitive.SPHERE,size:10,subdivisions:32})}}),e.add("Node/Primitive/Cylinder",{callback:function(){EditorModule.createPrimitive({geometry:LS.Components.GeometricPrimitive.CYLINDER,size:10,subdivisions:32})}}),e.add("Node/Primitive/Hemisphere",{callback:function(){EditorModule.createPrimitive({geometry:LS.Components.GeometricPrimitive.HEMISPHERE,size:10,subdivisions:32})}}),e.add("Node/Templates/Sprite",{callback:function(){EditorModule.createTemplate("Sprite",[{component:"Sprite"}])}}),e.add("Node/Templates/ParticleEmissor",{callback:function(){EditorModule.createTemplate("Particles",[{component:"ParticleEmissor"}])}}),e.add("Node/Templates/MeshRenderer",{callback:function(){EditorModule.createTemplate("Mesh",[{component:"MeshRenderer"}])}}),e.add("Node/Add Component",{callback:function(){EditorModule.showAddComponentToNode(null,function(){EditorModule.refreshAttributes()})}}),e.add("Node/Add Material",{callback:function(){EditorModule.showAddMaterialToNode(null,function(){EditorModule.refreshAttributes()})}}),e.add("Node/Add Script",{callback:function(){CodingModule.onNewScript(),EditorModule.refreshAttributes()}}),e.add("Node/Create from JSON",{callback:function(){EditorModule.showCreateFromJSONDialog()}}),e.add("Node/Check JSON",{callback:function(){EditorModule.checkJSON(SelectionModule.getSelectedNode())}}),e.add("View/Layers",{callback:function(){EditorModule.showLayersEditor()}}),e.add("Actions/Reload Shaders",{callback:function(){LS.ShadersManager.reloadShaders(function(){RenderModule.requestFrame()})}}),e.add("View/Show All Gizmos",{instance:EditorModule.preferences,property:"render_all_gizmos",type:"checkbox"}),e.add("View/Render Settings",{callback:function(){EditorModule.showRenderSettingsDialog(RenderModule.render_settings)}}),e.add("View/Render Mode/Wireframe",{value:"wireframe",isChecked:o,callback:t}),e.add("View/Render Mode/Flat",{value:"flat",isChecked:o,callback:t}),e.add("View/Render Mode/Solid",{value:"solid",isChecked:o,callback:t}),e.add("View/Render Mode/Texture",{value:"texture",isChecked:o,callback:t}),e.add("View/Render Mode/Full",{value:"full",isChecked:o,callback:t})},registerNodeEditor:function(e){this.node_editors.push(e)},registerMaterialEditor:function(e,t){this.material_editors[e]=t},refreshAttributes:function(){this.inspector.instance&&this.inspect(this.inspector.instance)},updateInspector:function(e){this.inspector.update(e)},inspect:function(e,t){return t=t||this.inspector.componentWidgets,this.target.select(null),this.inspector.componentWidgets.clear(),this.inspector.showComponent(e,t)},refreshInspector:function(){this.inspector.refreshInspector(this.target.selected)},inspectObjects:function(e,t){return console.warn("Deprecated, use EditorModule.inspect() instead"),this.inspect(e,t)},inspectObject:function(e,t){return console.warn("Deprecated, use EditorModule.inspect() instead"),this.inspect(e,t)},inspectScene:function(e,t){return console.warn("Deprecated, use EditorModule.inspect() instead"),this.inspect(e,t)},inspectNode:function(e,t){return console.warn("Deprecated, use EditorModule.inspect() instead"),this.inspect(e,t)},inspectInDialog:function(e){if(e){var t=LS.getObjectClassName(e),o="dialog_inspector_"+(e.uid||e.name);if(!(n=document.getElementById("dialog_inspector_"+o))){var n,r=.8*$("#visor").height()|0;(n=new LiteGUI.Dialog({id:o,title:t,close:!0,minimize:!1,width:300,height:r,scroll:!0,resizable:!0,draggable:!0})).show("fade"),n.setPosition(50+10*Math.random()|0,50+10*Math.random()|0),n.on_close=function(){};var i=new InspectorWidget;i.inspector;return i.inspector.on_refresh=function(){i.inspect(e),n.adjustSize()},i.inspector.refresh(),n.add(i),n.adjustSize(),n}}},getInspectedInstance:function(){return this.inspector.instance},checkJSON:function(e){if(e){console.log(e);var t=window.open("","_blank");t.document.write("<style>* { margin: 0; padding: 0; } html,body { margin: 20px; background-color: #222; color: #eee; } </style>"),e.constructor===String&&(e=JSON.parse(e));var o=JSON.stringify(e.serialize?e.serialize():e,null,"\t"),n=beautifyJSON(o);t.document.write("<pre>"+n+"</pre>"),t.document.close()}},showAddPropertyDialog:function(e,t){t=t||["string","number","vec2","vec3","vec4","color","texture","node"];var o=Math.random().toString(),n=document.getElementById("dialog_inspector_"+o);(n=new LiteGUI.Dialog({id:"dialog_inspector_properties",title:"Properties",parent:"#visor",close:!0,minimize:!1,width:300,height:200,scroll:!0,resizable:!0,draggable:!0})).show("fade");var r={name:"myVar",type:"number",value:0,step:.1},i=new LiteGUI.Inspector;function a(){switch(i.clear(),i.addString("Name",r.name,{callback:function(e){r.name=e}}),i.addString("Label",r.label,{callback:function(e){r.label=e}}),i.addCombo("Type",r.type,{values:t,callback:function(e){r.type=e,i.refresh()}}),r.type){case"number":value=0,i.addNumber("Value",value,{callback:function(e){r.value=e}});break;case"vec2":value=vec2.fromValues(0,0),i.addVector2("Value",value,{callback:function(e){r.value[0]=e[0],r.value[1]=e[1]}});break;case"vec3":value=vec3.fromValues(0,0,0),i.addVector3("Value",value,{callback:function(e){r.value[0]=e[0],r.value[1]=e[1],r.value[2]=e[2]}});break;case"vec4":value=vec4.fromValues(0,0,0),i.addVector4("Value",value,{callback:function(e){r.value[0]=e[0],r.value[1]=e[1],r.value[2]=e[2],r.value[3]=e[3]}});break;case"color":value=vec3.fromValues(0,0,0),i.addColor("Value",value,{callback:function(e){r.value[0]=e[0],r.value[1]=e[1],r.value[2]=e[2]}});break;default:value="",i.add(r.type,"Value",value,{callback:function(e){r.value=e}})}r.value=value,"number"!=r.type&&"vec2"!=r.type&&"vec3"!=r.type||i.addNumber("Step",r.step,{callback:function(e){r.step=e}}),i.addButton(null,"Create",{callback:function(){e&&e(r),n.close()}})}(i.on_refresh=a)(),n.add(i),n.adjustSize()},showEditPropertiesDialog:function(n,t,r){t=t||["string","number","vec2","vec3","vec4","color","texture","enum"];var i=null,a={},s=new LiteGUI.Dialog({title:"Edit Properties",parent:"#visor",close:!0,minimize:!1,width:600,height:300,resizable:!0,draggable:!0});s.show();var e=new LiteGUI.Area;e.split("horizontal",["50%",null]),s.add(e);var o=new LiteGUI.Inspector;e.getSection(0).add(o),o.addTitle("Current properties");var l=o.addList(null,n,{height:230,callback:function(e){i=e.name,d()}});o.addButton(null,["Create property"],{callback:function(e){"Create property"==e&&LiteGUI.prompt("Name of property",function(e){if(e){if(a[e])return LiteGUI.alert("There is another var with the same name.");if(!EditorModule.isValidVarName(e))return LiteGUI.alert("Not a valid name for a var.");var t={name:e,type:"number",value:0,step:.1};n.push(t),l.setValue(n),i=t.name,d(),EditorModule.refreshAttributes()}})}});var c=new LiteGUI.Inspector;e.getSection(1).add(c);function d(){for(var e in a={},n)i||(i=n[e].name),a[n[e].name]=n[e];c.clear();var o=a[i];o&&(c.addString("Name",o.name,{callback:function(e){if(e){if(a[e])return LiteGUI.alert("There is another var with the same name.");if(!EditorModule.isValidVarName(e))return LiteGUI.alert("Not a valid name for a var.");o.name=e,i=e,l.setValue(n),d(),EditorModule.refreshAttributes()}}}),c.addString("Label",o.label||"",{callback:function(e){o.label=e}}),c.addCombo("Type",o.type,{values:t,callback:function(e){var t=!1;e!=o.value&&(o.type=e,t=!0),u(o,t),d(),EditorModule.refreshAttributes()}}),u(o),"number"==o.type&&c.addNumber("Step",o.step,{callback:function(e){o.step=e}}),c.addButton(null,"Close",{callback:function(){r&&r(n),s.close()}}))}function u(o,e){var t=o.type;"number"==t?(e&&(o.value=0),c.addNumber("Value",o.value,{step:o.step,callback:function(e){o.value=e}})):"vec2"==t?(e&&(o.value=vec2.fromValues(0,0)),c.addVector2("Value",o.value,{step:o.step,callback:function(e){o.value[0]=e[0],o.value[1]=e[1]}})):"vec3"==t?(e&&(o.value=vec3.fromValues(0,0,0)),c.addVector3("Value",o.value,{step:o.step,callback:function(e){o.value[0]=e[0],o.value[1]=e[1],o.value[2]=e[2]}})):"color"==t?(e&&(o.value=vec3.fromValues(0,0,0)),c.addColor("Value",o.value,{callback:function(e){o.value[0]=e[0],o.value[1]=e[1],o.value[2]=e[2]}})):"enum"==t?(e&&(o.value="",o.values=[]),c.addString("Options",o.values,{callback:function(e){if(e){var t=e.split(",");o.values=t,d()}}}),c.addCombo("Value",o.value,{values:o.values,callback:function(e){o.value=e}})):(e&&(o.value=""),c.add(o.type,"Value",o.value,{callback:function(e){o.value=e}}))}d()},isValidVarName:function(){var t=/^[$A-Z_][0-9A-Z_$]*$/i,e=["instanceof","typeof","break","do","new","var","case","else","return","void","catch","finally","continue","for","switch","while","this","with","debugger","function","throw","default","if","try","delete","in"],o={};for(var n in e)o[e[n]]=!0;return function(e){return t.test(e)&&!o[e]}}(),showResetDialog:function(){LiteGUI.confirm("Are you sure?",function(e){e&&EditorModule.resetEditor()})},showNodeInfo:function(t){var o=new LiteGUI.Dialog({id:"node_info",title:"Node Info",width:500,draggable:!0,closable:!0}),e=new LiteGUI.Inspector;e.addString("Name",t.name,function(e){t.name=e}),e.addString("UID",t.uid,function(e){t.uid=e}),e.addCheckbox("Visible",t.visible,function(e){t.flags.visible=e});var n={};if(t.__levents)for(var r in t.__levents)n[r]=t.__levents[r];e.addCombo("Binded Events",null,{values:n,callback:function(e){console.log(e)}}),e.addSeparator(),e.addButtons(null,["Show JSON","Close"],function(e){"Show JSON"==e?EditorModule.checkJSON(t):"Close"==e&&o.close()}),o.add(e),o.adjustSize(),o.show()},showLayersEditor:function(n,r){var t=LS.GlobalScene,o=new LiteGUI.Dialog({id:"layers_editor",title:"Layers editor",width:300,height:500,draggable:!0,closable:!0}),e=new LiteGUI.Inspector,i=e.startContainer();i.style.height="300px",i.style.overflow="auto",void 0!==n&&(e.widgets_per_row=2);for(var a=0;a<32;++a)e.addString(null,t.layer_names[a]||"layer"+a,{layer:a,width:void 0!==n?"80%":null,callback:function(e){t.layer_names[this.options.layer]=e}}),void 0!==n&&e.addCheckbox(null,1<<a&n,{layer:a,width:"20%",callback:function(e){var t=this.options.layer,o=1<<t;n&=~o,e&&(n|=o),r&&r(n,t,e)}});e.widgets_per_row=1,e.endContainer(),e.addButtons(null,["Close"],function(e){"Close"==e&&o.close()}),o.add(e),o.adjustSize(),o.show(),o.center()},showComponentInfo:function(t){var o=new LiteGUI.Dialog({id:"component_info",title:"Component Info",width:500,draggable:!0,closable:!0}),e=new LiteGUI.Inspector;e.addString("Class",LS.getObjectClassName(t),{disabled:!0}),void 0!==t.enabled&&e.addCheckbox("Enabled",t.enabled,function(e){t.enabled=e}),e.addString("UID",t.uid,function(e){t.uid=e});e.addString("Locator",t.getLocator(),{disabled:!0});t.onComponentInfo&&t.onComponentInfo(e);var n={};if(t.__levents)for(var r in t.__levents)n[r]=t.__levents[r];e.addCombo("Binded Events",null,{values:n,callback:function(e){console.log(e)}}),e.addSeparator(),e.addButtons(null,["Show JSON","Copy Component","Close"],function(e){"Show JSON"==e?EditorModule.checkJSON(t):"Close"==e?o.close():"Copy"==e&&EditorModule.copyComponentToClipboard(t)}),o.add(e),o.adjustSize(),o.show()},showRenderSettingsDialog:function(e){var t=new LiteGUI.Dialog({title:"Render Settings",width:400,draggable:!0,closable:!0}),o=new LiteGUI.Inspector({name_width:"50%"});o.showObjectFields(e),o.onchange=function(){LS.GlobalScene.refresh()},t.add(o),t.adjustSize(),t.show()},showRenderFrameContextDialog:function(e,t){var o=new LiteGUI.Dialog({title:"Render Context",width:400,draggable:!0,closable:!0}),n=new LiteGUI.Inspector({name_width:"50%"});n.showObjectFields(e),n.onchange=function(){t&&t(render_state),LS.GlobalScene.refresh()},o.add(n),o.adjustSize(),o.show()},showRenderStateDialog:function(e,t){var o=new LiteGUI.Dialog({title:"Render State",width:400,draggable:!0,closable:!0}),n=new LiteGUI.Inspector({name_width:"50%"});n.showObjectFields(e),n.onchange=function(){t&&t(e),LS.GlobalScene.refresh()},o.add(n),o.adjustSize(),o.show()},moveObject:function(e,t,o){null===o&&(o=void 0);var n=!1;e.traverse(function(e){e===t&&(n=!0)}),n||(editor.execute(new MoveObjectCommand(e,t,o)),editor.signals.sceneGraphChanged.dispatch())},onDropOnScene:function(e,t,o){var n=!1;if("resource"==o.dataTransfer.getData("type")){var r=o.dataTransfer.getData("res-fullpath");n=this.onDropResourceOnScene(r,e,t,o)}return n},onDropResourceOnScene:function(e,t,o,n){var r=TONG.ResourcesManager.getResource(e);r?a(r):TONG.ResourcesManager.load(e,a),n.stopPropagation();var i=TONG.RM.getExtension(e);if("js"==i||"json"==i)return!0;function a(e){e?e.assignToScene?e.assignToScene(t,o):console.warn("Resource type has no assignToNode method: "+TONG.getObjectClassName(e)):console.warn("No resource")}},onDropOnNode:function(e,t){if(e){var o=!1,n=t.dataTransfer.getData("uid"),r=t.dataTransfer.getData("type"),i=null;if("SceneNode"==r?i=EditorModule.target.objectByUuid(n):"Component"==r?i=TONG.GlobalScene.findComponentByUId(n):"Material"==r&&(i=TONG.GlobalScene.findMaterialByUId(n)),i&&i instanceof TONG.Object3D&&e!=i&&(this.moveObject(i,e,null),console.log("Change parent"),o=!0),i&&i.constructor.is_component){var a=i;if(e!=a.root){if(t.shiftKey){var s=a.clone();e.addComponent(s),console.log("Component cloned")}else a.root.removeComponent(a),e.addComponent(a),console.log("Component moved");o=!0}}if(i&&i.constructor.is_material){var l=i;if(l._root){var c=l.clone();e.material=c,console.log("Material cloned")}else e.material=l.uid,console.log("Material assigned");o=!0}if("resource"==r){var d=t.dataTransfer.getData("res-fullpath");o=this.onDropResourceOnNode(d,e,t)}return t.dataTransfer.files&&t.dataTransfer.files.length&&(o=ImporterModule.onItemDrop(t,{node:e})),EditorModule.refreshAttributes(),o}},onDropResourceOnNode:function(e,t,o){var n=TONG.ResourcesManager.getResource(e);n?i(n):TONG.ResourcesManager.load(e,i),o.stopPropagation();var r=TONG.RM.getExtension(e);if("js"==r||"json"==r)return!0;function i(e){e?e.assignToNode?e.assignToNode(t):console.warn("Resource type has no assignToNode method: "+TONG.getObjectClassName(e)):console.warn("No resource")}},resetEditor:function(){LS.GlobalScene.clear(),LS.ResourcesManager.reset(),LEvent.trigger(this,"resetEditor"),InterfaceModule.setStatusBar()},copyNodeToClipboard:function(e){if(e){var t=e.serialize();t.uid=null,t._object_class=LS.getObjectClassName(e),LiteGUI.toClipboard(t)}},pasteNodeFromClipboard:function(e){var t=LiteGUI.getLocalClipboard();if(t&&"SceneNode"==t.object_class){t.uuid=null;var o=new LS.SceneNode;o.configure(t),(e=e||LS.GlobalScene.root).addChild(o),SelectionModule.setSelection(o),EditorModule.inspect(LS.GlobalScene.selected_node)}},copyComponentToClipboard:function(e){var t=e.serialize();t.object_class=e.className,t.uuid=null,LiteGUI.toClipboard(t)},pasteComponentFromClipboard:function(e){var t=LiteGUI.getLocalClipboard();if(t){t.uuid=TONG.Math.generateUUID();var o=(new TONG.Component).configure(t);e.root.addComponent(o)==o&&this.inspector.refreshInspector(e.root),EditorModule.target.execute(new AddComponentCommand(e.root,o))}},pasteComponentInNode:function(e){CORE.userAction("node_changed",e);var t=LiteGUI.getLocalClipboard();if(t&&t._object_class){t.uid=null;var o=new LS.Components[t._object_class];e.addComponent(o),o.configure(t),EditorModule.inspect(e),RenderModule.requestFrame()}},resetNodeComponent:function(e){CORE.userAction("component_changed",e),e.reset?e.reset():e.configure((new(LS.Components[LS.getObjectClassName(e)])).serialize()),LiteGUI.trigger(e,"changed"),EditorModule.inspect(LS.GlobalScene.selected_node)},shareNodeComponent:function(i){DriveModule.showSelectFolderFilenameDialog("component.COMP.json",function(e,t,o){var n=i.serialize();n.object_class=LS.getObjectClassName(i),n.is_data=!0,delete n.uid;var r=new LS.Resource;r.category=LS.TYPES.COMPONENT,r.setData(JSON.stringify(n)),r.filename=t,r.fullpath=o,LS.RM.registerResource(o,r),DriveModule.saveResource(r)},{extension:"json",allow_no_folder:!0})},deleteNodeComponent:function(e){var t=e._root;t&&0!=t.removeComponent(e)&&(this.inspector.refreshInspector(t),EditorModule.target.execute(new RemoveComponentCommand(t,e)))},deleteNode:function(e){e&&e.parentNode&&(CORE.userAction("node_deleted",e),e.parentNode.removeChild(e),EditorModule.inspect(),RenderModule.requestFrame())},loadAndSetTexture:function(t,o,n,e){if(!e){if(LS.ResourcesManager.textures[n])return void(t[o]=n);e=n}var r=new Image;r.type="IMG",r.onload=function(e){r.onload=null;LS.ResourcesManager.processImage(n,r);t[o]=n},r.src=e},cloneNode:function(e,t,o){if(e){var n=e.clone(),r=LS.GlobalScene.root,i=void 0;return t&&(i=(r=e.parentNode)._children.indexOf(e)+1),r.addChild(n,i),o||CORE.userAction("node_created",n),n}},cloneNodeMaterial:function(e,t){var o=e.getMaterial();delete(o=o.clone()).filename,delete o.fullpath,e.material=o,t||CORE.userAction("node_created",e)},removeSelectedNodes:function(){SelectionModule.removeSelectedInstances()},pasteComponent:function(e){},getAddRootNode:function(){return LS.GlobalScene.root},updateCreatedNodePosition:function(e){var t=RenderModule.getActiveCamera();e.transform.position=t.getCenter()},setPropertyValueToSelectedNode:function(e,t){var o=SelectionModule.getSelectedNode();if(o){CORE.userAction("node_changed",o);var n=t[2];isNaN(n)?"true"==n||"false"==n?n="true"==n:"null"==n&&(n=null):n=parseFloat(n);o.setPropertyValue(t[1],n);EditorModule.refreshAttributes(),RenderModule.requestFrame()}},createGraph:function(){var e=new LS.Components.GraphComponent,t=SelectionModule.getSelectedNode()||LS.GlobalScene.root;CORE.userAction("node_changed",t),t.addComponent(e),EditorModule.refreshAttributes(),RenderModule.requestFrame(),GraphModule.editInstanceGraph(e,null,!0)},createNullNode:function(e){var t=new LS.SceneNode(LS.GlobalScene.generateUniqueNodeName("node"));return t.material=null,(e=e||EditorModule.getAddRootNode()).addChild(t),EditorModule.updateCreatedNodePosition(t),CORE.userAction("node_created",t),SelectionModule.setSelection(t),t},createNodeWithMesh:function(e,t){var o=new LS.SceneNode(LS.GlobalScene.generateUniqueNodeName("mesh"));return o.material=new LS.StandardMaterial,o.setMesh(e),EditorModule.getAddRootNode().addChild(o),EditorModule.updateCreatedNodePosition(o),CORE.userAction("node_created",o),SelectionModule.setSelection(o),LS.ResourcesManager.load(e,t),o},createCameraNode:function(){var e=RenderModule.getActiveCamera(),t=new LS.SceneNode(LS.GlobalScene.generateUniqueNodeName("camera")),o=new LS.Camera(e);return o.resetVectors(),t.addComponent(o),o.lookAt(e.getEye(),e.getCenter(),e.up),EditorModule.getAddRootNode().addChild(t),CORE.userAction("node_created",t),SelectionModule.setSelection(t),t},createLightNode:function(){var e=new LS.SceneNode(LS.GlobalScene.generateUniqueNodeName("light"));return e.addComponent(new LS.Light),EditorModule.getAddRootNode().addChild(e),EditorModule.updateCreatedNodePosition(e),CORE.userAction("node_created",e),SelectionModule.setSelection(e),e},createPrimitive:function(e,t){var o=new LS.SceneNode(LS.GlobalScene.generateUniqueNodeName(t||"primitive"));return o.addComponent(new LS.Components.GeometricPrimitive(e)),EditorModule.getAddRootNode().addChild(o),EditorModule.updateCreatedNodePosition(o),CORE.userAction("node_created",o),SelectionModule.setSelection(o),o},createTemplate:function(e,t){var o=new LS.SceneNode(LS.GlobalScene.generateUniqueNodeName(e));for(var n in t){var r=t[n].component;r.constructor===String&&(r=LS.Components[r]);var i=new r(t[n].data);o.addComponent(i)}return EditorModule.getAddRootNode().addChild(o),EditorModule.updateCreatedNodePosition(o),CORE.userAction("node_created",o),SelectionModule.setSelection(o),o},addMaterialToNode:function(){var e=SelectionModule.getSelectedNode();e&&!LS.GlobalScene.selected_node.material&&(e.material=new LS.StandardMaterial,EditorModule.refreshAttributes(),RenderModule.requestFrame())},addComponentToNode:function(e,t){e&&(TONG.Components[t]?(e.addComponent(new TONG.Components[t]),EditorModule.refreshAttributes()):console.log("No component found with name: ",t))},showCreateResource:function(o,n,r,e){e=e||{},r=r||"json",LiteGUI.prompt(e.title||"Resource name",function(e){if(e=e.replace(/ /gi,"_"),!o.filename){o.id=null;var t=o.name=e;LS.RM.getExtension(t)!=r&&(t=e+"."+r),o.filename=t}LS.ResourcesManager.registerResource(o.filename,o),n&&n(o.filename,o)},{value:e.value})},showCanvasContextMenu:function(n,e){var t=[{title:"View",has_submenu:!0},{title:"Create",has_submenu:!0},{title:"Widgets",has_submenu:!0}],r=null;if(n)if(t.push(null),n.constructor===LS.SceneNode)t.push({title:"Node",has_submenu:!0});else if(n.constructor.is_component)r=LS.getObjectClassName(n),t.push({title:r,has_submenu:!0});else{var o=null;if(n.getActions?o=n.getActions():n.constructor.getActions&&(o=n.constructor.getActions()),o)for(var i in t.push(null),o)t.push(o[i])}var a=new LiteGUI.ContextMenu(t,{ignore_item_callbacks:!0,event:e,title:"Canvas",autoopen:!1,callback:function(e,t,o){return"View"==e.title?(RenderModule.getViewportUnderMouse(o).showContextMenu(o,a),!0):"Node"==e.title?(EditorModule.showNodeContextMenu(n,o,a),!0):"Create"==e.title?(EditorModule.showCreateContextMenu(n,o,a),!0):"Widgets"==e.title?(EditorModule.showCanvasWidgetsContextMenu(n,o,a),!0):e.title&&e.title==r?(EditorModule.showComponentContextMenu(n,o,a),!0):void(n&&(n.doAction?n.doAction(e):n.constructor.doAction&&n.constructor.doAction(e)))}})},showInstanceContextMenu:function(n,t){if(n){var o=[];if(n.constructor===LS.SceneNode)return this.showNodeContextMenu(n,t);if(n.constructor.is_component)return this.showComponentContextMenu(n,e,a);var r=null;if(n.getActions?r=n.getActions():n.constructor.getActions&&(r=n.constructor.getActions()),r)for(var i in o.push(null),r)o.push(r[i]);if(o.length)var a=new LiteGUI.ContextMenu(o,{title:null,ignore_item_callbacks:!0,event:t,callback:function(e,t,o){n&&(n.doAction?n.doAction(e):n.constructor.doAction&&n.constructor.doAction(e))}})}},showNodeContextMenu:function(i,e,t){if(i&&i.constructor===LS.SceneNode&&i.getActions){var o=i.getActions(),n=[];if(o)for(var r in o)n.push(o[r]);i._components&&i._components.length&&n.unshift({title:"Components",has_submenu:!0,show_components:!0},null);var a=new LiteGUI.ContextMenu(n,{ignore_item_callbacks:!0,event:e,title:"Node",parentMenu:t,callback:function(e,t,o){e.show_components?function(e){for(var t=[],o=0;o<i._components.length;++o){var n=i._components[o];t.push({title:LS.getObjectClassName(n),component:n,has_submenu:!0,index:o})}var r=new LiteGUI.ContextMenu(t,{event:e,title:"Node",parentMenu:a,callback:function(e,t,o){EditorModule.showComponentContextMenu(e.component,o,r)}})}(o):i.doAction(e)}})}},showComponentContextMenu:function(n,e,t){if(n&&n.constructor.is_component){var o=LS.Component.getActions(n);if(o){var r=LS.getObjectClassName(n),i=new LiteGUI.ContextMenu(o,{ignore_item_callbacks:!0,event:e,parentMenu:t,title:LS.getObjectClassName(n),callback:function(e,t,o){LS.Component.doAction(n,e),LS.GlobalScene.requestFrame(),EditorModule.refreshAttributes()}}),a=(r=i.root.querySelector(".litemenu-title"),EditorModule.getComponentIconHTML(n));return r.insertBefore(a,r.firstChild),i}}},showCreateContextMenu:function(e,t,o){var n=EditorView._canvas_event||t;GL.augmentEvent(n);var r=RenderModule.testGridCollision(n.canvasx,n.canvasy);new LiteGUI.ContextMenu(["SceneNode","Light","Camera","Graph"],{event:t,title:"Create",parentMenu:o,callback:function(e){var t=null;"SceneNode"==e?t=EditorModule.createNullNode():"Light"==e&&(t=EditorModule.createLightNode()),"Camera"==e&&(t=EditorModule.createCameraNode()),"Graph"==e&&(t=EditorModule.createGraph()),t&&r&&(t.transform.position=r),LS.GlobalScene.refresh()}})},showCanvasWidgetsContextMenu:function(e,t,o){var n=this,r=[];for(var i in this.canvas_widgets){this.canvas_widgets[i];r.push(i)}if(r.length)new LiteGUI.ContextMenu(r,{event:t,title:"Canvas Widgets",parentMenu:o,callback:function(e){var t=n.canvas_widgets[e];if(t){var o=new t;RenderModule.canvas_manager.root.addChild(o),LS.GlobalScene.refresh()}}})},showSelectSceneCameraContextMenu:function(e,t,o){for(var n=[],r=LS.GlobalScene.getAllCameras(),i=0;i<r.length;i++){var a=r[i];n.push({title:"Cam "+a._root.name,camera:a})}new LiteGUI.ContextMenu(n,{event:e,title:"Cameras",parentMenu:t,callback:function(e){o&&o(e.camera)}})},showAddMaterialToNode:function(t,o,n){if(t=EditorModule.target.selected){var r=new LiteGUI.Dialog({id:"dialog_materials",title:GetLanguage("Materials"),close:!0,minimize:!1,width:400,scroll:!1,draggable:!0});r.show("fade");var i=null,a=null,s=[];for(var e in s.push({first:!0,icon:null,ctor:new TONG.NoneMaterial,name:"None"}),TONG.MaterialClasses)if(TONG.MaterialClasses[e].is_material&&(TONG.MaterialClasses[e]instanceof TONG.Material||!(new TONG.MaterialClasses[e]instanceof TONG.ShaderMaterial))){var l=TONG.MaterialClasses[e]instanceof TONG.Material?TONG.MaterialClasses[e]:new TONG.MaterialClasses[e],c=l.icon?l.icon:TONG.MaterialClasses[e]instanceof TONG.Material?"mini-icon-materialres.png":"system_mat.png";s.push({icon:EditorModule.icons_path+c,ctor:TONG.MaterialClasses[e],name:e})}var d="",u=new LiteGUI.Inspector;u.addString(GetLanguage("Filter"),d,{callback:function(e){for(var t in d=e,(s=[]).push({first:!0,icon:null,ctor:new TONG.NoneMaterial,name:"None"}),TONG.MaterialClasses)if(TONG.MaterialClasses[t].is_material&&(TONG.MaterialClasses[t]instanceof TONG.Material||!(new TONG.MaterialClasses[t]instanceof TONG.ShaderMaterial))){var o=TONG.MaterialClasses[t]instanceof TONG.Material?TONG.MaterialClasses[t]:new TONG.MaterialClasses[t],n=t;if(-1!=n.indexOf(d)){var r=o.icon?o.icon:TONG.MaterialClasses[t]instanceof TONG.Material?"mini-icon-materialres.png":"system_mat.png";s.push({icon:EditorModule.icons_path+r,ctor:TONG.MaterialClasses[t],name:n})}}a.updateItems(s)}}),a=u.addList(null,s,{height:340,callback:function(e){i=e},callback_dblclick:function(e){i=e,h()}}),u.widgets_per_row=1,u.addButton(null,"Add",{callback:function(){h()}}),r.add(u),r.adjustSize(),document.body.appendChild(r.root)}else LiteGUI.alert("You must select a node to attach a material");function h(){if(!t||!i)return o&&o(null),void r.close();var e=i.ctor instanceof TONG.Material?i.ctor:new i.ctor;n||(CORE.userAction("node_material_assigned",t,e),t.material=e,CORE.afterUserAction("node_material_assigned",t,e)),r.close(),o&&o(e)}},showAddResourceToNode:function(t,o,n,e){var r=new LiteGUI.Dialog({id:"dialog_components",title:""+(Array.isArray(n)&&"string"!=typeof n?n[0]:n),close:!0,minimize:!1,width:400,scroll:!1,draggable:!0});r.show("fade");var i=new LiteGUI.Inspector,a=null,s=null,l=[];if(l.push({first:!0,icon:null,ctor:null,name:"None"}),e&&l.push({first:!0,icon:Resource.icons[e.resource_type],ctor:systemResource,name:e.filename}),Array.isArray(n))for(var c=0;c<n.length;c++)d(n[c]);else d(n);function d(e){for(var t=TONG.RM.getResourceByType(e),o=0;o<t.length;o++){var n=t[o];n instanceof TONG.Texture&&(n.icon=n._original_data);var r=n.icon?n.icon:Resource.icons[e];l.push({icon:r,ctor:n,name:n.filename})}}var u="";i.addString(GetLanguage("Filter"),u,{focus:!0,immediate:!0,callback:function(e){if(u=e.toLowerCase(),(l=[]).push({first:!0,icon:null,ctor:null,name:"None"}),Array.isArray(n))for(var t=0;t<n.length;t++)d(n[t]);else d(n);s.updateItems(l)}});l.sort(function(e,t){return e.first?-1:e.name<t.name?-1:e.name>t.name?1:0}),s=i.addList(null,l,{height:340,callback:function(e){a=e},callback_dblclick:function(e){a=e,f()}}),i.widgets_per_row=1;var h=s.querySelectorAll(".icon");for(c=0;c<h.length;c++)h[c].onerror=function(){this.src="imgs/mini-icon-question.png"};function f(){if(!a)return r.close(),void(o&&o());if(t){if(t.addComponent)(e=a.ctor)instanceof TONG.Script&&(e=e.getCompileScript()),t.addComponent(e),CORE.userAction("component_created",e),r.close(),o&&o(e)}else{r.close();var e=a.ctor;o&&o(e)}}i.addButton(null,"Add",{callback:f}),r.add(i),r.center(),document.body.appendChild(r.root)},showAddComponentToNode:function(i,t){if((i=i||this.inspector.instance)&&i instanceof TONG.Object3D){var o=new LiteGUI.Dialog({id:"dialog_components",title:GetLanguage("Components"),close:!0,minimize:!1,width:400,scroll:!1,draggable:!0});o.show("fade");var n=null,a=null,s=[];for(var e in TONG.Components)if(TONG.Components[e].is_component||TONG.Components[e]instanceof TONG.Component){var r=TONG.Components[e]instanceof TONG.Component?TONG.Components[e]:new TONG.Components[e](i);s.push({icon:r.icon,ctor:r,name:e})}var l="",c=new LiteGUI.Inspector;c.addString(GetLanguage("Filter"),l,{focus:!0,immediate:!0,callback:function(e){for(var t in l=e.toLowerCase(),s=[],TONG.Components)if(TONG.Components[t].is_component||TONG.Components[t]instanceof TONG.Component){var o=TONG.Components[t]instanceof TONG.Component?TONG.Components[t]:new TONG.Components[t](i),n=t;if(-1!=n.toLowerCase().indexOf(l)){var r={ctor:o,name:n};o.icon&&(r.icon=o.icon),s.push(r)}}a.updateItems(s)}});s.sort(function(e,t){return e.name<t.name?-1:e.name>t.name?1:0}),a=c.addList(null,s,{height:340,callback:function(e){n=e},callback_dblclick:function(e){n=e,u()}}),c.widgets_per_row=1;var d=a.querySelectorAll(".icon");for(e=0;e<d.length;e++)d[e].onerror=function(){this.src="imgs/mini-icon-question.png"};c.addButton(null,"Add",{callback:u}),o.add(c),o.center(),document.body.appendChild(o.root)}else LiteGUI.alert("You must select a node to attach a component");function u(){if(!i||!n)return o.close(),void(t&&t());if(i.addComponent){var e=n.ctor;e instanceof TONG.Script&&(e=e.getCompileScript()),null!=e&&(EditorModule.target.execute(new AddComponentCommand(i,e)),CORE.userAction("component_created",e),o.close(),t&&t(e))}}},showSelectResource:function(o){var n=new LiteGUI.Dialog({id:"select-resource-dialog",title:"Select resource",close:!0,width:800,height:500,scroll:!1,resizable:!0,draggable:!0}),e=new ResourcesPanelWidget(null,{skip_actions:!0});return o.type&&e.filterByCategory(o.type),e.showMemoryResources(),LiteGUI.bind(e,"resource_selected",function(e){var t=e.detail;o.allow_multiple&&e&&e.shiftKey||n.close();o.on_complete&&o.on_complete(t);t&&!o.skip_load&&LS.ResourcesManager.load(t,null,o.on_load);return!0}),n.add(e),n.show(),n},showSelectNode:function(e,t){var o=t.type,n=t.value,r=new LiteGUI.Dialog({id:"dialog_components",title:t.title||"Select node",close:!0,minimize:!1,width:400,resizable:!1,scroll:!1,draggable:!0});r.show(null,this.root),document.body.appendChild(r.root);var i=EditorModule.target.scene,a=null,s=t&&t.selected?t.selected:null,l=[{name:"None",node:n}];i.traverse(function(e){0,o&&e instanceof o.constructor&&l.push({name:e.name,node:e})});var c=new LiteGUI.Inspector({height:"100%",noscroll:!0});function d(){s?(r.close(),e&&e(s.node)):r.close()}c.addString(GetLanguage("Filter"),"",{focus:!0,immediate:!0,callback:function(o){a.filter(function(e,t){return!o||-1!=t.innerHTML.toLowerCase().indexOf(o.toLowerCase())})}}),a=c.addList(null,l,{height:340,callback:function(e){s=e},callback_dblclick:function(e){s=e,d()}}),c.widgets_per_row=1,c.addButton(null,"Add",{callback:d}),r.add(c)},showSelectComponent:function(i,o,e,t){var n=new LiteGUI.Dialog({id:"dialog_component",title:"Select Component "+(o?"("+o+")":""),close:!0,minimize:!1,width:400,scroll:!1,draggable:!0});n.show("fade"),document.body.appendChild(n.root);i&&i._root;var r=EditorModule.target.scene;o&&TONG.Components[o];var a=[];r.traverse(function(e){if(0!=e.getComponents(o).length){var t={name:e.name,node:e};EditorModule.target.selected==e&&(t.selected=!0),a.push(t)}});var s=new LiteGUI.Inspector;s.addString(GetLanguage("Filter"),"",{focus:!0,immediate:!0,callback:function(o){l.filter(function(e,t){return!o||-1!=t.innerHTML.toLowerCase().indexOf(o.toLowerCase())})}});var l=s.addList(null,a,{height:340,callback:function(e){if(!e)return;var t=e.node.getComponents();c=[];for(var o=0;o<t.length;o++){var n=t[o],r=n.title;r&&i&&i.title!=r||(d=n,console.log(d),c.push({name:r,uuid:n.uuid,component:n}))}},callback_dblclick:function(e){u()}}),c=[];s.addButton(null,"Add",{callback:u}),n.add(s);var d=null;function u(){d?(console.log(d),n.close(),e&&e.call(t||this,d)):n.close()}},showCreateFromJSONDialog:function(){var n=new LiteGUI.Dialog({title:"from JSON",close:!0,minimize:!1,width:400,height:620,scroll:!1,draggable:!0});n.show("fade");var e=new LiteGUI.Inspector;n.add(e);var r=null;e.addInfo(null,"Paste a JSON code of a node here."),e.addTextarea(null,"",{height:500,callback:function(e){try{r=JSON.parse(e)}catch(e){LiteGUI.alert("There are errors in the JSON")}}}),e.addButton(null,"Create",function(e){if(r){var t=null;if(r.components)(t=new LS.SceneNode).configure(r),EditorModule.getAddRootNode().addChild(t);else if(r.object_class&&LS.Components[r.object_class]){t=SelectionModule.getSelectedNode();var o=new LS.Components[r.object_class];o.configure(r),t.addComponent(o)}LS.GlobalScene.requestFrame(),n.close()}}),n.adjustSize(10)},getComponentIconHTML:function(n){LiteGUI.missing_icons||(LiteGUI.missing_icons={});var e="mini-icon-question.png";n.constructor.icon&&!LiteGUI.missing_icons[n.constructor.icon]&&(e=n.constructor.icon);var t=document.createElement("span");t.className="icon",t.style.width="20px",t.setAttribute("draggable",!0),t.innerHTML="<img title='Drag icon to transfer' src='"+EditorModule.icons_path+e+"'/>",t.addEventListener("dragstart",function(e){if(e.dataTransfer.setData("uid",n.uid),!n.root)return!1;var t,o=LS.getObjectClassName(n);t=e.shiftKey?n.getLocator():n.root.name+"/"+o,e.dataTransfer.setData("locator",t),e.dataTransfer.setData("type","Component"),e.dataTransfer.setData("node_uid",n.root.uid),e.dataTransfer.setData("class",o),n.setDragData&&n.setDragData(e)}),t.addEventListener("click",function(e){SelectionModule.setSelection(n),e.stopPropagation(),e.stopImmediatePropagation()});var o=t.querySelector(".icon img");return o&&(o.onerror=function(){LiteGUI.missing_icons[n.constructor.icon]=!0,this.src="imgs/mini-icon-question.png",this.onerror=null}),t},centerCameraInSelection:function(){var e=SelectionModule.getSelectionCenter();e=e||vec3.create(),cameraTool.setFocusPoint(e),RenderModule.requestFrame()},focusCameraInBoundingBox:function(e){var t=BBox.getRadius(e),o=BBox.getCenter(e);cameraTool.setFocusPoint(o,2*t),RenderModule.requestFrame()},focusCameraInSelection:function(){var e=SelectionModule.getSelectedNode();if(e){var t=e.getBoundingBox();this.focusCameraInBoundingBox(t)}},focusCameraInPixel:function(e){var t=ToolUtils.getCamera(e),o=t.getRayInPixel(e.canvasx,e.canvasy),n=LS.Picking.getInstanceAtCanvasPosition(e.canvasx,e.canvasy,t);if(!n||n.constructor!==LS.SceneNode)return!1;var r=n,i=LS.Physics.raycastNode(o.origin,o.direction,r,{triangle_collision:!0});if(i&&0!=i.length){var a=vec3.distance(i[0].position,o.origin);cameraTool.setFocusPoint(i[0].position,a),RenderModule.requestFrame()}},focusCameraInAll:function(){var e=BBox.create(),t=LS.GlobalScene._instances;if(t)for(var o=0;o<t.length;++o)0==o?e.set(t[o].aabb):BBox.merge(e,e,t[o].aabb);for(o=0;o<LS.GlobalScene._nodes.length;++o){var n=LS.GlobalScene._nodes[o];if(n.transform){var r=n.transform.getGlobalPosition();BBox.extendToPoint(e,r)}}this.focusCameraInBoundingBox(e)},globalKeyDown:function(e){var t=e.target.nodeName.toLowerCase();if("input"!==t&&"textarea"!==t&&"select"!==t){if(LiteGUI.focus_widget&&LiteGUI.focus_widget.onKeyDown)if(LiteGUI.focus_widget.onKeyDown(e))return;var o=LiteGUI.main_tabs.current_tab[2];if(o){var n=o.module;return n&&n.onKeyDown?n.onKeyDown(e):void 0}}},onKeyDown:function(e){switch(e.keyCode){case 83:e.ctrlKey&&(SceneStorageModule.fastSaveScene(),e.preventDefault(),e.stopPropagation());break;case 70:e.shiftKey?EditorModule.focusCameraInAll():EditorModule.focusCameraInSelection();break;case 80:return e.ctrlKey&&PlayModule.onPlay(),e.preventDefault(),e.stopPropagation(),!1;case 9:InterfaceModule.toggleInspectorTab();break;case 8:case 46:return e.preventDefault(),e.stopPropagation(),EditorModule.removeSelectedNodes(),!1;case 116:if(EditorModule.preferences.save_on_exit&&SceneStorageModule.saveLocalScene("last",{},LS.GlobalScene,SceneStorageModule.takeScreenshot(256,256)),EditorModule.preferences.save_on_exit&&EditorModule.preferences.reload_on_start)return window.location.href="?session=last",e.preventDefault(),e.stopPropagation(),!1;break;case 117:return localStorage.setItem("_refresh_scene",JSON.stringify(LS.GlobalScene.serialize())),location.reload(),e.preventDefault(),e.stopPropagation(),!1;case 38:return e.ctrlKey&&SelectionModule.selectParentNode(),e.preventDefault(),e.stopPropagation(),!1;case 39:return e.ctrlKey&&SelectionModule.selectSiblingNode(),e.preventDefault(),e.stopPropagation(),!1;case 37:return e.ctrlKey&&SelectionModule.selectSiblingNode(!0),e.preventDefault(),e.stopPropagation(),!1;case 40:return e.ctrlKey&&SelectionModule.selectChildNode(),e.preventDefault(),e.stopPropagation(),!1}CORE.callInModules("onCanvasKeyDown",e)},onShowPreferencesPanel:function(e,t){"editor"==e&&t.addFlags(EditorModule.preferences)}};CORE.registerModule(EditorModule),EditorModule.showMaterialNodeInfo=function(i,a){var e="";Material.icon&&(e="<span class='icon' style='width: 20px'><img src='"+EditorModule.icons_path+Material.icon+"' class='icon'/></span>");var t={callback:function(e){i._material_collapsed=!e}};t.collapsed=i._material_collapsed;var o=a.addSection(e+" Material<span class='buttons'><img class='options_section' src='imgs/mini-cog.png'></span>",t);o.querySelector(".wsectiontitle").addEventListener("contextmenu",function(e){return 2!=e.button||(l(e),e.preventDefault()),!1}.bind(this)),a.current_section.querySelector(".options_section").addEventListener("click",l);var n="";if(i.material&&(n="string"==typeof i.material?i.material:"@Instance"),a.addMaterial("Ref",n,{name_width:100,callback:function(e){CORE.userAction("node_material_assigned",i,e),i.material=e,CORE.afterUserAction("node_material_assigned",i,e),a.refresh()},callback_edit:function(){i._show_mat=!0,a.refresh()}}),i.material){var r=i.getMaterial();if(r){LiteGUI.bind(o,"wchange",function(e){r&&((r.fullpath||r.filename)&&LS.ResourcesManager.resourceModified(r))});var s=LS.getObjectClassName(r);if((e=o.querySelector(".icon")).addEventListener("dragstart",function(e){e.dataTransfer.setData("uid",r.uid),e.dataTransfer.setData("type","Material"),e.dataTransfer.setData("node_uid",i.uid),e.dataTransfer.setData("class",s)}),LiteGUI.bind(a.current_section,"wchange",function(e){r.remotepath&&LS.RM.resourceModified(r),CORE.userAction("material_changed",r)}),a.addInfo("Class",s),r.remotepath&&a.addButton("Reference","Save to Server",{callback:function(){var e=i.getMaterial();DriveModule.saveResource(e,function(){DriveModule.onUpdatePreview(e)})}}),i._show_mat){LS.getObjectClassName(r),r.constructor;a.addButton(null,"Hide Editor",{skip_wchange:!0,callback:function(e){i._show_mat=!1,a.refresh()}}),EditorModule.showMaterialProperties(r,a,i)}else a.addButtons(null,["See Properties"],{skip_wchange:!0,callback:function(e){"See Properties"==e?i._show_mat=!0:EditorModule.inspectInDialog(r),a.refresh()}})}else LS.ResourcesManager.isLoading(i.material)?(a.addInfo("","Loading..."),LS.ResourcesManager.onceLoaded(i.material,function(){a.refresh()})):a.addInfo("","Material not found")}else i.material||i.constructor!=LS.SceneNode||a.addButton(null,"Create Material",{callback:function(e){EditorModule.showAddMaterialToNode(i,function(e){a.refresh()})}});function l(e){var t=["Paste"];if(r&&(t.push("Copy","Paste","Delete","Share","Instance","Show JSON"),r.constructor.actions))for(var o in r.constructor.actions)t.push(o);new LiteGUI.ContextMenu(t,{component:r,title:s||"Material",event:e,callback:c});return e.preventDefault(),e.stopPropagation(),!0}function c(e){var t=i.material,o=i.getMaterial();if("Copy"==e)"object"==typeof t?(t.object_class=LS.getObjectClassName(t),LiteGUI.toClipboard(t.serialize())):LiteGUI.toClipboard({type:"value",data:t});else if("Paste"==e){var n=LiteGUI.getLocalClipboard();if(!n)return;if("value"==(t=n).type)t=t.data;else{if(!LS.MaterialClasses[t.object_class])return;t=new LS.MaterialClasses[t.object_class],delete n.object_class,t.configure(n),t.loadTextures()}CORE.userAction("node_material_assigned",i,t),i.material=t,CORE.afterUserAction("node_material_assigned",i,t),a.refresh()}else if("Delete"==e){if(!(t=i.getMaterial()))return;CORE.userAction("node_material_assigned",i,null),i.material=null,CORE.afterUserAction("node_material_assigned",i,null),a.refresh()}else if("Share"==e){var r=i.material;delete(t=i.getMaterial()).from_pack,delete t.from_prefab,"string"==typeof r?(delete(r=t.clone()).filename,delete r.fullpath,r.object_class=LS.getObjectClassName(r)):r.object_class=LS.getObjectClassName(i.material),r.updatePreview(DriveModule.preview_size||256),DriveModule.showResourceMaterialDialog({material:t,callback:function(e){i.material=e.fullpath||e.filename,a.refresh()}})}else if("Clone"==e||"Instance"==e)EditorModule.cloneNodeMaterial(i),a.refresh();else if("Show JSON"==e){(t=i.getMaterial())&&EditorModule.checkJSON(t),a.refresh()}else o&&o.constructor.actions&&o.constructor.actions[e]?(o.constructor.actions[e].callback.call(o,i),a.refresh()):LiteGUI.alert("Unknown option");LS.GlobalScene.refresh()}},EditorModule.registerNodeEditor(EditorModule.showMaterialNodeInfo),EditorModule.showTextureSamplerInfo=function(r,i){i=i||{},r||(r={}),r.mapping=!1,r.generateMipmaps=!1;i.channel;var e=i.material,t=new LiteGUI.Dialog({title:"Texture Sampler",close:!0,minimize:!1,width:360,scroll:!1,draggable:!0});document.body.appendChild(t.root),t.show("fade"),t.center();r.resource_type&&("Texture"==r.resource_type&&r.type);var o=new LiteGUI.Inspector({name_width:"50%"});o.onchange=function(e,t,o){if(0!=t.length){var n=TONG.RM.getResource(t).image;t&&""!=t&&n==r.image||(r.filename=t,i.callback&&i.callback(r))}};var n=o.addTexture("Texture",r.filename||"",{callback:function(e){if(0!=e.length){var t=TONG.RM.getResource(e).image;e&&""!=e&&t==r.image||(r.filename=e,r.image=t,r._original_data=TONG.RM.getResource(e)._original_data,r.needsUpdate=!0,i.callback&&i.callback(r))}}});function a(e){var t=!1;switch(e){case 1e3:t="REPEAT";break;case 1001:t="CLAMP_TO_EDGE";break;case 1002:t="MIRRORED_REPEAT";break;case 1003:t="NEAREST";break;case 1004:t="NEAREST_MIPMAP_NEAREST";break;case 1005:t="NEAREST_MIPMAP_LINEAR";break;case 1006:t="LINEAR";break;case 1007:t="LINEAR_MIPMAP_NEAREST";break;case 1008:t="LINEAR_MIPMAP_LINEAR"}return t}o.addSeparator();var s=o.addCombo("wrapS","CLAMP_TO_EDGE",{values:{CLAMP_TO_EDGE:TONG.ClampToEdgeWrapping,REPEAT:TONG.RepeatWrapping,MIRRORED_REPEAT:TONG.MirroredRepeatWrapping},callback:function(e){r.wrapS=e}});s.setValue(a(r.wrapS));var l=o.addCombo("wrapT","CLAMP_TO_EDGE",{values:{CLAMP_TO_EDGE:TONG.ClampToEdgeWrapping,REPEAT:TONG.RepeatWrapping,MIRRORED_REPEAT:TONG.MirroredRepeatWrapping},callback:function(e){r.wrapT=e}});l.setValue(a(r.wrapT));var c=o.addCombo("minFilter","LINEAR",{values:{NEAREST:TONG.NearestFilter,LINEAR:TONG.LinearFilter,NEAREST_MIPMAP_NEAREST:TONG.NearestMipMapNearestFilter,NEAREST_MIPMAP_LINEAR:TONG.NearestMipMapLinearFilter,LINEAR_MIPMAP_NEAREST:TONG.LinearMipMapNearestFilter,LINEAR_MIPMAP_LINEAR:TONG.LinearMipMapLinearFilter},callback:function(e){r.minFilter=e}});c.setValue(a(r.minFilter));var d=o.addCombo("magFilter",a(r.magFilter)||"LINEAR",{values:{NEAREST:TONG.NearestFilter,LINEAR:TONG.LinearFilter},callback:function(e){r.magFilter=e}});d.setValue(a(r.magFilter));o.addCombo("Anisotropic",r.anisotropy||"default",{values:{default:1,1:1,2:2,4:4,8:8,16:16},callback:function(e){r.anisotropy=e}});r.image||(r.wrapS=TONG.ClampToEdgeWrapping,s.setValue("CLAMP_TO_EDGE"),r.wrapT=TONG.ClampToEdgeWrapping,l.setValue("CLAMP_TO_EDGE"),r.minFilter=TONG.LinearFilter,c.setValue("LINEAR"),r.magFilter=TONG.LinearFilter,d.setValue("LINEAR")),e&&(o.addTitle("UVs transformed"),o.addVector2("Tiling",[r.repeat.x,r.repeat.y],{step:.001,callback:function(e){r&&r.repeat.set(e[0],e[1])}}),o.addVector2("Offset",[r.offset.x,r.offset.y],{step:.001,callback:function(e){r&&r.offset.set(e[0],e[1])}})),t.addButton("Clear",{className:"big",callback:function(e){r.image=null,r.filename="",n.setValue(""),i.callback&&i.callback(r)}}),t.addButton("Close",{className:"big",callback:function(e){t.close()}}),t.add(o),t.adjustSize(30)};var InterfaceModule={name:"interface",preferences:{show_low_panel:!0,side_panel_width:300},init:function(){this.preferences.side_panel_width;var e=new LiteGUI.Area({id:"mainarea",content_id:"workarea",height:"calc(100% - 30px)",autoresize:!0,inmediateResize:!0,minSplitSize:200});this.mainarea=e,LiteGUI.bind(e,"split_moved",function(e){var t=InterfaceModule.mainarea.getSection(1).getWidth();t&&(InterfaceModule.preferences.side_panel_width=t),InterfaceModule.lower_tabs_widget.onResize()}),this.createTabs(),LiteGUI.createDropArea(e.root,this.onItemDrop.bind(this))},selectContextTab:function(e,t){if(GetLanguage("Timeline")!=e.title)t(e.class);else{DriveModule.showAnimationDialog({filename:"animation.anim",folder:null},function(e){DriveModule.addResourceCommand(e),AnimationModule.showTimeline(e)})}},createTabs:function(){var e=new LiteGUI.Tabs({id:"worktabs",width:"full",mode:"vertical",autoswitch:!0});LiteGUI.main_tabs=e},selectTab:function(e){return LiteGUI.main_tabs.selectTab(e)},createSidePanel:function(){this.side_panel_visibility=!0;var e=new LiteGUI.Panel("side_panel",{title:"side panel"});this.mainarea.getSection(1).add(e),LiteGUI.sidepanel=e;var t=new LiteGUI.Button(LiteGUI.special_codes.close,function(){InterfaceModule.setSidePanelVisibility()});t.root.style.float="right",t.content.style.width="20px",e.header.appendChild(t.root);var o=new LiteGUI.Button("-",function(){InterfaceModule.splitSidePanel()});o.root.style.float="right",o.content.style.width="20px",e.header.appendChild(o.root);var n=new LiteGUI.Tabs({id:"paneltabs",size:"full"});n.addTab("Scene Tree",{selected:!0,id:"nodelist",size:"full",width:"100%"}),n.addTab("Inspector",{size:"full"}),e.add(n),this.sidepaneltabs=n,LiteGUI.menubar.add("Window/Side panel",{callback:function(){InterfaceModule.setSidePanelVisibility()}}),LiteGUI.menubar.add("Window/Low panel",{callback:function(){InterfaceModule.setLowerPanelVisibility()}}),LiteGUI.menubar.add("Window/Floating panel",{callback:function(){GenericTabsWidget.createDialog()}}),LiteGUI.menubar.add("Window/Inspector panel",{callback:function(){InspectorWidget.createDialog()}});var r=new LiteGUI.Area({id:"sidepanelarea",autoresize:!0,inmediateResize:!0});r.split("vertical",["30%",null],!0),r.hide(),LiteGUI.sidepanel.splitarea=r,LiteGUI.sidepanel.add(r),this.scene_tree=new SceneTreeWidget({id:"sidepanel-inspector"}),n.getTab("Scene Tree").add(this.scene_tree),EditorModule.inspector=this.inspector_widget=new InspectorWidget,n.getTab("Inspector").add(this.inspector_widget),n.selectTab("Inspector"),this.splitSidePanel()},setStatusBar:function(e,t){e=e||"";var o=document.querySelector("#statusbar .msg");if(o)return o.innerHTML=e,o.className="msg "+(t||""),o},toggleStatusBar:function(){console.log("toggle status bar");var e=this.visorarea,t=e.root.querySelector("#maincanvas"),o=e.root.querySelector("#statusbar");"50%"!=t.style.height?(t.style.height="50%",o.style.height="50%",o.classList.add("expanded")):(t.style.height="",o.style.height="",o.classList.remove("expanded"))},splitSidePanel:function(){var e=this.sidepaneltabs,t=LiteGUI.sidepanel.splitarea,o=this.scene_tree.root,n=this.inspector_widget.root;this.is_sidepanel_splitted?(e.getTab("Scene Tree").content.appendChild(o),e.getTab("Inspector").content.appendChild(n),e.show(),t.hide(),this.is_sidepanel_splitted=!1):(o.style.display=n.style.display="block",o.style.height=n.style.height="100%",e.hide(),t.show(),t.getSection(0).add(o),t.getSection(0).root.style.overflow="auto",t.getSection(1).add(n),t.getSection(1).root.style.overflow="auto",this.is_sidepanel_splitted=!0)},onItemDrop:function(e){for(var t=CORE.Modules.length-1;0<=t;--t){var o=CORE.Modules[t];if(o!=this&&(o.onItemDrop&&o.onItemDrop(e)))return}},toggleInspectorTab:function(){var e=this.sidepaneltabs;"Inspector"!=e.getCurrentTab()[0]?e.selectTab("Inspector"):e.selectTab("Scene Tree")},getSidePanelVisibility:function(e){return this.side_panel_visibility},createSidebarOpener:function(){if(!this.opensidepanel_button){var e=document.getElementById("visor");if(e){var t=this.opensidepanel_button=document.createElement("div");t.className="opensidepanel-button",t.innerHTML="&#10096;",e.appendChild(t),t.style.display="none",t.addEventListener("click",function(){InterfaceModule.setSidePanelVisibility(!0)})}}},setSidePanelVisibility:function(e){void 0===e&&(e=!this.side_panel_visibility),this.opensidepanel_button||this.createSidebarOpener(),(this.side_panel_visibility=e)?(this.mainarea.showSection(1),this.opensidepanel_button&&(this.opensidepanel_button.style.display="none")):(this.mainarea.hideSection(1),this.opensidepanel_button&&(this.opensidepanel_button.style.display="block"))},setVisorArea:function(e){this.visorarea=e;var t=this.lower_tabs_widget=new GenericTabsWidget;this.visorarea.dom.appendChild(t.root)},setLowerPanelVisibility:function(e){void 0===e&&(e=!this.lower_panel_visibility),(this.lower_panel_visibility=e)?this.visorarea.showSection(1):this.visorarea.hideSection(1),this.preferences.show_low_panel=e,LiteGUI.trigger(this.visorarea.root,"visibility_change"),this.lower_tabs_widget.onResize()}};CORE.registerModule(InterfaceModule);var NotifyModule={init:function(){LiteGUI.addCSS(".notify-msg { position: absolute; opacity: 0; color: #9AB; margin: 2px; margin-left: 6px; transform: scale(1) translate(0, -100px); transition: all ease-in-out 0.2s; }.notify-msg .content { font-size: 1em; position: relative; color: #EEE; white-space: nowrap; opacity: 0.9; background-color: rgba(80,80,80,0.4); border-left: 4px solid rgba(100,100,100,0.4); display: inline-block; overflow: hidden; padding: 4px; min-width: 100px; min-height: 20px; margin: 2px; padding: 2px 10px; transition: background-color 0.5s; }.notify-msg .close { width: 20px; height: 20px; pointer-events: auto; position: absolute; left: -20px; top: 2px; cursor: pointer; background-color: #333; }.notify-msg .close .cross { display: block; transform: translate(8px,12px) rotate(45deg) scale(2); opacity: 0.5; }.notify-msg .progress { pointer-events: none; width: 100%; height: 2px; position: absolute; bottom: 2px; left: 0; opacity: 0.5; background-color: #3FA; display: inline-block; transition: all ease-in-out 0.2s; }.notify-msg.footer { bottom: 100px; top: auto; }.notify-msg.good .content { color: white; background-color: rgba(100,200,100,0.8); box-shadow: 0 0 4px black; }.notify-msg.bad .content { color: white; background-color: rgba(200,100,100,0.8); box-shadow: 0 0 4px black; }.notify-msg.warn .content { color: white; background-color: rgba(200,200,100,0.8); box-shadow: 0 0 4px black; }.notify-msg.big .content { font-size: 2em; }")},show:function(e,i){(i=i||{}).constructor===String&&(i={className:i});var t=void 0!==i.time?i.time:3e3,a=document.createElement("div");a.className="notify-msg",i.id&&(a.id=i.id),i.className&&(a.className+=" "+i.className),a.innerHTML="<span class='content' style='"+(i.style||"")+"'>"+e+"</span>";var s=i.parent||LiteGUI.root;if(s&&s.constructor===String&&(s=document.querySelector(s)),s){for(var o=0,n=s.querySelectorAll(".notify-msg"),r=0;r<n.length;++r){var l=LiteGUI.getRect(n[r]);o+=(l?l.height:20)+2}if(s.appendChild(a),a.style.top="calc( "+(void 0!==i.top?i.top.constructor===String?i.left:i.left+"px":"20px")+" + "+o+"px )",a.style.left=void 0!==i.left?i.left.constructor===String?i.left:i.left+"px":"20px",setTimeout(function(){a.style.opacity="1",a.style.transform="scale(1)"},100),a.content=a.querySelector(".content"),i.closable){var c=document.createElement("span");c.className="close",c.innerHTML="<span class='cross'>+</span>",c.addEventListener("click",function(){a.kill()}),a.insertBefore(c,a.childNodes[0])}return a.setContent=function(e){this.content.innerHTML=e},a.setProgress=function(e,t){this.progress||(this.progress=document.createElement("span"),this.progress.className="progress",this.appendChild(this.progress)),t&&(this.progress.style.backgroundColor=t),this.progress.style.width=(100*e).toFixed(0)+"%"},a.kill=function(e){e=e||0,setTimeout(function(){a.style.opacity="0",setTimeout(function(){a.parentNode&&a.parentNode.removeChild(a);for(var e=0,t=s.querySelectorAll(".notify-msg"),o=0;o<t.length;o++){var n=t[o];n.style.top="calc( "+(void 0!==i.top?i.top.constructor===String?i.left:i.left+"px":"20px")+" + "+e+"px )";var r=LiteGUI.getRect(n);e+=(r?r.height:20)+2}},200)},e)},t&&setTimeout(function(){a.kill()},t),a}console.warn("Notify: error, parent not found",i.parent)},get:function(e,t){var o=document.getElementById(e);return o&&o.classList.contains("notify-msg")?o:null}};CORE.registerModule(NotifyModule);var DriveModule={name:"Drive",bigicon:"imgs/tabicon-drive.png",server_files_path:"",registered_drive_bridges:{},tree:{id:"Files",skipdrag:!0,visible:!1,children:[]},server_resources:{},server_resources_by_id:{},proxy:null,preview_format:"image/jpg",preview_size:100,generated_previews:{},categories_by_type:{"image/jpeg":"Texture","image/jpg":"Texture","image/webp":"Texture","image/png":"Texture"},categories_by_extension:{obj:"Mesh",txt:"Text",dds:"Texture"},ignore_thumbnail_for_extension:["js","txt","html","css","csv","wav","mp3"],root:null,insert_resource_callbacks:[],preferences_panel:[{name:"drive",title:"Drive",icon:null}],preferences:{show_leaving_warning:!0,fileserver_url:null,fileserver_files_url:null,proxy:null,store_meshes_with_lossy_compression:!0},init:function(){CORE.server_url=CORE.config.server,this.server_files_path=CORE.config.resources,this.proxy=CORE.config.proxy,this.preferences.fileserver_url&&(CORE.server_url=this.preferences.fileserver_url),this.preferences.fileserver_files_url&&(this.server_files_path=this.preferences.fileserver_files_url),this.preferences.proxy&&(this.proxy=this.preferences.proxy),void 0===this.preferences.store_meshes_with_lossy_compression&&(this.preferences.store_meshes_with_lossy_compression=!0),TONG.ResourcesManager.setPath(this.server_files_path),this.proxy&&TONG.ResourcesManager.setProxy(this.proxy),TONG.ResourcesManager.keep_files=!0;function e(e,t){var o=document.getElementById("res-msg-"+t.hashCode());o&&(o.content.style.backgroundColor="rgba(200,100,100,0.5)",o.kill(1e3))}this.tree.children.unshift({id:GetLanguage("Assets"),skipdrag:!0,className:"Memory",children:[],callback:DriveModule.showMemoryResources.bind(DriveModule)}),TONG.Event.bind(TONG.ResourcesManager,"resource_loading",function(e,t){NotifyModule.show("FILE: "+t,{id:"res-msg-"+t.hashCode(),closable:!0,time:0,left:60,top:30,parent:"#visor"})}),TONG.Event.bind(TONG.ResourcesManager,"resource_loading_progress",function(e,t){var o="res-msg-"+t.url.hashCode(),n=NotifyModule.get(o);n&&n.setProgress(t.progress)}),TONG.Event.bind(TONG.ResourcesManager,"resource_loaded",function(e,t){var o=document.getElementById("res-msg-"+t.hashCode());o&&(o.content.style.backgroundColor="rgba(100,200,150,0.5)",o.kill(500),"http://"!=t.substr(0,7)&&-1==t.indexOf("_th_")&&DriveModule.fetchPreview(t))}),TONG.Event.bind(TONG.ResourcesManager,"resource_not_found",e),TONG.Event.bind(TONG.ResourcesManager,"resource_problem_loading",e),TONG.Event.bind(TONG.ResourcesManager,"load_resource_preview",function(e,t){if(-1==t.indexOf("http")&&-1==t.toLowerCase().indexOf("cubemap")){var o=TONG.RM.getFolder(t),n=(TONG.RM.getBasename(t),TONG.RM.getFilename(t));if("_th_"!=n.substr(0,4)&&-1==n.indexOf("CUBECROSS")){var r=TONG.RM.getExtension(t);if(TONG.Formats.getFileFormatInfo(r).resourceClass===TONG.Texture){var i=o+"/_th_"+n+".jpg";TONG.ResourcesManager.load(i,{is_preview:!0,preview_of:t})}}}}),this.tab=LiteGUI.main_tabs.addTab(this.name,{id:"drivetab",bigicon:this.bigicon,size:"full",content:"",callback:function(e){DriveModule.refreshContent()},callback_leave:function(e){}}),this.root=LiteGUI.main_tabs.root.querySelector("#drivetab"),TONG.Event.bind(TONG.ResourcesManager,"resource_registered",function(e,t){DriveModule.onResourceRegistered(t)});var t=InterfaceModule.lower_tabs_widget.addWidgetTab(ResourcesPanelWidget);TONG.ResourcesManager.keep_original=!0,this.createPanel(t)},createPanel:function(e){this.root;this.resources_panel=e.widget,this.resources_panel.showMemoryResources()},guessCategoryFromFile:function(e){var t=this.categories_by_type[e.type],o=TONG.RM.getExtension(e.name);return t||(t=this.categories_by_extension[o]),t||"wbin"!=o||-1!=e.name.indexOf(".mesh.")&&(t="Mesh"),t},openTab:function(){LiteGUI.main_tabs.selectTab(this.tab_name)},registerDriveBridge:function(e){(this.registered_drive_bridges[e.name]=e).tree_root={id:e.name,skipdrag:!0,className:e.className+" drive-name",children:[],bridge:e},this.tree.children.push(e.tree_root)},getDriveBridge:function(e){return this.registered_drive_bridges[e]},showStartUploadingFile:function(e){NotifyModule.show("UPLOAD: "+e,{id:"res-msg-"+e.hashCode(),closable:!0,time:0,left:80,top:30})},showProgressUploadingFile:function(e,t){var o=NotifyModule.get("res-msg-"+e.hashCode());o&&o.setProgress(t)},showEndUploadingFile:function(e){var t=NotifyModule.get("res-msg-"+e.hashCode());t&&(t.content.style.backgroundColor="rgba(100,200,150,0.5)",t.kill(500))},showErrorUploadingFile:function(e,t){var o=NotifyModule.get("res-msg-"+e.hashCode());o&&(o.content.style.backgroundColor="rgba(200,100,100,0.5)",o.kill(1e3),LiteGUI.alert(t,{title:"Error uploading file"}))},onTreeUpdated:function(){this.refreshTree(),LiteGUI.trigger(DriveModule,"tree_updated",this.tree)},refreshTree:function(){},refreshContent:function(){this.resources_panel&&this.resources_panel.refreshContent()},showInBrowserContent:function(e,t){this.resources_panel.showInBrowserContent(e,t)},updateServerTreePanel:function(e){for(var t in this.registered_drive_bridges){var o=this.registered_drive_bridges[t];o&&o.updateTree&&o.updateTree(function(){DriveModule.onTreeUpdated()})}},selectFolder:function(e){this.resources_panel.tree_widget.setSelectedItem(e,!0,!0)},getFilename:function(e){if(!e)return null;var t=e.indexOf("?");return-1!=t&&(e=e.substr(0,t)),-1==(t=e.lastIndexOf("/"))?e:e.substr(t+1)},getExtension:function(e){var t=e.lastIndexOf(".");return-1==t?"":e.substr(t+1).toLowerCase()},getDriveBridgeFromFullpath:function(e){if(!e)return null;for(var t in this.registered_drive_bridges){var o=this.registered_drive_bridges[t];if(o.isPath&&o.isPath(e))return o}return null},getResourceCategory:function(e){if(e.resource_type)return e.resource_type;if(e.category)return e.category;if(e.getCategory)return e.getCategory();var t=e.resource_type||e.object_class||e.category;return"Object"==t&&(t=TONG.Formats.guessType(e.fullpath||e.filename)),t||(t="unknown"),t},showUploadDialog:function(e){},showRenameResourceDialog:function(o,n){var r=o.fullpath||o.filename,i=TONG.RM.getFolder(r),e=TONG.RM.getFilename(r);document.body.appendChild(LiteGUI.prompt("Choose new filename",function(e){if(e){var t=TONG.RM.cleanFullpath(i+"/"+e);DriveModule.renameResource(r,t,o),DriveModule.refreshContent(),n&&n(t)}},{title:"Rename resource",value:e,width:400}).root)},showCloneResourceDialog:function(n){document.body.appendChild(LiteGUI.prompt("Choose filename",function(e){if(e){var t=TONG.RM.getFolder(n.fullpath||n.filename),o=TONG.RM.cleanFullpath(t+"/"+e);DriveModule.cloneResource(n,o,function(){DriveModule.refreshContent()})}},{title:"Clone resource",value:TONG.RM.getFilename(n.fullpath||n.filename),width:400}).root)},showResourceInfoInDialog:function(e){var t=new LiteGUI.Dialog({title:"Properties",fullcontent:!0,closable:!0,draggable:!0,detachable:!0,minimize:!0,resizable:!0,width:400,height:500,scroll:!0}),o=new LiteGUI.Inspector;return t.add(o),this.showResourceInfo(e,o),t.on_close=function(){},t.show(),t},showMemoryResources:function(e){for(ResourcesPanelWidget.Deselect(!!EditorModule.target.selected);(e=e.parentElement)&&!e.classList.contains("resources-panel"););var t=DriveModule.resources_panel;return e&&e.panel&&(t=e.panel),t.showMemoryResources(),!0},showResourceInfo:function(r,e){if(r){var t=r.constructor===String?r:r.fullpath||r.filename,o=TONG.ResourcesManager.resources[t],n=DriveModule.server_resources[t];if(r=o||n){var i=r._preview_url||LFS.getPreviewPath(t),a=r.category||r.object_class;r.getCategory&&(a=r.getCategory()),e||(e=InterfaceModule.inspector_widget.inspector,InterfaceModule.inspector_widget.setTitle("Resource"),e.clear());var s=e.name_width;if(e.name_width=100,e.addTitle("Resource"),e.widgets_per_row=2,e.addString("Fullpath",r.fullpath,{width:"calc( 100% - 60px )",disabled:!0}),e.addButton(null,"Open",{width:60,callback:function(){var e=TONG.RM.getFolder(r.fullpath);DriveModule.selectFolder(e)}}),e.widgets_per_row=1,i){var l=new Image;l.src=i,l.className="preview_image",l.onerror=function(){this.parentNode.removeChild(this)};var c=e.addInfo(null,l);e.root.querySelector(".preview_image");c.style.backgroundColor="black",c.style.textAlign="center"}var d=r.filename;if(!d&&n&&(d=n.filename),e.addString("Filename",d,{callback:function(e){var t=r.fullpath||r.filename,o=TONG.RM.getFolder(t);-1!=o.indexOf("://")&&(o="");var n=TONG.RM.cleanFullpath(o+"/"+e);DriveModule.renameResource(t,n,r),DriveModule.refreshContent()}}),e.addFolder("Folder",r.folder||"",{disabled:!0,callback:function(e){var t=e+"/"+TONG.ResourcesManager.getFilename(r.filename);DriveModule.renameResource(r.filename,t)}}),e.addString("Category",a,{callback:function(e){r.category=e}}),r.size&&e.addInfo("Size",DriveModule.beautifySize(r.size)),e.addSeparator(),"Prefab"!=a&&"Pack"!=a||!o?"json"==a&&o&&e.addButton(a,"Show content",function(){EditorModule.checkJSON(o._data)}):e.addButton(a,"Show content",function(){PackTools.showPackDialog(o)}),o&&(o.from_pack&&e.addInfo("From Pack",o.from_pack),o.from_prefab&&e.addStringButton("From Prefab",o.from_prefab,{callback_button:function(){}})),n){var u=TONG.ResourcesManager.getFullURL(r.remotepath||r.fullpath||r.filename);e.addInfo("Link","<a target='_blank' href='"+u+"'>link to the file</a>")}o?e.addButton(null,"Open in Inspector",function(){EditorModule.inspect(o)}):e.addButton(null,"Load / Open in Inspector",function(){TONG.RM.load(r.remotepath||r.fullpath,function(e){EditorModule.inspect(e)})}),this.addResourceInspectorFields(r,e),e.name_width=s}}},addResourceInspectorFields:function(n,r){if(n){if((r=r||InterfaceModule.inspector_widget.inspector).addSeparator(),n._original_data||n._original_file){var e=n._original_data||n._original_file;e.buffer&&(e=e.buffer);var t=0;"string"==typeof e?t=e.length:e.constructor==ArrayBuffer&&(t=e.byteLength),r.widgets_per_row=2,r.addInfo("Bytes",DriveModule.beautifySize(t)),n.serialize?r.addButton(null,"Check JSON",function(){EditorModule.checkJSON(n.serialize())}):r.addInfo(null,""),r.widgets_per_row=1}var o=n.constructor===String?n:n.fullpath||n.filename,i=TONG.ResourcesManager.resources[o];DriveModule.server_resources[o];r.addButtons(null,["Update Preview","Update metadata"],{callback:function(e){if(i)if("Update Preview"==e){var t=DriveModule.generatePreview(n.fullpath,!0),o=r.root.querySelector(".preview_image");o&&(o.src=t),n._preview_url=t,DriveModule.onUpdatePreview(n,function(){console.log("preview updated!")})}else"Update metadata"==e&&n.generateMetadata&&n.generateMetadata();else LiteGUI.alert("You must load the resource before updating it")}}),r.addButtons(null,["Load","Unload"],{callback:function(e){n.category||n.object_class;"Load"==e?DriveModule.loadResource(n.fullpath,null,!0):(DriveModule.unloadResource(n.fullpath),DriveModule.refreshContent())}}),r.addButtons(null,["Save","Delete"],{callback:function(o){if("Save"==o)return n.from_pack||n.from_prefab?LiteGUI.alert((n.from_pack,n.from_pack)):n.fullpath?void DriveModule.saveResource(n):LiteGUI.alert("Resource must have a folder assigned");LiteGUI.confirm("Are you sure? This file will be deleted from the server forever.",function(e){if(e&&"Delete"==o){var t=n.fullpath||n.filename;TONG.RM.unregisterResource(t),DriveModule.serverDeleteFile(t,function(e){e&&DriveModule.refreshContent()})}})}}),r.addButton(null,"Download",{callback:function(){if(i){var e=DriveModule.getResourceAsBlob(n);if(!e)return;LiteGUI.downloadFile(TONG.RM.getFilename(e.filename),e)}else LiteGUI.downloadURL(TONG.RM.getFullURL(n.fullpath),TONG.RM.getFilename(n.filename))}}).querySelector("button").setAttribute("download",n.filename),n.optimize&&r.addButton(null,"Optimize",{callback:function(){n.optimize(),DriveModule.refreshContent()}})}},getResourceAsBlob:function(e){if(!e)return null;var t=e.filename,o=TONG.Resource.getDataToStore(e),n=o.data;n.data&&(n=n.data);var r=TONG.RM.getExtension(t);if(o.extension&&o.extension!=r&&(t+="."+o.extension,r=o.extension),!r){t+=n.constructor==ArrayBuffer||n.constructor==Blob||n.constructor==File?".wbin":".txt"}var i=new Blob([n],{type:"application/octet-stream"});return i.filename=t,i},renameResource:function(e,t,o){if(!e||!t||e.constructor!==String||t.constructor!==String)throw"DriveModule.renameResource wrong parameters";if(!TONG.RM.getFolder(e)||TONG.RM.getFolder(t)){o&&(o.in_server||o.remotepath)&&(console.log("Renaming server file"),console.log(o),e=o.fullpath,t=TONG.RM.cleanFullpath(t),this.serverMoveFile(e,t,function(){DriveModule.refreshContent()})),TONG.ResourcesManager.resources[e]&&TONG.ResourcesManager.renameResource(e,t)}else{if(o&&o.in_server)throw"DriveModule.renameResource new_name must have a folder";TONG.ResourcesManager.renameResource(e,t)}},cloneResource:function(e,t,o){if(!e)return null;var n=e.fullpath||e.filename;if(e.in_server)return DriveModule.serverCopyFile(n,t,o),null;if(!e.clone)return console.log("Resource type cannot be cloned: "+TONG.getObjectClassName(e)),null;var r=e.clone();return t||(t=r.filename),TONG.RM.registerResource(t,r),r instanceof TONG.Script?(console.log("enter is script"),TONG.Components.registerScriptComponent(r)):r instanceof TONG.Material&&TONG.MaterialClasses.registerMaterialClass(r),e.remotepath&&DriveModule.saveResource(r),r},showSelectFolderDialog:function(i,e,a){LoginModule.session?this.serverGetFolders(function(e){if(!e)return void LiteGUI.alert("Not logged to server");var t=DriveModule.convertToTree(e),o=new LiteGUI.Dialog({id:"select-folder-dialog",title:"Select folder",close:!0,width:360,height:240,scroll:!1,draggable:!0}),n=new LiteGUI.Tree(t,{id:"files-tree",allow_rename:!1,height:200});n.root.style.backgroundColor="#111",n.root.style.padding="5px",n.root.style.width="100%",n.root.style.overflow="auto",o.add(n);var r=null;n.root.addEventListener("item_selected",function(e){var t=e.detail;r=t.item.data}),o.addButton("Select",{className:"big",callback:function(){var e=null;r&&(e=LS.ResourcesManager.cleanFullpath(r.fullpath)),i&&i(e),o.close()}}),o.adjustSize(20),o.show("fade"),a&&n.setSelectedItem(a,!0)}):LiteGUI.alert("You must be logged in to select a folder")},showSelectFolderFilenameDialog:function(e,t,o){o=o||{};var n="",r="";e&&(n=TONG.RM.getFolder(e),r=TONG.RM.getFilename(e));var i=new LiteGUI.Dialog({id:"select-folder-filename-dialog",title:"Select folder and filename",close:!0,width:360,height:240,scroll:!1,draggable:!0}),a=new LiteGUI.Inspector;o.text&&a.addInfo(null,o.text),a.addFolder("Folder",n,{callback:function(e){e&&(n=e)}}),a.addString("Filename",r,{callback:function(e){e&&(r=e)}}),a.addButton(null,"Continue",function(){if((n||o.allow_no_folder)&&r){if(i.close(),o.extension)TONG.RM.getExtension(r)!=o.extension&&(r+="."+o.extension);var e=TONG.RM.cleanFullpath(n+"/"+r);t&&t(n,r,e)}}),i.add(a),i.adjustSize(20),i.show()},getServerFoldersTree:function(i){function a(e,t){var o=[];for(var n in t){var r=TONG.ResourcesManager.cleanFullpath(e+"/"+n),i={id:r,content:n,fullpath:r,type:"folder",candrag:!0,className:"folder",folder:n};t[n]&&(i.children=a(r,t[n])),o.push(i)}return o}this.serverGetFolders(function(e){DriveModule.tree.children.findIndex(function(e){return"Server"==e.id});e||i&&i(null);var t={id:"Server",children:[]};for(var o in e){var n=e[o],r={id:n.metadata.name,type:"unit",candrag:!0,className:"folder unit",fullpath:n.name};r.children=a(n.name+"/",n.folders),t.children.push(r)}i&&i(t)})},showLoadingBrowserContent:function(){var e=$(this.root).find(".resources-container")[0];$(e).empty(),$(e).append("<strong>loading...</strong>")},loadResource:function(e,t,o){o&&TONG.ResourcesManager.unregisterResource(e),delete TONG.ResourcesManager.resources_not_found[e],TONG.ResourcesManager.load(e,null,function(e){t&&t(e)})},unloadResource:function(e){TONG.ResourcesManager.resources[e]&&TONG.ResourcesManager.unregisterResource(e)},onResourceRegistered:function(e){var t=e.fullpath||e.filename;t&&"#"!=t[0]&&this.server_resources[t]&&(e._server_info=this.server_resources[t])},onInsertResourceInScene:function(e,t){if(e){t=t||{};var o=null,n=null,r=null;e.dataset?(o=e.dataset.fullpath||e.dataset.filename,n=e.dataset.restype,r=TONG.ResourcesManager.getResource(o)):e.fullpath&&(o=(r=e).fullpath||r.filename,n=TONG.ResourcesManager.getResourceType(r));var i=!1;for(var a in DriveModule.insert_resource_callbacks){var s=DriveModule.insert_resource_callbacks[a];if(s[0]==n||!s[0]){if(0==s[1].call(DriveModule,o,n,t))continue;return void(i=!0)}}var l=r?r.resource_type:n;i||LiteGUI.alert("Insert not implemented for this resource type: "+l)}else LiteGUI.alert("No resource selected")},registerAssignResourceCallback:function(e,t){if(e&&e.constructor===Array)for(var o in e)this.insert_resource_callbacks.push([e[o],t]);else this.insert_resource_callbacks.push([e,t])},onCreateFolderInServer:function(o,t){function n(e){DriveModule.updateServerTreePanel(),t&&t(e)}function r(e){LiteGUI.alert("Cannot be done (be sure your are logged and have rights to write in this unit)")}LiteGUI.prompt("Folder name",function(e){if(!e)return;var t=o+"/"+e;DriveModule.serverCreateFolder(t,n,r)})},onMoveFolderInServer:function(t,o,n){function r(e){e?DriveModule.updateServerTreePanel():LiteGUI.alert("Cannot be done (are you logged?)"),n&&n(e)}LiteGUI.confirm("Are you sure? All projects using the files inside this folder will have broken references.",function(e){if(!e)return;LoginModule.session.moveFolder(t,o,r)})},onDeleteFolderInServer:function(t,o){function n(e){e?DriveModule.updateServerTreePanel():LiteGUI.alert("Cannot be done (are you logged?)"),o&&o(e)}LiteGUI.confirm("Are you sure you want to delete the folder? All files will be lost",function(e){if(!e)return;if(null==t)return;DriveModule.serverDeleteFolder(t,n)})},onImportToFolder:function(e,t){LiteGUI.alert("feature not developed yet")},onUpdatePreview:function(o,n){if(o&&o.fullpath){var r=DriveModule.generatePreview(o.fullpath);r&&DriveModule.serverUpdatePreview(o.fullpath,r,function(e){if(e){if(LiteGUI.alert("Preview updated"),o._ignore_preview_cache=!0,DriveModule.resources_panel.selected_item){var t=DriveModule.resources_panel.selected_item.querySelector("img");t&&(o._preview_url=r,t.src=r)}}else console.error("Error updating preview");n&&n()},function(e){LiteGUI.alert("Error updating preview")})}else console.error("fullpath not found")},filterByCategory:function(e){this.resources_panel.filterByCategory(e)},generatePreview:function(e,t,o){var n=TONG.ResourcesManager.getResource(e);if(!n)return o?null:this.takeScreenshotUsingCache(this.preview_size,this.preview_size,e);if(n.updatePreview&&(n.updatePreview(this.preview_size),n._preview_url))return n._preview_url;if(n.toCanvas){console.log("Generating resource preview using a canvas: ",n.filename);var r=n.toCanvas(null,!0,256);if(r)return n._preview_url=r.toDataURL(this.preview_format),n._preview_url}if(n.img&&!t){var i=n.img;try{var a=createCanvas(this.preview_size,this.preview_size);if(ctx=a.getContext("2d"),i.height==6*i.width)return RenderModule.takeScreenshot(this.preview_size,this.preview_size);if(i.pixels){for(var s=createCanvas(i.width,i.height),l=s.getContext("2d"),c=l.getImageData(0,0,i.width,i.height),d=i.bytesPerPixel,u=i.pixels,h=0;h*d<i.pixels.length;h+=1)c.data.set([u[h*d],u[h*d+1],u[h*d+2],4==d?u[h*d+3]:255],4*h);l.putImageData(c,0,0),ctx.drawImage(s,0,0,a.width,a.height)}else ctx.drawImage(i,0,0,a.width,a.height);return a.toDataURL("image/png")}catch(e){return on_complete&&on_complete(-1,"Image doesnt come from a safe source"),null}}if(n.constructor===TONG.Texture){n.width,n.height;if("CubeTexture"===n.type)return RenderModule.takeScreenshot(this.preview_size,this.preview_size);var f=new Image;f.src=n.image.src;var p=f;return p.setAttribute("width",this.preview_size),p.setAttribute("height",this.preview_size),p}return o?null:this.takeScreenshotUsingCache(this.preview_size,this.preview_size,e)},takeScreenshotUsingCache:function(e,t,o){var n=getTime();if(this._last_screenshot&&n-this._last_screenshot.time<2e3)return this._last_screenshot.data;console.log("Screenshot taken for resource: "+(o||""));var r=RenderModule.takeScreenshot(e,t);return this._last_screenshot={time:n,data:r},r},fetchPreview:function(e){var t=this;if(!this.generated_previews[e]&&-1==e.indexOf("_th_")){var o=LFS.getPreviewPath(e),n=new Image;n.src=o,n.onerror=function(){delete t.generated_previews[e]},this.generated_previews[e]=n}},getServerPreviewURL:function(e){var t=TONG.RM.resources[e.fullpath];if(t&&t._ignore_preview_cache)return e._preview_url=LFS.getPreviewPath(e.fullpath,!0),e._ignore_preview_cache=!1,e._preview_url;if(e._preview_url)return e._preview_url;var o=TONG.RM.getExtension(e.fullpath);if(-1!=this.ignore_thumbnail_for_extension.indexOf(o))return null;if("json"==o&&"COMP"==TONG.RM.getExtension(TONG.RM.getBasename(e.fullpath)))return null;return e._preview_url=LFS.getPreviewPath(e.fullpath),e._preview_url},saveResource:function(o,n,r){if(r=r||{},o){if(!o.fullpath){if(console.warn("DriveModule.saveResource: resource without fullpath."),!TONG.RM.getFolder(o.filename))return;o.fullpath=o.filename}var e=o.from_pack||o.from_prefab;if(!e||e.constructor!=String||(CORE.log("Saving resource that belongs to a Pack or Prefab, so saving the Pack/Prefab: "+o.fullpath),o=TONG.RM.getResource(e))){var i=null,a=null;r.skip_alerts||(i=LiteGUI.alert("<p>Uploading file... <span class='upload_progress'></span></p>"),a=i.root.querySelector(".upload_progress")),TONG.RM.nocache_files[o.fullpath]=(new Date).getTime(),this.serverUploadResource(o,o.fullpath,function(e,t){e&&TONG.ResourcesManager.resourceSaved(o),LiteGUI.remove(a),i&&i.close(),r.skip_alerts||LiteGUI.alert(e?"Resource saved":"Problem saving the resource: "+t),n&&n(o)},function(e,t){i&&(413==t&&(e="File too big"),i.content.innerHTML="Error Uploading: "+e,n&&n(!1,e))},function(e){a&&(a.innerHTML=(100*e|0)+"%")})}else LiteGUI.alert("Error saving: Saving a resource inside a pack, but the pack is not in memory")}else console.error("DriveModule.saveResource: error, resource is null")},saveResourcesToFolder:function(i,a,s,l,c){var d=i.length;!function e(t,o){if(!i.length)return void(s&&s());if(!t)return void(l&&l(t,o));c&&c(i.length/d);var n=i.shift();if(!n)return void e(!0);n.constructor===String&&(n=TONG.ResourcesManager.resources[n]);var r=a+"/"+n.filename;TONG.RM.renameResource(n.fullpath||n.filename,r);DriveModule.saveResource(n,e)}(!0)},viewResource:function(e){var t=e.url;t||(t=TONG.ResourcesManager.getFullURL(e.filename)),window.open(t,"_blank")},getResourcesNotSaved:function(e){var t=null;t=e?TONG.GlobalScene.getResources():TONG.RM.resources;var o=[];for(var n in t){var r=null;if(r=e?TONG.RM.resources[n]:t[n]){var i=r.fullpath||r.filename;":"!=i[0]&&"_"!=i[0]&&(r.remotepath&&!r._modified||r.from_prefab||r.from_pack||o.push(i))}}return o.length?o:null},checkResourcesSaved:function(e,a){var s=this,l=this.getResourcesNotSaved(!0);if(!l)return a&&a(),!0;var c="";TONG.GlobalScene.extra.folder&&(c=TONG.GlobalScene.extra.folder);var d=TONG.Math.generateUUID().substr(1)+".PACK";TONG.GlobalScene.extra.filename&&(d=TONG.RM.getBasename(LS.GlobalScene.extra.filename)+".PACK");var u=c,h=new LiteGUI.Dialog({title:"Resources not saved",closable:!0,draggable:!0,width:400}),f=new LiteGUI.Inspector;function p(){var o=LiteGUI.alert("Saving..."),e=[];for(var t in l){var n=l[t],r=TONG.RM.resources[n];r&&(r.remotepah&&r._modified||e.push(n))}DriveModule.saveResourcesToFolder(e,u,function(){o.close(),LiteGUI.alert("Modified resources saved"),f.refresh()},function(e,t){o.content.innerHTML="Error saving resources: "+t},function(e){o.content.innerHTML="Saving..."+Math.floor(100*e)+"%"})}function m(){var o=LiteGUI.alert("Saving...");DriveModule.saveResourcesToFolder(l,u,function(){f.refresh(),o.close(),LiteGUI.alert("All resources saved"),a&&a()},function(e,t){o.content.innerHTML="Error saving resources: "+t},function(e){o.content.innerHTML="Saving..."+Math.floor(100*e)+"%"}),f.refresh()}function g(e){e?(TONG.GlobalScene.addPreloadResource(e.fullpath),LiteGUI.alert("Pack created: "+e.fullpath),a&&a(e)):LiteGUI.alert("Error creating Pack, check size in LFS")}return f.on_refresh=function(){if(!(l=s.getResourcesNotSaved(!0)))return h.close(),a&&a(),!0;f.clear(),f.addInfo(null,"There are some resources in this scene that are not stored in the server, this resources will be lost if you close the application or wont be seen by other users if you share your scene.<br/>You must save them."),f.addTitle("Resources not saved in server");var e=[];for(var t in l){var o=l[t],n=LS.RM.resources[o];if(n){var r=DriveModule.beautifyPath(o,{class:"ellipsis",style:"max-width: 80%;"});n._modified&&n.remotepath&&(r+="<button class='save-item' data-path='"+o+"' style='float:right; width: 60px; margin-top: 3px;'>Save</button>"),e.push({content:r})}else console.warn("checkResourcesSaved: resource not found:",o)}var i=f.addList(null,e,{height:200}).querySelectorAll(".save-item");i&&i.length&&LiteGUI.bind(i,"click",function(e){console.log(this.dataset.path);var t=TONG.RM.resources[o];DriveModule.saveResource(t,function(){f.refresh()},{skip_alerts:!0})});f.addTitle("Save individually"),f.addButton(null,"Save only modified ones",p),f.widgets_per_row=2,f.addFolder("Folder",u,{name_width:60,callback:function(e){u=e}}),f.addButton(null,"Save them individually",m),f.widgets_per_row=1,f.addTitle("Save all inside a Pack"),f.widgets_per_row=2,f.addFolder("Folder",c,{name_width:60,callback:function(e){c=e}}),f.addString("Filename",d,{callback:function(e){d=e}}),f.widgets_per_row=1,f.addButton(null,"Create PACK & Save",{callback:function(){return c?d?(h.close(),void function(){LiteGUI.alert("Saving...");var e=c+"/"+d;-1==e.toLowerCase().indexOf(".wbin")&&(e+=".wbin");var t=TONG.RM.getResource(e,LS.Pack);t?t.addResources(l):t=TONG.Pack.createPack(d,l,null,!0);t&&(t.fullpath=e,TONG.ResourcesManager.registerResource(t.fullpath||t.filename,t),DriveModule.saveResource(t,g))}()):LiteGUI.alert("You must choose a filename"):LiteGUI.alert("You must select a folder")}}),f.widgets_per_row=1,f.addSeparator(),f.addButtons(null,["Close","Save anyway"],function(e){h.close(),"Save anyway"==e&&a&&a()})},h.add(f),f.refresh(),h.show(),!1},processServerResource:function(e){var t=e;return t.id=parseInt(t.id),t.fullpath=t.folder+"/"+t.filename,t.url=CORE.server_url+"resources/"+t.fullpath,t.object_class=t.category,t.metadata?t.metadata=JSON.parse(t.metadata):t.metadata={},t._preview_url=CORE.server_url+"resources/_pics/_"+t.id+".png",this.server_resources[t.fullpath]=t,TONG.ResourcesManager.resources[t.fullpath]&&(TONG.ResourcesManager.resources[t.fullpath]._server_info=t),t},convertToTree:function(e,t){if(t=t||"",!e)return{};var o={children:[]};if(e.constructor==Array){o.id="Files";for(var n=0;n<e.length;++n){var r=e[n].name,i=t+"/"+r,a=this.convertToTree(e[n].folders,i);a.content=r,a.id=i,a.fullpath=i,o.children.push(a)}}else for(var n in e){i=t+"/"+n;var s=this.convertToTree(e[n],i);s.content=n,s.id=i,s.fullpath=i,o.children.push(s)}return o},onShowPreferencesPanel:function(e,t){if("drive"==e){var o=this;t.addTitle("Files server configuration"),t.addInfo(null,"You must restart WebGLStudio to changes take effect"),t.addString("Drive Service URL",this.preferences.fileserver_url,function(e){e=LFS.cleanPath(e)+"/",(o.preferences.fileserver_url=e)||(e=CORE.config.server),CORE.server_url=e}),t.addString("Drive Files URL",this.preferences.fileserver_files_url,function(e){e=LFS.cleanPath(e)+"/",(o.preferences.fileserver_files_url=e)||(e=CORE.config.resources),DriveModule.server_files_url=e,TONG.ResourcesManager.setPath(this.server_files_path)}),t.addString("Proxy URL",this.preferences.proxy,function(e){o.preferences.proxy=e,TONG.ResourcesManager.setProxy(e||CORE.config.proxy)});var n=t.addStringButton("Fetch from server","",{button_width:"25%",button:"Fetch",callback_button:function(){var t=n.getValue();t&&LiteGUI.requestJSON(t+"/config.json",function(e){if(!e)return LiteGUI.alert("Cannot retrieve config.json file from server");o.preferences.fileserver_url=LFS.cleanPath(t+"/"+e.server)+"/",o.preferences.fileserver_files_url=LFS.cleanPath(t+"/"+e.resources)+"/",LiteGUI.alert("Config found. You must restart to apply new server config.")})}});t.addButton(null,"Use default server",{callback:function(){o.preferences.fileserver_url="",o.preferences.fileserver_files_url="",LiteGUI.alert("You must restart to apply new server config.")}}),t.addSeparator(),t.addCheckbox("Show leaving warning",this.preferences.show_leaving_warning,{name_width:"80%",callback:function(e){o.preferences.show_leaving_warning=e}}),t.addCheckbox("Use lossy compression with meshes",this.preferences.store_meshes_with_lossy_compression,{name_width:"80%",callback:function(e){o.preferences.store_meshes_with_lossy_compression=e,TONG.Mesh.enable_wbin_compression=e}})}},retrieveNoCacheFiles:function(){console.log("load");var e=localStorage.getItem("wgl_nocache_files");if(e&&"undefined"!=e){e=JSON.parse(e);var t=(new Date).getTime();if(e)for(var o in e){t-e[o]<864e5&&(TONG.ResourcesManager.nocache_files[o]=e[o])}}},onUnload:function(){if(LS.RM.nocache_files&&localStorage.setItem("wgl_nocache_files",JSON.stringify(LS.RM.nocache_files)),this.preferences.show_leaving_warning){var e=this.getResourcesNotSaved();if(e&&e.length)return"There are Resources in memory that must be saved or they will be lost. Are you sure you want to exit?"}},serverGetFolders:function(t){var o=this;LoginModule.session?LoginModule.session.getUnitsAndFolders(function(e){o.units=e,t&&t(e)}):t&&t(null)},serverGetFiles:function(e,t){if(!LoginModule.session)throw"Session not found";LoginModule.session.getFilesByPath(e,function(e){t&&t(e)})},serverSearchFiles:function(e,t,o){if(!LoginModule.session)throw"Session not found";if(!e||"object"!=typeof e)throw"filter must be object";function n(e){t&&t(e)}function r(e){o&&o(e)}e.category?LoginModule.session.searchByCategory(e.category,n,r):e.filename&&LoginModule.session.searchByFilename(e.filename,n,r)},serverCopyFile:function(e,t,o){LoginModule.session.copyFile(e,t,o)},serverMoveFile:function(e,t,o){LoginModule.session.moveFile(e,t,o)},serverDeleteFile:function(e,t){LoginModule.session.deleteFile(e,t)},serverUploadResource:function(e,o,n,r,t){var i=e.filename;e.in_server&&TONG.ResourcesManager.resources[o]&&(e=TONG.ResourcesManager.resources[o]);var a=this.getResourceCategory(e);if(e.in_server&&!TONG.ResourcesManager.resources[o]){var s={};return void 0!==e.metadata&&(s.metadata=e.metadata),void 0!==e.category&&(s.category=e.category),void LoginModule.session.updateFileInfo(o,s,function(e,t){console.log("updated!"),n&&n(e,o,t)},function(e,t){console.log(e),r&&r(e)})}var l={metadata:{},category:a},c=TONG.RM.getExtension(i),d=TONG.Resource.getDataToStore(e),u=d.data;if(u.data&&(u=u.data),d.extension&&d.extension!=c&&(i+="."+d.extension,o+="."+d.extension),!(c=TONG.RM.getExtension(i))){var h="";i+=h=u.constructor==ArrayBuffer||u.constructor==Blob||u.constructor==File?".wbin":".txt",o+=h}e.filename=i,!1!==e.constructor.hasPreview&&(e._preview_url&&"data:image/"==e._preview_url.substr(0,11)?l.preview=e._preview_url:l.preview=this.generatePreview(e.fullpath));var f=u.length;void 0===f&&(f=u.byteLength),LoginModule.session.uploadFile(o,u,l,function(e,t){console.log("uploaded: ",o),n&&n(e,o,t)},function(e,t){console.log(e),r&&r(e)},function(e){t&&t(e)})},serverUpdatePreview:function(e,t,o,n){console.warn("Quarantine method"),LoginModule.session.updateFilePreview(e,t,o,n)},serverCreateFolder:function(e,t,o){console.warn("Quarantine method"),e&&LoginModule.session.createFolder(e,t,o)},serverDeleteFolder:function(e,o){console.warn("Quarantine method"),e&&LoginModule.session.deleteFolder(e,function(e,t){o&&o(e)})},beautifyPath:function(e,t){var o="",n="";if(t)for(var r in t)"class"==r?n=t[r]:o+=" "+r+"='"+t[r]+"'";return"<span class='path "+n+"' "+o+"><span class='foldername'>"+e.split("/").join("<span class='foldername-slash'>/</span>")+"</span></span>"},beautifySize:function(e){return 1048576<(e=parseInt(e))?e=(e/1048576).toFixed(1)+" <span class='bytes'>MBs</span>":1024<e?e=(e/1024).toFixed()+" <span class='bytes'>KBs</span>":e+=" <span class='bytes'>bytes</span>",e},showCreateNewFileMenu:function(n,e,t,r){var i=this,o=[GetLanguage("Script"),GetLanguage("Text"),"Json",GetLanguage("Shader"),GetLanguage("Material"),GetLanguage("Animation"),GetLanguage("RenderTexture")];return new LiteGUI.ContextMenu(o,{event:e,title:"Create",callback:function(e,t,o){e==GetLanguage("Script")?i.showCreateScriptDialog({filename:"NewScript.js",folder:n},i.addResourceCommand):"Json"==e?i.showCreateFileDialog({filename:"data.json",folder:n},i.addResourceCommand):e==GetLanguage("Text")?i.showCreateFileDialog({filename:"text.txt",folder:n},i.addResourceCommand):e==GetLanguage("Pack")?PackTools.showCreatePackDialog({folder:n},i.addResourceCommand):e==GetLanguage("Shader")?i.showCreateShaderDialog({filename:"shader.glsl",folder:n},i.addResourceCommand):e==GetLanguage("Material")?i.showResourceMaterialDialog({filename:"material.mat",folder:n},i.addResourceCommand):e==GetLanguage("Animation")?i.showAnimationDialog({filename:"animation.anim",folder:n},i.addResourceCommand):e==GetLanguage("RenderTexture")&&i.showRenderTextureDialog({filename:"renderTexture.rpic",folder:n},i.addResourceCommand);r&&r.call(i)},parentMenu:t})},showRenderTextureDialog:function(e,o){var n=this,r="rpic";(e=e||{}).filename&&-1!=e.filename.indexOf(".")&&(r=TONG.RM.getExtension(e.filename));var i=e.filename||"unnamed."+r,a=e.folder||this.current_folder,s=new LiteGUI.Dialog({title:GetLanguage("New RenderTexture"),fullcontent:!0,closable:!0,draggable:!0,resizable:!0,width:300,height:300}),t=new LiteGUI.Inspector;return t.addString(GetLanguage("Filename"),i,function(e){i=e}),t.addFolder(GetLanguage("Folder"),a,function(e){a=e}),t.addButton(null,GetLanguage("Create"),function(){a=a||"",TONG.RM.getExtension(i)!=r&&(i+="."+r);var e=FileNameHelper.GetNextFileName(i),t=new TONG.RenderTexture;t.uuid=TONG.Math.generateUUID(),t.filename=e,a&&""!=a&&(t.fullpath=a+"/"+e);t.register(),t.fullpath&&DriveModule.saveResource(t,function(e){n.refreshContent()},{skip_alerts:!0});o&&o(t);s.close()}),s.add(t),s.show("fade"),s.adjustSize(),document.body.appendChild(s.root),s},showAnimationDialog:function(e,n){var r=this,i="anim";(e=e||{}).filename&&-1!=e.filename.indexOf(".")&&(i=TONG.RM.getExtension(e.filename));var a=e.filename||"unnamed."+i,s=e.folder||this.current_folder,l=new LiteGUI.Dialog({title:GetLanguage("New Animation"),fullcontent:!0,closable:!0,draggable:!0,resizable:!0,width:300,height:300}),t=new LiteGUI.Inspector;return t.addString(GetLanguage("Filename"),a,function(e){a=e}),t.addFolder(GetLanguage("Folder"),s,function(e){s=e}),t.addButton(null,GetLanguage("Create"),function(){s=s||"",TONG.RM.getExtension(a)!=i&&(a+="."+i);var e=FileNameHelper.GetNextFileName(a),t=new TONG.AnimationClip(e,20,[]),o=new TONG.AnimationData;o.uuid=t.uuid,o.filename=e,s&&""!=s&&(o.fullpath=s+"/"+e);o.setData(t),o.register(),o.fullpath&&DriveModule.saveResource(o,function(e){r.refreshContent()},{skip_alerts:!0});n&&n(o);l.close()}),l.add(t),l.show("fade"),l.adjustSize(),document.body.appendChild(l.root),l},addResourceCommand:function(e){EditorModule.target.execute(new AddResourceCommand(e))},showResourceMaterialDialog:function(r,i){var a=this,s=(r=r||{}).filename||"material.mat",l=r.folder||this.current_folder,c="ShaderMaterial",e=null,t=r.button||(r.material?"Save":"Create");r.material&&(e=r.material,c=getObjectClassName(r.material),e.fullpath&&(s=TONG.RM.getFilename(e.fullpath),l=TONG.RM.getFolder(e.fullpath)));var d=new LiteGUI.Dialog({title:r.material?GetLanguage("Material"):GetLanguage("New Material"),fullcontent:!0,closable:!0,draggable:!0,resizable:!0,width:400,height:300}),o=new LiteGUI.Inspector;o.addString(GetLanguage("Filename"),s,function(e){s=e}),o.addFolder(GetLanguage("Folder"),l,function(e){l=e});var n=[];for(var u in TONG.MaterialClasses)"registerMaterialClass"!=u&&"unRegisterMaterialClass"!=u&&"mat"!=TONG.RM.getExtension(u)&&n.push(u);return o.addCombo(GetLanguage("Material Class"),c,{disabled:!!r.material,values:n,callback:function(e){c=e}}),o.addButton(null,GetLanguage(t),function(){if(!s)return;l=l||"";var e=r.material;if(!e){var t=TONG.MaterialClasses[c];if(!t)return;e=new t}"mat"!=TONG.RM.getExtension(s)&&(s+=".mat");var o=FileNameHelper.GetNextFileName(s),n=TONG.RM.cleanFullpath(l+"/"+o);e.name=e.filename=o,e.resource_type=TONG.Resource.TYPE.Material,e.is_material=!0,e.fullpath=TONG.RM.cleanFullpath(l+"/"+o),TONG.RM.registerResource(n,e),TONG.MaterialClasses.registerMaterialClass(e),TONG.RM.resourceModified(e),TONG.RM.getFolder(e.fullpath)?DriveModule.saveResource(e,function(){a.refreshContent(),r.callback&&r.callback(e)},{skip_alerts:!0}):r.callback&&r.callback(e);i&&i(e);a.refreshContent(),d.close()}),d.add(o),d.show("fade"),d.adjustSize(),document.body.appendChild(d.root),d},showCreateFileDialog:function(o,n){var r=this,i="txt";(o=o||{}).filename&&-1!=o.filename.indexOf(".")&&(i=TONG.RM.getExtension(o.filename));var a=o.filename||"unnamed."+i,s=o.folder||this.current_folder,l=new LiteGUI.Dialog({title:GetLanguage("New File"),fullcontent:!0,closable:!0,draggable:!0,resizable:!0,width:300,height:300}),e=new LiteGUI.Inspector;return e.addString(GetLanguage("Filename"),a,function(e){a=e}),e.addFolder(GetLanguage("Folder"),s,function(e){s=e}),e.addButton(null,GetLanguage("Create"),function(){s=s||"",TONG.RM.getExtension(a)!=i&&(a+="."+i);var e=FileNameHelper.GetNextFileName(a),t=new TONG.Resource;switch(t.uuid=TONG.Math.generateUUID(),t.filename=e,i){case"txt":t.resource_type=TONG.Resource.TYPE.Text;break;case"json":t.resource_type=TONG.Resource.TYPE.Json}s&&""!=s&&(t.fullpath=s+"/"+e);t.data=o.content||" ",t.register(),t.fullpath&&DriveModule.saveResource(t,function(e){r.refreshContent()},{skip_alerts:!0});n&&n(t);l.close()}),l.add(e),l.show("fade"),l.adjustSize(),document.body.appendChild(l.root),l},showCreateScriptDialog:function(e,n){var r=(e=e||{}).filename||"unnamed_script.js",i=e.folder||this.current_folder,a=e.template||"script",s=new LiteGUI.Dialog({title:GetLanguage("New Script"),fullcontent:!0,closable:!0,draggable:!0,resizable:!0,width:300,height:300}),t=new LiteGUI.Inspector;t.addString(GetLanguage("Filename"),r,function(e){r=e}),t.addFolder(GetLanguage("Folder"),i,function(e){i=e});var o=[];for(var l in TONG.Script.templates)o.push(l);return t.addCombo(GetLanguage("Template"),a,{values:o,callback:function(e){a=e}}),t.addButton(null,GetLanguage("Create"),function(){if(!r)return;"js"!=TONG.RM.getExtension(r)&&(r+=".js");i=i||"";var e=FileNameHelper.GetNextFileName(r),t=new TONG.Script;t.uuid=TONG.Math.generateUUID(),t.fullpath=t.title=t.filename=e,i&&""!=i&&(t.fullpath=i+"/"+e);var o=TONG.Script.templates[a](e)||"";t.setData(o),t.register(),t.compile(),TONG.Components.registerScriptComponent(t),t.fullpath;n&&n(t);s.close()}),s.add(t),s.show("fade"),s.adjustSize(),document.body.appendChild(s.root),s},showCreateShaderDialog:function(s,l){var c=this,d=(s=s||{}).filename||"shader.glsl",u=s.folder||this.current_folder,h=s.type||"default",f=new LiteGUI.Dialog({title:GetLanguage("New Shader"),fullcontent:!0,closable:!0,draggable:!0,resizable:!0,width:300,height:300}),e=new LiteGUI.Inspector;e.addString(GetLanguage("Filename"),d,function(e){d=e}),e.addFolder(GetLanguage("Folder"),u,function(e){u=e});var t=[];for(var o in TONG.ShaderCode.examples)t.push(o);return e.addCombo(GetLanguage("Shader Template"),h,{values:t,callback:function(e){h=e}}),e.addButton(null,GetLanguage("Create"),function(){if(!d)return;u=u||"","glsl"!=TONG.RM.getExtension(d)&&(d+=".glsl");var e=FileNameHelper.GetNextFileName(d),t=new TONG.ShaderCode;t.filename=e,t.uuid=TONG.Math.generateUUID();var o=TONG.RM.removeExtension(e);u&&""!=u&&(t.fullpath=u+"/"+e);t.data=t.code=s.content||TONG.ShaderCode.examples[h](o),TONG.ResourcesManager.registerResource(t.fullpath||t.filename,t);for(var n=TONG.RM.getResourceByType(TONG.Resource.TYPE.Material),r=0;r<n.length;r++)if(n[r]instanceof TONG.ShaderMaterial&&n[r].editorTarget){var i=n[r].editorTarget.shader.getValue(),a=n[r].editorTarget.shader.addElement(t.filename);n[r].editorTarget.shaderWidget&&n[r].editorTarget.shaderWidget.setOptionValues(a,i)}t.fullpath&&DriveModule.saveResource(t,function(e){c.refreshContent()},{skip_alerts:!0});l&&l(t);s.on_complete&&s.on_complete(t,e,u,t.fullpath);f.close()}),f.add(e),f.show("fade"),f.adjustSize(),document.body.appendChild(f.root),f}};DriveModule.getResourceAsFile=DriveModule.getResourceAsBlob,CORE.registerModule(DriveModule),DriveModule.registerAssignResourceCallback("Mesh",function(e,t,o){DriveModule.loadResource(e);var n=o.mesh_action||"replace",r=null;if("replace"==n&&o.node,"replace"==n&&(n="scene"),r=LS.newMeshNode(LS.GlobalScene.generateUniqueNodeName(),e),EditorModule.getAddRootNode().addChild(r),o.event){GL.augmentEvent(o.event);var i=null;if("plane"==n)i=RenderModule.testGridCollision(o.event.canvasx,o.event.canvasy);else if("scene"==n){var a=ToolUtils.getCamera().getRayInPixel(o.event.canvasx,o.event.canvasy),s=LS.Physics.raycastRenderInstances(a.origin,a.direction,{triangle_collision:!0});i=s&&s.length?s[0].position:RenderModule.testGridCollision(o.event.canvasx,o.event.canvasy)}i&&(r.transform.position=i)}SelectionModule.setSelection(r)}),DriveModule.registerAssignResourceCallback(["Texture","image/jpg","image/png"],function(e,t,o){var n=LS.GlobalScene.selected_node,r=o.texture_action||"material";o.event&&(GL.augmentEvent(o.event),n=RenderModule.getNodeAtCanvasPosition(o.event.canvasx,o.event.canvasy)),DriveModule.loadResource(e);var i=null;if("replace"==r||"material"==r){var a=o.channel||o.target||LS.Material.COLOR_TEXTURE;if(n){n.material||(n.material=new LS.StandardMaterial);var s=n.getMaterial(),l=s.getTextureChannels();-1==l.indexOf(a)&&(a=l[0]),a&&s.setTexture(a,e)}}else if("plane"==r)n=new LS.SceneNode,i=new LS.Components.GeometricPrimitive({geometry:LS.Components.GeometricPrimitive.PLANE}),n.addComponent(i),i.texture=e,EditorModule.getAddRootNode().addChild(n),n.material||(n.material=new LS.StandardMaterial),n.material.setTexture("color",e);else if("sprite"==r){(n=new LS.SceneNode).name=LS.ResourcesManager.getBasename(e),i=new LS.Components.Sprite,n.addComponent(i),i.texture=e;var c=LS.ResourcesManager.getTexture(e);c&&(i.size=[c.width,c.height]),EditorModule.getAddRootNode().addChild(n)}i&&(CORE.userAction("component_created",i),SelectionModule.setSelection(i)),EditorModule.inspect(n)}),DriveModule.onInsertMaterial=function(e,t,o){return!1},DriveModule.registerAssignResourceCallback(null,DriveModule.onInsertMaterial),DriveModule.registerAssignResourceCallback("SceneNode",function(e,t,o){var n=SelectionModule.getSelectedNode()||LS.GlobalScene.root,r=LS.RM.resources[e];r&&r.constructor===LS.SceneNode?(CORE.userAction("node_created",r),n.addChild(r)):LS.RM.load(e,function(e,t){e&&e.constructor===LS.SceneNode&&(CORE.userAction("node_created",e),n.addChild(e))})}),DriveModule.registerAssignResourceCallback("component",function(e,t,o){DriveModule.loadResource(e,function(e){if(e){var t=e.data;t.constructor===String&&(t=JSON.parse(t));var o=t.object_class;if(o&&LS.Components[o]){var n=new LS.Components[o];n.configure(t),(SelectionModule.getSelectedNode()||LS.GlobalScene.root).addComponent(n),EditorModule.refreshAttributes(),RenderModule.requestFrame()}else LiteGUI.alert("Unknown object class type: "+o)}})}),DriveModule.registerAssignResourceCallback("SceneTree",function(o,e,t){LiteGUI.confirm("Are you sure? you will loose the current scene",function(e){if(e){LS.GlobalScene.clear();var t=LS.RM.resources[o];t?(SceneStorageModule.setSceneFromJSON(t.serialize()),t.extra.folder=LS.ResourcesManager.getFolder(o),t.extra.fullpath=o,DriveModule.closeTab()):SceneStorageModule.loadScene(o,null,!0)}})}),DriveModule.registerAssignResourceCallback("Pack",function(e,t,o){DriveModule.loadResource(e,function(n){n&&n._data&&n._data["scene.json"]&&LiteGUI.confirm("Do you want to load the scene inside the PACK? Current scene will be lost",function(e){if(e){var t=n._data["scene.json"],o=JSON.parse(t);LS.GlobalScene.clear(),LS.GlobalScene.setFromJSON(o)}})})}),DriveModule.registerAssignResourceCallback("Prefab",function(e,t,o){var n=null;o.event&&(GL.augmentEvent(o.event),n=RenderModule.testGridCollision(o.event.canvasx,o.event.canvasy)),DriveModule.loadResource(e,function(e){var t=null;if(e.constructor===LS.Prefab?t=e.createObject():e.constructor===LS.SceneNode&&(t=e.clone()),!t)return LiteGUI.alert("Error in Prefab, cannot be inserted");LS.GlobalScene.root.addChild(t);var o=t.getResources({});LS.ResourcesManager.loadResources(o),n&&(t.transform.position=n),EditorModule.inspect(t),SelectionModule.setSelection(t)})}),DriveModule._textResourceCallback=function(e,t,o){var n=TONG.RM.getResource(e);if(n)if(n){var r=null;if(n.getData?r=n.getData():n.data&&(r=n.data),null!=r&&r.constructor===String){var i=TONG.RM.getExtension(n.filename);n instanceof TONG.Script&&(i="javascript");var a=TONG.Script.setScript(n.filename,i,r,n);TONG.Event.bind(a,"editInfo",function(e,t){n._code?n.data=n._code=t:n.data=t},a)}else document.body.appendChild(LiteGUI.alert("No data found in resource").root)}else console.warn("Assigning resource without loading it");else TONG.ResourcesManager.load(e,null,function(e,t){DriveModule.onInsertResourceInScene(e,t)})},DriveModule.registerAssignResourceCallback(["Data","Resource","application/javascript","text/plain","text/html","text/css","text/csv","TEXT","Text","Json"],DriveModule._textResourceCallback),DriveModule.registerAssignResourceCallback(["ShaderCode","Script"],DriveModule._textResourceCallback),LiteGUI.Inspector.prototype.addFolder=function(e,t,o){(o=this.processOptions(o)).callback_button;return o.callback_button=function(){DriveModule.showSelectFolderDialog(function(e){w.setValue(e)},null,w.getValue())},o.icon="imgs/mini-icon-folder.png",w=this.addStringButton(e,t,o),w.querySelector("input").classList.add("fixed_size"),w},LiteGUI.Inspector.widget_constructors.folder="addFolder";var ResourcesPanelWidget=function(e){e=e||{};var i=this;this.selected_item=null,this.current_folder=null,this.current_bridge=null,(this.widget=this).filter_by_name=null,this.filter_by_category=null,this.root=document.createElement("div"),this.root.className="resources-panel",(this.root.panel=this).root.style.width="100%",this.root.style.height="100%",e.id&&(this.root.id=e.id),this.area=new LiteGUI.Area(null),this.area.split("horizontal",[320,null],{draggable:!0}),this.area.getSection(0).content.style.overflow="auto",this.area.getSection(0).content.style.backgroundColor="black",this.root.appendChild(this.area.root),this.createTreeWidget(),this.rootItem=this.tree_widget.root.childNodes[1],console.log(this.rootItem);var t=this.area.getSection(1);this.area.root.addEventListener("contextmenu",function(e){this.showFolderContextMenu(e),e.preventDefault()}.bind(i));var o=new LiteGUI.Area({full:!0});t.add(o),o.split("vertical",[30,null]);var n=new LiteGUI.Inspector({one_line:!0});if(n.root.style.marginTop="4px",!e.skip_actions){var a=n.addIcon(null,"",{image:"css/pic/plus.png",width:14,height:14,callback:function(e,t){var o=DriveModule.showCreateNewFileMenu(i.current_folder,t),n=$(a).offset().top,r=$(a).offset().left+14;o.root.style.left=r+"px",o.root.style.top=n+"px"}});a.style.marginTop="3px",n.addSeparator(),n.addIcon(null,"",{image:"css/pic/crash.png",width:14,height:14,callback:function(e,t){}}).style.marginTop="3px",n.addSeparator()}n.addString(null,"",{name_width:40,icon:"css/pic/search.png",content_width:120,width:120,callback:function(e){i.filterByName(e)}}),this.filter_by_category_widget=n.addCombo(null,"DEFAULT",{values:TONG.Resource.TYPE,callback:function(e){i.filterByCategory(e,!0)}}),n.addButton(null,GetLanguage("Import"),{callback:function(){ImporterModule.showImportResourceDialog(null,{folder:i.current_folder},function(e){EditorModule.target.execute(new AddResourceCommand(e)),i.refreshContent()})}}).querySelector("button").style.color="#f67000",n.addSeparator(),n.addIcon(null,"",{image:"css/pic/library.png",width:19,height:16,callback:function(){window.open("http://docs.tong3d.com/engine/pro/cn/guide-index.html")}}).style.marginTop="3px",o.sections[0].add(n),this.browser_container=o.sections[1].content,this.browser_container.classList.add("resources-panel-container"),this.showInBrowserContent(null);var r=this.onLoginEvent.bind(this),s=this.onTreeUpdate.bind(this);$(this.root).bind("DOMNodeInserted",function(e){"resources-panel"==e.target.className&&(LiteGUI.bind(CORE,"user-login",r),LiteGUI.bind(CORE,"user-logout",r),LiteGUI.bind(DriveModule,"tree_updated",s),TONG.Event.bind(TONG.ResourcesManager,"resource_registered",i.onResourceRegistered,i))}),$(this.root).bind("DOMNodeRemoved",function(e){"resources-panel"==e.target.className&&(LiteGUI.unbind(CORE,"user-login",r),LiteGUI.unbind(CORE,"user-logout",r),LiteGUI.unbind(DriveModule,"tree_updated",s),TONG.Event.unbind(TONG.ResourcesManager,"resource_registered",i.onResourceRegistered,i))}),LiteGUI.createDropArea(this.browser_container,function(e){var t=i.current_folder,o=i.current_bridge;if(!o)return!1;if(o.onDropInFolder){var n=o.onDropInFolder(t,e);return n&&e.stopPropagation(),n}}),this.bindEvents()};ResourcesPanelWidget.widget_name=GetLanguage("Resources"),CORE.registerWidget(ResourcesPanelWidget),ResourcesPanelWidget.createDialog=function(e){var t=new LiteGUI.Dialog({title:ResourcesPanelWidget.widget_name,fullcontent:!0,closable:!0,draggable:!0,detachable:!0,minimize:!0,resizable:!0,parent:e,width:900,height:500});document.body.appendChild(t.root);var o=new ResourcesPanelWidget;return t.add(o),t.widget=o,t.on_close=function(){o.unbindEvents()},t.show(),t.center(),t},ResourcesPanelWidget.prototype.selectFolder=function(e){var t=this.tree_widget.getItem(e);t&&LiteGUI.trigger(t,"click")},ResourcesPanelWidget.prototype.getTreeData=function(){return DriveModule.tree},ResourcesPanelWidget.prototype.update=function(e){},ResourcesPanelWidget.prototype.createTreeWidget=function(){var e=new LiteGUI.Tree(this.getTreeData(),{allow_rename:!0,indent_offset:-1});e.root.classList.add("resources-tree"),e.root.style.backgroundColor="#282828",e.root.style.padding="5px",e.root.style.width="100%",e.root.style.height="100%",this.tree_widget=e;var n=this;return this.area.add(e),this.tree_widget.onItemContextMenu=function(e,t){var o=t.data.fullpath;if(o){new LiteGUI.ContextMenu([GetLanguage("Create Folder"),GetLanguage("Delete Folder"),GetLanguage("Rename"),GetLanguage("Import Project")],{event:e,callback:function(e){e==GetLanguage("Create Folder")?DriveModule.onCreateFolderInServer(o,function(){n.refreshTree()}):e==GetLanguage("Delete Folder")?DriveModule.onDeleteFolderInServer(o,function(){n.refreshTree()}):e==GetLanguage("Import Project")&&DriveModule.onImportToFolder(o,function(){n.refreshTree()})}});return e.preventDefault(),!1}},e.root.addEventListener("item_selected",function(e){var t=e.detail.data;t.className&&(t.bridge&&t.bridge.onFolderSelected?(n.current_folder=t.fullpath,n.current_bridge=t.bridge,t.bridge.onFolderSelected(t,n)):(n.current_folder="",n.current_bridge=null))}),e.root.addEventListener("drop_on_item",function(e){var t=e.detail.item,o=e.detail.event,n=t.parentNode.data,r=n.fullpath,i=n.bridge;i&&i.onDropInFolder&&i.onDropInFolder(r,o)}),e.root.addEventListener("item_renamed",function(e){e.detail}),e},ResourcesPanelWidget.prototype.showInBrowserContent=function(e,t){t=t||{};var o=this.browser_container;if(t.preserve){var n=document.createElement("div");if(n.className="file-list-block",o.appendChild(n),t.info){var r=document.createElement("div");r.className="info",r.innerHTML=t.info,n.appendChild(r)}}else{o.innerHTML="";var i=document.createElement("ul");if(i.className="file-list",i.style.height="calc( 100% )",o.appendChild(i),this.visible_resources=e,this._last_options=t,e){for(var a in e)if(":"!=a[0]){var s=e[a];s.name||(s.name=a),this.addItemToBrowser(s)}}else t.content?i.innerHTML=t.content:t.info?i.innerHTML="<div class='file-list-info'>"+t.info+"</div>":i.innerHTML="<div class='file-list-info'>No items</div>"}},ResourcesPanelWidget.Deselect=function(e){var t=$("ul.file-list")?$("ul.file-list")[0]:null;if(t)for(var o=t.querySelectorAll(".selected"),n=0;n<o.length;++n)o[n].classList.remove("selected");window.RESOURCE=null,e||InspectorPanel.ClearContent()},ResourcesPanelWidget.prototype.addItemToBrowser=function(t){var i=this,e=TONG.ResourcesManager.resources[t.fullpath];if(!e||!e.is_preview){var a=this.browser_container.querySelector(".file-list"),s=document.createElement("li");t.uid&&(s.dataset.id=t.uid),s.dataset.filename=t.filename,t.fullpath&&(s.dataset.fullpath=t.fullpath);var o=DriveModule.getResourceCategory(t),n=t.resource_type||t.category;"Object"==n&&(n=TONG.Formats.guessType(t.fullpath||t.filename)),n||(n="unknown"),s.dataset.restype=n,s.dataset.category=o,s.className="resource file-item resource-"+n,t.uid?s.className+=" in-server":s.className+=" in-client",(s.resource=t).element=s;var r=DriveModule.getFilename(t.filename);if(r||(r=t.fullpath||""),s.title=n+": "+t.filename,r){var l=r.split(".");l=l.shift()+"<span class='extension'>."+l.join(".")+"</span>",s.innerHTML="<span class='title'>"+l+"</span>"}var c=TONG.RM.getExtension(r);c=c&&"JSON"!=c.toUpperCase()?c.toUpperCase():n;var d=t._preview_url,u=t.fullpath||t.filename;if(d){if("string"==typeof d&&"data:image/"==d.substr(0,11)){u=t.fullpath||t.filename;if(DriveModule.generated_previews[u])d=DriveModule.generated_previews[u];else(h=new Image).src=d,h.style.maxWidth=200,d=DriveModule.generated_previews[u]=h}}else if(t.in_server||t.remotepath)d=DriveModule.getServerPreviewURL(t);else if(DriveModule.generated_previews[u])d=DriveModule.generated_previews[u];else if(!t.fullpath){if(d=DriveModule.generatePreview(u,void 0,!0))(h=new Image).src=d,h.style.maxWidth=200,d=DriveModule.generated_previews[u]=h}if(d||(d=Resource.panel.icons[n]?Resource.panel.icons[n]:null),d){var h;if("string"==typeof d)(h=new Image).src=d,h.style.maxWidth=200,h.onerror=function(){this.parentNode.removeChild(this)};else h=d;h.className="img type",s.appendChild(h)}s.addEventListener("click",function(e){for(var t=s.dataset.fullpath||s.dataset.filename,o=a.querySelectorAll(".selected"),n=0;n<o.length;++n)o[n].classList.remove("selected");s.querySelector(".title").classList.add("selected"),LiteGUI.trigger(i,"item_selected",s),LiteGUI.trigger(i,"resource_selected",t),i.selected_item=s;var r=TONG.RM.getResource(t);window.RESOURCE=r,EditorModule.inspect(r.callEditorTarget())}),s.addEventListener("dblclick",function(e){var t=s.dataset.fullpath||s.dataset.filename,o=TONG.RM.getResource(t);o.onDblclick&&o.onDblclick();DriveModule.onInsertResourceInScene(this)}),this.applyFilters([s]),a.appendChild(s),s.draggable=!0,s.addEventListener("dragstart",function(e){e.dataTransfer.setData("res-filename",t.filename),t.fullpath&&e.dataTransfer.setData("res-fullpath",t.fullpath),e.dataTransfer.setData("res-type",n),e.dataTransfer.setData("type","resource")}),s.addEventListener("contextmenu",function(e){return 2!=e.button||(i.showItemContextMenu(this,e),e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault()),!1})}},ResourcesPanelWidget.prototype.showItemContextMenu=function(a,e){var s=this,t=[GetLanguage("Clone"),GetLanguage("Properties"),null,GetLanguage("Delete")];new LiteGUI.ContextMenu(t,{ignore_item_callbacks:!0,event:e,title:GetLanguage("Resource"),callback:function(e,t,o){var n=a.dataset.fullpath||a.dataset.filename;if(n)if(e==GetLanguage("Insert"))DriveModule.onInsertResourceInScene(a);else if(e==GetLanguage("Load"))TONG.ResourcesManager.load(n);else if(e==GetLanguage("Rename"))DriveModule.showRenameResourceDialog(a.resource);else if(e==GetLanguage("Clone")){var r=TONG.RM.getResource(a.resource.filename),i=DriveModule.cloneResource(r);EditorModule.target.execute(new AddResourceCommand(i)),DriveModule.refreshContent()}else if(e==GetLanguage("Move"))LiteGUI.alert("Not implemented yet");else if(e==GetLanguage("Properties"))DriveModule.showResourceInfoInDialog(a.resource);else if("Set as Modifyed"==e)TONG.RM.resourceModified(a.resource),s.refreshContent();else if(e==GetLanguage("Delete")){r=TONG.RM.getResource(a.resource.filename);EditorModule.target.execute(new RemoveResourceCommand(r)),DriveModule.refreshContent()}else LiteGUI.alert("Unknown action")}})},ResourcesPanelWidget.prototype.onTreeUpdated=function(){this.tree_widget.updateTree(DriveModule.tree)},ResourcesPanelWidget.prototype.refreshTree=function(){this.tree_widget.updateTree(DriveModule.tree)},ResourcesPanelWidget.prototype.refreshContent=function(){this.current_bridge?this.current_bridge.updateContent(this.current_folder):this.showInBrowserContent(TONG.ResourcesManager.resources)},ResourcesPanelWidget.prototype.showMemoryResources=function(){this.showInBrowserContent(TONG.ResourcesManager.resources)},ResourcesPanelWidget.prototype.destroy=function(){TONG.Event.unbindAll(LS.GlobalScene,this),this.root.parentNode&&this.root.parentNode.removeChild(this.root)},ResourcesPanelWidget.prototype.bindEvents=function(){},ResourcesPanelWidget.prototype.unbindEvents=function(){},ResourcesPanelWidget.prototype.onResourceRegistered=function(e,t){this.current_folder||this.addItemToBrowser(t)},ResourcesPanelWidget.prototype.clear=function(){this.tree&&this.tree.clear(!0)},ResourcesPanelWidget.prototype.showContextMenu=function(e){new LiteGUI.ContextMenu([GetLanguage("Refresh")],{event:event,callback:function(e){e==GetLanguage("Refresh")&&this.refresh()}})},ResourcesPanelWidget.prototype.applyFilters=function(e){e||(e=this.root.querySelector("ul.file-list").querySelectorAll(".file-item"));for(var t=0;t<e.length;++t){var o=e[t],n=!1,r=o.dataset.filename;this.filter_by_name&&r&&(r=r.toLowerCase(),this.filter_by_name&&-1==r.indexOf(this.filter_by_name)&&(n=!0));var i=o.dataset.category;this.filter_by_category&&i&&(i=i.toLowerCase())!=this.filter_by_category&&(n=!0),n?o.classList.add("filtered"):o.classList.remove("filtered")}},ResourcesPanelWidget.prototype.filterByName=function(e){this.filter_by_name=e?e.toLowerCase():null,this.applyFilters()},ResourcesPanelWidget.prototype.filterByCategory=function(e,t){this.filter_by_category=e?e.toLowerCase():null,this.applyFilters(),!t&&this.filter_by_category_widget&&this.filter_by_category_widget.setValue(e.toUpperCase())},ResourcesPanelWidget.prototype.refresh=function(e){var t=this;e?DriveModule.getServerFoldersTree(function(){t.tree_widget.updateTree(DriveModule.tree)}):this.tree_widget.updateTree(DriveModule.tree)},ResourcesPanelWidget.prototype.onLoginEvent=function(e){},ResourcesPanelWidget.prototype.onTreeUpdate=function(e){this.refreshTree(),this.refreshContent()},ResourcesPanelWidget.prototype.showFolderContextMenu=function(e){var n=this,t=[GetLanguage("Create"),GetLanguage("Import"),GetLanguage("Refresh")],r=new LiteGUI.ContextMenu(t,{event:e,title:GetLanguage("Folder"),callback:function(e,t,o){e==GetLanguage("Create")?DriveModule.showCreateNewFileMenu(n.current_folder,o,r,i):e==GetLanguage("Import")?ImporterModule.showImportResourceDialog(null,{folder:n.current_folder},function(e){EditorModule.target.execute(new AddResourceCommand(e)),i()}):e==GetLanguage("Refresh")&&n.refreshContent()}});function i(){n.refreshContent()}};var ImporterModule={name:"importer",preferences:{optimize_data:!0,mesh_action:"load",texture_action:"replace",use_names_to_reference:!0,force_lowercase:!0},init:function(){window.addEventListener("paste",this.onPaste.bind(this))},onPaste:function(e){console.log("pasted items:",e.clipboardData.items.length,"files:",e.clipboardData.files.length,"types:",e.clipboardData.types.length);var t=(e.clipboardData||e.originalEvent.clipboardData).items,o=t.length?t[0]:null;if(o&&"file"==o.kind)return this.onLoadPastedItem(o),!1},loadFile:function(t,h){var f=t.name,p=FileSystem.getFileExtension(f),i=void 0!==t.path?FileSystem.getFilePath(t.path):"";try{if("gcode"===p)(m=new FileReader).onload=function(e){var t=(new TONG.GCodeLoader).parse(m.result),o={name:f,size:e.target.result.length||e.target.result.byteLength,type:p,data:t};h&&h(o)},m.readAsText(t);else if("obj"===p){(m=new FileReader).onload=function(e){try{var t=new TONG.OBJLoader;0;var o=t.parse(m.result);o.name=FileSystem.getFileName(f);var n={name:f,size:e.target.result.length||e.target.result.byteLength,type:p,data:o};h&&h(n)}catch(e){LiteGUI.alert("Error loading file: "+e),console.error("Tong Engine: Error loading file",e)}},m.readAsText(t)}else if("awd"===p){(m=new FileReader).onload=function(e){try{var t=new TONG.AWDLoader;t._baseDir=i;var o=t.parse(m.result),n={name:f,size:e.target.result.length||e.target.result.byteLength,type:p,data:o};h&&h(n)}catch(e){LiteGUI.alert("Error loading file: "+e),console.error("Tong Engine: Error loading file",e)}},m.readAsArrayBuffer(t)}else if("amf"===p){(m=new FileReader).onload=function(e){try{var t=(new TONG.AMFLoader).parse(m.result),o={name:f,size:e.target.result.length||e.target.result.byteLength,type:p,data:t};h&&h(o)}catch(e){LiteGUI.alert("Error loading file: "+e),console.error("Tong Engine: Error loading file",e)}},m.readAsArrayBuffer(t)}else if("assimp"===p){(m=new FileReader).onload=function(e){try{var t=(new TONG.AssimpLoader).parse(m.result,i),o={name:f,size:e.target.result.length||e.target.result.byteLength,type:p,data:t};h&&h(o)}catch(e){LiteGUI.alert("Error loading file: "+e),console.error("Tong Engine: Error loading file",e)}},m.readAsArrayBuffer(t)}else if(f.endsWith(".assimp.json")){(m=new FileReader).onload=function(e){try{var t=new TONG.AssimpJSONLoader,o=JSON.parse(m.result),n=t.parse(o,i),r={name:f,size:e.target.result.length||e.target.result.byteLength,type:p,data:n};h&&h(r)}catch(e){LiteGUI.alert("Error loading file: "+e),console.error("Tong Engine: Error loading file",e)}},m.readAsText(t)}else if("babylon"===p){(m=new FileReader).onload=function(e){try{var t=new TONG.BabylonLoader,o=JSON.parse(m.result),n=t.parse(o,i);n.type="Group",n.traverse(function(e){e instanceof TONG.Mesh&&(e.material=new TONG.MeshPhongMaterial)});var r={name:f,size:e.target.result.length||e.target.result.byteLength,type:p,data:n};h&&h(r)}catch(e){LiteGUI.alert("Error loading file: "+e),console.error("Tong Engine: Error loading file",e)}},m.readAsText(t)}else if("blend"===p){(m=new FileReader).onload=function(n){try{JSBLEND(m.result).then(function(e){var t=new Container;t.name=FileSystem.getNameWithoutExtension(f),e.three.loadScene(t);var o={name:f,size:n.target.result.length||n.target.result.byteLength,type:p,data:t};h&&h(o)})}catch(n){LiteGUI.alert("Error loading file: "+n),console.error("Tong Engine: Error loading file",n)}},m.readAsArrayBuffer(t)}else if("3ds"===p){(m=new FileReader).onload=function(e){try{var t=new TONG.TDSLoader;t.setPath(i);var o=t.parse(m.result),n={name:f,size:e.target.result.length||e.target.result.byteLength,type:p,data:o};h&&h(n)}catch(e){LiteGUI.alert("Error loading file: "+e),console.error("Tong Engine: Error loading file",e)}},m.readAsArrayBuffer(t)}else if("dae"===p){(m=new FileReader).onload=function(){try{var t=(new TONG.ColladaLoader).parse(m.result,i),o=t.scene,n=t.animations;0<n.length&&o.traverse(function(e){if(e instanceof TONG.SkinnedMesh){e.animations=n;for(var t=0;t<e.animations.length;t++)TONG.RM.addAnimClip(e.animations[t]);e.source=o}});var r={name:f,size:e.target.result.length||e.target.result.byteLength,type:p,data:o};h&&h(r)}catch(e){LiteGUI.alert("Error loading file: "+e),console.error("Tong Engine: Error loading file",e)}},m.readAsText(t)}else if("drc"===p){(m=new FileReader).onload=function(n){try{TONG.DRACOLoader.setDecoderPath(Editor.filePath+"wasm/draco/"),TONG.DRACOLoader.setDecoderConfig({type:"wasm"}),(new TONG.DRACOLoader).decodeDracoFile(m.result,function(e){e.computeVertexNormals();var t=new TONG.Mesh(e,Editor.defaultMaterial),o={name:f,size:n.target.result.length||n.target.result.byteLength,type:p,data:t};h&&h(o),TONG.DRACOLoader.releaseDecoderModule()})}catch(n){LiteGUI.alert("Error loading file: "+n),console.error("Tong Engine: Error loading file",n)}},m.readAsArrayBuffer(t)}else if("gltf"===p||"glb"===p){(m=new FileReader).onload=function(r){try{(new TONG.GLTFLoader).parse(m.result,i,function(e){var o=e.scene;o.type="Group",o.name=FileSystem.getNameWithoutExtension(f);var n=e.animations;0<n.length&&o.traverse(function(e){if(e instanceof TONG.SkinnedMesh){e.animations=n;for(var t=0;t<e.animations.length;t++)TONG.RM.addAnimClip(e.animations[t]);e.source=o}});var t={name:f,size:r.target.result.length||r.target.result.byteLength,type:p,data:o};h&&h(t)})}catch(r){LiteGUI.alert("Error loading file: "+r),console.error("Tong Engine: Error loading file",r)}},m.readAsArrayBuffer(t)}else if("ply"===p){(m=new FileReader).onload=function(e){try{var t=new TONG.PLYLoader,o=FileSystem.getNameWithoutExtension(f),n=t.parse(m.result);n.name=o;var r=new Mesh(n,Editor.defaultMaterial);r.name=o;var i={name:f,size:e.target.result.length||e.target.result.byteLength,type:p,data:r};h&&h(i)}catch(e){LiteGUI.alert("Error loading file: "+e),console.error("Tong Engine: Error loading file",e)}},m.readAsText(t)}else if("vtk"===p||"vtp"===p){(m=new FileReader).onload=function(e){try{var t=new TONG.VTKLoader,o=FileSystem.getNameWithoutExtension(f),n=t.parse(m.result);n.name=o;var r=new Mesh(n,Editor.defaultMaterial);r.name=o;var i={name:f,size:e.target.result.length||e.target.result.byteLength,type:p,data:r};h&&h(i)}catch(e){LiteGUI.alert("Error loading file: "+e),console.error("Tong Engine: Error loading file",e)}},m.readAsArrayBuffer(t)}else if("prwm"===p){(m=new FileReader).onload=function(){try{var t=new TONG.PRWMLoader,o=FileSystem.getNameWithoutExtension(f),n=t.parse(m.result);n.name=o;var r=new Mesh(n,Editor.defaultMaterial);r.name=o;var i={name:f,size:e.target.result.length||e.target.result.byteLength,type:p,data:r};h&&h(i)}catch(e){LiteGUI.alert("Error loading file: "+e),console.error("Tong Engine: Error loading file",e)}},m.readAsArrayBuffer(t)}else if("wrl"===p||"vrml"===p){(m=new FileReader).onload=function(e){try{var t=(new TONG.VRMLLoader).parse(m.result),o={name:f,size:e.target.result.length||e.target.result.byteLength,type:p,data:t};h&&h(o)}catch(e){LiteGUI.alert("Error loading file: "+e),console.error("Tong Engine: Error loading file",e)}},m.readAsText(t)}else if("fbx"===p){(m=new FileReader).onload=function(e){try{var o=(new TONG.FBXLoader).parse(m.result,i);0<o.animations.length&&o.traverse(function(e){if(e instanceof TONG.SkinnedMesh){e.animations=o.animations;for(var t=0;t<e.animations.length;t++)TONG.RM.addAnimClip(e.animations[t]);e.source=o}});var t={name:f,size:e.target.result.length||e.target.result.byteLength,type:p,data:o};h&&h(t)}catch(e){LiteGUI.alert("Error loading file: "+e),console.error("Tong Engine: Error loading file",e)}},m.readAsArrayBuffer(t)}else if("x"===p){function s(e,t){var o={};o.fps=e.fps,o.name=t,o.hierarchy=[];for(var n=0;n<e.hierarchy.length;n++){var r=-1,i={};i.name=e.hierarchy[n].name,i.parent=e.hierarchy[n].parent,i.keys=[];for(var a=1;a<e.hierarchy[n].keys.length&&(0<e.hierarchy[n].keys[a].time&&(-1===r&&(r=a-1,i.keys.push(e.hierarchy[n].keys[a-1])),i.keys.push(e.hierarchy[n].keys[a])),o.length=e.hierarchy[n].keys[a].time,!(a>=e.hierarchy[n].keys.length-1));a++);o.hierarchy.push(i)}return o}(m=new FileReader).onload=function(a){try{var e=new TONG.XLoader;e.baseDir=i,e.parse(m.result,function(e){for(var t=0;t<e.FrameInfo.length;t++){var o=e.FrameInfo[t];if(o instanceof TONG.SkinnedMesh){if(void 0!==e.XAnimationObj&&0<e.XAnimationObj.length)for(var n=e.XAnimationObj,r=0;r<n.length;r++)o.animationSpeed=1e3,o.animations.push(TONG.AnimationClip.parseAnimation(s(n[r],n[r].name),o.skeleton.bones));for(t=0;t<o.animations.length;t++)TONG.RM.addAnimClip(o.animations[t]);o.source=e}var i={name:f,size:a.target.result.length||a.target.result.byteLength,type:p,data:o};h&&h(i)}})}catch(a){LiteGUI.alert("Error loading file: "+a),console.error("Tong Engine: Error loading file",a)}},m.readAsArrayBuffer(t)}else if("pcd"===p){(m=new FileReader).onload=function(e){try{var t=(new TONG.PCDLoader).parse(m.result,o.name);t.material.name="points";var o={name:f,size:e.target.result.length||e.target.result.byteLength,type:p,data:t};h&&h(o)}catch(e){LiteGUI.alert("Error loading file: "+e),console.error("Tong Engine: Error loading file",e)}},m.readAsArrayBuffer(t)}else if("svg"===p){(m=new FileReader).onload=function(e){try{for(var t=(new TONG.SVGLoader).parse(m.result),o=new Container,n=0,r=0;r<t.length;r++)for(var i=new TONG.MeshBasicMaterial({color:t[r].color}),a=t[r].toShapes(!0),s=0;s<a.length;s++){var l=a[s],c=new TONG.ShapeBufferGeometry(l),d=new TONG.Mesh(c,i);d.position.z=n,n+=.1,o.add(d)}var u={name:f,size:e.target.result.length||e.target.result.byteLength,type:p,data:o};h&&h(u)}catch(e){LiteGUI.alert("Error loading file: "+e),console.error("Tong Engine: Error loading file",e)}},m.readAsText(t)}else if("stl"===p){(m=new FileReader).onload=function(e){try{var t=new TONG.STLLoader,o=FileSystem.getNameWithoutExtension(f),n=t.parse(m.result);n.name=o;var r={name:f,size:e.target.result.length||e.target.result.byteLength,type:p,data:new TONG.Mesh(n,new TONG.MeshStandardMaterial)};h&&h(r)}catch(e){LiteGUI.alert("Error loading file: "+e),console.error("Tong Engine: Error loading file",e)}},m.readAsArrayBuffer(t)}else if(TONG.Formats.getFileFormatInfo(f).resource==TONG.Resource.TYPE.Video){(m=new FileReader).onload=function(e){var t=new Video(m.result,p),o={name:f,size:e.target.result.length||e.target.result.byteLength,type:p,data:t};h&&h(o)},m.readAsArrayBuffer(t)}else if(TONG.Formats.getFileFormatInfo(f).resource==TONG.Resource.TYPE.Audio){(m=new FileReader).onload=function(e){var t=new Audio(m.result),o={name:t.name=f,size:e.target.result.length||e.target.result.byteLength,type:p,data:t};h&&h(o)},m.readAsArrayBuffer(t)}else if(TONG.Formats.getFileFormatInfo(f).resource==TONG.Resource.TYPE.Font){p=FileSystem.getFileExtension(f);(m=new FileReader).onload=function(e){if("font"===p||"fnt"===p)var t=new TONG.Font(JSON.parse(m.result));else(t=new TONG.Font(m.result)).encoding=p;var o={name:t.name=f,size:e.target.result.length||e.target.result.byteLength,type:p,data:t};h&&h(o)},"font"===p?m.readAsText(t):m.readAsArrayBuffer(t)}else if("json"===p){var m;(m=new FileReader).onload=function(e){try{var t=(new TONG.JSONLoader).parse(JSON.parse(m.result)),o=t.materials,n=t.geometry,r=null;void 0===o||0===o.length?r=Editor.defaultMaterial:1===o.length?r=o[0]:1<o.length&&(r=o);var i=null;i=0<n.bones.length?new SkinnedMesh(n,r):new Mesh(n,r);var a={name:f,size:e.target.result.length||e.target.result.byteLength,type:p,data:i};h&&h(a)}catch(e){LiteGUI.alert("Error loading file: "+e),console.error("Tong Engine: Error loading file",e)}},m.readAsText(t)}else LiteGUI.alert("Error loading file: "+e),console.warn("Tong Engine: Unknown file format")}catch(e){console.error("Tong Engine: Error loading file",e)}},onLoadPastedItem:function(e){var t=e.getAsFile();t&&(t.name?ImporterModule.loadFileToMemory(t,ImporterModule.showImportResourceDialog.bind(ImporterModule)):("image/png"==e.type?t.name="clipboard.png":"image/jpeg"==e.type?t.name="clipboard.jpg":t.name="unknown.bin",LiteGUI.prompt("Enter a filename",function(e){e&&(t.name=e,ImporterModule.loadFileToMemory(t,ImporterModule.showImportResourceDialog.bind(ImporterModule)))},{value:t.name})))},onItemDrop:function(e,t){t=t||{},console.log("processing item drop..."),GL.augmentEvent(e);var o=null;void 0!==e.canvasx&&(o=RenderModule.getNodeAtCanvasPosition(e.canvasx,e.canvasy)),t.node=o,t.event=e;var n=this.getFilesFromEvent(e,t);if(n&&n.length&&this.processFileList(n,t),e.dataTransfer.getData("res-fullpath")){e.dataTransfer.getData("res-filename");var r=e.dataTransfer.getData("res-fullpath"),i=e.dataTransfer.getData("res-type");if(r||(r=e.dataTransfer.getData("text/uri-list")),r&&1<r.split("/").length){var a;LFS.parsePath(r);return console.log(r),t.node&&(a=EditorModule.onDropResourceOnNode(r,t.node,e)),a||DriveModule.onInsertResourceInScene({dataset:{restype:i,fullpath:r}},t),!0}}if(e.dataTransfer.getData("uuid"))return GL.augmentEvent(e),(o=RenderModule.getNodeAtCanvasPosition(e.canvasx,e.canvasy))&&EditorModule.onDropOnNode(o,e),!0;if(e.dataTransfer.getData("text/uri-list")){GL.augmentEvent(e);o=RenderModule.getNodeAtCanvasPosition(e.canvasx,e.canvasy);var s=e.dataTransfer.getData("text/uri-list"),l=DriveModule.getFilename(s);ImporterModule.showImportResourceDialog({name:l,url:s},{node:o})}return!0},getFilesFromEvent:function(e,t){for(var o=[],r=this,n=0;n<e.dataTransfer.files.length;n++){var i=e.dataTransfer.files[n];i.size&&o.push(i)}for(n=0;n<e.dataTransfer.items.length;n++){var a=e.dataTransfer.items[n],s=a.webkitGetAsEntry||a.mozGetAsEntry||a.getAsEntry;if(!s)break;var l=s.call(a);l&&l.isDirectory&&c(l)}function c(o,n){if(n=n||"",o.isFile)o.file(function(e){r.processFileList([e],t,!0)});else if(o.isDirectory){o.createReader().readEntries(function(e){for(var t=0;t<e.length;t++)c(e[t],n+o.name+"/")})}}return o},processFileList:function(e,t,o){t=t||{};var n=this;if(1<e.length){e=ImporterModule.sortFilesByPriority(e);for(var r=0;r<e.length;r++)this.loadFileToMemory(e[r],s,t)}else{var i=e[0],a=o?s:this.showImportResourceDialog.bind(this);this.loadFileToMemory(i,a,t)}function s(e,t){var o=e.name.toLowerCase();NotifyModule.show("FILE: "+o,{id:"res-msg-"+o.hashCode(),closable:!0,time:3e3,left:60,top:30,parent:"#visor"}),CORE.log("File dropped: "+o),ImporterModule.processResource(o,e,n.getImporterOptions(o),function(e,t){t.constructor===GL.Mesh&&ImporterModule.insertMeshInScene(t)})}},loadFileToMemory:function(t,o,n){if(t){var e=new FileReader;e.onload=function(e){if(t.data=e.target.result,""==t.data&&1e5<t.size)LiteGUI.alert("File load error, it seems the file was too big to be loaded in memory by your browser.");else try{o&&o(t,n)}catch(e){console.log("Error processing data: "+e)}},e.onerror=function(e){console.error(e)},e.onprogress=function(e){};var r=TONG.ResourcesManager.getExtension(t.name).toLowerCase(),i=TONG.Formats.supported[r],a="binary";i&&(a=i.dataType||i.format),"string"==a||"text"==a||"json"==a||"xml"==a?e.readAsText(t):e.readAsArrayBuffer(t)}},importFile:function(e,n,t){this.loadFileToMemory(e,function(e,t){var o=ImporterModule.processResource(e.name,e,t,n);o&&n&&n(o)},t)},getImporterOptions:function(){var e={};for(var t in this.preferences)e[t]=this.preferences[t];return e},sortFilesByPriority:function(e){var t=[];function o(e){var t=LS.RM.getExtension(e.name),o=LS.Formats.supported[t];return!(!o||"image"!=o.type)}return Array.prototype.push.apply(t,e),t=t.sort(function(e,t){return o(e)?e:o(t)?t:e})},showImportResourceDialog:function(i,n,a){n=n||{};var s=this,l=new LiteGUI.Dialog({id:"dialog_import_resource",title:GetLanguage("Import File"),close:!0,minimize:!1,width:480,height:400,scroll:!1,draggable:!0});document.body.appendChild(l.root),l.show(),l.center();var r=n.channel,c=!1,d="",u=n.folder,h=this.getImporterOptions(),f=i?i.data:null,p="",m=n.node,g=m?m.getMaterial():null,v=new LiteGUI.Inspector({name_width:"50%"});v.on_refresh=function(){if(v.clear(),v.addTitle(GetLanguage("Select a file")),v.addFile(GetLanguage("Import from Harddrive"),i?i.name:"",function(e){b(i=e?e.file:null),v.refresh()}),v.addString(GetLanguage("Import from URL"),p,{callback:function(e){b(p=e),v.refresh()}}),v.addTitle(GetLanguage("Destination")),v.addFolder(GetLanguage("Save to folder"),u||"",{callback:function(e){u=e}}),v.addInfo(GetLanguage("You can also drag files here directly")),i){v.addTitle(GetLanguage("File Information")),v.addString(GetLanguage("Filename"),i.name),v.addInfo(GetLanguage("Bytes"),DriveModule.beautifySize(i.size)),v.addInfo(GetLanguage("Type"),i.type?i.type:TONG.RM.getExtension(i.name));var e=TONG.RM.getExtension(i.name);"zip"===e&&v.addInfo(GetLanguage("ZIP FILE")),v.addCheckbox(GetLanguage("Optimize data"),h.optimize_data,{callback:function(e){h.optimize_data=e}});var t=TONG.Formats.getFileFormatInfo(i.name);if(t)if("MeshAsset"==t.resource)v.addTitle(GetLanguage("Mesh")),v.addCombo(GetLanguage("Action"),ImporterModule.preferences.mesh_action,{values:{"Load in memory":"load","Insert in Scene":"scene","Replace Mesh":"replace"},callback:function(e){ImporterModule.preferences.mesh_action=e}});else if("Texture"==t.resource){if(v.addTitle(GetLanguage("Texture")),v.addCombo(GetLanguage("Action"),ImporterModule.preferences.texture_action,{values:{"Load in memory":"load","Replace in material":"replace","Insert as Plane":"plane","Insert as Sprite":"sprite"},callback:function(e){ImporterModule.preferences.texture_action=e}}),m&&g){var o=g.getTextureChannels();r=o[0],v.addCombo(GetLanguage("Channel"),r,{values:o,callback:function(e){r=e}})}v.addCheckbox(GetLanguage("Optimize data"),h.optimize_data,{callback:function(e){h.optimize_data=e}})}else"SceneTree"!=t.resource&&"SceneNode"!=t.resource||(v.addTitle(GetLanguage("Scene")),v.addCheckbox(GetLanguage("Optimize data"),h.optimize_data,{callback:function(e){h.optimize_data=e}}),v.addCheckbox(GetLanguage("Use node names to reference nodes"),h.use_names_to_reference,{callback:function(e){h.use_names_to_reference=e}}));else v.addTitle(GetLanguage("Unknown resource"))}},v.refresh(),l.add(v);l.root;function b(e){if(f=null,(i=e)&&!i.data)if(e.constructor!=String){var t=new FileReader;if(t.onload=function(e){y(e.target.result),v.refresh()},(n=TONG.Formats.getFileFormatInfo(i.name))&&"text"==n.format)t.readAsText(i);else if(n&&"Texture"==n.resource)t.readAsDataURL(i);else{if(100<i.size/1024/1024)return void document.body.appendChild(LiteGUI.alert(GetLanguage("The file is greater than 100M,Upload to server is recommended"),{noclose:!0,title:GetLanguage("alert"),draggable:!0,buttons:[{name:GetLanguage("Close"),close:!0}]}).root);s.loadFile(i,y)}t.onerror=function(e){console.error(e)}}else{var o=DriveModule.getFilename(e);i={name:o,size:0,type:"?",data:null};var n=TONG.Formats.getFileFormatInfo(i.name),r=TONG.RM.getFullURL(e);n&&"text"==n.format?LiteGUI.requestText(r,function(e,t){y(e,t.getResponseHeader("Content-Type"))}):LiteGUI.requestBinary(r,function(e,t){y(e,t.getResponseHeader("Content-Type"))})}}function y(e,t){f=e,i&&(i.data=f,i.size=f.length||f.byteLength,(t||f.type)&&(i.type=t||f.type)),v.refresh()}LiteGUI.createDropArea(l.root,function(e){var t=e.dataTransfer.files;return t&&t.length&&(b(t[0]),v.refresh()),!0},function(e){}),i&&i.url&&b(i.url),l.addButton(GetLanguage("Import to Memory"),{className:"big",callback:function(e,t){e==w&&(c=!0);if(!i)return LiteGUI.alert("No file imported");for(var o in d=(d=v.getValue(GetLanguage("Filename"))).replace(/ /g,"_"),d=FileNameHelper.GetNextFileName(d),n)h[o]=n[o];h.filename=d,h.target=r,h.to_memory=!c,h.size=(i.size/1024).toFixed()+"KBs",i.filename=d,ImporterModule.processResource(d,i,h,S),l.close()}});var w=null;function S(e,t,o){o=o||{};var n={};for(var r in o)n[r]=o[r];t.filename&&t.filename,u&&function(e,t){if(!t)return;if(!e.filename)return;var o=t+"/"+e.filename;TONG.ResourcesManager.renameResource(e.filename,o),e.fullpath=o,DriveModule.saveResource(e,a,{skip_alerts:!0})}(t,u),a&&a(t),c&&(n.mesh_action=ImporterModule.preferences.mesh_action,n.texture_action=ImporterModule.preferences.texture_action,DriveModule.onInsertResourceInScene(t,n)),l.close()}l.addButton(GetLanguage("Cancel"),{className:"big",callback:function(){l.close()}})},processResource:function(e,d,u,h){if(u=u||{},!d.data)return console.error("File data missing, use FileReader");var t=u.filename||e||d.name;return this.preferences.force_lowercase&&(t=t.toLowerCase()),"zip"==TONG.RM.getExtension(t)?LiteGUI.choice("This is a ZIP file, do you want to unzip the content? (If the zip contains an scene, select no)",["yes, unzip","no, leave as zip"],function(e){"yes, unzip"==e?ImporterModule.importZIP(d,o):TONG.ResourcesManager.processResource(t,d.data,u,o)},{width:400}):TONG.ResourcesManager.processResource(t,d.data,u,o),null;function o(e,t){var o=TONG.RM.getExtension(e),n=TONG.Formats.supported[o];if(t){if(console.log("Imported resource: "+t),u.optimize_data&&(t.constructor==TONG.Mesh&&"wbin"!=o&&(t._original_data=t.toBinary().buffer,e+=".wbin",TONG.ResourcesManager.renameResource(t.filename,e)),!(t.constructor!=TONG.Texture||n&&n.native))){t._original_data=null;var r=t.toBlob(!0),i=new FileReader;i.onload=function(){t._original_data=this.result},i.readAsArrayBuffer(r),e+=".png",TONG.ResourcesManager.renameResource(t.filename,e)}if(t._original_file||t._original_data||(t._original_file=d),t.constructor===TONG.Texture&&(t._preview_url=DriveModule.generatePreview(t.fullpath||t.filename)),t.constructor===TONG.Object3D){u.node=null;var a=t.getResources({},!0);if(u.optimize_data)for(var s in a){if((l=TONG.ResourcesManager.getResource(s))&&l.constructor===TONG.Animation)l.optimizeTracks()}if(u.use_names_to_reference){for(var s in console.log("Converting uids to names in animations and bones"),a){var l;if((l=TONG.ResourcesManager.getResource(s))&&l.constructor===TONG.Mesh&&l.bones)l.convertBoneNames(t,!1)}if(t.animations){var c=TONG.RM.getResource(t.animations);c&&c.convertIDsToNames(!0,t)}}}h&&h(e,t,u)}else h&&h(e,t,u)}},importZIP:function(e,i){if(window.JSZip){var t=new FileReader;t.onload=function(e){var t=new JSZip;console.log("unziping data..."),t.loadAsync(e.target.result).then(function(e){e.forEach(function(e,t){if(console.log("file in ZIP",e),t.dir);else{var o="arraybuffer",n=TONG.RM.getExtension(t.name),r=TONG.Formats.supported[n];r&&"text"==r.dataType&&(o="string"),t.async(o).then(function(e){var t=new Blob([e],{name:"foo",type:"application/octet-stream"});t.name=this.name,console.log(t),TONG.ResourcesManager.processResource(t.name,e,null,i)}.bind(t))}})})},console.log("reading zip data..."),t.readAsArrayBuffer(e)}else LiteGUI.alert("JSZIP.js not found.")},insertMeshInScene:function(e){var t=new TONG.SceneNode;if(t.name=e.filename||"Mesh",e.info&&e.info.groups&&e.info.groups.length)for(var o in e.info.groups){var n,r=e.info.groups[o];if(r.material)(n=new TONG.Components.MeshRenderer).mesh=e.fullpath||e.filename,n.submesh_id=o,n.material=r.material,t.addComponent(n)}else(n=new TONG.Components.MeshRenderer).mesh=e.fullpath||e.filename,t.addComponent(n);TONG.GlobalScene.root.addChild(t)}};CORE.registerModule(ImporterModule);