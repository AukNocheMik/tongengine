var Storage=function(n){var i=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;if(void 0===i)return console.warn("Storage:TongEngine IndexedDB not available."),{init:function(){},get:function(){},set:function(){},clear:function(){}};var r;return{init:function(t){var e=i.open("TongEngine-Editor",1);e.onupgradeneeded=function(e){var t=e.target.result;!1===t.objectStoreNames.contains("states")&&t.createObjectStore("states")},e.onsuccess=function(e){r=e.target.result,t()},e.onerror=function(e){console.error("TongEngine IndexedDB",e)}},get:function(t){r.transaction(["states"],"readwrite").objectStore("states").get(0).onsuccess=function(e){t(e.target.result)}},set:function(e,t){var i=performance.now();r.transaction(["states"],"readwrite").objectStore("states").put(e,0).onsuccess=function(e){console.log("["+/\d\d\:\d\d\:\d\d/.exec(new Date)[0]+"]","Saved state to TongEngine IndexedDB. "+(performance.now()-i).toFixed(2)+"ms"),n.signals.storageSaveFinish.dispatch()}},clear:function(){void 0!==r&&(r.transaction(["states"],"readwrite").objectStore("states").clear().onsuccess=function(e){console.log("["+/\d\d\:\d\d\:\d\d/.exec(new Date)[0]+"]","Cleared TongEngine IndexedDB.")})}}},Settings={FIRST_PERSON:10,ORBIT:11,PLANAR_LEFT:12,PLANAR_RIGHT:13,PLANAR_FRONT:14,PLANAR_BACK:15,PLANAR_TOP:16,PLANAR_BOTTOM:17,TOP_LEFT:20,TOP_RIGHT:21,BOTTOM_LEFT:22,BOTTOM_RIGHT:23,ORTHOGRAPHIC:20,PERSPECTIVE:21,mouseLookSensitivity:.002,mouseWheelSensitivity:5e-4,mouseMoveSpeed:.001,invertNavigation:!1,keyboardNavigation:!0,keyboardNavigationSpeed:.25,defaultTextureLensFlare:[],defaultTextureParticle:(new TONG.TextureLoader).load("./imgs/particle/particle.png"),defaultMaterial:new TONG.MeshStandardMaterial({roughness:.6,metalness:.2})};Settings.render={followProject:!0,toneMapping:TONG.LinearToneMapping,toneMappingExposure:1,toneMappingWhitePoint:1,antialiasing:!0,shadows:!0,gammaInput:!1,gammaOutput:!1,shadowsType:TONG.PCFSoftShadowMap,cameraPreviewEnabled:!0,cameraPreviewPercentage:.25,cameraPreviewPosition:Settings.BOTTOM_RIGHT};var Editor=function(){this.DEFAULT_CAMERA=new PerspectiveCamera(50,1,.1,1e3),this.DEFAULT_CAMERA.name="Camera",this.DEFAULT_CAMERA.position.set(20,10,20),this.DEFAULT_CAMERA.lookAt(new TONG.Vector3),Settings.defaultFont=window.DefaultFont=new Font("default.json"),window.DefaultFont.uuid=!1;for(var e=0;e<4;e++){var t=(new TONG.TextureLoader).load("./imgs/lensflare/lensflare"+e+".png");t.name="lensflare"+e,Settings.defaultTextureLensFlare.push(t)}var i=signals.Signal;this.signals={editScript:new i,editFile:new i,saveScript:new i,locateFile:new i,startPlayer:new i,stopPlayer:new i,enterVR:new i,enteredVR:new i,exitedVR:new i,showModal:new i,editorCleared:new i,savingStarted:new i,savingFinished:new i,themeChanged:new i,transformModeChanged:new i,snapChanged:new i,spaceChanged:new i,rendererChanged:new i,sceneBackgroundChanged:new i,sceneFogChanged:new i,sceneGraphChanged:new i,cameraChanged:new i,geometryChanged:new i,objectSelected:new i,objectFocused:new i,objectAdded:new i,objectChanged:new i,objectRemoved:new i,helperAdded:new i,helperRemoved:new i,materialChanged:new i,scriptAdded:new i,componentAdded:new i,componentRemoved:new i,componentChanged:new i,resourceAdded:new i,resourceRemoved:new i,resourceChange:new i,scriptChanged:new i,scriptRemoved:new i,windowResize:new i,showGridChanged:new i,refreshSidebarObject3D:new i,historyChanged:new i,assetsChange:new i,assetsSave:new i,storageGetFinish:new i,storageSaveFinish:new i,projectInfoChange:new i,colliderComponentChange:new i,constraintComponentChange:new i,currentObjectMeshChange:new i,sceneInitFinish:new i,uiAdded:new i,uiChanged:new i,uiRemoved:new i},this.config=new Config("TONG3D"),this.history=new History(this),this.storage=new Storage(this),this.loader=new Loader(this),this.camera=this.DEFAULT_CAMERA.clone(),this.scene=new Scene,this.scene.name="Scene",this.scene.background=new TONG.Color(1118481),this.sceneHelpers=new TONG.Scene,this.sceneHelpers.name="sceneHelp",this.objectIconHelper=new TONG.Object3D,this.sceneHelpers.add(this.objectIconHelper),this.objectHelper=new TONG.Object3D,this.sceneHelpers.add(this.objectHelper),this.outlineScene=new TONG.Scene,this.outlineScene.name="outlineScene",this.object={},this.geometries={},this.materials={},this.images={},this.textures={},this.resources={},this.components={},this.scripts={},this.selected=null,this.helpers={},this.iconHelpers={},this.ui={},this.projectsJsonData=new Utils.Dictionary,this.currentSceneName="",this.currentSceneTime="",this.currentProjectName="",this.isChinese=!0,this.orientation=new OrientationCube,this.Sky=null,this.currentPhysicsHelp=null};function parallelTraverse(e,t,i){i(e,t);for(var n=0;n<e.children.length;n++)parallelTraverse(e.children[n],t.children[n],i)}Editor.prototype={setTheme:function(e){document.getElementById("theme").href=e,this.signals.themeChanged.dispatch(e)},stopAutoSave:function(){this.config.setKey("autosave",!1)},startAutoSave:function(){this.config.setKey("autosave",!0)},setScene:function(e,t){this.signals.sceneInitFinish.dispatch(e),this.scene.uuid=e.uuid,this.scene.name=e.name,null!==e.background&&(this.scene.background=e.background.clone()),null!==e.fog&&(this.scene.fog=e.fog.clone()),this.scene.userData=JSON.parse(JSON.stringify(e.userData)),this.signals.sceneGraphChanged.active=!1;for(var i=0;i<this.scene.registerComponents.length;i++)this.scene.addComponent(this.scene.registerComponents[i]);for(var n=!1;0<e.children.length;)"Sky"==e.children[0].type?(n=!0,this.Sky=e.children[0],this.addGeometry(this.Sky.geometry),this.addMaterial(this.Sky.material),this.scene.Sky=this.Sky,this.scene.add(this.Sky)):this.addObject(e.children[0]);if(n||(this.Sky=new TONG.Sky,this.addGeometry(this.Sky.geometry),this.addMaterial(this.Sky.material),this.scene.Sky=this.Sky,this.scene.add(this.Sky)),0==e.cameras.length){var r=new PerspectiveCamera(50,1,1,1e4);r.position.set(0,0,-5),r.lookAt(0,0,0),r.name=GetLanguage("PerspectiveCamera")+" 1",this.addObject(r)}TONG.Components.configureComponents(t.scene,this.scene,this.materials),this.signals.sceneGraphChanged.active=!0,this.signals.sceneGraphChanged.dispatch()},addObject:function(e,t){var i=this;e.traverse(function(e){void 0!==e.geometry&&i.addGeometry(e.geometry),void 0!==e.material&&i.addMaterial(e.material),e instanceof TONG.Mesh&&i.addMesh(e),i.addHelper(e,!1)}),(t=t||this.scene).add(e),TONG.Event.trigger(this.scene,"nodeAdded",e),this.signals.objectAdded.dispatch(e),this.signals.sceneGraphChanged.dispatch()},moveObject:function(e,t,i){if(void 0===t&&(t=this.scene),t.add(e),void 0!==i){var n=t.children.indexOf(i);t.children.splice(n,0,e),t.children.pop()}this.signals.sceneGraphChanged.dispatch()},nameObject:function(e,t){e.name=t,this.signals.sceneGraphChanged.dispatch()},removeObject:function(e){if(null!==e.parent){var t=this;e.traverse(function(e){t.removeHelper(e,!0)}),e.parent.remove(e),TONG.Event.trigger(this.scene,"nodeRemoved",e),this.signals.objectRemoved.dispatch(e),this.signals.sceneGraphChanged.dispatch()}},addGeometry:function(e){TONG.RM.addGeometry(e),this.geometries[e.uuid]=e},setGeometryName:function(e,t){e.name=t,this.signals.sceneGraphChanged.dispatch()},addMaterial:function(e){TONG.RM.addMaterial(e),this.materials[e.uuid]=e},setMaterialName:function(e,t){e.name=t,this.signals.sceneGraphChanged.dispatch()},addTexture:function(e){TONG.RM.addTexture(e),this.textures[e.uuid]=e},addMesh:function(e){e.skeleton&&TONG.RM.addSkeleton(e.skeleton),TONG.RM.addMesh(e)},addImage:function(e){TONG.RM.addImage(e),this.images[e.uuid]=e},setProjectInfo:function(e,t,i,n){""!=e&&(this.currentProjectName=e),""!=t&&(this.currentSceneName=t),""!=i&&(this.currentSceneTime=i),n||this.signals.projectInfoChange.dispatch(e,t,i)},saveProjectInfoToStorage:function(e){this.projectsJsonData=e,this.storage.set(this.projectsJsonData.toJson())},saveAll:function(){var e=this.projectsJsonData.data;this.storage.set(e)},getCurrentProject:function(){return this.projectsJsonData.get(this.currentProjectName)},getCurrentScene:function(){return this.projectsJsonData.get(this.currentProjectName)[this.currentSceneName].data},addHelper:function(){var o=new TONG.SphereBufferGeometry(2,4,2),s=new TONG.MeshBasicMaterial({color:16711680,visible:!1});return function(e,t){var i,n;t=void 0===t||t;if(e instanceof PerspectiveCamera)i=new CameraHelper(e,1),n=new ObjectIconHelper(e,"./imgs/camera/camera_.png");else if(e instanceof OrthographicCamera)i=new CameraHelper(e,1),n=new ObjectIconHelper(e,"./imgs/camera/照相机.png");else if(e instanceof TONG.PointLight)i=new TONG.PointLightHelper(e,1),n=new ObjectIconHelper(e,"./imgs/lights/pointLight.png");else if(e instanceof TONG.DirectionalLight)i=new TONG.DirectionalLightHelper(e,1),n=new ObjectIconHelper(e,"./imgs/lights/sun.png");else if(e instanceof TONG.SpotLight)i=new TONG.SpotLightHelper(e),n=new ObjectIconHelper(e,"./imgs/lights/spotlight.png");else if(e instanceof TONG.HemisphereLight)i=new TONG.HemisphereLightHelper(e),n=new ObjectIconHelper(e,"./imgs/lights/sunHemis.png");else if(e instanceof TONG.RectAreaLight)i=new TONG.RectAreaLightHelper(e),n=new ObjectIconHelper(e,"./imgs/lights/rectLight.png");else{if(!(e instanceof TONG.SkinnedMesh))return;i=new SkeletonHelper(e.parent)}var r=new TONG.Mesh(o,s);r.name="picker",r.userData.object=e,null==this.iconHelpers[e.id]&&n&&(n.add(r),this.iconHelpers[e.id]=n,this.objectIconHelper.add(n),this.signals.helperAdded.dispatch(n)),t&&(i.add(r),this.objectHelper.add(i),this.helpers[e.id]=i)}}(),removeHelper:function(e,t){if(e&&void 0!==this.helpers[e.id]){var i=this.helpers[e.id];if(i.parent.remove(i),void 0!==this.iconHelpers[e.id]&&t){var n=this.iconHelpers[e.id];this.objectIconHelper.remove(n),delete this.iconHelpers[e.id],this.signals.helperRemoved.dispatch(n)}delete this.helpers[e.id]}},getAllResourceByUUID:function(i){for(var e in this.scene.traverse(function(e){if(e.uuid==i)return e;for(var t=0;t<e.getComponents().length;t++)if(e.getComponents()[t].uuid==i)return e.getComponents()[t]}),TONG.RM.resources)if(TONG.RM.resources[e].uuid==i)return TONG.RM.resources[e];return null},isResourceContainsUUID:function(e){for(var t in this.resources)if(this.resources[t]instanceof Array){for(var i=0;i<this.resources[t].length;i++)if(this.resources[t][i].uuid==e)return this.resources[t][i]}else if(this.resources[t]instanceof Object)for(var n in this.resources[t])if(this.resources[t][n].uuid==e)return this.resources[t][n];return!1},addScript:function(e,t){void 0===this.scripts[e.uuid]&&(this.scripts[e.uuid]=[]),this.scripts[e.uuid].push(t),this.signals.scriptAdded.dispatch(t)},removeScript:function(e,t){if(void 0!==this.scripts[e.uuid]){var i=this.scripts[e.uuid].indexOf(t);-1!==i&&this.scripts[e.uuid].splice(i,1),this.signals.scriptRemoved.dispatch(t)}},select:function(e){if(this.selected!==e){if(this.selected)for(var t=0;t<this.selected.components.length;t++)this.selected.components[t].OnInspectorChange&&this.selected.components[t].OnInspectorChange(e);if(e){for(t=0;t<e.registerComponents.length;t++)e.addComponent(e.registerComponents[t],t);for(var i=0;i<e.components.length;i++)e.components[i].OnInspectorSelect&&e.components[i].OnInspectorSelect(e)}var n=null;null!==e&&(n=e.uuid),this.removeHelper(this.selected),(this.selected=e)&&!this.helpers[e.id]&&this.addHelper(this.selected),this.config.setKey("selected",n),this.signals.objectSelected.dispatch(e)}},selectById:function(e){e!==this.camera.id?this.select(this.scene.getObjectById(e,!0)):this.select(this.camera)},selectByUuid:function(t){var i=this;this.scene.traverse(function(e){e.uuid===t&&i.select(e)})},deselect:function(){this.select(null)},focus:function(e){this.signals.objectFocused.dispatch(e)},focusById:function(e){this.focus(this.scene.getObjectById(e,!0))},reduction:function(e){console.log("scene data"),console.log(e);e.scene},clearData:function(){this.history.clear();for(var e=this.scene.children;0<e.length;)this.removeObject(e[0]);this.geometries={},this.materials={},this.textures={},this.images={},this.scripts={},this.resources={},TONG.RM.reset(),this.deselect()},clear:function(){this.history.clear(),this.storage.clear(),this.camera.copy(this.DEFAULT_CAMERA),this.scene.background.setHex(1118481),this.scene.fog=null;for(var e=this.scene.children;0<e.length;)this.removeObject(e[0]);this.geometries={},this.materials={},this.textures={},this.images={},this.scripts={},this.resources={},TONG.RM.reset(),this.deselect(),this.signals.editorCleared.dispatch(),this.signals.storageGetFinish.dispatch()},getDefaultJson:function(e){this.history.clear(),this.sceneHelpers.name="sceneHelp",this.scene.name=e+"",this.scene.background=new TONG.Color(1118481),this.scene.fog=null,this.scene.uuid=TONG.Math.generateUUID();for(var t=this.scene.children;0<t.length;)this.removeObject(t[0]);return this.geometries={},this.materials={},this.textures={},this.images={},this.scripts={},this.resources={},this.renderer=null,this.deselect(),{metadata:{},project:{gammaInput:this.config.getKey("project/renderer/gammaInput"),gammaOutput:this.config.getKey("project/renderer/gammaOutput"),shadows:this.config.getKey("project/renderer/shadows"),vr:this.config.getKey("project/vr"),gravity:this.config.getKey("gravity")},scene:this.scene.toJSON(),scripts:{},history:this.history.toJSON()}},fromJSON:function(e){var t=new ObjectLoader;if(this.deselect(),void 0!==e.scene){for(this.history.fromJSON(e.history),this.scripts=e.scripts;0<this.scene.children.length;)this.removeObject(this.scene.children[0]);for(var i in this.components=e.scene.components?e.scene.components:{},this.resources.images=e.scene.images,e.scene)if("materials"!=i&&"images"!=i&&"meshes"!=i&&e.scene[i]instanceof Array)for(var n=0;n<e.scene[i].length;n++)TONG.RM.configureResource(i,e.scene[i][n],e.scene);if(e.scene.materials instanceof Array)for(n=0;n<e.scene.materials.length;n++)TONG.RM.configureResource("materials",e.scene.materials[n],e.scene);if(e.scene.meshes instanceof Array)for(n=0;n<e.scene.meshes.length;n++)TONG.RM.configureResource("meshes",e.scene.meshes[n],e.scene);var r=this.config.getKey("project/renderer/antialias");Settings.render.antialiasing=r;var o=this.config.getKey("project/renderer/shadows");Settings.render.shadows=o;var s=this.config.getKey("project/renderer/gammaInput");Settings.render.gammaInput=s;var a=this.config.getKey("project/renderer/gammaOutput");Settings.render.gammaOutput=a,EditorModule.viewport.resetRenderer();var l=t.parseObject(e.scene.object,TONG.RM.geometries,TONG.RM.materials,TONG.RM.textures,TONG.RM.fontAssets,TONG.RM.animationClips);isEmptyObject(TONG.RM.skeletons)||t.bindSkeletons(l,TONG.RM.skeletons),this.setScene(l,e)}else this.setScene(t.parse(e),e)},toJSON:function(){var e=this.scene,t=this.scripts;for(var i in t){0!==t[i].length&&void 0!==e.getObjectByProperty("uuid",i)||delete t[i]}var n=this.scene.toJSON();console.log(n);var r={metadata:{},project:{gammaInput:this.config.getKey("project/renderer/gammaInput"),gammaOutput:this.config.getKey("project/renderer/gammaOutput"),shadows:this.config.getKey("project/renderer/shadows"),vr:this.config.getKey("project/vr"),gravity:this.config.getKey("gravity")},scene:n,scripts:this.scripts,history:this.history.toJSON()};return this.projectsJsonData.get(this.currentProjectName+"")[this.currentSceneName+""].data=r,this.projectsJsonData.data},getObjectMaterial:function(e,t){var i=e.material;return Array.isArray(i)&&(i=i[t]),i},setObjectMaterial:function(e,t,i,n,r){if(Array.isArray(e.material)){if(0==n){r=r||1;e.material.splice(t,r)}else e.material[t]=i;1==e.material.length&&(e.material=e.material[0])}else e.material=null==n?i:1==n?[e.material,i]:[]},objectByUuid:function(e){return this.scene.uuid==e?this.scene:this.scene.getObjectByProperty("uuid",e,!0)},objectMaterialByUUID:function(e){for(var t in this.materials)if(t==e)return this.materials[t];return null},execute:function(e,t){this.history.execute(e,t)},undo:function(){this.history.undo()},redo:function(){this.history.redo()}},TONG.AnimationUtils.clone=function(e){var r=new Map,o=new Map,t=e.clone();return parallelTraverse(e,t,function(e,t){r.set(t,e),o.set(e,t)}),t.traverse(function(e){if(e.isSkinnedMesh){var t=e,i=r.get(e),n=i.skeleton.bones;t.skeleton=i.skeleton.clone(),t.skeleton.bones=n.map(function(e){return o.get(e)}),t.bind(t.skeleton,t.bindMatrix),t.addComponent(Animation)}}),t};"use strict";function Element(e,t){this.parent=void 0!==e?e:document.body,this.element=document.createElement(void 0!==t?t:"div"),this.element.style.position="absolute",this.parent.appendChild(this.element),this.visible=!0,this.size=new TONG.Vector2(0,0),this.position=new TONG.Vector2(0,0),this._mode=Element.TOP_LEFT}function RendererCanvas(e,t){Element.call(this,e,"div"),t=void 0===t?new TONG.Vector2(100,100):t,this.onResize=null,this.size=t,this.resetCanvas(),this.createRenderer()}function EditorControls(){TONG.Group.call(this)}function EditorFreeControls(){EditorControls.call(this),this.orientation=new TONG.Vector2,this.camera=null,this.temp=new TONG.Vector3,this.changeEvent={type:"change"},this.reset(),this.updateControls()}function EditorOrbitControls(){EditorControls.call(this),this.distance=10,this.center=new TONG.Vector3,this.orientation=new TONG.Vector2,this.camera=null,this.maxDistance=Number.MAX_SAFE_INTEGER,this.minDistance=1e-10,this.limitUp=1.57,this.limitDown=-1.57,this.tempVector=new TONG.Vector3(0,0,0),this.tempMatrix=new TONG.Matrix4,this.changeEvent={type:"change"},this.reset(),this.updateControls()}function EditorPlanarControls(e){EditorOrbitControls.call(this),this.setMode(void 0!==e?e:Settings.PLANAR_LEFT)}(Element.prototype.constructor=Element).TOP_LEFT=0,Element.TOP_RIGHT=1,Element.BOTTOM_LEFT=2,Element.BOTTOM_RIGHT=3,Element.preventDefault=function(e){e.preventDefault()},Element.prototype.addClass=function(e){this.element.classList.add(e)},Element.prototype.removeClass=function(e){this.element.classList.contains(e)&&this.element.classList.remove(e)},Element.prototype.preventDragEvents=function(){this.element.ondrop=Element.preventDefault,this.element.ondragover=Element.preventDefault},Element.prototype.setAltText=function(e){var t=document.createElement("div");t.style.position="absolute",t.style.display="none",t.style.alignItems="center",t.style.zIndex="10000",t.style.border="3px solid",t.style.borderRadius="5px",t.style.color=Editor.theme.textColor,t.style.backgroundColor=Editor.theme.barColor,t.style.borderColor=Editor.theme.barColor,t.style.width="fit-content",t.style.height="fit-content",document.body.appendChild(t);var i=document.createTextNode(e);t.appendChild(i);var n=this.destroy;return this.destroy=function(){n.call(this),document.body.contains(t)&&document.body.removeChild(t)},this.element.style.pointerEvents="auto",this.element.onmousemove=function(e){t.style.display="flex",t.style.left=e.clientX+"px",t.style.top=e.clientY-30+"px"},this.element.onmouseout=function(){t.style.display="none"},t},Element.prototype.attachTo=function(e){this.parent.contains(this.element)&&this.parent.removeChild(this.element),this.parent=e,this.parent.appendChild(this.element),this.updateInterface()},Element.prototype.destroy=function(){this.parent.contains(this.element)&&this.parent.removeChild(this.element)},Element.prototype.setMode=function(e){this._mode=e,this.element.style.bottom=null,this.element.style.top=null,this.element.style.right=null,this.element.style.left=null},Element.prototype.setVisibility=function(e){this.visible=e,this.updateVisibility()},Element.prototype.updateVisibility=function(){this.element.style.display=this.visible?"block":"none"},Element.prototype.updatePosition=function(e){void 0!==e&&(this._mode=e),this._mode===Element.TOP_LEFT||this._mode===Element.TOP_RIGHT?this.element.style.top=this.position.y+"px":this.element.style.bottom=this.position.y+"px",this._mode===Element.TOP_LEFT||this._mode===Element.BOTTOM_LEFT?this.element.style.left=this.position.x+"px":this.element.style.right=this.position.x+"px"},Element.prototype.updateSize=function(){this.element.style.width=this.size.x+"px",this.element.style.height=this.size.y+"px"},Element.prototype.updateInterface=function(){this.updateVisibility(),this.visible&&(this.updateSize(),this.updatePosition())},RendererCanvas.prototype=Object.create(Element.prototype),RendererCanvas.prototype.setOnResize=function(e){this.onResize=e},RendererCanvas.prototype.resizeCanvas=function(){var e=this.size.x*window.devicePixelRatio,t=this.size.y*window.devicePixelRatio;this.canvas.width=e,this.canvas.height=t,this.canvas.style.width=this.size.x+"px",this.canvas.style.height=this.size.y+"px",null!==this.onResize&&this.onResize(e,t)},RendererCanvas.prototype.resetCanvas=function(){this.element.contains(this.canvas)&&this.element.removeChild(this.canvas),this.canvas=document.createElement("canvas"),this.canvas.style.position="absolute",this.canvas.style.display="block",this.canvas.style.top="0px",this.canvas.style.left="0px",this.element.appendChild(this.canvas),this.resizeCanvas()},RendererCanvas.prototype.createRenderer=function(){var e=Settings.render;this.renderer=new TONG.WebGLRenderer({canvas:this.canvas,context:null,precision:"highp",alpha:!0,premultipliedAlpha:!0,antialias:e.antialiasing,preserveDrawingBuffer:!1,powerPreference:"high-performance",logarithmicDepthBuffer:!1}),this.renderer.shadowMap.enabled=e.shadows,this.renderer.shadowMap.type=e.shadowsType,this.renderer.shadowMap.autoUpdate=!0,this.renderer.shadowMap.needsUpdate=!1,this.renderer.toneMapping=e.toneMapping,this.renderer.toneMappingExposure=e.toneMappingExposure,this.renderer.toneMappingWhitePoint=e.toneMappingWhitePoint,this.renderer.autoClear=!1,this.renderer.autoClearColor=!1,this.renderer.autoClearDepth=!1,this.renderer.autoClearStencil=!1,this.renderer.sortObjects=!0,this.renderer.gammaFactor=2,this.renderer.gammaInput=e.gammaInput,this.renderer.gammaOutput=e.gammaOutput,this.renderer.setSize(this.element.width,this.element.height)},RendererCanvas.prototype.reloadContext=function(){this.forceContextLoss(),this.resetCanvas(),this.createRenderer()},RendererCanvas.prototype.forceContextLoss=function(){try{null!==this.renderer&&(this.renderer.dispose(),this.renderer.forceContextLoss(),this.renderer=null)}catch(e){this.renderer=null,console.log("nunuStudio: Failed to destroy WebGL context.")}},RendererCanvas.prototype.destroy=function(){Element.prototype.destroy.call(this),this.forceContextLoss()},RendererCanvas.prototype.updateSize=function(){Element.prototype.updateSize.call(this),this.resizeCanvas(),this.renderer.setSize(this.size.x,this.size.y,!1)},TONG.TimelinerController=function(e,t,i,n){this._scene=e,this._trackInfo=t,this._trackInfo||(this._trackInfo=[]),this._onUpdate=i,this._mixer=new TONG.AnimationMixer(e),this._clip=n,this._action=null,this.timeliner=null,this._tracks={},this._propRefs={},this._channelNames=[],this.delKeyFunc=null,this.addKeyFunc=null,this.moveKeyFunc=null,this.clickKeyFunc=null,this.durationFunc=null,this.insertChannelFunc=null},TONG.TimelinerController.prototype={constructor:TONG.TimelinerController,init:function(e){for(var t=[],i=this._trackInfo,n=0,r=i.length;n!==r;++n){var o=i[n];t.push(this._addTrack(o.type,o.propertyPath,o.initialValue,o.interpolation))}this.timeliner=e,this._clip||(this._clip=new TONG.AnimationClip("editclip",0,t)),this._action=this._mixer.clipAction(this._clip).play()},setCallback:function(e,t,i,n,r){this.addKeyFunc=e,this.delKeyFunc=t,this.moveKeyFunc=i,this.durationFunc=n,this.insertChannelFunc=r},insertChannel:function(e){if(null==this._tracks[e.propertyPath]){this._trackInfo.push(e);var t=this._addTrack(e.type,e.propertyPath,e.initialValue,e.interpolation);this._clip.tracks||(this._clip.tracks=[]),this._clip.tracks.push(t),this._mixer._initMemoryManager(),this._action=this._mixer.clipAction(this._clip).play(),this.timeliner.updateState()}},getChannelTrackInfo:function(e){for(var t=0;t<this._trackInfo.length;t++)if(this._trackInfo[t].propertyPath==e)return this._trackInfo[t];return null},getTracks:function(e){return this._tracks[e]},onClickTrack:function(e,t,i){this.clickKeyFunc&&this.clickKeyFunc(e,t,i)},setKeyFrame:function(e,t,i){var n=this.getTracks(e),r=n.times,o=Timeliner.binarySearch(r,t),s=n.values,a=n.getValueSize(),l=o*a;if(o<0)this.addKeyframe(e,t),this.setKeyFrame(e,t,i);else for(var d=l;d<l+a;d++)s[d]=i[d-l];r[o]=t,this._propRefs[e].setValue(s,l)},getKeyValue:function(e,t){var i=this.getTracks(e),n=i.ValueTypeName,r=i.times,o=Timeliner.binarySearch(r,t),s=i.values,a=i.getValueSize(),l=o*a,d=s.slice(l,l+a);return this.reductionValueType(n,d)},reductionValueType:function(e,t){var i=null;switch(e){case"vector":2==t.length?(i=new TONG.Vector2).fromArray(t):3==t.length?(i=new TONG.Vector3).fromArray(t):4==t.length&&(i=new TONG.Vector4).fromArray(t);break;case"number":i=t[0];break;case"color":(i=new TONG.Color).fromArray(t);break;case"quaternion":(i=new TONG.Quaternion).fromArray(t);break;case"bool":case"boolean":case"string":i=t[0]}return i},setDisplayTime:function(e){this._action.time=e,this._mixer.update(0),this._onUpdate()},setDuration:function(e){this._clip.duration=e,this.durationFunc&&this.durationFunc(e)},getChannelNames:function(){return this._channelNames},getChannelKeyTimes:function(e){return this._tracks[e].times},addKeyframe:function(e,t){var i=this._tracks[e],n=i.times,r=Timeliner.binarySearch(n,t),o=i.values,s=i.getValueSize(),a=r*s;if(r<0){a=(r=~r)*s;for(var l=n.length+1,d=o.length+s,h=l-1;h!==r;--h)n[h]=n[h-1];h=d-1;for(var c=a+s-1;h!==c;--h)o[h]=o[h-s]}n[r]=t,this._propRefs[e].getValue(o,a),this.addKeyFunc&&this.addKeyFunc(e,t,o)},delKeyframe:function(e,t){var i=this._tracks[e],n=i.times,r=Timeliner.binarySearch(n,t);if(1<n.length&&0<=r){for(var o=n.length-1,s=i.values,a=i.getValueSize(),l=s.length-a,d=r;d!==o;++d)n[d]=n[d+1];n.pop();for(var h=r*a;h!==l;++h)s[h]=s[h+a];s.length=l}this.delKeyFunc&&this.delKeyFunc(e,t)},moveKeyframe:function(e,t,i,n){var r=this._tracks[e],o=r.times,s=Timeliner.binarySearch(o,t);if(0<=s){for(var a=n?o.length:s+1,l=o[s-1]<=t||!n&&t>=o[s+1];s!==a;)o[s++]+=i;l&&this._sort(r)}this.moveKeyFunc&&this.moveKeyFunc(e,t)},serialize:function(){for(var e={duration:this._clip.duration,channels:{}},t=this._channelNames,i=this._tracks,n=e.channels,r=0,o=t.length;r!==o;++r){var s=t[r],a=i[s];n[s]={times:a.times,values:a.values}}return e},deserialize:function(e){var t=this._channelNames,i=this._tracks,n=e.channels;this.setDuration(e.duration);for(var r=0,o=t.length;r!==o;++r){var s=t[r],a=i[s],l=n[s];this._setArray(a.times,l.times),this._setArray(a.values,l.values)}this.setDisplayTime(this._mixer.time)},setInterpolation:function(e,t){this.getTracks(e).setInterpolation(t),console.log(this.getTracks(e))},getInterpolation:function(e){return this.getTracks(e).getInterpolation()},getValueFromProperty:function(e){var t=e.split("."),i=EditorModule.target.objectByUuid(t[0]),n=null;2==t.length?n=i[t[1]]:3==propertys.length&&(n=i[t[1]][t[2]]);var r=null;return n instanceof TONG.Value&&(n=n.getValue()),"object"!=typeof n?r=n:n instanceof TONG.Vector2?r=n.clone():n instanceof TONG.Vector3?r=n.clone():n instanceof TONG.Vector4?r=n.clone():n instanceof TONG.Euler?r=n.clone():n instanceof TONG.Quaternion?r=n.clone():n instanceof TONG.Color?r=n.clone():n instanceof TONG.Slider?(r=new TONG.Slider).fromArray(n.toArray()):n instanceof TONG.Pad&&(r=new TONG.Pad).fromArray(n.toArray()),r},dataFromClip:function(e){this.setDuration(e.duration);for(var t=0;t<e.tracks.length;t++){var i=e.tracks[t];this._addTrackFromClip(i);var n=i.name,r=n.split("."),o=EditorModule.target.objectByUuid(r[0]);this._trackInfo.push({interpolation:i.getInterpolation(),propertyPath:n,originalValue:this.getValueFromProperty(n),root:o});for(var s=i.getValueSize(),a=i.times,l=i.values,d=0;d<a.length;d++){for(var h=[],c=d*s;c<d*s+s;c++)h.push(l[c]);this.setKeyFrame(n,a[d],h)}}this._clip=e,this._mixer._initMemoryManager(),this._action=this._mixer.clipAction(this._clip).play(),this.setDisplayTime(this._mixer.time)},_addTrackFromClip:function(e){return e.times=Array.prototype.slice.call(e.times),e.values=Array.prototype.slice.call(e.values),this._channelNames.push(e.name),this._tracks[e.name]=e,this._propRefs[e.name]=new TONG.PropertyBinding(this._scene,e.name),e},_sort:function(e){var t=e.times,i=TONG.AnimationUtils.getKeyframeOrder(t);this._setArray(t,TONG.AnimationUtils.sortedArray(t,1,i));var n=e.values,r=e.getValueSize();this._setArray(n,TONG.AnimationUtils.sortedArray(n,r,i))},_setArray:function(e,t){e.length=0,e.push.apply(e,t)},_addTrack:function(e,t,i,n){var r=new e(t,[0],i,n);return r.times=Array.prototype.slice.call(r.times),r.values=Array.prototype.slice.call(r.values),this._channelNames.push(t),this._tracks[t]=r,this._propRefs[t]=new TONG.PropertyBinding(this._scene,t),r}},EditorControls.prototype=Object.create(TONG.Group.prototype),EditorControls.prototype.attach=function(e){for(;0<this.children.length;)this.remove(this.children[0]);this.add(e),this.camera=e,this.updateControls()},EditorControls.prototype.reset=function(){},EditorControls.prototype.focusObject=function(e){},EditorControls.prototype.setOrientation=function(e){},EditorControls.prototype.update=function(e,t){},EditorControls.prototype.updateControls=function(){},EditorFreeControls.prototype=Object.create(EditorControls.prototype),EditorFreeControls.ZERO=new TONG.Vector3(0,0,0),EditorFreeControls.prototype.reset=function(){this.orientation.set(.5,.5),this.position.set(5,4.8,7.4),this.updateControls()},EditorFreeControls.prototype.focusObject=function(e){if(e){var t=ObjectUtils.calculateBoundingBox(e);t&&t.applyMatrix4(e.matrixWorld);var i=t?t.getSize(new TONG.Vector3).length():2,n=this.getWorldPosition(new TONG.Vector3).distanceTo(e.getWorldPosition(new TONG.Vector3)),r=e.position.clone();r.sub(this.position),r.normalize(),r.multiplyScalar(n-i),this.position.add(r),this.updateControls()}},EditorFreeControls.prototype.setOrientation=function(e){e===OrientationCube.Z_POS?this.orientation.set(0,0):e===OrientationCube.Z_NEG?this.orientation.set(Math.PI,0):e===OrientationCube.X_POS?this.orientation.set(Math.PI/2,0):e===OrientationCube.X_NEG?this.orientation.set(-Math.PI/2,0):e===OrientationCube.Y_POS?this.orientation.set(Math.PI,1.57):e===OrientationCube.Y_NEG&&this.orientation.set(Math.PI,-1.57),this.updateControls(!0)},EditorFreeControls.prototype.update=function(e,t){var i=!1;if(e.buttonPressed(Mouse.LEFT)&&(this.orientation.y-=Settings.mouseLookSensitivity*(Settings.invertNavigation?e.delta.y:-e.delta.y),this.orientation.x-=Settings.mouseLookSensitivity*e.delta.x,this.orientation.y<-1.57?this.orientation.y=-1.57:1.57<this.orientation.y&&(this.orientation.y=1.57),i=!0),e.buttonPressed(Mouse.RIGHT)){var n;(n=this.position.distanceTo(EditorFreeControls.ZERO)*Settings.mouseMoveSpeed)<.01&&(n=.01);var r=Math.cos(this.orientation.x),o=Math.sin(this.orientation.x);this.position.z-=e.delta.y*n*r,this.position.x-=e.delta.y*n*o;r=Math.cos(this.orientation.x+MathUtils.pid2),o=Math.sin(this.orientation.x+MathUtils.pid2);this.position.z-=e.delta.x*n*r,this.position.x-=e.delta.x*n*o,i=!0}(e.buttonPressed(Mouse.MIDDLE)&&(this.position.y+=e.delta.y*Settings.mouseMoveSpeed*100,i=!0),0!==e.wheel)&&((n=e.wheel*this.position.distanceTo(EditorFreeControls.ZERO)*Settings.mouseWheelSensitivity)<0&&-.02<n?n=-.02:0<n&&n<.02&&(n=.02),(s=this.getWorldDirection(this.temp)).multiplyScalar(n),this.position.add(s),i=!0);if(Settings.keyboardNavigation){var s;if(t.keyPressed(Keyboard.S))(s=this.getWorldDirection(this.temp)).multiplyScalar(Settings.keyboardNavigationSpeed),this.position.add(s),i=!0;if(t.keyPressed(Keyboard.W))(s=this.getWorldDirection(this.temp)).multiplyScalar(Settings.keyboardNavigationSpeed),this.position.sub(s),i=!0;t.keyPressed(Keyboard.D)&&(this.temp.set(Math.sin(this.orientation.x-1.57),0,Math.cos(this.orientation.x-1.57)),this.temp.normalize(),this.temp.multiplyScalar(Settings.keyboardNavigationSpeed),this.position.sub(this.temp),i=!0),t.keyPressed(Keyboard.A)&&(this.temp.set(Math.sin(this.orientation.x+1.57),0,Math.cos(this.orientation.x+1.57)),this.temp.normalize(),this.temp.multiplyScalar(Settings.keyboardNavigationSpeed),this.position.sub(this.temp),i=!0)}i&&this.updateControls()},EditorFreeControls.prototype.updateControls=function(e){var t=Math.cos(this.orientation.y);this.temp.set(Math.sin(this.orientation.x)*t,Math.sin(this.orientation.y),Math.cos(this.orientation.x)*t),this.temp.add(this.position),this.lookAt(this.temp),this.updateMatrixWorld(!0),e||this.dispatchEvent(this.changeEvent)},EditorOrbitControls.UP=new TONG.Vector3(0,1,0),EditorOrbitControls.prototype=Object.create(EditorControls.prototype),EditorOrbitControls.prototype.reset=function(){this.distance=10,this.center.set(0,0,0),this.orientation.set(-.4,.4),this.updateControls()},EditorOrbitControls.prototype.focusObject=function(e){var t=ObjectUtils.calculateBoundingBox(e);if(null!==t){t.applyMatrix4(e.matrixWorld),t.getCenter(this.center);var i=t.getSize(this.tempVector).length();this.camera instanceof TONG.PerspectiveCamera?this.distance=i/2/Math.tan(.5*TONG.Math.DEG2RAD*this.camera.fov):this.distance=i,this.updateControls()}else e.getWorldPosition(this.center),this.distance=this.center.y+1,this.updateControls()},EditorOrbitControls.prototype.setOrientation=function(e){e===OrientationCube.Z_POS?this.orientation.set(Math.PI/2,0):e===OrientationCube.Z_NEG?this.orientation.set(-Math.PI/2,0):e===OrientationCube.X_POS?this.orientation.set(0,0):e===OrientationCube.X_NEG?this.orientation.set(Math.PI,0):e===OrientationCube.Y_POS?this.orientation.set(Math.PI,1.57):e===OrientationCube.Y_NEG&&this.orientation.set(Math.PI,-1.57),this.updateControls(!0)},EditorOrbitControls.prototype.update=function(e,t){var i=!1;if(e.buttonPressed(Mouse.LEFT)&&(this.orientation.y+=Settings.mouseLookSensitivity*(Settings.invertNavigation?e.delta.y:-e.delta.y),this.orientation.x-=Settings.mouseLookSensitivity*e.delta.x,i=!0),e.buttonPressed(Mouse.MIDDLE)&&(this.center.y+=e.delta.y*Settings.mouseLookSensitivity*this.distance,i=!0),e.buttonPressed(Mouse.RIGHT)){var n,r=0<(n=this.getWorldDirection(this.tempVector)).y;n.y=0,n.normalize();var o=e.delta.y*Settings.mouseLookSensitivity*this.distance;this.center.x+=r?-n.x*o:n.x*o,this.center.z+=r?-n.z*o:n.z*o,n.applyAxisAngle(EditorOrbitControls.UP,1.57);var s=e.delta.x*Settings.mouseLookSensitivity*this.distance;this.center.x-=n.x*s,this.center.z-=n.z*s,i=!0}0!==e.wheel&&(this.distance+=e.wheel*this.position.distanceTo(this.center)*Settings.mouseWheelSensitivity,i=!0),t.keyPressed(Keyboard.S)&&((n=this.getWorldDirection(this.tempVector)).y=0,n.normalize(),this.center.x+=n.x*Settings.keyboardNavigationSpeed,this.center.z+=n.z*Settings.keyboardNavigationSpeed,i=!0),t.keyPressed(Keyboard.W)&&((n=this.getWorldDirection(this.tempVector)).y=0,n.normalize(),this.center.x-=n.x*Settings.keyboardNavigationSpeed,this.center.z-=n.z*Settings.keyboardNavigationSpeed,i=!0),t.keyPressed(Keyboard.A)&&((n=this.getWorldDirection(this.tempVector)).y=0,n.normalize(),n.applyAxisAngle(EditorOrbitControls.UP,1.57),this.center.x-=n.x*Settings.keyboardNavigationSpeed,this.center.z-=n.z*Settings.keyboardNavigationSpeed,i=!0),t.keyPressed(Keyboard.D)&&((n=this.getWorldDirection(this.tempVector)).y=0,n.normalize(),n.applyAxisAngle(EditorOrbitControls.UP,1.57),this.center.x+=n.x*Settings.keyboardNavigationSpeed,this.center.z+=n.z*Settings.keyboardNavigationSpeed,i=!0),!0===i&&this.updateControls()},EditorOrbitControls.prototype.updateControls=function(e){this.orientation.y<this.limitDown?this.orientation.y=this.limitDown:this.orientation.y>this.limitUp&&(this.orientation.y=this.limitUp),this.distance<this.minDistance?this.distance=this.minDistance:this.distance>this.maxDistance&&(this.distance=this.maxDistance);var t=this.distance*Math.cos(this.orientation.y);this.position.set(Math.cos(this.orientation.x)*t,this.distance*Math.sin(this.orientation.y),Math.sin(this.orientation.x)*t),this.position.add(this.center),this.tempMatrix.lookAt(this.position,this.center,EditorOrbitControls.UP),this.quaternion.setFromRotationMatrix(this.tempMatrix),this.updateMatrixWorld(!0),this.camera instanceof OrthographicCamera&&(this.camera.size=this.distance,this.camera.updateProjectionMatrix()),e||this.dispatchEvent(this.changeEvent)},EditorPlanarControls.prototype=Object.create(EditorOrbitControls.prototype),EditorPlanarControls.prototype.setOrientation=function(e){},EditorPlanarControls.prototype.setMode=function(e){(this.mode=e)===Settings.PLANAR_FRONT?this.orientation.set(Math.PI/2,0):e===Settings.PLANAR_BACK?this.orientation.set(-Math.PI/2,0):e===Settings.PLANAR_LEFT?this.orientation.set(0,0):e===Settings.PLANAR_RIGHT?this.orientation.set(Math.PI,0):e===Settings.PLANAR_TOP?this.orientation.set(Math.PI,1.57):e===Settings.PLANAR_BOTTOM&&this.orientation.set(Math.PI,-1.57),this.updateControls()},EditorPlanarControls.prototype.reset=function(){this.distance=10,this.center.set(0,0,0),this.updateControls()},EditorPlanarControls.prototype.update=function(e,t){var i=!1;if(e.buttonPressed(Mouse.RIGHT)){var n=this.getWorldDirection(this.tempVector),r=0<n.y;if(n.y=0,n.normalize(),this.mode===Settings.PLANAR_TOP||this.mode===Settings.PLANAR_BOTTOM){var o=e.delta.y*Settings.mouseLookSensitivity*this.distance;this.center.x+=r?-n.x*o:n.x*o,this.center.z+=r?-n.z*o:n.z*o}else this.center.y+=e.delta.y*Settings.mouseLookSensitivity*this.distance;n.applyAxisAngle(EditorOrbitControls.UP,1.57);var s=e.delta.x*Settings.mouseLookSensitivity*this.distance;this.center.x-=n.x*s,this.center.z-=n.z*s,i=!0}0!==e.wheel&&(this.distance+=e.wheel*Settings.mouseWheelSensitivity*this.distance,i=!0),!0===i&&this.updateControls()};var Config=function(i){var n={autosave:!0,theme:"css/dark.css","project/renderer":"WebGLRenderer","project/renderer/antialias":!0,"project/renderer/gammaInput":!1,"project/renderer/gammaOutput":!1,"project/renderer/shadows":!0,"project/vr":!1,"settings/history":!1,gravity:{x:0,y:-10,z:0}};if(void 0===window.localStorage[i])window.localStorage[i]=JSON.stringify(n);else{var e=JSON.parse(window.localStorage[i]);for(var t in e)n[t]=e[t]}return{getKey:function(e){return n[e]},setKey:function(){for(var e=0,t=arguments.length;e<t;e+=2)n[arguments[e]]=arguments[e+1];window.localStorage[i]=JSON.stringify(n),console.log("["+/\d\d\:\d\d\:\d\d/.exec(new Date)[0]+"]","Saved config to TongEngine.")},clear:function(){delete window.localStorage[i]}}};History=function(e){this.editor=e,this.undos=[],this.redos=[],this.lastCmdTime=new Date,this.idCounter=0,this.historyDisabled=!1,this.config=e.config,Command(e);var t=this;this.editor.signals.startPlayer.add(function(){t.historyDisabled=!0}),this.editor.signals.stopPlayer.add(function(){t.historyDisabled=!1})},History.prototype={execute:function(e,t){var i=this.undos[this.undos.length-1],n=(new Date).getTime()-this.lastCmdTime.getTime(),r=i&&i.updatable&&e.updatable&&i.object===e.object&&i.type===e.type&&i.script===e.script&&i.attributeName===e.attributeName;r&&"SetScriptValueCommand"===e.type?(i.update(e),e=i):r&&n<500?(i.update(e),e=i):(this.undos.push(e),e.id=++this.idCounter),e.name=void 0!==t?t:e.name,e.execute(),e.inMemory=!0,this.config.getKey("settings/history")&&(e.json=e.toJSON()),this.lastCmdTime=new Date,this.redos=[],this.editor.signals.historyChanged.dispatch(e)},undo:function(){if(!this.historyDisabled){var e=void 0;return 0<this.undos.length&&!1===(e=this.undos.pop()).inMemory&&e.fromJSON(e.json),void 0!==e&&(e.undo(),this.redos.push(e),this.editor.signals.historyChanged.dispatch(e)),e}alert("Undo/Redo disabled while scene is playing.")},redo:function(){if(!this.historyDisabled){var e=void 0;return 0<this.redos.length&&!1===(e=this.redos.pop()).inMemory&&e.fromJSON(e.json),void 0!==e&&(e.execute(),this.undos.push(e),this.editor.signals.historyChanged.dispatch(e)),e}alert("Undo/Redo disabled while scene is playing.")},toJSON:function(){var e={undos:[],redos:[]};if(!this.config.getKey("settings/history"))return e;for(var t=0;t<this.undos.length;t++)this.undos[t].hasOwnProperty("json")&&e.undos.push(this.undos[t].json);for(t=0;t<this.redos.length;t++)this.redos[t].hasOwnProperty("json")&&e.redos.push(this.redos[t].json);return e},fromJSON:function(e){if(void 0!==e){for(var t=0;t<e.undos.length;t++){var i=e.undos[t];(n=new window[i.type]).json=i,n.id=i.id,n.name=i.name,this.undos.push(n),this.idCounter=i.id>this.idCounter?i.id:this.idCounter}for(t=0;t<e.redos.length;t++){var n;i=e.redos[t];(n=new window[i.type]).json=i,n.id=i.id,n.name=i.name,this.redos.push(n),this.idCounter=i.id>this.idCounter?i.id:this.idCounter}this.editor.signals.historyChanged.dispatch(this.undos[this.undos.length-1])}},clear:function(){this.undos=[],this.redos=[],this.idCounter=0,this.editor.signals.historyChanged.dispatch()},goToState:function(e){if(this.historyDisabled)alert("Undo/Redo disabled while scene is playing.");else{this.editor.signals.sceneGraphChanged.active=!1,this.editor.signals.historyChanged.active=!1;var t=0<this.undos.length?this.undos[this.undos.length-1]:void 0;if(void 0===t||e>t.id)for(t=this.redo();void 0!==t&&e>t.id;)t=this.redo();else for(;void 0!==(t=this.undos[this.undos.length-1])&&e!==t.id;)t=this.undo();this.editor.signals.sceneGraphChanged.active=!0,this.editor.signals.historyChanged.active=!0,this.editor.signals.sceneGraphChanged.dispatch(),this.editor.signals.historyChanged.dispatch(t)}},enableSerialization:function(e){this.goToState(-1),this.editor.signals.sceneGraphChanged.active=!1,this.editor.signals.historyChanged.active=!1;for(var t=this.redo();void 0!==t;)t.hasOwnProperty("json")||(t.json=t.toJSON()),t=this.redo();this.editor.signals.sceneGraphChanged.active=!0,this.editor.signals.historyChanged.active=!0,this.goToState(e)}};var Loader=function(f){var g=this;f.signals;function l(e,t,i){switch(void 0===e.metadata&&(e.metadata={type:"Geometry"}),void 0===e.metadata.type&&(e.metadata.type="Geometry"),void 0!==e.metadata.formatVersion&&(e.metadata.version=e.metadata.formatVersion),e.metadata.type.toLowerCase()){case"buffergeometry":var n=(a=new TONG.BufferGeometryLoader).parse(e),r=new TONG.Mesh(n);f.execute(new AddObjectCommand(r));break;case"geometry":(a=new TONG.JSONLoader).setTexturePath(g.texturePath);var o,s=(n=a.parse(e)).geometry;o=void 0!==n.materials?1<n.materials.length?new TONG.MultiMaterial(n.materials):n.materials[0]:new TONG.MeshStandardMaterial,s.sourceType="ascii",s.sourceFile=t.name,(r=s.animation&&s.animation.hierarchy?new TONG.SkinnedMesh(s,o):new TONG.Mesh(s,o)).name=i,f.execute(new AddObjectCommand(r));break;case"object":var a;(a=new TONG.ObjectLoader).setTexturePath(g.texturePath),(n=a.parse(e))instanceof TONG.Scene?f.execute(new SetSceneCommand(n)):f.execute(new AddObjectCommand(n));break;case"app":f.stopAutoSave();var l="New Tong Scene";e.scene.object.name&&""!=e.scene.object.name&&(l=e.scene.object.name);var d=allProjectJsonDictionary.get(f.currentProjectName),h=Utils.RenameFunc(d,"",l+""),c=Utils.GetCurrentFullTime();d[h].sceneTime=c,allProjectJsonDictionary.get(f.currentProjectName)[h+""].data=e,f.saveProjectInfoToStorage(allProjectJsonDictionary),f.startAutoSave();break;case"tongproject":f.stopAutoSave();var u=Object.keys(e)[0];d=e[u+""],h=Utils.RenameFunc(allProjectJsonDictionary,"",u+"");d.renameRef=allProjectJsonDictionary.get(h+"").renameRef,d.GUID=allProjectJsonDictionary.get(h+"").GUID,allProjectJsonDictionary.data[h+""]=d,f.saveProjectInfoToStorage(allProjectJsonDictionary),f.startAutoSave()}}this.texturePath="",this.loadFile=function(s){var a=s.name,e=a.split(".").pop().toLowerCase(),t=new FileReader;switch(t.addEventListener("progress",function(e){var t="("+Math.floor(e.total/1e3).format()+" KB)",i=Math.floor(e.loaded/e.total*100),n=i+"%";console.log("Loading",a,t,i),$("#progressPanel").show(),ProgressPanel.setProgress("Import "+a,i),"100%"==n&&$("#progressPanel").hide()}),e){case"amf":t.addEventListener("load",function(e){var t=(new TONG.AMFLoader).parse(e.target.result);f.execute(new AddObjectCommand(t))},!1),t.readAsArrayBuffer(s);break;case"awd":t.addEventListener("load",function(e){var t=(new TONG.AWDLoader).parse(e.target.result);f.execute(new SetSceneCommand(t))},!1),t.readAsArrayBuffer(s);break;case"babylon":t.addEventListener("load",function(e){var t=e.target.result,i=JSON.parse(t),n=(new TONG.BabylonLoader).parse(i);f.execute(new SetSceneCommand(n))},!1),t.readAsText(s);break;case"babylonmeshdata":t.addEventListener("load",function(e){var t=e.target.result,i=JSON.parse(t),n=(new TONG.BabylonLoader).parseGeometry(i),r=new TONG.MeshStandardMaterial,o=new TONG.Mesh(n,r);o.name=a,f.execute(new AddObjectCommand(o))},!1),t.readAsText(s);break;case"ctm":t.addEventListener("load",function(e){var t=new Uint8Array(e.target.result),i=new CTM.Stream(t);i.offset=0,(new TONG.CTMLoader).createModel(new CTM.File(i),function(e){e.sourceType="ctm",e.sourceFile=s.name;var t=new TONG.MeshStandardMaterial,i=new TONG.Mesh(e,t);i.name=a,f.execute(new AddObjectCommand(i))})},!1),t.readAsArrayBuffer(s);break;case"dae":t.addEventListener("load",function(e){var t=e.target.result,i=(new TONG.ColladaLoader).parse(t);i.scene.name=a,f.execute(new AddObjectCommand(i.scene))},!1),t.readAsText(s);break;case"fbx":t.addEventListener("load",function(e){var t=e.target.result,i=(new TONG.FBXLoader).parse(t);f.execute(new AddObjectCommand(i))},!1),t.readAsText(s);break;case"glb":case"gltf":t.addEventListener("load",function(e){var t=e.target.result;(new TONG.GLTFLoader).parse(t,function(e){e.scene.name=a,f.execute(new AddObjectCommand(e.scene))})},!1),t.readAsArrayBuffer(s);break;case"js":case"json":case"3geo":case"3mat":case"3obj":case"3scn":t.addEventListener("load",function(e){var t,i=e.target.result;if(-1!==i.indexOf("postMessage")){var n=new Blob([i],{type:"text/javascript"}),r=URL.createObjectURL(n),o=new Worker(r);return o.onmessage=function(e){e.data.metadata={version:2},l(e.data,s,a)},void o.postMessage(Date.now())}try{t=JSON.parse(i)}catch(e){return void alert(e)}l(t,s,a)},!1),t.readAsText(s);break;case"kmz":t.addEventListener("load",function(e){var t=(new TONG.KMZLoader).parse(e.target.result);t.scene.name=a,f.execute(new AddObjectCommand(t.scene))},!1),t.readAsArrayBuffer(s);break;case"md2":t.addEventListener("load",function(e){var t=e.target.result,i=(new TONG.MD2Loader).parse(t),n=new TONG.MeshStandardMaterial({morphTargets:!0,morphNormals:!0}),r=new TONG.Mesh(i,n);r.mixer=new TONG.AnimationMixer(r),r.name=a,f.execute(new AddObjectCommand(r))},!1),t.readAsArrayBuffer(s);break;case"obj":t.addEventListener("load",function(e){var t=e.target.result,i=(new TONG.OBJLoader).parse(t);i.name=a,f.execute(new AddObjectCommand(i))},!1),t.readAsText(s);break;case"playcanvas":t.addEventListener("load",function(e){var t=e.target.result,i=JSON.parse(t),n=(new TONG.PlayCanvasLoader).parse(i);f.execute(new AddObjectCommand(n))},!1),t.readAsText(s);break;case"ply":t.addEventListener("load",function(e){var t=e.target.result,i=(new TONG.PLYLoader).parse(t);i.sourceType="ply",i.sourceFile=s.name;var n=new TONG.MeshStandardMaterial,r=new TONG.Mesh(i,n);r.name=a,f.execute(new AddObjectCommand(r))},!1),t.readAsArrayBuffer(s);break;case"stl":t.addEventListener("load",function(e){var t=e.target.result,i=(new TONG.STLLoader).parse(t);i.sourceType="stl",i.sourceFile=s.name;var n=new TONG.MeshStandardMaterial,r=new TONG.Mesh(i,n);r.name=a,f.execute(new AddObjectCommand(r))},!1),void 0!==t.readAsBinaryString?t.readAsBinaryString(s):t.readAsArrayBuffer(s);break;case"vtk":t.addEventListener("load",function(e){var t=e.target.result,i=(new TONG.VTKLoader).parse(t);i.sourceType="vtk",i.sourceFile=s.name;var n=new TONG.MeshStandardMaterial,r=new TONG.Mesh(i,n);r.name=a,f.execute(new AddObjectCommand(r))},!1),t.readAsText(s);break;case"wrl":t.addEventListener("load",function(e){var t=e.target.result,i=(new TONG.VRMLLoader).parse(t);f.execute(new SetSceneCommand(i))},!1),t.readAsText(s);break;default:alert("Unsupported file format ("+e+").")}}},ToolManager=function(e){var t=new UI.Panel;t.setId("toolManager");var i=new Toolbar(e);t.add(i);var n=new UI.Image(UserProfile.avatar_base_url+"/"+UserProfile.avatar_path);n.setPosition("absolute"),n.setId("userBtn"),n.dom.style.right="0px",n.setHeight("40px"),n.setWidth("40px"),n.dom.style.borderRadius="50%",n.dom.title=UserAccount.username,n.onClick(function(){window.open("http://tong3d.com/user/default/index","_blank")}),t.add(n);var r=new UI.ButtonIcon("css/pic/toolBar/AssetsStore.png","#303030","5% 40%","");r.setPosition("absolute"),r.setId("language"),r.dom.style.right="50px",r.setHeight("40px"),r.dom.title=GetLanguage("Assets Store"),r.onClick(function(){window.open("http://assets.tong3d.com","_blank")}),t.add(r);var o=new UI.Button("");o.setPosition("absolute"),o.setId("controlPanel"),o.dom.style.right="90px",o.dom.title=GetLanguage("Control"),t.add(o);var s=new UI.Button("");s.setId("forumBtn"),s.setPosition("absolute"),s.dom.title=GetLanguage("Forum"),s.dom.style.right="130px",s.onClick(function(e){window.open("http://forum.tong3d.com")}),t.add(s);var a=new UI.Button("");a.setId("settingBtn"),a.dom.title=GetLanguage("Settings"),a.dom.style.right="170px",a.setPosition("absolute"),t.add(a),Utils.OnClick(a,function(e,t){EditorModule.inspect(SettingComponent,EditorModule.inspector.componentWidgets)});var l=new UI.Panel;l.setPosition("absolute"),l.setId("searchHelpPanel"),l.setWidth("300px"),l.setHeight("40px"),l.setLeft("510px"),l.setTop("0px"),l.setBackground("url('css/pic/search.png') #262626 3% 50% no-repeat");var d=new UI.Input("");return d.setPosition("relative"),d.setColor("#cecece"),d.setBackgroundColor("#262626"),d.dom.placeholder=GetLanguage("Help you")+"...?",d.setWidth("90%"),d.setHeight("40px"),d.setLeft("30px"),d.dom.style.zIndex=1,l.add(d),t.add(l),t},Menubar=function(e){var t=new UI.Panel;t.setId("menubar");var i=new UI.Row;i.setClass("option");var n=new Menubar.File(e);i.add(n),i.onMouseOver(function(e){n.dom.getElementsByClassName("options")[0].style.top=Utils.GetElementOffset(i.dom).top-1+"px"}),t.add(i);var r=new UI.Row;r.setClass("option");var o=new Menubar.Edit(e);o.dom.onmouseover=function(e){o.dom.getElementsByClassName("options")[0].style.top=Utils.GetElementOffset(o.dom).top-1+"px"},t.add(r.add(o));var s=new UI.Row;s.setClass("option");var a=new Menubar.Add(e);t.add(s.add(a)),a.dom.onmousemove=function(e){a.dom.getElementsByClassName("options")[0].style.top=Utils.GetElementOffset(a.dom).top-1+"px"};var l=new UI.Row;l.setClass("option");var d=new Menubar.UI(e);t.add(l.add(d)),d.dom.onmousemove=function(e){d.dom.getElementsByClassName("options")[0].style.top=Utils.GetElementOffset(d.dom).top-1+"px"};var h=new UI.Row;h.setClass("option");var c=new Menubar.Play(e);t.add(h.add(c));var u=new UI.Row;u.setClass("option");var f=new Menubar.Help(e);return t.add(u.add(f)),f.dom.onmousemove=function(e){f.dom.getElementsByClassName("options")[0].style.top=Utils.GetElementOffset(f.dom).top-1+"px"},t};Menubar.Add=function(r,e){var t=new UI.Panel;if(t.setClass("menu"),!e){var i=new UI.Panel;i.setClass("title"),i.setTextContent("Add"),t.add(i)}var n=new UI.Panel;n.setClass("options"),t.add(n);var o,s=0,a=0,l=0;return r.signals.editorCleared.add(function(){l=a=s=0}),(o=new UI.Row).setClass("option"),o.setTextContent(GetLanguage("Group")),o.onMouseDown(function(){var e=new TONG.Group;e.name=GetLanguage("Group")+" "+ ++s,r.execute(new AddObjectCommand(e))}),n.add(o),n.add(new UI.HorizontalRule),(o=new UI.Row).setClass("option"),o.setTextContent(GetLanguage("Plane")),o.onMouseDown(function(){var e=new TONG.PlaneBufferGeometry(2,2),t=new TONG.MeshStandardMaterial,i=new TONG.Mesh(e,t);i.name=GetLanguage("Plane")+" "+ ++s,r.execute(new AddObjectCommand(i))}),n.add(o),(o=new UI.Row).setClass("option"),o.setTextContent(GetLanguage("Box")),o.onMouseDown(function(){var e=new TONG.BoxBufferGeometry(1,1,1),t=new TONG.Mesh(e,new TONG.MeshStandardMaterial);t.name=GetLanguage("Box")+" "+ ++s,r.execute(new AddObjectCommand(t))}),n.add(o),(o=new UI.Row).setClass("option"),o.setTextContent(GetLanguage("Circle")),o.onMouseDown(function(){var e=new TONG.CircleBufferGeometry(1,32),t=new TONG.Mesh(e,new TONG.MeshStandardMaterial);t.name=GetLanguage("Circle")+" "+ ++s,r.execute(new AddObjectCommand(t))}),n.add(o),(o=new UI.Row).setClass("option"),o.setTextContent(GetLanguage("Cylinder")),o.onMouseDown(function(){var e=new TONG.CylinderBufferGeometry(1,1,2,32,1,!1),t=new TONG.Mesh(e,new TONG.MeshStandardMaterial);t.name=GetLanguage("Cylinder")+" "+ ++s,r.execute(new AddObjectCommand(t))}),n.add(o),(o=new UI.Row).setClass("option"),o.setTextContent(GetLanguage("Sphere")),o.onMouseDown(function(){var e=2*Math.PI,t=Math.PI,i=new TONG.SphereBufferGeometry(1,32,16,0,e,0,t),n=new TONG.Mesh(i,new TONG.MeshStandardMaterial);n.name=GetLanguage("Sphere")+" "+ ++s,r.execute(new AddObjectCommand(n))}),n.add(o),(o=new UI.Row).setClass("option"),o.setTextContent(GetLanguage("Icosahedron")),o.onMouseDown(function(){var e=new TONG.IcosahedronGeometry(1,2),t=new TONG.Mesh(e,new TONG.MeshStandardMaterial);t.name=GetLanguage("Icosahedron ")+" "+ ++s,r.execute(new AddObjectCommand(t))}),n.add(o),(o=new UI.Row).setClass("option"),o.setTextContent(GetLanguage("Torus")),o.onMouseDown(function(){var e=2*Math.PI,t=new TONG.TorusBufferGeometry(2,1,32,12,e),i=new TONG.Mesh(t,new TONG.MeshStandardMaterial);i.name=GetLanguage("Torus")+" "+ ++s,r.execute(new AddObjectCommand(i))}),n.add(o),(o=new UI.Row).setClass("option"),o.setTextContent(GetLanguage("TorusKnot")),o.onMouseDown(function(){var e=new TONG.TorusKnotBufferGeometry(2,.8,64,12,2,3),t=new TONG.Mesh(e,new TONG.MeshStandardMaterial);t.name=GetLanguage("TorusKnot")+" "+ ++s,r.execute(new AddObjectCommand(t))}),n.add(o),(o=new UI.Row).setClass("option"),o.setTextContent(GetLanguage("Lathe")),o.onMouseDown(function(){var e=[new TONG.Vector2(0,0),new TONG.Vector2(4,0),new TONG.Vector2(3.5,.5),new TONG.Vector2(1,.75),new TONG.Vector2(.8,1),new TONG.Vector2(.8,4),new TONG.Vector2(1,4.2),new TONG.Vector2(1.4,4.8),new TONG.Vector2(2,5),new TONG.Vector2(2.5,5.4),new TONG.Vector2(3,12)],t=2*Math.PI,i=new TONG.LatheBufferGeometry(e,20,0,t),n=new TONG.Mesh(i,new TONG.MeshStandardMaterial({side:TONG.DoubleSide}));n.name=GetLanguage("Lathe")+" "+ ++s,r.execute(new AddObjectCommand(n))}),n.add(o),(o=new UI.Row).setClass("option"),o.setTextContent(GetLanguage("Partical")),o.onMouseDown(function(){var e=new TONG.Sprite(new TONG.SpriteMaterial);e.name=GetLanguage("Partical")+" "+ ++s,r.execute(new AddObjectCommand(e))}),n.add(o),n.add(new UI.HorizontalRule),(o=new UI.Row).setClass("option"),o.setTextContent(GetLanguage("PointLight")),o.onMouseDown(function(){var e=new TONG.PointLight(16777215,1,0);e.name=GetLanguage("PointLight")+" "+ ++a,r.execute(new AddObjectCommand(e))}),n.add(o),(o=new UI.Row).setClass("option"),o.setTextContent(GetLanguage("SpotLight")),o.onMouseDown(function(){var e=.1*Math.PI,t=new TONG.SpotLight(16777215,1,0,e,0);t.name=GetLanguage("SpotLight")+" "+ ++a,t.target.name="SpotLight "+a+" Target",t.position.set(5,10,7.5),r.execute(new AddObjectCommand(t))}),n.add(o),(o=new UI.Row).setClass("option"),o.setTextContent(GetLanguage("DirectionalLight")),o.onMouseDown(function(){var e=new TONG.DirectionalLight(16777215,1);e.name=GetLanguage("DirectionalLight")+" "+ ++a,e.position.set(5,10,7.5),r.execute(new AddObjectCommand(e))}),n.add(o),(o=new UI.Row).setClass("option"),o.setTextContent(GetLanguage("HemisphereLight")),o.onMouseDown(function(){var e=new TONG.HemisphereLight(43775,16755200,1);e.name=GetLanguage("HemisphereLight")+" "+ ++a,e.position.set(0,10,0),r.execute(new AddObjectCommand(e))}),n.add(o),(o=new UI.Row).setClass("option"),o.setTextContent(GetLanguage("AmbientLight")),o.onMouseDown(function(){var e=new TONG.AmbientLight(2236962);e.name=GetLanguage("AmbientLight")+" "+ ++a,r.execute(new AddObjectCommand(e))}),n.add(o),n.add(new UI.HorizontalRule),(o=new UI.Row).setClass("option"),o.setTextContent(GetLanguage("PerspectiveCamera")),o.onMouseDown(function(){var e=new PerspectiveCamera(50,1,1,1e4);e.name=GetLanguage("PerspectiveCamera")+" "+ ++l,r.execute(new AddObjectCommand(e))}),n.add(o),t};var Sidebar=function(e){var t=new UI.Panel;t.setId("sidebar");var i=new UI.Text("Inspector").onClick(s),n=new UI.Text("Project").onClick(s),r=new UI.Text("Settings").onClick(s),o=new UI.Div;function s(e){h(e.target.textContent)}o.setId("tabs"),o.add(i,n,r),t.add(o);var a=(new UI.Span).add(new Sidebar.Properties(e),new Sidebar.Animation(e),new Sidebar.Script(e));t.add(a);var l=(new UI.Span).add(new Sidebar.Project(e));t.add(l);var d=(new UI.Span).add(new Sidebar.Settings(e),new Sidebar.History(e));function h(e){switch(i.setClass(""),n.setClass(""),r.setClass(""),a.setDisplay("none"),l.setDisplay("none"),d.setDisplay("none"),e){case"Inspector":i.setClass("selected"),a.setDisplay("");break;case"Project":n.setClass("selected"),l.setDisplay("");break;case"Settings":r.setClass("selected"),d.setDisplay("")}}return t.add(d),h("Inspector"),t};function ProfilingPanelWidget(e){e=e||{};var t=this;this.enabled=!0,this.refresh_time=250,this.max_samples=100,this.last_fps=0,this.last_time=0,this.frames=0,this.buffer=[],this.frame_cpu_time=0,(this.widget=this).root=document.createElement("div"),this.root.className="profiling-panel",(this.root.panel=this).root.style.width="100%",this.root.style.height="100%",e.id&&(this.root.id=e.id);var i=e.canvas_height||150,n=this.area=new LiteGUI.Area;n.split("vertical",[i,null]),this.root.appendChild(n.root),this.canvas=createCanvas(100,i),this.area.getSection(0).add(this.canvas),this.render(),this.panel=new LiteGUI.Panel({title:GetLanguage("Profile info")}),this.area.getSection(1).add(this.panel),this.table=new LiteGUI.Table({width:400,scrollable:!0,columns:[{name:GetLanguage("Parameter"),width:200},GetLanguage("Value")]}),this.table.addRow([GetLanguage("Frame CPU Time"),"---"]),this.table.addRow([GetLanguage("Frames"),"---"]),this.table.addRow(["Draw Calls","---"]),this.table.addRow([GetLanguage("Geometries"),"---"]),this.table.addRow([GetLanguage("Faces"),"---"]),this.table.addRow([GetLanguage("Textures"),"---"]),this.table.addRow([GetLanguage("Points"),"---"]),this.table.addRow([GetLanguage("Vertices"),"---"]),this.table.addRow([GetLanguage("Objects"),"---"]),this.panel.add(this.table),this.root.addEventListener("DOMNodeInsertedIntoDocument",function(){t.bindEvents()}),this.root.addEventListener("DOMNodeRemovedFromDocument",function(){t.unbindEvents()})}function GenericTabsWidget(e){this.root=null,this.supported_widgets=null,this.init(e),this.addTab=this.tabs.addTab.bind(this.tabs)}ProfilingPanelWidget.vertices=0,ProfilingPanelWidget.objects=0,ProfilingPanelWidget.faces=0,ProfilingPanelWidget.widget_name=GetLanguage("Profiling"),ProfilingPanelWidget.prototype.render=function(){var e=LiteGUI.getRect(this.canvas.parentNode),t=e?e.width:100;this.canvas.width=t,this.max_samples=t-20,this.buffer.length>this.max_samples&&this.buffer.splice(0,this.buffer.length-this.max_samples);var i=this.canvas.getContext("2d");return i.fillStyle="#111",i.fillRect(0,0,this.canvas.width,this.canvas.height),i.fillStyle="#AAA",i.fillRect(0,0,this.canvas.width,1),this.updateGraph(this.renderer),!0},ProfilingPanelWidget.prototype.bindEvents=function(){TONG.Event.bind(EditorModule.globalTrigger,"afterRender",this.onFrame,this)},ProfilingPanelWidget.prototype.unbindEvents=function(){TONG.Event.unbind(EditorModule.globalTrigger,"afterRender",this.onFrame,this)},ProfilingPanelWidget.prototype.onFrame=function(e,t){if(this.renderer=t,this.enabled){var i=Date.now(),n=i-this.last_time;this.frame_cpu_time=n,this.frames++,n>this.refresh_time&&(this.last_fps=this.frames,this.buffer.push(this.last_fps*(1e3/this.refresh_time)),this.frames=0,this.buffer.length>this.max_samples&&this.buffer.shift(),this.last_time=i,this.updateGraph(t)),this.updateTable(t)}},ProfilingPanelWidget.prototype.updateTable=function(e){this.table&&(this.table.updateCell(0,1,this.frame_cpu_time.toFixed(2)+"ms"),this.table.updateCell(1,1,this.last_fps*(1e3/this.refresh_time)),this.table.updateCell(2,1,e.info.render.calls),this.table.updateCell(3,1,e.info.memory.geometries),this.table.updateCell(4,1,ProfilingPanelWidget.faces),this.table.updateCell(5,1,e.info.memory.textures),this.table.updateCell(6,1,e.info.render.points),this.table.updateCell(7,1,ProfilingPanelWidget.vertices),this.table.updateCell(8,1,ProfilingPanelWidget.objects))},ProfilingPanelWidget.prototype.updateGraph=function(e){if(this.canvas){var t=this.canvas.getContext("2d");if(t.clearRect(0,0,this.canvas.width,this.canvas.height),t.fillStyle="rgba(0,0,0,0.5)",t.fillRect(0,0,this.canvas.width,this.canvas.height),this.buffer.length){t.lineWidth=1,t.strokeStyle="rgba(255,255,255,0.4)",t.beginPath(),t.moveTo(10.5,10.5),t.lineTo(this.canvas.width-20.5,10.5),t.moveTo(10.5,this.canvas.height-10.5),t.lineTo(this.canvas.width-20.5,this.canvas.height-10.5),t.stroke();for(var i=0;i<this.buffer.length;i++){var n=this.buffer[i];t.strokeStyle=50<n?"#8F8":30<n?"#AD5":20<n?"orange":"red",t.beginPath(),t.moveTo(i+10.5,this.canvas.height-10.5),t.lineTo(i+10.5,this.canvas.height-10.5-Math.round(n)),t.stroke()}t.fillStyle="white",t.strokeStyle="black",t.font="18px Arial",t.lineWidth=2,t.strokeText(this.last_fps*(1e3/this.refresh_time),20,40),t.fillText(this.last_fps*(1e3/this.refresh_time),20,40)}}},ProfilingPanelWidget.prototype.onResize=function(){this.render()},CORE.registerWidget(ProfilingPanelWidget),GenericTabsWidget.prototype.init=function(e){e=e||{},this.root=LiteGUI.createElement("div",null,null,{width:"99.8%",height:"100%"}),e.id&&(this.root.id=e.id);var t=this.tabs=new LiteGUI.Tabs({height:"100%"});t.addPlusTab(this.onPlusTab.bind(this)),this.root.add(t),t.root.style.backgroundColor="#282828",this.bindEvents()},GenericTabsWidget.createDialog=function(e){var t=new LiteGUI.Dialog({title:"Panel",fullcontent:!0,closable:!0,detachable:!0,draggable:!0,minimize:!0,resizable:!0,parent:e,width:800,height:500}),i=new GenericTabsWidget;return t.add(i),t.on_close=function(){i.unbindEvents()},t.on_resize=function(){i.onResize()},t.show(),t},GenericTabsWidget.prototype.bindEvents=function(){},GenericTabsWidget.prototype.unbindEvents=function(){},GenericTabsWidget.prototype.onPlusTab=function(e,t){var i=this,n=this.supported_widgets;if(!n)for(var r in n=[],CORE.Widgets){var o=CORE.Widgets[r];n.push(o)}if(n.length)if(1!=n.length)new LiteGUI.ContextMenu(n,{event:t,callback:function(e,t){InterfaceModule.selectContextTab(e,function(e){i.addWidgetTab(e)})}});else this.addWidgetTab(n[0])},GenericTabsWidget.prototype.openInstanceTab=function(e){for(var t in this.tabs.tabs){var i=this.tabs.tabs[t],n=i.widget;if(n&&n.isInstance&&n.isInstance(e))return this.tabs.selectTab(i),!0}return!1},GenericTabsWidget.prototype.onResize=function(){for(var e in this.tabs.tabs){var t=this.tabs.tabs[e].widget;t&&t.onResize&&t.onResize()}},GenericTabsWidget.prototype.addWidgetTab=function(e,t){if(t=t||{},!e)throw"Widget missing";if(e.constructor===String&&(e=CORE.Widgets[e]),!e)throw"Widget missing";var i=t.title||e.widget_name||e.name,n=this.tabs.getNumOfTabs(),r=new e;tab=this.tabs.addTab(null,{title:i,selected:!0,closable:!0,size:"full",content:r.root,callback:function(){var e=this.widget;for(var t in o.tabs.tabs){var i=o.tabs.tabs[t],n=i.widget;e!=n&&n&&n.onChange&&n.onChange()}e.onShow&&e.onShow()},onclose:function(e){e.widget.onClose&&e.widget.onClose();if(!e.selected)return},skip_callbacks:!0,widget:r,index:n-1}),(tab.widget=r).onRename=function(e){tab.setTitle(e)};var o=this;return this.onWidgetCreated&&this.onWidgetCreated(r),LiteGUI.trigger(this,"tab_created",tab),r.onResize&&r.onResize(),tab};var ThemeConsole={barColor:"#222222",sepColor:"#292929",panelColor:"rgb(29, 29, 29)",resizeTabColor:"#222222",boxColor:"#444444",textColor:"rgb(153, 153, 153)",iconColor:"#FFFFFF",buttonColor:"#222222",buttonOverColor:"#555555",buttonLightColor:"#333333",audioTrack:"#222222",audioScrubber:"#FFFFFF",audioProgress:"#555555"};function Console(e){e=e||{},this.options=e,this.history=[],this.post_history=[],this.root=LiteGUI.createElement("div",".console-panel",null,{background:"#282828",width:"100%",height:"100%"}),this.element=this.root,this.filterTongJS=!1,this.bar=document.createElement("div"),this.bar.style.top="0px",this.bar.style.left="0px",this.bar.style.width="100%",this.bar.style.height="20px",this.bar.style.backgroundColor=ThemeConsole.barColor,this.element.appendChild(this.bar);var t=document.createElement("div");t.style.position="absolute",t.style.overflow="hidden",t.style.cursor="pointer",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center",t.style.right="8px",t.style.backgroundColor=ThemeConsole.buttonColor,t.style.color=ThemeConsole.textColor,t.onclick=function(){console.clear()};var i=document.createElement("span");i.style.whiteSpace="pre",t.appendChild(i),this.bar.appendChild(t);var n=document.createElement("img");n.style.position="relative",n.style.top="3px",n.style.width="13px",n.style.height="13px",n.src="css/pic/crash.png",i.appendChild(n),this.console=document.createElement("div"),this.console.style.overflow="auto",this.console.style.position="absolute",this.console.style.top="20px",this.console.style.bottom="25px",this.console.style.left="5px",this.console.style.width="100%",this.element.appendChild(this.console),this.code=document.createElement("input"),this.code.type="text",this.code.style.position="absolute",this.code.style.margin="0",this.code.style.boxSizing="border-box",this.code.style.textIndent="4px",this.code.style.color="#FFFFFF",this.code.style.borderStyle="solid",this.code.style.borderRightStyle="none",this.code.style.borderLeftStyle="none",this.code.style.borderBottomStyle="none",this.code.style.borderWidth="2px",this.code.style.borderColor=ThemeConsole.barColor,this.code.style.backgroundColor=ThemeConsole.panelColor,this.code.style.bottom="0px",this.code.style.left="0px",this.code.style.width="100%",this.code.style.height="25px",this.code.placeholder=GetLanguage("input")+"...",this.element.appendChild(this.code);var r=this;this.code.onkeydown=function(e){if(e.keyCode===Keyboard.ENTER){try{var t=eval.call(window,this.value);console.log(" >> "+this.value),console.log(t)}catch(e){console.error(" >> "+this.value),console.error(e)}r.history.push(this.value),this.value=""}else e.keyCode===Keyboard.UP&&0<r.history.length&&(this.value=r.history.pop())},this.useConsole()}function TimelineWidget(e){e=e||{},this.isClose=!1,this.resource=null,this.isSelect=!1,this.target=null,this.timeController=new TONG.TimelinerController(EditorModule.target.scene,[],EditorModule.viewport.transformRender),this.timeController.clickKeyFunc=this.onClickKeyFrame.bind(this),this.root=document.createElement("div"),this.root.className="timeline-panel",(this.root.panel=this).root.style.position="absolute",this.root.style.width="100%",this.root.style.height="100%",this.root.style.zIndex=0}Console.prototype.useConsole=function(){var e=this,t=window.console.log;window.console.log=function(){e.log(arguments),t.apply(null,arguments)};var i=window.console.warn;window.console.warn=function(){e.warn(arguments),i.apply(null,arguments)};var n=window.console.error;window.console.error=function(){e.error(arguments),n.apply(null,arguments)};var r=window.console.clear;window.console.clear=function(){e.clear(arguments),r.apply(null,arguments)}},Console.prototype.log=function(e){if(!this.filter(e)){for(var t=0;t<e.length;t++)this.console.appendChild(Console.createMessage(e[t]));this.console.appendChild(Console.createBar()),this.console.scrollTop=Number.MAX_SAFE_INTEGER}},Console.prototype.warn=function(e){if(!this.filter(e)){for(var t=0;t<e.length;t++){var i=Console.createMessage(e[t]);i.style.color="#FFFF00",this.console.appendChild(i)}this.console.appendChild(Console.createBar()),this.console.scrollTop=Number.MAX_SAFE_INTEGER}},Console.prototype.error=function(e){if(!this.filter(e)){for(var t=0;t<e.length;t++){var i=Console.createMessage(e[t]);i.style.color="#FF0000",this.console.appendChild(i)}this.console.appendChild(Console.createBar()),this.console.scrollTop=Number.MAX_SAFE_INTEGER}},Console.prototype.clear=function(e){for(this.history=[];this.console.hasChildNodes();)this.console.removeChild(this.console.lastChild);this.console.scrollTop=Number.MAX_SAFE_INTEGER},Console.prototype.filter=function(e){return!!(this.filterTongJS&&0<e.length&&(e[0]+"").startsWith("TONG"))},Console.prototype.updateInterface=function(){TabElement.prototype.updateInterface.call(this),this.visible&&(this.console.style.height=this.size.y-45+"px")},Console.createMessage=function(e){var t=document.createElement("div");if(t.style.width="100%",t.style.color="rgb(153, 153, 153)",t.style.backgroundColor="#282828",t.style.fontSize="12px",e instanceof Image){(r=document.createElement("img")).src=e.data,r.height=60,t.appendChild(r),(u=document.createElement("table")).style.display="inline-block",(o=u.insertRow(0)).insertCell(0).appendChild(document.createTextNode("Image")),(s=u.insertRow(1)).insertCell(0).appendChild(document.createTextNode("Name")),s.insertCell(1).appendChild(document.createTextNode(e.name)),(a=u.insertRow(2)).insertCell(0).appendChild(document.createTextNode("UUID")),a.insertCell(1).appendChild(document.createTextNode(e.uuid));var i=u.insertRow(3);i.insertCell(0).appendChild(document.createTextNode("Format")),i.insertCell(1).appendChild(document.createTextNode(e.format));var n=u.insertRow(4);n.insertCell(0).appendChild(document.createTextNode("Encoding")),n.insertCell(1).appendChild(document.createTextNode(e.encoding)),t.appendChild(u)}else if(e instanceof TONG.Material){var r,o,s,a;(r=MaterialRenderer.generateElement(e)).height=60,t.appendChild(r),(u=document.createElement("table")).style.display="inline-block",(o=u.insertRow(0)).insertCell(0).appendChild(document.createTextNode("Type")),o.insertCell(1).appendChild(document.createTextNode(e.type)),(s=u.insertRow(1)).insertCell(0).appendChild(document.createTextNode("Name")),s.insertCell(1).appendChild(document.createTextNode(e.name)),(a=u.insertRow(2)).insertCell(0).appendChild(document.createTextNode("UUID")),a.insertCell(1).appendChild(document.createTextNode(e.uuid)),t.appendChild(u)}else if(e.isVector2){(u=document.createElement("table")).style.display="inline-block",(l=u.insertRow(0)).insertCell(0).appendChild(document.createTextNode("X")),l.insertCell(1).appendChild(document.createTextNode("Y")),(d=u.insertRow(1)).insertCell(0).appendChild(document.createTextNode(e.x)),d.insertCell(1).appendChild(document.createTextNode(e.y)),t.appendChild(u)}else if(e.isVector3){(u=document.createElement("table")).style.display="inline-block",(l=u.insertRow(0)).insertCell(0).appendChild(document.createTextNode("X")),l.insertCell(1).appendChild(document.createTextNode("Y")),l.insertCell(2).appendChild(document.createTextNode("Z")),(d=u.insertRow(1)).insertCell(0).appendChild(document.createTextNode(e.x)),d.insertCell(1).appendChild(document.createTextNode(e.y)),d.insertCell(2).appendChild(document.createTextNode(e.z)),t.appendChild(u)}else if(e.isVector4||e.isQuaternion){var l,d;(u=document.createElement("table")).style.display="inline-block",(l=u.insertRow(0)).insertCell(0).appendChild(document.createTextNode("X")),l.insertCell(1).appendChild(document.createTextNode("Y")),l.insertCell(2).appendChild(document.createTextNode("Z")),l.insertCell(3).appendChild(document.createTextNode("W")),(d=u.insertRow(1)).insertCell(0).appendChild(document.createTextNode(e.x)),d.insertCell(1).appendChild(document.createTextNode(e.y)),d.insertCell(2).appendChild(document.createTextNode(e.z)),d.insertCell(3).appendChild(document.createTextNode(e.w)),t.appendChild(u)}else if(e instanceof TONG.Matrix4){(u=document.createElement("table")).style.display="inline-block";for(var h=0,c=0;h<16;h+=4,c++){(f=u.insertRow(c)).insertCell(0).appendChild(document.createTextNode(e.elements[h])),f.insertCell(1).appendChild(document.createTextNode(e.elements[h+1])),f.insertCell(2).appendChild(document.createTextNode(e.elements[h+2])),f.insertCell(3).appendChild(document.createTextNode(e.elements[h+3]))}t.appendChild(u)}else if(e instanceof TONG.Matrix3){var u;(u=document.createElement("table")).style.display="inline-block";for(h=0,c=0;h<9;h+=3,c++){var f;(f=u.insertRow(c)).insertCell(0).appendChild(document.createTextNode(e.elements[h])),f.insertCell(1).appendChild(document.createTextNode(e.elements[h+1])),f.insertCell(2).appendChild(document.createTextNode(e.elements[h+2]))}t.appendChild(u)}else if(null===e)t.appendChild(document.createTextNode("null"));else{var g=e;t.appendChild(document.createTextNode(g))}return t},Console.createBar=function(){var e=document.createElement("div");return e.style.width="100%",e.style.height="1px",e.style.marginTop="4px",e.style.marginBottom="4px",e.style.backgroundColor=ThemeConsole.barColor,e},Console.widget_name=GetLanguage("Console"),CORE.registerWidget(Console),TimelineWidget.prototype.onClickKeyFrame=function(e,t,i){var n=this.timeController.getKeyValue(t,i),r=this.timeController.getChannelTrackInfo(t),o=new KeyFrameData(r.interpolation,r.originalValue,t,n,i,this.timeController);EditorModule.inspect(new AnimationKeyFrame(o))},TimelineWidget.prototype.isNeedReCreate=function(){return this.isClose},TimelineWidget.prototype.onShow=function(){this.selectCurrent()},TimelineWidget.prototype.createWidgets=function(e,t){this.resource=t,this.timeController._clip=t.getData(),this.timeLiner=new Timeliner(e),this.timeLiner.appendToElement(this.root),this.timeLiner.load(this.timeController._clip),this.setTitle(t.filename),this.resize($("#project").width(),$("#project").height())},TimelineWidget.prototype.setTitle=function(e){this.timeLiner.setTitle(e)},TimelineWidget.prototype.onInsertKeyframeButton=function(e,t){var i=e.getAttribute("data-propertyuid").split("."),n=i[0],r=i[1],o=i[2],s=EditorModule.target.objectByUuid(n),a=null;a=s[r][o]instanceof TONG.Value?s[r][o].getValue():s[r][o],this.timeController&&0==this.timeController._trackInfo.length&&(this.target=s),this.insertChannel({root:s,value:a,uuid:n,title:r,property:o});var l=new Animation;l.file.setValue(this.resource),s.addComponent(l),EditorModule.target.execute(new AddComponentCommand(l._root,l))},TimelineWidget.prototype.insertChannel=function(e){var t=null,i=e.uuid,n=i+"."+e.title+"."+e.property,r=e.value,o=e.value;switch(e.root.isRegisterComponent(e.root[e.title])&&(n=i+"."+e.property),typeof e.value){case"number":t=TONG.NumberKeyframeTrack,r=[e.value];break;case"object":e.value instanceof TONG.Vector2?(t=TONG.VectorKeyframeTrack,r=e.value.toArray(),o=e.value.clone()):e.value instanceof TONG.Vector3?(t=TONG.VectorKeyframeTrack,r=e.value.toArray(),o=e.value.clone()):e.value instanceof TONG.Vector4?(t=TONG.VectorKeyframeTrack,r=e.value.toArray(),o=e.value.clone()):e.value instanceof TONG.Euler?(t=TONG.VectorKeyframeTrack,r=e.value.toArray(),o=e.value.clone()):e.value instanceof TONG.Quaternion?(t=TONG.QuaternionKeyframeTrack,r=e.value.toArray(),o=e.value.clone()):e.value instanceof TONG.Color?(t=TONG.ColorKeyframeTrack,r=e.value.toArray(),o=e.value.clone()):e.value instanceof TONG.Slider?(t=TONG.NumberKeyframeTrack,r=[e.value],(o=new TONG.Slider).fromArray(e.value.toArray())):e.value instanceof TONG.Pad&&(t=TONG.NumberKeyframeTrack,r=[e.value],(o=new TONG.Pad).fromArray(e.value.toArray()));break;case"string":t=TONG.StringKeyframeTrack,r=[e.value];break;case"boolean":t=TONG.BooleanKeyframeTrack,r=[e.value]}var s={type:t,propertyPath:n,initialValue:r,interpolation:TONG.InterpolateLinear,originalValue:o,root:e.root};this.timeController.insertChannel(s)},TimelineWidget.prototype.setAnimation=function(e){},TimelineWidget.prototype.selectCurrent=function(){for(var e in AnimationModule.tabs)if(AnimationModule.tabs[e].widget!=this)AnimationModule.tabs[e].widget.isSelect=!1;else{var t=AnimationModule.tabs[e].widget;t.isSelect=!0;for(var i=t.timeController._trackInfo,n=0;n<i.length;n++){var r=i[n],o=r.propertyPath.split("."),s=r.root;if(s){var a=null;2==o.length?a=s[o[1]]:3==o.length&&(a=s[o[1]][o[2]]),a instanceof TONG.Value&&(a=a.getValue()),"object"!=typeof r.originalValue?r.originalValue=a:r.originalValue instanceof TONG.Vector2?r.originalValue=a.clone():r.originalValue instanceof TONG.Vector3?r.originalValue=a.clone():r.originalValue instanceof TONG.Vector4?r.originalValue=a.clone():r.originalValue instanceof TONG.Euler?r.originalValue=a.clone():r.originalValue instanceof TONG.Quaternion?r.originalValue=a.clone():r.originalValue instanceof TONG.Color?r.originalValue=a.clone():r.originalValue instanceof TONG.Slider?(r.originalValue=new TONG.Slider,r.originalValue.fromArray(a.toArray())):r.originalValue instanceof TONG.Pad&&(r.originalValue=new TONG.Pad,r.originalValue.fromArray(a.toArray()))}}this.timeController._action&&(this.timeController._action.play(),this.timeController._mixer.update(0))}},TimelineWidget.prototype.applyOriginalValue=function(){var e=this.timeController._trackInfo;this.timeController._action&&this.timeController._action.stop();for(var t=0;t<e.length;t++){var i=e[t],n=i.propertyPath.split("."),r=i.root;2==n.length?r[n[1]].setValue?r[n[1]].setValue(i.originalValue):r[n[1]]=i.originalValue:r[n[1]][n[2]].setValue?r[n[1]][n[2]].setValue(i.originalValue):r[n[1]][n[2]]=i.originalValue}},TimelineWidget.prototype.onChange=function(){this.isSelect=!1,this.applyOriginalValue(),EditorModule.viewport.transformRender()},TimelineWidget.prototype.onClose=function(){this.isClose=!0,this.isSelect=!1,this.resource&&delete AnimationModule.tabs[this.resource.filename],this.applyOriginalValue(),EditorModule.viewport.transformRender()},TimelineWidget.prototype.resize=function(e,t){this.timeLiner&&(this.timeLiner.setBounds(this.timeLiner.pane,0,0,e,t),this.timeLiner.setBounds(this.timeLiner.ghostpane,0,0,e,t))},TimelineWidget.prototype.onResize=function(){this.resize($("#project").width(),$("#project").height())},TimelineWidget.widget_name=GetLanguage("Timeline"),CORE.registerWidget(TimelineWidget);var ProjectWidget={init:function(){var e=new UI.Panel;e.setId("project");var t=new UI.Panel;t.setId("content"),e.add(t),InterfaceModule.setVisorArea(t),document.body.appendChild(e.dom)}};CORE.registerModule(ProjectWidget);var ProjectToolBar=function(e){var t=new UI.Panel;t.setId("projectToolBar"),t.style("position:absolute;top:0px;height:30px;left:10px;width:600px;background-color:#222");var i=new UI.ButtonIcon("css/pic/hierarchy/hieIcon.png","#262626","8% 50%","ASSETS");i.setPosition("absolute"),i.setWidth("100px"),i.setHeight("30px"),i.dom.title="Assets",t.add(i);var n=new UI.ButtonIcon("css/pic/plus.png","#262626","50% 50%","");n.setId("addAssetsBtn"),n.setPosition("absolute"),n.setLeft("100px"),n.setWidth("30px"),n.setHeight("30px"),n.dom.title="Add",t.add(n),n.onClick(function(e){var t=$(n.dom).offset().top,i=$(n.dom).offset().left;$("#AddAssetsMenubar").css("left",i+30+"px"),$("#AddAssetsMenubar").css("top",t-100+"px"),$("#AddAssetsMenubar").css("display","")});var r=new UI.ButtonIcon("css/pic/crash.png","#262626","50% 50%","");r.setPosition("absolute"),r.setLeft("130px"),r.setWidth("30px"),r.setHeight("30px"),r.dom.title="Delete",t.add(r),r.onClick(function(e){Utils.DeleteAssets.Execute(e)});var o=new UI.ButtonIcon("css/pic/undo.png","#262626","50% 50%","");o.setPosition("absolute"),o.setLeft("160px"),o.setWidth("30px"),o.setHeight("30px"),o.dom.title="Folder Up",t.add(o),o.onClick(function(e){Utils.FolderUpAssets.Execute(e)});var s=new UI.ButtonIcon("css/pic/list.png","#262626","50% 50%","");s.setPosition("absolute"),s.setLeft("190px"),s.setWidth("30px"),s.setHeight("30px"),s.dom.title="List Size",Utils.OnClick(s,function(e,t){Utils.ListBtnCallBack.Execute(t)},!0),t.add(s);var a=new UI.Input("");a.setId("searchAssetsInput"),a.setPosition("absolute"),a.dom.placeholder=" Search",a.setLeft("220px"),a.setWidth("195px"),a.setHeight("30px"),a.setBackgroundColor("#202020"),a.setBackground("url('css/pic/search.png') right no-repeat"),a.dom.title="Search",Utils.OnStart.add(function(){$("#searchAssetsInput").bind("input propertychange",function(){var e=a.getValue();Utils.SearchAssets.Execute({value:e,target:a})})}),t.add(a);var l=(new UI.Select).setOptions({All:"All",Folder:"Folder",File:"File"});l.setPosition("absolute"),l.setLeft("425px"),l.setWidth("135px"),l.setHeight("30px"),l.dom.title="Classify",l.setValue("All"),l.setBackgroundColor("#262626"),l.onChange(function(e){Utils.ClassificationCallBack.Execute({target:e,classificationType:l.getValue()})}),t.add(l);var d=new UI.ButtonIcon("css/pic/library.png","#262626","50% 50%","");return d.setPosition("absolute"),d.setRight("0px"),d.setWidth("40px"),d.setHeight("30px"),d.dom.title="Library",t.add(d),t};Sidebar.Geometry=function(i){var e=i.signals,n=new UI.Panel;n.setBorderTop("0"),n.setPaddingTop("20px");var t=new UI.Row,r=new UI.Text;t.add(new UI.Text("Type").setWidth("90px")),t.add(r),n.add(t);var o=new UI.Row,s=(new UI.Input).setWidth("102px").setFontSize("12px").setDisabled(!0),a=new UI.Button("New").setMarginLeft("7px").onClick(function(){s.setValue(TONG.Math.generateUUID()),i.execute(new SetGeometryValueCommand(i.selected,"uuid",s.getValue()))});o.add(new UI.Text("UUID").setWidth("90px")),o.add(s),o.add(a),n.add(o);var l=new UI.Row,d=(new UI.Input).setWidth("150px").setFontSize("12px").onChange(function(){i.execute(new SetGeometryValueCommand(i.selected,"name",d.getValue()))});l.add(new UI.Text("Name").setWidth("90px")),l.add(d),n.add(l),n.add(new Sidebar.Geometry.Geometry(i)),n.add(new Sidebar.Geometry.BufferGeometry(i));var h=new UI.Span;function c(){var e=i.selected;if(e&&e.geometry){var t=e.geometry;n.setDisplay("block"),r.setValue(t.type),s.setValue(t.uuid),d.setValue(t.name),h.clear(),"BufferGeometry"===t.type||"Geometry"===t.type?h.add(new Sidebar.Geometry.Modifiers(i,e)):void 0!==Sidebar.Geometry[t.type]&&h.add(new Sidebar.Geometry[t.type](i,e))}else n.setDisplay("none")}return n.add(h),e.objectSelected.add(c),e.geometryChanged.add(c),n},Sidebar.Geometry.Geometry=function(e,t,i){e.signals;!function(e){if(null===e)return;if(void 0===e)return;var t=e.geometry;if(t instanceof TONG.Geometry)i.addString("Vertices",t.vertices.length.format()+""),i.addString("Faces",t.faces.length.format()+"")}(t)},Sidebar.Geometry.BufferGeometry=function(e,t,s){e.signals;!function(e){if(null===e)return;if(void 0===e)return;var t=e.geometry;if(t instanceof TONG.BufferGeometry){var i=t.index;null!==i&&s.addString("index",i.count.format()+"",{disabled:!0});var n=t.attributes;for(var r in n){var o=n[r];s.addString(""+r,o.count.format()+" ("+o.itemSize+")",{disabled:!0})}}}(t)},Sidebar.Geometry.Modifiers=function(e,t,i){var n=e.signals,r=t.geometry;i.addButton("","Compute Vertex Normals",{callback:function(){r.computeVertexNormals(),r instanceof TONG.BufferGeometry?r.attributes.normal.needsUpdate=!0:r.normalsNeedUpdate=!0,n.geometryChanged.dispatch(t)}})},Sidebar.Geometry.BoxGeometry=function(e,t,i){e.signals;var n=t.geometry,r=n.parameters,o=i.addNumber(GetLanguage("Width"),r.width,{callback:c}),s=i.addNumber(GetLanguage("Height"),r.height,{callback:c}),a=i.addNumber(GetLanguage("Depth"),r.depth,{callback:c}),l=i.addNumber(GetLanguage("WidthSegments"),r.widthSegments?r.widthSegments:1,{callback:c,precision:0,min:1}),d=i.addNumber(GetLanguage("HeightSegments"),r.heightSegments?r.heightSegments:1,{callback:c,precision:0,min:1}),h=i.addNumber(GetLanguage("DepthSegments"),r.depthSegments?r.depthSegments:1,{callback:c,precision:0,min:1});function c(){e.execute(new SetGeometryCommand(t,new TONG[n.type](o.getValue(),s.getValue(),a.getValue(),l.getValue(),d.getValue(),h.getValue())))}},Sidebar.Geometry.BoxBufferGeometry=Sidebar.Geometry.BoxGeometry,Sidebar.Geometry.CircleGeometry=function(e,t,i){e.signals;var n=t.geometry,r=n.parameters,o=i.addNumber(GetLanguage("Radius"),r.radius,{callback:d}),s=i.addNumber(GetLanguage("Segments"),r.segments,{min:3,callback:d}),a=i.addNumber(GetLanguage("ThetaStart"),r.thetaStart,{callback:d}),l=i.addNumber(GetLanguage("ThetaLength"),r.thetaLength,{callback:d});function d(){e.execute(new SetGeometryCommand(t,new TONG[n.type](o.getValue(),s.getValue(),a.getValue(),l.getValue())))}},Sidebar.Geometry.CircleBufferGeometry=Sidebar.Geometry.CircleGeometry,Sidebar.Geometry.CylinderGeometry=function(e,t,i){e.signals;var n=t.geometry,r=n.parameters,o=i.addNumber(GetLanguage("RadiusTop"),r.radiusTop,{callback:c}),s=i.addNumber(GetLanguage("RadiusBottom"),r.radiusBottom,{callback:c}),a=i.addNumber(GetLanguage("Height"),r.height,{callback:c}),l=i.addNumber(GetLanguage("RadialSegments"),r.radialSegments,{min:1,callback:c,precision:0}),d=i.addNumber(GetLanguage("HeightSegments"),r.heightSegments,{min:1,callback:c,precision:0}),h=i.addCheckbox(GetLanguage("OpenEnded"),r.openEnded,{callback:c});function c(){e.execute(new SetGeometryCommand(t,new TONG[n.type](o.getValue(),s.getValue(),a.getValue(),l.getValue(),d.getValue(),h.data)))}},Sidebar.Geometry.CylinderBufferGeometry=Sidebar.Geometry.CylinderGeometry,Sidebar.Geometry.IcosahedronGeometry=function(e,t,i){var n=e.signals,r=t.geometry,o=r.parameters,s=i.addNumber(GetLanguage("Radius"),o.radius,{callback:l}),a=i.addNumber(GetLanguage("Detail"),o.detail,{min:0,callback:l});function l(){e.execute(new SetGeometryCommand(t,new TONG[r.type](s.getValue(),a.getValue()))),n.objectChanged.dispatch(t)}},Sidebar.Geometry.IcosahedronBufferGeometry=Sidebar.Geometry.IcosahedronGeometry,Sidebar.Geometry.PlaneGeometry=function(e,t,i){e.signals;var n=t.geometry,r=n.parameters,o=i.addNumber(GetLanguage("Width"),r.width,{callback:d}),s=i.addNumber(GetLanguage("Height"),r.height,{callback:d}),a=i.addNumber(GetLanguage("WidthSegments"),r.widthSegments,{callback:d,precision:0,min:1}),l=i.addNumber(GetLanguage("HeightSegments"),r.heightSegments,{callback:d,min:1,precision:0});function d(){e.execute(new SetGeometryCommand(t,new TONG[n.type](o.getValue(),s.getValue(),a.getValue(),l.getValue())))}},Sidebar.Geometry.PlaneBufferGeometry=Sidebar.Geometry.PlaneGeometry,Sidebar.Geometry.SphereGeometry=function(e,t,i){e.signals;var n=t.geometry,r=n.parameters,o=i.addNumber(GetLanguage("Radius"),r.radius,{callback:u}),s=i.addNumber(GetLanguage("WidthSegments"),r.widthSegments,{callback:u,min:1,precision:0}),a=i.addNumber(GetLanguage("HeightSegments"),r.heightSegments,{callback:u,min:1,precision:0}),l=i.addNumber(GetLanguage("PhiStart"),r.phiStart,{callback:u}),d=i.addNumber(GetLanguage("PhiLength"),r.phiLength,{callback:u}),h=i.addNumber(GetLanguage("ThetaStart"),r.thetaStart,{callback:u}),c=i.addNumber(GetLanguage("ThetaLength"),r.thetaLength,{callback:u});function u(){e.execute(new SetGeometryCommand(t,new TONG[n.type](o.getValue(),s.getValue(),a.getValue(),l.getValue(),d.getValue(),h.getValue(),c.getValue())))}},Sidebar.Geometry.SphereBufferGeometry=Sidebar.Geometry.SphereGeometry,Sidebar.Geometry.TorusGeometry=function(e,t,i){e.signals;var n=t.geometry,r=n.parameters,o=i.addNumber(GetLanguage("Radius"),r.radius,{callback:h}),s=i.addNumber(GetLanguage("Tube"),r.tube,{callback:h}),a=i.addNumber(GetLanguage("RadialSegments"),r.radialSegments,{callback:h,min:1,precision:0}),l=i.addNumber(GetLanguage("TubularSegments"),r.tubularSegments,{callback:h,min:1,precision:0}),d=i.addNumber(GetLanguage("Arc"),r.arc,{callback:h});function h(){e.execute(new SetGeometryCommand(t,new TONG[n.type](o.getValue(),s.getValue(),a.getValue(),l.getValue(),d.getValue())))}},Sidebar.Geometry.TorusBufferGeometry=Sidebar.Geometry.TorusGeometry,Sidebar.Geometry.TorusKnotGeometry=function(e,t,i){e.signals;var n=t.geometry,r=n.parameters,o=i.addNumber(GetLanguage("Radius"),r.radius,{callback:c}),s=i.addNumber(GetLanguage("Tube"),r.tube,{callback:c}),a=i.addNumber(GetLanguage("TubularSegments"),r.tubularSegments,{callback:c,min:1,precision:0}),l=i.addNumber(GetLanguage("RadialSegments"),r.radialSegments,{callback:c,min:1,precision:0}),d=i.addNumber("P",r.p,{callback:c}),h=i.addNumber("Q",r.q,{callback:c});function c(){e.execute(new SetGeometryCommand(t,new TONG[n.type](o.getValue(),s.getValue(),a.getValue(),l.getValue(),d.getValue(),h.getValue())))}},Sidebar.Geometry.TorusKnotBufferGeometry=Sidebar.Geometry.TorusKnotGeometry,TONG.TeapotBufferGeometry=function(e,t,i,n,r,o,s){var a=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,3,16,17,18,7,19,20,21,11,22,23,24,15,25,26,27,18,28,29,30,21,31,32,33,24,34,35,36,27,37,38,39,30,40,41,0,33,42,43,4,36,44,45,8,39,46,47,12,12,13,14,15,48,49,50,51,52,53,54,55,56,57,58,59,15,25,26,27,51,60,61,62,55,63,64,65,59,66,67,68,27,37,38,39,62,69,70,71,65,72,73,74,68,75,76,77,39,46,47,12,71,78,79,48,74,80,81,52,77,82,83,56,56,57,58,59,84,85,86,87,88,89,90,91,92,93,94,95,59,66,67,68,87,96,97,98,91,99,100,101,95,102,103,104,68,75,76,77,98,105,106,107,101,108,109,110,104,111,112,113,77,82,83,56,107,114,115,84,110,116,117,88,113,118,119,92,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,123,136,137,120,127,138,139,124,131,140,141,128,135,142,143,132,132,133,134,135,144,145,146,147,148,149,150,151,68,152,153,154,135,142,143,132,147,155,156,144,151,157,158,148,154,159,160,68,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,164,177,178,161,168,179,180,165,172,181,182,169,176,183,184,173,173,174,175,176,185,186,187,188,189,190,191,192,193,194,195,196,176,183,184,173,188,197,198,185,192,199,200,189,196,201,202,193,203,203,203,203,204,205,206,207,208,208,208,208,209,210,211,212,203,203,203,203,207,213,214,215,208,208,208,208,212,216,217,218,203,203,203,203,215,219,220,221,208,208,208,208,218,222,223,224,203,203,203,203,221,225,226,204,208,208,208,208,224,227,228,209,209,210,211,212,229,230,231,232,233,234,235,236,237,238,239,240,212,216,217,218,232,241,242,243,236,244,245,246,240,247,248,249,218,222,223,224,243,250,251,252,246,253,254,255,249,256,257,258,224,227,228,209,252,259,260,229,255,261,262,233,258,263,264,237,265,265,265,265,266,267,268,269,270,271,272,273,92,119,118,113,265,265,265,265,269,274,275,276,273,277,278,279,113,112,111,104,265,265,265,265,276,280,281,282,279,283,284,285,104,103,102,95,265,265,265,265,282,286,287,266,285,288,289,270,95,94,93,92],l=[1.4,0,2.4,1.4,-.784,2.4,.784,-1.4,2.4,0,-1.4,2.4,1.3375,0,2.53125,1.3375,-.749,2.53125,.749,-1.3375,2.53125,0,-1.3375,2.53125,1.4375,0,2.53125,1.4375,-.805,2.53125,.805,-1.4375,2.53125,0,-1.4375,2.53125,1.5,0,2.4,1.5,-.84,2.4,.84,-1.5,2.4,0,-1.5,2.4,-.784,-1.4,2.4,-1.4,-.784,2.4,-1.4,0,2.4,-.749,-1.3375,2.53125,-1.3375,-.749,2.53125,-1.3375,0,2.53125,-.805,-1.4375,2.53125,-1.4375,-.805,2.53125,-1.4375,0,2.53125,-.84,-1.5,2.4,-1.5,-.84,2.4,-1.5,0,2.4,-1.4,.784,2.4,-.784,1.4,2.4,0,1.4,2.4,-1.3375,.749,2.53125,-.749,1.3375,2.53125,0,1.3375,2.53125,-1.4375,.805,2.53125,-.805,1.4375,2.53125,0,1.4375,2.53125,-1.5,.84,2.4,-.84,1.5,2.4,0,1.5,2.4,.784,1.4,2.4,1.4,.784,2.4,.749,1.3375,2.53125,1.3375,.749,2.53125,.805,1.4375,2.53125,1.4375,.805,2.53125,.84,1.5,2.4,1.5,.84,2.4,1.75,0,1.875,1.75,-.98,1.875,.98,-1.75,1.875,0,-1.75,1.875,2,0,1.35,2,-1.12,1.35,1.12,-2,1.35,0,-2,1.35,2,0,.9,2,-1.12,.9,1.12,-2,.9,0,-2,.9,-.98,-1.75,1.875,-1.75,-.98,1.875,-1.75,0,1.875,-1.12,-2,1.35,-2,-1.12,1.35,-2,0,1.35,-1.12,-2,.9,-2,-1.12,.9,-2,0,.9,-1.75,.98,1.875,-.98,1.75,1.875,0,1.75,1.875,-2,1.12,1.35,-1.12,2,1.35,0,2,1.35,-2,1.12,.9,-1.12,2,.9,0,2,.9,.98,1.75,1.875,1.75,.98,1.875,1.12,2,1.35,2,1.12,1.35,1.12,2,.9,2,1.12,.9,2,0,.45,2,-1.12,.45,1.12,-2,.45,0,-2,.45,1.5,0,.225,1.5,-.84,.225,.84,-1.5,.225,0,-1.5,.225,1.5,0,.15,1.5,-.84,.15,.84,-1.5,.15,0,-1.5,.15,-1.12,-2,.45,-2,-1.12,.45,-2,0,.45,-.84,-1.5,.225,-1.5,-.84,.225,-1.5,0,.225,-.84,-1.5,.15,-1.5,-.84,.15,-1.5,0,.15,-2,1.12,.45,-1.12,2,.45,0,2,.45,-1.5,.84,.225,-.84,1.5,.225,0,1.5,.225,-1.5,.84,.15,-.84,1.5,.15,0,1.5,.15,1.12,2,.45,2,1.12,.45,.84,1.5,.225,1.5,.84,.225,.84,1.5,.15,1.5,.84,.15,-1.6,0,2.025,-1.6,-.3,2.025,-1.5,-.3,2.25,-1.5,0,2.25,-2.3,0,2.025,-2.3,-.3,2.025,-2.5,-.3,2.25,-2.5,0,2.25,-2.7,0,2.025,-2.7,-.3,2.025,-3,-.3,2.25,-3,0,2.25,-2.7,0,1.8,-2.7,-.3,1.8,-3,-.3,1.8,-3,0,1.8,-1.5,.3,2.25,-1.6,.3,2.025,-2.5,.3,2.25,-2.3,.3,2.025,-3,.3,2.25,-2.7,.3,2.025,-3,.3,1.8,-2.7,.3,1.8,-2.7,0,1.575,-2.7,-.3,1.575,-3,-.3,1.35,-3,0,1.35,-2.5,0,1.125,-2.5,-.3,1.125,-2.65,-.3,.9375,-2.65,0,.9375,-2,-.3,.9,-1.9,-.3,.6,-1.9,0,.6,-3,.3,1.35,-2.7,.3,1.575,-2.65,.3,.9375,-2.5,.3,1.125,-1.9,.3,.6,-2,.3,.9,1.7,0,1.425,1.7,-.66,1.425,1.7,-.66,.6,1.7,0,.6,2.6,0,1.425,2.6,-.66,1.425,3.1,-.66,.825,3.1,0,.825,2.3,0,2.1,2.3,-.25,2.1,2.4,-.25,2.025,2.4,0,2.025,2.7,0,2.4,2.7,-.25,2.4,3.3,-.25,2.4,3.3,0,2.4,1.7,.66,.6,1.7,.66,1.425,3.1,.66,.825,2.6,.66,1.425,2.4,.25,2.025,2.3,.25,2.1,3.3,.25,2.4,2.7,.25,2.4,2.8,0,2.475,2.8,-.25,2.475,3.525,-.25,2.49375,3.525,0,2.49375,2.9,0,2.475,2.9,-.15,2.475,3.45,-.15,2.5125,3.45,0,2.5125,2.8,0,2.4,2.8,-.15,2.4,3.2,-.15,2.4,3.2,0,2.4,3.525,.25,2.49375,2.8,.25,2.475,3.45,.15,2.5125,2.9,.15,2.475,3.2,.15,2.4,2.8,.15,2.4,0,0,3.15,.8,0,3.15,.8,-.45,3.15,.45,-.8,3.15,0,-.8,3.15,0,0,2.85,.2,0,2.7,.2,-.112,2.7,.112,-.2,2.7,0,-.2,2.7,-.45,-.8,3.15,-.8,-.45,3.15,-.8,0,3.15,-.112,-.2,2.7,-.2,-.112,2.7,-.2,0,2.7,-.8,.45,3.15,-.45,.8,3.15,0,.8,3.15,-.2,.112,2.7,-.112,.2,2.7,0,.2,2.7,.45,.8,3.15,.8,.45,3.15,.112,.2,2.7,.2,.112,2.7,.4,0,2.55,.4,-.224,2.55,.224,-.4,2.55,0,-.4,2.55,1.3,0,2.55,1.3,-.728,2.55,.728,-1.3,2.55,0,-1.3,2.55,1.3,0,2.4,1.3,-.728,2.4,.728,-1.3,2.4,0,-1.3,2.4,-.224,-.4,2.55,-.4,-.224,2.55,-.4,0,2.55,-.728,-1.3,2.55,-1.3,-.728,2.55,-1.3,0,2.55,-.728,-1.3,2.4,-1.3,-.728,2.4,-1.3,0,2.4,-.4,.224,2.55,-.224,.4,2.55,0,.4,2.55,-1.3,.728,2.55,-.728,1.3,2.55,0,1.3,2.55,-1.3,.728,2.4,-.728,1.3,2.4,0,1.3,2.4,.224,.4,2.55,.4,.224,2.55,.728,1.3,2.55,1.3,.728,2.55,.728,1.3,2.4,1.3,.728,2.4,0,0,0,1.425,0,0,1.425,.798,0,.798,1.425,0,0,1.425,0,1.5,0,.075,1.5,.84,.075,.84,1.5,.075,0,1.5,.075,-.798,1.425,0,-1.425,.798,0,-1.425,0,0,-.84,1.5,.075,-1.5,.84,.075,-1.5,0,.075,-1.425,-.798,0,-.798,-1.425,0,0,-1.425,0,-1.5,-.84,.075,-.84,-1.5,.075,0,-1.5,.075,.798,-1.425,0,1.425,-.798,0,.84,-1.5,.075,1.5,-.84,.075];TONG.BufferGeometry.call(this),this.type="TeapotBufferGeometry",this.parameters={size:e,segments:t,bottom:i,lid:n,body:r,fitLid:o,blinn:s},e=e||50,t=void 0!==t?Math.max(2,Math.floor(t)||10):10,o=void 0===o||o;var d=3.15*((s=void 0===s||s)?1:1.3)/2,h=e/d,c=(i=void 0===i||i)?(8*t-4)*t:0;c+=(n=void 0===n||n)?(16*t-4)*t:0,c+=(r=void 0===r||r)?40*t*t:0;var u=new Uint32Array(3*c),f=i?4:0;f+=n?8:0,f+=r?20:0,f*=(t+1)*(t+1);var g=new Float32Array(3*f),p=new Float32Array(3*f),m=new Float32Array(2*f),y=new TONG.Matrix4;y.set(-1,3,-3,1,3,-6,3,0,-3,3,0,0,1,0,0,0);var v,w,b,T,C,O,G,N,S,I,E,x,L,A,R,M,U=[],P=[],k=[],B=[],V=[],F=[],_=[],j=[],D=[],z=new TONG.Vector3,W=0,H=0,K=new TONG.Vector3,Z=new TONG.Matrix4,J=new TONG.Matrix4,$=new TONG.Vector4,q=new TONG.Vector4,X=new TONG.Vector4,Y=new TONG.Vector4,Q=new TONG.Vector3,ee=new TONG.Vector3,te=y.clone();te.transpose();var ie=function(e,t,i){return!(g[3*e]===g[3*t]&&g[3*e+1]===g[3*t+1]&&g[3*e+2]===g[3*t+2]||g[3*e]===g[3*i]&&g[3*e+1]===g[3*i+1]&&g[3*e+2]===g[3*i+2]||g[3*t]===g[3*i]&&g[3*t+1]===g[3*i+1]&&g[3*t+2]===g[3*i+2])};for(v=0;v<3;v++)F[v]=new TONG.Matrix4;var ne=i?32:28;G=t+1;for(var re=0,oe=0,se=0,ae=0,le=0,de=r?0:20;de<ne;de++)if(n||de<20||28<=de){for(v=0;v<3;v++){for(w=0;w<4;w++)for(b=0;b<4;b++)U[4*b+w]=l[3*a[16*de+4*w+b]+v],o&&20<=de&&de<28&&2!==v&&(U[4*b+w]*=1.077),s||2!==v||(U[4*b+w]*=1.3);Z.set(U[0],U[1],U[2],U[3],U[4],U[5],U[6],U[7],U[8],U[9],U[10],U[11],U[12],U[13],U[14],U[15]),J.multiplyMatrices(Z,y),F[v].multiplyMatrices(te,J)}for(C=0;C<=t;C++)for(N=C/t,O=0;O<=t;O++){for(S=O/t,x=4,I=E=1;x--;)P[x]=I,k[x]=E,I*=N,E*=S,3===x?(B[x]=V[x]=0,W=H=1):(B[x]=W*(3-x),V[x]=H*(3-x),W*=N,H*=S);for($.fromArray(P),q.fromArray(k),X.fromArray(B),Y.fromArray(V),v=0;v<3;v++)(T=$.clone()).applyMatrix4(F[v]),_[v]=T.dot(q),(T=X.clone()).applyMatrix4(F[v]),j[v]=T.dot(q),(T=$.clone()).applyMatrix4(F[v]),D[v]=T.dot(Y);Q.fromArray(j),ee.fromArray(D),z.crossVectors(ee,Q),z.normalize(),0===_[0]&&0===_[1]?K.set(0,_[2]>d?1:-1,0):K.set(z.x,z.z,-z.y),g[oe++]=h*_[0],g[oe++]=h*(_[2]-d),g[oe++]=-h*_[1],p[se++]=K.x,p[se++]=K.y,p[se++]=K.z,m[ae++]=1-S,m[ae++]=1-N}for(C=0;C<t;C++)for(O=0;O<t;O++)M=(L=re*G*G+C*G+O)+G,ie(L,A=L+1,R=A+G)&&(u[le++]=L,u[le++]=A,u[le++]=R),ie(L,R,M)&&(u[le++]=L,u[le++]=R,u[le++]=M);re++}this.setIndex(new TONG.BufferAttribute(u,1)),this.addAttribute("position",new TONG.BufferAttribute(g,3)),this.addAttribute("normal",new TONG.BufferAttribute(p,3)),this.addAttribute("uv",new TONG.BufferAttribute(m,2)),this.computeBoundingSphere()},TONG.TeapotBufferGeometry.prototype=Object.create(TONG.BufferGeometry.prototype),TONG.TeapotBufferGeometry.prototype.constructor=TONG.TeapotBufferGeometry,TONG.TeapotBufferGeometry.prototype.clone=function(){return new TONG.TeapotBufferGeometry(this.parameters.size,this.parameters.segments,this.parameters.bottom,this.parameters.lid,this.parameters.body,this.parameters.fitLid,this.parameters.blinn)},Sidebar.Geometry.TeapotBufferGeometry=function(e,t,i){var n=new UI.Row,r=t.geometry.parameters,o=i.addNumber("Size",r.size,{callback:u}),s=i.addNumber("Segments",r.segments,{callback:u,min:1,precision:0}),a=i.addCheckbox("Bottom",r.bottom,{callback:u}),l=i.addCheckbox("Lid",r.segments,{callback:u}),d=i.addCheckbox("Body",r.body,{callback:u}),h=i.addCheckbox("Fitted Lid",r.fitLid,{callback:u}),c=i.addCheckbox("Blinn-scaled",r.blinn,{callback:u});function u(){t.geometry.dispose(),t.geometry=new TONG.TeapotBufferGeometry(o.getValue(),s.getValue(),a.getValue(),l.getValue(),d.getValue(),h.getValue(),c.getValue()),t.geometry.computeBoundingSphere(),e.signals.geometryChanged.dispatch(t)}return n},Sidebar.Geometry.LatheGeometry=function(r,o,e){r.signals;var t=new UI.Row,i=e.addContainer(),s=o.geometry,n=s.parameters,a=e.addNumber(GetLanguage("Segments"),n.segments,{callback:w,precision:0}),l=e.addNumber(GetLanguage("PhiStart")+"(°)",180*n.phiStart/Math.PI,{callback:w}),d=e.addNumber(GetLanguage("PhiLength")+"(°)",180*n.phiLength/Math.PI,{callback:w});i.appendChild(t.dom);var h=0,c=[],u=new UI.Row;u.add(new UI.Text(GetLanguage("Points")).setFontSize("0.8em"));var f=(new UI.Span).setDisplay("inline-block");u.add(f);var g=new UI.Div;f.add(g);for(var p=0;p<n.points.length;p++){var m=n.points[p];g.add(v(m.x,m.y))}var y=new UI.Button("+").onClick(function(){if(0===c.length)g.add(v(0,0));else{var e=c[c.length-1];g.add(v(e.x.getValue(),e.y.getValue()))}w()});function v(e,t){var i=new UI.Div,n=new UI.Text(h+1).setWidth("20px"),r=new UI.Number(e).setRange(0,1/0).setWidth("40px").onChange(w),o=new UI.Number(t).setWidth("40px").onChange(w),s=h,a=new UI.Button("-").onClick(function(){!function(e){if(!c[e])return;g.remove(c[e].row),c[e]=null,w()}(s)});return c.push({row:i,lbl:n,x:r,y:o}),h++,i.add(n,r,o,a),i}function w(){for(var e=[],t=0,i=0;i<c.length;i++){var n=c[i];n&&(e.push(new TONG.Vector2(n.x.getValue(),n.y.getValue())),t++,n.lbl.setValue(t))}r.execute(new SetGeometryCommand(o,new TONG[s.type](e,a.getValue(),l.getValue()/180*Math.PI,d.getValue()/180*Math.PI)))}f.add(y),t.add(u)},Sidebar.Geometry.LatheBufferGeometry=Sidebar.Geometry.LatheGeometry,Sidebar.History=function(n){var r=n.signals,o=n.config,a=n.history,e=new UI.Panel;e.add(new UI.Text("History"));var t=new UI.TONG.Boolean(o.getKey("settings/history"),"persistent");t.setPosition("absolute").setRight("8px"),t.onChange(function(){var e=this.getValue();if(o.setKey("settings/history",e),e){alert("The history will be preserved across sessions.\nThis can have an impact on performance when working with textures.");var t=a.undos[a.undos.length-1],i=void 0!==t?t.id:0;n.history.enableSerialization(i)}else r.historyChanged.dispatch()}),e.add(t),e.add(new UI.Break,new UI.Break);var i=new UI.Outliner(n);i.onChange(function(){!0,n.history.goToState(parseInt(i.getValue())),!1}),e.add(i);var s=function(){var o=[];function s(e){var t=document.createElement("div");return t.value=e.id,t}!function(e){for(var t=0,i=e.length;t<i;t++){var n=e[t],r=s(n);r.innerHTML="&nbsp;"+n.name,o.push(r)}}(a.undos),function(e,t){for(var i=e.length-1;0<=i;i--){var n=e[i],r=s(n);r.innerHTML="&nbsp;"+n.name,r.style.opacity=.3,o.push(r)}}(a.redos),i.setOptions(o)};return s(),r.editorCleared.add(s),r.historyChanged.add(s),r.historyChanged.add(function(e){i.setValue(void 0!==e?e.id:null)}),e},Sidebar.Hierarchy=function(n){var e=new UI.Panel;e.setId("hierarchy"),(new UI.Panel).setClass("resizePanel");var t=new UI.Row;t.setId("hierarchyHeader"),t.position="relative",t.setPaddingRight("10px"),t.setHeight("33px"),t.setBackgroundColor("#262626"),e.add(t);var i=new UI.Row;i.position="relative",i.setPaddingTop("6.5px"),i.setPaddingLeft("14px"),i.setPaddingRight("0px"),i.setId("hierarchyHeaderContent"),t.add(i);var r=new UI.Button(GetLanguage("HIERARCHY"));r.setId("hieIcon"),r.dom.style.fontSize="90%",i.add(r);var o=new UI.Button("");o.setId("addEntityBtn"),o.dom.title=GetLanguage("Add"),i.add(o);var s=null;Utils.OnStart.add(function(){(s=new Menubar.Add(n,!0)).setId("AddEntityMenubar"),s.setPosition("absolute"),s.setTop("0px"),s.setDisplay("none"),document.body.appendChild(s.dom)}),o.onClick(function(e){s.setDisplay("");var t=Utils.GetElementOffset(o.dom);s.dom.style.left=t.left+"px"}),$(document).on("mousedown",function(e){var t=$("#addEntityBtn").css("display");"addEntityBtn"!=e.target.id&&"AddEntityMenubar"!=e.target.id&&"none"!=t&&$("#AddEntityMenubar").css("display","none")});var a=new UI.Button("");a.setId("duplicate"),a.dom.title=GetLanguage("Duplicate"),i.add(a),a.onClick(function(e){var t=n.selected;if(null!==t.parent){var i=t.clone();n.execute(new AddObjectCommand(i))}});var l=new UI.Button("");l.setId("deleteEntity"),l.dom.title=GetLanguage("Delete"),i.add(l),l.onClick(function(e){var t=n.selected;null!==t.parent&&n.execute(new RemoveObjectCommand(t))});var d=new SceneTreeWidget(n.scene,{id:"sidepanel-inspector"}).root;return e.dom.appendChild(d),e};var Toolbar=function(i){var n=i.signals,e=new UI.Panel;e.setId("toolbar");var t=new UI.Panel;t.setId("toolbarContent"),e.add(t);var r=new UI.Panel;t.add(r);var o=new UI.Button("");o.setId("MenuBtn"),o.setLeft("0px"),o.dom.title=GetLanguage("Menu"),r.add(o),o.onClick(function(e){EditorModule.mainmenu.showMenu(EditorModule.mainmenu.menu[0],e,o.dom)});var s=new UI.Button("");function a(){n.transformModeChanged.dispatch("translate")}s.dom.title=GetLanguage("Translate"),s.setId("translate"),Utils.OnStart.add(a),s.onClick(a),r.add(s);var l=new UI.Button("");l.setId("rotation"),l.dom.title=GetLanguage("Rotation"),l.onClick(function(){n.transformModeChanged.dispatch("rotate")}),r.add(l);var d=new UI.Button("");d.setId("scale"),d.dom.title=GetLanguage("Scale"),d.onClick(function(){n.transformModeChanged.dispatch("scale")}),r.add(d),n.transformModeChanged.add(function(e){switch(s.dom.classList.remove("selected"),l.dom.classList.remove("selected"),d.dom.classList.remove("selected"),e){case"translate":s.dom.classList.add("selected");break;case"rotate":l.dom.classList.add("selected");break;case"scale":d.dom.classList.add("selected")}});var h=new UI.Button("");h.setId("worldBtn"),h.dom.title=GetLanguage("Local"),r.add(h);var c=!1;Utils.OnClick(h,function(e,t){c=t,h.dom.title=t?GetLanguage("World"):GetLanguage("Local"),O()},!0,!1,"#303030");var u=new UI.Button("");u.setId("snapBtn"),u.dom.title=GetLanguage("Snap"),r.add(u);var f=!1;Utils.OnClick(u,function(e,t){f=t,O()},!0,!1,"#303030");var g=new UI.Number(5).setWidth("40px").onChange(O),p=new UI.Button("");p.setId("showGridBtn"),p.dom.title=GetLanguage("Grid"),r.add(p);var m=!1;function y(e,t){null==t?(m=!0,p.dom.classList.add("selected")):m=t,O()}Utils.OnStart.add(y),Utils.OnClick(p,y,!0,!0,"#303030");var v=new UI.Button("");v.setId("focusBtn"),v.dom.title=GetLanguage("Focus"),r.add(v),Utils.OnClick(v,function(e,t){i.focus(i.selected)});var w=new UI.Button("");w.setId("undoBtn"),w.dom.title=GetLanguage("Undo"),r.add(w),Utils.OnClick(w,function(e,t){i.undo()});var b=new UI.Button("");b.setId("redoBtn"),b.dom.title=GetLanguage("Redo"),r.add(b),Utils.OnClick(b,function(e,t){i.redo()});var T=new UI.ButtonIcon("css/pic/Fullscreen.png","#303030","50% 50%","");T.setId("fullScreenBtn"),T.setHeight("40px"),T.setWidth("40px"),T.dom.title=GetLanguage("Full Screen"),r.add(T),Utils.OnClick(T,function(e,t){Utils.FullScreen(t,i)},!0);var C=new UI.ButtonIcon("css/pic/play.png","#303030","50% 50%","");function O(){n.snapChanged.dispatch(!0===f?g.getValue():null),n.spaceChanged.dispatch(!0==!c?"local":"world"),n.showGridChanged.dispatch(m)}return C.setId("playGameBtn"),C.setHeight("40px"),C.setWidth("40px"),C.dom.title=GetLanguage("Play"),r.add(C),Utils.OnClick(C,function(e,t){t?(i.toJSON(),C.dom.title=GetLanguage("Stop"),n.startPlayer.dispatch()):(C.dom.title=GetLanguage("Play"),n.stopPlayer.dispatch())},!0),Utils.OnStart.add(function(){$("#projectNameBtn").each(function(){10<$(this).text().length&&($(this).text($(this).text().substring(0,10)),$(this).html($(this).html()+"…"))}),$("#settingsNameBtn").each(function(){8<$(this).text().length&&($(this).text($(this).text().substring(0,8)),$(this).html($(this).html()+"…"))})}),O(),e},Viewport=function(d){var r=d.signals,o=this.container=new UI.Panel;o.setId("viewport"),o.setPosition("absolute"),this.size=new TONG.Vector2(100,100),this.rendererCanvas=new RendererCanvas(o.dom,this.size);var h=d.camera,c=d.scene,e=new TONG.Sky;c.add(e);var u=d.sceneHelpers,t=new TONG.AxesHelper(5);u.add(t);var f=d.outlineScene;this.orientation=new TONG.Vector2,this.camera=h,this.isInit=!1,this.keyboard=new Keyboard,this.mouseObj=new Mouse,this.canvas=this.rendererCanvas.canvas,Mouse.setCanvas(this.canvas),d.renderer=this.renderer=this.rendererCanvas.renderer,this.orientationCube=d.orientation,this.resetCanvas();var s=[],g=this;this.controls=null,this.setCameraMode(Settings.PERSPECTIVE),this.updateCameraControls(Settings.FIRST_PERSON),h=this.camera;var i,p=this.controls;if(h.far=2e6,!0===WEBVR.isAvailable()){var n=new TONG.PerspectiveCamera;n.projectionMatrix=h.projectionMatrix,h.add(n)}var a=new GridHelper(500,5,8947848);u.add(a);new TONG.Box3;var l=new TONG.MeshBasicMaterial({side:TONG.FrontSide,transparent:!0,opacity:0}),m=new TONG.Mesh;m.material=l,f.add(m);var y=null,v=null,w=null,b=new TONG.TransformControls(h,o.dom);Utils.SetTransformControl(b);var T=function(e,t){var i=new TONG.Vector3;i.setFromMatrixPosition(t.matrixWorld);var n=new TONG.Quaternion;t.getWorldQuaternion(n);var r=new TONG.Vector3;t.getWorldScale(r),e.position.set(i.x,i.y,i.z),e.quaternion.copy(n),e.scale.set(r.x,r.y,r.z)};b.addEventListener("change",function(){g.transformRender(!0)}),this.transformRender=function(e){var t=b.object;void 0!==t&&(void 0!==d.helpers[t.id]&&(d.helpers[t.id].update(),"SkinnedMesh"!=t.type&&d.iconHelpers[t.id].update()),e?r.refreshSidebarObject3D.dispatch(t,b.getMode()):b.update(),t instanceof TONG.Mesh&&T(m,t)),g.render()},b.addEventListener("mouseDown",function(){var e=b.object;y=e.position.clone(),v=e.rotation.clone(),w=e.scale.clone(),p.enabled=!1}),b.addEventListener("mouseUp",function(){var e=b.object;if(void 0!==e)switch(b.getMode()){case"translate":y.equals(e.position)||d.execute(new SetPositionCommand(e,e.position,y));break;case"rotate":v.equals(e.rotation)||d.execute(new SetRotationCommand(e,e.rotation,v));break;case"scale":w.equals(e.scale)||d.execute(new SetScaleCommand(e,e.scale,w))}p.enabled=!0}),u.add(b);var C=new TONG.Raycaster,O=new TONG.Vector2;function G(e,t){return O.set(2*e.x-1,-2*e.y+1),C.setFromCamera(O,h),C.intersectObjects(t)}var N=new TONG.Vector2,S=new TONG.Vector2,I=new TONG.Vector2;function E(e,t,i){var n=e.getBoundingClientRect();return[(t-n.left)/n.width,(i-n.top)/n.height]}function x(){if(0===N.distanceTo(S)){var e=G(S,s);if(0<e.length){var t=e[0].object;void 0!==t.userData.object?(EditorModule.target.selected!=t.userData.object&&ResourcesPanelWidget.Deselect(),d.select(t.userData.object)):(EditorModule.target.selected!=t&&ResourcesPanelWidget.Deselect(),d.select(t))}else ResourcesPanelWidget.Deselect(),d.select(null);g.render()}}function L(e){var t=E(o.dom,e.clientX,e.clientY);S.fromArray(t),x(),document.removeEventListener("mouseup",L,!1)}function A(e){var t=e.changedTouches[0],i=E(o.dom,t.clientX,t.clientY);S.fromArray(i),x(),document.removeEventListener("touchend",A,!1)}function R(){for(var i=0,n=0,r=0,e=0,t=c.children.length;e<t;e++){c.children[e].traverseVisible(function(e){if(i++,e instanceof TONG.Mesh&&"Sky"!=e.type){var t=e.geometry;t instanceof TONG.Geometry?(n+=t.vertices.length,r+=t.faces.length):t instanceof TONG.BufferGeometry&&(null!==t.index?(n+=3*t.index.count,r+=t.index.count):(n+=t.attributes.position.count,r+=t.attributes.position.count/3))}})}ProfilingPanelWidget.vertices=n,ProfilingPanelWidget.objects=i,ProfilingPanelWidget.faces=r}o.dom.addEventListener("mousedown",function(e){e.preventDefault();var t=E(o.dom,e.clientX,e.clientY);N.fromArray(t),document.addEventListener("mouseup",L,!1)},!1),o.dom.addEventListener("touchstart",function(e){var t=e.changedTouches[0],i=E(o.dom,t.clientX,t.clientY);N.fromArray(i),document.addEventListener("touchend",A,!1)},!1),o.dom.addEventListener("dblclick",function(e){var t=E(o.dom,e.clientX,e.clientY);I.fromArray(t);var i=G(I,s);if(0<i.length){var n=i[0];r.objectFocused.dispatch(n.object)}},!1),p.addEventListener("change",function(){b.update(),r.cameraChanged.dispatch(h),r.sceneGraphChanged.dispatch()}),r.editorCleared.add(function(){p.center.set(0,0,0),g.render()}),r.enterVR.add(function(){i.isPresenting?i.exitPresent():i.requestPresent()}),r.themeChanged.add(function(e){switch(e){case"css/light.css":case"css/dark.css":u.remove(a),a=new GridHelper(500,5,8947848),u.add(a)}g.render()}),r.transformModeChanged.add(function(e){b.setMode(e)}),r.snapChanged.add(function(e){b.setTranslationSnap(e)}),r.spaceChanged.add(function(e){b.setSpace(e)}),r.sceneInitFinish.add(function(){g.outlineRenderer=new TONG.WebGLRenderer,g.outlineRenderer.shadowMap.enabled=!0,g.outlineRenderer.setSize(o.dom.offsetWidth,o.dom.offsetHeight),g.outlineRenderer.domElement.style.position="absolute",g.outlineRenderer.domElement.style.top="0",g.outlineRenderer.domElement.style.pointerEvents="none",g.outlineRenderer.domElement.style.setProperty("mix-blend-mode","screen"),g.renderer.domElement.parentNode.appendChild(g.outlineRenderer.domElement),g.composer=new TONG.EffectComposer(g.outlineRenderer);var e=new TONG.RenderPass(f,h);g.composer.addPass(e),g.outlinePass=new TONG.OutlinePass(new TONG.Vector2(o.dom.offsetWidth,o.dom.offsetHeight),f,h),g.composer.addPass(g.outlinePass),g.effectFXAA=new TONG.ShaderPass(TONG.FXAAShader),g.effectFXAA.uniforms.resolution.value.set(1/o.dom.offsetWidth,1/o.dom.offsetHeight),g.effectFXAA.renderToScreen=!0,g.composer.addPass(g.effectFXAA),g.isInit=!0}),r.rendererChanged.add(function(e){null!==g.renderer&&g.rendererCanvas.element.removeChild(g.renderer.domElement),d.renderer=g.renderer=g.rendererCanvas.renderer=e,g.rendererCanvas.renderer.autoClear=!1,g.rendererCanvas.renderer.autoUpdateScene=!1,g.rendererCanvas.renderer.setPixelRatio(window.devicePixelRatio),g.rendererCanvas.renderer.setSize(o.dom.offsetWidth,o.dom.offsetHeight),g.rendererCanvas.element.appendChild(g.rendererCanvas.renderer.domElement),g.canvas=g.rendererCanvas.renderer.domElement,g.resizeCanvas(),!0===WEBVR.isAvailable()&&(new TONG.VRControls(n),i=new TONG.VREffect(g.renderer),window.addEventListener("vrdisplaypresentchange",function(e){effect.isPresenting?r.enteredVR.dispatch():r.exitedVR.dispatch()},!1)),g.render()}),r.sceneGraphChanged.add(function(){g.render()}),r.cameraChanged.add(function(){g.render()}),r.objectSelected.add(function(e){m&&f.remove(m),b.detach(),g.outlinePass.selectedObjects=[],null!==e&&e!==c&&e!==h&&(e instanceof TONG.Mesh&&"LensFlare"!=e.type&&(e instanceof SkinnedMesh||(m=e.clone(),T(m,e),f.add(m),g.outlinePass.selectedObjects=[m])),b.attach(e)),g.render()}),r.objectFocused.add(function(e){p.focusObject(e),d.select(null)}),r.geometryChanged.add(function(e){void 0!==e&&(m.geometry=e.geometry,T(m,e)),g.render(),R()}),r.objectAdded.add(function(e){e.traverse(function(e){s.push(e)}),R()}),r.objectChanged.add(function(e){d.selected===e&&(e instanceof TONG.Mesh&&T(m,e),b.update()),(e instanceof TONG.PerspectiveCamera||e instanceof PerspectiveCamera)&&e.updateProjectionMatrix(),void 0!==d.helpers[e.id]&&d.helpers[e.id].update(),g.render()}),r.objectRemoved.add(function(e){e.traverse(function(e){s.splice(s.indexOf(e),1)}),R()}),r.helperAdded.add(function(e){s.push(e.getObjectByName("picker"))}),r.helperRemoved.add(function(e){s.splice(s.indexOf(e.getObjectByName("picker")),1)}),r.materialChanged.add(function(e){g.render()}),r.sceneBackgroundChanged.add(function(e){c.background.setHex(e),g.render()});var M=null;r.sceneFogChanged.add(function(e,t,i,n,r){if(M!==e){switch(e){case"None":c.fog=null;break;case"Fog":c.fog=new TONG.Fog;break;case"FogExp2":c.fog=new TONG.FogExp2}M=e}c.fog instanceof TONG.Fog?(c.fog.color.setHex(t),c.fog.near=i,c.fog.far=n):c.fog instanceof TONG.FogExp2&&(c.fog.color.setHex(t),c.fog.density=r),g.render()}),r.windowResize.add(function(e,t){g.resizeCanvas(),g.Resize=!0,d.DEFAULT_CAMERA.aspect=o.dom.offsetWidth/o.dom.offsetHeight,d.DEFAULT_CAMERA.updateProjectionMatrix(),h.aspect=o.dom.offsetWidth/o.dom.offsetHeight,h.updateProjectionMatrix(),g.renderer.setSize(e||o.dom.offsetWidth,t||o.dom.offsetHeight),h.resize(o.dom.offsetWidth,o.dom.offsetHeight),g.isInit&&(g.outlineRenderer.setSize(o.dom.offsetWidth,o.dom.offsetHeight),g.composer.setSize(o.dom.offsetWidth,o.dom.offsetHeight),g.effectFXAA.uniforms.resolution.value.set(1/o.dom.offsetWidth,1/o.dom.offsetHeight)),g.render()}),this.setSize=function(e,t,i){g.renderer&&g.renderer.setSize(e,t,i),g.isInit&&(g.outlineRenderer.setSize(o.dom.offsetWidth,o.dom.offsetHeight),g.composer.setSize(o.dom.offsetWidth,o.dom.offsetHeight),g.effectFXAA.uniforms.resolution.value.set(1/o.dom.offsetWidth,1/o.dom.offsetHeight)),g.render()},r.showGridChanged.add(function(e){a.visible=e,g.render()}),this.render=function(){if(u.updateMatrixWorld(),c.updateMatrixWorld(),f.updateMatrixWorld(),g.renderer.setViewport(0,0,g.canvas.width,g.canvas.height),g.renderer.setScissor(0,0,g.canvas.width,g.canvas.height),h.render(g.renderer,c),g.isInit&&g.composer.render(),g.renderer.render(u,h),Settings.render.cameraPreviewEnabled){var e=Settings.render.cameraPreviewPercentage*g.canvas.width,t=Settings.render.cameraPreviewPercentage*g.canvas.height,i=Settings.BOTTOM_RIGHT,n=i===Settings.BOTTOM_RIGHT||i===Settings.TOP_RIGHT?g.canvas.width-e:0,r=i===Settings.BOTTOM_RIGHT||i===Settings.BOTTOM_LEFT?g.canvas.height-t:0;if(g.renderer.setScissorTest(!0),g.renderer.setViewport(n,r,e,t),g.renderer.setScissor(n,r,e,t),d.selected instanceof PerspectiveCamera||d.selected instanceof OrthographicCamera){var o=d.selected;o.aspect=e/t,o.updateProjectionMatrix(),o.resize(e,t),g.renderer.setViewport(n+e*o.offset.x,r+t*o.offset.y,e*o.viewport.x,t*o.viewport.y),g.renderer.setScissor(n+e*o.offset.x,r+t*o.offset.y,e*o.viewport.x,t*o.viewport.y),g.renderer.clear(o.clearColor,o.clearDepth,o.clearStencil),o.render(g.renderer,c)}else if(d.selected instanceof CubeCamera){var s=d.selected.cameras;function a(e,t,i,n,r){g.renderer.setViewport(t,i,n,r),g.renderer.setScissor(t,i,n,r),g.renderer.clear(!0,!0,!0),s[e].updateMatrixWorld(),s[e].render(g.renderer,c)}var l=t/3;n+=e-4*l,a(CubeTexture.LEFT,n,r+l,l,l),a(CubeTexture.FRONT,n+l,r+l,l,l),a(CubeTexture.RIGHT,n+2*l,r+l,l,l),a(CubeTexture.BACK,n+3*l,r+l,l,l),a(CubeTexture.TOP,n+l,r+2*l,l,l),a(CubeTexture.BOTTOM,n+l,r,l,l)}}g.orientationCube.updateRotation(p),g.orientationCube.render(g.renderer,g.canvas)},requestAnimationFrame(function e(){if(g.mouseObj.update(),g.keyboard.update(),requestAnimationFrame(e),g.renderer&&TONG.Event.trigger(EditorModule.globalTrigger,"afterRender",g.renderer),EditorModule.target.selected)for(var t=0;t<EditorModule.target.selected.components.length;t++)EditorModule.target.selected.components[t].OnInspectorUpdate&&EditorModule.target.selected.components[t].OnInspectorUpdate();Mouse.insideCanvas()&&!g.Resize&&(p.update(g.mouseObj,g.keyboard),b.update()),g.Resize&&(g.Resize=!1);var i=g.orientationCube.raycast(g.mouseObj,g.canvas);null!==i&&(g.mouseObj.buttonDoubleClicked()||g.mouseObj.buttonJustPressed(Mouse.MIDDLE))&&(p.setOrientation(i),g.renderer.clear(!0,!0,!0),g.render())})};Viewport.prototype.updateCameraControls=function(e){e===Settings.FIRST_PERSON?this.controls=new EditorFreeControls:e===Settings.ORBIT?this.controls=new EditorOrbitControls:this.controls=new EditorPlanarControls(e),this.controls.attach(this.camera)},Viewport.prototype.resetRenderer=function(){this.rendererCanvas.element&&this.container.dom.removeChild(this.rendererCanvas.element),this.rendererCanvas=new RendererCanvas(this.container.dom,this.size),this.canvas=this.rendererCanvas.canvas,EditorModule.target.renderer=this.renderer=this.rendererCanvas.renderer,Mouse.setCanvas(this.canvas),this.resetCanvas(),this.resizeCanvas(),this.renderer.setSize(this.container.dom.offsetWidth,this.container.dom.offsetHeight),this.render()},Viewport.prototype.screenPointTo3DPoint=function(e){var t=(e.clientX-e.target.getBoundingClientRect().left)/e.currentTarget.width*2-1,i=-(e.clientY-e.target.getBoundingClientRect().top)/e.currentTarget.height*2+1,n=new TONG.Vector3(t,i,.5);return n.unproject(this.camera),n},Viewport.prototype.resetCanvas=function(){this.mouseObj.setCanvas(this.canvas),this.canvas.ondragover=Element.preventDefault;var i=this;this.canvas.ondrop=function(e){var t=i.screenPointTo3DPoint(e);EditorModule.onDropOnScene(t,null,e)}},Viewport.prototype.resizeCanvas=function(){var e=this.size.x*window.devicePixelRatio,t=this.size.y*window.devicePixelRatio;this.canvas.width=e,this.canvas.height=t,this.canvas.style.width=this.size.x+"px",this.canvas.style.height=this.size.y+"px"},Viewport.prototype.setCameraMode=function(e){void 0===e&&(e=this.cameraMode===Settings.PERSPECTIVE?Settings.ORTHOGRAPHIC:Settings.PERSPECTIVE),this.cameraMode=e;var t=null!==this.canvas?this.canvas.width/this.canvas.height:1;this.cameraMode===Settings.ORTHOGRAPHIC?this.camera=new OrthographicCamera(10,t,OrthographicCamera.RESIZE_HORIZONTAL):this.cameraMode===Settings.PERSPECTIVE&&(this.camera=new PerspectiveCamera(60,t)),null!==this.controls&&(this.controls.attach(this.camera),this.controls.reset())},Viewport.prototype.createRenderer=RendererCanvas.prototype.createRenderer,Viewport.prototype.reloadContext=RendererCanvas.prototype.reloadContext,Viewport.prototype.forceContextLoss=RendererCanvas.prototype.forceContextLoss,Viewport.Info=function(s){var e=s.signals,t=new UI.Panel;t.setId("info"),t.setPosition("absolute"),t.setRight("10px"),t.setBottom("10px"),t.setFontSize("12px"),t.setColor("#fff");var a=new UI.Text("0").setMarginLeft("6px"),l=new UI.Text("0").setMarginLeft("6px"),d=new UI.Text("0").setMarginLeft("6px");function i(){for(var e=s.scene,i=0,n=0,r=0,t=0,o=e.children.length;t<o;t++){e.children[t].traverseVisible(function(e){if(i++,e instanceof TONG.Mesh){var t=e.geometry;t instanceof TONG.Geometry?(n+=t.vertices.length,r+=t.faces.length):t instanceof TONG.BufferGeometry&&(null!==t.index?(n+=3*t.index.count,r+=t.index.count):(n+=t.attributes.position.count,r+=t.attributes.position.count/3))}})}a.setValue(i.format()),l.setValue(n.format()),d.setValue(r.format())}return t.add(new UI.Text(GetLanguage("objects")),a,new UI.Break),t.add(new UI.Text(GetLanguage("vertices")),l,new UI.Break),t.add(new UI.Text(GetLanguage("triangles")),d,new UI.Break),e.objectAdded.add(i),e.objectRemoved.add(i),e.geometryChanged.add(i),t};var SearchHelpPanel=function(e){e.signals;var t=new UI.Panel;t.setPosition("absolute"),t.setId("SearchHelpContainer"),t.setTop("10px"),t.setLeft("720px");var i=new UI.Panel;i.setPosition("relative"),i.setId("searchHelpPanel"),i.setWidth("406px"),i.setHeight("37px"),i.setLeft("0px"),i.setTop("0px"),i.setBackground("url('css/pic/search.png') #262626 3% 50% no-repeat");var n=new UI.Input("");return n.setPosition("relative"),n.setColor("#cecece"),n.setBackgroundColor("#262626"),n.dom.placeholder="Help you ...?",n.setWidth("90%"),n.setHeight("30px"),n.setLeft("30px"),n.dom.style.zIndex=1,i.add(n),t.add(i),t},ViewportControl=function(i){var n=i.signals,e=new UI.Panel;e.setId("ViewportControl"),e.setPosition("absolute"),e.setLeft("10px"),e.setTop("10px"),e.setFontSize("12px"),e.setColor("#fff");var t=new UI.ButtonIcon("css/pic/home.png","#262626","5% 40%","Tong World Pro");t.setPosition("absolute"),t.setId("projectNameBtn"),t.setHeight("37px"),t.setWidth("130px"),t.dom.title="Tong World Pro",t.onClick(function(){i.stopAutoSave(),$("#TransparentBackPanel").css("display",""),$("#scenesManagerPanel").css("display",""),ScenesManagerPanel.RefreshPanel(i)}),e.add(t);var r=new UI.ButtonIcon("css/pic/sceneIcon.png","#262626","5% 40%","Main Scene");r.setPosition("absolute"),r.setId("settingsNameBtn"),r.setLeft("140px"),r.setHeight("37px"),r.setWidth("105px"),r.dom.title="Main Scene",r.onClick(function(){i.stopAutoSave(),$("#TransparentBackPanel").css("display",""),$("#scenesManagerPanel").css("display",""),ScenesManagerPanel.RefreshPanel(i)}),e.add(r),n.storageGetFinish.add(function(){t.setLabel(i.currentProjectName),r.setLabel(i.currentSceneName),r.dom.title=i.currentSceneName+"",t.dom.title=i.currentProjectName+"",a()});var o=new UI.ButtonIcon("css/pic/Fullscreen.png","#262626","50% 50%","");o.setId("fullScreenBtn"),o.setLeft("250px"),o.setPosition("absolute"),o.setHeight("37px"),o.setWidth("37px"),o.dom.title="Full Screen",e.add(o),Utils.OnClick(o,function(e,t){Utils.FullScreen(t,i)},!0);var s=new UI.ButtonIcon("css/pic/play.png","#262626","50% 50%","");function a(){$("#projectNameBtn").each(function(){10<$(this).text().length&&($(this).text($(this).text().substring(0,10)),$(this).html($(this).html()+"…"))}),$("#settingsNameBtn").each(function(){8<$(this).text().length&&($(this).text($(this).text().substring(0,8)),$(this).html($(this).html()+"…"))})}return s.setPosition("absolute"),s.setId("playGameBtn"),s.setLeft("292px"),s.setHeight("37px"),s.setWidth("37px"),s.dom.title="Play",e.add(s),Utils.OnClick(s,function(e,t){t?(i.toJSON(),s.dom.title="Stop",n.startPlayer.dispatch()):(s.dom.title="Play",n.stopPlayer.dispatch())},!0),Utils.OnStart.add(a),e};!function(e,t){if("function"==typeof define&&define.amd)define(["long"],t);else if("function"==typeof require&&"object"==typeof module&&module&&module.exports){var i,n=module;try{i=require("long")}catch(e){}i=t(i),n.exports=i}else(e.dcodeIO=e.dcodeIO||{}).ByteBuffer=t(e.dcodeIO.Long)}(this,function(l){function a(e){var t=0;return function(){return t<e.length?e.charCodeAt(t++):null}}function d(){var e=[],t=[];return function(){if(0===arguments.length)return t.join("")+n.apply(String,e);1024<e.length+arguments.length&&(t.push(n.apply(String,e)),e.length=0),Array.prototype.push.apply(e,arguments)}}function i(e,t,i,n,r){var o,s=(1<<(o=8*r-n-1))-1,a=s>>1,l=-7,d=i?-1:1,h=e[t+(r=i?r-1:0)];for(r+=d,i=h&(1<<-l)-1,h>>=-l,l+=o;0<l;i=256*i+e[t+r],r+=d,l-=8);for(o=i&(1<<-l)-1,i>>=-l,l+=n;0<l;o=256*o+e[t+r],r+=d,l-=8);if(0===i)i=1-a;else{if(i===s)return o?NaN:1/0*(h?-1:1);o+=Math.pow(2,n),i-=a}return(h?-1:1)*o*Math.pow(2,i-n)}function r(e,t,i,n,r,o){var s,a=8*o-r-1,l=(1<<a)-1,d=l>>1,h=23===r?Math.pow(2,-24)-Math.pow(2,-77):0;o=n?0:o-1;var c=n?1:-1,u=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||1/0===t?(t=isNaN(t)?1:0,n=l):(n=Math.floor(Math.log(t)/Math.LN2),t*(s=Math.pow(2,-n))<1&&(n--,s*=2),2<=(t=1<=n+d?t+h/s:t+h*Math.pow(2,1-d))*s&&(n++,s/=2),l<=n+d?(t=0,n=l):1<=n+d?(t=(t*s-1)*Math.pow(2,r),n+=d):(t=t*Math.pow(2,d-1)*Math.pow(2,r),n=0));8<=r;e[i+o]=255&t,o+=c,t/=256,r-=8);for(n=n<<r|t,a+=r;0<a;e[i+o]=255&n,o+=c,n/=256,a-=8);e[i+o-c]|=128*u}var u=function(e,t,i){if(void 0===e&&(e=u.DEFAULT_CAPACITY),void 0===t&&(t=u.DEFAULT_ENDIAN),void 0===i&&(i=u.DEFAULT_NOASSERT),!i){if((e|=0)<0)throw RangeError("Illegal capacity");t=!!t,i=!!i}this.buffer=0===e?s:new ArrayBuffer(e),this.view=0===e?null:new Uint8Array(this.buffer),this.offset=0,this.markedOffset=-1,this.limit=e,this.littleEndian=t,this.noAssert=i};u.VERSION="5.0.1",u.LITTLE_ENDIAN=!0,u.BIG_ENDIAN=!1,u.DEFAULT_CAPACITY=16,u.DEFAULT_ENDIAN=u.BIG_ENDIAN,u.DEFAULT_NOASSERT=!1,u.Long=l||null;var o=u.prototype;Object.defineProperty(o,"__isByteBuffer__",{value:!0,enumerable:!1,configurable:!1});var s=new ArrayBuffer(0),n=String.fromCharCode;u.accessor=function(){return Uint8Array},u.allocate=function(e,t,i){return new u(e,t,i)},u.concat=function(e,t,i,n){"boolean"!=typeof t&&"string"==typeof t||(n=i,i=t,t=void 0);for(var r,o=0,s=0,a=e.length;s<a;++s)u.isByteBuffer(e[s])||(e[s]=u.wrap(e[s],t)),0<(r=e[s].limit-e[s].offset)&&(o+=r);if(0===o)return new u(0,i,n);for(t=new u(o,i,n),s=0;s<a;)(r=(i=e[s++]).limit-i.offset)<=0||(t.view.set(i.view.subarray(i.offset,i.limit),t.offset),t.offset+=r);return t.limit=t.offset,t.offset=0,t},u.isByteBuffer=function(e){return!0===(e&&e.__isByteBuffer__)},u.type=function(){return ArrayBuffer},u.wrap=function(e,t,i,n){if("string"!=typeof t&&(n=i,i=t,t=void 0),"string"==typeof e)switch(void 0===t&&(t="utf8"),t){case"base64":return u.fromBase64(e,i);case"hex":return u.fromHex(e,i);case"binary":return u.fromBinary(e,i);case"utf8":return u.fromUTF8(e,i);case"debug":return u.fromDebug(e,i);default:throw Error("Unsupported encoding: "+t)}if(null===e||"object"!=typeof e)throw TypeError("Illegal buffer");if(u.isByteBuffer(e))return(t=o.clone.call(e)).markedOffset=-1,t;if(e instanceof Uint8Array)t=new u(0,i,n),0<e.length&&(t.buffer=e.buffer,t.offset=e.byteOffset,t.limit=e.byteOffset+e.byteLength,t.view=new Uint8Array(e.buffer));else if(e instanceof ArrayBuffer)t=new u(0,i,n),0<e.byteLength&&(t.buffer=e,t.offset=0,t.limit=e.byteLength,t.view=0<e.byteLength?new Uint8Array(e):null);else{if("[object Array]"!==Object.prototype.toString.call(e))throw TypeError("Illegal buffer");for((t=new u(e.length,i,n)).limit=e.length,i=0;i<e.length;++i)t.view[i]=e[i]}return t},o.writeBitSet=function(e,t){var i=void 0===t;if(i&&(t=this.offset),!this.noAssert){if(!(e instanceof Array))throw TypeError("Illegal BitSet: Not an array");if("number"!=typeof t||0!=t%1)throw TypeError("Illegal offset: "+t+" (not an integer)");if((t>>>=0)<0||t+0>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+t+" (+0) <= "+this.buffer.byteLength)}var n,r=t,o=e.length,s=o>>3,a=0;for(t+=this.writeVarint32(o,t);s--;)n=1&!!e[a++]|(1&!!e[a++])<<1|(1&!!e[a++])<<2|(1&!!e[a++])<<3|(1&!!e[a++])<<4|(1&!!e[a++])<<5|(1&!!e[a++])<<6|(1&!!e[a++])<<7,this.writeByte(n,t++);if(a<o){for(n=s=0;a<o;)n|=(1&!!e[a++])<<s++;this.writeByte(n,t++)}return i?(this.offset=t,this):t-r},o.readBitSet=function(e){var t=void 0===e;t&&(e=this.offset);var i=this.readVarint32(e),n=i.value,r=n>>3,o=0,s=[];for(e+=i.length;r--;)i=this.readByte(e++),s[o++]=!!(1&i),s[o++]=!!(2&i),s[o++]=!!(4&i),s[o++]=!!(8&i),s[o++]=!!(16&i),s[o++]=!!(32&i),s[o++]=!!(64&i),s[o++]=!!(128&i);if(o<n)for(r=0,i=this.readByte(e++);o<n;)s[o++]=!!(i>>r++&1);return t&&(this.offset=e),s},o.readBytes=function(e,t){var i=void 0===t;if(i&&(t=this.offset),!this.noAssert){if("number"!=typeof t||0!=t%1)throw TypeError("Illegal offset: "+t+" (not an integer)");if((t>>>=0)<0||t+e>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+t+" (+"+e+") <= "+this.buffer.byteLength)}var n=this.slice(t,t+e);return i&&(this.offset+=e),n},o.writeBytes=o.append,o.writeInt8=function(e,t){var i=void 0===t;if(i&&(t=this.offset),!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal value: "+e+" (not an integer)");if(e|=0,"number"!=typeof t||0!=t%1)throw TypeError("Illegal offset: "+t+" (not an integer)");if((t>>>=0)<0||t+0>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+t+" (+0) <= "+this.buffer.byteLength)}t+=1;var n=this.buffer.byteLength;return n<t&&this.resize((n*=2)>t?n:t),this.view[t-1]=e,i&&(this.offset+=1),this},o.writeByte=o.writeInt8,o.readInt8=function(e){var t=void 0===e;if(t&&(e=this.offset),!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal offset: "+e+" (not an integer)");if((e>>>=0)<0||e+1>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+e+" (+1) <= "+this.buffer.byteLength)}return 128==(128&(e=this.view[e]))&&(e=-(255-e+1)),t&&(this.offset+=1),e},o.readByte=o.readInt8,o.writeUint8=function(e,t){var i=void 0===t;if(i&&(t=this.offset),!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal value: "+e+" (not an integer)");if(e>>>=0,"number"!=typeof t||0!=t%1)throw TypeError("Illegal offset: "+t+" (not an integer)");if((t>>>=0)<0||t+0>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+t+" (+0) <= "+this.buffer.byteLength)}t+=1;var n=this.buffer.byteLength;return n<t&&this.resize((n*=2)>t?n:t),this.view[t-1]=e,i&&(this.offset+=1),this},o.writeUInt8=o.writeUint8,o.readUint8=function(e){var t=void 0===e;if(t&&(e=this.offset),!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal offset: "+e+" (not an integer)");if((e>>>=0)<0||e+1>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+e+" (+1) <= "+this.buffer.byteLength)}return e=this.view[e],t&&(this.offset+=1),e},o.readUInt8=o.readUint8,o.writeInt16=function(e,t){var i=void 0===t;if(i&&(t=this.offset),!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal value: "+e+" (not an integer)");if(e|=0,"number"!=typeof t||0!=t%1)throw TypeError("Illegal offset: "+t+" (not an integer)");if((t>>>=0)<0||t+0>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+t+" (+0) <= "+this.buffer.byteLength)}t+=2;var n=this.buffer.byteLength;return n<t&&this.resize((n*=2)>t?n:t),t-=2,this.littleEndian?(this.view[t+1]=(65280&e)>>>8,this.view[t]=255&e):(this.view[t]=(65280&e)>>>8,this.view[t+1]=255&e),i&&(this.offset+=2),this},o.writeShort=o.writeInt16,o.readInt16=function(e){var t=void 0===e;if(t&&(e=this.offset),!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal offset: "+e+" (not an integer)");if((e>>>=0)<0||e+2>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+e+" (+2) <= "+this.buffer.byteLength)}var i=0;return this.littleEndian?(i=this.view[e],i|=this.view[e+1]<<8):(i=this.view[e]<<8,i|=this.view[e+1]),32768==(32768&i)&&(i=-(65535-i+1)),t&&(this.offset+=2),i},o.readShort=o.readInt16,o.writeUint16=function(e,t){var i=void 0===t;if(i&&(t=this.offset),!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal value: "+e+" (not an integer)");if(e>>>=0,"number"!=typeof t||0!=t%1)throw TypeError("Illegal offset: "+t+" (not an integer)");if((t>>>=0)<0||t+0>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+t+" (+0) <= "+this.buffer.byteLength)}t+=2;var n=this.buffer.byteLength;return n<t&&this.resize((n*=2)>t?n:t),t-=2,this.littleEndian?(this.view[t+1]=(65280&e)>>>8,this.view[t]=255&e):(this.view[t]=(65280&e)>>>8,this.view[t+1]=255&e),i&&(this.offset+=2),this},o.writeUInt16=o.writeUint16,o.readUint16=function(e){var t=void 0===e;if(t&&(e=this.offset),!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal offset: "+e+" (not an integer)");if((e>>>=0)<0||e+2>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+e+" (+2) <= "+this.buffer.byteLength)}var i=0;return this.littleEndian?(i=this.view[e],i|=this.view[e+1]<<8):(i=this.view[e]<<8,i|=this.view[e+1]),t&&(this.offset+=2),i},o.readUInt16=o.readUint16,o.writeInt32=function(e,t){var i=void 0===t;if(i&&(t=this.offset),!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal value: "+e+" (not an integer)");if(e|=0,"number"!=typeof t||0!=t%1)throw TypeError("Illegal offset: "+t+" (not an integer)");if((t>>>=0)<0||t+0>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+t+" (+0) <= "+this.buffer.byteLength)}t+=4;var n=this.buffer.byteLength;return n<t&&this.resize((n*=2)>t?n:t),t-=4,this.littleEndian?(this.view[t+3]=e>>>24&255,this.view[t+2]=e>>>16&255,this.view[t+1]=e>>>8&255,this.view[t]=255&e):(this.view[t]=e>>>24&255,this.view[t+1]=e>>>16&255,this.view[t+2]=e>>>8&255,this.view[t+3]=255&e),i&&(this.offset+=4),this},o.writeInt=o.writeInt32,o.readInt32=function(e){var t=void 0===e;if(t&&(e=this.offset),!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal offset: "+e+" (not an integer)");if((e>>>=0)<0||e+4>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+e+" (+4) <= "+this.buffer.byteLength)}var i=0;return this.littleEndian?(i=this.view[e+2]<<16,i|=this.view[e+1]<<8,i|=this.view[e],i+=this.view[e+3]<<24>>>0):(i=this.view[e+1]<<16,i|=this.view[e+2]<<8,i|=this.view[e+3],i+=this.view[e]<<24>>>0),t&&(this.offset+=4),0|i},o.readInt=o.readInt32,o.writeUint32=function(e,t){var i=void 0===t;if(i&&(t=this.offset),!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal value: "+e+" (not an integer)");if(e>>>=0,"number"!=typeof t||0!=t%1)throw TypeError("Illegal offset: "+t+" (not an integer)");if((t>>>=0)<0||t+0>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+t+" (+0) <= "+this.buffer.byteLength)}t+=4;var n=this.buffer.byteLength;return n<t&&this.resize((n*=2)>t?n:t),t-=4,this.littleEndian?(this.view[t+3]=e>>>24&255,this.view[t+2]=e>>>16&255,this.view[t+1]=e>>>8&255,this.view[t]=255&e):(this.view[t]=e>>>24&255,this.view[t+1]=e>>>16&255,this.view[t+2]=e>>>8&255,this.view[t+3]=255&e),i&&(this.offset+=4),this},o.writeUInt32=o.writeUint32,o.readUint32=function(e){var t=void 0===e;if(t&&(e=this.offset),!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal offset: "+e+" (not an integer)");if((e>>>=0)<0||e+4>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+e+" (+4) <= "+this.buffer.byteLength)}var i=0;return this.littleEndian?(i=this.view[e+2]<<16,i|=this.view[e+1]<<8,i|=this.view[e],i+=this.view[e+3]<<24>>>0):(i=this.view[e+1]<<16,i|=this.view[e+2]<<8,i|=this.view[e+3],i+=this.view[e]<<24>>>0),t&&(this.offset+=4),i},o.readUInt32=o.readUint32,l&&(o.writeInt64=function(e,t){var i=void 0===t;if(i&&(t=this.offset),!this.noAssert){if("number"==typeof e)e=l.fromNumber(e);else if("string"==typeof e)e=l.fromString(e);else if(!(e&&e instanceof l))throw TypeError("Illegal value: "+e+" (not an integer or Long)");if("number"!=typeof t||0!=t%1)throw TypeError("Illegal offset: "+t+" (not an integer)");if((t>>>=0)<0||t+0>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+t+" (+0) <= "+this.buffer.byteLength)}"number"==typeof e?e=l.fromNumber(e):"string"==typeof e&&(e=l.fromString(e)),t+=8,(n=this.buffer.byteLength)<t&&this.resize((n*=2)>t?n:t),t-=8;var n=e.low,r=e.high;return this.littleEndian?(this.view[t+3]=n>>>24&255,this.view[t+2]=n>>>16&255,this.view[t+1]=n>>>8&255,this.view[t]=255&n,t+=4,this.view[t+3]=r>>>24&255,this.view[t+2]=r>>>16&255,this.view[t+1]=r>>>8&255,this.view[t]=255&r):(this.view[t]=r>>>24&255,this.view[t+1]=r>>>16&255,this.view[t+2]=r>>>8&255,this.view[t+3]=255&r,t+=4,this.view[t]=n>>>24&255,this.view[t+1]=n>>>16&255,this.view[t+2]=n>>>8&255,this.view[t+3]=255&n),i&&(this.offset+=8),this},o.writeLong=o.writeInt64,o.readInt64=function(e){var t=void 0===e;if(t&&(e=this.offset),!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal offset: "+e+" (not an integer)");if((e>>>=0)<0||e+8>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+e+" (+8) <= "+this.buffer.byteLength)}var i=0,n=0;return this.littleEndian?(i=this.view[e+2]<<16,i|=this.view[e+1]<<8,i|=this.view[e],i+=this.view[e+3]<<24>>>0,e+=4,n=this.view[e+2]<<16,n|=this.view[e+1]<<8,n|=this.view[e],n+=this.view[e+3]<<24>>>0):(n=this.view[e+1]<<16,n|=this.view[e+2]<<8,n|=this.view[e+3],n+=this.view[e]<<24>>>0,e+=4,i=this.view[e+1]<<16,i|=this.view[e+2]<<8,i|=this.view[e+3],i+=this.view[e]<<24>>>0),e=new l(i,n,!1),t&&(this.offset+=8),e},o.readLong=o.readInt64,o.writeUint64=function(e,t){var i=void 0===t;if(i&&(t=this.offset),!this.noAssert){if("number"==typeof e)e=l.fromNumber(e);else if("string"==typeof e)e=l.fromString(e);else if(!(e&&e instanceof l))throw TypeError("Illegal value: "+e+" (not an integer or Long)");if("number"!=typeof t||0!=t%1)throw TypeError("Illegal offset: "+t+" (not an integer)");if((t>>>=0)<0||t+0>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+t+" (+0) <= "+this.buffer.byteLength)}"number"==typeof e?e=l.fromNumber(e):"string"==typeof e&&(e=l.fromString(e)),t+=8,(n=this.buffer.byteLength)<t&&this.resize((n*=2)>t?n:t),t-=8;var n=e.low,r=e.high;return this.littleEndian?(this.view[t+3]=n>>>24&255,this.view[t+2]=n>>>16&255,this.view[t+1]=n>>>8&255,this.view[t]=255&n,t+=4,this.view[t+3]=r>>>24&255,this.view[t+2]=r>>>16&255,this.view[t+1]=r>>>8&255,this.view[t]=255&r):(this.view[t]=r>>>24&255,this.view[t+1]=r>>>16&255,this.view[t+2]=r>>>8&255,this.view[t+3]=255&r,t+=4,this.view[t]=n>>>24&255,this.view[t+1]=n>>>16&255,this.view[t+2]=n>>>8&255,this.view[t+3]=255&n),i&&(this.offset+=8),this},o.writeUInt64=o.writeUint64,o.readUint64=function(e){var t=void 0===e;if(t&&(e=this.offset),!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal offset: "+e+" (not an integer)");if((e>>>=0)<0||e+8>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+e+" (+8) <= "+this.buffer.byteLength)}var i=0,n=0;return this.littleEndian?(i=this.view[e+2]<<16,i|=this.view[e+1]<<8,i|=this.view[e],i+=this.view[e+3]<<24>>>0,e+=4,n=this.view[e+2]<<16,n|=this.view[e+1]<<8,n|=this.view[e],n+=this.view[e+3]<<24>>>0):(n=this.view[e+1]<<16,n|=this.view[e+2]<<8,n|=this.view[e+3],n+=this.view[e]<<24>>>0,e+=4,i=this.view[e+1]<<16,i|=this.view[e+2]<<8,i|=this.view[e+3],i+=this.view[e]<<24>>>0),e=new l(i,n,!0),t&&(this.offset+=8),e},o.readUInt64=o.readUint64),o.writeFloat32=function(e,t){var i=void 0===t;if(i&&(t=this.offset),!this.noAssert){if("number"!=typeof e)throw TypeError("Illegal value: "+e+" (not a number)");if("number"!=typeof t||0!=t%1)throw TypeError("Illegal offset: "+t+" (not an integer)");if((t>>>=0)<0||t+0>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+t+" (+0) <= "+this.buffer.byteLength)}t+=4;var n=this.buffer.byteLength;return n<t&&this.resize((n*=2)>t?n:t),r(this.view,e,t-4,this.littleEndian,23,4),i&&(this.offset+=4),this},o.writeFloat=o.writeFloat32,o.readFloat32=function(e){var t=void 0===e;if(t&&(e=this.offset),!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal offset: "+e+" (not an integer)");if((e>>>=0)<0||e+4>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+e+" (+4) <= "+this.buffer.byteLength)}return e=i(this.view,e,this.littleEndian,23,4),t&&(this.offset+=4),e},o.readFloat=o.readFloat32,o.writeFloat64=function(e,t){var i=void 0===t;if(i&&(t=this.offset),!this.noAssert){if("number"!=typeof e)throw TypeError("Illegal value: "+e+" (not a number)");if("number"!=typeof t||0!=t%1)throw TypeError("Illegal offset: "+t+" (not an integer)");if((t>>>=0)<0||t+0>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+t+" (+0) <= "+this.buffer.byteLength)}t+=8;var n=this.buffer.byteLength;return n<t&&this.resize((n*=2)>t?n:t),r(this.view,e,t-8,this.littleEndian,52,8),i&&(this.offset+=8),this},o.writeDouble=o.writeFloat64,o.readFloat64=function(e){var t=void 0===e;if(t&&(e=this.offset),!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal offset: "+e+" (not an integer)");if((e>>>=0)<0||e+8>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+e+" (+8) <= "+this.buffer.byteLength)}return e=i(this.view,e,this.littleEndian,52,8),t&&(this.offset+=8),e},o.readDouble=o.readFloat64,u.MAX_VARINT32_BYTES=5,u.calculateVarint32=function(e){return(e>>>=0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5},u.zigZagEncode32=function(e){return((e|=0)<<1^e>>31)>>>0},u.zigZagDecode32=function(e){return e>>>1^-(1&e)|0},o.writeVarint32=function(e,t){var i=void 0===t;if(i&&(t=this.offset),!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal value: "+e+" (not an integer)");if(e|=0,"number"!=typeof t||0!=t%1)throw TypeError("Illegal offset: "+t+" (not an integer)");if((t>>>=0)<0||t+0>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+t+" (+0) <= "+this.buffer.byteLength)}var n,r=u.calculateVarint32(e);for(t+=r,(n=this.buffer.byteLength)<t&&this.resize((n*=2)>t?n:t),t-=r,e>>>=0;128<=e;)n=127&e|128,this.view[t++]=n,e>>>=7;return this.view[t++]=e,i?(this.offset=t,this):r},o.writeVarint32ZigZag=function(e,t){return this.writeVarint32(u.zigZagEncode32(e),t)},o.readVarint32=function(e){var t=void 0===e;if(t&&(e=this.offset),!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal offset: "+e+" (not an integer)");if((e>>>=0)<0||e+1>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+e+" (+1) <= "+this.buffer.byteLength)}var i,n=0,r=0;do{if(!this.noAssert&&e>this.limit)throw(e=Error("Truncated")).truncated=!0,e;i=this.view[e++],n<5&&(r|=(127&i)<<7*n),++n}while(0!=(128&i));return r|=0,t?(this.offset=e,r):{value:r,length:n}},o.readVarint32ZigZag=function(e){return"object"==typeof(e=this.readVarint32(e))?e.value=u.zigZagDecode32(e.value):e=u.zigZagDecode32(e),e},l&&(u.MAX_VARINT64_BYTES=10,u.calculateVarint64=function(e){"number"==typeof e?e=l.fromNumber(e):"string"==typeof e&&(e=l.fromString(e));var t=e.toInt()>>>0,i=e.shiftRightUnsigned(28).toInt()>>>0;return 0==(e=e.shiftRightUnsigned(56).toInt()>>>0)?0==i?t<16384?t<128?1:2:t<2097152?3:4:i<16384?i<128?5:6:i<2097152?7:8:e<128?9:10},u.zigZagEncode64=function(e){return"number"==typeof e?e=l.fromNumber(e,!1):"string"==typeof e?e=l.fromString(e,!1):!1!==e.unsigned&&(e=e.toSigned()),e.shiftLeft(1).xor(e.shiftRight(63)).toUnsigned()},u.zigZagDecode64=function(e){return"number"==typeof e?e=l.fromNumber(e,!1):"string"==typeof e?e=l.fromString(e,!1):!1!==e.unsigned&&(e=e.toSigned()),e.shiftRightUnsigned(1).xor(e.and(l.ONE).toSigned().negate()).toSigned()},o.writeVarint64=function(e,t){var i=void 0===t;if(i&&(t=this.offset),!this.noAssert){if("number"==typeof e)e=l.fromNumber(e);else if("string"==typeof e)e=l.fromString(e);else if(!(e&&e instanceof l))throw TypeError("Illegal value: "+e+" (not an integer or Long)");if("number"!=typeof t||0!=t%1)throw TypeError("Illegal offset: "+t+" (not an integer)");if((t>>>=0)<0||t+0>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+t+" (+0) <= "+this.buffer.byteLength)}"number"==typeof e?e=l.fromNumber(e,!1):"string"==typeof e?e=l.fromString(e,!1):!1!==e.unsigned&&(e=e.toSigned());var n=u.calculateVarint64(e),r=e.toInt()>>>0,o=e.shiftRightUnsigned(28).toInt()>>>0,s=e.shiftRightUnsigned(56).toInt()>>>0;t+=n;var a=this.buffer.byteLength;switch(a<t&&this.resize((a*=2)>t?a:t),t-=n,n){case 10:this.view[t+9]=s>>>7&1;case 9:this.view[t+8]=9!==n?128|s:127&s;case 8:this.view[t+7]=8!==n?o>>>21|128:o>>>21&127;case 7:this.view[t+6]=7!==n?o>>>14|128:o>>>14&127;case 6:this.view[t+5]=6!==n?o>>>7|128:o>>>7&127;case 5:this.view[t+4]=5!==n?128|o:127&o;case 4:this.view[t+3]=4!==n?r>>>21|128:r>>>21&127;case 3:this.view[t+2]=3!==n?r>>>14|128:r>>>14&127;case 2:this.view[t+1]=2!==n?r>>>7|128:r>>>7&127;case 1:this.view[t]=1!==n?128|r:127&r}return i?(this.offset+=n,this):n},o.writeVarint64ZigZag=function(e,t){return this.writeVarint64(u.zigZagEncode64(e),t)},o.readVarint64=function(e){var t=void 0===e;if(t&&(e=this.offset),!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal offset: "+e+" (not an integer)");if((e>>>=0)<0||e+1>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+e+" (+1) <= "+this.buffer.byteLength)}var i=e,n=0,r=0,o=0,s=0;n=127&(s=this.view[e++]);if(128&s&&(n|=(127&(s=this.view[e++]))<<7,128&s||this.noAssert&&void 0===s)&&(n|=(127&(s=this.view[e++]))<<14,128&s||this.noAssert&&void 0===s)&&(n|=(127&(s=this.view[e++]))<<21,128&s||this.noAssert&&void 0===s)&&(r=127&(s=this.view[e++]),128&s||this.noAssert&&void 0===s)&&(r|=(127&(s=this.view[e++]))<<7,128&s||this.noAssert&&void 0===s)&&(r|=(127&(s=this.view[e++]))<<14,128&s||this.noAssert&&void 0===s)&&(r|=(127&(s=this.view[e++]))<<21,128&s||this.noAssert&&void 0===s)&&(o=127&(s=this.view[e++]),128&s||this.noAssert&&void 0===s)&&(o|=(127&(s=this.view[e++]))<<7,128&s||this.noAssert&&void 0===s))throw Error("Buffer overrun");return n=l.fromBits(n|r<<28,r>>>4|o<<24,!1),t?(this.offset=e,n):{value:n,length:e-i}},o.readVarint64ZigZag=function(e){return(e=this.readVarint64(e))&&e.value instanceof l?e.value=u.zigZagDecode64(e.value):e=u.zigZagDecode64(e),e}),o.writeCString=function(e,t){var i=void 0===t;i&&(t=this.offset);var n,r=e.length;if(!this.noAssert){if("string"!=typeof e)throw TypeError("Illegal str: Not a string");for(n=0;n<r;++n)if(0===e.charCodeAt(n))throw RangeError("Illegal str: Contains NULL-characters");if("number"!=typeof t||0!=t%1)throw TypeError("Illegal offset: "+t+" (not an integer)");if((t>>>=0)<0||t+0>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+t+" (+0) <= "+this.buffer.byteLength)}return r=f.calculateUTF16asUTF8(a(e))[1],t+=r+1,(n=this.buffer.byteLength)<t&&this.resize((n*=2)>t?n:t),t-=r+1,f.encodeUTF16toUTF8(a(e),function(e){this.view[t++]=e}.bind(this)),this.view[t++]=0,i?(this.offset=t,this):r},o.readCString=function(e){var t=void 0===e;if(t&&(e=this.offset),!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal offset: "+e+" (not an integer)");if((e>>>=0)<0||e+1>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+e+" (+1) <= "+this.buffer.byteLength)}var i,n=e,r=-1;return f.decodeUTF8toUTF16(function(){if(0===r)return null;if(e>=this.limit)throw RangeError("Illegal range: Truncated data, "+e+" < "+this.limit);return 0===(r=this.view[e++])?null:r}.bind(this),i=d(),!0),t?(this.offset=e,i()):{string:i(),length:e-n}},o.writeIString=function(e,t){var i=void 0===t;if(i&&(t=this.offset),!this.noAssert){if("string"!=typeof e)throw TypeError("Illegal str: Not a string");if("number"!=typeof t||0!=t%1)throw TypeError("Illegal offset: "+t+" (not an integer)");if((t>>>=0)<0||t+0>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+t+" (+0) <= "+this.buffer.byteLength)}var n,r=t;n=f.calculateUTF16asUTF8(a(e),this.noAssert)[1],t+=4+n;var o=this.buffer.byteLength;if(o<t&&this.resize((o*=2)>t?o:t),t-=4+n,this.littleEndian?(this.view[t+3]=n>>>24&255,this.view[t+2]=n>>>16&255,this.view[t+1]=n>>>8&255,this.view[t]=255&n):(this.view[t]=n>>>24&255,this.view[t+1]=n>>>16&255,this.view[t+2]=n>>>8&255,this.view[t+3]=255&n),t+=4,f.encodeUTF16toUTF8(a(e),function(e){this.view[t++]=e}.bind(this)),t!==r+4+n)throw RangeError("Illegal range: Truncated data, "+t+" == "+(t+4+n));return i?(this.offset=t,this):t-r},o.readIString=function(e){var t=void 0===e;if(t&&(e=this.offset),!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal offset: "+e+" (not an integer)");if((e>>>=0)<0||e+4>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+e+" (+4) <= "+this.buffer.byteLength)}var i=e,n=this.readUint32(e);n=this.readUTF8String(n,u.METRICS_BYTES,e+=4);return e+=n.length,t?(this.offset=e,n.string):{string:n.string,length:e-i}},u.METRICS_CHARS="c",u.METRICS_BYTES="b",o.writeUTF8String=function(e,t){var i=void 0===t;if(i&&(t=this.offset),!this.noAssert){if("number"!=typeof t||0!=t%1)throw TypeError("Illegal offset: "+t+" (not an integer)");if((t>>>=0)<0||t+0>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+t+" (+0) <= "+this.buffer.byteLength)}var n,r=t;n=f.calculateUTF16asUTF8(a(e))[1],t+=n;var o=this.buffer.byteLength;return o<t&&this.resize((o*=2)>t?o:t),t-=n,f.encodeUTF16toUTF8(a(e),function(e){this.view[t++]=e}.bind(this)),i?(this.offset=t,this):t-r},o.writeString=o.writeUTF8String,u.calculateUTF8Chars=function(e){return f.calculateUTF16asUTF8(a(e))[0]},u.calculateUTF8Bytes=function(e){return f.calculateUTF16asUTF8(a(e))[1]},u.calculateString=u.calculateUTF8Bytes,o.readUTF8String=function(e,t,i){"number"==typeof t&&(i=t,t=void 0);var n=void 0===i;if(n&&(i=this.offset),void 0===t&&(t=u.METRICS_CHARS),!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal length: "+e+" (not an integer)");if(e|=0,"number"!=typeof i||0!=i%1)throw TypeError("Illegal offset: "+i+" (not an integer)");if((i>>>=0)<0||i+0>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+i+" (+0) <= "+this.buffer.byteLength)}var r,o=0,s=i;if(t===u.METRICS_CHARS){if(r=d(),f.decodeUTF8(function(){return o<e&&i<this.limit?this.view[i++]:null}.bind(this),function(e){++o,f.UTF8toUTF16(e,r)}),o!==e)throw RangeError("Illegal range: Truncated data, "+o+" == "+e);return n?(this.offset=i,r()):{string:r(),length:i-s}}if(t===u.METRICS_BYTES){if(!this.noAssert){if("number"!=typeof i||0!=i%1)throw TypeError("Illegal offset: "+i+" (not an integer)");if((i>>>=0)<0||i+e>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+i+" (+"+e+") <= "+this.buffer.byteLength)}var a=i+e;if(f.decodeUTF8toUTF16(function(){return i<a?this.view[i++]:null}.bind(this),r=d(),this.noAssert),i!==a)throw RangeError("Illegal range: Truncated data, "+i+" == "+a);return n?(this.offset=i,r()):{string:r(),length:i-s}}throw TypeError("Unsupported metrics: "+t)},o.readString=o.readUTF8String,o.writeVString=function(e,t){var i=void 0===t;if(i&&(t=this.offset),!this.noAssert){if("string"!=typeof e)throw TypeError("Illegal str: Not a string");if("number"!=typeof t||0!=t%1)throw TypeError("Illegal offset: "+t+" (not an integer)");if((t>>>=0)<0||t+0>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+t+" (+0) <= "+this.buffer.byteLength)}var n,r,o=t;n=f.calculateUTF16asUTF8(a(e),this.noAssert)[1],r=u.calculateVarint32(n),t+=r+n;var s=this.buffer.byteLength;if(s<t&&this.resize((s*=2)>t?s:t),t-=r+n,t+=this.writeVarint32(n,t),f.encodeUTF16toUTF8(a(e),function(e){this.view[t++]=e}.bind(this)),t!==o+n+r)throw RangeError("Illegal range: Truncated data, "+t+" == "+(t+n+r));return i?(this.offset=t,this):t-o},o.readVString=function(e){var t=void 0===e;if(t&&(e=this.offset),!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal offset: "+e+" (not an integer)");if((e>>>=0)<0||e+1>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+e+" (+1) <= "+this.buffer.byteLength)}var i=e,n=this.readVarint32(e);n=this.readUTF8String(n.value,u.METRICS_BYTES,e+=n.length);return e+=n.length,t?(this.offset=e,n.string):{string:n.string,length:e-i}},o.append=function(e,t,i){"number"!=typeof t&&"string"==typeof t||(i=t,t=void 0);var n=void 0===i;if(n&&(i=this.offset),!this.noAssert){if("number"!=typeof i||0!=i%1)throw TypeError("Illegal offset: "+i+" (not an integer)");if((i>>>=0)<0||i+0>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+i+" (+0) <= "+this.buffer.byteLength)}if(e instanceof u||(e=u.wrap(e,t)),(t=e.limit-e.offset)<=0)return this;i+=t;var r=this.buffer.byteLength;return r<i&&this.resize((r*=2)>i?r:i),i-=t,this.view.set(e.view.subarray(e.offset,e.limit),i),e.offset+=t,n&&(this.offset+=t),this},o.appendTo=function(e,t){return e.append(this,t),this},o.assert=function(e){return this.noAssert=!e,this},o.capacity=function(){return this.buffer.byteLength},o.clear=function(){return this.offset=0,this.limit=this.buffer.byteLength,this.markedOffset=-1,this},o.clone=function(e){var t=new u(0,this.littleEndian,this.noAssert);return e?(t.buffer=new ArrayBuffer(this.buffer.byteLength),t.view=new Uint8Array(t.buffer)):(t.buffer=this.buffer,t.view=this.view),t.offset=this.offset,t.markedOffset=this.markedOffset,t.limit=this.limit,t},o.compact=function(e,t){if(void 0===e&&(e=this.offset),void 0===t&&(t=this.limit),!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal begin: Not an integer");if(e>>>=0,"number"!=typeof t||0!=t%1)throw TypeError("Illegal end: Not an integer");if(t>>>=0,e<0||t<e||t>this.buffer.byteLength)throw RangeError("Illegal range: 0 <= "+e+" <= "+t+" <= "+this.buffer.byteLength)}if(0===e&&t===this.buffer.byteLength)return this;var i=t-e;if(0===i)return this.buffer=s,this.view=null,0<=this.markedOffset&&(this.markedOffset-=e),this.limit=this.offset=0,this;var n=new ArrayBuffer(i),r=new Uint8Array(n);return r.set(this.view.subarray(e,t)),this.buffer=n,this.view=r,0<=this.markedOffset&&(this.markedOffset-=e),this.offset=0,this.limit=i,this},o.copy=function(e,t){if(void 0===e&&(e=this.offset),void 0===t&&(t=this.limit),!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal begin: Not an integer");if(e>>>=0,"number"!=typeof t||0!=t%1)throw TypeError("Illegal end: Not an integer");if(t>>>=0,e<0||t<e||t>this.buffer.byteLength)throw RangeError("Illegal range: 0 <= "+e+" <= "+t+" <= "+this.buffer.byteLength)}if(e===t)return new u(0,this.littleEndian,this.noAssert);var i=t-e,n=new u(i,this.littleEndian,this.noAssert);return n.offset=0,n.limit=i,0<=n.markedOffset&&(n.markedOffset-=e),this.copyTo(n,0,e,t),n},o.copyTo=function(e,t,i,n){var r,o;if(!this.noAssert&&!u.isByteBuffer(e))throw TypeError("Illegal target: Not a ByteBuffer");if(t=(o=void 0===t)?e.offset:0|t,i=(r=void 0===i)?this.offset:0|i,n=void 0===n?this.limit:0|n,t<0||t>e.buffer.byteLength)throw RangeError("Illegal target range: 0 <= "+t+" <= "+e.buffer.byteLength);if(i<0||n>this.buffer.byteLength)throw RangeError("Illegal source range: 0 <= "+i+" <= "+this.buffer.byteLength);var s=n-i;return 0===s?e:(e.ensureCapacity(t+s),e.view.set(this.view.subarray(i,n),t),r&&(this.offset+=s),o&&(e.offset+=s),this)},o.ensureCapacity=function(e){var t=this.buffer.byteLength;return t<e?this.resize((t*=2)>e?t:e):this},o.fill=function(e,t,i){var n=void 0===t;if(n&&(t=this.offset),"string"==typeof e&&0<e.length&&(e=e.charCodeAt(0)),void 0===t&&(t=this.offset),void 0===i&&(i=this.limit),!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal value: "+e+" (not an integer)");if(e|=0,"number"!=typeof t||0!=t%1)throw TypeError("Illegal begin: Not an integer");if(t>>>=0,"number"!=typeof i||0!=i%1)throw TypeError("Illegal end: Not an integer");if(i>>>=0,t<0||i<t||i>this.buffer.byteLength)throw RangeError("Illegal range: 0 <= "+t+" <= "+i+" <= "+this.buffer.byteLength)}if(i<=t)return this;for(;t<i;)this.view[t++]=e;return n&&(this.offset=t),this},o.flip=function(){return this.limit=this.offset,this.offset=0,this},o.mark=function(e){if(e=void 0===e?this.offset:e,!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal offset: "+e+" (not an integer)");if((e>>>=0)<0||e+0>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+e+" (+0) <= "+this.buffer.byteLength)}return this.markedOffset=e,this},o.order=function(e){if(!this.noAssert&&"boolean"!=typeof e)throw TypeError("Illegal littleEndian: Not a boolean");return this.littleEndian=!!e,this},o.LE=function(e){return this.littleEndian=void 0===e||!!e,this},o.BE=function(e){return this.littleEndian=void 0!==e&&!e,this},o.prepend=function(e,t,i){"number"!=typeof t&&"string"==typeof t||(i=t,t=void 0);var n=void 0===i;if(n&&(i=this.offset),!this.noAssert){if("number"!=typeof i||0!=i%1)throw TypeError("Illegal offset: "+i+" (not an integer)");if((i>>>=0)<0||i+0>this.buffer.byteLength)throw RangeError("Illegal offset: 0 <= "+i+" (+0) <= "+this.buffer.byteLength)}if(e instanceof u||(e=u.wrap(e,t)),(t=e.limit-e.offset)<=0)return this;var r=t-i;if(0<r){var o=new ArrayBuffer(this.buffer.byteLength+r),s=new Uint8Array(o);s.set(this.view.subarray(i,this.buffer.byteLength),t),this.buffer=o,this.view=s,this.offset+=r,0<=this.markedOffset&&(this.markedOffset+=r),this.limit+=r,i+=r}else new Uint8Array(this.buffer);return this.view.set(e.view.subarray(e.offset,e.limit),i-t),e.offset=e.limit,n&&(this.offset-=t),this},o.prependTo=function(e,t){return e.prepend(this,t),this},o.printDebug=function(e){"function"!=typeof e&&(e=console.log.bind(console)),e(this.toString()+"\n-------------------------------------------------------------------\n"+this.toDebug(!0))},o.remaining=function(){return this.limit-this.offset},o.reset=function(){return 0<=this.markedOffset?(this.offset=this.markedOffset,this.markedOffset=-1):this.offset=0,this},o.resize=function(e){if(!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal capacity: "+e+" (not an integer)");if((e|=0)<0)throw RangeError("Illegal capacity: 0 <= "+e)}if(this.buffer.byteLength<e){e=new ArrayBuffer(e);var t=new Uint8Array(e);t.set(this.view),this.buffer=e,this.view=t}return this},o.reverse=function(e,t){if(void 0===e&&(e=this.offset),void 0===t&&(t=this.limit),!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal begin: Not an integer");if(e>>>=0,"number"!=typeof t||0!=t%1)throw TypeError("Illegal end: Not an integer");if(t>>>=0,e<0||t<e||t>this.buffer.byteLength)throw RangeError("Illegal range: 0 <= "+e+" <= "+t+" <= "+this.buffer.byteLength)}return e===t||Array.prototype.reverse.call(this.view.subarray(e,t)),this},o.skip=function(e){if(!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal length: "+e+" (not an integer)");e|=0}var t=this.offset+e;if(!this.noAssert&&(t<0||t>this.buffer.byteLength))throw RangeError("Illegal length: 0 <= "+this.offset+" + "+e+" <= "+this.buffer.byteLength);return this.offset=t,this},o.slice=function(e,t){if(void 0===e&&(e=this.offset),void 0===t&&(t=this.limit),!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal begin: Not an integer");if(e>>>=0,"number"!=typeof t||0!=t%1)throw TypeError("Illegal end: Not an integer");if(t>>>=0,e<0||t<e||t>this.buffer.byteLength)throw RangeError("Illegal range: 0 <= "+e+" <= "+t+" <= "+this.buffer.byteLength)}var i=this.clone();return i.offset=e,i.limit=t,i},o.toBuffer=function(e){var t=this.offset,i=this.limit;if(!this.noAssert){if("number"!=typeof t||0!=t%1)throw TypeError("Illegal offset: Not an integer");if(t>>>=0,"number"!=typeof i||0!=i%1)throw TypeError("Illegal limit: Not an integer");if(i>>>=0,t<0||i<t||i>this.buffer.byteLength)throw RangeError("Illegal range: 0 <= "+t+" <= "+i+" <= "+this.buffer.byteLength)}return e||0!==t||i!==this.buffer.byteLength?t===i?s:(e=new ArrayBuffer(i-t),new Uint8Array(e).set(new Uint8Array(this.buffer).subarray(t,i),0),e):this.buffer},o.toArrayBuffer=o.toBuffer,o.toString=function(e,t,i){if(void 0===e)return"ByteBufferAB(offset="+this.offset+",markedOffset="+this.markedOffset+",limit="+this.limit+",capacity="+this.capacity()+")";switch("number"==typeof e&&(i=t=e="utf8"),e){case"utf8":return this.toUTF8(t,i);case"base64":return this.toBase64(t,i);case"hex":return this.toHex(t,i);case"binary":return this.toBinary(t,i);case"debug":return this.toDebug();case"columns":return this.toColumns();default:throw Error("Unsupported encoding: "+e)}};var h=function(){for(var e={},r=[65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,48,49,50,51,52,53,54,55,56,57,43,47],s=[],t=0,i=r.length;t<i;++t)s[r[t]]=t;return e.encode=function(e,t){for(var i,n;null!==(i=e());)t(r[i>>2&63]),n=(3&i)<<4,null!==(i=e())?(t(r[63&((n|=i>>4&15)|i>>4&15)]),n=(15&i)<<2,null!==(i=e())?(t(r[63&(n|i>>6&3)]),t(r[63&i])):(t(r[63&n]),t(61))):(t(r[63&n]),t(61),t(61))},e.decode=function(e,t){function i(e){throw Error("Illegal character code: "+e)}for(var n,r,o;null!==(n=e());)if(void 0===(r=s[n])&&i(n),null!==(n=e())&&(void 0===(o=s[n])&&i(n),t(r<<2>>>0|(48&o)>>4),null!==(n=e()))){if(void 0===(r=s[n])){if(61===n)break;i(n)}if(t((15&o)<<4>>>0|(60&r)>>2),null!==(n=e())){if(void 0===(o=s[n])){if(61===n)break;i(n)}t((3&r)<<6>>>0|o)}}},e.test=function(e){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(e)},e}();o.toBase64=function(e,t){if(void 0===e&&(e=this.offset),void 0===t&&(t=this.limit),t|=0,(e|=0)<0||t>this.capacity||t<e)throw RangeError("begin, end");var i;return h.encode(function(){return e<t?this.view[e++]:null}.bind(this),i=d()),i()},u.fromBase64=function(e,t){if("string"!=typeof e)throw TypeError("str");var i=new u(e.length/4*3,t),n=0;return h.decode(a(e),function(e){i.view[n++]=e}),i.limit=n,i},u.btoa=function(e){return u.fromBinary(e).toBase64()},u.atob=function(e){return u.fromBase64(e).toBinary()},o.toBinary=function(e,t){if(void 0===e&&(e=this.offset),void 0===t&&(t=this.limit),t|=0,(e|=0)<0||t>this.capacity()||t<e)throw RangeError("begin, end");if(e===t)return"";for(var i=[],n=[];e<t;)i.push(this.view[e++]),1024<=i.length&&(n.push(String.fromCharCode.apply(String,i)),i=[]);return n.join("")+String.fromCharCode.apply(String,i)},u.fromBinary=function(e,t){if("string"!=typeof e)throw TypeError("str");for(var i,n=0,r=e.length,o=new u(r,t);n<r;){if(255<(i=e.charCodeAt(n)))throw RangeError("illegal char code: "+i);o.view[n++]=i}return o.limit=r,o},o.toDebug=function(e){for(var t,i=-1,n=this.buffer.byteLength,r="",o="",s="";i<n;){if(-1!==i&&(r=(t=this.view[i])<16?r+"0"+t.toString(16).toUpperCase():r+t.toString(16).toUpperCase(),e&&(o+=32<t&&t<127?String.fromCharCode(t):".")),++i,e&&0<i&&0==i%16&&i!==n){for(;r.length<51;)r+=" ";s+=r+o+"\n",r=o=""}r=i===this.offset&&i===this.limit?r+(i===this.markedOffset?"!":"|"):i===this.offset?r+(i===this.markedOffset?"[":"<"):i===this.limit?r+(i===this.markedOffset?"]":">"):r+(i===this.markedOffset?"'":e||0!==i&&i!==n?" ":"")}if(e&&" "!==r){for(;r.length<51;)r+=" ";s+=r+o+"\n"}return e?s:r},u.fromDebug=function(e,t,i){var n=e.length;t=new u((n+1)/3|0,t,i);for(var r,o=0,s=0,a=!1,l=!1,d=!1,h=!1,c=!1;o<n;){switch(r=e.charAt(o++)){case"!":if(!i){if(l||d||h){c=!0;break}l=d=h=!0}t.offset=t.markedOffset=t.limit=s,a=!1;break;case"|":if(!i){if(l||h){c=!0;break}l=h=!0}t.offset=t.limit=s,a=!1;break;case"[":if(!i){if(l||d){c=!0;break}l=d=!0}t.offset=t.markedOffset=s,a=!1;break;case"<":if(!i){if(l){c=!0;break}l=!0}t.offset=s,a=!1;break;case"]":if(!i){if(h||d){c=!0;break}h=d=!0}t.limit=t.markedOffset=s,a=!1;break;case">":if(!i){if(h){c=!0;break}h=!0}t.limit=s,a=!1;break;case"'":if(!i){if(d){c=!0;break}d=!0}t.markedOffset=s,a=!1;break;case" ":a=!1;break;default:if(!i&&a){c=!0;break}if(r=parseInt(r+e.charAt(o++),16),!i&&(isNaN(r)||r<0||255<r))throw TypeError("Illegal str: Not a debug encoded string");t.view[s++]=r,a=!0}if(c)throw TypeError("Illegal str: Invalid symbol at "+o)}if(!i){if(!l||!h)throw TypeError("Illegal str: Missing offset or limit");if(s<t.buffer.byteLength)throw TypeError("Illegal str: Not a debug encoded string (is it hex?) "+s+" < "+n)}return t},o.toHex=function(e,t){if(e=void 0===e?this.offset:e,t=void 0===t?this.limit:t,!this.noAssert){if("number"!=typeof e||0!=e%1)throw TypeError("Illegal begin: Not an integer");if(e>>>=0,"number"!=typeof t||0!=t%1)throw TypeError("Illegal end: Not an integer");if(t>>>=0,e<0||t<e||t>this.buffer.byteLength)throw RangeError("Illegal range: 0 <= "+e+" <= "+t+" <= "+this.buffer.byteLength)}for(var i,n=Array(t-e);e<t;)(i=this.view[e++])<16?n.push("0",i.toString(16)):n.push(i.toString(16));return n.join("")},u.fromHex=function(e,t,i){if(!i){if("string"!=typeof e)throw TypeError("Illegal str: Not a string");if(0!=e.length%2)throw TypeError("Illegal str: Length not a multiple of 2")}var n=e.length;t=new u(n/2|0,t);for(var r,o=0,s=0;o<n;o+=2){if(r=parseInt(e.substring(o,o+2),16),!i&&(!isFinite(r)||r<0||255<r))throw TypeError("Illegal str: Contains non-hex characters");t.view[s++]=r}return t.limit=s,t};var c,f=c={MAX_CODEPOINT:1114111,encodeUTF8:function(e,t){var i=null;for("number"==typeof e&&(i=e,e=function(){return null});null!==i||null!==(i=e());)i<128?t(127&i):(i<2048?t(i>>6&31|192):(i<65536?t(i>>12&15|224):(t(i>>18&7|240),t(i>>12&63|128)),t(i>>6&63|128)),t(63&i|128)),i=null},decodeUTF8:function(e,t){for(var i,n,r,o,s=function(e){e=e.slice(0,e.indexOf(null));var t=Error(e.toString());throw t.name="TruncatedError",t.bytes=e,t};null!==(i=e());)if(0==(128&i))t(i);else if(192==(224&i))null===(n=e())&&s([i,n]),t((31&i)<<6|63&n);else if(224==(240&i))null!==(n=e())&&null!==(r=e())||s([i,n,r]),t((15&i)<<12|(63&n)<<6|63&r);else{if(240!=(248&i))throw RangeError("Illegal starting byte: "+i);null!==(n=e())&&null!==(r=e())&&null!==(o=e())||s([i,n,r,o]),t((7&i)<<18|(63&n)<<12|(63&r)<<6|63&o)}},UTF16toUTF8:function(e,t){for(var i,n=null;null!==(i=null!==n?n:e());)55296<=i&&i<=57343&&null!==(n=e())&&56320<=n&&n<=57343?(t(1024*(i-55296)+n-56320+65536),n=null):t(i);null!==n&&t(n)},UTF8toUTF16:function(e,t){var i=null;for("number"==typeof e&&(i=e,e=function(){return null});null!==i||null!==(i=e());)i<=65535?t(i):(t(55296+((i-=65536)>>10)),t(i%1024+56320)),i=null},encodeUTF16toUTF8:function(e,t){c.UTF16toUTF8(e,function(e){c.encodeUTF8(e,t)})},decodeUTF8toUTF16:function(e,t){c.decodeUTF8(e,function(e){c.UTF8toUTF16(e,t)})},calculateCodePoint:function(e){return e<128?1:e<2048?2:e<65536?3:4},calculateUTF8:function(e){for(var t,i=0;null!==(t=e());)i+=t<128?1:t<2048?2:t<65536?3:4;return i},calculateUTF16asUTF8:function(e){var t=0,i=0;return c.UTF16toUTF8(e,function(e){++t,i+=e<128?1:e<2048?2:e<65536?3:4}),[t,i]}};return o.toUTF8=function(t,i){if(void 0===t&&(t=this.offset),void 0===i&&(i=this.limit),!this.noAssert){if("number"!=typeof t||0!=t%1)throw TypeError("Illegal begin: Not an integer");if(t>>>=0,"number"!=typeof i||0!=i%1)throw TypeError("Illegal end: Not an integer");if(i>>>=0,t<0||i<t||i>this.buffer.byteLength)throw RangeError("Illegal range: 0 <= "+t+" <= "+i+" <= "+this.buffer.byteLength)}var e;try{f.decodeUTF8toUTF16(function(){return t<i?this.view[t++]:null}.bind(this),e=d())}catch(e){if(t!==i)throw RangeError("Illegal range: Truncated data, "+t+" != "+i)}return e()},u.fromUTF8=function(e,t,i){if(!i&&"string"!=typeof e)throw TypeError("Illegal str: Not a string");var n=new u(f.calculateUTF16asUTF8(a(e),!0)[1],t,i),r=0;return f.encodeUTF16toUTF8(a(e),function(e){n.view[r++]=e}),n.limit=r,n},u}),function(e,t){"function"==typeof define&&define.amd?define([],t):"function"==typeof require&&"object"==typeof module&&module&&module.exports?module.exports=t():(e.dcodeIO=e.dcodeIO||{}).Long=t()}(this,function(){function n(e,t,i){this.low=0|e,this.high=0|t,this.unsigned=!!i}function u(e){return!0===(e&&e.__isLong__)}function e(e,t){var i,n;if(t){if((n=0<=(e>>>=0)&&e<256)&&(i=o[e]))return i;i=g(e,(0|e)<0?-1:0,!0),n&&(o[e]=i)}else{if((n=-128<=(e|=0)&&e<128)&&(i=r[e]))return i;i=g(e,e<0?-1:0,!1),n&&(r[e]=i)}return i}function f(e,t){if(isNaN(e)||!isFinite(e))return t?a:y;if(t){if(e<0)return a;if(i<=e)return b}else{if(e<=-s)return T;if(s<=e+1)return w}return e<0?f(-e,t).neg():g(e%4294967296|0,e/4294967296|0,t)}function g(e,t,i){return new n(e,t,i)}function l(e,t,i){if(0===e.length)throw Error("empty string");if("NaN"===e||"Infinity"===e||"+Infinity"===e||"-Infinity"===e)return y;if("number"==typeof t?(i=t,t=!1):t=!!t,(i=i||10)<2||36<i)throw RangeError("radix");var n;if(0<(n=e.indexOf("-")))throw Error("interior hyphen");if(0===n)return l(e.substring(1),t,i).neg();n=f(d(i,8));for(var r=y,o=0;o<e.length;o+=8){var s=Math.min(8,e.length-o),a=parseInt(e.substring(o,o+s),i);s<8?(s=f(d(i,s)),r=r.mul(s).add(f(a))):r=(r=r.mul(n)).add(f(a))}return r.unsigned=t,r}function p(e){return e instanceof n?e:"number"==typeof e?f(e):"string"==typeof e?l(e):g(e.low,e.high,e.unsigned)}Object.defineProperty(n.prototype,"__isLong__",{value:!0,enumerable:!1,configurable:!1}),n.isLong=u;var r={},o={};n.fromInt=e,n.fromNumber=f,n.fromBits=g;var d=Math.pow;n.fromString=l,n.fromValue=p;var i=0x10000000000000000,s=i/2,m=e(16777216),y=e(0);n.ZERO=y;var a=e(0,!0);n.UZERO=a;var h=e(1);n.ONE=h;var c=e(1,!0);n.UONE=c;var v=e(-1);n.NEG_ONE=v;var w=g(-1,2147483647,!1);n.MAX_VALUE=w;var b=g(-1,-1,!0);n.MAX_UNSIGNED_VALUE=b;var T=g(0,-2147483648,!1);n.MIN_VALUE=T;var t=n.prototype;return t.toInt=function(){return this.unsigned?this.low>>>0:this.low},t.toNumber=function(){return this.unsigned?4294967296*(this.high>>>0)+(this.low>>>0):4294967296*this.high+(this.low>>>0)},t.toString=function(e){if((e=e||10)<2||36<e)throw RangeError("radix");if(this.isZero())return"0";if(this.isNegative()){if(this.eq(T)){var t=f(e);t=(i=this.div(t)).mul(t).sub(this);return i.toString(e)+t.toInt().toString(e)}return"-"+this.neg().toString(e)}for(var i=f(d(e,6),this.unsigned),n=(t=this,"");;){var r=t.div(i),o=(t.sub(r.mul(i)).toInt()>>>0).toString(e);if((t=r).isZero())return o+n;for(;o.length<6;)o="0"+o;n=""+o+n}},t.getHighBits=function(){return this.high},t.getHighBitsUnsigned=function(){return this.high>>>0},t.getLowBits=function(){return this.low},t.getLowBitsUnsigned=function(){return this.low>>>0},t.getNumBitsAbs=function(){if(this.isNegative())return this.eq(T)?64:this.neg().getNumBitsAbs();for(var e=0!=this.high?this.high:this.low,t=31;0<t&&0==(e&1<<t);t--);return 0!=this.high?t+33:t+1},t.isZero=function(){return 0===this.high&&0===this.low},t.isNegative=function(){return!this.unsigned&&this.high<0},t.isPositive=function(){return this.unsigned||0<=this.high},t.isOdd=function(){return 1==(1&this.low)},t.isEven=function(){return 0==(1&this.low)},t.equals=function(e){return u(e)||(e=p(e)),(this.unsigned===e.unsigned||1!=this.high>>>31||1!=e.high>>>31)&&(this.high===e.high&&this.low===e.low)},t.eq=t.equals,t.notEquals=function(e){return!this.eq(e)},t.neq=t.notEquals,t.lessThan=function(e){return this.comp(e)<0},t.lt=t.lessThan,t.lessThanOrEqual=function(e){return this.comp(e)<=0},t.lte=t.lessThanOrEqual,t.greaterThan=function(e){return 0<this.comp(e)},t.gt=t.greaterThan,t.greaterThanOrEqual=function(e){return 0<=this.comp(e)},t.gte=t.greaterThanOrEqual,t.compare=function(e){if(u(e)||(e=p(e)),this.eq(e))return 0;var t=this.isNegative(),i=e.isNegative();return t&&!i?-1:!t&&i?1:this.unsigned?e.high>>>0>this.high>>>0||e.high===this.high&&e.low>>>0>this.low>>>0?-1:1:this.sub(e).isNegative()?-1:1},t.comp=t.compare,t.negate=function(){return!this.unsigned&&this.eq(T)?T:this.not().add(h)},t.neg=t.negate,t.add=function(e){u(e)||(e=p(e));var t,i=this.high>>>16,n=65535&this.high,r=this.low>>>16,o=e.high>>>16,s=65535&e.high,a=e.low>>>16;return e=0+((t=(65535&this.low)+(65535&e.low)+0)>>>16),r=0+((e+=r+a)>>>16),g((65535&e)<<16|65535&t,(n=(n=0+((r+=n+s)>>>16))+(i+o)&65535)<<16|65535&r,this.unsigned)},t.subtract=function(e){return u(e)||(e=p(e)),this.add(e.neg())},t.sub=t.subtract,t.multiply=function(e){if(this.isZero())return y;if(u(e)||(e=p(e)),e.isZero())return y;if(this.eq(T))return e.isOdd()?T:y;if(e.eq(T))return this.isOdd()?T:y;if(this.isNegative())return e.isNegative()?this.neg().mul(e.neg()):this.neg().mul(e).neg();if(e.isNegative())return this.mul(e.neg()).neg();if(this.lt(m)&&e.lt(m))return f(this.toNumber()*e.toNumber(),this.unsigned);var t,i,n,r,o=this.high>>>16,s=65535&this.high,a=this.low>>>16,l=65535&this.low,d=e.high>>>16,h=65535&e.high,c=e.low>>>16;return n=0+((r=0+l*(e=65535&e.low))>>>16),i=0+((n+=a*e)>>>16),i+=(n=(65535&n)+l*c)>>>16,t=0+((i+=s*e)>>>16),t+=(i=(65535&i)+a*c)>>>16,i&=65535,g((n&=65535)<<16|65535&r,(t=(t+=(i+=l*h)>>>16)+(o*e+s*c+a*h+l*d)&65535)<<16|(i&=65535),this.unsigned)},t.mul=t.multiply,t.divide=function(e){if(u(e)||(e=p(e)),e.isZero())throw Error("division by zero");if(this.isZero())return this.unsigned?a:y;var t,i,n;if(this.unsigned){if(e.unsigned||(e=e.toUnsigned()),e.gt(this))return a;if(e.gt(this.shru(1)))return c;n=a}else{if(this.eq(T))return e.eq(h)||e.eq(v)?T:e.eq(T)?h:(t=this.shr(1).div(e).shl(1)).eq(y)?e.isNegative()?h:v:(i=this.sub(e.mul(t)),t.add(i.div(e)));if(e.eq(T))return this.unsigned?a:y;if(this.isNegative())return e.isNegative()?this.neg().div(e.neg()):this.neg().div(e).neg();if(e.isNegative())return this.div(e.neg()).neg();n=y}for(i=this;i.gte(e);){t=Math.max(1,Math.floor(i.toNumber()/e.toNumber()));for(var r=(r=Math.ceil(Math.log(t)/Math.LN2))<=48?1:d(2,r-48),o=f(t),s=o.mul(e);s.isNegative()||s.gt(i);)s=(o=f(t-=r,this.unsigned)).mul(e);o.isZero()&&(o=h),n=n.add(o),i=i.sub(s)}return n},t.div=t.divide,t.modulo=function(e){return u(e)||(e=p(e)),this.sub(this.div(e).mul(e))},t.mod=t.modulo,t.not=function(){return g(~this.low,~this.high,this.unsigned)},t.and=function(e){return u(e)||(e=p(e)),g(this.low&e.low,this.high&e.high,this.unsigned)},t.or=function(e){return u(e)||(e=p(e)),g(this.low|e.low,this.high|e.high,this.unsigned)},t.xor=function(e){return u(e)||(e=p(e)),g(this.low^e.low,this.high^e.high,this.unsigned)},t.shiftLeft=function(e){return u(e)&&(e=e.toInt()),0==(e&=63)?this:e<32?g(this.low<<e,this.high<<e|this.low>>>32-e,this.unsigned):g(0,this.low<<e-32,this.unsigned)},t.shl=t.shiftLeft,t.shiftRight=function(e){return u(e)&&(e=e.toInt()),0==(e&=63)?this:e<32?g(this.low>>>e|this.high<<32-e,this.high>>e,this.unsigned):g(this.high>>e-32,0<=this.high?0:-1,this.unsigned)},t.shr=t.shiftRight,t.shiftRightUnsigned=function(e){if(u(e)&&(e=e.toInt()),0===(e&=63))return this;var t=this.high;return e<32?g(this.low>>>e|t<<32-e,t>>>e,this.unsigned):g(32===e?t:t>>>e-32,0,this.unsigned)},t.shru=t.shiftRightUnsigned,t.toSigned=function(){return this.unsigned?g(this.low,this.high,!1):this},t.toUnsigned=function(){return this.unsigned?this:g(this.low,this.high,!0)},t.toBytes=function(e){return e?this.toBytesLE():this.toBytesBE()},t.toBytesLE=function(){var e=this.high,t=this.low;return[255&t,t>>>8&255,t>>>16&255,t>>>24&255,255&e,e>>>8&255,e>>>16&255,e>>>24&255]},t.toBytesBE=function(){var e=this.high,t=this.low;return[e>>>24&255,e>>>16&255,e>>>8&255,255&e,t>>>24&255,t>>>16&255,t>>>8&255,255&t]},n}),function(e){function t(e){if(!e)throw Error("TONG ENGINE requires ByteBuffer.js: Get it at https://tong3d.com/ByteBuffer.js");var n,r,o,t,i,s,a,l,d,h,c,u,f,g={T:{ZERO:0,MAX:239,NULL:240,TRUE:241,FALSE:242,EOBJECT:243,EARRAY:244,ESTRING:245,OBJECT:246,ARRAY:247,INTEGER:248,LONG:249,FLOAT:250,DOUBLE:251,STRING:252,STRING_ADD:253,STRING_GET:254,BINARY:255}};return g.Encoder=function(a,l){var e=new a(4);e.length=4;var d=a.Long,t=function(e,t,i){if(this.dict={},this.next=0,e&&Array.isArray(e))for(;this.next<e.length;)this.dict[e[this.next]]=this.next++;this.progressive=!!t,this.options=i||{}};return t.prototype.encode=function(e,t){var i=!1;t||(t=new a,i=!0);var n=t.littleEndian;try{return this._encodeValue(e,t.LE()),t.littleEndian=n,i?t.flip():t}catch(e){throw t.littleEndian=n,e}},t.prototype._encodeValue=function(t,i,n){if(null===t)i.writeUint8(l.NULL);else switch(typeof t){case"function":t=t.toString();case"string":0===t.length?i.writeUint8(l.ESTRING):this.dict.hasOwnProperty(t)?(i.writeUint8(l.STRING_GET),i.writeVarint32(this.dict[t])):(i.writeUint8(l.STRING),i.writeVString(t));break;case"number":t===(n=parseInt(t))?(n=a.zigZagEncode32(t))<=l.MAX?i.writeUint8(n):(i.writeUint8(l.INTEGER),i.writeVarint32ZigZag(t)):(e.writeFloat32(t,0),t===e.readFloat32(0)?(i.writeUint8(l.FLOAT),i.writeFloat32(t)):(i.writeUint8(l.DOUBLE),i.writeFloat64(t)));break;case"boolean":i.writeUint8(t?l.TRUE:l.FALSE);break;case"object":var r;if(Array.isArray(t))if(0===t.length)i.writeUint8(l.EARRAY);else for(i.writeUint8(l.ARRAY),i.writeVarint32(t.length),r=0;r<t.length;r++)this._encodeValue(t[r],i);else if(d&&t instanceof d)i.writeUint8(l.LONG),i.writeVarint64ZigZag(t);else try{t=a.wrap(t),i.writeUint8(l.BINARY),i.writeVarint32(t.remaining()),i.append(t)}catch(e){var o=Object.keys(t),s=0;for(r=0;r<o.length;r++)void 0!==t[o[r]]&&s++;if(0===s)i.writeUint8(l.EOBJECT);else for(i.writeUint8(l.OBJECT),i.writeVarint32(s),n||(n=!!t._PSON_EXCL_),r=0;r<o.length;r++)void 0!==t[s=o[r]]&&(this.dict.hasOwnProperty(s)?(i.writeUint8(l.STRING_GET),i.writeVarint32(this.dict[s])):(this.progressive&&!n?(this.dict[s]=this.next++,i.writeUint8(l.STRING_ADD)):i.writeUint8(l.STRING),i.writeVString(s)),this._encodeValue(t[s],i))}break;case"undefined":i.writeUint8(l.NULL)}},t}(e,g.T),g.Decoder=(n=e,r=g.T,o=n.Long,(t=function(e,t,i){this.dict=e&&Array.isArray(e)?e:[],this.progressive=!!t,this.options=i||{}}).prototype.decode=function(t){t instanceof n||(t=n.wrap(t));var i=t.littleEndian;try{var e=this._decodeValue(t.LE());return t.littleEndian=i,e}catch(e){throw t.littleEndian=i,e}},t.prototype._decodeValue=function(e){if((t=e.readUint8())<=r.MAX)return n.zigZagDecode32(t);switch(t){case r.NULL:return null;case r.TRUE:return!0;case r.FALSE:return!1;case r.EOBJECT:return{};case r.EARRAY:return[];case r.ESTRING:return"";case r.OBJECT:for(var t=e.readVarint32(),i={};0<=--t;)i[this._decodeValue(e)]=this._decodeValue(e);return i;case r.ARRAY:for(t=e.readVarint32(),i=[];0<=--t;)i.push(this._decodeValue(e));return i;case r.INTEGER:return e.readVarint32ZigZag();case r.LONG:return o?e.readVarint64ZigZag():e.readVarint32ZigZag();case r.FLOAT:return e.readFloat32();case r.DOUBLE:return e.readFloat64();case r.STRING:return e.readVString();case r.STRING_ADD:return e=e.readVString(),this.dict.push(e),e;case r.STRING_GET:return this.dict[e.readVarint32()];case r.BINARY:return t=e.readVarint32(),i=e.slice(e.offset,e.offset+t),e.offset+=t,i;default:throw Error("Illegal type at "+e.offset+": "+t)}},t),g.Pair=((i=function(){}).prototype.encode=function(e){return this.encoder.encode(e)},i.prototype.toArrayBuffer=function(e){return this.encoder.encode(e).toArrayBuffer()},i.prototype.toBuffer=function(e){return this.encoder.encode(e).toBuffer()},i.prototype.decode=function(e){return this.decoder.decode(e)},i),g.StaticPair=(s=g.Pair,a=g.Encoder,l=g.Decoder,(d=function(e,t){s.call(this),this.encoder=new a(e,!1,t),this.decoder=new l(e,!1,t)}).prototype=Object.create(s.prototype),d),g.ProgressivePair=(h=g.Pair,c=g.Encoder,u=g.Decoder,((f=function(e,t){h.call(this),this.encoder=new c(e,!0,t),this.decoder=new u(e,!0,t)}).prototype=Object.create(h.prototype)).exclude=function(e){g.exclude(e)},f.prototype.include=function(e){g.include(e)},f),g.exclude=function(e){"object"==typeof e&&Object.defineProperty(e,"_PSON_EXCL_",{value:!0,enumerable:!1,configurable:!0})},g.include=function(e){"object"==typeof e&&delete e._PSON_EXCL_},g}"undefined"!=typeof module&&module.exports?module.exports=t(require("bytebuffer")):"undefined"!=typeof define&&define.amd?define("TONGData",["ByteBuffer"],t):(e.dcodeIO||(e.dcodeIO={}),e.dcodeIO.TONGData=t(e.dcodeIO.ByteBuffer))}(this);